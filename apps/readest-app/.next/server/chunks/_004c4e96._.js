module.exports=[960696,e=>{"use strict";var i=e.i(570399);async function t(e={}){return"object"==typeof e&&Object.freeze(e),await (0,i.invoke)("plugin:dialog|open",{options:e})}async function a(e={}){return"object"==typeof e&&Object.freeze(e),await (0,i.invoke)("plugin:dialog|save",{options:e})}e.s(["open",()=>t,"save",()=>a])},41052,e=>{"use strict";function i(){return window.__TAURI_OS_PLUGIN_INTERNALS__.os_type}e.i(570399),e.s(["type",()=>i])},958240,e=>{"use strict";var i=e.i(570399);async function t(e){return await (0,i.invoke)("plugin:native-bridge|copy_uri_to_path",{payload:e})}e.s(["copyURIToPath",()=>t])},366573,e=>{"use strict";let i=async(e,i,t)=>{let a=[];try{a=await e.readDirectory(i,"None")}catch{throw Error(`Dir ${i} failed to read.`)}for(let r=0;r<a.length;r++){let s=a[r],o=`${i}/${s.path}`,n=`${t}/${s.path}`;await e.copyFile(o,n,"None")}let r=await e.readDirectory(t,"None");for(let e of a)if(!r.find(i=>i.path===e.path&&i.size===e.size))throw Error(`File ${e.path} failed to copy.`)};e.s(["copyFiles",0,i])},668314,e=>e.a(async(i,t)=>{try{var a=e.i(709613),r=e.i(679627),s=e.i(570399),o=e.i(960696),n=e.i(41052),l=e.i(413414),c=e.i(191587),p=e.i(325824),h=e.i(585260),d=e.i(958240),w=e.i(366573),u=e.i(869734),D=e.i(827667),f=i([l,u]);[l,u]=f.then?(await f)():f;let y=null,v=()=>(null===y&&(y=(0,n.type)()),y),g=({customRootDir:e,isPortable:i,execDir:t}={})=>{let a=e?0:void 0,s=!!e,o=s?i=>()=>{let t=["Settings","Data","Books","Fonts","Images"].includes(i)?"":i;return t?`${e}/${t}`:e}:void 0,n=o?e=>async()=>o(e)():void 0;return(e,l)=>{let c=o?.(l),p=n?.(l);switch(l){case"Settings":return{baseDir:i?0:r.BaseDirectory.AppConfig,basePrefix:i&&t?async()=>t:r.appConfigDir,fp:i&&t?`${t}${e?`/${e}`:""}`:e,base:l};case"Cache":return{baseDir:r.BaseDirectory.AppCache,basePrefix:r.appCacheDir,fp:e,base:l};case"Log":return{baseDir:s?0:r.BaseDirectory.AppLog,basePrefix:p??r.appLogDir,fp:c?`${c()}${e?`/${e}`:""}`:e,base:l};case"Data":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:p??r.appDataDir,fp:c?`${c()}/${D.DATA_SUBDIR}${e?`/${e}`:""}`:`${D.DATA_SUBDIR}${e?`/${e}`:""}`,base:l};case"Books":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:p||r.appDataDir,fp:c?`${c()}/${D.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`:`${D.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Fonts":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:p||r.appDataDir,fp:c?`${c()}/${D.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`:`${D.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Images":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:p||r.appDataDir,fp:c?`${c()}/${D.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`:`${D.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`,base:l};case"None":return{baseDir:0,basePrefix:async()=>"",fp:e,base:l};default:return{baseDir:r.BaseDirectory.Temp,basePrefix:r.tempDir,fp:e,base:l}}}},A={resolvePath:g(),async getPrefix(e){let{basePrefix:i,fp:t,baseDir:a}=this.resolvePath("",e),s=await i();return s=s.replace(/\/+$/,""),t?0===a?t:await (0,r.join)(s,t):s},getURL:e=>(0,c.isValidURL)(e)?e:(0,s.convertFileSrc)(e),async getBlobURL(e,i){let t=await this.readFile(e,i,"binary");return URL.createObjectURL(new Blob([t]))},async getImageURL(e){return this.getURL(e)},async openFile(e,i,t){let{fp:a,baseDir:s}=this.resolvePath(e,i),o=t||(0,p.getFilename)(a);if((0,c.isValidURL)(e))return await new h.RemoteFile(e,o).open();if((0,c.isContentURI)(e)||(0,c.isFileURI)(e)&&"ios"===v()){if(o=await (0,r.basename)(e),e.includes("com.android.externalstorage"))return await new h.NativeFile(a,o,s||null).open();{let i=await this.getPrefix("Cache"),t=await (0,r.join)(i,decodeURIComponent(o)),a=await (0,d.copyURIToPath)({uri:e,dst:t});if(!a.success)throw console.error("Failed to open file:",a),Error("Failed to open file");return await new h.NativeFile(t,o,s||null).open()}}{if((0,c.isFileURI)(e)||"android"===v())return await new h.NativeFile(a,o,s||null).open();let t=await this.getPrefix(i),n=t?await (0,r.join)(t,e):e;return await new h.RemoteFile(this.getURL(n),o).open()}},async copyFile(e,i,t){try{await this.exists((0,p.getDirPath)(i),t)||await this.createDir((0,p.getDirPath)(i),t,!0)}catch(e){console.log("Failed to create directory for copying file:",e)}if((0,c.isContentURI)(e)){let a=await this.getPrefix(t);if(!a)throw Error("Invalid base directory");let s=await (0,d.copyURIToPath)({uri:e,dst:await (0,r.join)(a,i)});if(!s.success)throw console.error("Failed to copy file:",s),Error("Failed to copy file")}else{let{fp:r,baseDir:s}=this.resolvePath(i,t);await (0,a.copyFile)(e,r,s?{toPathBaseDir:s}:void 0)}},async readFile(e,i,t){let{fp:r,baseDir:s}=this.resolvePath(e,i);return"text"===t?(0,a.readTextFile)(r,s?{baseDir:s}:void 0):(await (0,a.readFile)(r,s?{baseDir:s}:void 0)).buffer},async writeFile(e,i,t){let{fp:r,baseDir:s}=this.resolvePath(e,i);return(await this.exists((0,p.getDirPath)(e),i)||await this.createDir((0,p.getDirPath)(e),i,!0),"string"==typeof t)?(0,a.writeTextFile)(r,t,s?{baseDir:s}:void 0):t instanceof File?await (0,a.writeFile)(r,t.stream(),{write:!0,create:!0,baseDir:s||void 0}):await (0,a.writeFile)(r,new Uint8Array(t),s?{baseDir:s}:void 0)},async removeFile(e,i){let{fp:t,baseDir:r}=this.resolvePath(e,i);await (0,a.remove)(t,r?{baseDir:r}:void 0)},async createDir(e,i,t=!1){let{fp:r,baseDir:s}=this.resolvePath(e,i);await (0,a.mkdir)(r,{baseDir:s||void 0,recursive:t})},async removeDir(e,i,t=!1){let{fp:r,baseDir:s}=this.resolvePath(e,i);await (0,a.remove)(r,{baseDir:s||void 0,recursive:t})},async readDir(e,i){let{fp:t,baseDir:o}=this.resolvePath(e,i);if(!o||0===o)try{return(await (0,s.invoke)("read_dir",{path:t,recursive:!0,extensions:["*"]})).map(e=>{var i;let a;return{path:(i=e.path,a=i,i.toLowerCase().startsWith(t.toLowerCase())&&(a=i.substring(t.length)),(a.startsWith("\\")||a.startsWith("/"))&&(a=a.substring(1)),a),size:e.size}})}catch(e){console.error("Rust read_dir failed, falling back to JS recursion",e)}let n=await (0,a.readDir)(t,o?{baseDir:o}:void 0),l=[],c=async(e,i,t,s)=>{for(let n of t)if(n.isDirectory){let t=await (0,r.join)(e,n.name),l=i?await (0,r.join)(i,n.name):n.name;try{let e=await (0,a.readDir)(t,o?{baseDir:o}:void 0);await c(t,l,e,s)}catch{console.warn(`Skipping unreadable dir: ${t}`)}}else{let t=await (0,r.join)(e,n.name),l=i?await (0,r.join)(i,n.name):n.name,c=o?{baseDir:o}:void 0,p=await (0,a.stat)(t,c).then(e=>e.size).catch(()=>0);s.push({path:l,size:p})}};return await c(t,"",n,l),l},async exists(e,i){let{fp:t,baseDir:r}=this.resolvePath(e,i);try{return await (0,a.exists)(t,r?{baseDir:r}:void 0)}catch{return!1}},async stats(e,i){let{fp:t,baseDir:r}=this.resolvePath(e,i);return await (0,a.stat)(t,r?{baseDir:r}:void 0)}},P=process.env.NEXT_PUBLIC_DIST_CHANNEL||"readest";class m extends u.BaseAppService{fs=A;appPlatform="tauri";isAppDataSandbox=!1;isMobile=!1;isAndroidApp=!1;isIOSApp=!1;isMacOSApp=!1;isLinuxApp=!1;isMobileApp=!1;isDesktopApp=!1;isEink=!!window.__READEST_IS_EINK;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir="appstore"!==P;canReadExternalDir="appstore"!==P&&"playstore"!==P;distChannel=P;execDir=void 0;async init(){let e=v();this.isAppDataSandbox=["android","ios"].includes(e),this.isMobile=["android","ios"].includes(e),this.isAndroidApp="android"===e,this.isIOSApp="ios"===e,this.isMacOSApp="macos"===e,this.isLinuxApp="linux"===e,this.isMobileApp=["android","ios"].includes(e),this.isDesktopApp=["macos","windows","linux"].includes(e),this.hasTrafficLight="macos"===e,this.hasWindow="ios"!==e&&"android"!==e,this.hasWindowBar="ios"!==e&&"android"!==e,this.hasContextMenu="ios"!==e&&"android"!==e,this.hasRoundedWindow="linux"===e,this.hasSafeAreaInset="ios"===e||"android"===e,this.hasHaptics="ios"===e||"android"===e,this.hasUpdater="ios"!==e&&!process.env.NEXT_PUBLIC_DISABLE_UPDATER&&!window.__READEST_UPDATER_DISABLED,this.hasOrientationLock="ios"===e&&"ios"===(0,c.getOSPlatform)()||"android"===e,this.hasScreenBrightness="ios"===e||"android"===e,this.hasIAP="ios"===e||"android"===e&&"playstore"===P;let i=await (0,s.invoke)("get_executable_dir");this.execDir=i,(process.env.NEXT_PUBLIC_PORTABLE_APP||await this.fs.exists(`${i}/${D.SETTINGS_FILENAME}`,"None"))&&(this.isPortableApp=!0,this.fs.resolvePath=g({customRootDir:i,isPortable:this.isPortableApp,execDir:i}));let t=await this.loadSettings();t.customRootDir&&(this.fs.resolvePath=g({customRootDir:t.customRootDir,isPortable:this.isPortableApp,execDir:i})),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let e=await this.loadSettings(),i=e.migrationVersion||0;if(await super.runMigrations(i),i<0x1350195)try{await this.migrate20251029()}catch(e){console.error("Error migrating to version 20251029:",e)}i<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...e,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(e){console.error("Failed to run migrations:",e)}}resolvePath(e,i){return this.fs.resolvePath(e,i)}async setCustomRootDir(e){this.fs.resolvePath=g({customRootDir:e,isPortable:this.isPortableApp,execDir:this.execDir}),await this.prepareBooksDir()}async selectDirectory(){return await (0,o.open)({directory:!0,multiple:!1,recursive:!0})}async selectFiles(e,i){let t=await (0,o.open)({multiple:!0,filters:[{name:e,extensions:i}]});return Array.isArray(t)?t:t?[t]:[]}async saveFile(e,i,t,r){try{let s=e.split(".").pop()||"";if(this.isIOSApp)await (0,l.shareFile)(t,{mimeType:r||"application/octet-stream"});else{let t=await (0,o.save)({defaultPath:e,filters:[{name:s.toUpperCase(),extensions:[s]}]});if(!t)return!1;"string"==typeof i?await (0,a.writeTextFile)(t,i):await (0,a.writeFile)(t,new Uint8Array(i))}return!0}catch(e){return console.error("Failed to save file:",e),!1}}async migrate20251029(){console.log("Running migration 20251029 to update paths in Images dir...");let e=await this.resolveFilePath("..","Data"),i=await this.fs.getPrefix("Images"),t=await (0,r.join)(e,"Images","Readest","Images");await (0,w.copyFiles)(this,t,i);let a=await (0,r.join)(e,"Images","Readest");await this.deleteDir(a,"None",!0)}}e.s(["NativeAppService",()=>m,"nativeFileSystem",0,A]),t()}catch(e){t(e)}},!1)];

//# sourceMappingURL=_004c4e96._.js.map