{"version":3,"sources":["../../../../../packages/foliate-js/comic-book.js"],"sourcesContent":["export const makeComicBook = async ({ entries, loadBlob, getSize, getComment }, file) => {\n    const cache = new Map()\n    const urls = new Map()\n    const load = async name => {\n        if (cache.has(name)) return cache.get(name)\n        const src = URL.createObjectURL(await loadBlob(name))\n        const page = URL.createObjectURL(\n            new Blob([`<!DOCTYPE html><html><head><meta charset=\"utf-8\"></head><body style=\"margin: 0\"><img src=\"${src}\"></body></html>`], { type: 'text/html' }))\n        urls.set(name, [src, page])\n        cache.set(name, page)\n        return page\n    }\n    const unload = name => {\n        urls.get(name)?.forEach?.(url => URL.revokeObjectURL(url))\n        urls.delete(name)\n        cache.delete(name)\n    }\n\n    const exts = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.jxl', '.avif']\n    const files = entries\n        .map(entry => entry.filename)\n        .filter(name => exts.some(ext => name.endsWith(ext)))\n        .sort()\n    if (!files.length) throw new Error('No supported image files in archive')\n\n    const book = {}\n    try {\n        const jsonComment = JSON.parse(await getComment() || '')\n        const info = jsonComment['ComicBookInfo/1.0']\n        if (info) {\n            const year = info.publicationYear\n            const month = info.publicationMonth\n            const mm = month && month >= 1 && month <= 12 ? String(month).padStart(2, '0') : null\n            book.metadata = {\n                title: info.title || file.name,\n                publisher: info.publisher,\n                language: info.language || info.lang,\n                author: info.credits ? info.credits.map(c => `${c.person} (${c.role})`).join(', ') : '',\n                published: year && month ? `${year}-${mm}` : undefined,\n            }\n        } else {\n            book.metadata = { title: file.name }\n        }\n    } catch {\n        book.metadata = { title: file.name }\n    }\n    book.getCover = () => loadBlob(files[0])\n    book.sections = files.map(name => ({\n        id: name,\n        load: () => load(name),\n        unload: () => unload(name),\n        size: getSize(name),\n    }))\n    book.toc = files.map(name => ({ label: name, href: name }))\n    book.rendition = { layout: 'pre-paginated' }\n    book.resolveHref = href => ({ index: book.sections.findIndex(s => s.id === href) })\n    book.splitTOCHref = href => [href, null]\n    book.getTOCFragment = doc => doc.documentElement\n    book.destroy = () => {\n        for (const arr of urls.values())\n            for (const url of arr) URL.revokeObjectURL(url)\n    }\n    return book\n}\n"],"names":[],"mappings":"wCAAO,IAAM,EAAgB,MAAO,SAAE,CAAO,UAAE,CAAQ,SAAE,CAAO,YAAE,CAAU,CAAE,CAAE,KAC5E,IAAM,EAAQ,IAAI,IACZ,EAAO,IAAI,IACX,EAAO,MAAM,IACf,GAAI,EAAM,GAAG,CAAC,GAAO,OAAO,EAAM,GAAG,CAAC,GACtC,IAAM,EAAM,IAAI,eAAe,CAAC,MAAM,EAAS,IACzC,EAAO,IAAI,eAAe,CAC5B,IAAI,KAAK,CAAC,CAAC,0FAA0F,EAAE,EAAI,gBAAgB,CAAC,CAAC,CAAE,CAAE,KAAM,WAAY,IAGvJ,OAFA,EAAK,GAAG,CAAC,EAAM,CAAC,EAAK,EAAK,EAC1B,EAAM,GAAG,CAAC,EAAM,GACT,CACX,EAOM,EAAO,CAAC,OAAQ,QAAS,OAAQ,OAAQ,OAAQ,QAAS,OAAQ,OAAQ,QAAQ,CAClF,EAAQ,EACT,GAAG,CAAC,GAAS,EAAM,QAAQ,EAC3B,MAAM,CAAC,GAAQ,EAAK,IAAI,CAAC,GAAO,EAAK,QAAQ,CAAC,KAC9C,IAAI,GACT,GAAI,CAAC,EAAM,MAAM,CAAE,MAAM,AAAI,MAAM,uCAEnC,IAAM,EAAO,CAAC,EACd,GAAI,CAEA,IAAM,EADc,AACP,KADY,KAAK,CAAC,MAAM,KAAgB,GAC7B,CAAC,oBAAoB,CAC7C,GAAI,EAAM,CACN,IAAM,EAAO,EAAK,eAAe,CAC3B,EAAQ,EAAK,gBAAgB,CAC7B,EAAK,GAAS,GAAS,GAAK,GAAS,GAAK,OAAO,GAAO,QAAQ,CAAC,EAAG,KAAO,KACjF,EAAK,QAAQ,CAAG,CACZ,MAAO,EAAK,KAAK,EAAI,EAAK,IAAI,CAC9B,UAAW,EAAK,SAAS,CACzB,SAAU,EAAK,QAAQ,EAAI,EAAK,IAAI,CACpC,OAAQ,EAAK,OAAO,CAAG,EAAK,OAAO,CAAC,GAAG,CAAC,GAAK,CAAA,EAAG,EAAE,MAAM,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,MAAQ,GACrF,UAAW,GAAQ,EAAQ,CAAA,EAAG,EAAK,CAAC,EAAE,EAAA,CAAI,MAAG,CACjD,CACJ,MACI,CADG,CACE,QAAQ,CAAG,CAAE,MAAO,EAAK,IAAK,AAAD,CAE1C,CAAE,KAAM,CACJ,EAAK,QAAQ,CAAG,CAAE,MAAO,EAAK,IAAI,AAAC,CACvC,CAiBA,OAhBA,EAAK,QAAQ,CAAG,IAAM,EAAS,CAAK,CAAC,EAAE,EACvC,EAAK,QAAQ,CAAG,EAAM,GAAG,CAAC,IAAS,CAC/B,EAD8B,CAC1B,EACJ,KAAM,IAAM,EAAK,GACjB,OAAQ,IAAM,CArCd,EAAK,GAAG,CAAC,IAAO,UAAU,GAAO,IAAI,eAAe,CAAC,IACrD,EAAK,MAAM,CAAC,GACZ,EAAM,MAAM,CAAC,AAmCQ,IACrB,KAAM,EAAQ,GAClB,CAAC,EACD,EAAK,GAAG,CAAG,EAAM,GAAG,CAAC,IAAS,CAAE,EAAH,IAAU,EAAM,KAAM,EAAK,CAAC,EACzD,EAAK,SAAS,CAAG,CAAE,OAAQ,eAAgB,EAC3C,EAAK,WAAW,CAAG,IAAS,CAAE,EAAH,IAAU,EAAK,QAAQ,CAAC,SAAS,CAAC,GAAK,EAAE,EAAE,GAAK,GAAM,CAAC,CAClF,EAAK,YAAY,CAAG,GAAQ,CAAC,EAAM,KAAK,CACxC,EAAK,cAAc,CAAG,GAAO,EAAI,eAAe,CAChD,EAAK,OAAO,CAAG,KACX,IAAK,IAAM,KAAO,EAAK,MAAM,GACzB,IAAK,IAAM,KAAO,EAAK,IAAI,eAAe,CAAC,EACnD,EACO,CACX"}