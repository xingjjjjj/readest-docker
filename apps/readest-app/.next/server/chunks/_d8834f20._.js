module.exports=[612206,e=>{"use strict";let t,r=(e,t)=>[-1,...t,e.length].reduce(({xs:t,a:r},i)=>({xs:t?.concat([e.slice(r+1,i)])??[],a:i}),{}).xs,i=/\d/,s=/^epubcfi\((.*)\)$/,a=e=>e.replace(/[\^[\](),;=]/g,"^$&"),n=e=>s.test(e)?e:`epubcfi(${e})`,o=(t=(...e)=>e.join("!"),(...e)=>`epubcfi(${t(...e.map(e=>e.match(s)?.[1]??e))})`),l=(e,t)=>{let r;return r=([e])=>e===t,e.map((e,t,i)=>r(e,t,i)?t:null).filter(e=>null!=e)},f=e=>{let t,r=[];for(let[i,s]of e){if("/"===i)r.push({index:s});else{let e=r[r.length-1];if(":"===i)e.offset=s;else if("~"===i)e.temporal=s;else if("@"===i)e.spatial=(e.spatial??[]).concat(s);else if(";s"===i)e.side=s;else if("["===i)if("/"===t&&s)e.id=s;else{e.text=(e.text??[]).concat(s);continue}}t=i}return r},c=e=>r(e,l(e,"!")).map(f),h=e=>{let t=(e=>{let t=[],r,s,a="",n=e=>(t.push(e),r=null,a=""),o=e=>(a+=e,s=!1);for(let t of Array.from(e.trim()).concat("")){if("^"===t&&!s){s=!0;continue}if("!"===r)n(["!"]);else if(","===r)n([","]);else if("/"===r||":"===r)if(i.test(t)){o(t);continue}else n([r,parseInt(a)]);else if("~"===r)if(i.test(t)||"."===t){o(t);continue}else n(["~",parseFloat(a)]);else if("@"===r){if(":"===t){n(["@",parseFloat(a)]),r="@";continue}if(i.test(t)||"."===t){o(t);continue}n(["@",parseFloat(a)])}else if("["===r){";"!==t||s?","!==t||s?"]"!==t||s?o(t):n(["[",a]):(n(["[",a]),r="["):(n(["[",a]),r=";");continue}else if(r?.startsWith(";")){"="!==t||s?";"!==t||s?"]"!==t||s?o(t):n([r,a]):(n([r,a]),r=";"):(r=`;${a}`,a="");continue}("/"===t||":"===t||"~"===t||"@"===t||"["===t||"!"===t||","===t)&&(r=t)}return t})(e.match(s)?.[1]??e),a=l(t,",");if(!a.length)return c(t);let[n,o,f]=r(t,a).map(c);return{parent:n,start:o,end:f}},u=({index:e,id:t,offset:r,temporal:i,spatial:s,text:n,side:o})=>{let l=o?`;s=${o}`:"";return`/${e}`+(t?`[${a(t)}${l}]`:"")+(null!=r&&e%2?`:${r}`:"")+(i?`~${i}`:"")+(s?`@${s.join(":")}`:"")+(n||!t&&o?"["+(n?.map(a)?.join(",")??"")+l+"]":"")},p=e=>e.parent?[e.parent,e.start,e.end].map(p).join(","):e.map(e=>e.map(u).join("")).join("!"),d=e=>n(p(e)),m=(e,t)=>{let r,i;return"string"==typeof e?d(m(h(e),t)):e.parent?(r=e.parent,i=e[t?"end":"start"],r.slice(0,-1).concat([r[r.length-1].concat(i[0])]).concat(i.slice(1))):e},g=(e,t)=>{"string"==typeof e&&(e=h(e)),"string"==typeof t&&(t=h(t)),e=m(e),t=m(t,!0);let r=e[e.length-1],i=t[t.length-1],s=[],a=[],n=[],o=!0,l=Math.max(r.length,i.length);for(let e=0;e<l;e++){let t=r[e],l=i[e];(o&&=t?.index===l?.index&&!t?.offset&&!l?.offset)?s.push(t):(t&&a.push(t),l&&n.push(l))}return d({parent:e.slice(0,-1).concat([s]),start:[a],end:[n]})},w=(e,t)=>{if("string"==typeof e&&(e=h(e)),"string"==typeof t&&(t=h(t)),e.start||t.start)return w(m(e),m(t))||w(m(e,!0),m(t,!0));for(let r=0;r<Math.max(e.length,t.length);r++){let i=e[r]??[],s=t[r]??[],a=Math.max(i.length,s.length)-1;for(let e=0;e<=a;e++){let t=i[e],r=s[e];if(!t)return -1;if(!r||t.index>r.index)return 1;if(t.index<r.index)return -1;if(e===a){if(t.offset>r.offset)return 1;if(t.offset<r.offset)return -1}}}return 0},y=({nodeType:e})=>3===e||4===e,_=(e,t)=>{let r=Array.from(e.childNodes).filter(e=>y(e)||(({nodeType:e})=>1===e)(e));return t?r.map(e=>{let r=t(e);return r===NodeFilter.FILTER_REJECT?null:r===NodeFilter.FILTER_SKIP?_(e,t):e}).flat().filter(e=>e):r},b=(e,t)=>{let r=_(e,t).reduce((e,t)=>{let r=e[e.length-1];return r?y(t)?Array.isArray(r)?r.push(t):y(r)?e[e.length-1]=[r,t]:e.push(t):(({nodeType:e})=>1===e)(r)?e.push(null,t):e.push(t):e.push(t),e},[]);return(({nodeType:e})=>1===e)(r[0])&&r.unshift("first"),(({nodeType:e})=>1===e)(r[r.length-1])&&r.push("last"),r.unshift("before"),r.push("after"),r},v=(e,t,r)=>{let{id:i}=t[t.length-1];if(i){let t=e.ownerDocument.getElementById(i);if(t)return{node:t,offset:0}}for(let{index:i}of t){let t=e?b(e,r)[i]:null;if("first"===t)return{node:e.firstChild??e};if("last"===t)return{node:e.lastChild??e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}let{offset:s}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:s};let a=0;for(let t of e){let{length:e}=t.nodeValue;if(a+e>=s)return{node:t,offset:s-a};a+=e}},R=(e,t,r)=>{let{parentNode:i,id:s}=e,a=b(i,r),n=a.findIndex(t=>Array.isArray(t)?t.some(t=>t===e):t===e),o=a[n];if(Array.isArray(o)){let r=0;for(let i of o)if(i===e){r+=t;break}else r+=i.nodeValue.length;t=r}let l={id:s,index:n,offset:t};return(i!==e.ownerDocument.documentElement?R(i,null,r).concat(l):[l]).filter(e=>-1!==e.index)},I={fromIndex:e=>n(`/6/${(e+1)*2}`),toIndex:e=>e?.at(-1).index/2-1};e.s(["collapse",0,m,"compare",0,w,"fake",0,I,"fromCalibreHighlight",0,({spine_index:e,start_cfi:t,end_cfi:r})=>{let i=I.fromIndex(e)+"!";return g(i+t.slice(2),i+r.slice(2))},"fromCalibrePos",0,e=>{let[t]=h(e),r=t.shift();return t.shift(),d([[{index:6},r],t])},"fromElements",0,e=>{let t=[],{parentNode:r}=e[0],i=R(r);for(let[s,a]of b(r).entries()){let r=e[t.length];a===r&&t.push(d([i.concat({id:r.id,index:s})]))}return t},"fromRange",0,(e,t)=>{let{startContainer:r,startOffset:i,endContainer:s,endOffset:a}=e,n=R(r,i,t);return e.collapsed?d([n]):g([n],[R(s,a,t)])},"isCFI",0,s,"joinIndir",0,o,"parse",0,h,"toElement",0,(e,t)=>v(e.documentElement,m(t)).node,"toRange",0,(e,t,r)=>{let i=m(t),s=m(t,!0),a=e.documentElement,n=v(a,i[0],r),o=v(a,s[0],r),l=e.createRange();return n.before?l.setStartBefore(n.node):n.after?l.setStartAfter(n.node):l.setStart(n.node,n.offset),o.before?l.setEndBefore(o.node):o.after?l.setEndAfter(o.node):l.setEnd(o.node,o.offset),l}])},826165,e=>{"use strict";var t,r,i,s,a;function n(e,t,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)}function o(e,t,r,i,s){if("m"===i)throw TypeError("Private method is not writable");if("a"===i&&!s)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?s.call(e,r):s?s.value=r:t.set(e,r),r}"function"==typeof SuppressedError&&SuppressedError;let l="__TAURI_TO_IPC_KEY__";class f{constructor(e){t.set(this,void 0),r.set(this,0),i.set(this,[]),s.set(this,void 0),o(this,t,e||(()=>{}),"f"),this.id=function(e,t=!1){return window.__TAURI_INTERNALS__.transformCallback(e,t)}(e=>{let a=e.index;if("end"in e)return void(a==n(this,r,"f")?this.cleanupCallback():o(this,s,a,"f"));let l=e.message;if(a==n(this,r,"f")){for(n(this,t,"f").call(this,l),o(this,r,n(this,r,"f")+1,"f");n(this,r,"f")in n(this,i,"f");){let e=n(this,i,"f")[n(this,r,"f")];n(this,t,"f").call(this,e),delete n(this,i,"f")[n(this,r,"f")],o(this,r,n(this,r,"f")+1,"f")}n(this,r,"f")===n(this,s,"f")&&this.cleanupCallback()}else n(this,i,"f")[a]=l})}cleanupCallback(){window.__TAURI_INTERNALS__.unregisterCallback(this.id)}set onmessage(e){o(this,t,e,"f")}get onmessage(){return n(this,t,"f")}[(t=new WeakMap,r=new WeakMap,i=new WeakMap,s=new WeakMap,l)](){return`__CHANNEL__:${this.id}`}toJSON(){return this[l]()}}async function c(e,t={},r){return window.__TAURI_INTERNALS__.invoke(e,t,r)}function h(e,t="asset"){return window.__TAURI_INTERNALS__.convertFileSrc(e,t)}class u{get rid(){return n(this,a,"f")}constructor(e){a.set(this,void 0),o(this,a,e,"f")}async close(){return c("plugin:resources|close",{rid:this.rid})}}a=new WeakMap,e.s(["Channel",()=>f,"Resource",()=>u,"convertFileSrc",()=>h,"invoke",()=>c],826165)},144480,e=>{"use strict";var t=e.i(509979),r=e.i(227711),i=e.i(922987),s=e.i(199236),a=e.i(57990);let n=async()=>"",o={resolvePath:(e,t)=>{let r="undefined"!=typeof process;switch("undefined"!=typeof process&&console.log("[ResolvePath] Env Check - NEXT_PUBLIC_STORAGE_MODE:","local","isLocalMode:",r,"base:",t,"path:",e),t){case"Data":return{baseDir:0,basePrefix:n,fp:`${a.DATA_SUBDIR}/${e}`,base:t};case"Settings":return{baseDir:0,basePrefix:n,fp:`.readest/${e}`,base:t};case"Books":if("library.json"===e||"library.json.bak"===e||"library_backup.json"===e)return console.log("[ResolvePath] Books/Library detected, routing to .readest"),{baseDir:0,basePrefix:n,fp:`.readest/${e}`,base:t};return console.log("[ResolvePath] ✓ Books base, flat path (no prefix):",e),console.log("[ResolvePath] ✓ Returning fp:",e),{baseDir:0,basePrefix:n,fp:e,base:t};case"Fonts":return{baseDir:0,basePrefix:n,fp:`${a.LOCAL_FONTS_SUBDIR}/${e}`,base:t};case"Images":return{baseDir:0,basePrefix:n,fp:`${a.LOCAL_IMAGES_SUBDIR}/${e}`,base:t};case"None":return{baseDir:0,basePrefix:n,fp:e,base:t};default:return{baseDir:0,basePrefix:n,fp:`${t}/${e}`,base:t}}},async getPrefix(e){let{basePrefix:t,fp:r}=this.resolvePath("",e),i=await t();return(r?i?`${i}/${r}`:r:i).replace(/\/+$/,"")},getURL:e=>(0,t.isValidURL)(e)?e:`/api/storage/file?filePath=${encodeURIComponent(e)}`,async getBlobURL(e,t){try{let r=await this.readFile(e,t,"binary");return URL.createObjectURL(new Blob([r]))}catch{return e}},async getImageURL(e){return this.getURL(e)},async openFile(e,i,s){if((0,t.isValidURL)(e))return await new r.RemoteFile(e,s).open();let{fp:a}=this.resolvePath(e,i),n=await fetch(`/api/storage/file?filePath=${encodeURIComponent(a)}`);if(!n.ok)throw Error("File not found");return new File([await n.arrayBuffer()],s||e)},async copyFile(e,t,r){let i=await this.openFile(e,r);await this.writeFile(t,r,i)},async readFile(e,t,r){let{fp:i}=this.resolvePath(e,t),s=await fetch(`/api/storage/file?filePath=${encodeURIComponent(i)}`);if(!s.ok)throw Error(`File not found: ${i}`);return"text"===r?await s.text():await s.arrayBuffer()},async writeFile(e,t,r){let i,{fp:s}=this.resolvePath(e,t);if(console.log("[APIFileSystem.writeFile] 11. Input path:",e),console.log("[APIFileSystem.writeFile] 12. Base:",t),console.log("[APIFileSystem.writeFile] 13. Resolved fp:",s),i=r instanceof File?Buffer.from(await r.arrayBuffer()):Buffer.from(r),console.log("[APIFileSystem.writeFile] 14. Calling PUT /api/storage/file with filePath:",s),!(await fetch(`/api/storage/file?filePath=${encodeURIComponent(s)}`,{method:"PUT",body:i})).ok)throw Error("Failed to write file")},async removeFile(e,t){let{fp:r}=this.resolvePath(e,t);if(!(await fetch(`/api/storage/delete?fileKey=${encodeURIComponent(r)}`,{method:"DELETE"})).ok)throw Error("Failed to delete file")},async createDir(e,t){},async removeDir(e,t){},readDir:async(e,t)=>[],async exists(e,t){let{fp:r}=this.resolvePath(e,t);return(await fetch(`/api/storage/file?filePath=${encodeURIComponent(r)}`)).ok},async stats(e,t){let{fp:r}=this.resolvePath(e,t),i=await fetch(`/api/storage/file?filePath=${encodeURIComponent(r)}`);if(!i.ok)throw Error("File not found");return{isFile:!0,isDirectory:!1,size:(await i.arrayBuffer()).byteLength,mtime:null,atime:null,birthtime:null}}};class l extends s.BaseAppService{get fs(){return o}isMobile=["android","ios"].includes((0,t.getOSPlatform)());appPlatform="web";hasSafeAreaInset=(0,i.isPWA)();async init(){await this.loadSettings(),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let e=await this.loadSettings(),t=e.migrationVersion||0;await super.runMigrations(t),t<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...e,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(e){console.error("Failed to run migrations:",e)}}resolvePath(e,t){return this.fs.resolvePath(e,t)}async setCustomRootDir(){}async selectDirectory(){throw Error("selectDirectory is not supported in browser")}async selectFiles(){throw Error("selectFiles is not supported in browser")}async saveFile(e,t,r){try{let i=new Blob([t],{type:r||"application/octet-stream"}),s=URL.createObjectURL(i),a=document.createElement("a");return a.href=s,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),!0}catch(e){return console.error("Failed to save file:",e),!1}}}e.s(["WebAppService",()=>l],144480)},310848,e=>{e.v(t=>Promise.all(["server/chunks/f449e_@zip_js_zip_js_index_05a28c8a.js"].map(t=>e.l(t))).then(()=>t(531872)))},260943,e=>{e.v(t=>Promise.all(["server/chunks/packages_foliate-js_mobi_f7dd4b25.js"].map(t=>e.l(t))).then(()=>t(3209)))},829768,e=>{e.v(t=>Promise.all(["server/chunks/packages_foliate-js_fb2_669414ef.js"].map(t=>e.l(t))).then(()=>t(906533)))},704396,e=>{e.v(t=>Promise.all(["server/chunks/packages_foliate-js_vendor_fflate_bdf6918a.js"].map(t=>e.l(t))).then(()=>t(880987)))},228371,e=>{e.v(t=>Promise.all(["server/chunks/packages_foliate-js_pdf_6667cb35.js"].map(t=>e.l(t))).then(()=>t(64767)))},926413,e=>{e.v(t=>Promise.all(["server/chunks/packages_foliate-js_epub_2f7535b7.js"].map(t=>e.l(t))).then(()=>t(721448)))},121014,e=>{e.v(t=>Promise.all(["server/chunks/packages_foliate-js_comic-book_4b3761e5.js"].map(t=>e.l(t))).then(()=>t(983135)))}];

//# sourceMappingURL=_d8834f20._.js.map