module.exports=[679627,e=>{"use strict";var t,i,a=e.i(570399);async function r(){return(0,a.invoke)("plugin:path|resolve_directory",{directory:i.AppConfig})}async function o(){return(0,a.invoke)("plugin:path|resolve_directory",{directory:i.AppData})}async function s(){return(0,a.invoke)("plugin:path|resolve_directory",{directory:i.AppCache})}async function n(){return(0,a.invoke)("plugin:path|resolve_directory",{directory:i.AppLog})}async function l(){return(0,a.invoke)("plugin:path|resolve_directory",{directory:i.Temp})}async function c(...e){return(0,a.invoke)("plugin:path|join",{paths:e})}async function h(e,t){return(0,a.invoke)("plugin:path|basename",{path:e,ext:t})}(t=i||(i={}))[t.Audio=1]="Audio",t[t.Cache=2]="Cache",t[t.Config=3]="Config",t[t.Data=4]="Data",t[t.LocalData=5]="LocalData",t[t.Document=6]="Document",t[t.Download=7]="Download",t[t.Picture=8]="Picture",t[t.Public=9]="Public",t[t.Video=10]="Video",t[t.Resource=11]="Resource",t[t.Temp=12]="Temp",t[t.AppConfig=13]="AppConfig",t[t.AppData=14]="AppData",t[t.AppLocalData=15]="AppLocalData",t[t.AppCache=16]="AppCache",t[t.AppLog=17]="AppLog",t[t.Desktop=18]="Desktop",t[t.Executable=19]="Executable",t[t.Font=20]="Font",t[t.Home=21]="Home",t[t.Runtime=22]="Runtime",t[t.Template=23]="Template",e.s(["BaseDirectory",()=>i,"appCacheDir",()=>s,"appConfigDir",()=>r,"appDataDir",()=>o,"appLogDir",()=>n,"basename",()=>h,"join",()=>c,"tempDir",()=>l])},709613,e=>{"use strict";e.i(679627);var t,i,a=e.i(570399);function r(e){return{isFile:e.isFile,isDirectory:e.isDirectory,isSymlink:e.isSymlink,size:e.size,mtime:null!==e.mtime?new Date(e.mtime):null,atime:null!==e.atime?new Date(e.atime):null,birthtime:null!==e.birthtime?new Date(e.birthtime):null,readonly:e.readonly,fileAttributes:e.fileAttributes,dev:e.dev,ino:e.ino,mode:e.mode,nlink:e.nlink,uid:e.uid,gid:e.gid,rdev:e.rdev,blksize:e.blksize,blocks:e.blocks}}(t=i||(i={}))[t.Start=0]="Start",t[t.Current=1]="Current",t[t.End=2]="End";class o extends a.Resource{async read(e){if(0===e.byteLength)return 0;let t=await (0,a.invoke)("plugin:fs|read",{rid:this.rid,len:e.byteLength}),i=function(e){let t=new Uint8ClampedArray(e),i=t.byteLength,a=0;for(let e=0;e<i;e++)a*=256,a+=t[e];return a}(t.slice(-8)),r=t instanceof ArrayBuffer?new Uint8Array(t):t;return e.set(r.slice(0,r.length-8)),0===i?null:i}async seek(e,t){return await (0,a.invoke)("plugin:fs|seek",{rid:this.rid,offset:e,whence:t})}async stat(){return r(await (0,a.invoke)("plugin:fs|fstat",{rid:this.rid}))}async truncate(e){await (0,a.invoke)("plugin:fs|ftruncate",{rid:this.rid,len:e})}async write(e){return await (0,a.invoke)("plugin:fs|write",{rid:this.rid,data:e})}}async function s(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return new o(await (0,a.invoke)("plugin:fs|open",{path:e instanceof URL?e.toString():e,options:t}))}async function n(e,t,i){if(e instanceof URL&&"file:"!==e.protocol||t instanceof URL&&"file:"!==t.protocol)throw TypeError("Must be a file URL.");await (0,a.invoke)("plugin:fs|copy_file",{fromPath:e instanceof URL?e.toString():e,toPath:t instanceof URL?t.toString():t,options:i})}async function l(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");await (0,a.invoke)("plugin:fs|mkdir",{path:e instanceof URL?e.toString():e,options:t})}async function c(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return await (0,a.invoke)("plugin:fs|read_dir",{path:e instanceof URL?e.toString():e,options:t})}async function h(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let i=await (0,a.invoke)("plugin:fs|read_file",{path:e instanceof URL?e.toString():e,options:t});return i instanceof ArrayBuffer?new Uint8Array(i):Uint8Array.from(i)}async function f(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let i=await (0,a.invoke)("plugin:fs|read_text_file",{path:e instanceof URL?e.toString():e,options:t}),r=i instanceof ArrayBuffer?i:Uint8Array.from(i);return new TextDecoder().decode(r)}async function d(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");await (0,a.invoke)("plugin:fs|remove",{path:e instanceof URL?e.toString():e,options:t})}async function u(e,t){return r(await (0,a.invoke)("plugin:fs|stat",{path:e instanceof URL?e.toString():e,options:t}))}async function g(e,t,i){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");if(t instanceof ReadableStream){let a=await s(e,{read:!1,create:!0,write:!0,...i}),r=t.getReader();try{for(;;){let{done:e,value:t}=await r.read();if(e)break;await a.write(t)}}finally{r.releaseLock(),await a.close()}}else await (0,a.invoke)("plugin:fs|write_file",t,{headers:{path:encodeURIComponent(e instanceof URL?e.toString():e),options:JSON.stringify(i)}})}async function p(e,t,i){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let r=new TextEncoder;await (0,a.invoke)("plugin:fs|write_text_file",r.encode(t),{headers:{path:encodeURIComponent(e instanceof URL?e.toString():e),options:JSON.stringify(i)}})}async function m(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return await (0,a.invoke)("plugin:fs|exists",{path:e instanceof URL?e.toString():e,options:t})}a.Resource,e.s(["SeekMode",()=>i,"copyFile",()=>n,"exists",()=>m,"mkdir",()=>l,"open",()=>s,"readDir",()=>c,"readFile",()=>h,"readTextFile",()=>f,"remove",()=>d,"stat",()=>u,"writeFile",()=>g,"writeTextFile",()=>p])},325824,e=>{"use strict";e.i(679627);var t=e.i(191587);e.s(["getBaseFilename",0,e=>{let t=e.replace(/\\/g,"/").split("/").pop()||"",i=t.split(".");return i.length<=1?t:i.slice(0,-1).join(".")},"getDirPath",0,e=>{let t=e.replace(/\\/g,"/").split("/");return t.pop(),t.join("/")},"getFilename",0,e=>(((0,t.isValidURL)(e)||(0,t.isContentURI)(e)||(0,t.isFileURI)(e))&&(e=decodeURI(e)),e.replace(/\\/g,"/").split("/").pop().split("?")[0])])},585260,e=>{"use strict";var t=e.i(709613),i=e.i(191587);class a extends Blob{#e;#t;constructor(e,t){super(),this.#e=e,this.#t=t}async arrayBuffer(){return await this.#e}async text(){let e=await this.#e;return new TextDecoder().decode(e)}stream(){return new ReadableStream({start:async e=>{let t=await this.#e,i=new ReadableStream({start(e){e.enqueue(new Uint8Array(t)),e.close()}}).getReader(),a=()=>i.read().then(({done:t,value:i})=>t?(e.close(),Promise.resolve()):(e.enqueue(i),a()));return a()}})}get type(){return this.#t}}class r extends File{#i=null;#a;#r;#o;#s=0;#n=-1;#t="";static MAX_CACHE_CHUNK_SIZE=1048576;static MAX_CACHE_ITEMS_SIZE=50;#l=[];#c=new Map;#h=new Map;constructor(e,t,i=null,a=""){super([],t||e,{type:a}),this.#a=e,this.#o=i,this.#r=t||e}async open(){this.#i=await (0,t.open)(this.#a,this.#o?{baseDir:this.#o}:void 0);let e=await this.#i.stat();return this.#n=e.size,this.#s=e.mtime?e.mtime.getTime():Date.now(),this}async close(){this.#i&&(await this.#i.close(),this.#i=null),this.#c.clear(),this.#l=[]}get name(){return this.#r}get type(){return this.#t}get size(){return this.#n}get lastModified(){return this.#s}async stat(){return this.#i?.stat()}async seek(e,t){if(!this.#i)throw Error("File handle is not open");return this.#i.seek(e,t)}async readData(e,i){let a=(i=Math.max(e=Math.max(0,e),Math.min(this.size,i)))-e;if(a>r.MAX_CACHE_CHUNK_SIZE){let i=await (0,t.open)(this.#a,this.#o?{baseDir:this.#o}:void 0);try{await i.seek(e,t.SeekMode.Start);let r=new Uint8Array(a);return await i.read(r),r.buffer}finally{await i.close()}}let o=Array.from(this.#c.keys()).find(t=>{let a=this.#c.get(t);return e>=t&&i<=t+a.byteLength});if(void 0!==o){this.#f(o);let t=this.#c.get(o),i=e-o;return t.slice(i,i+a)}let s=`${e}-${i}`,n=this.#h.get(s);if(n)return n;let l=this.#d(e,a);this.#h.set(s,l);try{return await l}finally{this.#h.delete(s)}}async #d(e,i){let a=await (0,t.open)(this.#a,this.#o?{baseDir:this.#o}:void 0);try{let o=Math.max(0,e-1024),s=Math.min(this.size,e+r.MAX_CACHE_CHUNK_SIZE)-o;await a.seek(o,t.SeekMode.Start);let n=new Uint8Array(s);await a.read(n),this.#c.set(o,n.buffer),this.#f(o),this.#u();let l=e-o;return n.buffer.slice(l,l+i)}finally{await a.close()}}#f(e){let t=this.#l.indexOf(e);t>-1&&this.#l.splice(t,1),this.#l.unshift(e)}#u(){for(;this.#c.size>r.MAX_CACHE_ITEMS_SIZE;){let e=this.#l.pop();void 0!==e&&this.#c.delete(e)}}slice(e=0,t=this.size,i=this.type){return new a(this.readData(e,t),i)}stream(){let e=0;return new ReadableStream({pull:async i=>{if(!this.#i)return void i.error(Error("File handle is not open"));if(e>=this.size)return void i.close();let a=new Uint8Array(Math.min(e+1048576,this.size)-e);await this.#i.seek(e,t.SeekMode.Start);let r=await this.#i.read(a);null===r||0===r?i.close():(i.enqueue(a.subarray(0,r)),e+=r)},cancel:async()=>{await this.#i?.close()}})}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}class o extends File{url;#r;#s;#n=-1;#t="";#l=[];#c=new Map;#g=new Map;static MAX_CACHE_CHUNK_SIZE=131072;static MAX_CACHE_ITEMS_SIZE=128;constructor(e,t,i="",a=Date.now()){const r=e.split("/").pop()||"remote-file";super([],t||r,{type:i,lastModified:a}),this.url=e,this.#r=t||r,this.#t=i,this.#s=a}get name(){return this.#r}get type(){return this.#t}get size(){return this.#n}get lastModified(){return this.#s}async _open_with_head(){let e=await fetch(this.url,{method:"HEAD"});if(!e.ok)throw Error(`Failed to fetch file size: ${e.status}`);return this.#n=Number(e.headers.get("content-length")),this.#t=e.headers.get("content-type")||"",this}async _open_with_range(){let e=await fetch(this.url,{headers:{Range:"bytes=0-1023"}});if(!e.ok)throw Error(`Failed to fetch file size: ${e.status}`);return this.#n=Number(e.headers.get("content-range")?.split("/")[1]),this.#t=e.headers.get("content-type")||"",this}async open(){return"android"===(0,i.getOSPlatform)()?this._open_with_range():this._open_with_head()}async close(){this.#c.clear(),this.#l=[]}async fetchRangePart(e,t){e=Math.max(0,e),t=Math.min(this.size-1,t);let i=await fetch(this.url,{headers:{Range:`bytes=${e}-${t}`}});if(!i.ok)throw Error(`Failed to fetch range: ${i.status}`);return i.arrayBuffer()}async fetchRange(e,t){let i=t-e+1;if(i>1024e3){let i=[];for(let a=e;a<=t;a+=1024e3){let e=Math.min(a+1024e3-1,t);i.push(await this.fetchRangePart(a,e))}let a=new Uint8Array(i.reduce((e,t)=>e+t.byteLength,0)),r=0;for(let e of i)a.set(new Uint8Array(e),r),r+=e.byteLength;return a.buffer}{if(i>o.MAX_CACHE_CHUNK_SIZE)return this.fetchRangePart(e,t);let a=Array.from(this.#c.keys()).find(i=>{let a=this.#c.get(i).byteLength;return e>=i&&t<=i+a});if(void 0!==a){this.#f(a);let t=this.#c.get(a),r=e-a;return t.slice(r,r+i)}let r=`${e}-${t}`,s=this.#g.get(r);if(s)return s;let n=this.#p(e,t,i);this.#g.set(r,n);try{return await n}finally{this.#g.delete(r)}}}async #p(e,t,i){let a=Math.max(0,e-1024),r=Math.max(t,e+o.MAX_CACHE_CHUNK_SIZE-1024-1),s=await this.fetchRangePart(a,r);this.#c.set(a,s),this.#f(a),this.#u();let n=e-a;return s.slice(n,n+i)}#f(e){let t=this.#l.indexOf(e);t>-1&&this.#l.splice(t,1),this.#l.unshift(e)}#u(){for(;this.#c.size>o.MAX_CACHE_ITEMS_SIZE;){let e=this.#l.pop();void 0!==e&&this.#c.delete(e)}}slice(e=0,t=this.size,i=this.type){return new a(this.fetchRange(e,t-1),i)}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}e.s(["NativeFile",()=>r,"RemoteFile",()=>o])},597215,e=>{"use strict";let t=new Set(["PDF","CBZ"]);e.s(["FIXED_LAYOUT_FORMATS",0,t])},49422,e=>{"use strict";e.i(747153);let t={EPUB:"epub",PDF:"pdf",MOBI:"mobi",AZW:"azw",AZW3:"azw3",CBZ:"cbz",FB2:"fb2",FBZ:"fbz",TXT:"txt",MD:"md"};class i{file;constructor(e){this.file=e}async isZip(){let e=new Uint8Array(await this.file.slice(0,4).arrayBuffer());return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}async isPDF(){let e=new Uint8Array(await this.file.slice(0,5).arrayBuffer());return 37===e[0]&&80===e[1]&&68===e[2]&&70===e[3]&&45===e[4]}async makeZipLoader(){let t=async()=>{let e=Math.min(65536,this.file.size),t=new Uint8Array(await this.file.slice(this.file.size-e,this.file.size).arrayBuffer());for(let e=t.length-22;e>=0;e--)if(80===t[e]&&75===t[e+1]&&5===t[e+2]&&6===t[e+3]){let i=t[e+20]+(t[e+21]<<8),a=e+22,r=t.slice(a,a+i);return new TextDecoder().decode(r)}return null},{configure:i,ZipReader:a,BlobReader:r,TextWriter:o,BlobWriter:s}=await e.A(831930);i({useWebWorkers:!1});let n=new a(new r(this.file)),l=await n.getEntries(),c=new Map(l.map(e=>[e.filename,e])),h=e=>(t,...i)=>c.has(t)?e(c.get(t),...i):null,f=h(e=>e.getData?e.getData(new o):null);return{entries:l,loadText:f,loadBlob:h((e,t)=>e.getData?e.getData(new s(t)):null),getSize:e=>c.get(e)?.uncompressedSize??0,getComment:t,sha1:void 0}}isCBZ(){return"application/vnd.comicbook+zip"===this.file.type||this.file.name.endsWith(`.${t.CBZ}`)}isFB2(){return"application/x-fictionbook+xml"===this.file.type||this.file.name.endsWith(`.${t.FB2}`)}isFBZ(){return"application/x-zip-compressed-fb2"===this.file.type||this.file.name.endsWith(".fb.zip")||this.file.name.endsWith(".fb2.zip")||this.file.name.endsWith(`.${t.FBZ}`)}async open(){let i=null,a="EPUB";if(!this.file.size)throw Error("File is empty");try{if(await this.isZip()){let r=await this.makeZipLoader(),{entries:o}=r;if(this.isCBZ()){let{makeComicBook:t}=await e.A(701822);i=await t(r,this.file),a="CBZ"}else if(this.isFBZ()){let s=o.find(e=>e.filename.endsWith(`.${t.FB2}`)),n=await r.loadBlob((s??o[0]).filename),{makeFB2:l}=await e.A(695);i=await l(n),a="FBZ"}else{let{EPUB:t}=await e.A(157117);i=await new t(r).init(),a="EPUB"}}else if(await this.isPDF()){let{makePDF:t}=await e.A(497701);i=await t(this.file),a="PDF"}else if(await (await e.A(334401)).isMOBI(this.file)){let t=await e.A(871513),{MOBI:r}=await e.A(334401);switch(i=await new r({unzlib:t.unzlibSync}).open(this.file),this.file.name.split(".").pop()?.toLowerCase()){case"azw":a="AZW";break;case"azw3":a="AZW3";break;default:a="MOBI"}}else if(this.isFB2()){let{makeFB2:t}=await e.A(695);i=await t(this.file),a="FB2"}}catch(e){if(console.error("Failed to open document:",e),e instanceof Error&&e.message?.includes("not a valid zip"))throw Error("Unsupported or corrupted book file");throw e}return{book:i,format:a}}}e.s(["DocumentLoader",()=>i,"EXTS",0,t])},189207,e=>{"use strict";e.i(191587),e.s(["getDirFromLanguage",0,e=>{if(!e)return"auto";let t=new Set(["ar","he","fa","ur","dv","ps","sd","yi"]),i=e.split("-")[0].toLowerCase();return t.has(i)?"rtl":"auto"}])},371081,e=>{"use strict";var t=e.i(399577);function i(e){return(0,t.md5)(e).slice(0,7)}async function a(e){let i=t.md5.create();for(let t=-1;t<=10;t++){let a=Math.min(e.size,1024<<2*t),r=Math.min(a+1024,e.size);if(a>=e.size)break;let o=e.slice(a,r),s=new Uint8Array(await o.arrayBuffer());i.update(s)}return i.hex()}e.s(["md5Fingerprint",()=>i,"partialMD5",()=>a])},374594,e=>e.a(async(t,i)=>{try{e.i(49422),e.i(827667);var a=e.i(191587);e.i(189207);var r=e.i(252919);e.i(371081),e.i(399577);var o=t([r]);[r]=o.then?(await o)():o;let s=(e,t=!1)=>{let i=(0,a.getUserLang)();if(!e)return"";if("string"==typeof e)return e;let r=Object.keys(e);return t?e[r[0]]:e[i]||e[r[0]]},n=["ar","bo","de","en","es","fr","hi","it","nl","pl","pt","ru","th","tr","uk"],l=(e,t)=>{if(!e)return"";let i=e.split(" ");return t&&i.length>1?`${i[i.length-1]}, ${i.slice(0,-1).join(" ")}`:e};e.s(["INIT_BOOK_CONFIG",0,{updatedAt:0},"formatAuthors",0,(e,t,i)=>{let r=(e=>{try{let t="string"==typeof e?e:e?.[0];return t?t.split("-")[0]:""}catch{return""}})(t)||"en",o=!!i&&n.includes(r);return Array.isArray(e)?((e=!1,t="")=>(t=t||(0,a.getUserLang)(),e)?new Intl.ListFormat("en",{style:"narrow",type:"unit"}):new Intl.ListFormat(t,{style:"long",type:"conjunction"}))("zh"===r,r).format(e.map(e=>"string"==typeof e?l(e,o):l(s(e?.name),o))):"string"==typeof e?l(e,o):l(s(e?.name),o)},"formatTitle",0,e=>"string"==typeof e?e:s(e),"getConfigFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,"");return`${t}/config.json`},"getCoverFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,""),i=`${t}/cover.png`;return console.log("[getCoverFilename] ✓ Using relativePath:",e.relativePath),console.log("[getCoverFilename] ✓ Cover path result:",i),i},"getDir",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath.replace(/\.[^.]+$/,"")},"getLibraryBackupFilename",0,()=>"library_backup.json","getLibraryFilename",0,()=>"library.json","getLocalBookFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath},"getPrimaryLanguage",0,e=>{let t=Array.isArray(e)?e[0]:e;if((0,r.isValidLang)(t)){let e=(0,r.normalizedLangCode)(t);return(0,r.code6392to6391)(e)||e}return"en"}]),i()}catch(e){i(e)}},!1),978995,e=>{"use strict";let t="files",i=new class{db=null;initPromise=null;async init(){if(!this.db)return this.initPromise||(this.initPromise=new Promise((e,i)=>{let a=indexedDB.open("readest-cache",1);a.onerror=()=>{console.error("[IndexedDBCache] Failed to open database:",a.error),i(a.error)},a.onsuccess=()=>{this.db=a.result,console.log("[IndexedDBCache] ✓ Database opened successfully"),e()},a.onupgradeneeded=e=>{let i=e.target.result;i.objectStoreNames.contains(t)||(i.createObjectStore(t,{keyPath:"key"}).createIndex("expiresAt","expiresAt",{unique:!1}),console.log("[IndexedDBCache] ✓ Object store created"))}})),this.initPromise}async get(e){return(await this.init(),this.db)?new Promise((i,a)=>{let r=this.db.transaction(t,"readonly").objectStore(t).get(e);r.onerror=()=>a(r.error),r.onsuccess=()=>{let t=r.result;t&&t.expiresAt&&Date.now()>t.expiresAt?(console.log("[IndexedDBCache] Cache expired for:",e),this.delete(e).catch(e=>console.error("Failed to delete expired cache:",e)),i(null)):(t&&console.log("[IndexedDBCache] ✓ Cache hit for:",e),i(t||null))}}):null}async set(e,i,a,r){if(await this.init(),!this.db)return;let o={key:e,data:i,mimeType:a,etag:r?.etag,timestamp:Date.now(),expiresAt:r?.ttl?Date.now()+r.ttl:void 0};return new Promise((i,a)=>{let r=this.db.transaction(t,"readwrite").objectStore(t).put(o);r.onerror=()=>a(r.error),r.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache saved for:",e),i()}})}async delete(e){if(await this.init(),this.db)return new Promise((i,a)=>{let r=this.db.transaction(t,"readwrite").objectStore(t).delete(e);r.onerror=()=>a(r.error),r.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache deleted for:",e),i()}})}async clear(){if(await this.init(),this.db)return new Promise((e,i)=>{let a=this.db.transaction(t,"readwrite").objectStore(t).clear();a.onerror=()=>i(a.error),a.onsuccess=()=>{console.log("[IndexedDBCache] ✓ All caches cleared"),e()}})}async clearExpired(){return(await this.init(),this.db)?new Promise((e,i)=>{let a=this.db.transaction(t,"readwrite").objectStore(t),r=a.index("expiresAt"),o=IDBKeyRange.upperBound(Date.now()),s=r.openCursor(o),n=0;s.onerror=()=>i(s.error),s.onsuccess=t=>{let i=t.target.result;i?(console.log("[IndexedDBCache] Deleting expired cache:",i.key),a.delete(i.primaryKey),n++,i.continue()):(console.log("[IndexedDBCache] ✓ Cleared",n,"expired caches"),e(n))}}):0}async getStats(){return(await this.init(),this.db)?new Promise((e,i)=>{let a=this.db.transaction(t,"readonly").objectStore(t).getAll();a.onerror=()=>i(a.error),a.onsuccess=()=>{let t,i,r=a.result,o=0;r.forEach(e=>{o+=e.data.byteLength,(!t||e.timestamp<t.timestamp)&&(t={key:e.key,timestamp:e.timestamp}),(!i||e.timestamp>i.timestamp)&&(i={key:e.key,timestamp:e.timestamp})}),console.log("[IndexedDBCache] Stats:",{entries:r.length,size:(o/1024/1024).toFixed(2)+" MB"}),e({totalEntries:r.length,totalSize:o,oldestEntry:t,newestEntry:i})}}):{totalEntries:0,totalSize:0}}},a={cacheStrategy:"cache-first",cacheTTL:2592e6};async function r(e,t={}){let o={...a,...t},s=`file_${e}`;console.log(`[cachedFetch] Fetching: ${e}, strategy: ${o.cacheStrategy}`);try{if("cache-first"===o.cacheStrategy&&!o.bypassCache){let t=await i.get(s);if(t){console.log(`[cachedFetch] ✓ Using cached data for: ${e}`);let i=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),...t.etag&&{ETag:t.etag}});return{data:t.data,headers:i,fromCache:!0}}}let t=new Headers(o.headers||{}),a=await fetch(e,{method:"GET",headers:t,signal:AbortSignal.timeout(3e4)});if(304===a.status){console.log(`[cachedFetch] 304 Not Modified for: ${e}`);let t=await i.get(s);if(t){let e=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),ETag:a.headers.get("ETag")||t.etag||""});return{data:t.data,headers:e,fromCache:!0}}}if(!a.ok)throw Error(`HTTP ${a.status}: ${a.statusText}`);let r=parseInt(a.headers.get("Content-Length")||"0",10),n=a.body?.getReader(),l=[],c=0;if(n)for(;;){let{done:e,value:t}=await n.read();if(e)break;if(l.push(t),c+=t.length,r>0&&o.onProgress){let e=Math.round(c/r*100);o.onProgress(e)}}else l.push(new Uint8Array(await a.arrayBuffer()));let h=new ArrayBuffer(c),f=new Uint8Array(h),d=0;for(let e of l)f.set(e,d),d+=e.length;let u=a.headers.get("Content-Type")||"application/octet-stream",g=a.headers.get("ETag");return o.bypassCache||200!==a.status||i.set(s,h,u,{etag:g||void 0,ttl:o.cacheTTL}).catch(t=>{console.warn(`[cachedFetch] Failed to cache ${e}:`,t)}),console.log(`[cachedFetch] ✓ Fetched ${(h.byteLength/1024/1024).toFixed(2)} MB from network`),{data:h,headers:a.headers,fromCache:!1}}catch(a){console.warn(`[cachedFetch] Network error for ${e}:`,a);let t=await i.get(s);if(t){console.log(`[cachedFetch] ℹ Using stale cache due to network error: ${e}`);let i=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),Warning:'199 - "Stale cache used due to network error"'});return{data:t.data,headers:i,fromCache:!0}}throw a}}async function o(e,t={}){let{data:i,headers:a}=await r(e,t),s=new Blob([i],{type:a.get("Content-Type")||"application/octet-stream"});return URL.createObjectURL(s)}e.s(["cachedFetchAsUrl",()=>o],978995)},109166,e=>{"use strict";e.s(["deserializeConfig",0,(e,t,i)=>{let a=JSON.parse(e),{viewSettings:r,searchConfig:o}=a;return a.viewSettings={...t,...r},a.searchConfig={...i,...o},a.updatedAt??=Date.now(),a},"serializeConfig",0,(e,t,i)=>{let a=(e=JSON.parse(JSON.stringify(e))).viewSettings,r=e.searchConfig;return e.viewSettings=Object.entries(a).reduce((e,[i,a])=>(t[i]!==a&&(e[i]=a),e),{}),e.searchConfig=Object.entries(r).reduce((e,[t,a])=>(i[t]!==a&&(e[t]=a),e),{}),JSON.stringify(e)}])},772754,e=>e.a(async(t,i)=>{try{var a=e.i(371081),r=e.i(325824),o=e.i(252919),s=t([o]);[o]=s.then?(await s)():s;let n={lastAccessDate:new Date(0),lastModDate:new Date(0)},l=e=>e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"";class c{async convert(e){let{file:t,author:i,language:s}=e,n=await t.arrayBuffer(),l=this.detectEncoding(n)||"utf-8";console.log(`Detected encoding: ${l}`);let c=new TextDecoder(l).decode(n).trim(),h=this.extractBookTitle((0,r.getBaseFilename)(t.name)),f=`${h}.epub`,d=c.slice(0,1024),u=d.match(/[【\[]?作者[】\]]?[:：\s]\s*(.+)\r?\n/)||d.match(/[【\[]?\s*(.+)\s+著\s*[】\]]?\r?\n/),g=u?u[1].trim():i||"";try{g=g.replace(/^[\p{P}\p{S}]+|[\p{P}\p{S}]+$/gu,"")}catch{}let p=g||i||"",m=s||(0,o.detectLanguage)(d);console.log(`Detected language: ${m}`);let w=await (0,a.partialMD5)(t),y={bookTitle:h,author:p,language:m,identifier:w},b=[];for(let e=8;e>=6;e--){if(b=this.extractChapters(c,y,{linesBetweenSegments:e,fallbackParagraphsPerChapter:100}),0===b.length)throw Error("No chapters detected.");if(b.length>1)break}let k=await this.createEpub(b,y);return{file:new File([k],f),bookTitle:h,chapterCount:b.length,language:m}}extractChapters(e,t,i){let{language:a}=t,{linesBetweenSegments:r,fallbackParagraphsPerChapter:o}=i,s=RegExp(`(?:\\r?\\n){${r},}|-{8,}\r?
`),n=[];if("zh"===a)n.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`第[零〇一二三四五六七八九十0-9][零〇一二三四五六七八九十百千万0-9]*(?:[章卷节回讲篇封本册部话])(?:[：:、 　\(\)0-9]*[^\n-]{0,24})(?!\S)`,String.raw`(?:楔子|前言|简介|引言|序言|序章|总论|概论|后记)(?:[：: 　][^\n-]{0,24})?(?!\S)`,String.raw`chapter[\s.]*[0-9]+(?:[：:. 　]+[^\n-]{0,50})?(?!\S)`].join("|")+")","gui")),n.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`[一二三四五六七八九十][零〇一二三四五六七八九十百千万]?[：:、 　][^\n-]{0,24}(?=\n|$)`,String.raw`[0-9]+[^\n]{0,16}(?=\n|$)`].join("|")+")","gu"));else{let e=String.raw`(\d+|(?:[IVXLCDM]{2,}|V|X|L|C|D|M)\b)`,t=String.raw`\.\d{1,4}`,i=String.raw`[^\n]{0,50}`,a=["Chapter","Part","Section","Book","Volume","Act"].map(a=>String.raw`${a}\s*(?:${e}|${t})(?:[:.\-–—]?\s*${i})?`).join("|"),r=["Prologue","Epilogue","Introduction","Foreword","Preface","Afterword"].map(e=>String.raw`${e}(?:[:.\-–—]?\s*${i})?`).join("|"),o=String.raw`(?:^|\n|\s)(?:${a}|${r})(?=\s|$)`;n.push(RegExp(o,"gi"))}let c=e=>(e=l(e)).replace(/-{8,}|_{8,}/g,"\n").split(/\n+/).map(e=>e.trim()).filter(e=>e).join("</p><p>"),h=e=>e.reduce((e,t,i,a)=>(void 0===t&&i>0&&i<a.length-1&&void 0!==a[i-1]&&void 0!==a[i+1]?e[e.length-1]+=a[i+1]:void 0!==t&&(0===i||void 0!==a[i-1])&&e.push(t),e),[]),f=(e,t=1e5)=>{let i=e.filter(e=>e&&e.trim().length>0);return!(i.length<=1)&&!i.some(e=>e.length>t)},d=[];for(let t of e.split(s)){let e=t.replace(/<!--.*?-->/g,"").trim();if(!e)continue;let i=[],r=[];for(let t of n){let i=e.split(t);if(f(i)){r=h(i);break}}if(0===r.length&&o>0){let t=e.split(/\n+/),i=t.length;for(let e=0;e<i;e+=o){let i=t.slice(e,e+o),a=c(i.join("\n")),r=`${d.length+1}`,s=`<h2>${r}</h2><p>${a}</p>`;d.push({title:r,content:s,text:i.join("\n"),isVolume:!1})}continue}for(let e=1;e<r.length;e+=2){let t=r[e]?.trim()||"",o=r[e+1]?.trim()||"",s=!1,n=(s="zh"===a?/第[零〇一二三四五六七八九十百千万0-9]+(卷|本|册|部)/.test(t):/\b(Part|Volume|Book)\b/i.test(t))?`<h1>${t}</h1>`:`<h2>${t}</h2>`,h=c(o);i.push({title:l(t),content:`${n}<p>${h}</p>`,text:o,isVolume:s})}if(r[0]&&r[0].trim()){let e=r[0].trim(),t=e.split("\n")[0].trim(),a=(t.length>16?e.split(/[\n\s\p{P}]/u)[0].trim():t)||e.slice(0,16),o=c(e);i.unshift({title:l(a),content:`<h3></h3><p>${o}</p>`,text:e,isVolume:!1})}d.push(...i)}return d}async createEpub(t,i){let{BlobWriter:a,TextReader:r,ZipWriter:s}=await e.A(831930),{bookTitle:c,author:h,language:f,identifier:d}=i,u=new s(new a("application/epub+zip"),{extendedTimestamp:!1});await u.add("mimetype",new r("application/epub+zip"),n),await u.add("META-INF/container.xml",new r(`<?xml version="1.0" encoding="UTF-8"?>
    <container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
      <rootfiles>
        <rootfile full-path="content.opf" media-type="application/oebps-package+xml"/>
      </rootfiles>
    </container>`.trim()),n);let g=!1,p="";for(let e=0;e<t.length;e++){let i=`chapter${e+1}`,a=e+1;t[e].isVolume&&g&&(p+=`</navPoint>
`,g=!g),p+=`<navPoint id="navPoint-${i}" playOrder="${a}">
<navLabel><text>${t[e].title}</text></navLabel>
<content src="./OEBPS/${i}.xhtml" />
`,t[e].isVolume&&!g?g=!g:p+=`</navPoint>
`}g&&(p+="</navPoint>");let m=`<?xml version="1.0" encoding="UTF-8"?>
    <ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
      <head>
        <meta name="dtb:uid" content="book-id" />
        <meta name="dtb:depth" content="1" />
        <meta name="dtb:totalPageCount" content="0" />
        <meta name="dtb:maxPageNumber" content="0" />
      </head>
      <docTitle>
        <text>${l(c)}</text>
      </docTitle>
      <docAuthor>
        <text>${l(h)}</text>
      </docAuthor>
      <navMap>
        ${p}
      </navMap>
    </ncx>`.trim();await u.add("toc.ncx",new r(m),n);let w=t.map((e,t)=>`
      <item id="chap${t+1}" href="OEBPS/chapter${t+1}.xhtml" media-type="application/xhtml+xml"/>
    `).join("\n").trim(),y=t.map((e,t)=>`
      <itemref idref="chap${t+1}"/>`).join("\n").trim(),b=`
      body { line-height: 1.6; font-size: 1em; font-family: 'Arial', sans-serif; text-align: justify; }
      p { text-indent: 2em; margin: 0; }
    `;await u.add("style.css",new r(b),n);for(let e=0;e<t.length;e++){let i=t[e],a=(0,o.detectLanguage)(i.text),s=`<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" lang="${a}" xml:lang="${a}">
          <head>
            <title>${i.title}</title>
            <link rel="stylesheet" type="text/css" href="../style.css"/>
          </head>
          <body>${i.content}</body>
        </html>`.trim();await u.add(`OEBPS/chapter${e+1}.xhtml`,new r(s),n)}let k=`<?xml version="1.0" encoding="UTF-8"?>
      <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="book-id" version="2.0">
        <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
          <dc:title>${l(c)}</dc:title>
          <dc:language>${f}</dc:language>
          <dc:creator>${l(h)}</dc:creator>
          <dc:identifier id="book-id">${d}</dc:identifier>
        </metadata>
        <manifest>
          ${w}
          <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
          <item id="css" href="style.css" media-type="text/css"/>
        </manifest>
        <spine toc="ncx">
          ${y}
        </spine>
      </package>`.trim();return await u.add("content.opf",new r(k),n),await u.close()}detectEncoding(e){try{return new TextDecoder("utf-8",{fatal:!0}).decode(e),"utf-8"}catch{let t=new Uint8Array(e),i=0,a=0,r=Math.min(t.length,1e4);for(let e=0;e<r;e++)try{new TextDecoder("utf-8",{fatal:!0}).decode(t.slice(e,e+100)),i+=100,a+=100,e+=99}catch{a++}let o=i/a*100;if(console.log(`UTF-8 validity: ${o.toFixed(2)}%`),o>80)return console.log("Treating as UTF-8 despite some invalid sequences"),"utf-8"}let t=new Uint8Array(e.slice(0,4));if(255===t[0]&&254===t[1])return"utf-16le";if(254===t[0]&&255===t[1])return"utf-16be";if(239===t[0]&&187===t[1]&&191===t[2])return"utf-8";let i=new Uint8Array(e.slice(0,Math.min(1024,e.byteLength))),a=0;for(let e=0;e<i.length;e++)i[e]>=128&&a++;let r=a/i.length;if(r>.3)return"gbk";if(r>.1){let e=!1;for(let t=0;t<i.length-1;t++){let a=i[t],r=i[t+1];if((a>=129&&a<=159||a>=224&&a<=252)&&(r>=64&&r<=126||r>=128&&r<=252)){e=!0;break}}return e?"shift-jis":"gb18030"}return"utf-8"}extractBookTitle(e){let t=e.match(/《([^》]+)》/);return t?t[1]:e.split(".")[0]}}e.s(["TxtToEpubConverter",()=>c]),i()}catch(e){i(e)}},!1),185851,e=>{"use strict";e.s(["BOOK_FILE_NOT_FOUND_ERROR",0,"Book file not found"])},966569,e=>{"use strict";var t=e.i(191587);let i=new Set([1028,2052,3076,4100,19,33]);e.s(["parseFontInfo",0,(e,a)=>{let r=a.replace(/\.[^/.]+$/,"");try{var o,s,n,l;let a,r=new DataView(e),c=r.getUint32(0,!1);if(65536!==c&&0x74727565!==c&&0x4f54544f!==c)throw Error("Unsupported font format");let h=r.getUint16(4,!1),f=0,d=0,u=0;for(let e=0;e<h;e++){let t=12+16*e,i=String.fromCharCode(r.getUint8(t),r.getUint8(t+1),r.getUint8(t+2),r.getUint8(t+3));"name"===i?f=r.getUint32(t+8,!1):"OS/2"===i?d=r.getUint32(t+8,!1):"fvar"===i&&(u=r.getUint32(t+8,!1))}if(0===f)throw Error("Name table not found");let g=r.getUint16(f+2,!1),p=r.getUint16(f+4,!1),m=(0,t.getUserLang)(),w=[],y=[],b=[],k=[];for(let e=0;e<g;e++){let t=f+6+12*e,i=r.getUint16(t,!1),a=r.getUint16(t+4,!1),o=r.getUint16(t+6,!1),s=r.getUint16(t+8,!1),n=r.getUint16(t+10,!1);if(1===o||2===o||16===o||17===o){let e=f+p+n,t="";if(0===i||3===i?t=function(e,t,i){let a=[];for(let r=0;r<i;r+=2){let i=e.getUint16(t+r,!1);0!==i&&a.push(String.fromCharCode(i))}return a.join("")}(r,e,s):1===i&&(t=function(e,t,i){let a=[];for(let r=0;r<i;r++){let i=e.getUint8(t+r);a.push(String.fromCharCode(i))}return a.join("")}(r,e,s)),t&&t.trim()){let e=function(e,t,i){let a=0;0===e?a+=100:3===e?a+=90:1===e&&(a+=50);let r=i.toLowerCase();return 0===e||3===e?(r.startsWith("zh")?2052===t?a+=50:1028===t?a+=45:3076===t?a+=40:4100===t&&(a+=35):r.startsWith("ja")?1041===t&&(a+=50):r.startsWith("ko")?1042===t&&(a+=50):r.startsWith("en")&&(1033===t?a+=50:2057===t&&(a+=45)),1033===t&&(a+=10)):1===e&&(r.startsWith("zh")?33===t?a+=50:19===t&&(a+=45):r.startsWith("ja")?11===t&&(a+=50):r.startsWith("ko")?23===t&&(a+=50):r.startsWith("en")&&0===t&&(a+=50),0===t&&(a+=10)),a}(i,a,m),r={name:t.trim(),platformID:i,languageID:a,priority:e};1===o?w.push(r):2===o?y.push(r):16===o?b.push(r):17===o&&k.push(r)}}}if(0===w.length)throw Error("Font family name not found");w.sort((e,t)=>t.priority-e.priority),y.sort((e,t)=>t.priority-e.priority),b.sort((e,t)=>t.priority-e.priority),k.sort((e,t)=>t.priority-e.priority);let S=(b[0]||w[0]).name,F=k[0]||y[0],B=F?.name||"",E=400,v="normal",A=0;if(d>0)try{o=d,E=(s=r.getUint16(o+4,!1))>=1&&s<=100?100:s>=101&&s<=200?200:s>=201&&s<=300?300:s>=301&&s<=400?400:s>=401&&s<=500?500:s>=501&&s<=600?600:s>=601&&s<=700?700:s>=701&&s<=800?800:s>=801&&s<=900?900:400,n=d,A=r.getUint16(n+62,!1)}catch{console.warn("Failed to parse OS/2 table, falling back to style name analysis")}let T=!1;if(u>0){let e=function(e,t){try{let i=e.getUint16(t+4,!1),a=e.getUint16(t+6,!1),r=[],o=t+16;for(let t=0;t<i;t++){let t=String.fromCharCode(e.getUint8(o),e.getUint8(o+1),e.getUint8(o+2),e.getUint8(o+3)),i=e.getInt32(o+4,!1)/65536,s=e.getInt32(o+8,!1)/65536,n=e.getInt32(o+12,!1)/65536;r.push({tag:t,minValue:i,defaultValue:s,maxValue:n}),o+=a}return r}catch(e){return console.warn("Failed to parse fvar table:",e),[]}}(r,u);e&&e.length>0&&(T=!0)}if(400===E&&B){let e,t=(e=B.toLowerCase()).includes("thin")||e.includes("hairline")?100:e.includes("extralight")||e.includes("ultralight")?200:!e.includes("light")||e.includes("extralight")||e.includes("ultralight")?e.includes("medium")?500:e.includes("semibold")||e.includes("demibold")?600:e.includes("extrabold")||e.includes("ultrabold")?800:e.includes("black")||e.includes("heavy")?900:!e.includes("bold")||e.includes("semibold")||e.includes("extrabold")||e.includes("ultrabold")?400:700:300;400!==t&&(E=t)}return l=A,a=B.toLowerCase(),v=512&l?"oblique":1&l?"italic":a.includes("oblique")?"oblique":a.includes("italic")||a.includes("slant")?"italic":"normal",{name:F&&!i.has(F.languageID)?`${S} ${B}`:S,family:S,weight:E,style:v,variable:T}}catch(e){return console.warn(`Failed to parse font: ${e}`),{name:r,family:r,weight:400,style:"normal",variable:!1}}}])},404721,e=>{"use strict";function t(e){let t=parseFloat(e);if(!isNaN(t))return t}async function i(e,a=700,r=1050){let o=await e.text(),s=new DOMParser().parseFromString(o,"image/svg+xml").documentElement,n=s.getAttribute("width"),l=s.getAttribute("height");if(n&&l)return{width:t(n)||a,height:t(l)||r};let c=s.getAttribute("viewBox");if(c){let e=c.split(/\s+/).map(Number);if(4===e.length&&!e.some(isNaN)){let[,,t,i]=e;return{width:t||a,height:i||r}}}return{width:a,height:r}}async function a(e,t=.9){let r=await e.text(),o=URL.createObjectURL(new Blob([r],{type:"image/svg+xml"})),s=new Image;s.crossOrigin="anonymous",await new Promise((e,t)=>{s.onload=()=>e(),s.onerror=()=>t(Error("Failed to load SVG")),s.src=o}),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>requestAnimationFrame(e));let n=document.createElement("canvas"),{width:l,height:c}=await i(e);return n.width=l,n.height=c,n.getContext("2d").drawImage(s,0,0),URL.revokeObjectURL(o),new Promise(e=>{n.toBlob(t=>e(t),"image/png",t)})}e.s(["svg2png",()=>a])},869734,e=>e.a(async(t,i)=>{try{var a=e.i(696351),r=e.i(597215),o=e.i(374594),s=e.i(371081),n=e.i(399577),l=e.i(325824),c=e.i(49422),h=e.i(827667),f=e.i(978995),d=e.i(592583),u=e.i(191587),g=e.i(109166),p=e.i(772754),m=e.i(185851),w=e.i(966569),y=e.i(404721),b=t([a,o,p]);[a,o,p]=b.then?(await b)():b;class k{osPlatform=(0,u.getOSPlatform)();appPlatform="tauri";localBooksDir="";isMobile=!1;isMacOSApp=!1;isLinuxApp=!1;isAppDataSandbox=!1;isAndroidApp=!1;isIOSApp=!1;isMobileApp=!1;isPortableApp=!1;isDesktopApp=!1;isEink=!1;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir=!1;canReadExternalDir=!1;distChannel="readest";CURRENT_MIGRATION_VERSION=0x1352519;async runMigrations(e){if(e<0x13501f4)try{await this.migrate20251124()}catch(e){console.error("Error migrating to version 20251124:",e)}if(e<0x1352519)try{await this.migrate20260121()}catch(e){console.error("Error migrating to version 20260121:",e)}}async prepareBooksDir(){this.localBooksDir=await this.fs.getPrefix("Books"),await this.ensureConfigFilesExist()}async ensureConfigFilesExist(){try{if(!await this.fs.exists(h.SETTINGS_FILENAME,"Settings")){console.log("[Init] settings.json not found, creating with defaults...");let e={...h.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?h.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:h.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),globalReadSettings:{...h.DEFAULT_READSETTINGS,...this.isMobile?h.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()};await this.safeSaveJSON(h.SETTINGS_FILENAME,"Settings",e),console.log("[Init] ✓ settings.json created successfully")}let e=(0,o.getLibraryFilename)();await this.fs.exists(e,"Books")||(console.log("[Init] library.json not found, creating with defaults..."),await this.safeSaveJSON(e,"Books",[]),console.log("[Init] ✓ library.json created successfully")),console.log("[Init] ✓ All configuration files are ready")}catch(e){console.error("[Init] Error ensuring config files exist:",e)}}async openFile(e,t){return await this.fs.openFile(e,t)}async copyFile(e,t,i){return await this.fs.copyFile(e,t,i)}async readFile(e,t,i){return await this.fs.readFile(e,t,i)}async writeFile(e,t,i){return await this.fs.writeFile(e,t,i)}async createDir(e,t,i=!0){return await this.fs.createDir(e,t,i)}async deleteFile(e,t){return await this.fs.removeFile(e,t)}async deleteDir(e,t,i=!0){return await this.fs.removeDir(e,t,i)}async resolveFilePath(e,t){let i=await this.fs.getPrefix(t);return e?`${i}/${e}`:i}async readDirectory(e,t){return await this.fs.readDir(e,t)}async exists(e,t){return await this.fs.exists(e,t)}async getImageURL(e){return await this.fs.getImageURL(e)}getCoverImageUrl=e=>{let t=(0,o.getCoverFilename)(e),i=this.fs.resolvePath(t,"Books");return this.fs.getURL(i.fp)||`${this.localBooksDir}/${t}`};getCoverImageBlobUrl=async e=>{let t=(0,o.getCoverFilename)(e);if("web"===this.appPlatform)try{let e=this.fs.getURL(this.fs.resolvePath(t,"Books").fp)||`${this.localBooksDir}/${t}`;return await (0,f.cachedFetchAsUrl)(e,{cacheStrategy:"cache-first",cacheTTL:2592e6}).catch(()=>`${this.localBooksDir}/${t}`)}catch{return`${this.localBooksDir}/${t}`}try{return await this.fs.getBlobURL(t,"Books")}catch{return`${this.localBooksDir}/${t}`}};async getCachedImageUrl(e){let t=`img_${(0,n.md5)(e)}`,i=await this.fs.getPrefix("Cache"),a=`${i}/${t}`;if(await this.fs.exists(a,"None"))return await this.fs.getImageURL(a);{let i=await this.fs.openFile(e,"None");return await this.fs.writeFile(t,"Cache",await i.arrayBuffer()),await this.fs.getImageURL(a)}}getDefaultViewSettings(){return{...h.DEFAULT_BOOK_LAYOUT,...h.DEFAULT_BOOK_STYLE,...h.DEFAULT_BOOK_FONT,...h.DEFAULT_BOOK_LANGUAGE,...this.isMobile?h.DEFAULT_MOBILE_VIEW_SETTINGS:{},...this.isEink?h.DEFAULT_EINK_VIEW_SETTINGS:{},...(0,u.isCJKEnv)()?h.DEFAULT_CJK_VIEW_SETTINGS:{},...h.DEFAULT_VIEW_CONFIG,...h.DEFAULT_TTS_CONFIG,...h.DEFAULT_SCREEN_CONFIG,...h.DEFAULT_ANNOTATOR_CONFIG,...{...h.DEFAULT_TRANSLATOR_CONFIG,translateTargetLang:(0,u.getTargetLang)()}}}async loadSettings(){let e={...h.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?h.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:h.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),koreaderSyncDeviceId:(0,a.v4)(),globalReadSettings:{...h.DEFAULT_READSETTINGS,...this.isMobile?h.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()},t=await this.safeLoadJSON(h.SETTINGS_FILENAME,"Settings",e),i=t.version??0;return(this.isAppDataSandbox||i<h.SYSTEM_SETTINGS_VERSION)&&(t.version=h.SYSTEM_SETTINGS_VERSION),(t={...h.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?h.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},...t}).globalReadSettings={...h.DEFAULT_READSETTINGS,...this.isMobile?h.DEFAULT_MOBILE_READSETTINGS:{},...t.globalReadSettings},t.globalViewSettings={...this.getDefaultViewSettings(),...t.globalViewSettings},t.localBooksDir=await this.fs.getPrefix("Books"),t.kosync.deviceId||(t.kosync.deviceId=(0,a.v4)(),await this.saveSettings(t)),this.localBooksDir=t.localBooksDir,t}async saveSettings(e){await this.safeSaveJSON(h.SETTINGS_FILENAME,"Settings",e)}async importFont(e){let t,i;if("string"==typeof e)t=(await this.fs.openFile(e,"None")).name||(0,l.getFilename)(e),await this.fs.copyFile(e,t,"Fonts"),i=await this.fs.openFile(t,"Fonts");else{if(!e)return null;t=(0,l.getFilename)(e.name),await this.fs.writeFile(t,"Fonts",e),i=e}return{path:t,...(0,w.parseFontInfo)(await i.arrayBuffer(),t)}}async deleteFont(e){await this.fs.removeFile(e.path,"Fonts")}async importImage(e){let t;if("string"==typeof e)t=(await this.fs.openFile(e,"None")).name||(0,l.getFilename)(e),await this.fs.copyFile(e,t,"Images");else{if(!e)return null;t=(0,l.getFilename)(e.name),await this.fs.writeFile(t,"Images",e)}return{name:t.replace(/\.[^/.]+$/,""),path:t}}async deleteImage(e){await this.fs.removeFile(e.path,"Images")}async importBook(e,t,i=!0,a=!0,r=!1,n=!1,h){let f=Date.now(),d="";try{let g,m,w;if(n&&"string"!=typeof e)throw Error("Transient import is only supported for file paths");try{"string"==typeof e?d=(w=await this.fs.openFile(e,"None")).name||(0,l.getFilename)(e):(w=e,d=e.name);let t=w.size/1048576;if(console.log(`[importBook] Processing: ${d}, size: ${t.toFixed(2)} MB`),0===w.size)throw Error("Invalid or empty book file");if(w.size>0x6400000&&console.warn(`[importBook] ⚠️ Large file: ${t.toFixed(2)} MB, processing may take longer`),/\.txt$/i.test(d)){let e=new p.TxtToEpubConverter;({file:w}=await e.convert({file:w}))}if(console.log(`[importBook] Opening document: ${d}`),{book:g,format:m}=await new c.DocumentLoader(w).open(),!g)throw Error("Unsupported or corrupted book file");let i=(0,o.formatTitle)(g.metadata.title);i&&i.trim()&&i!==d||(g.metadata.title=(0,l.getBaseFilename)(d)),console.log(`[importBook] ✓ Document opened successfully: ${d}`)}catch(t){let e=t.message||String(t);throw console.error(`[importBook] ✗ Failed to open book: ${d}`,e),Error(`Failed to open the book: ${e}`)}console.log(`[importBook] Computing hash for: ${d}`);let b=await (0,s.partialMD5)(w),k=t.filter(e=>e.hash===b)[0],S=Date.now();k&&(n||(k.deletedAt=null),k.createdAt=S,k.updatedAt=S);let F=(0,o.getPrimaryLanguage)(g.metadata.language),B={hash:b,format:m,title:(0,o.formatTitle)(g.metadata.title),sourceTitle:(0,o.formatTitle)(g.metadata.title),primaryLanguage:F,author:(0,o.formatAuthors)(g.metadata.author,F),createdAt:k?k.createdAt:S,uploadedAt:k?k.uploadedAt:n?null:S,deletedAt:n?S:null,downloadedAt:S,updatedAt:S};k&&(k.format=B.format,k.title=k.title.trim()?k.title.trim():B.title,k.sourceTitle=k.sourceTitle??B.sourceTitle,k.author=k.author??B.author,k.primaryLanguage=k.primaryLanguage??B.primaryLanguage,k.downloadedAt=Date.now());let E="web"===this.appPlatform;console.log("[ImportBook] appPlatform:",this.appPlatform,"STORAGE_MODE (runtime):",!1,"STORAGE_MODE (env):","local","shouldUseLocalFlatStorage:",E);let v=c.EXTS[m]||m.toLowerCase?.()||"book",A=(0,u.makeSafeFilename)(B.sourceTitle||B.title),T=h?.targetGroupName?.trim();if(E){let e=h?.targetRelativePath?h.targetRelativePath:`${T?`${T}/`:""}${A}.${v}`;if(!e)throw Error("targetRelativePath is required for local storage mode. Please provide a valid relative path.");B.relativePath=e,console.log("[ImportBook] 5. Setting book.relativePath to:",e),console.log("[ImportBook] 6. Book hash:",B.hash),k&&(k.relativePath=e),T&&!B.groupName&&(B.groupName=T,k&&!k.groupName&&(k.groupName=T))}else if("web"===this.appPlatform){let e=h?.targetRelativePath?h.targetRelativePath:`${T?`${T}/`:""}${A}.${v}`;B.relativePath=e,k&&(k.relativePath=e)}await this.ensureLocalBookDirs(B);let D=(0,o.getLocalBookFilename)(B);if(i&&!n&&(!await this.fs.exists(D,"Books")||r))if(/\.txt$/i.test(d))await this.fs.writeFile(D,"Books",w);else if("string"==typeof e&&(0,u.isContentURI)(e))await this.fs.copyFile(e,D,"Books");else if("string"!=typeof e||(0,u.isValidURL)(e))await this.fs.writeFile(D,"Books",w);else try{await this.fs.copyFile(e,D,"Books")}catch{await this.fs.writeFile(D,"Books",await w.arrayBuffer())}if(a&&(!await this.fs.exists((0,o.getCoverFilename)(B),"Books")||r)){console.log("[ImportBook] 7. Preparing to save cover");let e=await g.getCover();if(e?.type==="image/svg+xml")try{console.log("[ImportBook] Converting SVG cover to PNG..."),e=await (0,y.svg2png)(e)}catch{}if(e){let t=(0,o.getCoverFilename)(B);console.log("[ImportBook] 8. Saving cover with filename:",t),console.log("[ImportBook] 9. Cover size:",e.size,"bytes"),await this.fs.writeFile(t,"Books",await e.arrayBuffer()),console.log("[ImportBook] 10. Cover saved successfully")}}k||(await this.saveBookConfig(B,o.INIT_BOOK_CONFIG),t.splice(0,0,B)),"string"==typeof e&&((0,u.isValidURL)(e)&&(B.url=e,k&&(k.url=e)),n&&(B.filePath=e,k&&(k.filePath=e))),B.coverImageUrl=await this.generateCoverImageUrl(B),e&&e.close&&await e.close();let L=Date.now()-f;return console.log(`[importBook] ✓ Import completed in ${L}ms: ${d}`),k||B}catch(r){let t=Date.now()-f,i=r.message||String(r),a=r.stack;if(console.error(`[importBook] ✗ Import failed after ${t}ms`),console.error(`[importBook] File: ${d||("string"==typeof e?e:"unknown")}`),console.error(`[importBook] Error: ${i}`),a&&console.error("[importBook] Stack trace:",a),i.includes("memory")||i.includes("ENOMEM"))throw Error(`内存不足：文件可能过大。请尝试导入较小的文件或关闭其他程序。原始错误：${i}`);throw i.includes("too large")||i.includes("Maximum size"),r}}async importBookFromPath(e,t,i){try{let a=t.split("/").slice(0,-1).join("/");return await this.importBook(e,i,!1,!0,!1,!0,{targetRelativePath:t,targetGroupName:a||""})}catch(t){return console.error("Error importing book from path:",e,t),null}}async reclassifyBook(e,t,i){if("web"!==this.appPlatform)return void console.log("[Reclassify] 非本地存储模式，跳过文件移动");if(!e.relativePath)return void console.log("[Reclassify] 书籍未使用新存储结构，跳过文件移动:",e.title);try{let a,r,o=(await this.loadSettings()).groupDirectories||{},s=e.relativePath;if(i&&s.startsWith(`${i}/`))a=s.substring(i.length+1);else{let e=s.split("/");a=e[e.length-1]||""}let n=(r=t&&o[t]?o[t]:t||"")?`${r}/${a}`:a;if(s===n)return void console.log("[Reclassify] 书籍分组未改变，无需移动文件");console.log("[Reclassify] 准备移动书籍文件"),console.log("  旧路径:",s),console.log("  新路径:",n),console.log("  文件名:",a),console.log("  新分组:",t),console.log("  目标目录:",r);let l=await fetch("/api/storage/reclassify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPath:s,newPath:n})});if(!l.ok){let e=await l.text();throw console.error("[Reclassify] 文件移动失败:",e),Error(`Failed to move book files: ${e}`)}let c=await l.json();e.relativePath=n,e.groupName=t||void 0,c.absolutePath&&(e.absolutePath=c.absolutePath),console.log("[Reclassify] 文件移动成功:",c)}catch(e){throw console.error("[Reclassify] 重新分类书籍时出错:",e),e}}async deleteBook(e,t){if(console.log("Deleting book with action:",t,e.title),"local"===t||"both"===t){for(let i of"local"===t?[(0,o.getLocalBookFilename)(e)]:[(0,o.getLocalBookFilename)(e),(0,o.getCoverFilename)(e)])console.log("Deleting local file:",i),await this.fs.removeFile(i,"Books");"local"===t?e.downloadedAt=null:(e.deletedAt=Date.now(),e.downloadedAt=null,e.coverDownloadedAt=null)}("cloud"===t||"both"===t)&&e.uploadedAt&&(console.log("Cloud delete operation skipped - cloud storage removed"),e.uploadedAt=null)}async exportBook(e){let{file:t}=await this.loadBookContent(e),i=await t.arrayBuffer(),a=`${(0,u.makeSafeFilename)(e.title)}.${e.format.toLowerCase()}`,r=await this.resolveFilePath((0,o.getLocalBookFilename)(e),"Books"),s=t.type||"application/octet-stream";return await this.saveFile(a,i,r,s)}async isBookAvailable(e){let t=(0,o.getLocalBookFilename)(e);return!!await this.fs.exists(t,"Books")||(e.filePath?await this.fs.exists(e.filePath,"None"):!!e.url&&(0,u.isValidURL)(e.url))}async getBookFileSize(e){let t=(0,o.getLocalBookFilename)(e);if(await this.fs.exists(t,"Books")){let e=await this.fs.openFile(t,"Books"),i=e.size;return e&&e.close&&await e.close(),i}return null}async loadBookContent(e){let t,i=(0,o.getLocalBookFilename)(e);if(await this.fs.exists(i,"Books"))t=await this.fs.openFile(i,"Books");else if(e.filePath)t=await this.fs.openFile(e.filePath,"None");else if(e.url)t=await this.fs.openFile(e.url,"None");else{let i=(0,o.getDir)(e),a=await this.fs.readDir((0,o.getDir)(e),"Books");if(a.length>0){let r=a.find(t=>t.path.endsWith(`.${c.EXTS[e.format]}`));if(r)t=await this.fs.openFile(`${i}/${r.path}`,"Books");else throw Error(m.BOOK_FILE_NOT_FOUND_ERROR)}else throw Error(m.BOOK_FILE_NOT_FOUND_ERROR)}return{book:e,file:t}}async loadBookConfig(e,t){let i={...t.globalViewSettings,...r.FIXED_LAYOUT_FORMATS.has(e.format)?h.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};try{let t="{}";return await this.fs.exists((0,o.getConfigFilename)(e),"Books")&&(t=await this.fs.readFile((0,o.getConfigFilename)(e),"Books","text")),(0,g.deserializeConfig)(t,i,h.DEFAULT_BOOK_SEARCH_CONFIG)}catch{return(0,g.deserializeConfig)("{}",i,h.DEFAULT_BOOK_SEARCH_CONFIG)}}async fetchBookDetails(e){let t=(0,o.getLocalBookFilename)(e);if(!await this.fs.exists(t,"Books")&&e.uploadedAt)throw console.warn("Book file not found locally and cloud download is disabled:",e.title),Error("Book file not found locally");let{file:i}=await this.loadBookContent(e),a=(await new c.DocumentLoader(i).open()).book;return i&&i.close&&await i.close(),a.metadata}async saveBookConfig(e,t,i){let a;if(i){let o={...i.globalViewSettings,...r.FIXED_LAYOUT_FORMATS.has(e.format)?h.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};a=(0,g.serializeConfig)(t,o,h.DEFAULT_BOOK_SEARCH_CONFIG)}else a=JSON.stringify(t);await this.fs.writeFile((0,o.getConfigFilename)(e),"Books",a)}async generateCoverImageUrl(e){return"web"===this.appPlatform?await this.getCoverImageBlobUrl(e):this.getCoverImageUrl(e)}async loadLibraryBooks(){console.log("Loading library books...");let e=(0,o.getLibraryFilename)();await this.fs.exists("","Books")||await this.fs.createDir("","Books",!0);let t=await this.safeLoadJSON(e,"Books",[]);return await Promise.all(t.map(async e=>(e.coverImageUrl=await this.generateCoverImageUrl(e),e.updatedAt??=e.lastUpdated||Date.now(),e))),t}async saveLibraryBooks(e){let t=e.map(({coverImageUrl:e,...t})=>t);await this.safeSaveJSON((0,o.getLibraryFilename)(),"Books",t)}async reconcileBookPaths(e){if("web"!==this.appPlatform)return console.log("[Reconcile] 非本地存储模式，跳过路径校准"),{success:!1,error:"Not in local storage mode"};try{console.log("[Reconcile] 开始校准书籍路径，共",e.length,"本书");let t=e.filter(e=>!e.deletedAt).map(e=>({hash:e.hash,relativePath:e.relativePath,absolutePath:e.absolutePath,title:e.title,groupName:e.groupName})),i=await fetch("/api/storage/reconcile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({library:t})});if(!i.ok){let e=await i.text();throw console.error("[Reconcile] 路径校准失败:",e),Error(`Failed to reconcile paths: ${e}`)}let a=await i.json();return console.log("[Reconcile] 路径校准完成:",a.summary),a}catch(e){throw console.error("[Reconcile] 路径校准出错:",e),e}}async applyReconciliation(e,t){let i=[...e];for(let e of t)if("moved"===e.status){let t=i.findIndex(t=>t.hash===e.hash);if(-1!==t){let a=i[t];a&&(a.relativePath=e.newRelativePath,a.absolutePath=e.absolutePath,void 0!==e.suggestedGroupName&&(a.groupName=e.suggestedGroupName,a.groupId=e.suggestedGroupName?(0,s.md5Fingerprint)(e.suggestedGroupName):""),a.updatedAt=Date.now(),console.log("[Reconcile] 更新书籍:",a.title,"新路径:",a.relativePath))}}return await this.saveLibraryBooks(i),i}imageToArrayBuffer(e,t){return new Promise((i,a)=>{e||t?"web"===this.appPlatform&&e&&e.startsWith("blob:")?fetch(e).then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):"tauri"===this.appPlatform&&t?this.fs.openFile(t,"None").then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):"tauri"===this.appPlatform&&e?(0,d.fetch)(e,{method:"GET"}).then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):a(Error("Unsupported platform or missing image data")):a(Error("No image URL or file provided"))})}async updateCoverImage(e,t,i){if("_blank"===t)await this.fs.removeFile((0,o.getCoverFilename)(e),"Books");else if(t||i){let a=await this.imageToArrayBuffer(t,i);await this.fs.writeFile((0,o.getCoverFilename)(e),"Books",a)}}async loadJSONFile(e,t){try{let i=await this.fs.readFile(e,t,"text");if(!i||"string"!=typeof i||0===i.trim().length)return{success:!1,error:"File is empty or invalid"};try{let e=JSON.parse(i);return{success:!0,data:e}}catch(e){return{success:!1,error:`JSON parse error: ${e}`}}}catch(e){return{success:!1,error:e}}}async safeLoadJSON(e,t,i){let a=`${e}.bak`,r=await this.loadJSONFile(e,t);if(r.success)return r.data;console.warn(`Failed to load ${e}, attempting backup...`,r.error);let o=await this.loadJSONFile(a,t);if(o.success){console.warn(`Loaded from backup: ${a}`);try{let i=JSON.stringify(o.data,null,2);await this.fs.writeFile(e,t,i),console.log(`Restored ${e} from backup`)}catch(t){console.error(`Failed to restore ${e} from backup:`,t)}return o.data}return console.error(`Both ${e} and ${a} failed to load`),i}async safeSaveJSON(e,t,i){let a=`${e}.bak`,r=JSON.stringify(i,null,2);try{await this.fs.writeFile(a,t,r),await this.fs.writeFile(e,t,r)}catch(t){throw console.error(`Failed to save ${e}:`,t),Error(`Failed to save ${e}: ${t}`)}}async ensureLocalBookDirs(e){if(e.relativePath){let t=e.relativePath.split("/").slice(0,-1).join("/"),i=e.relativePath.replace(/\.[^.]+$/,"");t&&await this.fs.createDir(t,"Books",!0),await this.fs.createDir(i,"Books",!0);return}await this.fs.exists((0,o.getDir)(e),"Books")||await this.fs.createDir((0,o.getDir)(e),"Books")}async migrate20251124(){console.log("Running migration for version 20251124 to rename the backup library file...");let e=(0,o.getLibraryBackupFilename)(),t=`${(0,o.getLibraryFilename)()}.bak`;if(await this.fs.exists(e,"Books"))try{let i=await this.fs.readFile(e,"Books","text");await this.fs.writeFile(t,"Books",i),await this.fs.removeFile(e,"Books"),console.log("Migration to rename backup library file completed successfully.")}catch(e){console.error("Error during migration to rename backup library file:",e)}}async migrate20260121(){if("web"!==this.appPlatform)return void console.log("[Migration 20260121] Skip (not web/local mode)");console.log("[Migration 20260121] Start migrating legacy hash-based books to flat layout");let e=await this.loadLibraryBooks(),t=0;for(let i of e){if(i.relativePath)continue;let e=c.EXTS[i.format]||i.format?.toLowerCase?.()||"book",a=(0,u.makeSafeFilename)(i.sourceTitle||i.title||i.hash),r=`${i.groupName?`${i.groupName}/`:""}${a}.${e}`,o=`${i.hash}/${a}.${e}`,s=`${i.hash}/cover.png`,n=`${i.hash}/config.json`,l=r.replace(/\.[^.]+$/,"")+"/cover.png",h=r.replace(/\.[^.]+$/,"")+"/config.json";try{if(await this.fs.exists(o,"Books")){await this.ensureLocalBookDirs({...i,relativePath:r});let e=await this.fs.openFile(o,"Books");await this.fs.writeFile(r,"Books",e),await this.fs.removeFile(o,"Books")}if(await this.fs.exists(s,"Books")){let e=await this.fs.openFile(s,"Books");await this.fs.writeFile(l,"Books",e),await this.fs.removeFile(s,"Books")}if(await this.fs.exists(n,"Books")){let e=await this.fs.readFile(n,"Books","text");await this.fs.writeFile(h,"Books",e),await this.fs.removeFile(n,"Books")}i.relativePath=r,t++}catch(e){console.error("[Migration 20260121] Failed to migrate book:",i.title,e)}}t>0?(await this.saveLibraryBooks(e),console.log(`[Migration 20260121] Migrated ${t} book(s) to flat layout`)):console.log("[Migration 20260121] No legacy books to migrate")}}e.s(["BaseAppService",()=>k]),i()}catch(e){i(e)}},!1)];

//# sourceMappingURL=_70f52d28._.js.map