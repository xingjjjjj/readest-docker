module.exports=[41162,800676,157849,a=>{"use strict";a.i(461937);var b,c,d=a.i(11491);function e(a){return{isFile:a.isFile,isDirectory:a.isDirectory,isSymlink:a.isSymlink,size:a.size,mtime:null!==a.mtime?new Date(a.mtime):null,atime:null!==a.atime?new Date(a.atime):null,birthtime:null!==a.birthtime?new Date(a.birthtime):null,readonly:a.readonly,fileAttributes:a.fileAttributes,dev:a.dev,ino:a.ino,mode:a.mode,nlink:a.nlink,uid:a.uid,gid:a.gid,rdev:a.rdev,blksize:a.blksize,blocks:a.blocks}}(b=c||(c={}))[b.Start=0]="Start",b[b.Current=1]="Current",b[b.End=2]="End";class f extends d.Resource{async read(a){if(0===a.byteLength)return 0;let b=await (0,d.invoke)("plugin:fs|read",{rid:this.rid,len:a.byteLength}),c=function(a){let b=new Uint8ClampedArray(a),c=b.byteLength,d=0;for(let a=0;a<c;a++)d*=256,d+=b[a];return d}(b.slice(-8)),e=b instanceof ArrayBuffer?new Uint8Array(b):b;return a.set(e.slice(0,e.length-8)),0===c?null:c}async seek(a,b){return await (0,d.invoke)("plugin:fs|seek",{rid:this.rid,offset:a,whence:b})}async stat(){return e(await (0,d.invoke)("plugin:fs|fstat",{rid:this.rid}))}async truncate(a){await (0,d.invoke)("plugin:fs|ftruncate",{rid:this.rid,len:a})}async write(a){return await (0,d.invoke)("plugin:fs|write",{rid:this.rid,data:a})}}async function g(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");return new f(await (0,d.invoke)("plugin:fs|open",{path:a instanceof URL?a.toString():a,options:b}))}async function h(a,b,c){if(a instanceof URL&&"file:"!==a.protocol||b instanceof URL&&"file:"!==b.protocol)throw TypeError("Must be a file URL.");await (0,d.invoke)("plugin:fs|copy_file",{fromPath:a instanceof URL?a.toString():a,toPath:b instanceof URL?b.toString():b,options:c})}async function i(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");await (0,d.invoke)("plugin:fs|mkdir",{path:a instanceof URL?a.toString():a,options:b})}async function j(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");return await (0,d.invoke)("plugin:fs|read_dir",{path:a instanceof URL?a.toString():a,options:b})}async function k(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");let c=await (0,d.invoke)("plugin:fs|read_file",{path:a instanceof URL?a.toString():a,options:b});return c instanceof ArrayBuffer?new Uint8Array(c):Uint8Array.from(c)}async function l(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");let c=await (0,d.invoke)("plugin:fs|read_text_file",{path:a instanceof URL?a.toString():a,options:b}),e=c instanceof ArrayBuffer?c:Uint8Array.from(c);return new TextDecoder().decode(e)}async function m(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");await (0,d.invoke)("plugin:fs|remove",{path:a instanceof URL?a.toString():a,options:b})}async function n(a,b){return e(await (0,d.invoke)("plugin:fs|stat",{path:a instanceof URL?a.toString():a,options:b}))}async function o(a,b,c){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");if(b instanceof ReadableStream){let d=await g(a,{read:!1,create:!0,write:!0,...c}),e=b.getReader();try{for(;;){let{done:a,value:b}=await e.read();if(a)break;await d.write(b)}}finally{e.releaseLock(),await d.close()}}else await (0,d.invoke)("plugin:fs|write_file",b,{headers:{path:encodeURIComponent(a instanceof URL?a.toString():a),options:JSON.stringify(c)}})}async function p(a,b,c){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");let e=new TextEncoder;await (0,d.invoke)("plugin:fs|write_text_file",e.encode(b),{headers:{path:encodeURIComponent(a instanceof URL?a.toString():a),options:JSON.stringify(c)}})}async function q(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");return await (0,d.invoke)("plugin:fs|exists",{path:a instanceof URL?a.toString():a,options:b})}d.Resource,a.s(["SeekMode",()=>c,"copyFile",()=>h,"exists",()=>q,"mkdir",()=>i,"open",()=>g,"readDir",()=>j,"readFile",()=>k,"readTextFile",()=>l,"remove",()=>m,"stat",()=>n,"writeFile",()=>o,"writeTextFile",()=>p],800676);var r=a.i(73552);class s extends Blob{#a;#b;constructor(a,b){super(),this.#a=a,this.#b=b}async arrayBuffer(){return await this.#a}async text(){let a=await this.#a;return new TextDecoder().decode(a)}stream(){return new ReadableStream({start:async a=>{let b=await this.#a,c=new ReadableStream({start(a){a.enqueue(new Uint8Array(b)),a.close()}}).getReader(),d=()=>c.read().then(({done:b,value:c})=>b?(a.close(),Promise.resolve()):(a.enqueue(c),d()));return d()}})}get type(){return this.#b}}class t extends File{#c=null;#d;#e;#f;#g=0;#h=-1;#b="";static MAX_CACHE_CHUNK_SIZE=1048576;static MAX_CACHE_ITEMS_SIZE=50;#i=[];#j=new Map;#k=new Map;constructor(a,b,c=null,d=""){super([],b||a,{type:d}),this.#d=a,this.#f=c,this.#e=b||a}async open(){this.#c=await g(this.#d,this.#f?{baseDir:this.#f}:void 0);let a=await this.#c.stat();return this.#h=a.size,this.#g=a.mtime?a.mtime.getTime():Date.now(),this}async close(){this.#c&&(await this.#c.close(),this.#c=null),this.#j.clear(),this.#i=[]}get name(){return this.#e}get type(){return this.#b}get size(){return this.#h}get lastModified(){return this.#g}async stat(){return this.#c?.stat()}async seek(a,b){if(!this.#c)throw Error("File handle is not open");return this.#c.seek(a,b)}async readData(a,b){let d=(b=Math.max(a=Math.max(0,a),Math.min(this.size,b)))-a;if(d>t.MAX_CACHE_CHUNK_SIZE){let b=await g(this.#d,this.#f?{baseDir:this.#f}:void 0);try{await b.seek(a,c.Start);let e=new Uint8Array(d);return await b.read(e),e.buffer}finally{await b.close()}}let e=Array.from(this.#j.keys()).find(c=>{let d=this.#j.get(c);return a>=c&&b<=c+d.byteLength});if(void 0!==e){this.#l(e);let b=this.#j.get(e),c=a-e;return b.slice(c,c+d)}let f=`${a}-${b}`,h=this.#k.get(f);if(h)return h;let i=this.#m(a,d);this.#k.set(f,i);try{return await i}finally{this.#k.delete(f)}}async #m(a,b){let d=await g(this.#d,this.#f?{baseDir:this.#f}:void 0);try{let e=Math.max(0,a-1024),f=Math.min(this.size,a+t.MAX_CACHE_CHUNK_SIZE)-e;await d.seek(e,c.Start);let g=new Uint8Array(f);await d.read(g),this.#j.set(e,g.buffer),this.#l(e),this.#n();let h=a-e;return g.buffer.slice(h,h+b)}finally{await d.close()}}#l(a){let b=this.#i.indexOf(a);b>-1&&this.#i.splice(b,1),this.#i.unshift(a)}#n(){for(;this.#j.size>t.MAX_CACHE_ITEMS_SIZE;){let a=this.#i.pop();void 0!==a&&this.#j.delete(a)}}slice(a=0,b=this.size,c=this.type){return new s(this.readData(a,b),c)}stream(){let a=0;return new ReadableStream({pull:async b=>{if(!this.#c)return void b.error(Error("File handle is not open"));if(a>=this.size)return void b.close();let d=new Uint8Array(Math.min(a+1048576,this.size)-a);await this.#c.seek(a,c.Start);let e=await this.#c.read(d);null===e||0===e?b.close():(b.enqueue(d.subarray(0,e)),a+=e)},cancel:async()=>{await this.#c?.close()}})}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}class u extends File{url;#e;#g;#h=-1;#b="";#i=[];#j=new Map;#o=new Map;static MAX_CACHE_CHUNK_SIZE=131072;static MAX_CACHE_ITEMS_SIZE=128;constructor(a,b,c="",d=Date.now()){const e=a.split("/").pop()||"remote-file";super([],b||e,{type:c,lastModified:d}),this.url=a,this.#e=b||e,this.#b=c,this.#g=d}get name(){return this.#e}get type(){return this.#b}get size(){return this.#h}get lastModified(){return this.#g}async _open_with_head(){let a=await fetch(this.url,{method:"HEAD"});if(!a.ok)throw Error(`Failed to fetch file size: ${a.status}`);return this.#h=Number(a.headers.get("content-length")),this.#b=a.headers.get("content-type")||"",this}async _open_with_range(){let a=await fetch(this.url,{headers:{Range:"bytes=0-1023"}});if(!a.ok)throw Error(`Failed to fetch file size: ${a.status}`);return this.#h=Number(a.headers.get("content-range")?.split("/")[1]),this.#b=a.headers.get("content-type")||"",this}async open(){return"android"===(0,r.getOSPlatform)()?this._open_with_range():this._open_with_head()}async close(){this.#j.clear(),this.#i=[]}async fetchRangePart(a,b){a=Math.max(0,a),b=Math.min(this.size-1,b);let c=await fetch(this.url,{headers:{Range:`bytes=${a}-${b}`}});if(!c.ok)throw Error(`Failed to fetch range: ${c.status}`);return c.arrayBuffer()}async fetchRange(a,b){let c=b-a+1;if(c>1024e3){let c=[];for(let d=a;d<=b;d+=1024e3){let a=Math.min(d+1024e3-1,b);c.push(await this.fetchRangePart(d,a))}let d=new Uint8Array(c.reduce((a,b)=>a+b.byteLength,0)),e=0;for(let a of c)d.set(new Uint8Array(a),e),e+=a.byteLength;return d.buffer}{if(c>u.MAX_CACHE_CHUNK_SIZE)return this.fetchRangePart(a,b);let d=Array.from(this.#j.keys()).find(c=>{let d=this.#j.get(c).byteLength;return a>=c&&b<=c+d});if(void 0!==d){this.#l(d);let b=this.#j.get(d),e=a-d;return b.slice(e,e+c)}let e=`${a}-${b}`,f=this.#o.get(e);if(f)return f;let g=this.#p(a,b,c);this.#o.set(e,g);try{return await g}finally{this.#o.delete(e)}}}async #p(a,b,c){let d=Math.max(0,a-1024),e=Math.max(b,a+u.MAX_CACHE_CHUNK_SIZE-1024-1),f=await this.fetchRangePart(d,e);this.#j.set(d,f),this.#l(d),this.#n();let g=a-d;return f.slice(g,g+c)}#l(a){let b=this.#i.indexOf(a);b>-1&&this.#i.splice(b,1),this.#i.unshift(a)}#n(){for(;this.#j.size>u.MAX_CACHE_ITEMS_SIZE;){let a=this.#i.pop();void 0!==a&&this.#j.delete(a)}}slice(a=0,b=this.size,c=this.type){return new s(this.fetchRange(a,b-1),c)}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}a.s(["NativeFile",()=>t,"RemoteFile",()=>u],41162);var v=a.i(254799);let w={randomUUID:v.randomUUID},x=new Uint8Array(256),y=x.length,z=[];for(let a=0;a<256;++a)z.push((a+256).toString(16).slice(1));let A=function(a,b,c){if(w.randomUUID&&!b&&!a)return w.randomUUID();let d=(a=a||{}).random??a.rng?.()??(y>x.length-16&&((0,v.randomFillSync)(x),y=0),x.slice(y,y+=16));if(d.length<16)throw Error("Random bytes length must be >= 16");if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,b){if((c=c||0)<0||c+16>b.length)throw RangeError(`UUID byte range ${c}:${c+15} is out of buffer bounds`);for(let a=0;a<16;++a)b[c+a]=d[a];return b}return function(a,b=0){return(z[a[b+0]]+z[a[b+1]]+z[a[b+2]]+z[a[b+3]]+"-"+z[a[b+4]]+z[a[b+5]]+"-"+z[a[b+6]]+z[a[b+7]]+"-"+z[a[b+8]]+z[a[b+9]]+"-"+z[a[b+10]]+z[a[b+11]]+z[a[b+12]]+z[a[b+13]]+z[a[b+14]]+z[a[b+15]]).toLowerCase()}(d)};var B=a.i(316282),C=a.i(593604),D=a.i(446338),E=a.i(808091),F=a.i(941287),G=a.i(810076),H=a.i(657123);let I="files",J=new class{db=null;initPromise=null;async init(){if(!this.db)return this.initPromise||(this.initPromise=new Promise((a,b)=>{let c=indexedDB.open("readest-cache",1);c.onerror=()=>{console.error("[IndexedDBCache] Failed to open database:",c.error),b(c.error)},c.onsuccess=()=>{this.db=c.result,console.log("[IndexedDBCache] ✓ Database opened successfully"),a()},c.onupgradeneeded=a=>{let b=a.target.result;b.objectStoreNames.contains(I)||(b.createObjectStore(I,{keyPath:"key"}).createIndex("expiresAt","expiresAt",{unique:!1}),console.log("[IndexedDBCache] ✓ Object store created"))}})),this.initPromise}async get(a){return(await this.init(),this.db)?new Promise((b,c)=>{let d=this.db.transaction(I,"readonly").objectStore(I).get(a);d.onerror=()=>c(d.error),d.onsuccess=()=>{let c=d.result;c&&c.expiresAt&&Date.now()>c.expiresAt?(console.log("[IndexedDBCache] Cache expired for:",a),this.delete(a).catch(a=>console.error("Failed to delete expired cache:",a)),b(null)):(c&&console.log("[IndexedDBCache] ✓ Cache hit for:",a),b(c||null))}}):null}async set(a,b,c,d){if(await this.init(),!this.db)return;let e={key:a,data:b,mimeType:c,etag:d?.etag,timestamp:Date.now(),expiresAt:d?.ttl?Date.now()+d.ttl:void 0};return new Promise((b,c)=>{let d=this.db.transaction(I,"readwrite").objectStore(I).put(e);d.onerror=()=>c(d.error),d.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache saved for:",a),b()}})}async delete(a){if(await this.init(),this.db)return new Promise((b,c)=>{let d=this.db.transaction(I,"readwrite").objectStore(I).delete(a);d.onerror=()=>c(d.error),d.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache deleted for:",a),b()}})}async clear(){if(await this.init(),this.db)return new Promise((a,b)=>{let c=this.db.transaction(I,"readwrite").objectStore(I).clear();c.onerror=()=>b(c.error),c.onsuccess=()=>{console.log("[IndexedDBCache] ✓ All caches cleared"),a()}})}async clearExpired(){return(await this.init(),this.db)?new Promise((a,b)=>{let c=this.db.transaction(I,"readwrite").objectStore(I),d=c.index("expiresAt"),e=IDBKeyRange.upperBound(Date.now()),f=d.openCursor(e),g=0;f.onerror=()=>b(f.error),f.onsuccess=b=>{let d=b.target.result;d?(console.log("[IndexedDBCache] Deleting expired cache:",d.key),c.delete(d.primaryKey),g++,d.continue()):(console.log("[IndexedDBCache] ✓ Cleared",g,"expired caches"),a(g))}}):0}async getStats(){return(await this.init(),this.db)?new Promise((a,b)=>{let c=this.db.transaction(I,"readonly").objectStore(I).getAll();c.onerror=()=>b(c.error),c.onsuccess=()=>{let b,d,e=c.result,f=0;e.forEach(a=>{f+=a.data.byteLength,(!b||a.timestamp<b.timestamp)&&(b={key:a.key,timestamp:a.timestamp}),(!d||a.timestamp>d.timestamp)&&(d={key:a.key,timestamp:a.timestamp})}),console.log("[IndexedDBCache] Stats:",{entries:e.length,size:(f/1024/1024).toFixed(2)+" MB"}),a({totalEntries:e.length,totalSize:f,oldestEntry:b,newestEntry:d})}}):{totalEntries:0,totalSize:0}}},K={cacheStrategy:"cache-first",cacheTTL:2592e6};async function L(a,b={}){let c={...K,...b},d=`file_${a}`;console.log(`[cachedFetch] Fetching: ${a}, strategy: ${c.cacheStrategy}`);try{if("cache-first"===c.cacheStrategy&&!c.bypassCache){let b=await J.get(d);if(b){console.log(`[cachedFetch] ✓ Using cached data for: ${a}`);let c=new Headers({"Content-Type":b.mimeType,"Content-Length":b.data.byteLength.toString(),...b.etag&&{ETag:b.etag}});return{data:b.data,headers:c,fromCache:!0}}}let b=new Headers(c.headers||{}),e=await fetch(a,{method:"GET",headers:b,signal:AbortSignal.timeout(3e4)});if(304===e.status){console.log(`[cachedFetch] 304 Not Modified for: ${a}`);let b=await J.get(d);if(b){let a=new Headers({"Content-Type":b.mimeType,"Content-Length":b.data.byteLength.toString(),ETag:e.headers.get("ETag")||b.etag||""});return{data:b.data,headers:a,fromCache:!0}}}if(!e.ok)throw Error(`HTTP ${e.status}: ${e.statusText}`);let f=parseInt(e.headers.get("Content-Length")||"0",10),g=e.body?.getReader(),h=[],i=0;if(g)for(;;){let{done:a,value:b}=await g.read();if(a)break;if(h.push(b),i+=b.length,f>0&&c.onProgress){let a=Math.round(i/f*100);c.onProgress(a)}}else h.push(new Uint8Array(await e.arrayBuffer()));let j=new ArrayBuffer(i),k=new Uint8Array(j),l=0;for(let a of h)k.set(a,l),l+=a.length;let m=e.headers.get("Content-Type")||"application/octet-stream",n=e.headers.get("ETag");return c.bypassCache||200!==e.status||J.set(d,j,m,{etag:n||void 0,ttl:c.cacheTTL}).catch(b=>{console.warn(`[cachedFetch] Failed to cache ${a}:`,b)}),console.log(`[cachedFetch] ✓ Fetched ${(j.byteLength/1024/1024).toFixed(2)} MB from network`),{data:j,headers:e.headers,fromCache:!1}}catch(c){console.warn(`[cachedFetch] Network error for ${a}:`,c);let b=await J.get(d);if(b){console.log(`[cachedFetch] ℹ Using stale cache due to network error: ${a}`);let c=new Headers({"Content-Type":b.mimeType,"Content-Length":b.data.byteLength.toString(),Warning:'199 - "Stale cache used due to network error"'});return{data:b.data,headers:c,fromCache:!0}}throw c}}async function M(a,b={}){let{data:c,headers:d}=await L(a,b),e=new Blob([c],{type:d.get("Content-Type")||"application/octet-stream"});return URL.createObjectURL(e)}var N=a.i(288638),O=a.i(653221),P=a.i(506892);let Q={lastAccessDate:new Date(0),lastModDate:new Date(0)},R=a=>a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"";class S{async convert(a){let{file:b,author:c,language:d}=a,e=await b.arrayBuffer(),f=this.detectEncoding(e)||"utf-8";console.log(`Detected encoding: ${f}`);let g=new TextDecoder(f).decode(e).trim(),h=this.extractBookTitle((0,F.getBaseFilename)(b.name)),i=`${h}.epub`,j=g.slice(0,1024),k=j.match(/[【\[]?作者[】\]]?[:：\s]\s*(.+)\r?\n/)||j.match(/[【\[]?\s*(.+)\s+著\s*[】\]]?\r?\n/),l=k?k[1].trim():c||"";try{l=l.replace(/^[\p{P}\p{S}]+|[\p{P}\p{S}]+$/gu,"")}catch{}let m=l||c||"",n=d||(0,P.detectLanguage)(j);console.log(`Detected language: ${n}`);let o={bookTitle:h,author:m,language:n,identifier:await (0,D.partialMD5)(b)},p=[];for(let a=8;a>=6;a--){if(0===(p=this.extractChapters(g,o,{linesBetweenSegments:a,fallbackParagraphsPerChapter:100})).length)throw Error("No chapters detected.");if(p.length>1)break}return{file:new File([await this.createEpub(p,o)],i),bookTitle:h,chapterCount:p.length,language:n}}extractChapters(a,b,c){let{language:d}=b,{linesBetweenSegments:e,fallbackParagraphsPerChapter:f}=c,g=RegExp(`(?:\\r?\\n){${e},}|-{8,}\r?
`),h=[];if("zh"===d)h.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`第[零〇一二三四五六七八九十0-9][零〇一二三四五六七八九十百千万0-9]*(?:[章卷节回讲篇封本册部话])(?:[：:、 　\(\)0-9]*[^\n-]{0,24})(?!\S)`,String.raw`(?:楔子|前言|简介|引言|序言|序章|总论|概论|后记)(?:[：: 　][^\n-]{0,24})?(?!\S)`,String.raw`chapter[\s.]*[0-9]+(?:[：:. 　]+[^\n-]{0,50})?(?!\S)`].join("|")+")","gui")),h.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`[一二三四五六七八九十][零〇一二三四五六七八九十百千万]?[：:、 　][^\n-]{0,24}(?=\n|$)`,String.raw`[0-9]+[^\n]{0,16}(?=\n|$)`].join("|")+")","gu"));else{let a=String.raw`(\d+|(?:[IVXLCDM]{2,}|V|X|L|C|D|M)\b)`,b=String.raw`\.\d{1,4}`,c=String.raw`[^\n]{0,50}`,d=["Chapter","Part","Section","Book","Volume","Act"].map(d=>String.raw`${d}\s*(?:${a}|${b})(?:[:.\-–—]?\s*${c})?`).join("|"),e=["Prologue","Epilogue","Introduction","Foreword","Preface","Afterword"].map(a=>String.raw`${a}(?:[:.\-–—]?\s*${c})?`).join("|"),f=String.raw`(?:^|\n|\s)(?:${d}|${e})(?=\s|$)`;h.push(RegExp(f,"gi"))}let i=a=>(a=R(a)).replace(/-{8,}|_{8,}/g,"\n").split(/\n+/).map(a=>a.trim()).filter(a=>a).join("</p><p>"),j=a=>a.reduce((a,b,c,d)=>(void 0===b&&c>0&&c<d.length-1&&void 0!==d[c-1]&&void 0!==d[c+1]?a[a.length-1]+=d[c+1]:void 0!==b&&(0===c||void 0!==d[c-1])&&a.push(b),a),[]),k=(a,b=1e5)=>{let c=a.filter(a=>a&&a.trim().length>0);return!(c.length<=1)&&!c.some(a=>a.length>b)},l=[];for(let b of a.split(g)){let a=b.replace(/<!--.*?-->/g,"").trim();if(!a)continue;let c=[],e=[];for(let b of h){let c=a.split(b);if(k(c)){e=j(c);break}}if(0===e.length&&f>0){let b=a.split(/\n+/),c=b.length;for(let a=0;a<c;a+=f){let c=b.slice(a,a+f),d=i(c.join("\n")),e=`${l.length+1}`,g=`<h2>${e}</h2><p>${d}</p>`;l.push({title:e,content:g,text:c.join("\n"),isVolume:!1})}continue}for(let a=1;a<e.length;a+=2){let b=e[a]?.trim()||"",f=e[a+1]?.trim()||"",g=!1,h=(g="zh"===d?/第[零〇一二三四五六七八九十百千万0-9]+(卷|本|册|部)/.test(b):/\b(Part|Volume|Book)\b/i.test(b))?`<h1>${b}</h1>`:`<h2>${b}</h2>`,j=i(f);c.push({title:R(b),content:`${h}<p>${j}</p>`,text:f,isVolume:g})}if(e[0]&&e[0].trim()){let a=e[0].trim(),b=a.split("\n")[0].trim(),d=(b.length>16?a.split(/[\n\s\p{P}]/u)[0].trim():b)||a.slice(0,16),f=i(a);c.unshift({title:R(d),content:`<h3></h3><p>${f}</p>`,text:a,isVolume:!1})}l.push(...c)}return l}async createEpub(b,c){let{BlobWriter:d,TextReader:e,ZipWriter:f}=await a.A(80252),{bookTitle:g,author:h,language:i,identifier:j}=c,k=new f(new d("application/epub+zip"),{extendedTimestamp:!1});await k.add("mimetype",new e("application/epub+zip"),Q),await k.add("META-INF/container.xml",new e(`<?xml version="1.0" encoding="UTF-8"?>
    <container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
      <rootfiles>
        <rootfile full-path="content.opf" media-type="application/oebps-package+xml"/>
      </rootfiles>
    </container>`.trim()),Q);let l=!1,m="";for(let a=0;a<b.length;a++){let c=`chapter${a+1}`,d=a+1;b[a].isVolume&&l&&(m+=`</navPoint>
`,l=!l),m+=`<navPoint id="navPoint-${c}" playOrder="${d}">
<navLabel><text>${b[a].title}</text></navLabel>
<content src="./OEBPS/${c}.xhtml" />
`,b[a].isVolume&&!l?l=!l:m+=`</navPoint>
`}l&&(m+="</navPoint>");let n=`<?xml version="1.0" encoding="UTF-8"?>
    <ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
      <head>
        <meta name="dtb:uid" content="book-id" />
        <meta name="dtb:depth" content="1" />
        <meta name="dtb:totalPageCount" content="0" />
        <meta name="dtb:maxPageNumber" content="0" />
      </head>
      <docTitle>
        <text>${R(g)}</text>
      </docTitle>
      <docAuthor>
        <text>${R(h)}</text>
      </docAuthor>
      <navMap>
        ${m}
      </navMap>
    </ncx>`.trim();await k.add("toc.ncx",new e(n),Q);let o=b.map((a,b)=>`
      <item id="chap${b+1}" href="OEBPS/chapter${b+1}.xhtml" media-type="application/xhtml+xml"/>
    `).join("\n").trim(),p=b.map((a,b)=>`
      <itemref idref="chap${b+1}"/>`).join("\n").trim(),q=`
      body { line-height: 1.6; font-size: 1em; font-family: 'Arial', sans-serif; text-align: justify; }
      p { text-indent: 2em; margin: 0; }
    `;await k.add("style.css",new e(q),Q);for(let a=0;a<b.length;a++){let c=b[a],d=(0,P.detectLanguage)(c.text),f=`<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" lang="${d}" xml:lang="${d}">
          <head>
            <title>${c.title}</title>
            <link rel="stylesheet" type="text/css" href="../style.css"/>
          </head>
          <body>${c.content}</body>
        </html>`.trim();await k.add(`OEBPS/chapter${a+1}.xhtml`,new e(f),Q)}let r=`<?xml version="1.0" encoding="UTF-8"?>
      <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="book-id" version="2.0">
        <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
          <dc:title>${R(g)}</dc:title>
          <dc:language>${i}</dc:language>
          <dc:creator>${R(h)}</dc:creator>
          <dc:identifier id="book-id">${j}</dc:identifier>
        </metadata>
        <manifest>
          ${o}
          <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
          <item id="css" href="style.css" media-type="text/css"/>
        </manifest>
        <spine toc="ncx">
          ${p}
        </spine>
      </package>`.trim();return await k.add("content.opf",new e(r),Q),await k.close()}detectEncoding(a){try{return new TextDecoder("utf-8",{fatal:!0}).decode(a),"utf-8"}catch{let b=new Uint8Array(a),c=0,d=0,e=Math.min(b.length,1e4);for(let a=0;a<e;a++)try{new TextDecoder("utf-8",{fatal:!0}).decode(b.slice(a,a+100)),c+=100,d+=100,a+=99}catch{d++}let f=c/d*100;if(console.log(`UTF-8 validity: ${f.toFixed(2)}%`),f>80)return console.log("Treating as UTF-8 despite some invalid sequences"),"utf-8"}let b=new Uint8Array(a.slice(0,4));if(255===b[0]&&254===b[1])return"utf-16le";if(254===b[0]&&255===b[1])return"utf-16be";if(239===b[0]&&187===b[1]&&191===b[2])return"utf-8";let c=new Uint8Array(a.slice(0,Math.min(1024,a.byteLength))),d=0;for(let a=0;a<c.length;a++)c[a]>=128&&d++;let e=d/c.length;if(e>.3)return"gbk";if(e>.1){let a=!1;for(let b=0;b<c.length-1;b++){let d=c[b],e=c[b+1];if((d>=129&&d<=159||d>=224&&d<=252)&&(e>=64&&e<=126||e>=128&&e<=252)){a=!0;break}}return a?"shift-jis":"gb18030"}return"utf-8"}extractBookTitle(a){let b=a.match(/《([^》]+)》/);return b?b[1]:a.split(".")[0]}}let T="Book file not found",U=new Set([1028,2052,3076,4100,19,33]);function V(a){let b=parseFloat(a);if(!isNaN(b))return b}async function W(a,b=700,c=1050){let d=await a.text(),e=new DOMParser().parseFromString(d,"image/svg+xml").documentElement,f=e.getAttribute("width"),g=e.getAttribute("height");if(f&&g)return{width:V(f)||b,height:V(g)||c};let h=e.getAttribute("viewBox");if(h){let a=h.split(/\s+/).map(Number);if(4===a.length&&!a.some(isNaN)){let[,,d,e]=a;return{width:d||b,height:e||c}}}return{width:b,height:c}}async function X(a,b=.9){let c=await a.text(),d=URL.createObjectURL(new Blob([c],{type:"image/svg+xml"})),e=new Image;e.crossOrigin="anonymous",await new Promise((a,b)=>{e.onload=()=>a(),e.onerror=()=>b(Error("Failed to load SVG")),e.src=d}),await new Promise(a=>requestAnimationFrame(a)),await new Promise(a=>requestAnimationFrame(a));let f=document.createElement("canvas"),{width:g,height:h}=await W(a);return f.width=g,f.height=h,f.getContext("2d").drawImage(e,0,0),URL.revokeObjectURL(d),new Promise(a=>{f.toBlob(b=>a(b),"image/png",b)})}class Y{osPlatform=(0,r.getOSPlatform)();appPlatform="tauri";localBooksDir="";isMobile=!1;isMacOSApp=!1;isLinuxApp=!1;isAppDataSandbox=!1;isAndroidApp=!1;isIOSApp=!1;isMobileApp=!1;isPortableApp=!1;isDesktopApp=!1;isEink=!1;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir=!1;canReadExternalDir=!1;distChannel="readest";CURRENT_MIGRATION_VERSION=0x1352519;async runMigrations(a){if(a<0x13501f4)try{await this.migrate20251124()}catch(a){console.error("Error migrating to version 20251124:",a)}if(a<0x1352519)try{await this.migrate20260121()}catch(a){console.error("Error migrating to version 20260121:",a)}}async prepareBooksDir(){this.localBooksDir=await this.fs.getPrefix("Books"),await this.ensureConfigFilesExist()}async ensureConfigFilesExist(){try{if(!await this.fs.exists(H.SETTINGS_FILENAME,"Settings")){console.log("[Init] settings.json not found, creating with defaults...");let a={...H.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?H.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:H.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),globalReadSettings:{...H.DEFAULT_READSETTINGS,...this.isMobile?H.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()};await this.safeSaveJSON(H.SETTINGS_FILENAME,"Settings",a),console.log("[Init] ✓ settings.json created successfully")}let a=(0,C.getLibraryFilename)();await this.fs.exists(a,"Books")||(console.log("[Init] library.json not found, creating with defaults..."),await this.safeSaveJSON(a,"Books",[]),console.log("[Init] ✓ library.json created successfully")),console.log("[Init] ✓ All configuration files are ready")}catch(a){console.error("[Init] Error ensuring config files exist:",a)}}async openFile(a,b){return await this.fs.openFile(a,b)}async copyFile(a,b,c){return await this.fs.copyFile(a,b,c)}async readFile(a,b,c){return await this.fs.readFile(a,b,c)}async writeFile(a,b,c){return await this.fs.writeFile(a,b,c)}async createDir(a,b,c=!0){return await this.fs.createDir(a,b,c)}async deleteFile(a,b){return await this.fs.removeFile(a,b)}async deleteDir(a,b,c=!0){return await this.fs.removeDir(a,b,c)}async resolveFilePath(a,b){let c=await this.fs.getPrefix(b);return a?`${c}/${a}`:c}async readDirectory(a,b){return await this.fs.readDir(a,b)}async exists(a,b){return await this.fs.exists(a,b)}async getImageURL(a){return await this.fs.getImageURL(a)}getCoverImageUrl=a=>{let b=(0,C.getCoverFilename)(a),c=this.fs.resolvePath(b,"Books");return this.fs.getURL(c.fp)||`${this.localBooksDir}/${b}`};getCoverImageBlobUrl=async a=>{let b=(0,C.getCoverFilename)(a);if("web"===this.appPlatform)try{let a=this.fs.getURL(this.fs.resolvePath(b,"Books").fp)||`${this.localBooksDir}/${b}`;return await M(a,{cacheStrategy:"cache-first",cacheTTL:2592e6}).catch(()=>`${this.localBooksDir}/${b}`)}catch{return`${this.localBooksDir}/${b}`}try{return await this.fs.getBlobURL(b,"Books")}catch{return`${this.localBooksDir}/${b}`}};async getCachedImageUrl(a){let b=`img_${(0,E.md5)(a)}`,c=await this.fs.getPrefix("Cache"),d=`${c}/${b}`;if(await this.fs.exists(d,"None"))return await this.fs.getImageURL(d);{let c=await this.fs.openFile(a,"None");return await this.fs.writeFile(b,"Cache",await c.arrayBuffer()),await this.fs.getImageURL(d)}}getDefaultViewSettings(){return{...H.DEFAULT_BOOK_LAYOUT,...H.DEFAULT_BOOK_STYLE,...H.DEFAULT_BOOK_FONT,...H.DEFAULT_BOOK_LANGUAGE,...this.isMobile?H.DEFAULT_MOBILE_VIEW_SETTINGS:{},...this.isEink?H.DEFAULT_EINK_VIEW_SETTINGS:{},...(0,r.isCJKEnv)()?H.DEFAULT_CJK_VIEW_SETTINGS:{},...H.DEFAULT_VIEW_CONFIG,...H.DEFAULT_TTS_CONFIG,...H.DEFAULT_SCREEN_CONFIG,...H.DEFAULT_ANNOTATOR_CONFIG,...{...H.DEFAULT_TRANSLATOR_CONFIG,translateTargetLang:(0,r.getTargetLang)()}}}async loadSettings(){let a={...H.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?H.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:H.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),koreaderSyncDeviceId:A(),globalReadSettings:{...H.DEFAULT_READSETTINGS,...this.isMobile?H.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()},b=await this.safeLoadJSON(H.SETTINGS_FILENAME,"Settings",a),c=b.version??0;return(this.isAppDataSandbox||c<H.SYSTEM_SETTINGS_VERSION)&&(b.version=H.SYSTEM_SETTINGS_VERSION),(b={...H.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?H.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},...b}).globalReadSettings={...H.DEFAULT_READSETTINGS,...this.isMobile?H.DEFAULT_MOBILE_READSETTINGS:{},...b.globalReadSettings},b.globalViewSettings={...this.getDefaultViewSettings(),...b.globalViewSettings},b.localBooksDir=await this.fs.getPrefix("Books"),b.kosync.deviceId||(b.kosync.deviceId=A(),await this.saveSettings(b)),this.localBooksDir=b.localBooksDir,b}async saveSettings(a){await this.safeSaveJSON(H.SETTINGS_FILENAME,"Settings",a)}async importFont(a){let b,c;if("string"==typeof a)b=(await this.fs.openFile(a,"None")).name||(0,F.getFilename)(a),await this.fs.copyFile(a,b,"Fonts"),c=await this.fs.openFile(b,"Fonts");else{if(!a)return null;b=(0,F.getFilename)(a.name),await this.fs.writeFile(b,"Fonts",a),c=a}return{path:b,...((a,b)=>{let c=b.replace(/\.[^/.]+$/,"");try{var d,e,f,g;let b,c=new DataView(a),h=c.getUint32(0,!1);if(65536!==h&&0x74727565!==h&&0x4f54544f!==h)throw Error("Unsupported font format");let i=c.getUint16(4,!1),j=0,k=0,l=0;for(let a=0;a<i;a++){let b=12+16*a,d=String.fromCharCode(c.getUint8(b),c.getUint8(b+1),c.getUint8(b+2),c.getUint8(b+3));"name"===d?j=c.getUint32(b+8,!1):"OS/2"===d?k=c.getUint32(b+8,!1):"fvar"===d&&(l=c.getUint32(b+8,!1))}if(0===j)throw Error("Name table not found");let m=c.getUint16(j+2,!1),n=c.getUint16(j+4,!1),o=(0,r.getUserLang)(),p=[],q=[],s=[],t=[];for(let a=0;a<m;a++){let b=j+6+12*a,d=c.getUint16(b,!1),e=c.getUint16(b+4,!1),f=c.getUint16(b+6,!1),g=c.getUint16(b+8,!1),h=c.getUint16(b+10,!1);if(1===f||2===f||16===f||17===f){let a=j+n+h,b="";if(0===d||3===d?b=function(a,b,c){let d=[];for(let e=0;e<c;e+=2){let c=a.getUint16(b+e,!1);0!==c&&d.push(String.fromCharCode(c))}return d.join("")}(c,a,g):1===d&&(b=function(a,b,c){let d=[];for(let e=0;e<c;e++){let c=a.getUint8(b+e);d.push(String.fromCharCode(c))}return d.join("")}(c,a,g)),b&&b.trim()){let a=function(a,b,c){let d=0;0===a?d+=100:3===a?d+=90:1===a&&(d+=50);let e=c.toLowerCase();return 0===a||3===a?(e.startsWith("zh")?2052===b?d+=50:1028===b?d+=45:3076===b?d+=40:4100===b&&(d+=35):e.startsWith("ja")?1041===b&&(d+=50):e.startsWith("ko")?1042===b&&(d+=50):e.startsWith("en")&&(1033===b?d+=50:2057===b&&(d+=45)),1033===b&&(d+=10)):1===a&&(e.startsWith("zh")?33===b?d+=50:19===b&&(d+=45):e.startsWith("ja")?11===b&&(d+=50):e.startsWith("ko")?23===b&&(d+=50):e.startsWith("en")&&0===b&&(d+=50),0===b&&(d+=10)),d}(d,e,o),c={name:b.trim(),platformID:d,languageID:e,priority:a};1===f?p.push(c):2===f?q.push(c):16===f?s.push(c):17===f&&t.push(c)}}}if(0===p.length)throw Error("Font family name not found");p.sort((a,b)=>b.priority-a.priority),q.sort((a,b)=>b.priority-a.priority),s.sort((a,b)=>b.priority-a.priority),t.sort((a,b)=>b.priority-a.priority);let u=(s[0]||p[0]).name,v=t[0]||q[0],w=v?.name||"",x=400,y="normal",z=0;if(k>0)try{d=k,x=(e=c.getUint16(d+4,!1))>=1&&e<=100?100:e>=101&&e<=200?200:e>=201&&e<=300?300:e>=301&&e<=400?400:e>=401&&e<=500?500:e>=501&&e<=600?600:e>=601&&e<=700?700:e>=701&&e<=800?800:e>=801&&e<=900?900:400,f=k,z=c.getUint16(f+62,!1)}catch{console.warn("Failed to parse OS/2 table, falling back to style name analysis")}let A=!1;if(l>0){let a=function(a,b){try{let c=a.getUint16(b+4,!1),d=a.getUint16(b+6,!1),e=[],f=b+16;for(let b=0;b<c;b++){let b=String.fromCharCode(a.getUint8(f),a.getUint8(f+1),a.getUint8(f+2),a.getUint8(f+3)),c=a.getInt32(f+4,!1)/65536,g=a.getInt32(f+8,!1)/65536,h=a.getInt32(f+12,!1)/65536;e.push({tag:b,minValue:c,defaultValue:g,maxValue:h}),f+=d}return e}catch(a){return console.warn("Failed to parse fvar table:",a),[]}}(c,l);a&&a.length>0&&(A=!0)}if(400===x&&w){let a,b=(a=w.toLowerCase()).includes("thin")||a.includes("hairline")?100:a.includes("extralight")||a.includes("ultralight")?200:!a.includes("light")||a.includes("extralight")||a.includes("ultralight")?a.includes("medium")?500:a.includes("semibold")||a.includes("demibold")?600:a.includes("extrabold")||a.includes("ultrabold")?800:a.includes("black")||a.includes("heavy")?900:!a.includes("bold")||a.includes("semibold")||a.includes("extrabold")||a.includes("ultrabold")?400:700:300;400!==b&&(x=b)}return g=z,b=w.toLowerCase(),y=512&g?"oblique":1&g?"italic":b.includes("oblique")?"oblique":b.includes("italic")||b.includes("slant")?"italic":"normal",{name:v&&!U.has(v.languageID)?`${u} ${w}`:u,family:u,weight:x,style:y,variable:A}}catch(a){return console.warn(`Failed to parse font: ${a}`),{name:c,family:c,weight:400,style:"normal",variable:!1}}})(await c.arrayBuffer(),b)}}async deleteFont(a){await this.fs.removeFile(a.path,"Fonts")}async importImage(a){let b;if("string"==typeof a)b=(await this.fs.openFile(a,"None")).name||(0,F.getFilename)(a),await this.fs.copyFile(a,b,"Images");else{if(!a)return null;b=(0,F.getFilename)(a.name),await this.fs.writeFile(b,"Images",a)}return{name:b.replace(/\.[^/.]+$/,""),path:b}}async deleteImage(a){await this.fs.removeFile(a.path,"Images")}async importBook(a,b,c=!0,d=!0,e=!1,f=!1,g){let h=Date.now(),i="";try{let j,k,l;if(f&&"string"!=typeof a)throw Error("Transient import is only supported for file paths");try{"string"==typeof a?i=(l=await this.fs.openFile(a,"None")).name||(0,F.getFilename)(a):(l=a,i=a.name);let b=l.size/1048576;if(console.log(`[importBook] Processing: ${i}, size: ${b.toFixed(2)} MB`),0===l.size)throw Error("Invalid or empty book file");if(l.size>0x6400000&&console.warn(`[importBook] ⚠️ Large file: ${b.toFixed(2)} MB, processing may take longer`),/\.txt$/i.test(i)){let a=new S;({file:l}=await a.convert({file:l}))}if(console.log(`[importBook] Opening document: ${i}`),{book:j,format:k}=await new G.DocumentLoader(l).open(),!j)throw Error("Unsupported or corrupted book file");let c=(0,C.formatTitle)(j.metadata.title);c&&c.trim()&&c!==i||(j.metadata.title=(0,F.getBaseFilename)(i)),console.log(`[importBook] ✓ Document opened successfully: ${i}`)}catch(b){let a=b.message||String(b);throw console.error(`[importBook] ✗ Failed to open book: ${i}`,a),Error(`Failed to open the book: ${a}`)}console.log(`[importBook] Computing hash for: ${i}`);let m=await (0,D.partialMD5)(l),n=b.filter(a=>a.hash===m)[0],o=Date.now();n&&(f||(n.deletedAt=null),n.createdAt=o,n.updatedAt=o);let p=(0,C.getPrimaryLanguage)(j.metadata.language),q={hash:m,format:k,title:(0,C.formatTitle)(j.metadata.title),sourceTitle:(0,C.formatTitle)(j.metadata.title),primaryLanguage:p,author:(0,C.formatAuthors)(j.metadata.author,p),createdAt:n?n.createdAt:o,uploadedAt:n?n.uploadedAt:f?null:o,deletedAt:f?o:null,downloadedAt:o,updatedAt:o};n&&(n.format=q.format,n.title=n.title.trim()?n.title.trim():q.title,n.sourceTitle=n.sourceTitle??q.sourceTitle,n.author=n.author??q.author,n.primaryLanguage=n.primaryLanguage??q.primaryLanguage,n.downloadedAt=Date.now());let s="web"===this.appPlatform;console.log("[ImportBook] appPlatform:",this.appPlatform,"STORAGE_MODE (runtime):",!1,"STORAGE_MODE (env):","local","shouldUseLocalFlatStorage:",s);let t=G.EXTS[k]||k.toLowerCase?.()||"book",u=(0,r.makeSafeFilename)(q.sourceTitle||q.title),v=g?.targetGroupName?.trim();if(s){let a=g?.targetRelativePath?g.targetRelativePath:`${v?`${v}/`:""}${u}.${t}`;if(!a)throw Error("targetRelativePath is required for local storage mode. Please provide a valid relative path.");q.relativePath=a,console.log("[ImportBook] 5. Setting book.relativePath to:",a),console.log("[ImportBook] 6. Book hash:",q.hash),n&&(n.relativePath=a),v&&!q.groupName&&(q.groupName=v,n&&!n.groupName&&(n.groupName=v))}else if("web"===this.appPlatform){let a=g?.targetRelativePath?g.targetRelativePath:`${v?`${v}/`:""}${u}.${t}`;q.relativePath=a,n&&(n.relativePath=a)}await this.ensureLocalBookDirs(q);let w=(0,C.getLocalBookFilename)(q);if(c&&!f&&(!await this.fs.exists(w,"Books")||e))if(/\.txt$/i.test(i))await this.fs.writeFile(w,"Books",l);else if("string"==typeof a&&(0,r.isContentURI)(a))await this.fs.copyFile(a,w,"Books");else if("string"!=typeof a||(0,r.isValidURL)(a))await this.fs.writeFile(w,"Books",l);else try{await this.fs.copyFile(a,w,"Books")}catch{await this.fs.writeFile(w,"Books",await l.arrayBuffer())}if(d&&(!await this.fs.exists((0,C.getCoverFilename)(q),"Books")||e)){console.log("[ImportBook] 7. Preparing to save cover");let a=await j.getCover();if(a?.type==="image/svg+xml")try{console.log("[ImportBook] Converting SVG cover to PNG..."),a=await X(a)}catch{}if(a){let b=(0,C.getCoverFilename)(q);console.log("[ImportBook] 8. Saving cover with filename:",b),console.log("[ImportBook] 9. Cover size:",a.size,"bytes"),await this.fs.writeFile(b,"Books",await a.arrayBuffer()),console.log("[ImportBook] 10. Cover saved successfully")}}n||(await this.saveBookConfig(q,C.INIT_BOOK_CONFIG),b.splice(0,0,q)),"string"==typeof a&&((0,r.isValidURL)(a)&&(q.url=a,n&&(n.url=a)),f&&(q.filePath=a,n&&(n.filePath=a))),q.coverImageUrl=await this.generateCoverImageUrl(q),a&&a.close&&await a.close();let x=Date.now()-h;return console.log(`[importBook] ✓ Import completed in ${x}ms: ${i}`),n||q}catch(e){let b=Date.now()-h,c=e.message||String(e),d=e.stack;if(console.error(`[importBook] ✗ Import failed after ${b}ms`),console.error(`[importBook] File: ${i||("string"==typeof a?a:"unknown")}`),console.error(`[importBook] Error: ${c}`),d&&console.error("[importBook] Stack trace:",d),c.includes("memory")||c.includes("ENOMEM"))throw Error(`内存不足：文件可能过大。请尝试导入较小的文件或关闭其他程序。原始错误：${c}`);throw c.includes("too large")||c.includes("Maximum size"),e}}async importBookFromPath(a,b,c){try{let d=b.split("/").slice(0,-1).join("/");return await this.importBook(a,c,!1,!0,!1,!0,{targetRelativePath:b,targetGroupName:d||""})}catch(b){return console.error("Error importing book from path:",a,b),null}}async reclassifyBook(a,b,c){if("web"!==this.appPlatform)return void console.log("[Reclassify] 非本地存储模式，跳过文件移动");if(!a.relativePath)return void console.log("[Reclassify] 书籍未使用新存储结构，跳过文件移动:",a.title);try{let d,e,f=(await this.loadSettings()).groupDirectories||{},g=a.relativePath;if(c&&g.startsWith(`${c}/`))d=g.substring(c.length+1);else{let a=g.split("/");d=a[a.length-1]||""}let h=(e=b&&f[b]?f[b]:b||"")?`${e}/${d}`:d;if(g===h)return void console.log("[Reclassify] 书籍分组未改变，无需移动文件");console.log("[Reclassify] 准备移动书籍文件"),console.log("  旧路径:",g),console.log("  新路径:",h),console.log("  文件名:",d),console.log("  新分组:",b),console.log("  目标目录:",e);let i=await fetch("/api/storage/reclassify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPath:g,newPath:h})});if(!i.ok){let a=await i.text();throw console.error("[Reclassify] 文件移动失败:",a),Error(`Failed to move book files: ${a}`)}let j=await i.json();a.relativePath=h,a.groupName=b||void 0,j.absolutePath&&(a.absolutePath=j.absolutePath),console.log("[Reclassify] 文件移动成功:",j)}catch(a){throw console.error("[Reclassify] 重新分类书籍时出错:",a),a}}async deleteBook(a,b){if(console.log("Deleting book with action:",b,a.title),"local"===b||"both"===b){for(let c of"local"===b?[(0,C.getLocalBookFilename)(a)]:[(0,C.getLocalBookFilename)(a),(0,C.getCoverFilename)(a)])console.log("Deleting local file:",c),await this.fs.removeFile(c,"Books");"local"===b?a.downloadedAt=null:(a.deletedAt=Date.now(),a.downloadedAt=null,a.coverDownloadedAt=null)}("cloud"===b||"both"===b)&&a.uploadedAt&&(console.log("Cloud delete operation skipped - cloud storage removed"),a.uploadedAt=null)}async exportBook(a){let{file:b}=await this.loadBookContent(a),c=await b.arrayBuffer(),d=`${(0,r.makeSafeFilename)(a.title)}.${a.format.toLowerCase()}`,e=await this.resolveFilePath((0,C.getLocalBookFilename)(a),"Books"),f=b.type||"application/octet-stream";return await this.saveFile(d,c,e,f)}async isBookAvailable(a){let b=(0,C.getLocalBookFilename)(a);return!!await this.fs.exists(b,"Books")||(a.filePath?await this.fs.exists(a.filePath,"None"):!!a.url&&(0,r.isValidURL)(a.url))}async getBookFileSize(a){let b=(0,C.getLocalBookFilename)(a);if(await this.fs.exists(b,"Books")){let a=await this.fs.openFile(b,"Books"),c=a.size;return a&&a.close&&await a.close(),c}return null}async loadBookContent(a){let b,c=(0,C.getLocalBookFilename)(a);if(await this.fs.exists(c,"Books"))b=await this.fs.openFile(c,"Books");else if(a.filePath)b=await this.fs.openFile(a.filePath,"None");else if(a.url)b=await this.fs.openFile(a.url,"None");else{let c=(0,C.getDir)(a),d=await this.fs.readDir((0,C.getDir)(a),"Books");if(d.length>0){let e=d.find(b=>b.path.endsWith(`.${G.EXTS[a.format]}`));if(e)b=await this.fs.openFile(`${c}/${e.path}`,"Books");else throw Error(T)}else throw Error(T)}return{book:a,file:b}}async loadBookConfig(a,b){let c={...b.globalViewSettings,...B.FIXED_LAYOUT_FORMATS.has(a.format)?H.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};try{let b="{}";return await this.fs.exists((0,C.getConfigFilename)(a),"Books")&&(b=await this.fs.readFile((0,C.getConfigFilename)(a),"Books","text")),(0,O.deserializeConfig)(b,c,H.DEFAULT_BOOK_SEARCH_CONFIG)}catch{return(0,O.deserializeConfig)("{}",c,H.DEFAULT_BOOK_SEARCH_CONFIG)}}async fetchBookDetails(a){let b=(0,C.getLocalBookFilename)(a);if(!await this.fs.exists(b,"Books")&&a.uploadedAt)throw console.warn("Book file not found locally and cloud download is disabled:",a.title),Error("Book file not found locally");let{file:c}=await this.loadBookContent(a),d=(await new G.DocumentLoader(c).open()).book;return c&&c.close&&await c.close(),d.metadata}async saveBookConfig(a,b,c){let d;if(c){let e={...c.globalViewSettings,...B.FIXED_LAYOUT_FORMATS.has(a.format)?H.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};d=(0,O.serializeConfig)(b,e,H.DEFAULT_BOOK_SEARCH_CONFIG)}else d=JSON.stringify(b);await this.fs.writeFile((0,C.getConfigFilename)(a),"Books",d)}async generateCoverImageUrl(a){return"web"===this.appPlatform?await this.getCoverImageBlobUrl(a):this.getCoverImageUrl(a)}async loadLibraryBooks(){console.log("Loading library books...");let a=(0,C.getLibraryFilename)();await this.fs.exists("","Books")||await this.fs.createDir("","Books",!0);let b=await this.safeLoadJSON(a,"Books",[]);return await Promise.all(b.map(async a=>(a.coverImageUrl=await this.generateCoverImageUrl(a),a.updatedAt??=a.lastUpdated||Date.now(),a))),b}async saveLibraryBooks(a){let b=a.map(({coverImageUrl:a,...b})=>b);await this.safeSaveJSON((0,C.getLibraryFilename)(),"Books",b)}async reconcileBookPaths(a){if("web"!==this.appPlatform)return console.log("[Reconcile] 非本地存储模式，跳过路径校准"),{success:!1,error:"Not in local storage mode"};try{console.log("[Reconcile] 开始校准书籍路径，共",a.length,"本书");let b=a.filter(a=>!a.deletedAt).map(a=>({hash:a.hash,relativePath:a.relativePath,absolutePath:a.absolutePath,title:a.title,groupName:a.groupName})),c=await fetch("/api/storage/reconcile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({library:b})});if(!c.ok){let a=await c.text();throw console.error("[Reconcile] 路径校准失败:",a),Error(`Failed to reconcile paths: ${a}`)}let d=await c.json();return console.log("[Reconcile] 路径校准完成:",d.summary),d}catch(a){throw console.error("[Reconcile] 路径校准出错:",a),a}}async applyReconciliation(a,b){let c=[...a];for(let a of b)if("moved"===a.status){let b=c.findIndex(b=>b.hash===a.hash);if(-1!==b){let d=c[b];d&&(d.relativePath=a.newRelativePath,d.absolutePath=a.absolutePath,void 0!==a.suggestedGroupName&&(d.groupName=a.suggestedGroupName,d.groupId=a.suggestedGroupName?(0,D.md5Fingerprint)(a.suggestedGroupName):""),d.updatedAt=Date.now(),console.log("[Reconcile] 更新书籍:",d.title,"新路径:",d.relativePath))}}return await this.saveLibraryBooks(c),c}imageToArrayBuffer(a,b){return new Promise((c,d)=>{a||b?"web"===this.appPlatform&&a&&a.startsWith("blob:")?fetch(a).then(a=>a.arrayBuffer()).then(a=>c(a)).catch(a=>d(a)):"tauri"===this.appPlatform&&b?this.fs.openFile(b,"None").then(a=>a.arrayBuffer()).then(a=>c(a)).catch(a=>d(a)):"tauri"===this.appPlatform&&a?(0,N.fetch)(a,{method:"GET"}).then(a=>a.arrayBuffer()).then(a=>c(a)).catch(a=>d(a)):d(Error("Unsupported platform or missing image data")):d(Error("No image URL or file provided"))})}async updateCoverImage(a,b,c){if("_blank"===b)await this.fs.removeFile((0,C.getCoverFilename)(a),"Books");else if(b||c){let d=await this.imageToArrayBuffer(b,c);await this.fs.writeFile((0,C.getCoverFilename)(a),"Books",d)}}async loadJSONFile(a,b){try{let c=await this.fs.readFile(a,b,"text");if(!c||"string"!=typeof c||0===c.trim().length)return{success:!1,error:"File is empty or invalid"};try{let a=JSON.parse(c);return{success:!0,data:a}}catch(a){return{success:!1,error:`JSON parse error: ${a}`}}}catch(a){return{success:!1,error:a}}}async safeLoadJSON(a,b,c){let d=`${a}.bak`,e=await this.loadJSONFile(a,b);if(e.success)return e.data;console.warn(`Failed to load ${a}, attempting backup...`,e.error);let f=await this.loadJSONFile(d,b);if(f.success){console.warn(`Loaded from backup: ${d}`);try{let c=JSON.stringify(f.data,null,2);await this.fs.writeFile(a,b,c),console.log(`Restored ${a} from backup`)}catch(b){console.error(`Failed to restore ${a} from backup:`,b)}return f.data}return console.error(`Both ${a} and ${d} failed to load`),c}async safeSaveJSON(a,b,c){let d=`${a}.bak`,e=JSON.stringify(c,null,2);try{await this.fs.writeFile(d,b,e),await this.fs.writeFile(a,b,e)}catch(b){throw console.error(`Failed to save ${a}:`,b),Error(`Failed to save ${a}: ${b}`)}}async ensureLocalBookDirs(a){if(a.relativePath){let b=a.relativePath.split("/").slice(0,-1).join("/"),c=a.relativePath.replace(/\.[^.]+$/,"");b&&await this.fs.createDir(b,"Books",!0),await this.fs.createDir(c,"Books",!0);return}await this.fs.exists((0,C.getDir)(a),"Books")||await this.fs.createDir((0,C.getDir)(a),"Books")}async migrate20251124(){console.log("Running migration for version 20251124 to rename the backup library file...");let a=(0,C.getLibraryBackupFilename)(),b=`${(0,C.getLibraryFilename)()}.bak`;if(await this.fs.exists(a,"Books"))try{let c=await this.fs.readFile(a,"Books","text");await this.fs.writeFile(b,"Books",c),await this.fs.removeFile(a,"Books"),console.log("Migration to rename backup library file completed successfully.")}catch(a){console.error("Error during migration to rename backup library file:",a)}}async migrate20260121(){if("web"!==this.appPlatform)return void console.log("[Migration 20260121] Skip (not web/local mode)");console.log("[Migration 20260121] Start migrating legacy hash-based books to flat layout");let a=await this.loadLibraryBooks(),b=0;for(let c of a){if(c.relativePath)continue;let a=G.EXTS[c.format]||c.format?.toLowerCase?.()||"book",d=(0,r.makeSafeFilename)(c.sourceTitle||c.title||c.hash),e=`${c.groupName?`${c.groupName}/`:""}${d}.${a}`,f=`${c.hash}/${d}.${a}`,g=`${c.hash}/cover.png`,h=`${c.hash}/config.json`,i=e.replace(/\.[^.]+$/,"")+"/cover.png",j=e.replace(/\.[^.]+$/,"")+"/config.json";try{if(await this.fs.exists(f,"Books")){await this.ensureLocalBookDirs({...c,relativePath:e});let a=await this.fs.openFile(f,"Books");await this.fs.writeFile(e,"Books",a),await this.fs.removeFile(f,"Books")}if(await this.fs.exists(g,"Books")){let a=await this.fs.openFile(g,"Books");await this.fs.writeFile(i,"Books",a),await this.fs.removeFile(g,"Books")}if(await this.fs.exists(h,"Books")){let a=await this.fs.readFile(h,"Books","text");await this.fs.writeFile(j,"Books",a),await this.fs.removeFile(h,"Books")}c.relativePath=e,b++}catch(a){console.error("[Migration 20260121] Failed to migrate book:",c.title,a)}}b>0?(await this.saveLibraryBooks(a),console.log(`[Migration 20260121] Migrated ${b} book(s) to flat layout`)):console.log("[Migration 20260121] No legacy books to migrate")}}a.s(["BaseAppService",()=>Y],157849)}];

//# sourceMappingURL=apps_readest-app_src_utils_file_ts_64883864._.js.map