module.exports=[621823,a=>{"use strict";let b,c=(a,b)=>[-1,...b,a.length].reduce(({xs:b,a:c},d)=>({xs:b?.concat([a.slice(c+1,d)])??[],a:d}),{}).xs,d=/\d/,e=/^epubcfi\((.*)\)$/,f=a=>a.replace(/[\^[\](),;=]/g,"^$&"),g=a=>e.test(a)?a:`epubcfi(${a})`,h=(b=(...a)=>a.join("!"),(...a)=>`epubcfi(${b(...a.map(a=>a.match(e)?.[1]??a))})`),i=(a,b)=>{let c;return c=([a])=>a===b,a.map((a,b,d)=>c(a,b,d)?b:null).filter(a=>null!=a)},j=a=>{let b,c=[];for(let[d,e]of a){if("/"===d)c.push({index:e});else{let a=c[c.length-1];if(":"===d)a.offset=e;else if("~"===d)a.temporal=e;else if("@"===d)a.spatial=(a.spatial??[]).concat(e);else if(";s"===d)a.side=e;else if("["===d)if("/"===b&&e)a.id=e;else{a.text=(a.text??[]).concat(e);continue}}b=d}return c},k=a=>c(a,i(a,"!")).map(j),l=a=>{let b=(a=>{let b=[],c,e,f="",g=a=>(b.push(a),c=null,f=""),h=a=>(f+=a,e=!1);for(let b of Array.from(a.trim()).concat("")){if("^"===b&&!e){e=!0;continue}if("!"===c)g(["!"]);else if(","===c)g([","]);else if("/"===c||":"===c)if(d.test(b)){h(b);continue}else g([c,parseInt(f)]);else if("~"===c)if(d.test(b)||"."===b){h(b);continue}else g(["~",parseFloat(f)]);else if("@"===c){if(":"===b){g(["@",parseFloat(f)]),c="@";continue}if(d.test(b)||"."===b){h(b);continue}g(["@",parseFloat(f)])}else if("["===c){";"!==b||e?","!==b||e?"]"!==b||e?h(b):g(["[",f]):(g(["[",f]),c="["):(g(["[",f]),c=";");continue}else if(c?.startsWith(";")){"="!==b||e?";"!==b||e?"]"!==b||e?h(b):g([c,f]):(g([c,f]),c=";"):(c=`;${f}`,f="");continue}("/"===b||":"===b||"~"===b||"@"===b||"["===b||"!"===b||","===b)&&(c=b)}return b})(a.match(e)?.[1]??a),f=i(b,",");if(!f.length)return k(b);let[g,h,j]=c(b,f).map(k);return{parent:g,start:h,end:j}},m=({index:a,id:b,offset:c,temporal:d,spatial:e,text:g,side:h})=>{let i=h?`;s=${h}`:"";return`/${a}`+(b?`[${f(b)}${i}]`:"")+(null!=c&&a%2?`:${c}`:"")+(d?`~${d}`:"")+(e?`@${e.join(":")}`:"")+(g||!b&&h?"["+(g?.map(f)?.join(",")??"")+i+"]":"")},n=a=>a.parent?[a.parent,a.start,a.end].map(n).join(","):a.map(a=>a.map(m).join("")).join("!"),o=a=>g(n(a)),p=(a,b)=>{let c,d;return"string"==typeof a?o(p(l(a),b)):a.parent?(c=a.parent,d=a[b?"end":"start"],c.slice(0,-1).concat([c[c.length-1].concat(d[0])]).concat(d.slice(1))):a},q=(a,b)=>{"string"==typeof a&&(a=l(a)),"string"==typeof b&&(b=l(b)),a=p(a),b=p(b,!0);let c=a[a.length-1],d=b[b.length-1],e=[],f=[],g=[],h=!0,i=Math.max(c.length,d.length);for(let a=0;a<i;a++){let b=c[a],i=d[a];(h&&=b?.index===i?.index&&!b?.offset&&!i?.offset)?e.push(b):(b&&f.push(b),i&&g.push(i))}return o({parent:a.slice(0,-1).concat([e]),start:[f],end:[g]})},r=(a,b)=>{if("string"==typeof a&&(a=l(a)),"string"==typeof b&&(b=l(b)),a.start||b.start)return r(p(a),p(b))||r(p(a,!0),p(b,!0));for(let c=0;c<Math.max(a.length,b.length);c++){let d=a[c]??[],e=b[c]??[],f=Math.max(d.length,e.length)-1;for(let a=0;a<=f;a++){let b=d[a],c=e[a];if(!b)return -1;if(!c||b.index>c.index)return 1;if(b.index<c.index)return -1;if(a===f){if(b.offset>c.offset)return 1;if(b.offset<c.offset)return -1}}}return 0},s=({nodeType:a})=>3===a||4===a,t=(a,b)=>{let c=Array.from(a.childNodes).filter(a=>s(a)||(({nodeType:a})=>1===a)(a));return b?c.map(a=>{let c=b(a);return c===NodeFilter.FILTER_REJECT?null:c===NodeFilter.FILTER_SKIP?t(a,b):a}).flat().filter(a=>a):c},u=(a,b)=>{let c=t(a,b).reduce((a,b)=>{let c=a[a.length-1];return c?s(b)?Array.isArray(c)?c.push(b):s(c)?a[a.length-1]=[c,b]:a.push(b):(({nodeType:a})=>1===a)(c)?a.push(null,b):a.push(b):a.push(b),a},[]);return(({nodeType:a})=>1===a)(c[0])&&c.unshift("first"),(({nodeType:a})=>1===a)(c[c.length-1])&&c.push("last"),c.unshift("before"),c.push("after"),c},v=(a,b,c)=>{let{id:d}=b[b.length-1];if(d){let b=a.ownerDocument.getElementById(d);if(b)return{node:b,offset:0}}for(let{index:d}of b){let b=a?u(a,c)[d]:null;if("first"===b)return{node:a.firstChild??a};if("last"===b)return{node:a.lastChild??a};if("before"===b)return{node:a,before:!0};if("after"===b)return{node:a,after:!0};a=b}let{offset:e}=b[b.length-1];if(!Array.isArray(a))return{node:a,offset:e};let f=0;for(let b of a){let{length:a}=b.nodeValue;if(f+a>=e)return{node:b,offset:e-f};f+=a}},w=(a,b,c)=>{let{parentNode:d,id:e}=a,f=u(d,c),g=f.findIndex(b=>Array.isArray(b)?b.some(b=>b===a):b===a),h=f[g];if(Array.isArray(h)){let c=0;for(let d of h)if(d===a){c+=b;break}else c+=d.nodeValue.length;b=c}let i={id:e,index:g,offset:b};return(d!==a.ownerDocument.documentElement?w(d,null,c).concat(i):[i]).filter(a=>-1!==a.index)},x={fromIndex:a=>g(`/6/${(a+1)*2}`),toIndex:a=>a?.at(-1).index/2-1};a.s(["collapse",0,p,"compare",0,r,"fake",0,x,"fromCalibreHighlight",0,({spine_index:a,start_cfi:b,end_cfi:c})=>{let d=x.fromIndex(a)+"!";return q(d+b.slice(2),d+c.slice(2))},"fromCalibrePos",0,a=>{let[b]=l(a),c=b.shift();return b.shift(),o([[{index:6},c],b])},"fromElements",0,a=>{let b=[],{parentNode:c}=a[0],d=w(c);for(let[e,f]of u(c).entries()){let c=a[b.length];f===c&&b.push(o([d.concat({id:c.id,index:e})]))}return b},"fromRange",0,(a,b)=>{let{startContainer:c,startOffset:d,endContainer:e,endOffset:f}=a,g=w(c,d,b);return a.collapsed?o([g]):q([g],[w(e,f,b)])},"isCFI",0,e,"joinIndir",0,h,"parse",0,l,"toElement",0,(a,b)=>v(a.documentElement,p(b)).node,"toRange",0,(a,b,c)=>{let d=p(b),e=p(b,!0),f=a.documentElement,g=v(f,d[0],c),h=v(f,e[0],c),i=a.createRange();return g.before?i.setStartBefore(g.node):g.after?i.setStartAfter(g.node):i.setStart(g.node,g.offset),h.before?i.setEndBefore(h.node):h.after?i.setEndAfter(h.node):i.setEnd(h.node,h.offset),i}])},593604,810076,a=>{"use strict";var b=a.i(621823);let c={EPUB:"epub",PDF:"pdf",MOBI:"mobi",AZW:"azw",AZW3:"azw3",CBZ:"cbz",FB2:"fb2",FBZ:"fbz",TXT:"txt",MD:"md"},d={EPUB:["application/epub+zip"],PDF:["application/pdf"],MOBI:["application/x-mobipocket-ebook"],AZW:["application/vnd.amazon.ebook"],AZW3:["application/vnd.amazon.mobi8-ebook","application/x-mobi8-ebook"],CBZ:["application/vnd.comicbook+zip","application/zip","application/x-cbz"],FB2:["application/x-fictionbook+xml","text/xml","application/xml"],FBZ:["application/x-zip-compressed-fb2","application/zip"],TXT:["text/plain"],MD:["text/markdown","text/x-markdown"]};class e{file;constructor(a){this.file=a}async isZip(){let a=new Uint8Array(await this.file.slice(0,4).arrayBuffer());return 80===a[0]&&75===a[1]&&3===a[2]&&4===a[3]}async isPDF(){let a=new Uint8Array(await this.file.slice(0,5).arrayBuffer());return 37===a[0]&&80===a[1]&&68===a[2]&&70===a[3]&&45===a[4]}async makeZipLoader(){let b=async()=>{let a=Math.min(65536,this.file.size),b=new Uint8Array(await this.file.slice(this.file.size-a,this.file.size).arrayBuffer());for(let a=b.length-22;a>=0;a--)if(80===b[a]&&75===b[a+1]&&5===b[a+2]&&6===b[a+3]){let c=b[a+20]+(b[a+21]<<8),d=a+22,e=b.slice(d,d+c);return new TextDecoder().decode(e)}return null},{configure:c,ZipReader:d,BlobReader:e,TextWriter:f,BlobWriter:g}=await a.A(80252);c({useWebWorkers:!1});let h=new d(new e(this.file)),i=await h.getEntries(),j=new Map(i.map(a=>[a.filename,a])),k=a=>(b,...c)=>j.has(b)?a(j.get(b),...c):null,l=k(a=>a.getData?a.getData(new f):null);return{entries:i,loadText:l,loadBlob:k((a,b)=>a.getData?a.getData(new g(b)):null),getSize:a=>j.get(a)?.uncompressedSize??0,getComment:b,sha1:void 0}}isCBZ(){return"application/vnd.comicbook+zip"===this.file.type||this.file.name.endsWith(`.${c.CBZ}`)}isFB2(){return"application/x-fictionbook+xml"===this.file.type||this.file.name.endsWith(`.${c.FB2}`)}isFBZ(){return"application/x-zip-compressed-fb2"===this.file.type||this.file.name.endsWith(".fb.zip")||this.file.name.endsWith(".fb2.zip")||this.file.name.endsWith(`.${c.FBZ}`)}async open(){let b=null,d="EPUB";if(!this.file.size)throw Error("File is empty");try{if(await this.isZip()){let e=await this.makeZipLoader(),{entries:f}=e;if(this.isCBZ()){let{makeComicBook:c}=await a.A(857698);b=await c(e,this.file),d="CBZ"}else if(this.isFBZ()){let g=f.find(a=>a.filename.endsWith(`.${c.FB2}`)),h=await e.loadBlob((g??f[0]).filename),{makeFB2:i}=await a.A(120301);b=await i(h),d="FBZ"}else{let{EPUB:c}=await a.A(306701);b=await new c(e).init(),d="EPUB"}}else if(await this.isPDF()){let{makePDF:c}=await a.A(602697);b=await c(this.file),d="PDF"}else if(await (await a.A(935402)).isMOBI(this.file)){let c=await a.A(38142),{MOBI:e}=await a.A(935402);switch(b=await new e({unzlib:c.unzlibSync}).open(this.file),this.file.name.split(".").pop()?.toLowerCase()){case"azw":d="AZW";break;case"azw3":d="AZW3";break;default:d="MOBI"}}else if(this.isFB2()){let{makeFB2:c}=await a.A(120301);b=await c(this.file),d="FB2"}}catch(a){if(console.error("Failed to open document:",a),a instanceof Error&&a.message?.includes("not a valid zip"))throw Error("Unsupported or corrupted book file");throw a}return{book:b,format:d}}}a.s(["CFI",0,b,"DocumentLoader",()=>e,"EXTS",0,c,"getDirection",0,a=>{let{defaultView:b}=a,{writingMode:c,direction:d}=b.getComputedStyle(a.body);return{vertical:"vertical-rl"===c||"vertical-lr"===c,rtl:"rtl"===a.body.dir||"rtl"===d||"rtl"===a.documentElement.dir}},"getFileExtFromMimeType",0,a=>{if(!a)return"";for(let b in d)if(d[b].includes(a))return c[b];return""}],810076);var f=a.i(657123),g=a.i(73552),h=a.i(243648),i=a.i(506892);a.i(446338);var j=a.i(808091);let k=(a,b=!1)=>{let c=(0,g.getUserLang)();if(!a)return"";if("string"==typeof a)return a;let d=Object.keys(a);return b?a[d[0]]:a[c]||a[d[0]]},l=(a=!1,b="")=>(b=b||(0,g.getUserLang)(),a)?new Intl.ListFormat("en",{style:"narrow",type:"unit"}):new Intl.ListFormat(b,{style:"long",type:"conjunction"}),m=a=>{try{let b="string"==typeof a?a:a?.[0];return b?b.split("-")[0]:""}catch{return""}},n=["ar","bo","de","en","es","fr","hi","it","nl","pl","pt","ru","th","tr","uk"],o=(a,b)=>{if(!a)return"";let c=a.split(" ");return b&&c.length>1?`${c[c.length-1]}, ${c.slice(0,-1).join(" ")}`:a},p=a=>f.SUPPORTED_LANGS[a]||a.toUpperCase(),q=a=>{let b=Array.isArray(a)?a[0]:a;if((0,i.isValidLang)(b)){let a=(0,i.normalizedLangCode)(b);return(0,i.code6392to6391)(a)||a}return"en"},r=a=>{try{if(a.includes("urn:"))return a.match(/[^:]+$/)?.[0]||"";if(a.includes(":"))return a.match(/^[^:]+:(.+)$/)?.[1]||""}catch{}return a};a.s(["INIT_BOOK_CONFIG",0,{updatedAt:0},"flattenContributors",0,a=>a?Array.isArray(a)?a.map(a=>"string"==typeof a?a:k(a?.name)).join(", "):"string"==typeof a?a:k(a?.name):"","formatAuthors",0,(a,b,c)=>{let d=m(b)||"en",e=!!c&&n.includes(d);return Array.isArray(a)?l("zh"===d,d).format(a.map(a=>"string"==typeof a?o(a,e):o(k(a?.name),e))):"string"==typeof a?o(a,e):o(k(a?.name),e)},"formatBytes",0,(a,b="en-US")=>{if(!a)return"";let c=Math.floor(Math.log(a)/Math.log(1024)),d=a/Math.pow(1024,c);return new Intl.NumberFormat(b,{style:"unit",unit:["byte","kilobyte","megabyte","gigabyte","terabyte"][c],unitDisplay:"short",maximumFractionDigits:2}).format(d)},"formatDate",0,(a,b=!1)=>{if(!a)return;let c=(0,g.getUserLang)();try{return new Date(a).toLocaleDateString(c,{year:"numeric",month:"long",day:"numeric",timeZone:b?"UTC":void 0})}catch{return}},"formatDescription",0,a=>a?("string"==typeof a?a:k(a)).replace(/<\/?[^>]+(>|$)/g,"").replace(/&#\d+;/g,"").trim():"","formatLanguage",0,a=>Array.isArray(a)?a.map(p).join(", "):p(a||""),"formatPublisher",0,a=>"string"==typeof a?a:k(a),"formatTitle",0,a=>"string"==typeof a?a:k(a),"getBookDirFromLanguage",0,a=>{let b=q(a)||"";return(0,h.getDirFromLanguage)(b)},"getBookDirFromWritingMode",0,a=>{switch(a){case"horizontal-tb":return"ltr";case"horizontal-rl":case"vertical-rl":return"rtl";default:return"auto"}},"getBookLangCode",0,m,"getConfigFilename",0,a=>{if(!a.relativePath)throw Error(`Book ${a.title} (${a.hash}) is missing relativePath. Please re-import the book.`);let b=a.relativePath.replace(/\.[^.]+$/,"");return`${b}/config.json`},"getCoverFilename",0,a=>{if(!a.relativePath)throw Error(`Book ${a.title} (${a.hash}) is missing relativePath. Please re-import the book.`);let b=a.relativePath.replace(/\.[^.]+$/,""),c=`${b}/cover.png`;return console.log("[getCoverFilename] ✓ Using relativePath:",a.relativePath),console.log("[getCoverFilename] ✓ Cover path result:",c),c},"getCurrentPage",0,(a,b)=>{let c=a.format,{section:d,pageinfo:e}=b;return"PDF"===c?d?d.current+1:0:e?e.current+1:0},"getDir",0,a=>{if(!a.relativePath)throw Error(`Book ${a.title} (${a.hash}) is missing relativePath. Please re-import the book.`);return a.relativePath.replace(/\.[^.]+$/,"")},"getLibraryBackupFilename",0,()=>"library_backup.json","getLibraryFilename",0,()=>"library.json","getLocalBookFilename",0,a=>{if(!a.relativePath)throw Error(`Book ${a.title} (${a.hash}) is missing relativePath. Please re-import the book.`);return a.relativePath},"getMetadataHash",0,a=>{try{var b;let c,d=(c=a.title,"string"==typeof c?c:k(c,!0)),e=(!(b=a.author)?[]:Array.isArray(b)?b.map(a=>"string"==typeof a?a:k(a?.name,!0)).filter(Boolean):["string"==typeof b?b:k(b?.name,!0)]).join(","),f=(a=>{if(!a)return[];if(Array.isArray(a)){let b=(a=>{for(let b of["uuid","calibre","isbn"]){let c=a.find(a=>"string"==typeof a?a.toLowerCase().includes(b):a.scheme.toLowerCase()===b);if(c)return"string"==typeof c?r(c):c.value}})(a);if(b)return[b]}return Array.isArray(a)?a.map(a=>"string"==typeof a?r(a):a.value).filter(Boolean):"string"==typeof a?[r(a)]:[a.value]})(a.altIdentifier||a.identifier).join(","),g=`${d}|${e}|${f}`;return(0,j.md5)(g.normalize("NFC"))}catch(a){console.error("Error generating metadata hash:",a)}},"getPrimaryLanguage",0,q,"listFormater",0,l],593604)}];

//# sourceMappingURL=_a200d5df._.js.map