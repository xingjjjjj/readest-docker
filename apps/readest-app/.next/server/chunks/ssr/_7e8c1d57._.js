module.exports=[253574,(a,b,c)=>{},652259,(a,b,c)=>{a.r(253574);var d=a.r(649970),e=d&&"object"==typeof d&&"default"in d?d:{default:d},f="undefined"!=typeof process&&process.env&&!0,g=function(a){return"[object String]"===Object.prototype.toString.call(a)},h=function(){function a(a){var b=void 0===a?{}:a,c=b.name,d=void 0===c?"stylesheet":c,e=b.optimizeForSpeed,h=void 0===e?f:e;i(g(d),"`name` must be a string"),this._name=d,this._deletedRulePlaceholder="#"+d+"-deleted-rule____{}",i("boolean"==typeof h,"`optimizeForSpeed` must be a boolean"),this._optimizeForSpeed=h,this._serverSheet=void 0,this._tags=[],this._injected=!1,this._rulesCount=0,this._nonce=null}var b,c=a.prototype;return c.setOptimizeForSpeed=function(a){i("boolean"==typeof a,"`setOptimizeForSpeed` accepts a boolean"),i(0===this._rulesCount,"optimizeForSpeed cannot be when rules have already been inserted"),this.flush(),this._optimizeForSpeed=a,this.inject()},c.isOptimizeForSpeed=function(){return this._optimizeForSpeed},c.inject=function(){var a=this;i(!this._injected,"sheet already injected"),this._injected=!0,this._serverSheet={cssRules:[],insertRule:function(b,c){return"number"==typeof c?a._serverSheet.cssRules[c]={cssText:b}:a._serverSheet.cssRules.push({cssText:b}),c},deleteRule:function(b){a._serverSheet.cssRules[b]=null}}},c.getSheetForTag=function(a){if(a.sheet)return a.sheet;for(var b=0;b<document.styleSheets.length;b++)if(document.styleSheets[b].ownerNode===a)return document.styleSheets[b]},c.getSheet=function(){return this.getSheetForTag(this._tags[this._tags.length-1])},c.insertRule=function(a,b){return i(g(a),"`insertRule` accepts only strings"),"number"!=typeof b&&(b=this._serverSheet.cssRules.length),this._serverSheet.insertRule(a,b),this._rulesCount++},c.replaceRule=function(a,b){this._optimizeForSpeed;var c=this._serverSheet;if(b.trim()||(b=this._deletedRulePlaceholder),!c.cssRules[a])return a;c.deleteRule(a);try{c.insertRule(b,a)}catch(d){f||console.warn("StyleSheet: illegal rule: \n\n"+b+"\n\nSee https://stackoverflow.com/q/20007992 for more info"),c.insertRule(this._deletedRulePlaceholder,a)}return a},c.deleteRule=function(a){this._serverSheet.deleteRule(a)},c.flush=function(){this._injected=!1,this._rulesCount=0,this._serverSheet.cssRules=[]},c.cssRules=function(){return this._serverSheet.cssRules},c.makeStyleTag=function(a,b,c){b&&i(g(b),"makeStyleTag accepts only strings as second parameter");var d=document.createElement("style");this._nonce&&d.setAttribute("nonce",this._nonce),d.type="text/css",d.setAttribute("data-"+a,""),b&&d.appendChild(document.createTextNode(b));var e=document.head||document.getElementsByTagName("head")[0];return c?e.insertBefore(d,c):e.appendChild(d),d},b=[{key:"length",get:function(){return this._rulesCount}}],function(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}(a.prototype,b),a}();function i(a,b){if(!a)throw Error("StyleSheet: "+b+".")}var j=function(a){for(var b=5381,c=a.length;c;)b=33*b^a.charCodeAt(--c);return b>>>0},k={};function l(a,b){if(!b)return"jsx-"+a;var c=String(b),d=a+c;return k[d]||(k[d]="jsx-"+j(a+"-"+c)),k[d]}function m(a,b){var c=a+(b=b.replace(/\/style/gi,"\\/style"));return k[c]||(k[c]=b.replace(/__jsx-style-dynamic-selector/g,a)),k[c]}var n=function(){function a(a){var b=void 0===a?{}:a,c=b.styleSheet,d=void 0===c?null:c,e=b.optimizeForSpeed,f=void 0!==e&&e;this._sheet=d||new h({name:"styled-jsx",optimizeForSpeed:f}),this._sheet.inject(),d&&"boolean"==typeof f&&(this._sheet.setOptimizeForSpeed(f),this._optimizeForSpeed=this._sheet.isOptimizeForSpeed()),this._fromServer=void 0,this._indices={},this._instancesCounts={}}var b=a.prototype;return b.add=function(a){var b=this;void 0===this._optimizeForSpeed&&(this._optimizeForSpeed=Array.isArray(a.children),this._sheet.setOptimizeForSpeed(this._optimizeForSpeed),this._optimizeForSpeed=this._sheet.isOptimizeForSpeed());var c=this.getIdAndRules(a),d=c.styleId,e=c.rules;if(d in this._instancesCounts){this._instancesCounts[d]+=1;return}var f=e.map(function(a){return b._sheet.insertRule(a)}).filter(function(a){return -1!==a});this._indices[d]=f,this._instancesCounts[d]=1},b.remove=function(a){var b=this,c=this.getIdAndRules(a).styleId;if(function(a,b){if(!a)throw Error("StyleSheetRegistry: "+b+".")}(c in this._instancesCounts,"styleId: `"+c+"` not found"),this._instancesCounts[c]-=1,this._instancesCounts[c]<1){var d=this._fromServer&&this._fromServer[c];d?(d.parentNode.removeChild(d),delete this._fromServer[c]):(this._indices[c].forEach(function(a){return b._sheet.deleteRule(a)}),delete this._indices[c]),delete this._instancesCounts[c]}},b.update=function(a,b){this.add(b),this.remove(a)},b.flush=function(){this._sheet.flush(),this._sheet.inject(),this._fromServer=void 0,this._indices={},this._instancesCounts={}},b.cssRules=function(){var a=this,b=this._fromServer?Object.keys(this._fromServer).map(function(b){return[b,a._fromServer[b]]}):[],c=this._sheet.cssRules();return b.concat(Object.keys(this._indices).map(function(b){return[b,a._indices[b].map(function(a){return c[a].cssText}).join(a._optimizeForSpeed?"":"\n")]}).filter(function(a){return!!a[1]}))},b.styles=function(a){var b,c;return b=this.cssRules(),void 0===(c=a)&&(c={}),b.map(function(a){var b=a[0],d=a[1];return e.default.createElement("style",{id:"__"+b,key:"__"+b,nonce:c.nonce?c.nonce:void 0,dangerouslySetInnerHTML:{__html:d}})})},b.getIdAndRules=function(a){var b=a.children,c=a.dynamic,d=a.id;if(c){var e=l(d,c);return{styleId:e,rules:Array.isArray(b)?b.map(function(a){return m(e,a)}):[m(e,b)]}}return{styleId:l(d),rules:Array.isArray(b)?b:[b]}},b.selectFromServer=function(){return Array.prototype.slice.call(document.querySelectorAll('[id^="__jsx-"]')).reduce(function(a,b){return a[b.id.slice(2)]=b,a},{})},a}(),o=d.createContext(null);function p(){return new n}function q(){return d.useContext(o)}function r(a){var b=q();return b&&b.add(a),null}o.displayName="StyleSheetContext",e.default.useInsertionEffect||e.default.useLayoutEffect,r.dynamic=function(a){return a.map(function(a){return l(a[0],a[1])}).join(" ")},c.StyleRegistry=function(a){var b=a.registry,c=a.children,f=d.useContext(o),g=d.useState(function(){return f||b||p()})[0];return e.default.createElement(o.Provider,{value:g},c)},c.createStyleRegistry=p,c.style=r,c.useStyleRegistry=q},415838,(a,b,c)=>{b.exports=a.r(652259).style},225558,(a,b,c)=>{"use strict";let d=["nodebuffer","arraybuffer","fragments"],e="undefined"!=typeof Blob;e&&d.push("blob"),b.exports={BINARY_TYPES:d,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:e,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}},254242,(a,b,c)=>{"use strict";let{EMPTY_BUFFER:d}=a.r(225558),e=Buffer[Symbol.species];function f(a,b,c,d,e){for(let f=0;f<e;f++)c[d+f]=a[f]^b[3&f]}function g(a,b){for(let c=0;c<a.length;c++)a[c]^=b[3&c]}function h(a){let b;return(h.readOnly=!0,Buffer.isBuffer(a))?a:(a instanceof ArrayBuffer?b=new e(a):ArrayBuffer.isView(a)?b=new e(a.buffer,a.byteOffset,a.byteLength):(b=Buffer.from(a),h.readOnly=!1),b)}if(b.exports={concat:function(a,b){if(0===a.length)return d;if(1===a.length)return a[0];let c=Buffer.allocUnsafe(b),f=0;for(let b=0;b<a.length;b++){let d=a[b];c.set(d,f),f+=d.length}return f<b?new e(c.buffer,c.byteOffset,f):c},mask:f,toArrayBuffer:function(a){return a.length===a.buffer.byteLength?a.buffer:a.buffer.slice(a.byteOffset,a.byteOffset+a.length)},toBuffer:h,unmask:g},!process.env.WS_NO_BUFFER_UTIL)try{let a=(()=>{let a=Error("Cannot find module 'bufferutil'");throw a.code="MODULE_NOT_FOUND",a})();b.exports.mask=function(b,c,d,e,g){g<48?f(b,c,d,e,g):a.mask(b,c,d,e,g)},b.exports.unmask=function(b,c){b.length<32?g(b,c):a.unmask(b,c)}}catch(a){}},634907,(a,b,c)=>{"use strict";let d=Symbol("kDone"),e=Symbol("kRun");b.exports=class{constructor(a){this[d]=()=>{this.pending--,this[e]()},this.concurrency=a||1/0,this.jobs=[],this.pending=0}add(a){this.jobs.push(a),this[e]()}[e](){if(this.pending!==this.concurrency&&this.jobs.length){let a=this.jobs.shift();this.pending++,a(this[d])}}}},745143,(a,b,c)=>{"use strict";let d,e=a.r(406461),f=a.r(254242),g=a.r(634907),{kStatusCode:h}=a.r(225558),i=Buffer[Symbol.species],j=Buffer.from([0,0,255,255]),k=Symbol("permessage-deflate"),l=Symbol("total-length"),m=Symbol("callback"),n=Symbol("buffers"),o=Symbol("error");function p(a){this[n].push(a),this[l]+=a.length}function q(a){(this[l]+=a.length,this[k]._maxPayload<1||this[l]<=this[k]._maxPayload)?this[n].push(a):(this[o]=RangeError("Max payload size exceeded"),this[o].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[o][h]=1009,this.removeListener("data",q),this.reset())}function r(a){(this[k]._inflate=null,this[o])?this[m](this[o]):(a[h]=1007,this[m](a))}b.exports=class{constructor(a,b,c){this._maxPayload=0|c,this._options=a||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!b,this._deflate=null,this._inflate=null,this.params=null,d||(d=new g(void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10))}static get extensionName(){return"permessage-deflate"}offer(){let a={};return this._options.serverNoContextTakeover&&(a.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(a.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(a.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?a.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(a.client_max_window_bits=!0),a}accept(a){return a=this.normalizeParams(a),this.params=this._isServer?this.acceptAsServer(a):this.acceptAsClient(a),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let a=this._deflate[m];this._deflate.close(),this._deflate=null,a&&a(Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(a){let b=this._options,c=a.find(a=>(!1!==b.serverNoContextTakeover||!a.server_no_context_takeover)&&(!a.server_max_window_bits||!1!==b.serverMaxWindowBits&&("number"!=typeof b.serverMaxWindowBits||!(b.serverMaxWindowBits>a.server_max_window_bits)))&&("number"!=typeof b.clientMaxWindowBits||!!a.client_max_window_bits));if(!c)throw Error("None of the extension offers can be accepted");return b.serverNoContextTakeover&&(c.server_no_context_takeover=!0),b.clientNoContextTakeover&&(c.client_no_context_takeover=!0),"number"==typeof b.serverMaxWindowBits&&(c.server_max_window_bits=b.serverMaxWindowBits),"number"==typeof b.clientMaxWindowBits?c.client_max_window_bits=b.clientMaxWindowBits:(!0===c.client_max_window_bits||!1===b.clientMaxWindowBits)&&delete c.client_max_window_bits,c}acceptAsClient(a){let b=a[0];if(!1===this._options.clientNoContextTakeover&&b.client_no_context_takeover)throw Error('Unexpected parameter "client_no_context_takeover"');if(b.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&b.client_max_window_bits>this._options.clientMaxWindowBits)throw Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(b.client_max_window_bits=this._options.clientMaxWindowBits);return b}normalizeParams(a){return a.forEach(a=>{Object.keys(a).forEach(b=>{let c=a[b];if(c.length>1)throw Error(`Parameter "${b}" must have only a single value`);if(c=c[0],"client_max_window_bits"===b){if(!0!==c){let a=+c;if(!Number.isInteger(a)||a<8||a>15)throw TypeError(`Invalid value for parameter "${b}": ${c}`);c=a}else if(!this._isServer)throw TypeError(`Invalid value for parameter "${b}": ${c}`)}else if("server_max_window_bits"===b){let a=+c;if(!Number.isInteger(a)||a<8||a>15)throw TypeError(`Invalid value for parameter "${b}": ${c}`);c=a}else if("client_no_context_takeover"===b||"server_no_context_takeover"===b){if(!0!==c)throw TypeError(`Invalid value for parameter "${b}": ${c}`)}else throw Error(`Unknown parameter "${b}"`);a[b]=c})}),a}decompress(a,b,c){d.add(d=>{this._decompress(a,b,(a,b)=>{d(),c(a,b)})})}compress(a,b,c){d.add(d=>{this._compress(a,b,(a,b)=>{d(),c(a,b)})})}_decompress(a,b,c){let d=this._isServer?"client":"server";if(!this._inflate){let a=`${d}_max_window_bits`,b="number"!=typeof this.params[a]?e.Z_DEFAULT_WINDOWBITS:this.params[a];this._inflate=e.createInflateRaw({...this._options.zlibInflateOptions,windowBits:b}),this._inflate[k]=this,this._inflate[l]=0,this._inflate[n]=[],this._inflate.on("error",r),this._inflate.on("data",q)}this._inflate[m]=c,this._inflate.write(a),b&&this._inflate.write(j),this._inflate.flush(()=>{let a=this._inflate[o];if(a){this._inflate.close(),this._inflate=null,c(a);return}let e=f.concat(this._inflate[n],this._inflate[l]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[l]=0,this._inflate[n]=[],b&&this.params[`${d}_no_context_takeover`]&&this._inflate.reset()),c(null,e)})}_compress(a,b,c){let d=this._isServer?"server":"client";if(!this._deflate){let a=`${d}_max_window_bits`,b="number"!=typeof this.params[a]?e.Z_DEFAULT_WINDOWBITS:this.params[a];this._deflate=e.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:b}),this._deflate[l]=0,this._deflate[n]=[],this._deflate.on("data",p)}this._deflate[m]=c,this._deflate.write(a),this._deflate.flush(e.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let a=f.concat(this._deflate[n],this._deflate[l]);b&&(a=new i(a.buffer,a.byteOffset,a.length-4)),this._deflate[m]=null,this._deflate[l]=0,this._deflate[n]=[],b&&this.params[`${d}_no_context_takeover`]&&this._deflate.reset(),c(null,a)})}}},557147,(a,b,c)=>{"use strict";let{isUtf8:d}=a.r(500874),{hasBlob:e}=a.r(225558);function f(a){let b=a.length,c=0;for(;c<b;)if((128&a[c])==0)c++;else if((224&a[c])==192){if(c+1===b||(192&a[c+1])!=128||(254&a[c])==192)return!1;c+=2}else if((240&a[c])==224){if(c+2>=b||(192&a[c+1])!=128||(192&a[c+2])!=128||224===a[c]&&(224&a[c+1])==128||237===a[c]&&(224&a[c+1])==160)return!1;c+=3}else{if((248&a[c])!=240||c+3>=b||(192&a[c+1])!=128||(192&a[c+2])!=128||(192&a[c+3])!=128||240===a[c]&&(240&a[c+1])==128||244===a[c]&&a[c+1]>143||a[c]>244)return!1;c+=4}return!0}if(b.exports={isBlob:function(a){return e&&"object"==typeof a&&"function"==typeof a.arrayBuffer&&"string"==typeof a.type&&"function"==typeof a.stream&&("Blob"===a[Symbol.toStringTag]||"File"===a[Symbol.toStringTag])},isValidStatusCode:function(a){return a>=1e3&&a<=1014&&1004!==a&&1005!==a&&1006!==a||a>=3e3&&a<=4999},isValidUTF8:f,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},d)b.exports.isValidUTF8=function(a){return a.length<24?f(a):d(a)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let a=(()=>{let a=Error("Cannot find module 'utf-8-validate'");throw a.code="MODULE_NOT_FOUND",a})();b.exports.isValidUTF8=function(b){return b.length<32?f(b):a(b)}}catch(a){}},971345,(a,b,c)=>{"use strict";let{Writable:d}=a.r(688947),e=a.r(745143),{BINARY_TYPES:f,EMPTY_BUFFER:g,kStatusCode:h,kWebSocket:i}=a.r(225558),{concat:j,toArrayBuffer:k,unmask:l}=a.r(254242),{isValidStatusCode:m,isValidUTF8:n}=a.r(557147),o=Buffer[Symbol.species];b.exports=class extends d{constructor(a={}){super(),this._allowSynchronousEvents=void 0===a.allowSynchronousEvents||a.allowSynchronousEvents,this._binaryType=a.binaryType||f[0],this._extensions=a.extensions||{},this._isServer=!!a.isServer,this._maxPayload=0|a.maxPayload,this._skipUTF8Validation=!!a.skipUTF8Validation,this[i]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(a,b,c){if(8===this._opcode&&0==this._state)return c();this._bufferedBytes+=a.length,this._buffers.push(a),this.startLoop(c)}consume(a){if(this._bufferedBytes-=a,a===this._buffers[0].length)return this._buffers.shift();if(a<this._buffers[0].length){let b=this._buffers[0];return this._buffers[0]=new o(b.buffer,b.byteOffset+a,b.length-a),new o(b.buffer,b.byteOffset,a)}let b=Buffer.allocUnsafe(a);do{let c=this._buffers[0],d=b.length-a;a>=c.length?b.set(this._buffers.shift(),d):(b.set(new Uint8Array(c.buffer,c.byteOffset,a),d),this._buffers[0]=new o(c.buffer,c.byteOffset+a,c.length-a)),a-=c.length}while(a>0)return b}startLoop(a){this._loop=!0;do switch(this._state){case 0:this.getInfo(a);break;case 1:this.getPayloadLength16(a);break;case 2:this.getPayloadLength64(a);break;case 3:this.getMask();break;case 4:this.getData(a);break;case 5:case 6:this._loop=!1;return}while(this._loop)this._errored||a()}getInfo(a){if(this._bufferedBytes<2){this._loop=!1;return}let b=this.consume(2);if((48&b[0])!=0)return void a(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"));let c=(64&b[0])==64;if(c&&!this._extensions[e.extensionName])return void a(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));if(this._fin=(128&b[0])==128,this._opcode=15&b[0],this._payloadLength=127&b[1],0===this._opcode){if(c)return void a(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));if(!this._fragmented)return void a(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"));this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return void a(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));this._compressed=c}else{if(!(this._opcode>7)||!(this._opcode<11))return void a(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));if(!this._fin)return void a(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"));if(c)return void a(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength)return void a(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=(128&b[1])==128,this._isServer){if(!this._masked)return void a(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}else if(this._masked)return void a(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"));126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(a)}getPayloadLength16(a){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(a)}getPayloadLength64(a){if(this._bufferedBytes<8){this._loop=!1;return}let b=this.consume(8),c=b.readUInt32BE(0);c>2097151?a(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=0x100000000*c+b.readUInt32BE(4),this.haveLength(a))}haveLength(a){this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)?a(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH")):this._masked?this._state=3:this._state=4}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=4}getData(a){let b=g;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}b=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!=0&&l(b,this._mask)}if(this._opcode>7)return void this.controlMessage(b,a);if(this._compressed){this._state=5,this.decompress(b,a);return}b.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(b)),this.dataMessage(a)}decompress(a,b){this._extensions[e.extensionName].decompress(a,this._fin,(a,c)=>{if(a)return b(a);if(c.length){if(this._messageLength+=c.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return void b(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(c)}this.dataMessage(b),0===this._state&&this.startLoop(b)})}dataMessage(a){if(!this._fin){this._state=0;return}let b=this._messageLength,c=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let d;d="nodebuffer"===this._binaryType?j(c,b):"arraybuffer"===this._binaryType?k(j(c,b)):"blob"===this._binaryType?new Blob(c):c,this._allowSynchronousEvents?(this.emit("message",d,!0),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",d,!0),this._state=0,this.startLoop(a)}))}else{let d=j(c,b);if(!this._skipUTF8Validation&&!n(d))return void a(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));5===this._state||this._allowSynchronousEvents?(this.emit("message",d,!1),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",d,!1),this._state=0,this.startLoop(a)}))}}controlMessage(a,b){if(8===this._opcode){if(0===a.length)this._loop=!1,this.emit("conclude",1005,g),this.end();else{let c=a.readUInt16BE(0);if(!m(c))return void b(this.createError(RangeError,`invalid status code ${c}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE"));let d=new o(a.buffer,a.byteOffset+2,a.length-2);if(!this._skipUTF8Validation&&!n(d))return void b(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));this._loop=!1,this.emit("conclude",c,d),this.end()}this._state=0;return}this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",a),this._state=0):(this._state=6,setImmediate(()=>{this.emit(9===this._opcode?"ping":"pong",a),this._state=0,this.startLoop(b)}))}createError(a,b,c,d,e){this._loop=!1,this._errored=!0;let f=new a(c?`Invalid WebSocket frame: ${b}`:b);return Error.captureStackTrace(f,this.createError),f.code=e,f[h]=d,f}}},478583,(a,b,c)=>{"use strict";let d,{Duplex:e}=a.r(688947),{randomFillSync:f}=a.r(254799),g=a.r(745143),{EMPTY_BUFFER:h,kWebSocket:i,NOOP:j}=a.r(225558),{isBlob:k,isValidStatusCode:l}=a.r(557147),{mask:m,toBuffer:n}=a.r(254242),o=Symbol("kByteLength"),p=Buffer.alloc(4),q=8192;class r{constructor(a,b,c){this._extensions=b||{},c&&(this._generateMask=c,this._maskBuffer=Buffer.alloc(4)),this._socket=a,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=j,this[i]=void 0}static frame(a,b){let c,e,g=!1,h=2,i=!1;b.mask&&(c=b.maskBuffer||p,b.generateMask?b.generateMask(c):(8192===q&&(void 0===d&&(d=Buffer.alloc(8192)),f(d,0,8192),q=0),c[0]=d[q++],c[1]=d[q++],c[2]=d[q++],c[3]=d[q++]),i=(c[0]|c[1]|c[2]|c[3])==0,h=6),"string"==typeof a?e=(!b.mask||i)&&void 0!==b[o]?b[o]:(a=Buffer.from(a)).length:(e=a.length,g=b.mask&&b.readOnly&&!i);let j=e;e>=65536?(h+=8,j=127):e>125&&(h+=2,j=126);let k=Buffer.allocUnsafe(g?e+h:h);return(k[0]=b.fin?128|b.opcode:b.opcode,b.rsv1&&(k[0]|=64),k[1]=j,126===j?k.writeUInt16BE(e,2):127===j&&(k[2]=k[3]=0,k.writeUIntBE(e,4,6)),b.mask)?(k[1]|=128,k[h-4]=c[0],k[h-3]=c[1],k[h-2]=c[2],k[h-1]=c[3],i)?[k,a]:g?(m(a,c,k,h,e),[k]):(m(a,c,a,0,e),[k,a]):[k,a]}close(a,b,c,d){let e;if(void 0===a)e=h;else if("number"==typeof a&&l(a))if(void 0!==b&&b.length){let c=Buffer.byteLength(b);if(c>123)throw RangeError("The message must not be greater than 123 bytes");(e=Buffer.allocUnsafe(2+c)).writeUInt16BE(a,0),"string"==typeof b?e.write(b,2):e.set(b,2)}else(e=Buffer.allocUnsafe(2)).writeUInt16BE(a,0);else throw TypeError("First argument must be a valid error code number");let f={[o]:e.length,fin:!0,generateMask:this._generateMask,mask:c,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,e,!1,f,d]):this.sendFrame(r.frame(e,f),d)}ping(a,b,c){let d,e;if("string"==typeof a?(d=Buffer.byteLength(a),e=!1):k(a)?(d=a.size,e=!1):(d=(a=n(a)).length,e=n.readOnly),d>125)throw RangeError("The data size must not be greater than 125 bytes");let f={[o]:d,fin:!0,generateMask:this._generateMask,mask:b,maskBuffer:this._maskBuffer,opcode:9,readOnly:e,rsv1:!1};k(a)?0!==this._state?this.enqueue([this.getBlobData,a,!1,f,c]):this.getBlobData(a,!1,f,c):0!==this._state?this.enqueue([this.dispatch,a,!1,f,c]):this.sendFrame(r.frame(a,f),c)}pong(a,b,c){let d,e;if("string"==typeof a?(d=Buffer.byteLength(a),e=!1):k(a)?(d=a.size,e=!1):(d=(a=n(a)).length,e=n.readOnly),d>125)throw RangeError("The data size must not be greater than 125 bytes");let f={[o]:d,fin:!0,generateMask:this._generateMask,mask:b,maskBuffer:this._maskBuffer,opcode:10,readOnly:e,rsv1:!1};k(a)?0!==this._state?this.enqueue([this.getBlobData,a,!1,f,c]):this.getBlobData(a,!1,f,c):0!==this._state?this.enqueue([this.dispatch,a,!1,f,c]):this.sendFrame(r.frame(a,f),c)}send(a,b,c){let d,e,f=this._extensions[g.extensionName],h=b.binary?2:1,i=b.compress;"string"==typeof a?(d=Buffer.byteLength(a),e=!1):k(a)?(d=a.size,e=!1):(d=(a=n(a)).length,e=n.readOnly),this._firstFragment?(this._firstFragment=!1,i&&f&&f.params[f._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(i=d>=f._threshold),this._compress=i):(i=!1,h=0),b.fin&&(this._firstFragment=!0);let j={[o]:d,fin:b.fin,generateMask:this._generateMask,mask:b.mask,maskBuffer:this._maskBuffer,opcode:h,readOnly:e,rsv1:i};k(a)?0!==this._state?this.enqueue([this.getBlobData,a,this._compress,j,c]):this.getBlobData(a,this._compress,j,c):0!==this._state?this.enqueue([this.dispatch,a,this._compress,j,c]):this.dispatch(a,this._compress,j,c)}getBlobData(a,b,c,d){this._bufferedBytes+=c[o],this._state=2,a.arrayBuffer().then(a=>{if(this._socket.destroyed){let a=Error("The socket was closed while the blob was being read");process.nextTick(s,this,a,d);return}this._bufferedBytes-=c[o];let e=n(a);b?this.dispatch(e,b,c,d):(this._state=0,this.sendFrame(r.frame(e,c),d),this.dequeue())}).catch(a=>{process.nextTick(t,this,a,d)})}dispatch(a,b,c,d){if(!b)return void this.sendFrame(r.frame(a,c),d);let e=this._extensions[g.extensionName];this._bufferedBytes+=c[o],this._state=1,e.compress(a,c.fin,(a,b)=>{this._socket.destroyed?s(this,Error("The socket was closed while data was being compressed"),d):(this._bufferedBytes-=c[o],this._state=0,c.readOnly=!1,this.sendFrame(r.frame(b,c),d),this.dequeue())})}dequeue(){for(;0===this._state&&this._queue.length;){let a=this._queue.shift();this._bufferedBytes-=a[3][o],Reflect.apply(a[0],this,a.slice(1))}}enqueue(a){this._bufferedBytes+=a[3][o],this._queue.push(a)}sendFrame(a,b){2===a.length?(this._socket.cork(),this._socket.write(a[0]),this._socket.write(a[1],b),this._socket.uncork()):this._socket.write(a[0],b)}}function s(a,b,c){"function"==typeof c&&c(b);for(let c=0;c<a._queue.length;c++){let d=a._queue[c],e=d[d.length-1];"function"==typeof e&&e(b)}}function t(a,b,c){s(a,b,c),a.onerror(b)}b.exports=r},21392,(a,b,c)=>{"use strict";let{kForOnEventAttribute:d,kListener:e}=a.r(225558),f=Symbol("kCode"),g=Symbol("kData"),h=Symbol("kError"),i=Symbol("kMessage"),j=Symbol("kReason"),k=Symbol("kTarget"),l=Symbol("kType"),m=Symbol("kWasClean");class n{constructor(a){this[k]=null,this[l]=a}get target(){return this[k]}get type(){return this[l]}}Object.defineProperty(n.prototype,"target",{enumerable:!0}),Object.defineProperty(n.prototype,"type",{enumerable:!0});class o extends n{constructor(a,b={}){super(a),this[f]=void 0===b.code?0:b.code,this[j]=void 0===b.reason?"":b.reason,this[m]=void 0!==b.wasClean&&b.wasClean}get code(){return this[f]}get reason(){return this[j]}get wasClean(){return this[m]}}Object.defineProperty(o.prototype,"code",{enumerable:!0}),Object.defineProperty(o.prototype,"reason",{enumerable:!0}),Object.defineProperty(o.prototype,"wasClean",{enumerable:!0});class p extends n{constructor(a,b={}){super(a),this[h]=void 0===b.error?null:b.error,this[i]=void 0===b.message?"":b.message}get error(){return this[h]}get message(){return this[i]}}Object.defineProperty(p.prototype,"error",{enumerable:!0}),Object.defineProperty(p.prototype,"message",{enumerable:!0});class q extends n{constructor(a,b={}){super(a),this[g]=void 0===b.data?null:b.data}get data(){return this[g]}}function r(a,b,c){"object"==typeof a&&a.handleEvent?a.handleEvent.call(a,c):a.call(b,c)}Object.defineProperty(q.prototype,"data",{enumerable:!0}),b.exports={CloseEvent:o,ErrorEvent:p,Event:n,EventTarget:{addEventListener(a,b,c={}){let f;for(let f of this.listeners(a))if(!c[d]&&f[e]===b&&!f[d])return;if("message"===a)f=function(a,c){let d=new q("message",{data:c?a:a.toString()});d[k]=this,r(b,this,d)};else if("close"===a)f=function(a,c){let d=new o("close",{code:a,reason:c.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});d[k]=this,r(b,this,d)};else if("error"===a)f=function(a){let c=new p("error",{error:a,message:a.message});c[k]=this,r(b,this,c)};else{if("open"!==a)return;f=function(){let a=new n("open");a[k]=this,r(b,this,a)}}f[d]=!!c[d],f[e]=b,c.once?this.once(a,f):this.on(a,f)},removeEventListener(a,b){for(let c of this.listeners(a))if(c[e]===b&&!c[d]){this.removeListener(a,c);break}}},MessageEvent:q}},943017,(a,b,c)=>{"use strict";let{tokenChars:d}=a.r(557147);function e(a,b,c){void 0===a[b]?a[b]=[c]:a[b].push(c)}b.exports={format:function(a){return Object.keys(a).map(b=>{let c=a[b];return Array.isArray(c)||(c=[c]),c.map(a=>[b].concat(Object.keys(a).map(b=>{let c=a[b];return Array.isArray(c)||(c=[c]),c.map(a=>!0===a?b:`${b}=${a}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(a){let b,c,f=Object.create(null),g=Object.create(null),h=!1,i=!1,j=!1,k=-1,l=-1,m=-1,n=0;for(;n<a.length;n++)if(l=a.charCodeAt(n),void 0===b)if(-1===m&&1===d[l])-1===k&&(k=n);else if(0!==n&&(32===l||9===l))-1===m&&-1!==k&&(m=n);else if(59===l||44===l){if(-1===k)throw SyntaxError(`Unexpected character at index ${n}`);-1===m&&(m=n);let c=a.slice(k,m);44===l?(e(f,c,g),g=Object.create(null)):b=c,k=m=-1}else throw SyntaxError(`Unexpected character at index ${n}`);else if(void 0===c)if(-1===m&&1===d[l])-1===k&&(k=n);else if(32===l||9===l)-1===m&&-1!==k&&(m=n);else if(59===l||44===l){if(-1===k)throw SyntaxError(`Unexpected character at index ${n}`);-1===m&&(m=n),e(g,a.slice(k,m),!0),44===l&&(e(f,b,g),g=Object.create(null),b=void 0),k=m=-1}else if(61===l&&-1!==k&&-1===m)c=a.slice(k,n),k=m=-1;else throw SyntaxError(`Unexpected character at index ${n}`);else if(i){if(1!==d[l])throw SyntaxError(`Unexpected character at index ${n}`);-1===k?k=n:h||(h=!0),i=!1}else if(j)if(1===d[l])-1===k&&(k=n);else if(34===l&&-1!==k)j=!1,m=n;else if(92===l)i=!0;else throw SyntaxError(`Unexpected character at index ${n}`);else if(34===l&&61===a.charCodeAt(n-1))j=!0;else if(-1===m&&1===d[l])-1===k&&(k=n);else if(-1!==k&&(32===l||9===l))-1===m&&(m=n);else if(59===l||44===l){if(-1===k)throw SyntaxError(`Unexpected character at index ${n}`);-1===m&&(m=n);let d=a.slice(k,m);h&&(d=d.replace(/\\/g,""),h=!1),e(g,c,d),44===l&&(e(f,b,g),g=Object.create(null),b=void 0),c=void 0,k=m=-1}else throw SyntaxError(`Unexpected character at index ${n}`);if(-1===k||j||32===l||9===l)throw SyntaxError("Unexpected end of input");-1===m&&(m=n);let o=a.slice(k,m);return void 0===b?e(f,o,g):(void 0===c?e(g,o,!0):h?e(g,c,o.replace(/\\/g,"")):e(g,c,o),e(f,b,g)),f}}},141649,(a,b,c)=>{"use strict";let d=a.r(427699),e=a.r(524836),f=a.r(921517),g=a.r(504446),h=a.r(755004),{randomBytes:i,createHash:j}=a.r(254799),{Duplex:k,Readable:l}=a.r(688947),{URL:m}=a.r(792509),n=a.r(745143),o=a.r(971345),p=a.r(478583),{isBlob:q}=a.r(557147),{BINARY_TYPES:r,EMPTY_BUFFER:s,GUID:t,kForOnEventAttribute:u,kListener:v,kStatusCode:w,kWebSocket:x,NOOP:y}=a.r(225558),{EventTarget:{addEventListener:z,removeEventListener:A}}=a.r(21392),{format:B,parse:C}=a.r(943017),{toBuffer:D}=a.r(254242),E=Symbol("kAborted"),F=[8,13],G=["CONNECTING","OPEN","CLOSING","CLOSED"],H=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class I extends d{constructor(a,b,c){super(),this._binaryType=r[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=s,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=I.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==a?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===b?b=[]:Array.isArray(b)||("object"==typeof b&&null!==b?(c=b,b=[]):b=[b]),function a(b,c,d,g){let h,k,l,o,p={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:F[1],maxPayload:0x6400000,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...g,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(b._autoPong=p.autoPong,!F.includes(p.protocolVersion))throw RangeError(`Unsupported protocol version: ${p.protocolVersion} (supported versions: ${F.join(", ")})`);if(c instanceof m)h=c;else try{h=new m(c)}catch(a){throw SyntaxError(`Invalid URL: ${c}`)}"http:"===h.protocol?h.protocol="ws:":"https:"===h.protocol&&(h.protocol="wss:"),b._url=h.href;let q="wss:"===h.protocol,r="ws+unix:"===h.protocol;if("ws:"===h.protocol||q||r?r&&!h.pathname?k="The URL's pathname is empty":h.hash&&(k="The URL contains a fragment identifier"):k='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"',k){let a=SyntaxError(k);if(0!==b._redirects)return void J(b,a);throw a}let s=q?443:80,u=i(16).toString("base64"),v=q?e.request:f.request,w=new Set;if(p.createConnection=p.createConnection||(q?L:K),p.defaultPort=p.defaultPort||s,p.port=h.port||s,p.host=h.hostname.startsWith("[")?h.hostname.slice(1,-1):h.hostname,p.headers={...p.headers,"Sec-WebSocket-Version":p.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket"},p.path=h.pathname+h.search,p.timeout=p.handshakeTimeout,p.perMessageDeflate&&(l=new n(!0!==p.perMessageDeflate?p.perMessageDeflate:{},!1,p.maxPayload),p.headers["Sec-WebSocket-Extensions"]=B({[n.extensionName]:l.offer()})),d.length){for(let a of d){if("string"!=typeof a||!H.test(a)||w.has(a))throw SyntaxError("An invalid or duplicated subprotocol was specified");w.add(a)}p.headers["Sec-WebSocket-Protocol"]=d.join(",")}if(p.origin&&(p.protocolVersion<13?p.headers["Sec-WebSocket-Origin"]=p.origin:p.headers.Origin=p.origin),(h.username||h.password)&&(p.auth=`${h.username}:${h.password}`),r){let a=p.path.split(":");p.socketPath=a[0],p.path=a[1]}if(p.followRedirects){if(0===b._redirects){b._originalIpc=r,b._originalSecure=q,b._originalHostOrSocketPath=r?p.socketPath:h.host;let a=g&&g.headers;if(g={...g,headers:{}},a)for(let[b,c]of Object.entries(a))g.headers[b.toLowerCase()]=c}else if(0===b.listenerCount("redirect")){let a=r?!!b._originalIpc&&p.socketPath===b._originalHostOrSocketPath:!b._originalIpc&&h.host===b._originalHostOrSocketPath;a&&(!b._originalSecure||q)||(delete p.headers.authorization,delete p.headers.cookie,a||delete p.headers.host,p.auth=void 0)}p.auth&&!g.headers.authorization&&(g.headers.authorization="Basic "+Buffer.from(p.auth).toString("base64")),o=b._req=v(p),b._redirects&&b.emit("redirect",b.url,o)}else o=b._req=v(p);p.timeout&&o.on("timeout",()=>{M(b,o,"Opening handshake has timed out")}),o.on("error",a=>{null===o||o[E]||(o=b._req=null,J(b,a))}),o.on("response",e=>{let f=e.headers.location,h=e.statusCode;if(f&&p.followRedirects&&h>=300&&h<400){let e;if(++b._redirects>p.maxRedirects)return void M(b,o,"Maximum redirects exceeded");o.abort();try{e=new m(f,c)}catch(a){J(b,SyntaxError(`Invalid URL: ${f}`));return}a(b,e,d,g)}else b.emit("unexpected-response",o,e)||M(b,o,`Unexpected server response: ${e.statusCode}`)}),o.on("upgrade",(a,c,d)=>{let e;if(b.emit("upgrade",a),b.readyState!==I.CONNECTING)return;o=b._req=null;let f=a.headers.upgrade;if(void 0===f||"websocket"!==f.toLowerCase())return void M(b,c,"Invalid Upgrade header");let g=j("sha1").update(u+t).digest("base64");if(a.headers["sec-websocket-accept"]!==g)return void M(b,c,"Invalid Sec-WebSocket-Accept header");let h=a.headers["sec-websocket-protocol"];if(void 0!==h?w.size?w.has(h)||(e="Server sent an invalid subprotocol"):e="Server sent a subprotocol but none was requested":w.size&&(e="Server sent no subprotocol"),e)return void M(b,c,e);h&&(b._protocol=h);let i=a.headers["sec-websocket-extensions"];if(void 0!==i){let a;if(!l)return void M(b,c,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");try{a=C(i)}catch(a){M(b,c,"Invalid Sec-WebSocket-Extensions header");return}let d=Object.keys(a);if(1!==d.length||d[0]!==n.extensionName)return void M(b,c,"Server indicated an extension that was not requested");try{l.accept(a[n.extensionName])}catch(a){M(b,c,"Invalid Sec-WebSocket-Extensions header");return}b._extensions[n.extensionName]=l}b.setSocket(c,d,{allowSynchronousEvents:p.allowSynchronousEvents,generateMask:p.generateMask,maxPayload:p.maxPayload,skipUTF8Validation:p.skipUTF8Validation})}),p.finishRequest?p.finishRequest(o,b):o.end()}(this,a,b,c)):(this._autoPong=c.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(a){r.includes(a)&&(this._binaryType=a,this._receiver&&(this._receiver._binaryType=a))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(a,b,c){let d=new o({allowSynchronousEvents:c.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:c.maxPayload,skipUTF8Validation:c.skipUTF8Validation}),e=new p(a,this._extensions,c.generateMask);this._receiver=d,this._sender=e,this._socket=a,d[x]=this,e[x]=this,a[x]=this,d.on("conclude",O),d.on("drain",P),d.on("error",Q),d.on("message",S),d.on("ping",T),d.on("pong",U),e.onerror=W,a.setTimeout&&a.setTimeout(0),a.setNoDelay&&a.setNoDelay(),b.length>0&&a.unshift(b),a.on("close",Y),a.on("data",Z),a.on("end",$),a.on("error",_),this._readyState=I.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=I.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[n.extensionName]&&this._extensions[n.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=I.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(a,b){if(this.readyState!==I.CLOSED){if(this.readyState===I.CONNECTING)return void M(this,this._req,"WebSocket was closed before the connection was established");if(this.readyState===I.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=I.CLOSING,this._sender.close(a,b,!this._isServer,a=>{!a&&(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),X(this)}}pause(){this.readyState!==I.CONNECTING&&this.readyState!==I.CLOSED&&(this._paused=!0,this._socket.pause())}ping(a,b,c){if(this.readyState===I.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");("function"==typeof a?(c=a,a=b=void 0):"function"==typeof b&&(c=b,b=void 0),"number"==typeof a&&(a=a.toString()),this.readyState!==I.OPEN)?N(this,a,c):(void 0===b&&(b=!this._isServer),this._sender.ping(a||s,b,c))}pong(a,b,c){if(this.readyState===I.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");("function"==typeof a?(c=a,a=b=void 0):"function"==typeof b&&(c=b,b=void 0),"number"==typeof a&&(a=a.toString()),this.readyState!==I.OPEN)?N(this,a,c):(void 0===b&&(b=!this._isServer),this._sender.pong(a||s,b,c))}resume(){this.readyState!==I.CONNECTING&&this.readyState!==I.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(a,b,c){if(this.readyState===I.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof b&&(c=b,b={}),"number"==typeof a&&(a=a.toString()),this.readyState!==I.OPEN)return void N(this,a,c);let d={binary:"string"!=typeof a,mask:!this._isServer,compress:!0,fin:!0,...b};this._extensions[n.extensionName]||(d.compress=!1),this._sender.send(a||s,d,c)}terminate(){if(this.readyState!==I.CLOSED){if(this.readyState===I.CONNECTING)return void M(this,this._req,"WebSocket was closed before the connection was established");this._socket&&(this._readyState=I.CLOSING,this._socket.destroy())}}}function J(a,b){a._readyState=I.CLOSING,a._errorEmitted=!0,a.emit("error",b),a.emitClose()}function K(a){return a.path=a.socketPath,g.connect(a)}function L(a){return a.path=void 0,a.servername||""===a.servername||(a.servername=g.isIP(a.host)?"":a.host),h.connect(a)}function M(a,b,c){a._readyState=I.CLOSING;let d=Error(c);Error.captureStackTrace(d,M),b.setHeader?(b[E]=!0,b.abort(),b.socket&&!b.socket.destroyed&&b.socket.destroy(),process.nextTick(J,a,d)):(b.destroy(d),b.once("error",a.emit.bind(a,"error")),b.once("close",a.emitClose.bind(a)))}function N(a,b,c){if(b){let c=q(b)?b.size:D(b).length;a._socket?a._sender._bufferedBytes+=c:a._bufferedAmount+=c}if(c){let b=Error(`WebSocket is not open: readyState ${a.readyState} (${G[a.readyState]})`);process.nextTick(c,b)}}function O(a,b){let c=this[x];c._closeFrameReceived=!0,c._closeMessage=b,c._closeCode=a,void 0!==c._socket[x]&&(c._socket.removeListener("data",Z),process.nextTick(V,c._socket),1005===a?c.close():c.close(a,b))}function P(){let a=this[x];a.isPaused||a._socket.resume()}function Q(a){let b=this[x];void 0!==b._socket[x]&&(b._socket.removeListener("data",Z),process.nextTick(V,b._socket),b.close(a[w])),b._errorEmitted||(b._errorEmitted=!0,b.emit("error",a))}function R(){this[x].emitClose()}function S(a,b){this[x].emit("message",a,b)}function T(a){let b=this[x];b._autoPong&&b.pong(a,!this._isServer,y),b.emit("ping",a)}function U(a){this[x].emit("pong",a)}function V(a){a.resume()}function W(a){let b=this[x];b.readyState!==I.CLOSED&&(b.readyState===I.OPEN&&(b._readyState=I.CLOSING,X(b)),this._socket.end(),b._errorEmitted||(b._errorEmitted=!0,b.emit("error",a)))}function X(a){a._closeTimer=setTimeout(a._socket.destroy.bind(a._socket),3e4)}function Y(){let a,b=this[x];this.removeListener("close",Y),this.removeListener("data",Z),this.removeListener("end",$),b._readyState=I.CLOSING,this._readableState.endEmitted||b._closeFrameReceived||b._receiver._writableState.errorEmitted||null===(a=b._socket.read())||b._receiver.write(a),b._receiver.end(),this[x]=void 0,clearTimeout(b._closeTimer),b._receiver._writableState.finished||b._receiver._writableState.errorEmitted?b.emitClose():(b._receiver.on("error",R),b._receiver.on("finish",R))}function Z(a){this[x]._receiver.write(a)||this.pause()}function $(){let a=this[x];a._readyState=I.CLOSING,a._receiver.end(),this.end()}function _(){let a=this[x];this.removeListener("error",_),this.on("error",y),a&&(a._readyState=I.CLOSING,this.destroy())}Object.defineProperty(I,"CONNECTING",{enumerable:!0,value:G.indexOf("CONNECTING")}),Object.defineProperty(I.prototype,"CONNECTING",{enumerable:!0,value:G.indexOf("CONNECTING")}),Object.defineProperty(I,"OPEN",{enumerable:!0,value:G.indexOf("OPEN")}),Object.defineProperty(I.prototype,"OPEN",{enumerable:!0,value:G.indexOf("OPEN")}),Object.defineProperty(I,"CLOSING",{enumerable:!0,value:G.indexOf("CLOSING")}),Object.defineProperty(I.prototype,"CLOSING",{enumerable:!0,value:G.indexOf("CLOSING")}),Object.defineProperty(I,"CLOSED",{enumerable:!0,value:G.indexOf("CLOSED")}),Object.defineProperty(I.prototype,"CLOSED",{enumerable:!0,value:G.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(a=>{Object.defineProperty(I.prototype,a,{enumerable:!0})}),["open","error","close","message"].forEach(a=>{Object.defineProperty(I.prototype,`on${a}`,{enumerable:!0,get(){for(let b of this.listeners(a))if(b[u])return b[v];return null},set(b){for(let b of this.listeners(a))if(b[u]){this.removeListener(a,b);break}"function"==typeof b&&this.addEventListener(a,b,{[u]:!0})}})}),I.prototype.addEventListener=z,I.prototype.removeEventListener=A,b.exports=I},210578,(a,b,c)=>{"use strict";a.r(141649);let{Duplex:d}=a.r(688947);function e(a){a.emit("close")}function f(){!this.destroyed&&this._writableState.finished&&this.destroy()}function g(a){this.removeListener("error",g),this.destroy(),0===this.listenerCount("error")&&this.emit("error",a)}b.exports=function(a,b){let c=!0,h=new d({...b,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return a.on("message",function(b,c){let d=!c&&h._readableState.objectMode?b.toString():b;h.push(d)||a.pause()}),a.once("error",function(a){h.destroyed||(c=!1,h.destroy(a))}),a.once("close",function(){h.destroyed||h.push(null)}),h._destroy=function(b,d){if(a.readyState===a.CLOSED){d(b),process.nextTick(e,h);return}let f=!1;a.once("error",function(a){f=!0,d(a)}),a.once("close",function(){f||d(b),process.nextTick(e,h)}),c&&a.terminate()},h._final=function(b){a.readyState===a.CONNECTING?a.once("open",function(){h._final(b)}):null!==a._socket&&(a._socket._writableState.finished?(b(),h._readableState.endEmitted&&h.destroy()):(a._socket.once("finish",function(){b()}),a.close()))},h._read=function(){a.isPaused&&a.resume()},h._write=function(b,c,d){a.readyState===a.CONNECTING?a.once("open",function(){h._write(b,c,d)}):a.send(b,d)},h.on("end",f),h.on("error",g),h}},235134,(a,b,c)=>{"use strict";let{tokenChars:d}=a.r(557147);b.exports={parse:function(a){let b=new Set,c=-1,e=-1,f=0;for(;f<a.length;f++){let g=a.charCodeAt(f);if(-1===e&&1===d[g])-1===c&&(c=f);else if(0!==f&&(32===g||9===g))-1===e&&-1!==c&&(e=f);else if(44===g){if(-1===c)throw SyntaxError(`Unexpected character at index ${f}`);-1===e&&(e=f);let d=a.slice(c,e);if(b.has(d))throw SyntaxError(`The "${d}" subprotocol is duplicated`);b.add(d),c=e=-1}else throw SyntaxError(`Unexpected character at index ${f}`)}if(-1===c||-1!==e)throw SyntaxError("Unexpected end of input");let g=a.slice(c,f);if(b.has(g))throw SyntaxError(`The "${g}" subprotocol is duplicated`);return b.add(g),b}}},304294,(a,b,c)=>{"use strict";let d=a.r(427699),e=a.r(921517),{Duplex:f}=a.r(688947),{createHash:g}=a.r(254799),h=a.r(943017),i=a.r(745143),j=a.r(235134),k=a.r(141649),{GUID:l,kWebSocket:m}=a.r(225558),n=/^[+/0-9A-Za-z]{22}==$/;function o(a){a._state=2,a.emit("close")}function p(){this.destroy()}function q(a,b,c,d){c=c||e.STATUS_CODES[b],d={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(c),...d},a.once("finish",a.destroy),a.end(`HTTP/1.1 ${b} ${e.STATUS_CODES[b]}\r
`+Object.keys(d).map(a=>`${a}: ${d[a]}`).join("\r\n")+"\r\n\r\n"+c)}function r(a,b,c,d,e,f){if(a.listenerCount("wsClientError")){let d=Error(e);Error.captureStackTrace(d,r),a.emit("wsClientError",d,c,b)}else q(c,d,e,f)}b.exports=class extends d{constructor(a,b){if(super(),null==(a={allowSynchronousEvents:!0,autoPong:!0,maxPayload:0x6400000,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:k,...a}).port&&!a.server&&!a.noServer||null!=a.port&&(a.server||a.noServer)||a.server&&a.noServer)throw TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=a.port?(this._server=e.createServer((a,b)=>{let c=e.STATUS_CODES[426];b.writeHead(426,{"Content-Length":c.length,"Content-Type":"text/plain"}),b.end(c)}),this._server.listen(a.port,a.host,a.backlog,b)):a.server&&(this._server=a.server),this._server){const a=this.emit.bind(this,"connection");this._removeListeners=function(a,b){for(let c of Object.keys(b))a.on(c,b[c]);return function(){for(let c of Object.keys(b))a.removeListener(c,b[c])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(b,c,d)=>{this.handleUpgrade(b,c,d,a)}})}!0===a.perMessageDeflate&&(a.perMessageDeflate={}),a.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=a,this._state=0}address(){if(this.options.noServer)throw Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(a){if(2===this._state){a&&this.once("close",()=>{a(Error("The server is not running"))}),process.nextTick(o,this);return}if(a&&this.once("close",a),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(o,this);else{let a=this._server;this._removeListeners(),this._removeListeners=this._server=null,a.close(()=>{o(this)})}}shouldHandle(a){if(this.options.path){let b=a.url.indexOf("?");if((-1!==b?a.url.slice(0,b):a.url)!==this.options.path)return!1}return!0}handleUpgrade(a,b,c,d){b.on("error",p);let e=a.headers["sec-websocket-key"],f=a.headers.upgrade,g=+a.headers["sec-websocket-version"];if("GET"!==a.method)return void r(this,a,b,405,"Invalid HTTP method");if(void 0===f||"websocket"!==f.toLowerCase())return void r(this,a,b,400,"Invalid Upgrade header");if(void 0===e||!n.test(e))return void r(this,a,b,400,"Missing or invalid Sec-WebSocket-Key header");if(13!==g&&8!==g)return void r(this,a,b,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});if(!this.shouldHandle(a))return void q(b,400);let k=a.headers["sec-websocket-protocol"],l=new Set;if(void 0!==k)try{l=j.parse(k)}catch(c){r(this,a,b,400,"Invalid Sec-WebSocket-Protocol header");return}let m=a.headers["sec-websocket-extensions"],o={};if(this.options.perMessageDeflate&&void 0!==m){let c=new i(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let a=h.parse(m);a[i.extensionName]&&(c.accept(a[i.extensionName]),o[i.extensionName]=c)}catch(c){r(this,a,b,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let f={origin:a.headers[`${8===g?"sec-websocket-origin":"origin"}`],secure:!!(a.socket.authorized||a.socket.encrypted),req:a};if(2===this.options.verifyClient.length)return void this.options.verifyClient(f,(f,g,h,i)=>{if(!f)return q(b,g||401,h,i);this.completeUpgrade(o,e,l,a,b,c,d)});if(!this.options.verifyClient(f))return q(b,401)}this.completeUpgrade(o,e,l,a,b,c,d)}completeUpgrade(a,b,c,d,e,f,j){if(!e.readable||!e.writable)return e.destroy();if(e[m])throw Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return q(e,503);let k=g("sha1").update(b+l).digest("base64"),n=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${k}`],r=new this.options.WebSocket(null,void 0,this.options);if(c.size){let a=this.options.handleProtocols?this.options.handleProtocols(c,d):c.values().next().value;a&&(n.push(`Sec-WebSocket-Protocol: ${a}`),r._protocol=a)}if(a[i.extensionName]){let b=a[i.extensionName].params,c=h.format({[i.extensionName]:[b]});n.push(`Sec-WebSocket-Extensions: ${c}`),r._extensions=a}this.emit("headers",n,d),e.write(n.concat("\r\n").join("\r\n")),e.removeListener("error",p),r.setSocket(e,f,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(r),r.on("close",()=>{this.clients.delete(r),this._shouldEmitClose&&!this.clients.size&&process.nextTick(o,this)})),j(r,d)}}},132958,(a,b,c)=>{"use strict";let d=a.r(141649);d.createWebSocketStream=a.r(210578),d.Server=a.r(304294),d.Receiver=a.r(971345),d.Sender=a.r(478583),d.WebSocket=d,d.WebSocketServer=d.Server,b.exports=d},101986,(a,b,c)=>{"use strict";b.exports=a.r(132958)},625725,a=>{"use strict";var b,c=a.i(92585),d=a.i(649970),e=a.i(592385),f=a.i(506017),g=a.i(596013),h=a.i(947218),i=a.i(865950),j=a.i(239337),k=a.i(165696),l=a.i(396560),m=a.i(445148),n=a.i(407027),o=a.i(902142),p=a.i(968366);let q={searchTerm:"",searchResults:null,searchResultIndex:0,searchProgress:1},r={activeBooknoteType:null,booknoteResults:null,booknoteIndex:0},s=(0,p.create)((a,b)=>({sideBarBookKey:null,sideBarWidth:"",isSideBarVisible:!1,isSideBarPinned:!1,searchNavStates:{},booknotesNavStates:{},searchStatuses:{},getIsSideBarVisible:()=>b().isSideBarVisible,getSideBarWidth:()=>b().sideBarWidth,setSideBarBookKey:b=>a({sideBarBookKey:b}),setSideBarWidth:b=>a({sideBarWidth:b}),toggleSideBar:()=>a(a=>({isSideBarVisible:!a.isSideBarVisible})),toggleSideBarPin:()=>a(a=>({isSideBarPinned:!a.isSideBarPinned})),setSideBarVisible:b=>a({isSideBarVisible:b}),setSideBarPin:b=>a({isSideBarPinned:b}),getSearchStatus:a=>b().searchStatuses[a]||null,getSearchNavState:a=>b().searchNavStates[a]||q,setSearchTerm:(b,c)=>a(a=>({searchNavStates:{...a.searchNavStates,[b]:{...a.searchNavStates[b]||q,searchTerm:c}}})),setSearchResults:(b,c)=>a(a=>({searchNavStates:{...a.searchNavStates,[b]:{...a.searchNavStates[b]||q,searchResults:c}}})),setSearchResultIndex:(b,c)=>a(a=>({searchNavStates:{...a.searchNavStates,[b]:{...a.searchNavStates[b]||q,searchResultIndex:c}}})),setSearchProgress:(b,c)=>a(a=>({searchNavStates:{...a.searchNavStates,[b]:{...a.searchNavStates[b]||q,searchProgress:c}}})),clearSearch:b=>a(a=>({searchNavStates:{...a.searchNavStates,[b]:{...q}},searchStatuses:{...a.searchStatuses,[b]:"terminated"}})),setSearchStatus:(b,c)=>a(a=>({searchStatuses:{...a.searchStatuses,[b]:c}})),getBooknotesNavState:a=>b().booknotesNavStates[a]||r,setActiveBooknoteType:(b,c)=>a(a=>({booknotesNavStates:{...a.booknotesNavStates,[b]:{...a.booknotesNavStates[b]||r,activeBooknoteType:c}}})),setBooknoteResults:(b,c)=>a(a=>({booknotesNavStates:{...a.booknotesNavStates,[b]:{...a.booknotesNavStates[b]||r,booknoteResults:c}}})),setBooknoteIndex:(b,c)=>a(a=>({booknotesNavStates:{...a.booknotesNavStates,[b]:{...a.booknotesNavStates[b]||r,booknoteIndex:c}}})),clearBooknotesNav:b=>a(a=>({booknotesNavStates:{...a.booknotesNavStates,[b]:{...r}}}))})),t=(0,p.create)((a,b)=>({notebookWidth:"",isNotebookVisible:!1,isNotebookPinned:!1,notebookNewAnnotation:null,notebookEditAnnotation:null,notebookAnnotationDrafts:{},getIsNotebookVisible:()=>b().isNotebookVisible,getNotebookWidth:()=>b().notebookWidth,setNotebookWidth:b=>a({notebookWidth:b}),toggleNotebook:()=>a(a=>({isNotebookVisible:!a.isNotebookVisible})),toggleNotebookPin:()=>a(a=>({isNotebookPinned:!a.isNotebookPinned})),setNotebookVisible:b=>a({isNotebookVisible:b}),setNotebookPin:b=>a({isNotebookPinned:b}),setNotebookNewAnnotation:b=>a({notebookNewAnnotation:b}),setNotebookEditAnnotation:b=>a({notebookEditAnnotation:b}),saveNotebookAnnotationDraft:(b,c)=>a(a=>({notebookAnnotationDrafts:{...a.notebookAnnotationDrafts,[b]:c}})),getNotebookAnnotationDraft:a=>b().notebookAnnotationDrafts[a]}));var u=a.i(392212),v=a.i(692017),w=a.i(557767),x=a.i(690557),y=a.i(65091),z=a.i(833047),A=a.i(751328),B=a.i(649661),C=a.i(142773),D=a.i(325219),E=a.i(808091),F=a.i(619974),G=a.i(288638),H=a.i(674893);class I{config;isLanServer;constructor(a){this.config=a,this.config.serverUrl=a.serverUrl.replace(/\/$/,""),this.isLanServer=(0,H.isLanAddress)(this.config.serverUrl)}async request(a,b={}){let{method:c="GET",body:d,headers:e,useAuth:f=!0}=b,g=new Headers(e||{});return(f&&(g.set("X-Auth-User",this.config.username),g.set("X-Auth-Key",this.config.userkey)),this.isLanServer||(0,z.isTauriAppPlatform)())?((0,z.isTauriAppPlatform)()?G.fetch:window.fetch)(`${this.config.serverUrl}${a}`,{method:c,headers:{accept:"application/vnd.koreader.v1+json",..."GET"===c?{}:{"Content-Type":"application/json"},...Object.fromEntries(g.entries())},body:d,danger:{acceptInvalidCerts:!0,acceptInvalidHostnames:!0}}):fetch(`${(0,z.getAPIBaseUrl)()}/kosync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({serverUrl:this.config.serverUrl,endpoint:a,method:c,headers:Object.fromEntries(g.entries()),body:d?JSON.parse(d):void 0})})}async connect(a,b){let c=(0,E.md5)(b);try{let b=await this.request("/users/auth",{method:"GET",headers:{"X-Auth-User":a,"X-Auth-Key":c}});if(b.ok)return{success:!0,message:"Login successful."};if(401===b.status){let b=await this.request("/users/create",{method:"POST",useAuth:!1,body:JSON.stringify({username:a,password:c})});if(b.ok)return{success:!0,message:"Registration successful."};let d=await b.json().catch(()=>({}));if(402===b.status)return{success:!1,message:"Invalid credentials."};return{success:!1,message:d.message||"Registration failed."}}let d=await b.json().catch(()=>({}));return{success:!1,message:d.message||`Authorization failed with status: ${b.status}`}}catch(a){return console.error("KOSync connection failed",a),{success:!1,message:a.message||"Connection error."}}}async getProgress(a){if(!this.config.userkey)return null;let b=this.getDocumentDigest(a);if(!b)return null;try{let c=await this.request(`/syncs/progress/${b}`);if(!c.ok)return console.error(`KOSync: Failed to get progress for ${a.title}. Status: ${c.status}`),null;let d=await c.json();return d.document?d:null}catch(a){return console.error("KOSync getProgress failed",a),null}}async updateProgress(a,b,c){if(!this.config.userkey)return!1;let d=this.getDocumentDigest(a);if(!d)return!1;let e={document:d,progress:b,percentage:c,device:this.config.deviceName,device_id:this.config.deviceId};try{let b=await this.request("/syncs/progress",{method:"PUT",body:JSON.stringify(e)});if(!b.ok)return console.error(`KOSync: Failed to update progress for ${a.title}. Status: ${b.status}`),!1;return!0}catch(a){return console.error("KOSync updateProgress failed",a),!1}}getDocumentDigest(a){return"filename"===this.config.checksumMethod&&console.warn("This is not possible anymore, using md5 instead."),a.hash}}var J=a.i(516320),K=a.i(73552),L=a.i(359978);let M=({value:a,onChange:b,options:d,className:e,disabled:f=!1})=>(0,c.jsx)("select",{value:a,onChange:b,className:(0,j.default)("select select-bordered h-12 w-full text-sm focus:outline-none focus:ring-0",e),disabled:f,children:d.map(({value:a,label:b,disabled:d=!1})=>(0,c.jsx)("option",{value:a,disabled:d,children:b},a))}),N=()=>{let a=(0,f.useTranslation)(),{settings:b,setSettings:g,saveSettings:i}=(0,h.useSettingsStore)(),{envConfig:j,appService:k}=(0,e.useEnv)(),[l,m]=(0,d.useState)(!1),[n,o]=(0,d.useState)(b.kosync.serverUrl||""),[p,q]=(0,d.useState)(b.kosync.username||""),[r,s]=(0,d.useState)(""),[t,u]=(0,d.useState)(!1),[v,w]=(0,d.useState)(""),[y,z]=(0,d.useState)(""),[A,B]=(0,d.useState)("");(0,d.useEffect)(()=>{(async()=>{var a;let b="";if(k?.appPlatform==="tauri")b=await (0,F.type)();else{let a=(0,K.getOSPlatform)();"unknown"!==a&&(b=a)}B((a=b)?"macos"===a.toLowerCase()?"macOS":"ios"===a.toLowerCase()?"iOS":a.charAt(0).toUpperCase()+a.slice(1):"")})()},[k]),(0,d.useEffect)(()=>{let a=A?`Readest (${A})`:"Readest";z(b.kosync.deviceName||a)},[b.kosync.deviceName,A]);let C=(0,d.useMemo)(()=>!!b.kosync.userkey,[b.kosync.userkey]),D=(0,d.useCallback)((0,J.debounce)(a=>{let c={...b,koreaderSyncDeviceName:a};g(c),i(j,c)},500),[b,g,i,j]);(0,d.useEffect)(()=>{let a=a=>{m(a.detail.visible),a.detail.visible&&(o(b.kosync.serverUrl||""),q(b.kosync.username||""),s(""),w(""))},c=document.getElementById("kosync_settings_window");return c?.addEventListener("setKOSyncSettingsVisibility",a),()=>{c?.removeEventListener("setKOSyncSettingsVisibility",a)}},[b.kosync.serverUrl,b.kosync.username]);let G=async()=>{u(!0);let c={...b.kosync,serverUrl:n,username:p,userkey:(0,E.md5)(r),deviceName:y,enabled:!0},d=new I(c),e=await d.connect(p,r);if(e.success){let a={...b,kosync:c};g(a),await i(j,a)}else w(""),x.eventDispatcher.dispatch("toast",{message:`${a("Failed to connect")}: ${a(e.message||"Connection error")}`,type:"error"});u(!1),s("")},H=async()=>{let c={...b.kosync,userkey:"",enabled:!1},d={...b,kosync:c};g(d),await i(j,d),q(""),x.eventDispatcher.dispatch("toast",{message:a("Disconnected"),type:"info"})},N=async a=>{let c={...b.kosync,strategy:a.target.value},d={...b,kosync:c};g(d),await i(j,d)},O=async a=>{let c={...b.kosync,checksumMethod:a.target.value},d={...b,kosync:c};g(d),await i(j,d)};return(0,c.jsx)(L.default,{id:"kosync_settings_window",isOpen:l,onClose:()=>m(!1),title:a("KOReader Sync Settings"),boxClassName:"sm:!min-w-[520px] sm:h-auto",children:l&&(0,c.jsx)("div",{className:"mb-4 mt-0 flex flex-col gap-4 p-2 sm:p-4",children:C?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"text-center",children:(0,c.jsx)("p",{className:"text-base-content/80 text-sm",children:a("Sync as {{userDisplayName}}",{userDisplayName:b.kosync.username})})}),(0,c.jsxs)("div",{className:"flex h-14 items-center justify-between",children:[(0,c.jsx)("span",{className:"text-base-content/80",children:a("Sync Server Connected")}),(0,c.jsx)("input",{type:"checkbox",className:"toggle",checked:b.kosync.enabled,onChange:()=>H()})]}),(0,c.jsxs)("div",{className:"form-control w-full",children:[(0,c.jsx)("label",{className:"label py-1",children:(0,c.jsx)("span",{className:"label-text font-medium",children:a("Sync Strategy")})}),(0,c.jsx)(M,{value:b.kosync.strategy,onChange:N,options:[{value:"prompt",label:a("Ask on conflict")},{value:"silent",label:a("Always use latest")},{value:"send",label:a("Send changes only")},{value:"receive",label:a("Receive changes only")}]})]}),(0,c.jsxs)("div",{className:"form-control w-full",children:[(0,c.jsx)("label",{className:"label py-1",children:(0,c.jsx)("span",{className:"label-text font-medium",children:a("Checksum Method")})}),(0,c.jsx)(M,{value:b.kosync.checksumMethod,onChange:O,options:[{value:"binary",label:a("File Content (recommended)")},{value:"filename",label:a("File Name"),disabled:!0}]})]}),(0,c.jsxs)("div",{className:"form-control w-full",children:[(0,c.jsx)("label",{className:"label py-1",children:(0,c.jsx)("span",{className:"label-text font-medium",children:a("Device Name")})}),(0,c.jsx)("input",{type:"text",placeholder:A?`Readest (${A})`:"Readest",className:"input input-bordered h-12 w-full focus:outline-none focus:ring-0",value:y,onChange:a=>{let b=a.target.value;z(b),D(b)}})]})]}):(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("p",{className:"text-base-content/70 text-center text-sm",children:a("Connect to your KOReader Sync server.")}),(0,c.jsxs)("div",{className:"form-control w-full",children:[(0,c.jsx)("label",{className:"label py-1",children:(0,c.jsx)("span",{className:"label-text font-medium",children:a("Server URL")})}),(0,c.jsx)("input",{type:"text",placeholder:"https://koreader.sync.server",className:"input input-bordered h-12 w-full focus:outline-none focus:ring-0",spellCheck:"false",value:n,onChange:a=>o(a.target.value)})]}),(0,c.jsxs)("form",{className:"flex flex-col gap-4",children:[(0,c.jsxs)("div",{className:"form-control w-full",children:[(0,c.jsx)("label",{className:"label py-1",children:(0,c.jsx)("span",{className:"label-text font-medium",children:a("Username")})}),(0,c.jsx)("input",{type:"text",placeholder:a("Your Username"),className:"input input-bordered h-12 w-full focus:outline-none focus:ring-0",spellCheck:"false",value:p,onChange:a=>q(a.target.value),autoComplete:"username"})]}),(0,c.jsxs)("div",{className:"form-control w-full",children:[(0,c.jsx)("label",{className:"label py-1",children:(0,c.jsx)("span",{className:"label-text font-medium",children:a("Password")})}),(0,c.jsx)("input",{type:"password",placeholder:a("Your Password"),className:"input input-bordered h-12 w-full focus:outline-none focus:ring-0",value:r,onChange:a=>s(a.target.value),autoComplete:"current-password"})]})]}),(0,c.jsx)("button",{className:"btn btn-primary mt-2 h-12 min-h-12 w-full",onClick:G,disabled:t||!n||!p||!r,children:t?(0,c.jsx)("span",{className:"loading loading-spinner"}):a("Connect")}),v&&(0,c.jsx)("div",{className:"text-error h-4 text-center text-sm",children:v})]})})})};var O=a.i(23804),P=a.i(303661);let Q=(0,p.create)(()=>({getBookRules:a=>{let{getViewSettings:b}=o.useReaderStore.getState(),c=b(a);return c?.proofreadRules||[]},getGlobalRules:()=>{let{settings:a}=h.useSettingsStore.getState();return a.globalViewSettings.proofreadRules||[]},getMergedRules:a=>{var b,c;let d,{settings:e}=h.useSettingsStore.getState(),{getViewSettings:f}=o.useReaderStore.getState(),g=f(a);return b=e.globalViewSettings.proofreadRules,c=g?.proofreadRules,d=new Map,(b??[]).forEach(a=>d.set(a.id,a)),(c??[]).forEach(a=>d.set(a.id,a)),[...d.values()].sort((a,b)=>(a.order??0)-(b.order??0))},addRule:async(a,b,c)=>{let d={id:(0,K.uniqueId)(),scope:c.scope,pattern:c.pattern,replacement:c.replacement,cfi:c.cfi,sectionHref:c.sectionHref,isRegex:c.isRegex??!1,enabled:c.enabled??!0,caseSensitive:c.caseSensitive??!0,order:c.order??1e3,wholeWord:c.wholeWord??!0,onlyForTTS:c.onlyForTTS??!1};return"library"===c.scope?await V(a,d):await R(a,b,d,c.scope),d},updateRule:async(a,b,c,d)=>{"library"===d.scope?await W(a,c,d):await S(a,b,c,d)},removeRule:async(a,b,c,d)=>{"library"===d?await X(a,c):await T(a,b,c)},toggleRule:async(a,b,c)=>{let{getMergedRules:d}=Q.getState(),e=d(b).find(a=>a.id===c);if(!e)throw Error(`Rule not found: ${c}`);let{updateRule:f}=Q.getState();await f(a,b,c,{enabled:!e.enabled})}}));async function R(a,b,c,d){let{getViewSettings:e}=o.useReaderStore.getState(),f=e(b);if(!f)return;let g=f.proofreadRules||[];if("selection"===d)g.push(c);else{let a=g.find(a=>a.pattern===c.pattern&&a.isRegex===c.isRegex&&"selection"!==a.scope);a?Object.assign(a,{replacement:c.replacement,enabled:c.enabled,order:c.order}):g.push(c)}await U(a,b,g)}async function S(a,b,c,d){let{getViewSettings:e}=o.useReaderStore.getState(),f=e(b);if(!f)throw Error(`No viewSettings found for book: ${b}`);let g=(f.proofreadRules||[]).map(a=>a.id===c?{...a,...d}:a);await U(a,b,g)}async function T(a,b,c){let{getViewSettings:d}=o.useReaderStore.getState(),e=d(b);if(!e)throw Error(`No viewSettings found for book: ${b}`);let f=(e.proofreadRules||[]).filter(a=>a.id!==c);await U(a,b,f)}async function U(a,b,c){let{getViewSettings:d,setViewSettings:e}=o.useReaderStore.getState(),{getConfig:f,saveConfig:g}=P.useBookDataStore.getState(),{settings:i}=h.useSettingsStore.getState(),j=d(b);if(!j)throw Error(`No viewSettings found for book: ${b}`);let k={...j,proofreadRules:c};e(b,k);let l=f(b);l&&await g(a,b,{...l,viewSettings:k,updatedAt:Date.now()},i)}async function V(a,b){let{settings:c}=h.useSettingsStore.getState();if(!c||!c.globalViewSettings)return;let d=c.globalViewSettings.proofreadRules||[],e=d.find(a=>a.pattern===b.pattern&&a.isRegex===b.isRegex);e?(Object.assign(e,{replacement:b.replacement,enabled:b.enabled,order:b.order}),await Y(a,d)):await Y(a,[...d,b])}async function W(a,b,c){let{settings:d}=h.useSettingsStore.getState(),e=(d.globalViewSettings.proofreadRules||[]).map(a=>a.id===b?{...a,...c}:a);await Y(a,e)}async function X(a,b){let{settings:c}=h.useSettingsStore.getState(),d=(c.globalViewSettings.proofreadRules||[]).filter(a=>a.id!==b);await Y(a,d)}async function Y(a,b){let{settings:c,setSettings:d,saveSettings:e}=h.useSettingsStore.getState(),f={...c,globalViewSettings:{...c.globalViewSettings,proofreadRules:b}};d(f),await e(a,f)}let Z="proofread_rules_window",$=({rule:a,scope:b,isEditing:d,editingData:e,onEdit:g,onDelete:h,onSave:i,onCancel:k,onEditChange:l})=>{let m=(0,f.useTranslation)(),{sideBarBookKey:n}=s(),{getView:p}=(0,o.useReaderStore)();return d?(0,c.jsxs)("div",{className:"flex flex-col gap-3 p-3",children:[(0,c.jsxs)("div",{className:"flex flex-col gap-1.5",children:[(0,c.jsx)("label",{className:"text-base-content/70 text-xs font-medium",children:m("Selected text:")}),(0,c.jsx)("input",{className:"input input-sm bg-base-200 text-sm opacity-60",value:e.pattern,disabled:!0})]}),(0,c.jsxs)("div",{className:"flex flex-col gap-1.5",children:[(0,c.jsx)("label",{className:"text-base-content/70 text-xs font-medium",children:m("Replace with:")}),(0,c.jsx)("input",{className:"input input-sm text-sm",value:e.replacement,onChange:a=>l("replacement",a.target.value)})]}),(0,c.jsxs)("div",{className:"mt-1 flex gap-2",children:[(0,c.jsx)("button",{className:"btn btn-primary btn-sm flex-1",onClick:i,children:m("Save")}),(0,c.jsx)("button",{className:"btn btn-sm flex-1",onClick:k,children:m("Cancel")})]})]}):(0,c.jsxs)("div",{className:"relative flex items-start justify-between gap-3 p-3",children:[(0,c.jsxs)("div",{className:"flex min-w-0 flex-1 flex-col gap-1.5",children:[(0,c.jsx)("div",{className:"break-words pe-20 text-base font-medium leading-snug",children:a.pattern}),(0,c.jsxs)("div",{className:"text-base-content/70 break-words text-sm",children:[(0,c.jsx)("span",{className:"text-base-content/80 mr-1.5 text-xs font-medium",children:m("Replace with:")}),(0,c.jsx)("span",{className:"text-base-content/90 text-xs",children:"'"+a.replacement+"'"})]}),(0,c.jsxs)("div",{className:"text-base-content/60 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs",children:[(0,c.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,c.jsx)("span",{className:"text-base-content/50",children:m("Scope:")}),(0,c.jsx)("span",{role:"none",className:(0,j.default)("text-base-content/70 font-medium","selection"===b&&"cursor-pointer text-blue-400 hover:text-blue-500"),onClick:"selection"===b?()=>{n&&a.cfi&&(x.eventDispatcher.dispatch("navigate",{bookKey:n,cfi:a.cfi}),p(n)?.goTo(a.cfi))}:void 0,children:m("selection"===b?"Selection":"book"===b?"Book":"Library")})]}),(0,c.jsx)("span",{className:"text-base-content/30",children:""}),(0,c.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,c.jsx)("span",{className:"text-base-content/50",children:m("Case sensitive:")}),(0,c.jsx)("span",{className:"text-base-content/70 font-medium",children:m(!1!==a.caseSensitive?"Yes":"No")})]}),(0,c.jsx)("span",{className:"text-base-content/30",children:""}),(0,c.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,c.jsx)("span",{className:"text-base-content/50",children:m("Only for TTS:")}),(0,c.jsx)("span",{className:"text-base-content/70 font-medium",children:m(!0===a.onlyForTTS?"Yes":"No")})]})]})]}),(0,c.jsxs)("div",{className:"absolute right-2 top-2 flex items-center gap-1",children:[(0,c.jsx)("button",{className:"btn btn-ghost btn-sm h-8 w-8 p-0",onClick:g,"aria-label":m("Edit"),children:(0,c.jsx)(O.RiEditLine,{className:"h-4 w-4"})}),(0,c.jsx)("button",{className:"btn btn-ghost btn-sm h-8 w-8 p-0",onClick:h,"aria-label":m("Delete"),children:(0,c.jsx)(O.RiDeleteBin7Line,{className:"h-4 w-4"})})]})]})},_=()=>{let a=(0,f.useTranslation)(),{envConfig:b}=(0,e.useEnv)(),{recreateViewer:g}=(0,o.useReaderStore)(),{sideBarBookKey:i}=s(),{updateRule:j,removeRule:k}=Q(),[l,m]=(0,d.useState)(!1),[n,p]=(0,d.useState)({id:null,scope:null,pattern:"",replacement:"",enabled:!0,onlyForTTS:!1}),{singleRules:q,bookRules:r}=(a=>{let{settings:b}=(0,h.useSettingsStore)(),{getViewSettings:c}=(0,o.useReaderStore)(),{getConfig:d}=(0,P.useBookDataStore)(),e=a?c(a):null,f=e?.proofreadRules||[],g=a?d(a):null,i=g?.viewSettings?.proofreadRules||[],j=i.length?i:f,k=j.filter(a=>"selection"===a.scope),l=j.filter(a=>"book"===a.scope),m=b?.globalViewSettings?.proofreadRules||[],n=new Set(m.map(a=>a.id)),p=l.filter(a=>!1!==a.enabled||n.has(a.id));return{singleRules:k,bookRules:p.concat(m.filter(a=>!p.find(b=>b.id===a.id)))}})(i);(0,d.useEffect)(()=>{let a=a=>m(!!a.detail?.visible),b=document.getElementById(Z);return b?.addEventListener("setProofreadRulesVisibility",a),()=>b?.removeEventListener("setProofreadRulesVisibility",a)},[]);let t=()=>{p({id:null,scope:null,pattern:"",replacement:"",enabled:!0,onlyForTTS:!1})},u=async()=>{n.id&&n.scope&&i&&(await j(b,i,n.id,{scope:n.scope,pattern:n.pattern,replacement:n.replacement,enabled:n.enabled,onlyForTTS:n.onlyForTTS}),t(),n.onlyForTTS||g(b,i))},v=async a=>{i&&(await k(b,i,a.id,a.scope),a.onlyForTTS||g(b,i))},w=(a,b,d,e)=>(0,c.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,c.jsx)("h3",{className:"text-base-content/90 text-sm font-semibold",children:d}),0===a.length?(0,c.jsx)("div",{className:"border-base-content/10 bg-base-200/30 rounded-lg border border-dashed p-6 text-center",children:(0,c.jsx)("p",{className:"text-base-content/50 text-sm",children:e})}):(0,c.jsx)("ul",{className:"flex flex-col gap-2",children:a.map(a=>(0,c.jsx)("li",{className:"border-base-content/10 bg-base-100 hover:border-base-content/20 rounded-lg border transition-colors",children:(0,c.jsx)($,{rule:a,scope:"selection"===b?"selection":a.scope,isEditing:n.id===a.id&&n.scope===("selection"===b?"selection":a.scope),editingData:n,onEdit:()=>{p({id:a.id,scope:a.scope,pattern:a.pattern,replacement:a.replacement,enabled:!!a.enabled,onlyForTTS:!!a.onlyForTTS})},onDelete:()=>v(a),onSave:u,onCancel:t,onEditChange:(a,b)=>p({...n,replacement:b})})},a.id))})]});return(0,c.jsx)(L.default,{id:Z,isOpen:l,onClose:()=>m(!1),title:a("Proofread Replacement Rules"),boxClassName:"sm:!min-w-[560px] sm:!max-w-[640px] sm:h-auto",children:l&&(0,c.jsxs)("div",{className:"flex max-h-[70vh] flex-col gap-6 p-4 sm:p-6",children:[w(q,"selection",a("Selected Text Rules"),a("No selected text replacement rules")),w(r,"book",a("Book Specific Rules"),a("No book-level replacement rules")),(0,c.jsx)("div",{className:"p-1"})]})})};var aa=a.i(777470),ab=a.i(199096),ac=a.i(976072),ad=a.i(936630),ae=a.i(444789),af=a.i(631833),ag=a.i(858589),ah=a.i(11491),ai=a.i(593604);async function aj(a,b){try{let c=await fetch(a),d=await c.blob(),e=new Image;e.crossOrigin="anonymous";let f=await fetch(b),g=await f.blob(),h=new Image;return h.crossOrigin="anonymous",new Promise((a,b)=>{let c=!1,f=!1,i=()=>{if(c&&f)try{let c,d,f,g,i=document.createElement("canvas"),j=i.getContext("2d");if(!j)return void b(Error("Failed to get canvas context"));i.width=512,i.height=512;let k=e.width/e.height;k>1?(c=512,d=512/k,f=0,g=(512-d)/2):(d=512,c=512*k,f=(512-c)/2,g=0),j.imageSmoothingEnabled=!0,j.imageSmoothingQuality="high",j.drawImage(e,f,g,c,d),j.drawImage(h,278,320,224,182),i.toBlob(c=>{c?a(c):b(Error("Failed to create blob"))},"image/jpeg",.9)}catch(a){b(Error(`Failed to process cover: ${a}`))}};e.onload=()=>{c=!0,i()},h.onload=()=>{f=!0,i()},e.onerror=()=>b(Error("Failed to load cover image")),h.onerror=()=>b(Error("Failed to load icon image"));let j=URL.createObjectURL(d),k=URL.createObjectURL(g);e.src=j,h.src=k,e.onload=function(){URL.revokeObjectURL(j),c=!0,i()},h.onload=function(){URL.revokeObjectURL(k),f=!0,i()}})}catch(a){throw console.error("Error processing Discord cover:",a),a}}async function ak(a,b={}){let{targetWidth:c=256,format:d="image/jpeg",quality:e=.85}=b;try{let b=await fetch(a);if(!b.ok)throw Error(`Failed to fetch image: ${b.status} ${b.statusText}`);let f=await b.blob(),g=new Image;return g.crossOrigin="anonymous",new Promise((a,b)=>{g.onload=()=>{try{let f=g.height/g.width,h=Math.round(c*f),i=document.createElement("canvas"),j=i.getContext("2d");if(!j)return void b(Error("Failed to get canvas context"));i.width=c,i.height=h,j.imageSmoothingEnabled=!0,j.imageSmoothingQuality="high",j.drawImage(g,0,0,c,h);let k=i.toDataURL(d,e);a(k)}catch(a){b(Error(`Failed to scale image: ${a}`))}},g.onerror=()=>b(Error("Failed to load image for scaling"));let h=URL.createObjectURL(f);g.src=h;let i=g.onload,j=g.onerror;g.onload=function(a){URL.revokeObjectURL(h),i&&i.call(this,a)},g.onerror=function(a){URL.revokeObjectURL(h),j&&j.call(this,a)}})}catch(a){throw console.error("Error fetching and encoding image:",a),a}}let al=new Map,am=async(a,b)=>{let c=al.get(a.hash);if(c){if(!(Date.now()-c.timestamp>36e5))return c.url??void 0;c.url||al.delete(a.hash)}try{let c=(0,ai.getCoverFilename)(a);if(!await b.exists(c,"Books"))return void al.set(a.hash,{url:null,timestamp:Date.now()});let d=await b.resolveFilePath(c,"Books"),e=await b.getImageURL(d);await aj(e,"/icon-tiny.png"),console.log("Processed Discord cover for book:",a.title),al.set(a.hash,{url:null,timestamp:Date.now()});return}catch(b){console.warn("Failed to process cover for Discord:",b),al.set(a.hash,{url:null,timestamp:Date.now()});return}},an=async(a,b,c)=>{if(c?.isDesktopApp)try{let d=await am(a,c),e={bookHash:a.hash,title:a.title,author:a.author||null,coverUrl:d||null,sessionStart:b};await (0,ah.invoke)("update_book_presence",{presence:e})}catch(a){console.warn("Failed to update Discord presence:",a)}},ao=async a=>{if(a?.isDesktopApp)try{await (0,ah.invoke)("clear_book_presence")}catch(a){console.warn("Failed to clear Discord presence:",a)}};var ap=a.i(657123);a.i(965870);var aq=a.i(582823);let ar=(0,p.create)((a,b)=>({parallelViews:[],setParallel:b=>{a(a=>{let c,d=[...new Set(b.filter(a=>""!==a.trim()))];if(d.length<2)return a;let e=[...a.parallelViews],f=e.filter(a=>d.some(b=>a.has(b)));return 0===f.length?(c=new Set(d),e.push(c)):1===f.length?(c=f[0],d.forEach(a=>c.add(a))):(c=f[0],f.slice(1).forEach(a=>{a.forEach(a=>c.add(a));let b=e.indexOf(a);b>-1&&e.splice(b,1)}),d.forEach(a=>c.add(a))),console.log("Set parallel groups:",e),{parallelViews:e}})},unsetParallel:b=>{a(a=>{let c=[...new Set(b.filter(a=>""!==a.trim()))];if(0===c.length)return a;let d=[...a.parallelViews];return d.filter(a=>c.some(b=>a.has(b))).forEach(a=>{if(c.forEach(b=>a.delete(b)),a.size<=1){let b=d.indexOf(a);b>-1&&d.splice(b,1)}}),console.log("Unset parallel groups:",d),{parallelViews:d}})},areParallels(a,c){let{parallelViews:d}=b();return d.some(b=>b.has(a)&&b.has(c))},getParallels(a){let{parallelViews:c}=b();return c.find(b=>b.has(a))||null}})),as=()=>{let a=(0,k.useRouter)(),b=(0,k.useSearchParams)(),{envConfig:c}=(0,e.useEnv)(),{bookKeys:f}=(0,o.useReaderStore)(),{setBookKeys:g,initViewState:h}=(0,o.useReaderStore)(),{sideBarBookKey:i,setSideBarBookKey:j}=s(),[l,m]=(0,d.useState)(!1),{setParallel:n}=ar();(0,d.useEffect)(()=>{if(l){let c=f.map(a=>a.split("-")[0]);c&&(0,ag.navigateToReader)(a,c,b?.toString()||"",{scroll:!1}),m(!1)}},[f,l]);let p=(a,b,d)=>{let e=`${a}-${(0,K.uniqueId)()}`;h(c,a,e,b),f.includes(e)||g([...f,e]),d&&n([i,e]),j(e),m(!0)};return{bookKeys:f,appendBook:p,dismissBook:a=>{g(f.filter(b=>b!==a)),m(!0)},getNextBookKey:a=>{let b=(f.findIndex(b=>b===a)+1)%f.length;return f[b]},openParallelView:a=>{p(a,i?.split("-")[0]!=a,!0)}}};var at=a.i(224499);let au=(a,b)=>!!a&&!!b&&a.book.rendition?.layout==="pre-paginated"&&(b.zoomLevel>100||"fit-page"!==b.zoomMode),av=(a,b,c,d="page",e=50)=>{var f;if(!a||!b)return;let g=a.renderer;if("rtl"===a.book.dir&&(c="left"===(f=c)?"right":"right"===f?"left":f),g.scrolled){let{size:e}=g,f=b.showHeader&&b.showBarsOnScroll,h=b.showFooter&&b.showBarsOnScroll,i=e-b.scrollingOverlap-44*!!f-44*!!h;return"section"!==d?"left"===c||"up"===c?a.prev(i):a.next(i):"left"===c||"up"===c?a.renderer.prevSection?.():a.renderer.nextSection?.()}if("pan"===d&&au(a,b))return a&&b&&au(a,b)&&a.isOverflowX()&&("left"===c||"right"===c)?a.pan("left"===c?-e:e,0):a&&b&&au(a,b)&&a.isOverflowY()&&("up"===c||"down"===c)?a.pan(0,"up"===c?-e:e):"left"===c||"up"===c?a.prev():a.next();return"section"!==d?"left"===c||"up"===c?a.prev():a.next():"left"===c||"up"===c?a.renderer.prevSection?.():a.renderer.nextSection?.()};var aw=a.i(192238),ax=a.i(963508),ay=a.i(415838),az=a.i(383729),aA=a.i(804638),aB=a.i(883639),aC=a.i(995038);function aD(a){return(0,aC.GenIcon)({tag:"svg",attr:{viewBox:"0 0 512 512"},child:[{tag:"path",attr:{d:"M169 57v430h78V57h-78zM25 105v190h46V105H25zm158 23h18v320h-18V128zm128.725 7.69l-45.276 8.124 61.825 344.497 45.276-8.124-61.825-344.497zM89 153v270h62V153H89zm281.502 28.68l-27.594 11.773 5.494 12.877 27.594-11.773-5.494-12.877zm12.56 29.433l-27.597 11.772 5.494 12.877 27.593-11.772-5.492-12.877zm12.555 29.434l-27.594 11.77 99.674 233.628 27.594-11.773-99.673-233.625zM25 313v30h46v-30H25zm190 7h18v128h-18V320zM25 361v126h46V361H25zm64 80v46h62v-46H89z"},child:[]}]})(a)}var aE=a.i(784782),aF=a.i(205558),aG=a.i(191601),aH=a.i(268120),aI=a.i(966027),aJ=a.i(499527),aK=a.i(863052),aL=a.i(427617),aM=a.i(316282),aN=a.i(926955),aO=a.i(627910),aP=a.i(199099);let aQ=({menuClassName:a,setIsDropdownOpen:b})=>{let g=(0,f.useTranslation)(),i=(0,k.useRouter)(),{envConfig:l,appService:m}=(0,e.useEnv)(),{user:n}=(0,aK.useAuth)(),{settings:p}=(0,h.useSettingsStore)(),{bookKeys:q,recreateViewer:r,getViewSettings:t,setViewSettings:u}=(0,o.useReaderStore)(),{getVisibleLibrary:v}=(0,aL.useLibraryStore)(),{openParallelView:w}=as(),{sideBarBookKey:y}=s(),{parallelViews:A,setParallel:B,unsetParallel:D}=ar(),E=t(y),[F,G]=d.default.useState(E?.sortedTOC||!1),H=()=>{B(q),b?.(!1)},I=()=>{D(q),b?.(!1)};return(0,c.jsxs)(aP.default,{className:(0,j.default)("book-menu dropdown-content z-20 shadow-2xl",a),onCancel:()=>b?.(!1),children:[(0,c.jsx)(aO.default,{label:g("Parallel Read"),buttonClass:q.length>1?"lg:tooltip lg:tooltip-bottom":"",tooltip:A.length>0?g("Disable"):q.length>1?g("Enable"):"",Icon:A.length>0&&q.length>1?aF.MdCheck:void 0,onClick:A.length>0?I:q.length>1?H:void 0,children:(0,c.jsx)("ul",{className:"max-h-60 overflow-y-auto",children:v().filter(a=>!aM.FIXED_LAYOUT_FORMATS.has(a.format)).filter(a=>!!a.downloadedAt).slice(0,20).map(a=>(0,c.jsx)(aO.default,{Icon:(0,c.jsx)(aJ.default,{src:a.coverImageUrl,alt:a.title,width:56,height:80,className:"aspect-auto max-h-8 max-w-4 rounded-sm shadow-md",onError:a=>{a.target.style.display="none"}}),label:a.title,labelClass:"max-w-36",onClick:()=>{w(a.hash),b?.(!1)}},a.hash))})}),q.length>1&&(A.length>0?(0,c.jsx)(aO.default,{label:g("Exit Parallel Read"),onClick:I}):(0,c.jsx)(aO.default,{label:g("Enter Parallel Read"),onClick:H})),(0,c.jsx)("hr",{className:"border-base-200 my-1"}),(0,c.jsx)(aO.default,{label:g("KOReader Sync"),onClick:()=>{let a=document.getElementById("kosync_settings_window");if(a){let b=new CustomEvent("setKOSyncSettingsVisibility",{detail:{visible:!0}});a.dispatchEvent(b)}b?.(!1)}}),p.kosync.enabled&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(aO.default,{label:g("Push Progress"),onClick:()=>{x.eventDispatcher.dispatch("push-kosync",{bookKey:y}),b?.(!1)}}),(0,c.jsx)(aO.default,{label:g("Pull Progress"),onClick:()=>{x.eventDispatcher.dispatch("pull-kosync",{bookKey:y}),b?.(!1)}})]}),m?.isDesktopApp&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("hr",{className:"border-base-200 my-1"}),(0,c.jsx)(aO.default,{label:g("Show on Discord"),tooltip:g("Display what I'm reading on Discord"),toggled:p.discordRichPresenceEnabled,onClick:()=>{let a=!p.discordRichPresenceEnabled;(0,aN.saveSysSettings)(l,"discordRichPresenceEnabled",a),b?.(!1),a&&!n&&(0,ag.navigateToLogin)(i)}})]}),(0,c.jsx)("hr",{className:"border-base-200 my-1"}),(0,c.jsx)(aO.default,{label:g("Proofread"),onClick:()=>{let a;(a=document.getElementById(Z))&&a.dispatchEvent(new CustomEvent("setProofreadRulesVisibility",{detail:{visible:!0}})),b?.(!1)}}),(0,c.jsx)("hr",{className:"border-base-200 my-1"}),(0,c.jsx)(aO.default,{label:g("Export Annotations"),onClick:()=>{x.eventDispatcher.dispatch("export-annotations",{bookKey:y}),b?.(!1)}}),(0,c.jsx)(aO.default,{label:g("Sort TOC by Page"),Icon:F?aF.MdCheck:void 0,onClick:()=>{if(G(a=>!a),b?.(!1),y){let a=t(y);a.sortedTOC=!F,u(y,a),r(l,y)}}}),(0,c.jsx)(aO.default,{label:g("Reload Page"),shortcut:"Shift+R",onClick:()=>{window.location.reload(),b?.(!1)}}),(0,c.jsx)("hr",{className:"border-base-200 my-1"}),(0,z.isWebAppPlatform)()&&(0,c.jsx)(aO.default,{label:g("Download Readest"),onClick:()=>{window.open(ap.DOWNLOAD_READEST_URL,"_blank"),b?.(!1)}}),(0,c.jsx)(aO.default,{label:g("About Readest"),onClick:()=>{(0,C.setAboutDialogVisible)(!0),b?.(!1)}})]})},aR=({isPinned:a,isSearchBarVisible:b,onGoToLibrary:d,onClose:e,onTogglePin:g,onToggleSearchBar:h})=>{let i=(0,f.useTranslation)(),{isTrafficLightVisible:k}=(0,aG.useTrafficLight)(),l=(0,aH.useResponsiveSize)(14),m=(0,aH.useResponsiveSize)(18),n=(0,aH.useResponsiveSize)(22);return(0,c.jsxs)("div",{className:(0,j.default)("sidebar-header flex h-11 items-center justify-between pe-2",k?"ps-1.5 sm:ps-20":"ps-1.5"),dir:"ltr",children:[(0,c.jsxs)("div",{className:"flex items-center gap-x-8",children:[(0,c.jsx)("button",{title:i("Close"),onClick:e,className:"btn btn-ghost btn-circle flex h-6 min-h-6 w-6 hover:bg-transparent sm:hidden",children:(0,c.jsx)(aF.MdArrowBackIosNew,{size:n})}),(0,c.jsx)("button",{title:i("Go to Library"),className:"btn btn-ghost hidden h-8 min-h-8 w-8 p-0 sm:flex",onClick:d,children:(0,c.jsx)(aD,{className:"fill-base-content"})})]}),(0,c.jsxs)("div",{className:"flex min-w-24 max-w-32 items-center justify-between sm:size-[70%]",children:[(0,c.jsx)("button",{title:i(b?"Hide Search Bar":"Show Search Bar"),onClick:h,className:(0,j.default)("btn btn-ghost left-0 h-8 min-h-8 w-8 p-0",b?"bg-base-300":""),children:(0,c.jsx)(aE.FiSearch,{size:m,className:"text-base-content"})}),(0,c.jsx)(aI.default,{label:i("Book Menu"),className:(0,j.default)(window.innerWidth<640&&"dropdown-end","dropdown-bottom flex justify-center"),menuClassName:window.innerWidth<640?"no-triangle mt-1":"dropdown-center mt-1",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0",toggleButton:(0,c.jsx)(aF.MdOutlineMenu,{className:"fill-base-content"}),children:(0,c.jsx)(aQ,{})}),(0,c.jsx)("div",{className:"right-0 hidden h-8 w-8 items-center justify-center sm:flex",children:(0,c.jsx)("button",{title:i(a?"Unpin Sidebar":"Pin Sidebar"),onClick:g,className:(0,j.default)("sidebar-pin-btn btn btn-ghost btn-circle hidden h-6 min-h-6 w-6 sm:flex",a?"bg-base-300":"bg-base-300/65"),children:a?(0,c.jsx)(aF.MdPushPin,{size:l}):(0,c.jsx)(aF.MdOutlinePushPin,{size:l})})})]})]})};var aS=a.i(133242),aT=a.i(305092),aU=a.i(754873),aV=a.i(394712);function aW(a,b,c=!1,e="translation-target-block"){let{getViewSettings:f,getProgress:g}=(0,o.useReaderStore)(),h=f(a),i=g(a),j=(0,d.useRef)(h?.translationEnabled),[k,l]=(0,d.useState)(h?.translationProvider),[m,n]=(0,d.useState)(h?.translateTargetLang),p=(0,d.useRef)(h?.showTranslateSource),{translate:q}=(0,aV.useTranslator)({provider:k,targetLang:m||(0,K.getLocale)()}),r=(0,d.useRef)(q),s=(0,d.useRef)(null),t=(0,d.useRef)([]),u=(0,d.useRef)([]);(0,d.useEffect)(()=>{r.current=q},[q]);let v=()=>{if(!b||!j.current)return;let a=w();s.current=a;let c=((a,b=[])=>{let c=[],d=(a,e=0)=>{if(!(e>15))for(let f of(a instanceof HTMLElement&&a.shadowRoot&&d(a.shadowRoot,e+1),"children"in a?Array.from(a.children):[])){if("STYLE"===f.tagName||"LINK"===f.tagName||b.includes(f.tagName.toLowerCase()))continue;if(f.shadowRoot&&d(f.shadowRoot,e+1),"IFRAME"===f.tagName){let a=f.contentDocument||f.contentWindow?.document;a&&a.body&&d(a.body,e+1)}let a=f.childNodes&&Array.from(f.childNodes).some(a=>!!(a.nodeType===Node.TEXT_NODE&&a.textContent?.trim()||a.nodeType===Node.ELEMENT_NODE&&"SPAN"===a.tagName&&a.textContent?.trim()));0===f.children.length&&f.textContent?.trim()||a?c.push(f):f.children.length>0&&d(f,e+1)}};return d(a),c})(b,["pre","code","math"]);console.log("Observing text nodes for translation:",c.length),u.current=c,c.forEach(b=>a.observe(b))},w=()=>new IntersectionObserver(a=>{let b=null,c=null;for(let d of a){if(!d.isIntersecting){c||(b=d.target);continue}let a=d.target;y(a),c=a}b&&y(b),c&&x(c,2)},{rootMargin:"1280px",threshold:0}),x=(a,b)=>{if(!u.current||b<=0)return;let c=u.current.indexOf(a);-1===c||u.current.slice(c+1,c+1+b).forEach((a,b)=>{setTimeout(()=>{y(a)},500*b)})},y=async a=>{if(!j.current)return;let b=a.textContent?.replaceAll("\n","").trim();if(!b||a.classList.contains("translation-target"))return;let d=a=>{if(Array.from(a.childNodes).some(a=>a.nodeType===Node.TEXT_NODE&&a.textContent?.trim()!=="")){a.classList.add("translation-source");let b=Array.from(a.childNodes).filter(a=>a.nodeType===Node.TEXT_NODE&&a.textContent?.trim()!=="");a.hasAttribute("original-text-stored")||(a.setAttribute("original-text-nodes",JSON.stringify(b.map(a=>a.textContent))),a.setAttribute("original-text-stored","true"))}if(a.classList.contains("translation-source")){let b=Array.from(a.childNodes).filter(a=>a.nodeType===Node.TEXT_NODE);if(p.current){let c=JSON.parse(a.getAttribute("original-text-nodes")||"[]");b.forEach((a,b)=>{void 0!==c[b]&&(a.textContent=c[b])})}else b.forEach(a=>{a.textContent=""})}for(let b of Array.from(a.childNodes))b.nodeType===Node.ELEMENT_NODE&&(b.classList.contains("translation-target")||d(b))};d(a);try{let d=(await r.current([b]))[0];if(!d||b===d)return;let f=document.createElement("font");f.className=`translation-target ${!j.current?"hidden":""}`,f.setAttribute("translation-element-mark","1"),f.setAttribute("lang",m||(0,K.getLocale)()),c&&f.appendChild(document.createElement("br"));let g=document.createElement("font");g.className=`translation-target ${e}`;let h=document.createElement("font");if(h.className="translation-target target-inner target-inner-theme-none",h.textContent=d,g.appendChild(h),f.appendChild(g),a.querySelector(".translation-target"))return;a.appendChild(f),t.current.push(a)}catch(a){console.warn("Translation failed:",a)}},z=(0,d.useCallback)((0,J.debounce)(a=>{let b=u.current;if(0===b.length)return void console.warn("No text nodes available for translation.");let{startIndex:c,endIndex:d}=((a,b)=>{let c=a.startContainer,d=a.endContainer,e=-1,f=-1;for(let a=0;a<b.length;a++){let g=b[a];(g===c||g.contains(c))&&-1===e&&(e=a),(g===d||g.contains(d))&&(f=a)}return -1!==e&&-1===f&&(f=e),{startIndex:e,endIndex:f}})(a,b);if(-1===c)return void console.log("Range not found in text nodes");let e=Math.max(0,c-2),f=Math.min(b.length-1,d+5);for(let a=e;a<=f;a++){let c=b[a];c&&y(c)}},500),[y]);(0,d.useEffect)(()=>{if(j.current&&i){let{range:a}=i;z(a)}},[i]),(0,d.useEffect)(()=>{if(!h)return;let a=j.current!==h.translationEnabled,c=k!==h.translationProvider,d=m!==h.translateTargetLang,e=p.current!==h.showTranslateSource;if(a&&(j.current=h.translationEnabled),c&&l(h.translationProvider),d&&n(h.translateTargetLang),e&&(p.current=h.showTranslateSource),a){var f;f=h.translationEnabled,t.current.forEach(a=>{a.querySelectorAll(".translation-target").forEach(a=>{f?a.classList.remove("hidden"):a.classList.add("hidden")})}),j.current&&v()}else{let a;(c||d||e)&&(t.current.forEach(a=>{a.querySelectorAll(".translation-target").forEach(a=>a.remove())}),t.current=[],h?.translationEnabled&&b&&(a=w(),s.current?.disconnect(),s.current=a,u.current.forEach(b=>a.observe(b))))}},[a,h,k,m]),(0,d.useEffect)(()=>{if(b&&j.current)return"renderer"in b?b.addEventListener("load",v):v(),()=>{"renderer"in b&&b.removeEventListener("load",v),s.current?.disconnect(),t.current=[]}},[b])}let aX=d.default.memo(({flatItem:a,itemSize:b,isActive:e,onToggleExpand:f,onItemClick:g})=>{let h,{item:i,depth:k}=a,l=(0,d.useCallback)(a=>{a.preventDefault(),a.stopPropagation(),f(i)},[i,f]),m=(0,d.useCallback)(a=>{a.preventDefault(),g(i)},[i,g]);return(0,c.jsxs)("div",{tabIndex:0,role:"treeitem",onClick:i.href?m:void 0,onKeyDown:i.href?a=>"Enter"===a.key&&m(a):void 0,"aria-expanded":a.isExpanded?"true":"false","aria-selected":e?"true":"false","data-href":i.href?(0,K.getContentMd5)(i.href):void 0,className:(0,j.default)("flex w-full cursor-pointer items-center rounded-md py-4 sm:py-2",e?"text-bold-in-eink sm:bg-base-300/65 sm:hover:bg-base-300/75 sm:text-base-content text-blue-500":"sm:hover:bg-base-300/75"),style:{height:b?`${b}px`:"auto",paddingInlineStart:`${(k+1)*12}px`},children:[i.subitems&&(0,c.jsx)("button",{onClick:l,onKeyDown:a=>{a.stopPropagation()},className:"inline-block cursor-pointer",style:{padding:"12px",margin:"-12px"},children:(h=a.isExpanded||!1,(0,c.jsx)("svg",{viewBox:"0 0 8 10",width:"8",height:"10",className:(0,j.default)("text-base-content transform transition-transform",h?"rotate-90":"rotate-0"),style:{transformOrigin:"center"},fill:"currentColor",children:(0,c.jsx)("polygon",{points:"0 0, 8 5, 0 10"})}))}),(0,c.jsx)("div",{className:"ms-2 truncate text-ellipsis",style:{maxWidth:"calc(100% - 24px)",whiteSpace:"nowrap",textOverflow:"ellipsis"},children:i.label}),i.location&&(0,c.jsx)("div",{className:"text-base-content/50 ms-auto ps-1 text-xs sm:pe-1",children:i.location.current+1})]})});aX.displayName="TOCItemView";let aY=({bookKey:a,flatItem:b,itemSize:d,activeHref:e,onToggleExpand:f,onItemClick:g})=>{let h=e===b.item.href;return(0,c.jsx)("div",{className:(0,j.default)("border-base-300 w-full border-b sm:border-none","pe-4 ps-2 pt-[1px] sm:pe-2"),title:b.item.label||"",children:(0,c.jsx)(aX,{bookKey:a,flatItem:b,itemSize:d,isActive:h,onToggleExpand:f,onItemClick:g})})},aZ=({index:a,style:b,data:d})=>{let{flatItems:e,bookKey:f,activeHref:g,itemSize:h,onToggleExpand:i,onItemClick:j}=d,k=e[a];return(0,c.jsx)("div",{style:b,title:k.item.label||"",children:(0,c.jsx)(aY,{bookKey:f,flatItem:k,itemSize:h-1,activeHref:g,onToggleExpand:i,onItemClick:j})})},a$=a=>{let b=a.href||"";return`toc-item-${a.id}-${b}`},a_=({bookKey:a,toc:b,sections:f})=>{let{appService:g}=(0,e.useEnv)(),{getView:h,getProgress:i,getViewSettings:j}=(0,o.useReaderStore)(),{sideBarBookKey:k,isSideBarVisible:l}=s(),m=j(a),n=i(a),[p,q]=(0,d.useState)(new Set),[r,t]=(0,d.useState)(400),u=(0,d.useRef)(!1),v=(0,d.useRef)(0),w=(0,d.useRef)(null),y=(0,d.useRef)(null),z=(0,d.useRef)(null),A=(0,d.useRef)(null),[B]=(0,aS.useOverlayScrollbars)({defer:!0,options:{scrollbars:{autoHide:"scroll"},showNativeOverlaidScrollbars:!1},events:{initialized(a){let{viewport:b}=a.elements();b.style.overflowX="var(--os-viewport-overflow-x)",b.style.overflowY="var(--os-viewport-overflow-y)"}}}),C=(0,d.useCallback)(()=>!!u.current&&(!(Date.now()-v.current>=1e4)||(u.current=!1,!1)),[]),D=(0,d.useCallback)(()=>{setTimeout(()=>{u.current=!0,v.current=Date.now()},500)},[]);(0,d.useEffect)(()=>{let{current:a}=w,{current:b}=y;if(a&&b)return B({target:a,elements:{viewport:b}}),b.addEventListener("scroll",D),()=>{b.removeEventListener("scroll",D)}},[B,D]),aW(a,w.current||A.current,!1,"translation-target-toc"),(0,d.useEffect)(()=>{let a=()=>{if(w.current){let a=w.current.getBoundingClientRect(),b=w.current.closest(".scroll-container");if(b){let c=b.getBoundingClientRect();t(Math.max(400,c.height-(a.top-c.top)))}}};a(),window.addEventListener("resize",a);let b=null;if(w.current){let c=w.current.closest(".scroll-container");c&&(b=new ResizeObserver(a)).observe(c)}let c=A.current,d=null;return c&&(d=c.parentElement)&&d.addEventListener("scroll",D),()=>{window.removeEventListener("resize",a),b&&b.disconnect(),d&&d.removeEventListener("scroll",D)}},[p,D]);let E=(0,d.useMemo)(()=>n?.sectionHref||null,[n?.sectionHref]),F=(0,d.useMemo)(()=>{let a=(b,c=0)=>{let d=[];return b.forEach((b,e)=>{let f=p.has(a$(b));d.push({item:b,depth:c,index:e,isExpanded:f}),b.subitems&&f&&d.push(...a(b.subitems,c+1))}),d};return a(b)},[b,p]),G=(0,d.useMemo)(()=>F.findIndex(a=>a.item.href===E),[F,E]),H=(0,d.useCallback)(a=>{let b=a$(a);D(),q(a=>{let c=new Set(a);return c.has(b)?c.delete(b):c.add(b),c})},[D]),I=(0,d.useCallback)(b=>{x.eventDispatcher.dispatch("navigate",{bookKey:a,href:b.href}),b.href&&h(a)?.goTo(b.href)},[a,h]),J=(0,d.useCallback)((a,b)=>{q(new Set((0,aU.findParentPath)(a,b).map(a=>a$(a)).filter(Boolean)))},[]),L=(0,d.useCallback)(()=>{if(E){if(z.current){let a=F.findIndex(a=>a.item.href===E);-1!==a&&z.current.scrollToItem(a,"center")}if(A.current){let a=E?(0,K.getContentMd5)(E):"",b=A.current?.querySelector(`[data-href="${a}"]`);if(b){let a=A.current.parentElement.getBoundingClientRect(),c=b.getBoundingClientRect();c.top>=a.top&&c.bottom<=a.bottom||b.scrollIntoView({behavior:"instant",block:"center"}),b.setAttribute("aria-current","page")}}}},[F,E]),M=(0,d.useMemo)(()=>window.innerWidth>=640&&!m?.translationEnabled?37:57,[m?.translationEnabled]),N=(0,d.useMemo)(()=>({flatItems:F,itemSize:M,bookKey:a,activeHref:E,onToggleExpand:H,onItemClick:I}),[F,M,a,E,H,I]);return(0,d.useEffect)(()=>{if(!n||!l||k!==a||C())return;let{sectionHref:c}=n;c&&J(b,c)},[b,n,k,l,a,J,C]),(0,d.useEffect)(()=>{!C()&&F.length>0&&setTimeout(L,g?.isAndroidApp?300:100)},[n,L,C]),f&&f.length>256?(0,c.jsx)("div",{className:"virtual-list mt-2 rounded","data-overlayscrollbars-initialize":"",ref:w,children:(0,c.jsx)(aT.FixedSizeList,{ref:z,outerRef:y,width:"100%",height:r,itemCount:F.length,itemSize:M,itemData:N,overscanCount:20,initialScrollOffset:g?.isAndroidApp&&G>=0?Math.max(0,G*M-r/2):void 0,children:aZ})}):(0,c.jsx)("div",{className:"static-list mt-2 rounded",ref:A,children:F.map((b,d)=>(0,c.jsx)(aY,{bookKey:a,flatItem:b,activeHref:E,onToggleExpand:H,onItemClick:I},`static-row-${d}`))})};var a0=a.i(621823),a1=a.i(235724);function a2(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var a3=a2(),a4={exec:()=>null};function a5(a,b=""){let c="string"==typeof a?a:a.source,d={replace:(a,b)=>{let e="string"==typeof b?b:b.source;return e=e.replace(a6.caret,"$1"),c=c.replace(a,e),d},getRegex:()=>new RegExp(c,b)};return d}var a6={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:a=>RegExp(`^( {0,3}${a})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:a=>RegExp(`^ {0,${Math.min(3,a-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:a=>RegExp(`^ {0,${Math.min(3,a-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:a=>RegExp(`^ {0,${Math.min(3,a-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:a=>RegExp(`^ {0,${Math.min(3,a-1)}}#`),htmlBeginRegex:a=>RegExp(`^ {0,${Math.min(3,a-1)}}<(?:[a-z].*>|!--)`,"i")},a7=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,a8=/(?:[*+-]|\d{1,9}[.)])/,a9=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,ba=a5(a9).replace(/bull/g,a8).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),bb=a5(a9).replace(/bull/g,a8).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),bc=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,bd=/(?!\s*\])(?:\\.|[^\[\]\\])+/,be=a5(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",bd).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),bf=a5(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,a8).getRegex(),bg="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",bh=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,bi=a5("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",bh).replace("tag",bg).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),bj=a5(bc).replace("hr",a7).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",bg).getRegex(),bk={blockquote:a5(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",bj).getRegex(),code:/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,def:be,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,hr:a7,html:bi,lheading:ba,list:bf,newline:/^(?:[ \t]*(?:\n|$))+/,paragraph:bj,table:a4,text:/^[^\n]+/},bl=a5("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",a7).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",bg).getRegex(),bm={...bk,lheading:bb,table:bl,paragraph:a5(bc).replace("hr",a7).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",bl).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",bg).getRegex()},bn={...bk,html:a5(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",bh).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:a4,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:a5(bc).replace("hr",a7).replace("heading"," *#{1,6} *[^\n]").replace("lheading",ba).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},bo=/^( {2,}|\\)\n(?!\s*$)/,bp=/[\p{P}\p{S}]/u,bq=/[\s\p{P}\p{S}]/u,br=/[^\s\p{P}\p{S}]/u,bs=a5(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,bq).getRegex(),bt=/(?!~)[\p{P}\p{S}]/u,bu=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,bv=a5(bu,"u").replace(/punct/g,bp).getRegex(),bw=a5(bu,"u").replace(/punct/g,bt).getRegex(),bx="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",by=a5(bx,"gu").replace(/notPunctSpace/g,br).replace(/punctSpace/g,bq).replace(/punct/g,bp).getRegex(),bz=a5(bx,"gu").replace(/notPunctSpace/g,/(?:[^\s\p{P}\p{S}]|~)/u).replace(/punctSpace/g,/(?!~)[\s\p{P}\p{S}]/u).replace(/punct/g,bt).getRegex(),bA=a5("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,br).replace(/punctSpace/g,bq).replace(/punct/g,bp).getRegex(),bB=a5(/\\(punct)/,"gu").replace(/punct/g,bp).getRegex(),bC=a5(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),bD=a5(bh).replace("(?:-->|$)","-->").getRegex(),bE=a5("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",bD).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),bF=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,bG=a5(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",bF).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),bH=a5(/^!?\[(label)\]\[(ref)\]/).replace("label",bF).replace("ref",bd).getRegex(),bI=a5(/^!?\[(ref)\](?:\[\])?/).replace("ref",bd).getRegex(),bJ=a5("reflink|nolink(?!\\()","g").replace("reflink",bH).replace("nolink",bI).getRegex(),bK={_backpedal:a4,anyPunctuation:bB,autolink:bC,blockSkip:/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,br:bo,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,del:a4,emStrongLDelim:bv,emStrongRDelimAst:by,emStrongRDelimUnd:bA,escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,link:bG,nolink:bI,punctuation:bs,reflink:bH,reflinkSearch:bJ,tag:bE,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,url:a4},bL={...bK,link:a5(/^!?\[(label)\]\((.*?)\)/).replace("label",bF).getRegex(),reflink:a5(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",bF).getRegex()},bM={...bK,emStrongRDelimAst:bz,emStrongLDelim:bw,url:a5(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},bN={...bM,br:a5(bo).replace("{2,}","*").getRegex(),text:a5(bM.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},bO={normal:bk,gfm:bm,pedantic:bn},bP={normal:bK,gfm:bM,breaks:bN,pedantic:bL},bQ={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},bR=a=>bQ[a];function bS(a,b){if(b){if(a6.escapeTest.test(a))return a.replace(a6.escapeReplace,bR)}else if(a6.escapeTestNoEncode.test(a))return a.replace(a6.escapeReplaceNoEncode,bR);return a}function bT(a){try{a=encodeURI(a).replace(a6.percentDecode,"%")}catch{return null}return a}function bU(a,b){let c=a.replace(a6.findPipe,(a,b,c)=>{let d=!1,e=b;for(;--e>=0&&"\\"===c[e];)d=!d;return d?"|":" |"}).split(a6.splitPipe),d=0;if(c[0].trim()||c.shift(),c.length>0&&!c.at(-1)?.trim()&&c.pop(),b)if(c.length>b)c.splice(b);else for(;c.length<b;)c.push("");for(;d<c.length;d++)c[d]=c[d].trim().replace(a6.slashPipe,"|");return c}function bV(a,b,c){let d=a.length;if(0===d)return"";let e=0;for(;e<d;){let f=a.charAt(d-e-1);if(f!==b||c)if(f!==b&&c)e++;else break;else e++}return a.slice(0,d-e)}function bW(a,b,c,d,e){let f=b.href,g=b.title||null,h=a[1].replace(e.other.outputLinkReplace,"$1");d.state.inLink=!0;let i={type:"!"===a[0].charAt(0)?"image":"link",raw:c,href:f,title:g,text:h,tokens:d.inlineTokens(h)};return d.state.inLink=!1,i}var bX=class{options;rules;lexer;constructor(a){this.options=a||a3}space(a){let b=this.rules.block.newline.exec(a);if(b&&b[0].length>0)return{type:"space",raw:b[0]}}code(a){let b=this.rules.block.code.exec(a);if(b){let a=b[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:b[0],codeBlockStyle:"indented",text:this.options.pedantic?a:bV(a,"\n")}}}fences(a){let b=this.rules.block.fences.exec(a);if(b){let a=b[0],c=function(a,b,c){let d=a.match(c.other.indentCodeCompensation);if(null===d)return b;let e=d[1];return b.split("\n").map(a=>{let b=a.match(c.other.beginningSpace);if(null===b)return a;let[d]=b;return d.length>=e.length?a.slice(e.length):a}).join("\n")}(a,b[3]||"",this.rules);return{type:"code",raw:a,lang:b[2]?b[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):b[2],text:c}}}heading(a){let b=this.rules.block.heading.exec(a);if(b){let a=b[2].trim();if(this.rules.other.endingHash.test(a)){let b=bV(a,"#");this.options.pedantic?a=b.trim():(!b||this.rules.other.endingSpaceChar.test(b))&&(a=b.trim())}return{type:"heading",raw:b[0],depth:b[1].length,text:a,tokens:this.lexer.inline(a)}}}hr(a){let b=this.rules.block.hr.exec(a);if(b)return{type:"hr",raw:bV(b[0],"\n")}}blockquote(a){let b=this.rules.block.blockquote.exec(a);if(b){let a=bV(b[0],"\n").split("\n"),c="",d="",e=[];for(;a.length>0;){let b,f=!1,g=[];for(b=0;b<a.length;b++)if(this.rules.other.blockquoteStart.test(a[b]))g.push(a[b]),f=!0;else if(f)break;else g.push(a[b]);a=a.slice(b);let h=g.join("\n"),i=h.replace(this.rules.other.blockquoteSetextReplace,"\n    $1").replace(this.rules.other.blockquoteSetextReplace2,"");c=c?`${c}
${h}`:h,d=d?`${d}
${i}`:i;let j=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(i,e,!0),this.lexer.state.top=j,0===a.length)break;let k=e.at(-1);if(k?.type==="code")break;if(k?.type==="blockquote"){let b=k.raw+"\n"+a.join("\n"),f=this.blockquote(b);e[e.length-1]=f,c=c.substring(0,c.length-k.raw.length)+f.raw,d=d.substring(0,d.length-k.text.length)+f.text;break}if(k?.type==="list"){let b=k.raw+"\n"+a.join("\n"),f=this.list(b);e[e.length-1]=f,c=c.substring(0,c.length-k.raw.length)+f.raw,d=d.substring(0,d.length-k.raw.length)+f.raw,a=b.substring(e.at(-1).raw.length).split("\n");continue}}return{type:"blockquote",raw:c,tokens:e,text:d}}}list(a){let b=this.rules.block.list.exec(a);if(b){let c=b[1].trim(),d=c.length>1,e={type:"list",raw:"",ordered:d,start:d?+c.slice(0,-1):"",loose:!1,items:[]};c=d?`\\d{1,9}\\${c.slice(-1)}`:`\\${c}`,this.options.pedantic&&(c=d?c:"[*+-]");let f=this.rules.other.listItemRegex(c),g=!1;for(;a;){let c,d=!1,h="",i="";if(!(b=f.exec(a))||this.rules.block.hr.test(a))break;h=b[0],a=a.substring(h.length);let j=b[2].split("\n",1)[0].replace(this.rules.other.listReplaceTabs,a=>" ".repeat(3*a.length)),k=a.split("\n",1)[0],l=!j.trim(),m=0;if(this.options.pedantic?(m=2,i=j.trimStart()):l?m=b[1].length+1:(m=(m=b[2].search(this.rules.other.nonSpaceChar))>4?1:m,i=j.slice(m),m+=b[1].length),l&&this.rules.other.blankLine.test(k)&&(h+=k+"\n",a=a.substring(k.length+1),d=!0),!d){let b=this.rules.other.nextBulletRegex(m),c=this.rules.other.hrRegex(m),d=this.rules.other.fencesBeginRegex(m),e=this.rules.other.headingBeginRegex(m),f=this.rules.other.htmlBeginRegex(m);for(;a;){let g,n=a.split("\n",1)[0];if(k=n,g=this.options.pedantic?k=k.replace(this.rules.other.listReplaceNesting,"  "):k.replace(this.rules.other.tabCharGlobal,"    "),d.test(k)||e.test(k)||f.test(k)||b.test(k)||c.test(k))break;if(g.search(this.rules.other.nonSpaceChar)>=m||!k.trim())i+="\n"+g.slice(m);else{if(l||j.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||d.test(j)||e.test(j)||c.test(j))break;i+="\n"+k}l||k.trim()||(l=!0),h+=n+"\n",a=a.substring(n.length+1),j=g.slice(m)}}!e.loose&&(g?e.loose=!0:this.rules.other.doubleBlankLine.test(h)&&(g=!0));let n=null;this.options.gfm&&(n=this.rules.other.listIsTask.exec(i))&&(c="[ ] "!==n[0],i=i.replace(this.rules.other.listReplaceTask,"")),e.items.push({type:"list_item",raw:h,task:!!n,checked:c,loose:!1,text:i,tokens:[]}),e.raw+=h}let h=e.items.at(-1);if(!h)return;h.raw=h.raw.trimEnd(),h.text=h.text.trimEnd(),e.raw=e.raw.trimEnd();for(let a=0;a<e.items.length;a++)if(this.lexer.state.top=!1,e.items[a].tokens=this.lexer.blockTokens(e.items[a].text,[]),!e.loose){let b=e.items[a].tokens.filter(a=>"space"===a.type);e.loose=b.length>0&&b.some(a=>this.rules.other.anyLine.test(a.raw))}if(e.loose)for(let a=0;a<e.items.length;a++)e.items[a].loose=!0;return e}}html(a){let b=this.rules.block.html.exec(a);if(b)return{type:"html",block:!0,raw:b[0],pre:"pre"===b[1]||"script"===b[1]||"style"===b[1],text:b[0]}}def(a){let b=this.rules.block.def.exec(a);if(b){let a=b[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),c=b[2]?b[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",d=b[3]?b[3].substring(1,b[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):b[3];return{type:"def",tag:a,raw:b[0],href:c,title:d}}}table(a){let b=this.rules.block.table.exec(a);if(!b||!this.rules.other.tableDelimiter.test(b[2]))return;let c=bU(b[1]),d=b[2].replace(this.rules.other.tableAlignChars,"").split("|"),e=b[3]?.trim()?b[3].replace(this.rules.other.tableRowBlankLine,"").split("\n"):[],f={type:"table",raw:b[0],header:[],align:[],rows:[]};if(c.length===d.length){for(let a of d)this.rules.other.tableAlignRight.test(a)?f.align.push("right"):this.rules.other.tableAlignCenter.test(a)?f.align.push("center"):this.rules.other.tableAlignLeft.test(a)?f.align.push("left"):f.align.push(null);for(let a=0;a<c.length;a++)f.header.push({text:c[a],tokens:this.lexer.inline(c[a]),header:!0,align:f.align[a]});for(let a of e)f.rows.push(bU(a,f.header.length).map((a,b)=>({text:a,tokens:this.lexer.inline(a),header:!1,align:f.align[b]})));return f}}lheading(a){let b=this.rules.block.lheading.exec(a);if(b)return{type:"heading",raw:b[0],depth:"="===b[2].charAt(0)?1:2,text:b[1],tokens:this.lexer.inline(b[1])}}paragraph(a){let b=this.rules.block.paragraph.exec(a);if(b){let a="\n"===b[1].charAt(b[1].length-1)?b[1].slice(0,-1):b[1];return{type:"paragraph",raw:b[0],text:a,tokens:this.lexer.inline(a)}}}text(a){let b=this.rules.block.text.exec(a);if(b)return{type:"text",raw:b[0],text:b[0],tokens:this.lexer.inline(b[0])}}escape(a){let b=this.rules.inline.escape.exec(a);if(b)return{type:"escape",raw:b[0],text:b[1]}}tag(a){let b=this.rules.inline.tag.exec(a);if(b)return!this.lexer.state.inLink&&this.rules.other.startATag.test(b[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(b[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(b[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(b[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:b[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:b[0]}}link(a){let b=this.rules.inline.link.exec(a);if(b){let a=b[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(a)){if(!this.rules.other.endAngleBracket.test(a))return;let b=bV(a.slice(0,-1),"\\");if((a.length-b.length)%2==0)return}else{let a=function(a,b){if(-1===a.indexOf(")"))return -1;let c=0;for(let b=0;b<a.length;b++)if("\\"===a[b])b++;else if("("===a[b])c++;else if(")"===a[b]&&--c<0)return b;return c>0?-2:-1}(b[2],0);if(-2===a)return;if(a>-1){let c=(0===b[0].indexOf("!")?5:4)+b[1].length+a;b[2]=b[2].substring(0,a),b[0]=b[0].substring(0,c).trim(),b[3]=""}}let c=b[2],d="";if(this.options.pedantic){let a=this.rules.other.pedanticHrefTitle.exec(c);a&&(c=a[1],d=a[3])}else d=b[3]?b[3].slice(1,-1):"";return c=c.trim(),this.rules.other.startAngleBracket.test(c)&&(c=this.options.pedantic&&!this.rules.other.endAngleBracket.test(a)?c.slice(1):c.slice(1,-1)),bW(b,{href:c?c.replace(this.rules.inline.anyPunctuation,"$1"):c,title:d?d.replace(this.rules.inline.anyPunctuation,"$1"):d},b[0],this.lexer,this.rules)}}reflink(a,b){let c;if((c=this.rules.inline.reflink.exec(a))||(c=this.rules.inline.nolink.exec(a))){let a=b[(c[2]||c[1]).replace(this.rules.other.multipleSpaceGlobal," ").toLowerCase()];if(!a){let a=c[0].charAt(0);return{type:"text",raw:a,text:a}}return bW(c,a,c[0],this.lexer,this.rules)}}emStrong(a,b,c=""){let d=this.rules.inline.emStrongLDelim.exec(a);if(!(!d||d[3]&&c.match(this.rules.other.unicodeAlphaNumeric))&&(!(d[1]||d[2])||!c||this.rules.inline.punctuation.exec(c))){let c=[...d[0]].length-1,e,f,g=c,h=0,i="*"===d[0][0]?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(i.lastIndex=0,b=b.slice(-1*a.length+c);null!=(d=i.exec(b));){if(!(e=d[1]||d[2]||d[3]||d[4]||d[5]||d[6]))continue;if(f=[...e].length,d[3]||d[4]){g+=f;continue}if((d[5]||d[6])&&c%3&&!((c+f)%3)){h+=f;continue}if((g-=f)>0)continue;f=Math.min(f,f+g+h);let b=[...d[0]][0].length,i=a.slice(0,c+d.index+b+f);if(Math.min(c,f)%2){let a=i.slice(1,-1);return{type:"em",raw:i,text:a,tokens:this.lexer.inlineTokens(a)}}let j=i.slice(2,-2);return{type:"strong",raw:i,text:j,tokens:this.lexer.inlineTokens(j)}}}}codespan(a){let b=this.rules.inline.code.exec(a);if(b){let a=b[2].replace(this.rules.other.newLineCharGlobal," "),c=this.rules.other.nonSpaceChar.test(a),d=this.rules.other.startingSpaceChar.test(a)&&this.rules.other.endingSpaceChar.test(a);return c&&d&&(a=a.substring(1,a.length-1)),{type:"codespan",raw:b[0],text:a}}}br(a){let b=this.rules.inline.br.exec(a);if(b)return{type:"br",raw:b[0]}}del(a){let b=this.rules.inline.del.exec(a);if(b)return{type:"del",raw:b[0],text:b[2],tokens:this.lexer.inlineTokens(b[2])}}autolink(a){let b=this.rules.inline.autolink.exec(a);if(b){let a,c;return c="@"===b[2]?"mailto:"+(a=b[1]):a=b[1],{type:"link",raw:b[0],text:a,href:c,tokens:[{type:"text",raw:a,text:a}]}}}url(a){let b;if(b=this.rules.inline.url.exec(a)){let a,c;if("@"===b[2])c="mailto:"+(a=b[0]);else{let d;do d=b[0],b[0]=this.rules.inline._backpedal.exec(b[0])?.[0]??"";while(d!==b[0])a=b[0],c="www."===b[1]?"http://"+b[0]:b[0]}return{type:"link",raw:b[0],text:a,href:c,tokens:[{type:"text",raw:a,text:a}]}}}inlineText(a){let b=this.rules.inline.text.exec(a);if(b){let a=this.lexer.state.inRawBlock;return{type:"text",raw:b[0],text:b[0],escaped:a}}}},bY=class a{tokens;options;state;tokenizer;inlineQueue;constructor(a){this.tokens=[],this.tokens.links=Object.create(null),this.options=a||a3,this.options.tokenizer=this.options.tokenizer||new bX,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const b={other:a6,block:bO.normal,inline:bP.normal};this.options.pedantic?(b.block=bO.pedantic,b.inline=bP.pedantic):this.options.gfm&&(b.block=bO.gfm,this.options.breaks?b.inline=bP.breaks:b.inline=bP.gfm),this.tokenizer.rules=b}static get rules(){return{block:bO,inline:bP}}static lex(b,c){return new a(c).lex(b)}static lexInline(b,c){return new a(c).inlineTokens(b)}lex(a){a=a.replace(a6.carriageReturn,"\n"),this.blockTokens(a,this.tokens);for(let a=0;a<this.inlineQueue.length;a++){let b=this.inlineQueue[a];this.inlineTokens(b.src,b.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(a,b=[],c=!1){for(this.options.pedantic&&(a=a.replace(a6.tabCharGlobal,"    ").replace(a6.spaceLine,""));a;){let d;if(this.options.extensions?.block?.some(c=>!!(d=c.call({lexer:this},a,b))&&(a=a.substring(d.raw.length),b.push(d),!0)))continue;if(d=this.tokenizer.space(a)){a=a.substring(d.raw.length);let c=b.at(-1);1===d.raw.length&&void 0!==c?c.raw+="\n":b.push(d);continue}if(d=this.tokenizer.code(a)){a=a.substring(d.raw.length);let c=b.at(-1);c?.type==="paragraph"||c?.type==="text"?(c.raw+="\n"+d.raw,c.text+="\n"+d.text,this.inlineQueue.at(-1).src=c.text):b.push(d);continue}if((d=this.tokenizer.fences(a))||(d=this.tokenizer.heading(a))||(d=this.tokenizer.hr(a))||(d=this.tokenizer.blockquote(a))||(d=this.tokenizer.list(a))||(d=this.tokenizer.html(a))){a=a.substring(d.raw.length),b.push(d);continue}if(d=this.tokenizer.def(a)){a=a.substring(d.raw.length);let c=b.at(-1);c?.type==="paragraph"||c?.type==="text"?(c.raw+="\n"+d.raw,c.text+="\n"+d.raw,this.inlineQueue.at(-1).src=c.text):this.tokens.links[d.tag]||(this.tokens.links[d.tag]={href:d.href,title:d.title});continue}if((d=this.tokenizer.table(a))||(d=this.tokenizer.lheading(a))){a=a.substring(d.raw.length),b.push(d);continue}let e=a;if(this.options.extensions?.startBlock){let b,c=1/0,d=a.slice(1);this.options.extensions.startBlock.forEach(a=>{"number"==typeof(b=a.call({lexer:this},d))&&b>=0&&(c=Math.min(c,b))}),c<1/0&&c>=0&&(e=a.substring(0,c+1))}if(this.state.top&&(d=this.tokenizer.paragraph(e))){let f=b.at(-1);c&&f?.type==="paragraph"?(f.raw+="\n"+d.raw,f.text+="\n"+d.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=f.text):b.push(d),c=e.length!==a.length,a=a.substring(d.raw.length);continue}if(d=this.tokenizer.text(a)){a=a.substring(d.raw.length);let c=b.at(-1);c?.type==="text"?(c.raw+="\n"+d.raw,c.text+="\n"+d.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):b.push(d);continue}if(a){let b="Infinite loop on byte: "+a.charCodeAt(0);if(this.options.silent){console.error(b);break}throw Error(b)}}return this.state.top=!0,b}inline(a,b=[]){return this.inlineQueue.push({src:a,tokens:b}),b}inlineTokens(a,b=[]){let c=a,d=null;if(this.tokens.links){let a=Object.keys(this.tokens.links);if(a.length>0)for(;null!=(d=this.tokenizer.rules.inline.reflinkSearch.exec(c));)a.includes(d[0].slice(d[0].lastIndexOf("[")+1,-1))&&(c=c.slice(0,d.index)+"["+"a".repeat(d[0].length-2)+"]"+c.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(d=this.tokenizer.rules.inline.anyPunctuation.exec(c));)c=c.slice(0,d.index)+"++"+c.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;null!=(d=this.tokenizer.rules.inline.blockSkip.exec(c));)c=c.slice(0,d.index)+"["+"a".repeat(d[0].length-2)+"]"+c.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let e=!1,f="";for(;a;){let d;if(e||(f=""),e=!1,this.options.extensions?.inline?.some(c=>!!(d=c.call({lexer:this},a,b))&&(a=a.substring(d.raw.length),b.push(d),!0)))continue;if((d=this.tokenizer.escape(a))||(d=this.tokenizer.tag(a))||(d=this.tokenizer.link(a))){a=a.substring(d.raw.length),b.push(d);continue}if(d=this.tokenizer.reflink(a,this.tokens.links)){a=a.substring(d.raw.length);let c=b.at(-1);"text"===d.type&&c?.type==="text"?(c.raw+=d.raw,c.text+=d.text):b.push(d);continue}if((d=this.tokenizer.emStrong(a,c,f))||(d=this.tokenizer.codespan(a))||(d=this.tokenizer.br(a))||(d=this.tokenizer.del(a))||(d=this.tokenizer.autolink(a))||!this.state.inLink&&(d=this.tokenizer.url(a))){a=a.substring(d.raw.length),b.push(d);continue}let g=a;if(this.options.extensions?.startInline){let b,c=1/0,d=a.slice(1);this.options.extensions.startInline.forEach(a=>{"number"==typeof(b=a.call({lexer:this},d))&&b>=0&&(c=Math.min(c,b))}),c<1/0&&c>=0&&(g=a.substring(0,c+1))}if(d=this.tokenizer.inlineText(g)){a=a.substring(d.raw.length),"_"!==d.raw.slice(-1)&&(f=d.raw.slice(-1)),e=!0;let c=b.at(-1);c?.type==="text"?(c.raw+=d.raw,c.text+=d.text):b.push(d);continue}if(a){let b="Infinite loop on byte: "+a.charCodeAt(0);if(this.options.silent){console.error(b);break}throw Error(b)}}return b}},bZ=class{options;parser;constructor(a){this.options=a||a3}space(a){return""}code({text:a,lang:b,escaped:c}){let d=(b||"").match(a6.notSpaceStart)?.[0],e=a.replace(a6.endingNewline,"")+"\n";return d?'<pre><code class="language-'+bS(d)+'">'+(c?e:bS(e,!0))+"</code></pre>\n":"<pre><code>"+(c?e:bS(e,!0))+"</code></pre>\n"}blockquote({tokens:a}){let b=this.parser.parse(a);return`<blockquote>
${b}</blockquote>
`}html({text:a}){return a}heading({tokens:a,depth:b}){return`<h${b}>${this.parser.parseInline(a)}</h${b}>
`}hr(a){return"<hr>\n"}list(a){let b=a.ordered,c=a.start,d="";for(let b=0;b<a.items.length;b++){let c=a.items[b];d+=this.listitem(c)}let e=b?"ol":"ul";return"<"+e+(b&&1!==c?' start="'+c+'"':"")+">\n"+d+"</"+e+">\n"}listitem(a){let b="";if(a.task){let c=this.checkbox({checked:!!a.checked});a.loose?a.tokens[0]?.type==="paragraph"?(a.tokens[0].text=c+" "+a.tokens[0].text,a.tokens[0].tokens&&a.tokens[0].tokens.length>0&&"text"===a.tokens[0].tokens[0].type&&(a.tokens[0].tokens[0].text=c+" "+bS(a.tokens[0].tokens[0].text),a.tokens[0].tokens[0].escaped=!0)):a.tokens.unshift({type:"text",raw:c+" ",text:c+" ",escaped:!0}):b+=c+" "}return b+=this.parser.parse(a.tokens,!!a.loose),`<li>${b}</li>
`}checkbox({checked:a}){return"<input "+(a?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:a}){return`<p>${this.parser.parseInline(a)}</p>
`}table(a){let b="",c="";for(let b=0;b<a.header.length;b++)c+=this.tablecell(a.header[b]);b+=this.tablerow({text:c});let d="";for(let b=0;b<a.rows.length;b++){let e=a.rows[b];c="";for(let a=0;a<e.length;a++)c+=this.tablecell(e[a]);d+=this.tablerow({text:c})}return d&&(d=`<tbody>${d}</tbody>`),"<table>\n<thead>\n"+b+"</thead>\n"+d+"</table>\n"}tablerow({text:a}){return`<tr>
${a}</tr>
`}tablecell(a){let b=this.parser.parseInline(a.tokens),c=a.header?"th":"td";return(a.align?`<${c} align="${a.align}">`:`<${c}>`)+b+`</${c}>
`}strong({tokens:a}){return`<strong>${this.parser.parseInline(a)}</strong>`}em({tokens:a}){return`<em>${this.parser.parseInline(a)}</em>`}codespan({text:a}){return`<code>${bS(a,!0)}</code>`}br(a){return"<br>"}del({tokens:a}){return`<del>${this.parser.parseInline(a)}</del>`}link({href:a,title:b,tokens:c}){let d=this.parser.parseInline(c),e=bT(a);if(null===e)return d;let f='<a href="'+(a=e)+'"';return b&&(f+=' title="'+bS(b)+'"'),f+=">"+d+"</a>"}image({href:a,title:b,text:c,tokens:d}){d&&(c=this.parser.parseInline(d,this.parser.textRenderer));let e=bT(a);if(null===e)return bS(c);a=e;let f=`<img src="${a}" alt="${c}"`;return b&&(f+=` title="${bS(b)}"`),f+=">"}text(a){return"tokens"in a&&a.tokens?this.parser.parseInline(a.tokens):"escaped"in a&&a.escaped?a.text:bS(a.text)}},b$=class{strong({text:a}){return a}em({text:a}){return a}codespan({text:a}){return a}del({text:a}){return a}html({text:a}){return a}text({text:a}){return a}link({text:a}){return""+a}image({text:a}){return""+a}br(){return""}},b_=class a{options;renderer;textRenderer;constructor(a){this.options=a||a3,this.options.renderer=this.options.renderer||new bZ,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new b$}static parse(b,c){return new a(c).parse(b)}static parseInline(b,c){return new a(c).parseInline(b)}parse(a,b=!0){let c="";for(let d=0;d<a.length;d++){let e=a[d];if(this.options.extensions?.renderers?.[e.type]){let a=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==a||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(e.type)){c+=a||"";continue}}switch(e.type){case"space":c+=this.renderer.space(e);continue;case"hr":c+=this.renderer.hr(e);continue;case"heading":c+=this.renderer.heading(e);continue;case"code":c+=this.renderer.code(e);continue;case"table":c+=this.renderer.table(e);continue;case"blockquote":c+=this.renderer.blockquote(e);continue;case"list":c+=this.renderer.list(e);continue;case"html":c+=this.renderer.html(e);continue;case"paragraph":c+=this.renderer.paragraph(e);continue;case"text":{let f=e,g=this.renderer.text(f);for(;d+1<a.length&&"text"===a[d+1].type;)f=a[++d],g+="\n"+this.renderer.text(f);b?c+=this.renderer.paragraph({type:"paragraph",raw:g,text:g,tokens:[{type:"text",raw:g,text:g,escaped:!0}]}):c+=g;continue}default:{let a='Token with "'+e.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw Error(a)}}}return c}parseInline(a,b=this.renderer){let c="";for(let d=0;d<a.length;d++){let e=a[d];if(this.options.extensions?.renderers?.[e.type]){let a=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==a||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(e.type)){c+=a||"";continue}}switch(e.type){case"escape":case"text":c+=b.text(e);break;case"html":c+=b.html(e);break;case"link":c+=b.link(e);break;case"image":c+=b.image(e);break;case"strong":c+=b.strong(e);break;case"em":c+=b.em(e);break;case"codespan":c+=b.codespan(e);break;case"br":c+=b.br(e);break;case"del":c+=b.del(e);break;default:{let a='Token with "'+e.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw Error(a)}}}return c}},b0=class{options;block;constructor(a){this.options=a||a3}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(a){return a}postprocess(a){return a}processAllTokens(a){return a}provideLexer(){return this.block?bY.lex:bY.lexInline}provideParser(){return this.block?b_.parse:b_.parseInline}},b1=new class{defaults=a2();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=b_;Renderer=bZ;TextRenderer=b$;Lexer=bY;Tokenizer=bX;Hooks=b0;constructor(...a){this.use(...a)}walkTokens(a,b){let c=[];for(let d of a)switch(c=c.concat(b.call(this,d)),d.type){case"table":for(let a of d.header)c=c.concat(this.walkTokens(a.tokens,b));for(let a of d.rows)for(let d of a)c=c.concat(this.walkTokens(d.tokens,b));break;case"list":c=c.concat(this.walkTokens(d.items,b));break;default:{let a=d;this.defaults.extensions?.childTokens?.[a.type]?this.defaults.extensions.childTokens[a.type].forEach(d=>{let e=a[d].flat(1/0);c=c.concat(this.walkTokens(e,b))}):a.tokens&&(c=c.concat(this.walkTokens(a.tokens,b)))}}return c}use(...a){let b=this.defaults.extensions||{renderers:{},childTokens:{}};return a.forEach(a=>{let c={...a};if(c.async=this.defaults.async||c.async||!1,a.extensions&&(a.extensions.forEach(a=>{if(!a.name)throw Error("extension name required");if("renderer"in a){let c=b.renderers[a.name];c?b.renderers[a.name]=function(...b){let d=a.renderer.apply(this,b);return!1===d&&(d=c.apply(this,b)),d}:b.renderers[a.name]=a.renderer}if("tokenizer"in a){if(!a.level||"block"!==a.level&&"inline"!==a.level)throw Error("extension level must be 'block' or 'inline'");let c=b[a.level];c?c.unshift(a.tokenizer):b[a.level]=[a.tokenizer],a.start&&("block"===a.level?b.startBlock?b.startBlock.push(a.start):b.startBlock=[a.start]:"inline"===a.level&&(b.startInline?b.startInline.push(a.start):b.startInline=[a.start]))}"childTokens"in a&&a.childTokens&&(b.childTokens[a.name]=a.childTokens)}),c.extensions=b),a.renderer){let b=this.defaults.renderer||new bZ(this.defaults);for(let c in a.renderer){if(!(c in b))throw Error(`renderer '${c}' does not exist`);if(["options","parser"].includes(c))continue;let d=a.renderer[c],e=b[c];b[c]=(...a)=>{let c=d.apply(b,a);return!1===c&&(c=e.apply(b,a)),c||""}}c.renderer=b}if(a.tokenizer){let b=this.defaults.tokenizer||new bX(this.defaults);for(let c in a.tokenizer){if(!(c in b))throw Error(`tokenizer '${c}' does not exist`);if(["options","rules","lexer"].includes(c))continue;let d=a.tokenizer[c],e=b[c];b[c]=(...a)=>{let c=d.apply(b,a);return!1===c&&(c=e.apply(b,a)),c}}c.tokenizer=b}if(a.hooks){let b=this.defaults.hooks||new b0;for(let c in a.hooks){if(!(c in b))throw Error(`hook '${c}' does not exist`);if(["options","block"].includes(c))continue;let d=a.hooks[c],e=b[c];b0.passThroughHooks.has(c)?b[c]=a=>{if(this.defaults.async)return Promise.resolve(d.call(b,a)).then(a=>e.call(b,a));let c=d.call(b,a);return e.call(b,c)}:b[c]=(...a)=>{let c=d.apply(b,a);return!1===c&&(c=e.apply(b,a)),c}}c.hooks=b}if(a.walkTokens){let b=this.defaults.walkTokens,d=a.walkTokens;c.walkTokens=function(a){let c=[];return c.push(d.call(this,a)),b&&(c=c.concat(b.call(this,a))),c}}this.defaults={...this.defaults,...c}}),this}setOptions(a){return this.defaults={...this.defaults,...a},this}lexer(a,b){return bY.lex(a,b??this.defaults)}parser(a,b){return b_.parse(a,b??this.defaults)}parseMarkdown(a){return(b,c)=>{let d={...c},e={...this.defaults,...d},f=this.onError(!!e.silent,!!e.async);if(!0===this.defaults.async&&!1===d.async)return f(Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(null==b)return f(Error("marked(): input parameter is undefined or null"));if("string"!=typeof b)return f(Error("marked(): input parameter is of type "+Object.prototype.toString.call(b)+", string expected"));e.hooks&&(e.hooks.options=e,e.hooks.block=a);let g=e.hooks?e.hooks.provideLexer():a?bY.lex:bY.lexInline,h=e.hooks?e.hooks.provideParser():a?b_.parse:b_.parseInline;if(e.async)return Promise.resolve(e.hooks?e.hooks.preprocess(b):b).then(a=>g(a,e)).then(a=>e.hooks?e.hooks.processAllTokens(a):a).then(a=>e.walkTokens?Promise.all(this.walkTokens(a,e.walkTokens)).then(()=>a):a).then(a=>h(a,e)).then(a=>e.hooks?e.hooks.postprocess(a):a).catch(f);try{e.hooks&&(b=e.hooks.preprocess(b));let a=g(b,e);e.hooks&&(a=e.hooks.processAllTokens(a)),e.walkTokens&&this.walkTokens(a,e.walkTokens);let c=h(a,e);return e.hooks&&(c=e.hooks.postprocess(c)),c}catch(a){return f(a)}}}onError(a,b){return c=>{if(c.message+="\nPlease report this to https://github.com/markedjs/marked.",a){let a="<p>An error occurred:</p><pre>"+bS(c.message+"",!0)+"</pre>";return b?Promise.resolve(a):a}if(b)return Promise.reject(c);throw c}}};function b2(a,b){return b1.parse(a,b)}b2.options=b2.setOptions=function(a){return b1.setOptions(a),b2.defaults=b1.defaults,a3=b2.defaults,b2},b2.getDefaults=a2,b2.defaults=a3,b2.use=function(...a){return b1.use(...a),b2.defaults=b1.defaults,a3=b2.defaults,b2},b2.walkTokens=function(a,b){return b1.walkTokens(a,b)},b2.parseInline=b1.parseInline,b2.Parser=b_,b2.parser=b_.parse,b2.Renderer=bZ,b2.TextRenderer=b$,b2.Lexer=bY,b2.lexer=bY.lex,b2.Tokenizer=bX,b2.Hooks=b0,b2.parse=b2,b2.options,b2.setOptions,b2.use,b2.walkTokens,b2.parseInline,b_.parse,bY.lex;let b3="foliate-note:";function b4(a,b){if(!b)return!1;let c=a0.collapse(b),d=a0.collapse(b,!0);return a0.compare(a,c)>=0&&0>=a0.compare(a,d)}let b5=(a,b)=>{let c=(0,d.useRef)(null),e=(0,d.useMemo)(()=>b4(a,b?.location),[a,b]);return(0,d.useEffect)(()=>{if(!c.current||!e)return;let a=c.current,b=a.getBoundingClientRect();b.top>=0&&b.bottom<=window.innerHeight||a.scrollIntoView({behavior:"smooth",block:"center"}),a.setAttribute("aria-current","page")},[e]),{isCurrent:e,viewRef:c}},b6=({children:a,onClick:b,disabled:d=!1,className:e,variant:f="primary",size:g="sm",type:h="button"})=>{let i={sm:"font-size-sm h-[1.3em] min-h-[1.3em]",md:"font-size-md h-[1.5em] min-h-[1.5em]",lg:"font-size-lg h-[1.8em] min-h-[1.8em]"};return(0,c.jsx)("button",{type:h,className:(0,j.default)("content settings-content btn btn-ghost hover:bg-transparent","flex items-end p-0",i[g],d?"btn-disabled !bg-opacity-0":"",e),onClick:b,disabled:d,children:(0,c.jsx)("div",{className:(0,j.default)("align-bottom",i[g].split(" ")[0],{primary:"text-blue-500 hover:text-blue-600",secondary:"text-gray-500 hover:text-gray-600",danger:"text-red-500 hover:text-red-600",success:"text-green-500 hover:text-green-600"}[f]),children:a})})},b7=(0,d.forwardRef)(({value:a,onChange:b,onBlur:e,onSave:f,onEscape:g,placeholder:h,className:i,autoFocus:k=!1,spellCheck:l=!1,disabled:m=!1,maxRows:n,minRows:o=1},p)=>{let q=(0,d.useRef)(null);(0,d.useImperativeHandle)(p,()=>({focus:()=>{q.current?.focus()},blur:()=>{q.current?.blur()},getValue:()=>q.current?.value||"",setValue:a=>{q.current&&(q.current.value=a,r())},getElement:()=>q.current})),(0,d.useEffect)(()=>{k&&q.current&&q.current.focus()},[k]),(0,d.useEffect)(()=>{q.current&&(q.current.value=a,r())},[a]);let r=()=>{if(q.current){q.current.style.height="auto";let a=q.current.scrollHeight,b=1/0;n&&(b=parseInt(getComputedStyle(q.current).lineHeight)*n);let c=Math.min(Math.max(a,(parseInt(getComputedStyle(q.current).lineHeight)||20)*o),b);q.current.style.height=`${c}px`}};return(0,c.jsx)("textarea",{ref:q,className:(0,j.default)("textarea textarea-ghost min-h-[1em] resize-none !outline-none","inset-0 w-full rounded-none border-0 bg-transparent p-0","content font-size-sm",i),dir:"auto",rows:o,spellCheck:l,disabled:m,onChange:a=>{r(),b(a.target.value)},onBlur:e,onKeyDown:a=>{if("Escape"===a.key&&g)return void g();if("Enter"===a.key&&(a.metaKey||a.ctrlKey)&&f){a.preventDefault(),f();return}},placeholder:h||""})});b7.displayName="TextEditor";let b8=({bookKey:a,item:b,onClick:g})=>{let i=(0,f.useTranslation)(),{envConfig:k}=(0,e.useEnv)(),{settings:l}=(0,h.useSettingsStore)(),{getConfig:m,saveConfig:n,updateBooknotes:p}=(0,P.useBookDataStore)(),{getProgress:q,getView:r,getViewsById:s}=(0,o.useReaderStore)(),{setNotebookEditAnnotation:u,setNotebookVisible:v}=t(),{text:w,cfi:y,note:z}=b,A=(0,d.useRef)(null),[B,C]=(0,d.useState)(w||""),[D,E]=(0,d.useState)(!1),F=(0,aH.useResponsiveSize)(3),{isCurrent:G,viewRef:H}=b5(y,q(a)),I=b=>{b.preventDefault(),x.eventDispatcher.dispatch("navigate",{bookKey:a,cfi:y}),g?.(),r(a)?.goTo(y),z&&v(!0)},J=()=>{E(!1);let c=m(a);if(!c||!B)return;let{booknotes:d=[]}=c,e=d.findIndex(a=>b.id===a.id);if(-1===e)return;d[e].updatedAt=Date.now(),d[e].text=B;let f=p(a,d);f&&n(k,a,f,l)};return D?(0,c.jsxs)("div",{className:(0,j.default)("border-base-300 content group relative my-2 cursor-pointer rounded-lg p-2",G?"bg-base-300/85 hover:bg-base-300":"hover:bg-base-300/55 bg-base-100","transition-all duration-300 ease-in-out"),children:[(0,c.jsx)("div",{className:"flex w-full",children:(0,c.jsx)(b7,{className:"!leading-normal",ref:A,value:B,onChange:C,onSave:J,onEscape:()=>E(!1),spellCheck:!1})}),(0,c.jsxs)("div",{className:"flex justify-end space-x-3 p-2",dir:"ltr",children:[(0,c.jsx)(b6,{onClick:()=>E(!1),children:i("Cancel")}),(0,c.jsx)(b6,{onClick:J,disabled:!B,children:i("Save")})]})]}):(0,c.jsxs)("li",{role:"button",ref:H,className:(0,j.default)("booknote-item border-base-300 content group relative my-2 cursor-pointer rounded-lg p-2",G?"bg-base-300/85 hover:bg-base-300 focus:bg-base-300":"hover:bg-base-300/55 focus:bg-base-300/55 bg-base-100","transition-all duration-300 ease-in-out"),tabIndex:0,onClick:I,onKeyDown:a=>{"Enter"===a.key||" "===a.key?I(a):a.stopPropagation()},children:[(0,c.jsxs)("div",{className:(0,j.default)("min-h-4 p-0 transition-all duration-300 ease-in-out"),style:{"--top-override":"0.7rem","--end-override":"0.3rem"},children:[b.note&&(0,c.jsx)("div",{className:"content prose prose-sm font-size-sm",dir:"auto",dangerouslySetInnerHTML:{__html:b2.parse(b.note)}}),(0,c.jsxs)("div",{className:"flex items-start",children:[b.note&&(0,c.jsx)("div",{className:"me-2 mt-2.5 min-h-full self-stretch rounded-xl bg-gray-300",style:{minWidth:`${F}px`}}),(0,c.jsx)("div",{className:(0,j.default)("content font-size-sm line-clamp-3",b.note&&"mt-2"),children:(0,c.jsx)("span",{className:(0,j.default)("booknote-text inline leading-normal",b.note&&"content font-size-xs text-gray-500",("underline"===b.style||"squiggly"===b.style)&&"underline decoration-2","highlight"===b.style&&`bg-${b.color}-500 bg-opacity-40`,"underline"===b.style&&`decoration-${b.color}-400`,"squiggly"===b.style&&`decoration-wavy decoration-${b.color}-400`),children:w||""})})]})]}),(0,c.jsx)("div",{className:(0,j.default)("max-h-0 overflow-hidden p-0","transition-[max-height] duration-300 ease-in-out","group-hover:max-h-8 group-hover:overflow-visible","group-focus-within:max-h-8 group-focus-within:overflow-visible"),style:{"--bottom-override":0},onClick:a=>a.stopPropagation(),children:(0,c.jsxs)("div",{className:"flex cursor-default items-center justify-between",children:[(0,c.jsx)("div",{className:"flex items-center",children:(0,c.jsx)("span",{className:"text-sm text-gray-500 sm:text-xs",children:(0,a1.default)(b.createdAt).fromNow()})}),(0,c.jsxs)("div",{className:"flex items-center justify-end space-x-3 p-2",dir:"ltr",children:[(b.note||"bookmark"===b.type)&&(0,c.jsx)(b6,{onClick:"bookmark"===b.type?()=>{C(w||""),E(!0)}:(a=>{v(!0),u(a)}).bind(null,b),variant:"primary",className:"opacity-0 transition duration-300 ease-in-out group-focus-within:opacity-100 group-hover:opacity-100",children:i("Edit")}),(0,c.jsx)(b6,{onClick:(b=>{if(!a)return;let c=m(a);if(!c)return;let{booknotes:d=[]}=c;d.forEach(c=>{c.id===b.id&&(c.deletedAt=Date.now(),s(a.split("-")[0]).forEach(a=>a?.addAnnotation({...c,value:`${b3}${c.cfi}`},!0)))});let e=p(a,d);e&&n(k,a,e,l)}).bind(null,b),variant:"danger",className:"opacity-0 transition duration-300 ease-in-out group-focus-within:opacity-100 group-hover:opacity-100",children:i("Delete")})]})]})})]})},b9=({type:a,bookKey:b,toc:d})=>{let{getConfig:e}=(0,P.useBookDataStore)(),{setActiveBooknoteType:f,setBooknoteResults:g}=s(),{booknotes:h=[]}=e(b),i=h.filter(b=>b.type===a&&!b.deletedAt),j={};for(let a of i){let b=(0,aU.findTocItemBS)(d??[],a.cfi),c=b?.href||"",e=b?.label||"",f=b?.id||0;j[c]||(j[c]={id:f,href:c,label:e,booknotes:[]}),j[c].booknotes.push(a)}Object.values(j).forEach(a=>{a.booknotes.sort((a,b)=>a0.compare(a.cfi,b.cfi))});let k=Object.values(j).sort((a,b)=>a.id-b.id),l=()=>{if(0===i.length)return;let c=[...i].sort((a,b)=>a0.compare(a.cfi,b.cfi));f(b,a),g(b,c)};return(0,c.jsx)("div",{className:"rounded pt-2",children:(0,c.jsx)("ul",{role:"tree",className:"px-2",children:k.map(a=>(0,c.jsxs)("li",{className:"p-2",children:[(0,c.jsx)("h3",{className:"content font-size-base line-clamp-1 font-normal",children:a.label}),(0,c.jsx)("ul",{children:a.booknotes.map((a,d)=>(0,c.jsx)(b8,{bookKey:b,item:a,onClick:l},`${d}-${a.cfi}`))})]},a.href))})})};var ca=a.i(584807),cb=a.i(508931);let cc=({activeTab:a,onTabChange:b})=>{let d=(0,f.useTranslation)(),{appService:g}=(0,e.useEnv)();return(0,c.jsxs)("div",{className:(0,j.default)("bottom-tab border-base-300/50 bg-base-200/20 relative flex w-full border-t",g?.hasRoundedWindow&&"rounded-window-bottom-left"),dir:"ltr",children:[(0,c.jsx)("div",{className:(0,j.default)("bg-base-300/85 absolute bottom-1.5 start-1 z-10 h-[calc(100%-12px)] w-[calc(33.3%-8px)] rounded-lg","transform transition-transform duration-300","toc"===a&&"translate-x-0","annotations"===a&&"translate-x-[calc(100%+8px)]","bookmarks"===a&&"translate-x-[calc(200%+16px)]")}),["toc","annotations","bookmarks"].map(a=>(0,c.jsx)("div",{tabIndex:0,role:"button",className:"z-[11] m-1.5 flex-1 cursor-pointer rounded-md p-2",onClick:()=>b(a),onKeyDown:c=>{("Enter"===c.key||" "===c.key)&&(c.preventDefault(),b(a))},title:"toc"===a?d("TOC"):"annotations"===a?d("Annotate"):d("Bookmark"),"aria-label":"toc"===a?d("TOC"):"annotations"===a?d("Annotate"):d("Bookmark"),children:(0,c.jsx)("div",{className:(0,j.default)("m-0 flex h-6 items-center p-0"),children:"toc"===a?(0,c.jsx)(ca.IoIosList,{className:"mx-auto"}):"annotations"===a?(0,c.jsx)(cb.PiNotePencil,{className:"mx-auto"}):(0,c.jsx)(aF.MdBookmarkBorder,{className:"mx-auto"})})},a))]})},cd=({bookDoc:a,sideBarBookKey:b})=>{let{safeAreaInsets:e}=(0,n.useThemeStore)(),{setHoveredBookKey:f}=(0,o.useReaderStore)(),{setSideBarVisible:g}=s(),{getConfig:h,setConfig:i}=(0,P.useBookDataStore)(),k=h(b),[l,m]=(0,d.useState)(k?.viewSettings?.sideBarTab||"toc"),[p,q]=(0,d.useState)(!1),[r,t]=(0,d.useState)(l),u=window.innerWidth<640||window.innerHeight<640;return(0,d.useEffect)(()=>{b&&m(h(b).viewSettings.sideBarTab)},[b]),(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:(0,j.default)("sidebar-content flex h-full min-h-0 flex-grow flex-col shadow-inner","font-sans text-base font-normal sm:text-sm"),children:(0,c.jsx)(aS.OverlayScrollbarsComponent,{className:"min-h-0 flex-1",options:{scrollbars:{autoHide:"scroll",clickScroll:!0},showNativeOverlaidScrollbars:!1},defer:!0,children:(0,c.jsxs)("div",{className:(0,j.default)("scroll-container h-full transition-opacity duration-300 ease-in-out",{"opacity-0":p,"opacity-100":!p}),children:["toc"===r&&a.toc&&(0,c.jsx)(a_,{toc:a.toc,sections:a.sections,bookKey:b}),"annotations"===r&&(0,c.jsx)(b9,{type:"annotation",toc:a.toc??[],bookKey:b}),"bookmarks"===r&&(0,c.jsx)(b9,{type:"bookmark",toc:a.toc??[],bookKey:b})]})})}),(0,c.jsx)("div",{className:"flex-shrink-0",style:{paddingBottom:`${(e?.bottom||0)/2}px`},children:(0,c.jsx)(cc,{activeTab:l,onTabChange:a=>{q(!0);let c=setTimeout(()=>{if(l===a&&u){f(b),g(!1);return}t(a),q(!1),i(b,d),clearTimeout(c)},300);m(a);let d=h(b);d.viewSettings.sideBarTab=a}})})]})};var ce=a.i(948449);let cf=({book:a})=>{let{title:b,author:e}=a,g=(0,f.useTranslation)(),{isDarkMode:h}=(0,n.useThemeStore)(),i=(0,aH.useResponsiveSize)(18),k=(0,d.useRef)(null);return(0,c.jsxs)("div",{className:"flex h-20 w-full items-center",children:[(0,c.jsx)("div",{ref:k,className:(0,j.default)("me-4 aspect-[28/41] max-h-16 w-[15%] max-w-12 overflow-hidden rounded-sm shadow-md",h?"mix-blend-screen":"mix-blend-multiply"),children:(0,c.jsx)(ce.default,{book:a,mode:"list",coverFit:"crop",imageClassName:"rounded-sm",onImageError:()=>k.current.style.display="none"})}),(0,c.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,c.jsx)("h4",{className:"line-clamp-2 w-[90%] text-sm font-semibold",children:(0,ai.formatTitle)(b).replace(/\u00A0/g," ")}),(0,c.jsx)("p",{className:"truncate text-xs opacity-75",children:(0,ai.formatAuthors)(e)})]}),(0,c.jsx)("button",{className:"btn btn-ghost hover:bg-base-300 h-6 min-h-6 w-6 rounded-full p-0 transition-colors","aria-label":g("More Info"),onClick:()=>{x.eventDispatcher.dispatchSync("show-book-details",a)},children:(0,c.jsx)(aF.MdInfoOutline,{size:i,className:"fill-base-content"})})]})};var cg=a.i(157142),ch=a.i(506892);let ci=({tags:a=[],classes:b=[],attributes:c=[],contents:d=[]})=>e=>{if(e.nodeType===Node.ELEMENT_NODE){let f=e.tagName.toLowerCase();return"script"===f||"style"===f||a.includes(f)||b.some(a=>e.classList.contains(a))||c.some(a=>e.hasAttribute(a))||d.some(({tag:a,content:b})=>f===a&&b.test(e.textContent||""))?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}return NodeFilter.FILTER_ACCEPT},cj=({label:a,isActive:b,onClick:d})=>(0,c.jsx)("button",{className:"hover:bg-base-300 flex w-full items-center justify-between rounded-md p-2",onClick:d,children:(0,c.jsxs)("div",{className:"flex items-center",children:[(0,c.jsx)("span",{style:{minWidth:`${(0,aH.useDefaultIconSize)()}px`},children:b&&(0,c.jsx)(aF.MdCheck,{className:"text-base-content"})}),(0,c.jsx)("span",{className:"ml-2",children:a})]})}),ck=({isEink:a,searchConfig:b,menuClassName:d,onSearchConfigChanged:e,setIsDropdownOpen:g})=>{let h=(0,f.useTranslation)(),i=(a,c)=>{e({...b,[a]:c}),g?.(!1)};return(0,c.jsxs)("div",{className:(0,j.default)("search-options dropdown-content dropdown-center border-base-200 z-20 w-56 border shadow-2xl",a?"bordercolor-content border-base-content !bg-base-100 border":"",d),children:[(0,c.jsx)(cj,{label:h("Book"),isActive:"book"===b.scope,onClick:()=>i("scope","book")}),(0,c.jsx)(cj,{label:h("Chapter"),isActive:"section"===b.scope,onClick:()=>i("scope","section")}),(0,c.jsx)("hr",{className:"border-base-200 my-1"}),(0,c.jsx)(cj,{label:h("Match Case"),isActive:b.matchCase,onClick:()=>i("matchCase",!b.matchCase)}),(0,c.jsx)(cj,{label:h("Match Whole Words"),isActive:b.matchWholeWords,onClick:()=>i("matchWholeWords",!b.matchWholeWords)}),(0,c.jsx)(cj,{label:h("Match Diacritics"),isActive:b.matchDiacritics,onClick:()=>i("matchDiacritics",!b.matchDiacritics)})]})},cl="search",cm=({isVisible:a,bookKey:b,onHideSearchBar:g})=>{let i=(0,f.useTranslation)(),{envConfig:k,appService:l}=(0,e.useEnv)(),{settings:m}=(0,h.useSettingsStore)(),{getBookData:n}=(0,P.useBookDataStore)(),{getConfig:p,setConfig:q,saveConfig:r}=(0,P.useBookDataStore)(),{getView:t,getProgress:u,getViewSettings:v}=(0,o.useReaderStore)(),{setSearchTerm:w,setSearchResults:x,setSearchProgress:y}=s(),{getSearchNavState:z,getSearchStatus:A,setSearchStatus:B}=s(),C=v(b),{searchTerm:D}=z(b),F=(0,d.useRef)(""),G=(0,d.useRef)(null),H=(0,d.useRef)(!1),I=(0,d.useMemo)(()=>b.split("-")[0],[b]),K=(0,d.useMemo)(()=>`search-history-${I}`,[I]),[L,M]=(0,d.useState)(()=>[]);(0,d.useEffect)(()=>{let a=localStorage.getItem(K);M(a?JSON.parse(a):[])},[K]);let N=(0,d.useCallback)(a=>{let b=L.filter(b=>b!==a),c=[a,...b].slice(0,10);localStorage.setItem(K,JSON.stringify(c)),M(c)},[K,L]),O=async()=>{M([]),localStorage.removeItem(K),await T()},Q=(0,d.useCallback)((a,b)=>{let c=JSON.stringify({scope:b.scope,matchCase:b.matchCase,matchWholeWords:b.matchWholeWords,matchDiacritics:b.matchDiacritics});return(0,E.md5)(`${a}-${c}`)},[]),R=(0,d.useCallback)(async(a,b)=>{let c=Q(a,b),d=`${cl}/${I}/${c}.json`;try{if(await l?.exists(d,"Cache")){let a=await l?.readFile(d,"Cache","text");if(a)return JSON.parse(a)}}catch(a){console.error("Failed to read search cache:",a)}return null},[I,l,Q]),S=(0,d.useCallback)(async(a,b,c)=>{let d=Q(a,b),e=`${cl}/${I}`,f=`${e}/${d}.json`;try{await l?.exists(e,"Cache")||await l?.createDir(e,"Cache",!0),await l?.writeFile(f,"Cache",JSON.stringify(c))}catch(a){console.error("Failed to save search cache:",a)}},[I,l,Q]),T=(0,d.useCallback)(async()=>{let a=`${cl}/${I}`;try{await l?.exists(a,"Cache")&&await l?.deleteDir(a,"Cache",!0)}catch(a){console.error("Failed to clear search cache:",a)}},[I,l]),U=t(b),V=p(b),W=n(b),X=u(b),Y=W.book?.primaryLanguage||"en",Z=(0,aH.useResponsiveSize)(12),$=(0,aH.useResponsiveSize)(16);(0,d.useEffect)(()=>{ab(D)},[b,D]),(0,d.useEffect)(()=>{a&&G.current&&(G.current.onblur=()=>{H.current=!1},G.current.onfocus=()=>{H.current=!0},l?.isMobile||G.current.focus()),a&&D&&ab(D)},[l,a]),(0,d.useEffect)(()=>{let a=a=>{"Escape"===a.key&&(G.current&&H.current?G.current.blur():g())};return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a)}},[g]);let _=(0,d.useCallback)(async a=>{console.log("searching for:",a);let c=V.searchConfig,d=await R(a,c);d&&(x(b,d),y(b,1),d.length>0&&N(a)),y(b,0),B(b,"searching");let{section:e}=X,f="section"===c.scope?e.current:void 0,g=await U.search({...c,index:f,query:a,acceptNode:ci({tags:Y.startsWith("ja")?["rt"]:[]}),results:d}),h=[],i=0;(async()=>{for await(let d of g){if("terminated"===A(b))return void console.log("search terminated");if("string"==typeof d)"done"===d&&(B(b,"completed"),x(b,[...h]),y(b,1),h.length>0&&(N(a),await S(a,c,h)),console.log("search done"));else if(d.progress){y(b,d.progress);let c=Date.now();if(c-i>=1e3&&(console.log("search progress:",d.progress),i=c),F.current!==a){console.log("search term changed, resetting search"),aa();return}}else h.push(d),x(b,[...h]);await new Promise(a=>setTimeout(a,0))}})()},[X,V.searchConfig,x,y,N,R,S]),aa=(0,d.useCallback)(()=>{x(b,[]),U?.clearSearch()},[b,U,x]),ab=(0,d.useCallback)((0,J.debounce)(a=>{let b;F.current=a,(b=(0,ch.isCJKStr)(a)?1:2,a.length>=b)?_(a):aa()},500),[_,aa]);return(0,c.jsxs)("div",{className:"relative flex flex-col gap-3 p-2",children:[(0,c.jsxs)("div",{className:"bg-base-100 flex h-8 items-center rounded-lg",children:[(0,c.jsx)("div",{className:"absolute ps-3",children:(0,c.jsx)(cg.FaSearch,{size:$,className:"text-base-content/50"})}),(0,c.jsx)("input",{ref:G,type:"text",value:D,spellCheck:!1,onChange:a=>{let c=a.target.value;w(b,c),ab(c)},placeholder:i("Search..."),className:"search-input w-full bg-transparent p-2 pr-0 ps-10 font-sans text-sm font-light focus:outline-none"}),D&&(0,c.jsx)("button",{onClick:()=>{w(b,""),aa(),G.current?.focus()},className:"absolute end-8 flex h-8 w-8 items-center justify-center bg-transparent","aria-label":i("Clear search"),children:(0,c.jsx)(ca.IoMdCloseCircle,{size:$,className:"text-base-content/75"})}),(0,c.jsx)("div",{className:(0,j.default)("absolute end-2 flex h-8 w-8 items-center rounded-r-lg",C?.isEink?"bg-transparent":"bg-base-300"),children:(0,c.jsx)(aI.default,{label:i("Search Options"),className:(0,j.default)(window.innerWidth<640&&"dropdown-end","dropdown-bottom flex justify-center"),menuClassName:window.innerWidth<640?"no-triangle mt-1":"dropdown-center mt-3.5",buttonClassName:(0,j.default)("btn btn-ghost h-8 min-h-8 w-8 p-0 rounded-none rounded-r-lg",C?.isEink?"!bg-transparent hover:!bg-transparent":""),toggleButton:(0,c.jsx)(cg.FaChevronDown,{size:Z,className:"text-base-content/50"}),children:(0,c.jsx)(ck,{isEink:!!C?.isEink,searchConfig:V.searchConfig,onSearchConfigChanged:a=>{q(b,{searchConfig:{...a}}),r(k,b,V,m),ab(D)}})})})]}),L.length>0&&!D&&(0,c.jsxs)("div",{className:"relative flex",children:[(0,c.jsx)("div",{className:(0,j.default)("from-base-200 pointer-events-none absolute left-0 top-0 h-full w-3 bg-gradient-to-r to-transparent",C?.isEink?"hidden":""),"aria-hidden":"true"}),(0,c.jsx)("div",{className:"scrollbar-hidden flex flex-1 gap-1.5 overflow-x-auto",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:L.map((a,d)=>(0,c.jsx)("button",{onClick:()=>{w(b,a),ab(a)},className:"hover:bg-base-200/20 text-base-content/70 bg-base-100 max-w-[60%] flex-shrink-0 whitespace-nowrap rounded-full px-3 py-0.5 text-xs",children:(0,c.jsx)("p",{className:"truncate",children:a})},d))}),(0,c.jsx)("div",{className:(0,j.default)("from-base-200 pointer-events-none absolute right-6 top-0 h-full w-6 bg-gradient-to-l to-transparent",C?.isEink?"hidden":""),"aria-hidden":"true"}),(0,c.jsx)("button",{onClick:O,className:(0,j.default)("text-base-content/50 hover:text-base-content/80 flex-shrink-0 items-center","flex h-6 min-h-6 w-8 min-w-8 items-center justify-center p-0"),title:i("Clear search history"),"aria-label":i("Clear search history"),children:(0,c.jsx)(aF.MdDeleteOutline,{size:$})})]})]})},cn=({bookKey:a,cfi:b,excerpt:d,onSelectResult:e})=>{let{getProgress:f}=(0,o.useReaderStore)(),{isCurrent:g,viewRef:h}=b5(b,f(a));return(0,c.jsx)("li",{role:"button",ref:h,className:(0,j.default)("my-2 cursor-pointer rounded-lg p-2 text-sm",g?"bg-base-300 hover:bg-gray-300/70":"hover:bg-base-300 bg-base-100"),tabIndex:0,onClick:()=>e(b),onKeyDown:a=>{"Enter"===a.key||" "===a.key?e(b):a.stopPropagation()},children:(0,c.jsxs)("div",{className:"line-clamp-3",children:[(0,c.jsx)("span",{className:"",children:d.pre}),(0,c.jsx)("span",{className:"font-bold text-red-500",children:d.match}),(0,c.jsx)("span",{className:"",children:d.post})]})})},co=({bookKey:a,results:b,onSelectResult:d})=>(0,c.jsx)("div",{className:"search-results overflow-y-auto p-2 font-sans text-sm font-light",children:(0,c.jsx)("ul",{className:"px-2",children:b.map((b,e)=>"subitems"in b?(0,c.jsxs)("ul",{children:[(0,c.jsx)("h3",{className:"line-clamp-1 font-normal",children:b.label}),(0,c.jsx)("ul",{children:b.subitems.map((b,e)=>(0,c.jsx)(cn,{bookKey:a,cfi:b.cfi,excerpt:b.excerpt,onSelectResult:d},`${e}-${b.cfi}`))})]},`${e}-${b.label}`):(0,c.jsx)(cn,{bookKey:a,cfi:b.cfi,excerpt:b.excerpt,onSelectResult:d},`${e}-${b.cfi}`))})}),cp=({onGoToLibrary:a})=>{let b=(0,f.useTranslation)(),{appService:g}=(0,e.useEnv)(),{updateAppTheme:i,safeAreaInsets:k}=(0,n.useThemeStore)(),{settings:l}=(0,h.useSettingsStore)(),{sideBarBookKey:m,setSideBarBookKey:p,getSearchNavState:q,setSearchTerm:r,clearSearch:t}=s(),{searchTerm:u="",searchResults:v=null}=(m?q(m):null)||{},{getBookData:w}=(0,P.useBookDataStore)(),{getView:y,getViewSettings:z}=(0,o.useReaderStore)(),[A,B]=(0,d.useState)(!1),C=(0,d.useRef)(u),D=(0,d.useRef)(1),E=window.innerWidth<640,{sideBarWidth:F,isSideBarPinned:G,isSideBarVisible:H,getSideBarWidth:I,setSideBarVisible:J,handleSideBarResize:K,handleSideBarTogglePin:L}=((a,b)=>{let{envConfig:c}=(0,e.useEnv)(),{settings:f}=(0,h.useSettingsStore)(),{sideBarWidth:g,isSideBarVisible:i,isSideBarPinned:j,getSideBarWidth:k,setSideBarWidth:l,setSideBarVisible:m,setSideBarPin:n,toggleSideBar:o,toggleSideBarPin:p}=s();return(0,d.useEffect)(()=>{l(a),n(b),m(b)},[]),{sideBarWidth:g,isSideBarPinned:j,isSideBarVisible:i,getSideBarWidth:k,handleSideBarResize:a=>{l(a),f.globalReadSettings.sideBarWidth=a},handleSideBarTogglePin:()=>{p(),j&&i&&m(!1);let a={...f.globalReadSettings,isSideBarPinned:!j};(0,aN.saveSysSettings)(c,"globalReadSettings",a)},setSideBarVisible:m,toggleSideBar:o}})(l.globalReadSettings.sideBarWidth,!E&&l.globalReadSettings.isSideBarPinned),M=async a=>{let{term:b,bookKey:c}=a.detail;J(!0),p(c),B(!0),null!=b&&r(c,b)},N=async()=>{let a=document.querySelector(".sidebar-pin-btn");a&&"none"!==window.getComputedStyle(a).display||J(!1)};(0,d.useEffect)(()=>{H?i("base-200"):i("base-100")},[H]),(0,d.useEffect)(()=>{C.current=u},[u]),(0,d.useEffect)(()=>(x.eventDispatcher.on("search-term",M),x.eventDispatcher.on("navigate",N),()=>{x.eventDispatcher.off("search-term",M),x.eventDispatcher.off("navigate",N)}),[]);let{handleDragStart:O}=(0,aA.useDrag)(a=>{if(!E)return;let b=a.clientY/window.innerHeight,c=Math.max(0,Math.min(1,b));D.current=c;let d=document.querySelector(".sidebar-container"),e=document.querySelector(".overlay");d&&e&&(d.style.top=`${100*c}%`,e.style.opacity=`${1-b}`)},()=>{},a=>{let b=document.querySelector(".sidebar-container"),c=document.querySelector(".overlay");if(b&&c)if(a.velocity>.5||a.velocity>=0&&a.clientY>=.5*window.innerHeight){let d=.15/Math.max(a.velocity,.5);b.style.transition=`top ${d}s ease-out`,b.style.top="100%",c.style.transition=`opacity ${d}s ease-out`,c.style.opacity="0",setTimeout(()=>J(!1),300),g?.hasHaptics&&(0,az.impactFeedback)("medium")}else b.style.transition="top 0.3s ease-out",b.style.top="0%",c.style.transition="opacity 0.3s ease-out",c.style.opacity="0.8",g?.hasHaptics&&(0,az.impactFeedback)("medium")}),{handleDragStart:Q,handleDragKeyDown:R}=(0,aA.useDrag)(a=>{let b=Math.max(.05,Math.min(.45,a.clientX/window.innerWidth));K(`${Math.round(1e4*b)/100}%`)},a=>{let b=parseFloat(I())/100,c=b;"ArrowLeft"===a.key?c=Math.max(.05,b-a.step):"ArrowRight"===a.key&&(c=Math.min(.45,b+a.step)),K(`${Math.round(1e4*c)/100}%`)}),S=(0,d.useCallback)(()=>{setTimeout(()=>{J(!0),B(!0)},100)},[]),T=(0,d.useCallback)(()=>{B(!1),setTimeout(()=>{m&&t(m)},100),y(m)?.clearSearch()},[m,t]),U=(0,d.useCallback)(()=>{C.current?T():G||J(!1)},[m,G]);if((0,aw.default)({onShowSearchBar:S,onEscape:U},[U]),!m)return null;let V=z(m),W=w(m);if(!W||!W.book||!W.bookDoc)return null;let{book:X,bookDoc:Y}=W,Z=(0,ai.getBookDirFromLanguage)(Y.metadata.language);return H?(0,c.jsxs)(c.Fragment,{children:[!G&&(0,c.jsx)(aB.Overlay,{className:(0,j.default)("z-[45]",V?.isEink?"":"bg-black/50 sm:bg-black/20"),onDismiss:()=>{J(!1)}}),(0,c.jsxs)("div",{role:"group","aria-label":b("Sidebar"),dir:V?.rtl&&"rtl"===Z?"rtl":"ltr",style:{width:`${F}`,maxWidth:"45%",position:G?"relative":"absolute",paddingTop:`${k?.top||0}px`},className:"jsx-fbb074d65c8317d1 "+((0,j.default)("sidebar-container flex min-w-60 select-none flex-col","full-height transition-[padding-top] duration-300",V?.isEink?"bg-base-100":"bg-base-200",g?.hasRoundedWindow&&"rounded-window-top-left rounded-window-bottom-left",G?"z-20":"z-[45] shadow-2xl",!G&&V?.isEink&&"border-base-content border-e")||""),children:[(0,c.jsx)(ay.default,{id:"fbb074d65c8317d1",children:"@media (width<=640px){.sidebar-container.jsx-fbb074d65c8317d1{border-top-left-radius:16px;border-top-right-radius:16px;width:100%;min-width:100%}.sidebar-container.open.jsx-fbb074d65c8317d1{top:0%}.overlay.jsx-fbb074d65c8317d1{transition:opacity .3s ease-in-out}}"}),(0,c.jsx)("div",{role:"slider",tabIndex:0,"aria-label":b("Resize Sidebar"),"aria-orientation":"horizontal","aria-valuenow":parseFloat(F),onMouseDown:Q,onTouchStart:Q,onKeyDown:R,className:"jsx-fbb074d65c8317d1 "+((0,j.default)("drag-bar absolute -right-2 top-0 h-full w-0.5 cursor-col-resize bg-transparent p-1",E&&"hidden")||"")}),(0,c.jsxs)("div",{className:"jsx-fbb074d65c8317d1 flex-shrink-0",children:[E&&(0,c.jsx)("div",{role:"slider",tabIndex:0,"aria-label":b("Resize Sidebar"),"aria-orientation":"vertical","aria-valuenow":D.current,onMouseDown:O,onTouchStart:O,className:"jsx-fbb074d65c8317d1 drag-handle flex h-10 w-full cursor-row-resize items-center justify-center",children:(0,c.jsx)("div",{className:"jsx-fbb074d65c8317d1 bg-base-content/50 h-1 w-10 rounded-full"})}),(0,c.jsx)(aR,{isPinned:G,isSearchBarVisible:A,onGoToLibrary:a,onClose:()=>J(!1),onTogglePin:L,onToggleSearchBar:()=>{B(a=>(a&&T(),!a))}}),(0,c.jsx)("div",{className:"jsx-fbb074d65c8317d1 "+((0,j.default)("search-bar",{"search-bar-visible":A})||""),children:(0,c.jsx)(cm,{isVisible:A,bookKey:m,onHideSearchBar:T})}),(0,c.jsx)("div",{className:"jsx-fbb074d65c8317d1 border-base-300/50 border-b px-3",children:(0,c.jsx)(cf,{book:X})})]}),A&&v?(0,c.jsx)(co,{bookKey:m,results:v,onSelectResult:a=>{N(),y(m)?.goTo(a)}}):(0,c.jsx)(cd,{bookDoc:Y,sideBarBookKey:m})]})]}):null};var cq=a.i(382541);let cr=({isPinned:a,isSearchBarVisible:b,handleClose:d,handleTogglePin:e,handleToggleSearchBar:g})=>{let h=(0,f.useTranslation)(),i=(0,aH.useResponsiveSize)(14),k=(0,aH.useResponsiveSize)(18);return(0,c.jsxs)("div",{className:"notebook-header relative flex h-11 items-center px-3",dir:"ltr",children:[(0,c.jsxs)("div",{className:"absolute inset-0 z-[-1] flex items-center justify-center space-x-2",children:[(0,c.jsx)(cq.LuNotebookPen,{size:k}),(0,c.jsx)("div",{className:"notebook-title hidden text-sm font-medium sm:flex",children:h("Notebook")})]}),(0,c.jsxs)("div",{className:"flex w-full items-center gap-x-4",children:[(0,c.jsx)("button",{title:h(a?"Unpin Notebook":"Pin Notebook"),onClick:e,className:(0,j.default)("btn btn-ghost btn-circle hidden h-6 min-h-6 w-6 sm:flex",a?"bg-base-300":"bg-base-300/65"),children:a?(0,c.jsx)(aF.MdPushPin,{size:i}):(0,c.jsx)(aF.MdOutlinePushPin,{size:i})}),(0,c.jsx)("button",{title:h("Close"),onClick:d,className:"btn btn-ghost btn-circle flex h-6 min-h-6 w-6 hover:bg-transparent sm:hidden",children:(0,c.jsx)(aF.MdArrowBackIosNew,{})})]}),(0,c.jsx)("div",{className:"flex items-center justify-end gap-x-4",children:(0,c.jsx)("button",{title:h(b?"Hide Search Bar":"Show Search Bar"),onClick:g,className:(0,j.default)("btn btn-ghost h-8 min-h-8 w-8 p-0",b&&"bg-base-300"),children:(0,c.jsx)(aE.FiSearch,{size:k})})})]})};var cs=a.i(446338);let ct=({onSave:a,onEdit:b})=>{let e=(0,f.useTranslation)(),{notebookNewAnnotation:g,notebookEditAnnotation:h,setNotebookNewAnnotation:i,setNotebookEditAnnotation:j,saveNotebookAnnotationDraft:k,getNotebookAnnotationDraft:l}=t(),m=(0,d.useRef)(null),[n,o]=(0,d.useState)(""),p=(0,aH.useResponsiveSize)(3);(0,d.useEffect)(()=>{if(h){let a=h.note;o(a),m.current?.setValue(a),m.current?.focus()}else if(g){let a=q();if(a){let b=l((0,cs.md5Fingerprint)(a))||"";o(b),m.current?.setValue(b),m.current?.focus()}}},[g,h]);let q=()=>h?.text||g?.text||"",r=()=>{let c=m.current?.getValue();c&&(g?a(g,c):h&&(h.note=c,b(h)))},s=()=>{g&&i(null),h&&j(null)};(0,aw.default)({onSaveNote:()=>{m.current?.getValue()&&r()},onEscape:s});let u=!!n.trim();return(0,c.jsxs)("div",{className:"content booknote-item note-editor-container bg-base-100 mt-2 rounded-md p-2",children:[(0,c.jsx)("div",{className:"flex w-full",children:(0,c.jsx)(b7,{ref:m,value:n,onChange:a=>{o(a)},onBlur:()=>{let a=m.current?.getValue();if(a){let b=q();b&&k((0,cs.md5Fingerprint)(b),a)}},onSave:r,onEscape:s,placeholder:e("Add your notes here..."),spellCheck:!1})}),(0,c.jsxs)("div",{className:"flex items-center pt-2",children:[(0,c.jsx)("div",{className:"me-2 mt-0.5 min-h-full self-stretch rounded-xl bg-gray-300",style:{minWidth:`${p}px`}}),(0,c.jsx)("div",{className:"content font-size-sm line-clamp-3",children:(0,c.jsx)("span",{className:"content font-size-xs text-gray-500",children:q()})})]}),(0,c.jsxs)("div",{className:"flex justify-end space-x-3 p-2",dir:"ltr",children:[(0,c.jsx)(b6,{onClick:s,children:e("Cancel")}),(0,c.jsx)(b6,{onClick:r,disabled:!u,children:e("Save")})]})]})},cu=({isVisible:a,bookKey:b,searchTerm:e,onSearchResultChange:g})=>{let h=(0,f.useTranslation)(),{getConfig:i}=(0,P.useBookDataStore)(),[j,k]=(0,d.useState)(e),l=(0,d.useRef)(null),m=(0,d.useRef)(null),n=(0,aH.useResponsiveSize)(16),o=(0,aH.useResponsiveSize)(12);(0,d.useEffect)(()=>{p(j)},[b]),(0,d.useEffect)(()=>{k(e),p(e)},[e]),(0,d.useEffect)(()=>{a&&l.current&&l.current.focus()},[a]),(0,d.useEffect)(()=>{let a=a=>{"Escape"===a.key&&l.current&&l.current.blur()};return window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a),m.current&&clearTimeout(m.current)}},[]);let p=a=>{a.trim().length>=1?q(a):r()},q=a=>{let c=i(b);if(!c)return void r();let{booknotes:d=[]}=c;g(((a,b)=>{if(!b.trim())return[];let c=b.toLowerCase();return a.filter(a=>{let b=a.text?.toLowerCase().includes(c)||!1,d=a.note?.toLowerCase().includes(c)||!1;return b||d})})(d.filter(a=>!a.deletedAt),a))},r=()=>{g(null)};return(0,c.jsx)("div",{className:"relative px-3 py-2",children:(0,c.jsxs)("div",{className:"bg-base-100 flex h-8 items-center rounded-lg",children:[(0,c.jsx)("div",{className:"pl-3",children:(0,c.jsx)(cg.FaSearch,{size:n,className:"text-base-content/50"})}),(0,c.jsx)("input",{ref:l,type:"text",value:j,spellCheck:!1,onChange:a=>{let b=a.target.value;k(b),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{p(b)},300)},placeholder:h("Search notes and excerpts..."),className:"w-full bg-transparent p-2 font-sans text-sm font-light focus:outline-none"}),j&&(0,c.jsx)("div",{className:"bg-base-300 flex h-8 w-8 items-center rounded-r-lg",children:(0,c.jsx)("button",{onClick:()=>{k(""),p(""),l.current&&l.current.focus()},className:"btn btn-ghost h-8 min-h-8 w-8 rounded-none rounded-r-lg p-0",children:(0,c.jsx)(cg.FaTimes,{size:o,className:"text-base-content/50"})})})]})})},cv=({})=>{let a=(0,f.useTranslation)(),{updateAppTheme:b,safeAreaInsets:g}=(0,n.useThemeStore)(),{envConfig:i,appService:k}=(0,e.useEnv)(),{settings:l}=(0,h.useSettingsStore)(),{sideBarBookKey:m}=s(),{notebookWidth:p,isNotebookVisible:q,isNotebookPinned:r}=t(),{notebookNewAnnotation:u,notebookEditAnnotation:v,setNotebookPin:w}=t(),{getBookData:y,getConfig:z,saveConfig:A,updateBooknotes:B}=(0,P.useBookDataStore)(),{getView:C,getViewSettings:D}=(0,o.useReaderStore)(),{getNotebookWidth:E,setNotebookWidth:F,setNotebookVisible:G,toggleNotebookPin:H}=t(),{setNotebookNewAnnotation:I,setNotebookEditAnnotation:J}=t(),[L,M]=(0,d.useState)(!1),[N,O]=(0,d.useState)(null),[Q,R]=(0,d.useState)(""),S=async()=>{let a=document.querySelector(".sidebar-pin-btn");a&&"none"!==window.getComputedStyle(a).display||G(!1)},T=(0,d.useCallback)(()=>{r||G(!1)},[r]);(0,aw.default)({onEscape:T},[T]),(0,d.useEffect)(()=>{q?b("base-200"):b("base-100")},[q]),(0,d.useEffect)(()=>(F(l.globalReadSettings.notebookWidth),w(l.globalReadSettings.isNotebookPinned),G(l.globalReadSettings.isNotebookPinned),x.eventDispatcher.on("navigate",S),()=>{x.eventDispatcher.off("navigate",S)}),[]);let U=a=>{F(a),l.globalReadSettings.notebookWidth=a},V=(a,b)=>{if(!m)return;let c=C(m),{booknotes:d=[]}=z(m),e=d.findIndex(b=>b.id===a.id);if(-1===e)return;b?a.deletedAt=Date.now():a.updatedAt=Date.now(),d[e]=a,c?.addAnnotation({...a,value:`${b3}${a.cfi}`},!0);let f=B(m,d);f&&A(i,m,f,l),J(null)},{handleDragStart:W,handleDragKeyDown:X}=(0,aA.useDrag)(a=>{let b=Math.max(.15,Math.min(.45,1-a.clientX/window.innerWidth));U(`${Math.round(1e4*b)/100}%`)},a=>{let b=parseFloat(E())/100,c=b;"ArrowLeft"===a.key?c=Math.max(.15,b+a.step):"ArrowRight"===a.key&&(c=Math.min(.45,b-a.step)),U(`${Math.round(1e4*c)/100}%`)}),{booknotes:Y=[]}=z(m)||{},Z=Y.filter(a=>"annotation"===a.type&&a.note&&!a.deletedAt).sort((a,b)=>b.createdAt-a.createdAt),$=Y.filter(a=>"excerpt"===a.type&&a.text&&!a.deletedAt).sort((a,b)=>a.createdAt-b.createdAt),_=(0,d.useMemo)(()=>L&&N?N.filter(a=>"annotation"===a.type&&a.note&&!a.deletedAt):Z,[Z,N,L]),aa=(0,d.useMemo)(()=>L&&N?N.filter(a=>"excerpt"===a.type&&a.text&&!a.deletedAt):$,[$,N,L]);if(!m)return null;let ab=y(m),ac=D(m);if(!ab||!ab.bookDoc)return null;let{bookDoc:ad}=ab,ae=(0,ai.getBookDirFromLanguage)(ad.metadata.language),af=_.length>0||aa.length>0,ag=Z.length>0||$.length>0;return q?(0,c.jsxs)(c.Fragment,{children:[!r&&(0,c.jsx)(aB.Overlay,{className:(0,j.default)("z-[45]",ac?.isEink?"":"bg-black/20"),onDismiss:()=>{G(!1),I(null),J(null)}}),(0,c.jsxs)("div",{role:"group","aria-label":a("Notebook"),dir:ac?.rtl&&"rtl"===ae?"rtl":"ltr",style:{width:`${p}`,maxWidth:"45%",position:r?"relative":"absolute",paddingTop:`${g?.top||0}px`},className:"jsx-790d1708c20552f7 "+((0,j.default)("notebook-container right-0 flex min-w-60 select-none flex-col","full-height font-sans text-base font-normal sm:text-sm",ac?.isEink?"bg-base-100":"bg-base-200",k?.hasRoundedWindow&&"rounded-window-top-right rounded-window-bottom-right",r?"z-20":"z-[45] shadow-2xl",!r&&ac?.isEink&&"border-base-content border-s")||""),children:[(0,c.jsx)(ay.default,{id:"790d1708c20552f7",children:"@media (width<=640px){.notebook-container.jsx-790d1708c20552f7{width:100%;min-width:100%}}"}),(0,c.jsx)("div",{role:"slider",tabIndex:0,"aria-label":a("Resize Notebook"),"aria-orientation":"horizontal","aria-valuenow":parseFloat(p),onMouseDown:W,onTouchStart:W,onKeyDown:X,className:"jsx-790d1708c20552f7 "+((0,j.default)("drag-bar absolute -left-2 top-0 h-full w-0.5 cursor-col-resize bg-transparent p-2")||"")}),(0,c.jsxs)("div",{className:"jsx-790d1708c20552f7 flex-shrink-0",children:[(0,c.jsx)(cr,{isPinned:r,isSearchBarVisible:L,handleClose:()=>G(!1),handleTogglePin:()=>{H();let a={...l.globalReadSettings,isNotebookPinned:!r};(0,aN.saveSysSettings)(i,"globalReadSettings",a)},handleToggleSearchBar:()=>{M(a=>!a),L&&(O(null),R(""))}}),(0,c.jsx)("div",{className:"jsx-790d1708c20552f7 "+((0,j.default)("search-bar",{"search-bar-visible":L})||""),children:(0,c.jsx)(cu,{isVisible:L,bookKey:m,searchTerm:Q,onSearchResultChange:O})})]}),(0,c.jsxs)("div",{className:"jsx-790d1708c20552f7 flex-grow overflow-y-auto px-3",children:[L&&N&&!af&&ag&&(0,c.jsx)("div",{className:"jsx-790d1708c20552f7 flex h-32 items-center justify-center text-gray-500",children:(0,c.jsx)("p",{className:"jsx-790d1708c20552f7 font-size-sm text-center",children:a("No notes match your search")})}),(0,c.jsx)("div",{dir:"ltr",className:"jsx-790d1708c20552f7",children:aa.length>0&&(0,c.jsxs)("p",{className:"jsx-790d1708c20552f7 content font-size-base",children:[a("Excerpts"),L&&N&&(0,c.jsxs)("span",{className:"jsx-790d1708c20552f7 font-size-xs ml-2 text-gray-500",children:["(",aa.length,")"]})]})}),(0,c.jsx)("ul",{className:"jsx-790d1708c20552f7 ",children:aa.map((b,d)=>(0,c.jsx)("li",{className:"jsx-790d1708c20552f7 my-2",children:(0,c.jsxs)("div",{role:"button",tabIndex:0,onKeyDown:a=>{("Backspace"===a.key||"Delete"===a.key)&&V(b,!0)},className:"jsx-790d1708c20552f7 booknote-item collapse-arrow border-base-300 bg-base-100 collapse border",children:[(0,c.jsx)("div",{style:{"--top-override":"1.25rem","--end-override":"0.7rem"},className:"jsx-790d1708c20552f7 "+((0,j.default)("collapse-title pe-8 text-sm font-medium","h-[2.5rem] min-h-[2.5rem] p-[0.6rem]")||""),children:(0,c.jsx)("p",{className:"jsx-790d1708c20552f7 line-clamp-1",children:b.text||`Excerpt ${d+1}`})}),(0,c.jsxs)("div",{className:"jsx-790d1708c20552f7 collapse-content font-size-xs select-text px-3 pb-0",children:[(0,c.jsx)("p",{className:"jsx-790d1708c20552f7 hyphens-auto text-justify",children:b.text}),(0,c.jsx)("div",{dir:"ltr",className:"jsx-790d1708c20552f7 flex justify-end",children:(0,c.jsx)("div",{onClick:V.bind(null,b,!0),"aria-label":a("Delete"),className:"jsx-790d1708c20552f7 font-size-xs cursor-pointer align-bottom text-red-500 hover:text-red-600",children:a("Delete")})})]})]})},`${d}-${b.id}`))}),(0,c.jsx)("div",{dir:"ltr",className:"jsx-790d1708c20552f7",children:(u||_.length>0)&&(0,c.jsxs)("p",{className:"jsx-790d1708c20552f7 content font-size-base",children:[a("Notes"),L&&N&&_.length>0&&(0,c.jsxs)("span",{className:"jsx-790d1708c20552f7 font-size-xs ml-2 text-gray-500",children:["(",_.length,")"]})]})}),(u||v)&&!L&&(0,c.jsx)(ct,{onSave:(a,b)=>{if(!m)return;let c=C(m),d=z(m),e=c?.getCFI(a.index,a.range);if(!e)return;let{booknotes:f=[]}=d,g={id:(0,K.uniqueId)(),type:"annotation",cfi:e,note:b,text:a.text,createdAt:Date.now(),updatedAt:Date.now()};c?.addAnnotation({...g,value:`${b3}${g.cfi}`}),f.push(g);let h=B(m,f);h&&A(i,m,h,l),I(null)},onEdit:a=>V(a,!1)}),(0,c.jsx)("ul",{className:"jsx-790d1708c20552f7",children:_.map((a,b)=>(0,c.jsx)(b8,{bookKey:m,item:a},`${b}-${a.cfi}`))})]})]})]}):null},cw=(a,b)=>a<=1?{columns:"1fr",rows:"1fr"}:2===a?b<1?{columns:"1fr",rows:"1fr 1fr"}:{columns:"1fr 1fr",rows:"1fr"}:3===a||4===a?{columns:"1fr 1fr",rows:"1fr 1fr"}:{columns:"1fr 1fr 1fr",rows:"1fr 1fr 1fr"},cx=a=>{let b=a.showHeader,c=a.showFooter,d=a.vertical||a.writingMode.includes("vertical"),e=a.marginPx||a.marginTopPx,f=a.compactMarginPx||a.compactMarginTopPx,g=a.marginBottomPx,h=a.compactMarginBottomPx,i=a.marginLeftPx,j=a.marginRightPx,k=a.compactMarginLeftPx,l=a.compactMarginRightPx;return{top:b&&!d?e:f,right:b&&d?j:l,bottom:c&&!d?g:h,left:c&&d?i:k}};var cy=a.i(466939);let cz=({bookKey:a,gridInsets:b,title:d,section:g,progress:h,showListButton:i=!0,hasPrevious:k,hasNext:l,previousLabel:m,nextLabel:n,previousTitle:p,nextTitle:q,showResultsTitle:r,closeTitle:s,onShowResults:t,onClose:u,onPrevious:v,onNext:w})=>{let{appService:x}=(0,e.useEnv)(),y=(0,f.useTranslation)(),{getViewSettings:z}=(0,o.useReaderStore)(),A=z(a),B=(0,aH.useResponsiveSize)(16),C=(0,aH.useResponsiveSize)(18),D=(0,aH.useResponsiveSize)(20),E=x?.isMobile||!A?.showHeader;return(0,c.jsxs)("div",{className:"results-nav-bar pointer-events-none absolute inset-0 z-30 flex flex-col items-center justify-between px-4 py-1",style:{top:b.top,right:b.right,bottom:b.bottom/4,left:b.left},children:[(0,c.jsxs)("div",{className:"bg-base-100 pointer-events-auto relative flex items-center justify-between overflow-hidden rounded-xl px-2 py-1 shadow-lg sm:gap-6",children:[void 0!==h&&h<1&&(0,c.jsx)("div",{className:"bg-base-200 absolute inset-y-0 left-0 transition-all duration-300",style:{width:`${100*h}%`}}),1===h&&(0,c.jsx)("div",{className:"bg-base-200 absolute inset-0"}),i&&t?(0,c.jsx)("button",{title:r||y("Show Results"),onClick:t,className:"btn btn-ghost relative z-10 h-8 min-h-8 w-8 p-0 hover:bg-transparent",children:(0,c.jsx)(ca.IoIosList,{size:D,className:"text-base-content"})}):(0,c.jsx)("div",{className:"relative z-10 w-8"}),(0,c.jsxs)("div",{className:"relative z-10 flex flex-1 flex-col items-center px-2",children:[(0,c.jsx)("span",{className:"line-clamp-1 text-sm font-medium",children:d}),g&&E&&(0,c.jsx)("span",{className:"text-base-content/70 line-clamp-1 text-xs",children:g})]}),(0,c.jsx)("button",{title:s||y("Close"),onClick:u,className:"btn btn-ghost relative z-10 h-8 min-h-8 w-8 p-0 hover:bg-transparent",children:(0,c.jsx)(ca.IoMdCloseCircle,{size:B})})]}),(0,c.jsxs)("div",{className:"bg-base-200 pointer-events-auto flex items-center justify-between gap-6 rounded-xl px-4 py-0 shadow-lg",children:[(0,c.jsxs)("button",{title:p||y("Previous"),onClick:v,disabled:!k,className:(0,j.default)("btn btn-ghost flex h-auto min-h-0 flex-1 flex-col items-center gap-0 p-1 hover:bg-transparent",!k&&"opacity-40 disabled:bg-transparent"),children:[(0,c.jsx)(cy.HiArrowLongLeft,{size:C,className:"text-base-content"}),(0,c.jsx)("span",{className:"text-sm font-medium",children:m||y("Previous")})]}),(0,c.jsxs)("button",{title:q||y("Next"),onClick:w,disabled:!l,className:(0,j.default)("btn btn-ghost flex h-auto min-h-0 flex-1 flex-col items-center gap-0 p-1 hover:bg-transparent",!l&&"opacity-40 disabled:bg-transparent"),children:[(0,c.jsx)(cy.HiArrowLongRight,{size:C,className:"text-base-content"}),(0,c.jsx)("span",{className:"text-sm font-medium",children:n||y("Next")})]})]})]})},cA=({bookKey:a,gridInsets:b})=>{let{searchTerm:e,searchProgress:g,currentSection:h,showSearchNav:i,hasPreviousPage:j,hasNextPage:k,handleShowResults:l,handleCloseSearch:m,handlePreviousResult:n,handleNextResult:p}=function(a){let{getView:b,getProgress:c}=(0,o.useReaderStore)(),{setSideBarVisible:e}=s(),{getSearchNavState:f,setSearchResultIndex:g,clearSearch:h}=s(),{searchTerm:i,searchResults:j,searchResultIndex:k,searchProgress:l}=f(a),m=c(a),n=(0,d.useMemo)(()=>m?.location,[m]),p=(0,d.useMemo)(()=>j?function(a){let b=[];for(let c of a)if("subitems"in c)for(let a of c.subitems)b.push({cfi:a.cfi,sectionLabel:c.label});else b.push({cfi:c.cfi,sectionLabel:""});return b}(j):[],[j]),q=p.length,r=j&&q>0,t=(0,d.useMemo)(()=>!p.length||k>=p.length?"":p[k]?.sectionLabel||"",[p,k]),u=(0,d.useMemo)(()=>{if(!p.length||!n)return{firstIndex:-1,lastIndex:-1};let b=-1,c=-1;for(let a=0;a<p.length;a++){let d=p[a];d&&b4(d.cfi,n)&&(-1===b&&(b=a),c=a)}return -1!==b&&setTimeout(()=>g(a,b),0),{firstIndex:b,lastIndex:c}},[p,n,a,g]),v=(0,d.useCallback)(c=>{if(!p.length||c<0||c>=p.length)return;let d=p[c];d&&(g(a,c),b(a)?.goTo(d.cfi))},[a,p,g,b]),w=(0,d.useCallback)(()=>{e(!0)},[e]),x=(0,d.useCallback)(()=>{h(a),b(a)?.clearSearch()},[h,a,b]),y=(0,d.useCallback)(()=>{let{firstIndex:a}=u;a>0?v(a-1):-1===a&&k>0&&v(k-1)},[u,k,v]),z=(0,d.useCallback)(()=>{let{lastIndex:a}=u;a>=0&&a<q-1?v(a+1):-1===a&&k<q-1&&v(k+1)},[u,q,k,v]),A=u.firstIndex>0||-1===u.firstIndex&&k>0,B=u.lastIndex>=0&&u.lastIndex<q-1||-1===u.lastIndex&&k<q-1;return{searchTerm:i,searchProgress:l,currentSection:t,searchResultIndex:k,totalResults:q,showSearchNav:r,hasPreviousPage:A,hasNextPage:B,handleShowResults:w,handleCloseSearch:x,handlePreviousResult:y,handleNextResult:z}}(a),q=(0,f.useTranslation)();return i?(0,c.jsx)(cz,{bookKey:a,gridInsets:b,title:q("Search results for '{{term}}'",{term:e}),section:h,progress:g,hasPrevious:j,hasNext:k,previousTitle:q("Previous Result"),nextTitle:q("Next Result"),showResultsTitle:q("Show Search Results"),closeTitle:q("Close Search"),onShowResults:l,onClose:m,onPrevious:n,onNext:p}):null},cB=({bookKey:a,gridInsets:b,toc:e})=>{let{activeBooknoteType:g,currentSection:h,showBooknotesNav:i,hasPreviousPage:j,hasNextPage:k,handleShowResults:l,handleClose:m,handlePrevious:n,handleNext:p}=function(a,b){let{getView:c,getProgress:e}=(0,o.useReaderStore)(),{getConfig:f}=(0,P.useBookDataStore)(),{setSideBarVisible:g,getBooknotesNavState:h,setActiveBooknoteType:i,setBooknoteResults:j,setBooknoteIndex:k,clearBooknotesNav:l}=s(),{activeBooknoteType:m,booknoteResults:n,booknoteIndex:p}=h(a),q=e(a),r=q?.location,t=(0,d.useMemo)(()=>{let b=f(a);return b?.booknotes?.filter(a=>!a.deletedAt)||[]},[a,f]),u=(0,d.useMemo)(()=>n?[...n].sort((a,b)=>a0.compare(a.cfi,b.cfi)):[],[n]),v=u.length,w=n&&v>0,x=(0,d.useMemo)(()=>{if(!u.length||p>=u.length)return"";let a=u[p];if(!a)return"";let c=(0,aU.findTocItemBS)(b,a.cfi);return c?.label||""},[u,p,b]),y=(0,d.useMemo)(()=>{if(!u.length||!r)return{firstIndex:-1,lastIndex:-1};let b=-1,c=-1;for(let a=0;a<u.length;a++){let d=u[a];d&&b4(d.cfi,r)&&(-1===b&&(b=a),c=a)}return -1!==b&&setTimeout(()=>k(a,b),0),{firstIndex:b,lastIndex:c}},[u,r,a,k]),z=(0,d.useCallback)(b=>{if(!u.length||b<0||b>=u.length)return;let d=u[b];d&&(k(a,b),c(a)?.goTo(d.cfi))},[a,u,k,c]),A=(0,d.useCallback)(b=>{let d=t.filter(a=>a.type===b);if(0===d.length)return;let e=[...d].sort((a,b)=>a0.compare(a.cfi,b.cfi));i(a,b),j(a,e),k(a,0),e.length>0&&c(a)?.goTo(e[0].cfi)},[t,a,i,j,k,c]),B=(0,d.useCallback)(()=>{g(!0)},[g]),C=(0,d.useCallback)(()=>{l(a)},[l,a]),D=(0,d.useCallback)(()=>{let{firstIndex:a}=y;a>0?z(a-1):-1===a&&p>0&&z(p-1)},[y,p,z]),E=(0,d.useCallback)(()=>{let{lastIndex:a}=y;a>=0&&a<v-1?z(a+1):-1===a&&p<v-1&&z(p+1)},[y,v,p,z]),F=y.firstIndex>0||-1===y.firstIndex&&p>0,G=y.lastIndex>=0&&y.lastIndex<v-1||-1===y.lastIndex&&p<v-1,H=(0,d.useMemo)(()=>t.filter(a=>"bookmark"===a.type).length,[t]);return{activeBooknoteType:m,currentSection:x,booknoteIndex:p,totalResults:v,showBooknotesNav:w&&null!==m,hasPreviousPage:F,hasNextPage:G,bookmarkCount:H,annotationCount:(0,d.useMemo)(()=>t.filter(a=>"annotation"===a.type).length,[t]),excerptCount:(0,d.useMemo)(()=>t.filter(a=>"excerpt"===a.type).length,[t]),startNavigation:A,handleShowResults:B,handleClose:C,handlePrevious:D,handleNext:E}}(a,e),q=(0,f.useTranslation)();if(!i)return null;let r=()=>{switch(g){case"bookmark":return q("Bookmarks");case"annotation":return q("Annotations");case"excerpt":return q("Excerpts");default:return""}};return(0,c.jsx)(cz,{bookKey:a,gridInsets:b,title:r(),section:h,hasPrevious:j,hasNext:k,progress:1,previousTitle:q("Previous"),nextTitle:q("Next"),showResultsTitle:r(),closeTitle:q("Close"),onShowResults:l,onClose:m,onPrevious:n,onNext:p})};var cC=a.i(810076),cD=a.i(391830);let cE=(a,b)=>{let c=b?.onLoad,e=b?.onRelocate,f=b?.onLinkClick,g=b?.onRendererRelocate,h=b?.onDrawAnnotation,i=b?.onShowAnnotation;(0,d.useEffect)(()=>{if(a)return c&&a.addEventListener("load",c),e&&a.addEventListener("relocate",e),f&&a.addEventListener("link",f),g&&a.renderer.addEventListener("relocate",g),h&&a.addEventListener("draw-annotation",h),i&&a.addEventListener("show-annotation",i),()=>{c&&a.removeEventListener("load",c),e&&a.removeEventListener("relocate",e),f&&a.removeEventListener("link",f),g&&a.renderer.removeEventListener("relocate",g),h&&a.removeEventListener("draw-annotation",h),i&&a.removeEventListener("show-annotation",i)}},[a])};var cF=a.i(996925),cG=a.i(653221);class cH{document;spineItemIndex;constructor(a,b=0){this.document=a,this.spineItemIndex=b}static extractSpineIndex(a){try{if(a.startsWith("epubcfi(")){let b=(0,a0.collapse)((0,a0.parse)(a)),c=b[0]?.[1]?.index;if(void 0===c)throw Error("Cannot extract spine index from CFI");return Math.floor((c-2)/2)}if(a.startsWith("/body/DocFragment[")){let b=a.match(/DocFragment\[(\d+)\]/);if(b)return parseInt(b[1],10)-1;throw Error("Cannot extract spine index from XPath")}throw Error("Unsupported format for spine index extraction")}catch(b){throw Error(`Cannot extract spine index from CFI/XPointer: ${a} - ${b}`)}}xPointerToCFI(a,b){try{if(b)return this.convertRangeXPointerToCFI(a,b);return this.convertPointXPointerToCFI(a)}catch(b){throw Error(`Failed to convert XPointer ${a}: ${b}`)}}cfiToXPointer(a){try{let b=(0,a0.parse)(a);if(b.parent){let a=a0.fake.toIndex(b.parent.shift());if(a!==this.spineItemIndex)throw Error(`CFI spine index ${a} does not match converter spine index ${this.spineItemIndex}`);let c=(0,a0.toRange)(this.document,b),d=this.rangePointToXPointer(c.startContainer,c.startOffset),e=this.rangePointToXPointer(c.endContainer,c.endOffset);return{xpointer:d,pos0:d,pos1:e}}let c=(0,a0.collapse)(b),d=a0.fake.toIndex(b.shift());if(d!==this.spineItemIndex)throw Error(`CFI spine index ${d} does not match converter spine index ${this.spineItemIndex}`);let e=(0,a0.toElement)(this.document,b[0]);if(!e)throw Error(`Element not found for CFI: ${a}`);let f=c[c.length-1]?.[c[c.length-1].length-1],g=f?.offset;return{xpointer:void 0!==g?this.handleTextOffset(e,g):this.buildXPointerPath(e)}}catch(b){throw Error(`Failed to convert CFI ${a}: ${b}`)}}validateCFI(a){try{return(0,a0.parse)(a),this.cfiToXPointer(a),!0}catch{return!1}}validateXPointer(a,b){try{return this.xPointerToCFI(a,b),!0}catch{return!1}}convertPointXPointerToCFI(a){let{element:b,textOffset:c}=this.parseXPointer(a),d=this.document.createRange();if(void 0!==c){let a=this.findTextNodeAtOffset(b,c);a?(d.setStart(a.node,a.offset),d.setEnd(a.node,a.offset)):(d.setStart(b,0),d.setEnd(b,0))}else d.setStart(b,0),d.setEnd(b,0);let e=(0,a0.fromRange)(d);return this.adjustSpineIndex(e)}convertRangeXPointerToCFI(a,b){let c=this.parseXPointer(a),d=this.parseXPointer(b),e=this.document.createRange();if(void 0!==c.textOffset){let a=this.findTextNodeAtOffset(c.element,c.textOffset);a?e.setStart(a.node,a.offset):e.setStart(c.element,0)}else e.setStart(c.element,0);if(void 0!==d.textOffset){let a=this.findTextNodeAtOffset(d.element,d.textOffset);a?e.setEnd(a.node,a.offset):e.setEnd(d.element,0)}else e.setEnd(d.element,0);let f=(0,a0.fromRange)(e);return this.adjustSpineIndex(f)}parseXPointer(a){let b=a.match(/\/text\(\)\.(\d+)$/),c=b?parseInt(b[1],10):void 0,d=void 0!==c?a.replace(/\/text\(\)\.\d+$/,""):a,e=this.resolveXPointerPath(d);if(!e)throw Error(`Cannot resolve XPointer path: ${d}`);return{element:e,textOffset:c}}resolveXPointerPath(a){let b=a.match(/^\/body\/DocFragment\[\d+\]\/body(.*)$/);if(!b)throw Error(`Invalid XPointer format: ${a}`);let c=b[1],d=this.document.body;if(!c||""===c)return d;for(let a of c.split("/").filter(Boolean)){let b,c,e=a.match(/^(\w+)\[(\d+)\]$/),f=a.match(/^(\w+)$/);if(e){let[,a,d]=e;b=a,c=Math.max(0,parseInt(d,10)-1)}else if(f){let[,a]=f;b=a,c=0}else throw Error(`Invalid XPointer segment: ${a}`);let g=Array.from(d.children).filter(a=>a.tagName.toLowerCase()===b?.toLowerCase());if(c>=g.length)throw Error(`Element index ${c} out of bounds for tag ${b}`);d=g[c]}return d}findTextNodeAtOffset(a,b){let c=[];this.collectTextNodes(a,c);let d=0;for(let a of c){let c=(a.textContent||"").length;if(d+c>=b)return{node:a,offset:b-d};d+=c}if(c.length>0){let a=c[c.length-1];return{node:a,offset:(a.textContent||"").length}}return null}adjustSpineIndex(a){let b=a.match(/^epubcfi\((.+)\)$/);if(!b)throw Error(`Invalid CFI format: ${a}`);let c=b[1],d=(this.spineItemIndex+1)*2;if(c.match(/^\/6\/\d+!/)){let a=c.replace(/^\/6\/\d+!/,`/6/${d}!`);return`epubcfi(${a})`}{let a=`/6/${d}!${c}`;return`epubcfi(${a})`}}rangePointToXPointer(a,b){if(a.nodeType===Node.TEXT_NODE){let c=a.parentElement||this.document.documentElement;return this.handleTextOffsetInElement(c,a,b)}if(a.nodeType!==Node.ELEMENT_NODE)return this.buildXPointerPath(this.document.documentElement);if(0===b)return a.childNodes.length>0&&a.childNodes[0].nodeType===Node.ELEMENT_NODE?this.buildXPointerPath(a.childNodes[0]):this.buildXPointerPath(a);{let c=Array.from(a.childNodes),d=c[b-1]||c[c.length-1];return d?.nodeType===Node.ELEMENT_NODE?this.buildXPointerPath(d):d?.nodeType===Node.TEXT_NODE?this.handleTextOffsetInElement(a,d,d.textContent?.length||0):this.buildXPointerPath(a)}}buildXPointerPath(a){let b=[],c=a;for(;c&&c!==this.document.documentElement;){let a=c.parentElement;if(!a)break;let d=c.tagName.toLowerCase(),e=0,f=0;for(let b of Array.from(a.children))b.tagName.toLowerCase()===d&&(b===c&&(e=f),f++);1===f?b.unshift(d):b.unshift(`${d}[${e+1}]`),c=a}let d=`/body/DocFragment[${this.spineItemIndex+1}]`;return b.length>0&&b[0].startsWith("body")&&b.shift(),d+="/body",b.length>0&&(d+="/"+b.join("/")),d}handleTextOffset(a,b){let c=[];this.collectTextNodes(a,c);let d=0,e=null,f=0;for(let a of c){let c=(a.textContent||"").length;if(d+c>=b){e=a,f=b-d;break}d+=c}if(!e)return this.buildXPointerPath(a);let g=e.parentElement;for(;g&&!this.isSignificantElement(g);)g=g.parentElement;g||(g=a);let h=this.buildXPointerPath(g);return`${h}/text().${f}`}handleTextOffsetInElement(a,b,c){let d=[];this.collectTextNodes(a,d);let e=0;for(let a of d){if(a===b){e+=c;break}e+=(a.textContent||"").length}return this.handleTextOffset(a,e)}collectTextNodes(a,b){for(let c of Array.from(a.childNodes))c.nodeType===Node.TEXT_NODE?(c.textContent||"").length>0&&b.push(c):c.nodeType===Node.ELEMENT_NODE&&this.collectTextNodes(c,b)}isSignificantElement(a){let b=a.tagName.toLowerCase();return!new Set(["span","em","strong","i","b","u","small","mark","sup","sub"]).has(b)}}let cI=async(a,b,c,d)=>{let e,f=cH.extractSpineIndex(a);if(c===f&&b)e=new cH(b,c||0);else{let a=await d?.sections?.[f]?.createDocument();if(!a)throw Error("Failed to load document for XPointer conversion.");e=new cH(a,f||0)}return e.xPointerToCFI(a)},cJ=async(a,b,c,d)=>{let e,f=cH.extractSpineIndex(a);if(c===f&&b)e=new cH(b,c||0);else{let a=await d?.sections?.[f]?.createDocument();if(!a)throw Error("Failed to load document for CFI conversion.");e=new cH(a,f||0)}return e.cfiToXPointer(a)},cK=a=>{let b=/\/text\(\).*$/;a.match(b)&&(a=a.replace(b,""));let c=/\.\d+$/;return a.match(c)&&(a=a.replace(c,"")),a};var cL=a.i(933912),cM=a.i(189416),cN=a.i(168780),cO=a.i(19229);let cP=0,cQ=null,cR={key:"",code:"",ctrlKey:!1,shiftKey:!1,altKey:!1,metaKey:!1},cS=a=>a&&"ctrlKey"in a?{key:cR.key,code:cR.code,ctrlKey:a.ctrlKey,shiftKey:a.shiftKey,altKey:a.altKey,metaKey:a.metaKey}:{...cR},cT=(a,b)=>{cR={key:b.key,code:b.code,ctrlKey:b.ctrlKey,shiftKey:b.shiftKey,altKey:b.altKey,metaKey:b.metaKey},["Backspace"].includes(b.key)&&b.preventDefault(),window.postMessage({type:"iframe-keydown",bookKey:a,key:b.key,code:b.code,ctrlKey:b.ctrlKey,shiftKey:b.shiftKey,altKey:b.altKey,metaKey:b.metaKey},"*")},cU=(a,b)=>{cR={key:"",code:"",ctrlKey:b.ctrlKey,shiftKey:b.shiftKey,altKey:b.altKey,metaKey:b.metaKey},window.postMessage({type:"iframe-keyup",bookKey:a,key:b.key,code:b.code,ctrlKey:b.ctrlKey,shiftKey:b.shiftKey,altKey:b.altKey,metaKey:b.metaKey},"*")},cV=(a,b)=>{cQ=setTimeout(()=>{cQ=null},ap.LONG_HOLD_THRESHOLD),window.postMessage({type:"iframe-mousedown",bookKey:a,button:b.button,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,offsetX:b.offsetX,offsetY:b.offsetY,...cS(b)},"*")},cW=(a,b)=>{[3,4].includes(b.button)&&b.preventDefault(),window.postMessage({type:"iframe-mouseup",bookKey:a,button:b.button,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,offsetX:b.offsetX,offsetY:b.offsetY,...cS(b)},"*")},cX=(a,b)=>{window.postMessage({type:"iframe-wheel",bookKey:a,deltaMode:b.deltaMode,deltaX:b.deltaX,deltaY:b.deltaY,deltaZ:b.deltaZ,screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,offsetX:b.offsetX,offsetY:b.offsetY,...cS(b)},"*")},cY=(a,b,c)=>{let d=Date.now();if(!b.current&&d-cP<ap.DOUBLE_CLICK_INTERVAL_THRESHOLD_MS){cP=d,window.postMessage({type:"iframe-double-click",bookKey:a,screenX:c.screenX,screenY:c.screenY,clientX:c.clientX,clientY:c.clientY,offsetX:c.offsetX,offsetY:c.offsetY,...cS(c)},"*");return}cP=d;let e=()=>{let b=c.target;if(b?.closest("sup, a, audio, video")&&!b?.closest("a.duokan-footnote:not([href])"))return;let d=b?.closest(".js_readerFooterNote, .zhangyue-footnote, .duokan-footnote");d?x.eventDispatcher.dispatch("footnote-popup",{bookKey:a,element:d,footnote:d.getAttribute("data-wr-footernote")||d.getAttribute("zy-footnote")||d.getAttribute("alt")||b?.getAttribute("alt")||""}):cQ&&window.postMessage({type:"iframe-single-click",bookKey:a,screenX:c.screenX,screenY:c.screenY,clientX:c.clientX,clientY:c.clientY,offsetX:c.offsetX,offsetY:c.offsetY,...cS(c)},"*")};b.current?e():setTimeout(()=>{Date.now()-cP>=ap.DOUBLE_CLICK_INTERVAL_THRESHOLD_MS&&e()},ap.DOUBLE_CLICK_INTERVAL_THRESHOLD_MS)},cZ=(a,b,c)=>{let d=b.targetTouches[0],e=[];d&&e.push({clientX:d.clientX,clientY:d.clientY,screenX:d.screenX,screenY:d.screenY}),window.postMessage({type:c,bookKey:a,timeStamp:Date.now(),targetTouches:e,...cS(b)},"*")},c$=(a,b)=>{cZ(a,b,"iframe-touchstart")},c_=(a,b)=>{cZ(a,b,"iframe-touchmove")},c0=(a,b)=>{cZ(a,b,"iframe-touchend")};var c1=a.i(711135),c2=a.i(243648);let c3={"":"","":"","":"","":"","":"","":"","":"","":""},c4={"":"","":"","":"","":"","":"","":"","":"","":""},c5={"":"","":"","":"","":"","":"","":"","":"","":""},{entries:c6,setPrototypeOf:c7,isFrozen:c8,getPrototypeOf:c9,getOwnPropertyDescriptor:da}=Object,{freeze:db,seal:dc,create:dd}=Object,{apply:de,construct:df}="undefined"!=typeof Reflect&&Reflect;db||(db=function(a){return a}),dc||(dc=function(a){return a}),de||(de=function(a,b){for(var c=arguments.length,d=Array(c>2?c-2:0),e=2;e<c;e++)d[e-2]=arguments[e];return a.apply(b,d)}),df||(df=function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return new a(...c)});let dg=dv(Array.prototype.forEach),dh=dv(Array.prototype.lastIndexOf),di=dv(Array.prototype.pop),dj=dv(Array.prototype.push),dk=dv(Array.prototype.splice),dl=dv(String.prototype.toLowerCase),dm=dv(String.prototype.toString),dn=dv(String.prototype.match),dp=dv(String.prototype.replace),dq=dv(String.prototype.indexOf),dr=dv(String.prototype.trim),ds=dv(Object.prototype.hasOwnProperty),dt=dv(RegExp.prototype.test),du=(b=TypeError,function(){for(var a=arguments.length,c=Array(a),d=0;d<a;d++)c[d]=arguments[d];return df(b,c)});function dv(a){return function(b){b instanceof RegExp&&(b.lastIndex=0);for(var c=arguments.length,d=Array(c>1?c-1:0),e=1;e<c;e++)d[e-1]=arguments[e];return de(a,b,d)}}function dw(a,b){let c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:dl;c7&&c7(a,null);let d=b.length;for(;d--;){let e=b[d];if("string"==typeof e){let a=c(e);a!==e&&(c8(b)||(b[d]=a),e=a)}a[e]=!0}return a}function dx(a){let b=dd(null);for(let[c,d]of c6(a))ds(a,c)&&(Array.isArray(d)?b[c]=function(a){for(let b=0;b<a.length;b++)ds(a,b)||(a[b]=null);return a}(d):d&&"object"==typeof d&&d.constructor===Object?b[c]=dx(d):b[c]=d);return b}function dy(a,b){for(;null!==a;){let c=da(a,b);if(c){if(c.get)return dv(c.get);if("function"==typeof c.value)return dv(c.value)}a=c9(a)}return function(){return null}}let dz=db(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),dA=db(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),dB=db(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),dC=db(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),dD=db(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),dE=db(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),dF=db(["#text"]),dG=db(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),dH=db(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),dI=db(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),dJ=db(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),dK=dc(/\{\{[\w\W]*|[\w\W]*\}\}/gm),dL=dc(/<%[\w\W]*|[\w\W]*%>/gm),dM=dc(/\$\{[\w\W]*/gm),dN=dc(/^data-[\-\w.\u00B7-\uFFFF]+$/),dO=dc(/^aria-[\-\w]+$/),dP=dc(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),dQ=dc(/^(?:\w+script|data):/i),dR=dc(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),dS=dc(/^html$/i);var dT=Object.freeze({__proto__:null,ARIA_ATTR:dO,ATTR_WHITESPACE:dR,CUSTOM_ELEMENT:dc(/^[a-z][.\w]*(-[.\w]+)+$/i),DATA_ATTR:dN,DOCTYPE_NAME:dS,ERB_EXPR:dL,IS_ALLOWED_URI:dP,IS_SCRIPT_OR_DATA:dQ,MUSTACHE_EXPR:dK,TMPLIT_EXPR:dM});let dU=function(a,b){if("object"!=typeof a||"function"!=typeof a.createPolicy)return null;let c=null,d="data-tt-policy-suffix";b&&b.hasAttribute(d)&&(c=b.getAttribute(d));let e="dompurify"+(c?"#"+c:"");try{return a.createPolicy(e,{createHTML:a=>a,createScriptURL:a=>a})}catch(a){return console.warn("TrustedTypes policy "+e+" could not be created."),null}},dV=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};var dW=function a(){let b,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,d=b=>a(b);if(d.version="3.3.0",d.removed=[],!c||!c.document||9!==c.document.nodeType||!c.Element)return d.isSupported=!1,d;let{document:e}=c,f=e,g=f.currentScript,{DocumentFragment:h,HTMLTemplateElement:i,Node:j,Element:k,NodeFilter:l,NamedNodeMap:m=c.NamedNodeMap||c.MozNamedAttrMap,HTMLFormElement:n,DOMParser:o,trustedTypes:p}=c,q=k.prototype,r=dy(q,"cloneNode"),s=dy(q,"remove"),t=dy(q,"nextSibling"),u=dy(q,"childNodes"),v=dy(q,"parentNode");if("function"==typeof i){let a=e.createElement("template");a.content&&a.content.ownerDocument&&(e=a.content.ownerDocument)}let w="",{implementation:x,createNodeIterator:y,createDocumentFragment:z,getElementsByTagName:A}=e,{importNode:B}=f,C=dV();d.isSupported="function"==typeof c6&&"function"==typeof v&&x&&void 0!==x.createHTMLDocument;let{MUSTACHE_EXPR:D,ERB_EXPR:E,TMPLIT_EXPR:F,DATA_ATTR:G,ARIA_ATTR:H,IS_SCRIPT_OR_DATA:I,ATTR_WHITESPACE:J,CUSTOM_ELEMENT:K}=dT,{IS_ALLOWED_URI:L}=dT,M=null,N=dw({},[...dz,...dA,...dB,...dD,...dF]),O=null,P=dw({},[...dG,...dH,...dI,...dJ]),Q=Object.seal(dd(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),R=null,S=null,T=Object.seal(dd(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),U=!0,V=!0,W=!1,X=!0,Y=!1,Z=!0,$=!1,_=!1,aa=!1,ab=!1,ac=!1,ad=!1,ae=!0,af=!1,ag=!0,ah=!1,ai={},aj=null,ak=dw({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),al=null,am=dw({},["audio","video","img","source","image","track"]),an=null,ao=dw({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),ap="http://www.w3.org/1998/Math/MathML",aq="http://www.w3.org/2000/svg",ar="http://www.w3.org/1999/xhtml",as=ar,at=!1,au=null,av=dw({},[ap,aq,ar],dm),aw=dw({},["mi","mo","mn","ms","mtext"]),ax=dw({},["annotation-xml"]),ay=dw({},["title","style","font","a","script"]),az=null,aA=["application/xhtml+xml","text/html"],aB=null,aC=null,aD=e.createElement("form"),aE=function(a){return a instanceof RegExp||a instanceof Function},aF=function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!aC||aC!==a){if(a&&"object"==typeof a||(a={}),a=dx(a),aB="application/xhtml+xml"===(az=-1===aA.indexOf(a.PARSER_MEDIA_TYPE)?"text/html":a.PARSER_MEDIA_TYPE)?dm:dl,M=ds(a,"ALLOWED_TAGS")?dw({},a.ALLOWED_TAGS,aB):N,O=ds(a,"ALLOWED_ATTR")?dw({},a.ALLOWED_ATTR,aB):P,au=ds(a,"ALLOWED_NAMESPACES")?dw({},a.ALLOWED_NAMESPACES,dm):av,an=ds(a,"ADD_URI_SAFE_ATTR")?dw(dx(ao),a.ADD_URI_SAFE_ATTR,aB):ao,al=ds(a,"ADD_DATA_URI_TAGS")?dw(dx(am),a.ADD_DATA_URI_TAGS,aB):am,aj=ds(a,"FORBID_CONTENTS")?dw({},a.FORBID_CONTENTS,aB):ak,R=ds(a,"FORBID_TAGS")?dw({},a.FORBID_TAGS,aB):dx({}),S=ds(a,"FORBID_ATTR")?dw({},a.FORBID_ATTR,aB):dx({}),ai=!!ds(a,"USE_PROFILES")&&a.USE_PROFILES,U=!1!==a.ALLOW_ARIA_ATTR,V=!1!==a.ALLOW_DATA_ATTR,W=a.ALLOW_UNKNOWN_PROTOCOLS||!1,X=!1!==a.ALLOW_SELF_CLOSE_IN_ATTR,Y=a.SAFE_FOR_TEMPLATES||!1,Z=!1!==a.SAFE_FOR_XML,$=a.WHOLE_DOCUMENT||!1,ab=a.RETURN_DOM||!1,ac=a.RETURN_DOM_FRAGMENT||!1,ad=a.RETURN_TRUSTED_TYPE||!1,aa=a.FORCE_BODY||!1,ae=!1!==a.SANITIZE_DOM,af=a.SANITIZE_NAMED_PROPS||!1,ag=!1!==a.KEEP_CONTENT,ah=a.IN_PLACE||!1,L=a.ALLOWED_URI_REGEXP||dP,as=a.NAMESPACE||ar,aw=a.MATHML_TEXT_INTEGRATION_POINTS||aw,ax=a.HTML_INTEGRATION_POINTS||ax,Q=a.CUSTOM_ELEMENT_HANDLING||{},a.CUSTOM_ELEMENT_HANDLING&&aE(a.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(Q.tagNameCheck=a.CUSTOM_ELEMENT_HANDLING.tagNameCheck),a.CUSTOM_ELEMENT_HANDLING&&aE(a.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(Q.attributeNameCheck=a.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),a.CUSTOM_ELEMENT_HANDLING&&"boolean"==typeof a.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements&&(Q.allowCustomizedBuiltInElements=a.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Y&&(V=!1),ac&&(ab=!0),ai&&(M=dw({},dF),O=[],!0===ai.html&&(dw(M,dz),dw(O,dG)),!0===ai.svg&&(dw(M,dA),dw(O,dH),dw(O,dJ)),!0===ai.svgFilters&&(dw(M,dB),dw(O,dH),dw(O,dJ)),!0===ai.mathMl&&(dw(M,dD),dw(O,dI),dw(O,dJ))),a.ADD_TAGS&&("function"==typeof a.ADD_TAGS?T.tagCheck=a.ADD_TAGS:(M===N&&(M=dx(M)),dw(M,a.ADD_TAGS,aB))),a.ADD_ATTR&&("function"==typeof a.ADD_ATTR?T.attributeCheck=a.ADD_ATTR:(O===P&&(O=dx(O)),dw(O,a.ADD_ATTR,aB))),a.ADD_URI_SAFE_ATTR&&dw(an,a.ADD_URI_SAFE_ATTR,aB),a.FORBID_CONTENTS&&(aj===ak&&(aj=dx(aj)),dw(aj,a.FORBID_CONTENTS,aB)),ag&&(M["#text"]=!0),$&&dw(M,["html","head","body"]),M.table&&(dw(M,["tbody"]),delete R.tbody),a.TRUSTED_TYPES_POLICY){if("function"!=typeof a.TRUSTED_TYPES_POLICY.createHTML)throw du('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if("function"!=typeof a.TRUSTED_TYPES_POLICY.createScriptURL)throw du('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');w=(b=a.TRUSTED_TYPES_POLICY).createHTML("")}else void 0===b&&(b=dU(p,g)),null!==b&&"string"==typeof w&&(w=b.createHTML(""));db&&db(a),aC=a}},aG=dw({},[...dA,...dB,...dC]),aH=dw({},[...dD,...dE]),aI=function(a){let b=v(a);b&&b.tagName||(b={namespaceURI:as,tagName:"template"});let c=dl(a.tagName),d=dl(b.tagName);return!!au[a.namespaceURI]&&(a.namespaceURI===aq?b.namespaceURI===ar?"svg"===c:b.namespaceURI===ap?"svg"===c&&("annotation-xml"===d||aw[d]):!!aG[c]:a.namespaceURI===ap?b.namespaceURI===ar?"math"===c:b.namespaceURI===aq?"math"===c&&ax[d]:!!aH[c]:a.namespaceURI===ar?(b.namespaceURI!==aq||!!ax[d])&&(b.namespaceURI!==ap||!!aw[d])&&!aH[c]&&(ay[c]||!aG[c]):"application/xhtml+xml"===az&&!!au[a.namespaceURI])},aJ=function(a){dj(d.removed,{element:a});try{v(a).removeChild(a)}catch(b){s(a)}},aK=function(a,b){try{dj(d.removed,{attribute:b.getAttributeNode(a),from:b})}catch(a){dj(d.removed,{attribute:null,from:b})}if(b.removeAttribute(a),"is"===a)if(ab||ac)try{aJ(b)}catch(a){}else try{b.setAttribute(a,"")}catch(a){}},aL=function(a){let c=null,d=null;if(aa)a="<remove></remove>"+a;else{let b=dn(a,/^[\r\n\t ]+/);d=b&&b[0]}"application/xhtml+xml"===az&&as===ar&&(a='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+a+"</body></html>");let f=b?b.createHTML(a):a;if(as===ar)try{c=new o().parseFromString(f,az)}catch(a){}if(!c||!c.documentElement){c=x.createDocument(as,"template",null);try{c.documentElement.innerHTML=at?w:f}catch(a){}}let g=c.body||c.documentElement;return(a&&d&&g.insertBefore(e.createTextNode(d),g.childNodes[0]||null),as===ar)?A.call(c,$?"html":"body")[0]:$?c.documentElement:g},aM=function(a){return y.call(a.ownerDocument||a,a,l.SHOW_ELEMENT|l.SHOW_COMMENT|l.SHOW_TEXT|l.SHOW_PROCESSING_INSTRUCTION|l.SHOW_CDATA_SECTION,null)},aN=function(a){return a instanceof n&&("string"!=typeof a.nodeName||"string"!=typeof a.textContent||"function"!=typeof a.removeChild||!(a.attributes instanceof m)||"function"!=typeof a.removeAttribute||"function"!=typeof a.setAttribute||"string"!=typeof a.namespaceURI||"function"!=typeof a.insertBefore||"function"!=typeof a.hasChildNodes)},aO=function(a){return"function"==typeof j&&a instanceof j};function aP(a,b,c){dg(a,a=>{a.call(d,b,c,aC)})}let aQ=function(a){let b=null;if(aP(C.beforeSanitizeElements,a,null),aN(a))return aJ(a),!0;let c=aB(a.nodeName);if(aP(C.uponSanitizeElement,a,{tagName:c,allowedTags:M}),Z&&a.hasChildNodes()&&!aO(a.firstElementChild)&&dt(/<[/\w!]/g,a.innerHTML)&&dt(/<[/\w!]/g,a.textContent)||7===a.nodeType||Z&&8===a.nodeType&&dt(/<[/\w]/g,a.data))return aJ(a),!0;if(!(T.tagCheck instanceof Function&&T.tagCheck(c))&&(!M[c]||R[c])){if(!R[c]&&aS(c)&&(Q.tagNameCheck instanceof RegExp&&dt(Q.tagNameCheck,c)||Q.tagNameCheck instanceof Function&&Q.tagNameCheck(c)))return!1;if(ag&&!aj[c]){let b=v(a)||a.parentNode,c=u(a)||a.childNodes;if(c&&b){let d=c.length;for(let e=d-1;e>=0;--e){let d=r(c[e],!0);d.__removalCount=(a.__removalCount||0)+1,b.insertBefore(d,t(a))}}}return aJ(a),!0}return a instanceof k&&!aI(a)||("noscript"===c||"noembed"===c||"noframes"===c)&&dt(/<\/no(script|embed|frames)/i,a.innerHTML)?(aJ(a),!0):(Y&&3===a.nodeType&&(b=a.textContent,dg([D,E,F],a=>{b=dp(b,a," ")}),a.textContent!==b&&(dj(d.removed,{element:a.cloneNode()}),a.textContent=b)),aP(C.afterSanitizeElements,a,null),!1)},aR=function(a,b,c){if(ae&&("id"===b||"name"===b)&&(c in e||c in aD))return!1;if(V&&!S[b]&&dt(G,b));else if(U&&dt(H,b));else if(T.attributeCheck instanceof Function&&T.attributeCheck(b,a));else if(!O[b]||S[b]){if(!(aS(a)&&(Q.tagNameCheck instanceof RegExp&&dt(Q.tagNameCheck,a)||Q.tagNameCheck instanceof Function&&Q.tagNameCheck(a))&&(Q.attributeNameCheck instanceof RegExp&&dt(Q.attributeNameCheck,b)||Q.attributeNameCheck instanceof Function&&Q.attributeNameCheck(b,a))||"is"===b&&Q.allowCustomizedBuiltInElements&&(Q.tagNameCheck instanceof RegExp&&dt(Q.tagNameCheck,c)||Q.tagNameCheck instanceof Function&&Q.tagNameCheck(c))))return!1}else if(an[b]);else if(dt(L,dp(c,J,"")));else if(("src"===b||"xlink:href"===b||"href"===b)&&"script"!==a&&0===dq(c,"data:")&&al[a]);else if(W&&!dt(I,dp(c,J,"")));else if(c)return!1;return!0},aS=function(a){return"annotation-xml"!==a&&dn(a,K)},aT=function(a){aP(C.beforeSanitizeAttributes,a,null);let{attributes:c}=a;if(!c||aN(a))return;let e={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:O,forceKeepAttr:void 0},f=c.length;for(;f--;){let{name:g,namespaceURI:h,value:i}=c[f],j=aB(g),k="value"===g?i:dr(i);if(e.attrName=j,e.attrValue=k,e.keepAttr=!0,e.forceKeepAttr=void 0,aP(C.uponSanitizeAttribute,a,e),k=e.attrValue,af&&("id"===j||"name"===j)&&(aK(g,a),k="user-content-"+k),Z&&dt(/((--!?|])>)|<\/(style|title|textarea)/i,k)||"attributename"===j&&dn(k,"href")){aK(g,a);continue}if(e.forceKeepAttr)continue;if(!e.keepAttr||!X&&dt(/\/>/i,k)){aK(g,a);continue}Y&&dg([D,E,F],a=>{k=dp(k,a," ")});let l=aB(a.nodeName);if(!aR(l,j,k)){aK(g,a);continue}if(b&&"object"==typeof p&&"function"==typeof p.getAttributeType)if(h);else switch(p.getAttributeType(l,j)){case"TrustedHTML":k=b.createHTML(k);break;case"TrustedScriptURL":k=b.createScriptURL(k)}if(k!==i)try{h?a.setAttributeNS(h,g,k):a.setAttribute(g,k),aN(a)?aJ(a):di(d.removed)}catch(b){aK(g,a)}}aP(C.afterSanitizeAttributes,a,null)},aU=function a(b){let c=null,d=aM(b);for(aP(C.beforeSanitizeShadowDOM,b,null);c=d.nextNode();)aP(C.uponSanitizeShadowNode,c,null),aQ(c),aT(c),c.content instanceof h&&a(c.content);aP(C.afterSanitizeShadowDOM,b,null)};return d.sanitize=function(a){let c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=null,g=null,i=null,k=null;if((at=!a)&&(a="<!-->"),"string"!=typeof a&&!aO(a))if("function"==typeof a.toString){if("string"!=typeof(a=a.toString()))throw du("dirty is not a string, aborting")}else throw du("toString is not a function");if(!d.isSupported)return a;if(_||aF(c),d.removed=[],"string"==typeof a&&(ah=!1),ah){if(a.nodeName){let b=aB(a.nodeName);if(!M[b]||R[b])throw du("root node is forbidden and cannot be sanitized in-place")}}else if(a instanceof j)1===(g=(e=aL("<!---->")).ownerDocument.importNode(a,!0)).nodeType&&"BODY"===g.nodeName||"HTML"===g.nodeName?e=g:e.appendChild(g);else{if(!ab&&!Y&&!$&&-1===a.indexOf("<"))return b&&ad?b.createHTML(a):a;if(!(e=aL(a)))return ab?null:ad?w:""}e&&aa&&aJ(e.firstChild);let l=aM(ah?a:e);for(;i=l.nextNode();)aQ(i),aT(i),i.content instanceof h&&aU(i.content);if(ah)return a;if(ab){if(ac)for(k=z.call(e.ownerDocument);e.firstChild;)k.appendChild(e.firstChild);else k=e;return(O.shadowroot||O.shadowrootmode)&&(k=B.call(f,k,!0)),k}let m=$?e.outerHTML:e.innerHTML;return $&&M["!doctype"]&&e.ownerDocument&&e.ownerDocument.doctype&&e.ownerDocument.doctype.name&&dt(dS,e.ownerDocument.doctype.name)&&(m="<!DOCTYPE "+e.ownerDocument.doctype.name+">\n"+m),Y&&dg([D,E,F],a=>{m=dp(m,a," ")}),b&&ad?b.createHTML(m):m},d.setConfig=function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};aF(a),_=!0},d.clearConfig=function(){aC=null,_=!1},d.isValidAttribute=function(a,b,c){return aC||aF({}),aR(aB(a),aB(b),c)},d.addHook=function(a,b){"function"==typeof b&&dj(C[a],b)},d.removeHook=function(a,b){if(void 0!==b){let c=dh(C[a],b);return -1===c?void 0:dk(C[a],c,1)[0]}return di(C[a])},d.removeHooks=function(a){C[a]=[]},d.removeAllHooks=function(){C=dV()},d}(),dX=a.i(903484);let dY=a=>/[\p{L}\p{N}_]/u.test(a||""),dZ="------------",d$=a=>RegExp(`[${dZ}]`).test(a||"");function d_(a,b,c){let d,e;if(!c.isRegex&&!(!1!==c.caseSensitive?b[0]===c.pattern:b[0].toLowerCase()===c.pattern.toLowerCase()))return!1;if(d=c.pattern,/[^\x00-\x7F]/.test(d)&&(e=c.pattern,!RegExp(`^[${dZ}]+$`).test(e))){let c=a[b.index-1]??"",d=a[b.index+b[0].length]??"";if(!d$(c)&&!d$(d)&&(dY(c)||dY(d)))return!1}return!0}let d0={name:"proofread",transform:async(a,b)=>{let{docType:c="text/html",onlyForTTS:d=!1}=b||{},e=[...h.useSettingsStore.getState().settings?.globalViewSettings?.proofreadRules??[],...a.viewSettings.proofreadRules??[]].sort((a,b)=>(a.order??0)-(b.order??0));if(!e.length)return a.content;let f=e.filter(a=>a.enabled&&a.pattern.trim()).filter(a=>d?a.onlyForTTS:!a.onlyForTTS).map(a=>({...a,normalizedPattern:function(a,b,c=!0){let d=/[^\x00-\x7F]/.test(a),e=d?"ug":"g";if(c||(e+="i"),b)return{source:a.includes("\\b")||d?a:`\\b${a}\\b`,flags:e};let f=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(d)return{source:f,flags:e};let g=/^[^\w\s]/.test(a),h=/[^\w\s]$/.test(a);if(g||h){let b=a.match(/[\w]+/);if(!b)return{source:f,flags:e};let c=b[0],d=a.indexOf(c),g=d+c.length,h=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=f.substring(0,d),j=f.substring(g);return{source:`${i}\\b${h}\\b${j}`,flags:e}}return{source:`\\b${f}\\b`,flags:e}}(a.pattern,a.isRegex,!1!==a.caseSensitive)}));if(!f.length)return a.content;let g=new DOMParser().parseFromString(a.content,c),i=function(a){let b,c=document.createTreeWalker(a.body||a.documentElement,NodeFilter.SHOW_TEXT,{acceptNode:a=>{let b=a.parentElement;return b?.tagName==="SCRIPT"||b?.tagName==="STYLE"?NodeFilter.FILTER_REJECT:a.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),d=[];for(;b=c.nextNode();)d.push(b);return d}(g),j={selection:f.filter(a=>"selection"===a.scope),book:f.filter(a=>"book"===a.scope),library:f.filter(a=>"library"===a.scope)};for(let b of[...j.selection,...j.book,...j.library]){if("selection"===b.scope){let c=b.sectionHref?.split("#")[0];if(a.sectionHref?.split("#")[0]!==c)continue}"selection"===b.scope?function(a,b){let c;try{c=new RegExp(b.normalizedPattern.source,b.normalizedPattern.flags)}catch{return}let d=a0.parse(b.cfi);if(d.parent){d.parent.shift();let e=a0.toRange(a,d);if(e){let a=e.startContainer;if(a===e.endContainer&&a.nodeType===Node.TEXT_NODE){let d=a.textContent||"",f=e.startOffset,g=e.endOffset,h=Math.max(0,f-32),i=Math.min(d.length,g+32),j=d.slice(h,i),k=d.slice(f,g),l=c.exec(j);if(l&&d_(k,l,b)){let c=h+l.index,e=c+l[0].length;e>=f-32&&c<=g+32&&(a.textContent=d.slice(0,c)+b.replacement+d.slice(e))}}}}}(g,b):function(a,b){let c;try{c=new RegExp(b.normalizedPattern.source,b.normalizedPattern.flags)}catch{return}for(let d of a){let a;if(!d.textContent)continue;let e=d.textContent,f=[];for(;null!==(a=c.exec(e));)d_(e,a,b)&&f.push({index:a.index,length:a[0].length});if(0!==f.length){for(let a=f.length-1;a>=0;a--){let c=f[a];e=e.slice(0,c.index)+b.replacement+e.slice(c.index+c.length)}d.textContent=e}}}(i,b)}return new XMLSerializer().serializeToString(g)}},d1=[{name:"punctuation",transform:async a=>{if(!a.viewSettings.replaceQuotationMarks)return a.content;let b=a.content,c=a.viewSettings.convertChineseVariant,d=a.reversePunctuationTransform||!1;if(c&&"none"!==c)for(let[a,e]of Object.entries(c5)){let[f,g]=d!==c.includes("2s")?[e,a]:[a,e];b=b.replace(RegExp(f,"g"),g)}if(a.viewSettings.vertical){let c=["zh-Hant","zh-TW","zh_TW"],d=c3;for(let[e,f]of((c.includes(a.primaryLanguage||"")||c.includes(a.userLocale))&&(d=c4),Object.entries(d)))b=a.reversePunctuationTransform?b.replace(RegExp(f,"g"),e):b.replace(RegExp(e,"g"),f)}return b}},{name:"footnote",transform:async a=>{let b=a.content;return b.replace(/<aside\s+epub:type\s*=\s*["'](footnote|endnote|note|rearnote)["']([^>]*)>/gi,'<aside class="epubtype-footnote" epub:type="$1"$2>')}},{name:"language",transform:async a=>{let b=a.primaryLanguage,c=a.content,d=c.match(/<html\b([^>]*)>/i);if(d){let a=d[1]||"",e=/ lang="([^"]*)"/i,f=/ xml:lang="([^"]*)"/i,g=a.match(f),h=a.match(e),i=h?.[1]||g?.[1];if(!(0,ch.isValidLang)(i)||!(0,ch.isSameLang)(i,b)){let i=c.replace(/<[^>]+>/g," "),j=(0,ch.isValidLang)(b)&&"en"!==b?b:(0,ch.detectLanguage)(i),k=(0,ch.getLanguageInfo)(j||""),l=` lang="${j}"`,m=` xml:lang="${j}"`,n=k?.direction==="rtl"?' dir="rtl"':"";a=h?a.replace(e,l):a+l+n,a=g?a.replace(f,m):a+m+n,c=c.replace(d[0],`<html${a}>`)}}else{let a=(0,ch.isValidLang)(b)&&"en"!==b?b:(0,ch.detectLanguage)(c.replace(/<[^>]+>/g," ")),d=(0,ch.getLanguageInfo)(a||""),e=d?.direction==="rtl"?' dir="rtl"':"",f=` lang="${a}" xml:lang="${a}" ${e}`;c=c.replace(/<html>/i,`<html${f}>`)}return c}},{name:"style",transform:async a=>{let b=a.content;for(let c of[...b.matchAll(/<style[^>]*>([\s\S]*?)<\/style>/gi)]){let[d,e]=c,f=await (0,at.transformStylesheet)(e,a.width||window.innerWidth,a.height||window.innerHeight,a.viewSettings.vertical);b=b.replace(d,`<style>${f}</style>`)}return b}},{name:"whitespace",transform:async a=>a.viewSettings.overrideLayout?a.content.replace(/(&amp;)?&nbsp;/g,(a,b)=>b?a:" ").replace(/\u00A0/g," ").replace(/ {2,}/g," "):a.content},{name:"sanitizer",transform:async a=>{if(a.viewSettings.allowScript)return a.content;let b=a.content.replaceAll("&nbsp;","&#160;"),c=dW.sanitize(b,{WHOLE_DOCUMENT:!0,FORBID_TAGS:["script"],ALLOWED_URI_REGEXP:/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|blob|data):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,ADD_TAGS:["link","meta"],ADD_ATTR:a=>["xmlns","http-equiv","content","charset","link","vlink","imt-state","data-wr-footernote","zy-footnote"].includes(a)||a.startsWith("xml:")||a.startsWith("xmlns:")||a.startsWith("epub:"),RETURN_DOM:!0}),d=new XMLSerializer().serializeToString(c);return(d=(d='<?xml version="1.0" encoding="utf-8"?>'+(d=d.replaceAll("&#160;","&nbsp;").replaceAll("","&nbsp;"))).replace(/(<head[^>]*>)/i,"\n$1")).replace(/(<\/body>)(<\/html>)/i,"$1\n$2")}},{name:"simplecc",transform:async a=>{let b,c=a.viewSettings.convertChineseVariant;if(!c||"none"===c)return a.content;await (0,dX.initSimpleCC)();let d=new DOMParser().parseFromString(a.content,"text/html"),e=document.createTreeWalker(d.body||d.documentElement,NodeFilter.SHOW_TEXT,{acceptNode:a=>{let b=a.parentElement;return b&&("SCRIPT"===b.tagName||"STYLE"===b.tagName)?NodeFilter.FILTER_REJECT:a.textContent?.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),f=[];for(;b=e.nextNode();)f.push(b);for(let a of f)a.textContent&&(a.textContent=(0,dX.runSimpleCC)(a.textContent,c));return new XMLSerializer().serializeToString(d)}},d0],d2=async a=>{let b=a.content;for(let c of a.transformers.map(a=>d1.find(b=>b.name===a)).filter(a=>!!a))try{b=await c.transform({...a,content:b})}catch(a){console.warn(`Error in transformer ${c.name}:`,a)}return b};var d3=a.i(778838);let d4=({details:a,onResolveWithLocal:b,onResolveWithRemote:d,onClose:e})=>{let g=(0,f.useTranslation)();return a?(0,c.jsxs)(L.default,{isOpen:!0,onClose:e,title:g("Sync Conflict"),children:[(0,c.jsx)("p",{className:"py-4 text-center",children:g('Sync reading progress from "{{deviceName}}"?',{deviceName:a.remote.device||g("another device")})}),(0,c.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,c.jsxs)("button",{className:"btn h-auto w-full flex-col items-start py-2",onClick:b,children:[(0,c.jsx)("span",{children:g("Local Progress")}),(0,c.jsx)("span",{className:"text-base-content/50 text-xs font-normal normal-case",children:a.local.preview})]}),(0,c.jsxs)("button",{className:"btn btn-primary h-auto w-full flex-col items-start py-2",onClick:d,children:[(0,c.jsx)("span",{children:g("Remote Progress")}),(0,c.jsx)("span",{className:"text-xs font-normal normal-case",children:a.remote.preview})]})]})]}):null},d5=({bookKey:b,bookDoc:g,config:i,gridInsets:j,contentInsets:k})=>{let l=(0,f.useTranslation)(),{appService:m,envConfig:p}=(0,e.useEnv)(),{themeCode:q,isDarkMode:r}=(0,n.useThemeStore)(),{settings:s}=(0,h.useSettingsStore)(),{loadCustomFonts:t,getLoadedFonts:v}=(0,cD.useCustomFontStore)(),{getView:w,setView:y,setViewInited:C,setProgress:D}=(0,o.useReaderStore)(),{getViewState:E,getViewSettings:F,setViewSettings:G}=(0,o.useReaderStore)(),{getParallels:H}=ar(),{getBookData:L}=(0,P.useBookDataStore)(),{applyBackgroundTexture:M}=(0,cL.useBackgroundTexture)(),{applyEinkMode:N}=(0,cN.useEinkMode)(),O=L(b),Q=E(b),R=F(b),S=(0,d.useRef)(null),T=(0,d.useRef)(null),U=(0,d.useRef)(!1),V=(0,d.useRef)(!!R?.disableDoubleClick),[W,X]=(0,d.useState)(""),[Y,Z]=(0,d.useState)(!1),$=(0,d.useRef)(!1);(0,cM.useAutoFocus)({ref:T}),((a,b,c)=>{let{appService:f}=(0,e.useEnv)(),g=(0,d.useRef)(Date.now()),h=(0,d.useRef)(null),i=(0,d.useRef)(null),j=(0,d.useRef)(!1);(0,d.useEffect)(()=>{if(!b||!a||!f?.isDesktopApp)return;let d=()=>{h.current&&(clearInterval(h.current),h.current=null),j.current=!1};if(!c){d(),ao(f),i.current=null;return}i.current!==a.hash&&(g.current=Date.now(),i.current=a.hash);let e=async()=>{if(!j.current){j.current=!0;try{await an(a,g.current,f)}catch(a){console.error("Discord presence update failed:",a)}finally{j.current=!1}}};return e(),h.current=setInterval(()=>{e()},15e3),()=>{d(),ao(f)}},[a?.hash,b,c,f])})(O?.book||null,!!Q?.isPrimary,s.discordRichPresenceEnabled),(0,d.useEffect)(()=>{let a=setTimeout(()=>X(""),2e3);return()=>clearTimeout(a)},[W]),(0,cO.useUICSS)(b),(a=>{let b=(0,f.useTranslation)(),{getConfig:c,setConfig:e,getBookData:g}=(0,P.useBookDataStore)(),{getView:i,getProgress:j,setHoveredBookKey:k}=(0,o.useReaderStore)(),{settings:l}=(0,h.useSettingsStore)(),{syncedConfigs:m,syncConfigs:n}=(0,cF.useSync)(a),{user:p}=(0,aK.useAuth)(),q=j(a),r=(0,d.useRef)(!1),s=(0,d.useRef)(!1),t=async(a,b)=>{let c=g(a)?.book;if(!b||!c||!p)return;let d=a.split("-")[0],e=c.metaHash,f={...b,bookHash:d,metaHash:e},h=JSON.parse((0,cG.serializeConfig)(f,l.globalViewSettings,ap.DEFAULT_BOOK_SEARCH_CONFIG));delete h.booknotes,await n([h],d,e,"push")},u=async a=>{let b=g(a)?.book;if(!p||!b)return;let c=a.split("-")[0],d=b.metaHash;await n([],c,d,"pull")},v=async()=>{if(r.current){let b=c(a),d=i(a),e=g(a)?.book;if(b&&d&&e&&b.progress&&b.progress[0]>0){try{let a=d.renderer.getContents()[0];if(a&&!aM.FIXED_LAYOUT_FORMATS.has(e.format)){let{doc:c,index:d}=a,e=await cJ(b.location,c,d||0);b.xpointer=cK(e.xpointer)}}catch(a){console.warn("Failed to convert CFI to XPointer",a)}t(a,b)}}else u(a)},w=async b=>{let{bookKey:c}=b.detail;c===a&&(r.current=!1,await u(a))};(0,d.useEffect)(()=>(x.eventDispatcher.on("sync-book-progress",w),()=>{x.eventDispatcher.off("sync-book-progress",w)}),[a]);let y=(0,d.useCallback)((0,J.debounce)(()=>{v()},1e3*ap.SYNC_PROGRESS_INTERVAL_SEC),[]);(0,d.useEffect)(()=>{q?.location&&p&&y()},[q?.location]),(0,d.useEffect)(()=>{q&&!s.current&&(s.current=!0,u(a))},[q]);let z=async d=>{let f=c(a),h=g(a)?.book;if(!d||0===d.length||!f||!h)return;let j=a.split("-")[0],l=h.metaHash,m=d.filter(a=>a.bookHash===j||a.metaHash===l)[0];if(m){let c=f?.location,d=m.location,h=m.xpointer,j=g(a),l=i(a);if(h&&l&&j&&j.bookDoc){let a=l.renderer.getContents()[0],b=cK(h),c=await cI(b,a?.doc,a?.index,j.bookDoc);(!d||0>cC.CFI.compare(d,c))&&(d=c)}let n=Object.fromEntries(Object.entries(m).filter(([a,b])=>null!=b));m.updatedAt>=f.updatedAt?e(a,{...f,...n}):e(a,{...n,...f}),d&&c&&0>cC.CFI.compare(c,d)&&l&&(l.goTo(d),k(null),x.eventDispatcher.dispatch("hint",{bookKey:a,message:b("Reading Progress Synced")}))}};(0,d.useEffect)(()=>{!r.current&&m&&(r.current=!0,z(m).catch(a=>{console.error("Failed to apply remote progress",a)}))},[m])})(b),(a=>{let{envConfig:b}=(0,e.useEnv)(),{getConfig:c,saveConfig:f}=(0,P.useBookDataStore)(),{getProgress:g}=(0,o.useReaderStore)(),i=g(a),j=(0,d.useCallback)((0,af.throttle)(()=>{setTimeout(async()=>{let d=c(a),e=h.useSettingsStore.getState().settings;await f(b,a,d,e)},5e3)},1e4),[]);(0,d.useEffect)(()=>{j()},[i,a])})(b),(a=>{let b=(0,f.useTranslation)(),{envConfig:c,appService:g}=(0,e.useEnv)(),i=(0,d.useCallback)((0,af.throttle)(()=>{setTimeout(async()=>{let d=h.useSettingsStore.getState().settings,e=P.useBookDataStore.getState().getBookData(a),f=e?.book,i=d.savedBookCoverForLockScreen,j=d.savedBookCoverForLockScreenPath;if(g&&f&&i&&i!==f?.hash){let a=await g.resolveFilePath((0,ai.getCoverFilename)(f),"Books");try{let b="last-book-cover.png",e=await g.resolveFilePath("","Images");j&&j!==e?await g.copyFile(a,`${j}/${b}`,"None"):await g.copyFile(a,b,"Images"),d.savedBookCoverForLockScreen=f.hash,h.useSettingsStore.getState().setSettings(d),h.useSettingsStore.getState().saveSettings(c,d)}catch(a){x.eventDispatcher.dispatch("toast",{type:"error",message:b("Failed to auto-save book cover for lock screen: {{error}}",{error:a instanceof Error?a.message:String(a)})})}}},5e3)},5e3,{emitLast:!1}),[]);(0,d.useEffect)(()=>{i()},[])})(b);let{syncState:_,conflictDetails:aa,resolveWithLocal:ab,resolveWithRemote:ac}=(a=>{let b=(0,f.useTranslation)(),{appService:c}=(0,e.useEnv)(),{settings:g}=(0,h.useSettingsStore)(),{getProgress:i,getView:j}=(0,o.useReaderStore)(),{getBookData:k}=(0,P.useBookDataStore)(),[l,m]=(0,d.useState)(null),[n,p]=(0,d.useState)("idle"),[q,r]=(0,d.useState)(null),[s]=(0,d.useState)(null),t=(0,d.useRef)(!1),u=i(a);(0,d.useEffect)(()=>{g.kosync.username&&g.kosync.userkey?m(new I(g.kosync)):m(null)},[g]);let v=(0,d.useCallback)(()=>{let b,c=i(a),d=k(a)?.book;if(!c||!d)return null;let e="";if(aM.FIXED_LAYOUT_FORMATS.has(d.format)){let a=c.section?.current??0,d=c.section?.total??0;e=a.toString(),b=d>0?(a+1)/d:0}else{let d=j(a),f=c.location;if(!d||!f)return null;try{let a=d.renderer.getContents()[0];if(a){let{doc:b,index:c}=a,d=new cH(b,c||0).cfiToXPointer(f);e=cK(d.xpointer)}}catch(a){console.error("Failed to convert CFI to XPointer",a)}let g=c.pageinfo?.current??0,h=c.pageinfo?.total??0;b=h>0?(g+1)/h:0}return{koProgress:e,percentage:b}},[a,i,k,j]),w=async(c,d,e)=>{let f=j(a);if(aM.FIXED_LAYOUT_FORMATS.has(c.format)){let a=parseInt(e.progress,10);if(isNaN(a))return;f?.select(a-1)}else{if(!e.progress?.startsWith("/body"))return;try{let a=f?.renderer.getContents()[0],b=cK(e.progress),c=await cI(b,a?.doc,a?.index,d);f?.goTo(c)}catch(a){console.error("Failed to convert XPointer to CFI",a);return}}x.eventDispatcher.dispatch("toast",{message:b("Reading Progress Synced"),type:"info"})},y=async(a,c,d,e)=>{let f="",g="",h=e.percentage||0;if(aM.FIXED_LAYOUT_FORMATS.has(a.format)){let a=d.section,c=a&&a.total>0?Math.round((a.current+1)/a.total*100):0;f=a?b("Page {{page}} of {{total}} ({{percentage}}%)",{page:a.current+1,total:a.total,percentage:c}):b("Current position");let i=parseInt(e.progress,10);if(!isNaN(i)&&h>0){let c=a?.total??0,d=Math.round(i/h);g=1>=Math.abs(c-d)?b("Page {{page}} of {{total}} ({{percentage}}%)",{page:i,total:d,percentage:Math.round(100*h)}):b("Approximately page {{page}} of {{total}} ({{percentage}}%)",{page:i,total:d,percentage:Math.round(100*h)})}else g=b("Approximately {{percentage}}%",{percentage:Math.round(100*h)})}else{let a=d.pageinfo,c=a&&a.total>0?Math.round((a.current+1)/a.total*100):0;f=`${d.sectionLabel} (${c}%)`,g=b("Approximately {{percentage}}%",{percentage:Math.round(100*h)})}r({book:a,bookDoc:c,local:{cfi:d.location,preview:f},remote:{...e,preview:g}})},z=(0,d.useMemo)(()=>(0,J.debounce)(async()=>{if(!a||!c||!l||!t.current)return;let{settings:b}=h.useSettingsStore.getState();if(["receive","disable"].includes(b.kosync.strategy))return;let d=k(a)?.book,e=v();d&&e&&e.koProgress&&await l.updateProgress(d,e.koProgress,e.percentage)},5e3),[a,c,l]),A=(0,d.useCallback)(async()=>{if(!u?.location||!c||!l)return;let b=k(a),d=b?.book,e=b?.bookDoc;if(!d||!e)return;let{strategy:f,enabled:h}=g.kosync;if(!h)return;if(t.current=!0,"send"===f)return void p("synced");p("checking");let i=await l.getProgress(d);if(!i||!i.progress)return void p("synced");let j=b?.config?.updatedAt||d.updatedAt,m=i.timestamp?1e3*i.timestamp:Date.now();"receive"===f||"silent"===f&&m>j?(w(d,e,i),p("synced")):"prompt"===f?(y(d,e,u,i),p("conflict")):p("synced")},[a,c,l,g.kosync,u]);(0,d.useEffect)(()=>{let b=b=>{b.detail.bookKey===a&&(z(),z.flush())},c=b=>{b.detail.bookKey===a&&z.flush()};return x.eventDispatcher.on("push-kosync",b),x.eventDispatcher.on("flush-kosync",c),()=>{x.eventDispatcher.off("push-kosync",b),x.eventDispatcher.off("flush-kosync",c),z.flush()}},[a,z]),(0,d.useEffect)(()=>{let b=b=>{b.detail.bookKey===a&&A()};return x.eventDispatcher.on("pull-kosync",b),()=>{x.eventDispatcher.off("pull-kosync",b)}},[a,A]),(0,d.useEffect)(()=>{c&&l&&u?.location&&(t.current||A())},[c,l,u?.location,z,A]),(0,d.useEffect)(()=>{if("synced"===n&&u){let{strategy:a,enabled:b}=g.kosync;"receive"!==a&&b&&z()}},[u,n,g.kosync,z]);let B=async()=>{let b=j(a),c=q?.remote,d=q?.book,e=q?.bookDoc;d&&e&&c&&c.progress&&b&&(w(d,e,c),p("synced"),r(null))};return{syncState:n,conflictDetails:q,errorMessage:s,pushProgress:z,pullProgress:A,resolveWithLocal:()=>{z(),z.flush(),p("synced"),r(null)},resolveWithRemote:B}})(b);aW(b,S.current);let{handlePageFlip:ad,handleContinuousScroll:ag}=((a,b,c)=>{let{appService:f}=(0,e.useEnv)(),{getBookData:g}=(0,P.useBookDataStore)(),{getViewSettings:h,getViewState:i}=(0,o.useReaderStore)(),{hoveredBookKey:j,setHoveredBookKey:k}=(0,o.useReaderStore)(),{acquireVolumeKeyInterception:l,releaseVolumeKeyInterception:m}=(0,u.useDeviceControlStore)(),n=async d=>{let e=i(a),l=g(a);if(e?.inited&&l){if(d instanceof MessageEvent){if(d.data&&d.data.bookKey===a){let e=h(a);if("iframe-single-click"===d.data.type){let g=c.current;if(g){let{screenX:c}=d.data,h=g.getBoundingClientRect(),i=((0,z.isTauriAppPlatform)()?f?.isMobile?0:(await (0,ae.tauriGetWindowLogicalPosition)()).x:window.screenX)+h.left,l=i+h.width/2;if(!x.eventDispatcher.dispatchSync("iframe-single-click")){let d=i+.375*h.width,f=i+.625*h.width;if(e.disableClick||c>=d&&c<=f)k(j?null:a);else{if(j)return void k(null);!e.disableClick&&c>=l?e.fullscreenClickArea?av(b.current,e,"down"):e.swapClickArea?av(b.current,e,"left"):av(b.current,e,"right"):!e.disableClick&&c<l&&(e.fullscreenClickArea?av(b.current,e,"down"):e.swapClickArea?av(b.current,e,"right"):av(b.current,e,"left"))}}}}else if("iframe-wheel"!==d.data.type||e.scrolled||au(b.current,e))"iframe-mouseup"===d.data.type&&(3===d.data.button?b.current?.history.back():4===d.data.button&&b.current?.history.forward());else{let{deltaY:a}=d.data;a>0?b.current?.next(1):a<0&&b.current?.prev(1)}}}else if(d instanceof CustomEvent){let c=h(a);if("native-key-down"===d.type&&c?.volumeKeysToFlip){let{keyName:a}=d.detail;k(""),"VolumeUp"===a?av(b.current,c,"up"):"VolumeDown"===a&&av(b.current,c,"down")}else if("touch-swipe"===d.type&&l.isFixedLayout&&!au(b.current,c)){let{deltaX:a,deltaY:e,deltaT:f}=d.detail,g=Math.abs(a/f);Math.abs(a)>Math.abs(e)&&Math.abs(a)>30&&g>.2&&(a>0?av(b.current,c,"left"):av(b.current,c,"right"))}}else if("click"===d.type){let{clientX:c}=d,e=window.innerWidth,f=h(a);c<.5*e?av(b.current,f,"left"):c>.5*e&&av(b.current,f,"right")}}};return(0,d.useEffect)(()=>{if(!f?.isMobileApp)return;let b=h(a);return b?.volumeKeysToFlip?l():m(),x.eventDispatcher.on("native-key-down",n),()=>{m(),x.eventDispatcher.off("native-key-down",n)}},[]),{handlePageFlip:n,handleContinuousScroll:(c,d,e)=>{let f=b.current?.renderer,i=h(a),j=g(a);if(j.bookDoc?.rendition?.layout!=="pre-paginated"&&f&&i.scrolled&&i.continuousScroll){let a=()=>{f.start<=d&&d>e?setTimeout(()=>{b.current?.prev(f.start+1)},100):Math.ceil(f.end)-d>=f.viewSize&&d<-e&&setTimeout(()=>{b.current?.next(f.viewSize-Math.floor(f.end)+1)},100)};"mouse"===c?a():"touch"===c&&(f.size>=f.viewSize?a():f.addEventListener("relocate",()=>a(),{once:!0}))}}}})(b,S,T),ah=((a,b,c)=>{let{hoveredBookKey:e}=(0,o.useReaderStore)(),f=(0,J.debounce)(c,500),g=(0,J.debounce)(b,100),h=c=>{c instanceof MessageEvent?c.data&&c.data.bookKey===a&&("iframe-wheel"===c.data.type&&f("mouse",-c.data.deltaY,0),"iframe-wheel"===c.data.type?c.data.ctrlKey?c.data.deltaY>0?x.eventDispatcher.dispatch("zoom-out",{factor:Math.abs(c.data.deltaY)/100}):c.data.deltaY<0&&x.eventDispatcher.dispatch("zoom-in",{factor:Math.abs(c.data.deltaY)/100}):g(c):b(c)):"wheel"===c.type?f("mouse",-c.deltaY,0):b(c)};return(0,d.useEffect)(()=>(window.addEventListener("message",h),()=>{window.removeEventListener("message",h)}),[a,e]),{onClick:b,onWheel:h}})(b,ad,ag),aj=((a,b,c)=>{let{getBookData:e}=(0,P.useBookDataStore)(),{hoveredBookKey:f,setHoveredBookKey:g,getViewSettings:h}=(0,o.useReaderStore)(),i=(0,d.useRef)(null),j=(0,d.useRef)(null),k=(0,d.useRef)(null),l=(0,d.useRef)(null),m=a=>{let b=a.targetTouches[0];b&&(i.current=b,k.current="timeStamp"in a?a.timeStamp:Date.now())},n=b=>{if(!i.current)return;let c=b.targetTouches[0];c&&(j.current=c,l.current="timeStamp"in b?b.timeStamp:Date.now());let{current:d}=i,{current:e}=j;if(f&&e){let b=h(a),c=e.screenY-d.screenY,f=e.screenX-d.screenX;b.scrolled||b.vertical?g(null):Math.abs(f)>Math.abs(c)&&Math.abs(f)>10&&g(null)}},p=d=>{if(!i.current)return;let m=d.targetTouches[0];m&&(j.current=m,l.current="timeStamp"in d?d.timeStamp:Date.now());let n=window.innerWidth,{current:o}=i,{current:p}=j,{current:q}=k,{current:r}=l;if(p){let d=h(a),i=e(a),j=p.screenY-o.screenY,k=p.screenX-o.screenX;j<-10&&Math.abs(j)>2*Math.abs(k)&&Math.abs(k)<.3*n?d.scrolled||d.vertical||i.isFixedLayout&&!(d.zoomLevel<=100)||g(f?null:a):f&&g(null),b(new CustomEvent("touch-swipe",{detail:{deltaX:k,deltaY:j,deltaT:r&&q?r-q:0,startX:o.screenX,startY:o.screenY,endX:p.screenX,endY:p.screenY}})),c("touch",j,30)}i.current=null,j.current=null},q=b=>{b.data&&b.data.bookKey===a&&("iframe-touchstart"===b.data.type?m(b.data):"iframe-touchmove"===b.data.type?n(b.data):"iframe-touchend"===b.data.type&&p(b.data))};return(0,d.useEffect)(()=>(window.addEventListener("message",q),()=>{window.removeEventListener("message",q)}),[f]),{onTouchStart:m,onTouchMove:n,onTouchEnd:p}})(b,ad,ag);cE(S.current,{onLoad:a=>{Z(!1),$.current=!0;let c=a.detail;if(console.log("doc index loaded:",c.index),c.doc){let a=S.current?.renderer.setStyles&&(0,cC.getDirection)(c.doc),d=F(b),e=L(b),f=a?.vertical||d.writingMode.includes("vertical")||!1,h=a?.rtl||"rtl"===(0,c2.getDirFromUILanguage)()||d.writingMode.includes("rl")||!1;(d.vertical!==f||d.rtl!==h)&&(d.vertical=f,d.rtl=h,G(b,{...d})),e?.isFixedLayout||(0,A.mountAdditionalFonts)(c.doc,(0,ch.isCJKLang)(e.book?.primaryLanguage)),v().forEach(a=>{(0,A.mountCustomFont)(c.doc,a)}),g.rendition?.layout==="pre-paginated"&&(0,at.applyFixedlayoutStyles)(c.doc,d),(0,at.applyImageStyle)(c.doc),(0,at.applyTableStyle)(c.doc),(0,at.applyThemeModeClass)(c.doc,r),(0,at.applyScrollModeClass)(c.doc,d.scrolled||!1),(0,at.keepTextAlignment)(c.doc),c.doc.querySelectorAll("a").forEach(a=>{a.setAttribute("tabindex","-1")}),d.allowScript&&(0,z.isTauriAppPlatform)()&&(a=>{if(a.defaultView&&a.defaultView.frameElement){let b=a.defaultView.frameElement;a.querySelectorAll("script:not([src])").forEach((a,c)=>{let d=a.textContent||a.innerHTML;try{console.warn("Evaluating inline scripts in iframe"),b.contentWindow?.eval(d)}catch(a){console.error(`Error executing iframe script ${c+1}:`,a)}})}})(c.doc),d.codeHighlighting&&(0,d3.manageSyntaxHighlighting)(c.doc,d),setTimeout(()=>{(i.booknotes||[]).filter(a=>!a.deletedAt&&"annotation"===a.type&&a.style).forEach(a=>S.current?.addAnnotation(a))},100),c.doc.isEventListenersAdded||(c.doc.isEventListenersAdded=!0,c.doc.addEventListener("keydown",cT.bind(null,b)),c.doc.addEventListener("keyup",cU.bind(null,b)),c.doc.addEventListener("mousedown",cV.bind(null,b)),c.doc.addEventListener("mouseup",cW.bind(null,b)),c.doc.addEventListener("click",cY.bind(null,b,V)),c.doc.addEventListener("wheel",cX.bind(null,b)),c.doc.addEventListener("touchstart",c$.bind(null,b)),c.doc.addEventListener("touchmove",c_.bind(null,b)),c.doc.addEventListener("touchend",c0.bind(null,b)))}},onRelocate:a=>{let c=a.detail;D(b,c.cfi,c.tocItem,c.section,c.location,c.time,c.range)},onRendererRelocate:a=>{let c=a.detail;if("scroll"!==c.reason&&"page"!==c.reason)return;let d=H(b);d&&d.size>0&&d.forEach(a=>{if(a!==b){let b=w(a)?.renderer;b&&b.goTo?.({index:c.index,anchor:c.fraction})}})}}),(0,d.useEffect)(()=>{U.current||(U.current=!0,setTimeout(()=>Z(!0),200),(async()=>{var c;let d;console.log("Opening book",b),await a.A(583521);let e=(d=(c=document.createElement("foliate-view")).addAnnotation.bind(c),c.addAnnotation=(a,b=!1)=>d({value:a.cfi,...a},b),c);e.id=`foliate-view-${b}`,T.current?.appendChild(e);let f=F(b),h=f.writingMode;if(h){let a=(0,ai.getBookDirFromWritingMode)(h),b=(0,ai.getBookDirFromLanguage)(g.metadata.language);"auto"!==a?g.dir=a:"auto"!==b&&(g.dir=b)}if(g.rendition?.layout==="pre-paginated"&&g.sections){g.rendition.spread=f.spreadMode;let a="rtl"===g.dir?"right":"left";g.sections[0].pageSpread=f.keepCoverSpread?"":a}await e.open(g),S.current=e,y(b,e);let{book:j}=e;j.transformTarget?.addEventListener("load",a=>{let{detail:b}=a;b.isScript&&(b.allow=f.allowScript??!1)});let k=m?.isMobile?screen.width:window.innerWidth,l=m?.isMobile?screen.height:window.innerHeight;j.transformTarget?.addEventListener("data",(({width:a,height:c})=>d=>{let{detail:e}=d;e.data=Promise.resolve(e.data).then(d=>{let f=F(b),g=L(b);if(f&&"text/css"===e.type)return(0,at.transformStylesheet)(d,a,c,f.vertical);let h="application/xhtml+xml"===e.type||"text/html"===e.type;return f&&g&&h?Promise.resolve(d2({bookKey:b,viewSettings:f,width:a,height:c,primaryLanguage:g.book?.primaryLanguage,userLocale:(0,K.getLocale)(),content:d,sectionHref:e.name,transformers:["style","punctuation","footnote","whitespace","language","sanitizer","simplecc","proofread"]})):d}).catch(a=>(console.error(Error(`Failed to load ${e.name}`,{cause:a})),""))})({width:k,height:l})),e.renderer.setStyles?.((0,at.getStyles)(f)),(0,at.applyTranslationStyle)(f),V.current=f.disableDoubleClick;let n=f.animated,o=f.isEink,p=f.maxColumnCount,q=(0,c1.getMaxInlineSize)(f),r=f.maxBlockSize,s=f.screenOrientation;m?.isMobileApp&&await (0,B.lockScreenOrientation)({orientation:s}),n?e.renderer.setAttribute("animated",""):e.renderer.removeAttribute("animated"),m?.isAndroidApp&&(o?e.renderer.setAttribute("eink",""):e.renderer.removeAttribute("eink"),N(o)),g?.rendition?.layout==="pre-paginated"?(e.renderer.setAttribute("zoom",f.zoomMode),e.renderer.setAttribute("spread",f.spreadMode),e.renderer.setAttribute("scale-factor",f.zoomLevel)):(e.renderer.setAttribute("max-column-count",p),e.renderer.setAttribute("max-inline-size",`${q}px`),e.renderer.setAttribute("max-block-size",`${r}px`)),ak();let t=i.location;t?await e.init({lastLocation:t}):await e.goToFraction(0),C(b,!0)})())},[]);let ak=()=>{let a=F(b),c=E(b),d=cx(a),e=a.vertical&&a.doubleBorder,f=e&&a.showHeader,g=e&&a.showFooter,h=a.showHeader&&!a.vertical,i=a.showFooter&&!a.vertical,l=h?Math.max(0,44-k.top):0,m=c?.ttsEnabled&&a.showTTSBar?52+.33*j.bottom:0,n=i?Math.max(0,Math.max(m,44)-k.bottom):Math.max(0,m),o=(h?k.top:d.top)+l,p=k.right+32*!!f,q=(i?k.bottom:d.bottom)+n,r=k.left+32*!!g,s=a.showMarginsOnScroll&&a.scrolled;S.current?.renderer.setAttribute("margin-top",`${s?0:o}px`),S.current?.renderer.setAttribute("margin-right",`${p}px`),S.current?.renderer.setAttribute("margin-bottom",`${s?0:q}px`),S.current?.renderer.setAttribute("margin-left",`${r}px`),S.current?.renderer.setAttribute("gap",`${a.gapPercent}%`),a.scrolled&&S.current?.renderer.setAttribute("flow","scrolled")};(0,d.useEffect)(()=>{if(S.current&&S.current.renderer){let a=F(b);S.current.renderer.setStyles?.((0,at.getStyles)(a)),S.current.renderer.getContents().forEach(({doc:b})=>{g.rendition?.layout==="pre-paginated"&&(0,at.applyFixedlayoutStyles)(b,a),(0,at.applyThemeModeClass)(b,r),(0,at.applyScrollModeClass)(b,a.scrolled||!1)})}},[q,r,R?.scrolled,R?.overrideColor,R?.invertImgColorInDark]),(0,d.useEffect)(()=>{let a=async()=>{await t(p),v().forEach(a=>{(0,A.mountCustomFont)(document,a);let b=S.current?.renderer.getContents();b?.forEach(({doc:b})=>(0,A.mountCustomFont)(b,a))})};s.customFonts&&a()},[s.customFonts,p]),(0,d.useEffect)(()=>{R&&M(p,R)},[R?.backgroundTextureId,R?.backgroundOpacity,R?.backgroundSize,M]),(0,d.useEffect)(()=>{S.current&&S.current.renderer&&(V.current=!!R?.disableDoubleClick)},[R?.disableDoubleClick]),(0,d.useEffect)(()=>{S.current&&S.current.renderer&&R&&ak()},[k.top,k.right,k.bottom,k.left,R?.doubleBorder,R?.showHeader,R?.showFooter,R?.showTTSBar,Q?.ttsEnabled]);let al=R?.showMarginsOnScroll&&R?.scrolled;return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{ref:T,tabIndex:-1,role:"document","aria-label":l("Book Content"),className:"foliate-viewer h-[100%] w-[100%] focus:outline-none",style:{paddingTop:al?k.top:0,paddingBottom:al?k.bottom:0},...ah,...aj}),!$.current&&Y&&(0,c.jsx)(ax.default,{loading:!0}),"conflict"===_&&aa&&(0,c.jsx)(d4,{details:aa,onResolveWithLocal:ab,onResolveWithRemote:ac,onClose:ab})]})},d6=({bookKey:a,section:b,showDoubleBorder:d,isScrolled:g,isVertical:h,isEink:i,horizontalGap:k,contentInsets:l,gridInsets:m})=>{let p=(0,f.useTranslation)(),{appService:q}=(0,e.useEnv)(),{hoveredBookKey:r,setHoveredBookKey:s}=(0,o.useReaderStore)(),{systemUIVisible:t,statusBarHeight:u}=(0,n.useThemeStore)(),v=Math.max(m.top,q?.isAndroidApp&&t?u/2:0);return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:(0,j.default)("absolute left-0 right-0 top-0 z-10",g&&!h&&"bg-base-100"),style:{height:`${v}px`}}),(0,c.jsx)("div",{className:(0,j.default)("sectioninfo absolute flex items-center overflow-hidden font-sans",i?"text-sm font-normal":"text-neutral-content text-xs font-light",h?"writing-vertical-rl max-h-[85%]":"top-0 h-[44px]",g&&!h&&"bg-base-100"),role:"none",onClick:()=>s(a),style:h?{top:`${(l.top-m.top)*1.5}px`,right:d?`calc(${l.right}px)`:`calc(${Math.max(0,l.right-32)}px)`,width:d?"32px":`${l.right}px`,height:`calc(100% - ${l.top+l.bottom}px)`}:{top:`${v}px`,paddingInline:`calc(${k/2}% + ${l.left/2}px)`,width:"100%"},children:(0,c.jsx)("span",{"aria-label":b?p("Section Title")+`: ${b}`:"",className:(0,j.default)("text-center",h?"":"line-clamp-1",!h&&r==a&&"hidden"),children:b||""})})]})};var d7=a.i(946687);let d8=(a,b)=>{if(!b)return b;let c=a.globalReadSettings.customHighlightColors;return c?.[b]??ap.HIGHLIGHT_COLOR_HEX[b]};var d9=a.i(627068);function ea({tipColor:a="#FFD700",tipStyle:b={},...c}){return(0,aC.GenIcon)({tag:"svg",attr:{viewBox:"0 0 256 256",fill:"none"},child:[{tag:"path",attr:{d:"M253.66,106.34a8,8,0,0,0-11.32,0L192,156.69,107.31,72l50.35-50.34a8,8,0,1,0-11.32-11.32L96,60.69A16,16,0,0,0,93.18,79.5L72,100.69a16,16,0,0,0,0,22.62L76.69,128,136,187.31l4.69,4.69a16,16,0,0,0,22.62,0l21.18-21.18A16,16,0,0,0,203.31,168l50.35-50.34A8,8,0,0,0,253.66,106.34ZM152,180.69,83.31,112,104,91.31,172.69,160Z",fill:"currentColor"},child:[]},{tag:"path",attr:{d:"M18.34,186.34c-4.209212,4.20621-2.516471,11.37196,3.13,13.25l72,24c0.815308,0.27382,1.669943,0.41232,2.53,0.41c2.12237,0.002,4.15842-0.84009,5.66-2.34L136,187.31c13.62143,13.61626-70.243446-70.24754-64-64l4.69,4.69z",fill:a,style:b},child:[]}]})(c)}var eb=a.i(940333);let ec=({selectedAction:a,onActionSelect:b,setIsDropdownOpen:d})=>{let e=(0,f.useTranslation)();return(0,c.jsx)(aP.default,{className:(0,j.default)("annotation-quick-action-menu dropdown-content z-20 mt-1 border","bgcolor-base-200 shadow-2xl"),style:{maxWidth:`${window.innerWidth-40}px`},onCancel:()=>d?.(!1),children:d9.annotationToolQuickActions.map(f=>(0,c.jsx)(aO.default,{label:e(f.label),tooltip:e(f.tooltip),buttonClass:a===f.type?"bg-base-300/85":"",Icon:f.Icon,onClick:()=>{var c;b(c=f.type),a===c?x.eventDispatcher.dispatch("toast",{type:"info",timeout:2e3,message:e("Quick action disabled")}):x.eventDispatcher.dispatch("toast",{type:"info",timeout:2e3,message:e(d9.annotationToolQuickActions.find(a=>a.type===c)?.tooltip||"")}),d?.(!1)}},f.type))})};var ed=a.i(280107);let ee=({icon:a,onClick:b,disabled:d=!1,label:f,className:g})=>{let{appService:h}=(0,e.useEnv)();return(0,c.jsx)("button",{className:(0,j.default)("btn btn-ghost h-8 min-h-8 w-8 p-0",h?.isMobileApp&&"hover:bg-transparent",d&&"cursor-default !bg-transparent opacity-50",g),title:f,"aria-label":f,onClick:d?void 0:b,children:a})},ef=({bookKey:a})=>{let b=(0,f.useTranslation)(),{sideBarBookKey:d,isSideBarVisible:e,setSideBarBookKey:g,toggleSideBar:h}=s(),{setHoveredBookKey:i}=(0,o.useReaderStore)();return(0,c.jsx)(ee,{icon:d===a&&e?(0,c.jsx)(ed.TbLayoutSidebarFilled,{className:"text-base-content"}):(0,c.jsx)(ed.TbLayoutSidebar,{className:"text-base-content"}),onClick:()=>{d===a?h():(g(a),e||h()),i("")},label:b("Toggle Sidebar")})},eg=({bookKey:a})=>{let b=(0,f.useTranslation)(),{envConfig:g}=(0,e.useEnv)(),{settings:i}=(0,h.useSettingsStore)(),{getConfig:j,saveConfig:k,getBookData:l,updateBooknotes:m}=(0,P.useBookDataStore)(),{getProgress:n,getViewState:p,setBookmarkRibbonVisibility:q}=(0,o.useReaderStore)(),[r,s]=(0,d.useState)(!1),t=j(a),u=n(a),v=()=>{let b=l(a),c=j(a),d=n(a);if(!b||!c||!d)return;let{booknotes:e=[]}=c,{location:f,range:h}=d;if(f)if(p(a)?.ribbonVisible){s(!1),e.forEach(a=>{"bookmark"===a.type&&b4(a.cfi,f)&&(a.deletedAt=Date.now())});let b=m(a,e);b&&k(g,a,b,i)}else{s(!0);let c=h?.startContainer.textContent?.slice(0,128)||"",j=128===c.length?c+"...":c,l={id:(0,K.uniqueId)(),type:"bookmark",cfi:f,text:j||`${(0,ai.getCurrentPage)(b.book,d)}`,note:"",createdAt:Date.now(),updatedAt:Date.now()},n=e.find(a=>"bookmark"===a.type&&a.cfi===f);n?(n.deletedAt=null,n.updatedAt=Date.now(),n.text=l.text):e.push(l);let o=m(a,e);o&&k(g,a,o,i)}};return(0,d.useEffect)(()=>{let b=b=>{let{bookKey:c}=b.detail;c===a&&v()};return x.eventDispatcher.on("toggle-bookmark",b),()=>{x.eventDispatcher.off("toggle-bookmark",b)}},[a]),(0,d.useEffect)(()=>{let{booknotes:b=[]}=t||{},{location:c}=u||{};if(!c)return;let d=b.filter(a=>"bookmark"===a.type&&!a.deletedAt).some(a=>b4(a.cfi,c));s(d),q(a,d)},[t,u]),(0,c.jsx)(ee,{icon:r?(0,c.jsx)(aF.MdOutlineBookmark,{className:"text-base-content"}):(0,c.jsx)(aF.MdOutlineBookmarkAdd,{className:"text-base-content"}),onClick:v,label:b(r?"Remove Bookmark":"Add Bookmark")})},eh=({bookKey:a})=>{let b=(0,f.useTranslation)(),{appService:d}=(0,e.useEnv)(),{setHoveredBookKey:g}=(0,o.useReaderStore)(),{sideBarBookKey:h,setSideBarBookKey:i}=s(),{isNotebookVisible:j,toggleNotebook:k}=t(),l=(0,aH.useResponsiveSize)(16);return(0,c.jsx)(ee,{icon:(0,c.jsx)(cq.LuNotebookPen,{size:l,className:"text-base-content"}),onClick:()=>{d?.isMobile&&g(""),h===a?k():(i(a),j||k())},label:b("Notebook")})},ei=({bookKey:a})=>{let b=(0,f.useTranslation)(),{setHoveredBookKey:d}=(0,o.useReaderStore)(),{isSettingsDialogOpen:e,setSettingsDialogOpen:g}=(0,h.useSettingsStore)(),{setSettingsDialogBookKey:i}=(0,h.useSettingsStore)();return(0,c.jsx)(ee,{icon:(0,c.jsx)(O.RiFontSize,{className:"text-base-content"}),onClick:()=>{d(""),i(a),g(!e)},label:b("Font & Layout")})};var ej=a.i(568338);let ek=({bookKey:a})=>{let b=(0,f.useTranslation)(),{envConfig:g,appService:h}=(0,e.useEnv)(),{getBookData:i}=(0,P.useBookDataStore)(),{getViewSettings:j,setViewSettings:k,setHoveredBookKey:l}=(0,o.useReaderStore)(),m=i(a),n=j(a),[p,q]=(0,d.useState)(n.translationEnabled),[r,s]=(0,d.useState)((0,ej.isTranslationAvailable)(m?.book,n.translateTargetLang));return(0,d.useEffect)(()=>{p!==n.translationEnabled&&(h?.isMobile&&l(""),(0,aN.saveViewSettings)(g,a,"translationEnabled",p,!0,!1),n.translationEnabled=p,k(a,{...n}))},[p]),(0,d.useEffect)(()=>{q(n.translationEnabled),s((0,ej.isTranslationAvailable)(m?.book,n.translateTargetLang))},[m,n.translationEnabled,n.translateTargetLang]),(0,c.jsx)(ee,{icon:(0,c.jsx)(O.RiTranslateAi,{className:p?"text-blue-500":"text-base-content"}),"aria-label":b("Toggle Translation"),disabled:!r&&!p,onClick:()=>q(!p),label:b(r?p?"Disable Translation":"Enable Translation":"Translation Disabled")})};var el=a.i(513786);let em=({bookKey:a,setIsDropdownOpen:b})=>{let g=(0,f.useTranslation)(),i=(0,k.useRouter)(),{user:l}=(0,aK.useAuth)(),{envConfig:m,appService:p}=(0,e.useEnv)(),{getConfig:q,getBookData:r}=(0,P.useBookDataStore)(),{setSettingsDialogOpen:s,setSettingsDialogBookKey:t}=(0,h.useSettingsStore)(),{getView:u,getViewSettings:v,getViewState:w,setViewSettings:y}=(0,o.useReaderStore)(),z=q(a),A=r(a),B=v(a),C=w(a),{themeMode:D,isDarkMode:E,setThemeMode:F}=(0,n.useThemeStore)(),[G,H]=(0,d.useState)(B.scrolled),[I,J]=(0,d.useState)(B.zoomLevel),[K,L]=(0,d.useState)(B.zoomMode),[M,N]=(0,d.useState)(B.spreadMode),[O,Q]=(0,d.useState)(B.keepCoverSpread),[R,S]=(0,d.useState)(B.invertImgColorInDark);(0,d.useEffect)(()=>{G!==B.scrolled&&(B.scrolled=G,u(a)?.renderer.setAttribute("flow",G?"scrolled":"paginated"),u(a)?.renderer.setAttribute("max-inline-size",`${(0,c1.getMaxInlineSize)(B)}px`),u(a)?.renderer.setStyles?.((0,at.getStyles)(B)),y(a,B))},[G]),(0,d.useEffect)(()=>{(0,aN.saveViewSettings)(m,a,"zoomLevel",I,!0,!0),A.bookDoc?.rendition?.layout==="pre-paginated"&&u(a)?.renderer.setAttribute("scale-factor",I)},[I]),(0,d.useEffect)(()=>{R!==B.invertImgColorInDark&&(0,aN.saveViewSettings)(m,a,"invertImgColorInDark",R,!0,!0)},[R]),(0,d.useEffect)(()=>{K!==B.zoomMode&&(B.zoomMode=K,u(a)?.renderer.setAttribute("zoom",K),y(a,B),(0,aN.saveViewSettings)(m,a,"zoomMode",K,!0,!1))},[K]),(0,d.useEffect)(()=>{M!==B.spreadMode&&(B.spreadMode=M,u(a)?.renderer.setAttribute("spread",M),y(a,B),(0,aN.saveViewSettings)(m,a,"spreadMode",M,!0,!1))},[M]),(0,d.useEffect)(()=>{if(O===B.keepCoverSpread||!A?.bookDoc?.sections?.length)return;B.keepCoverSpread=O;let b="rtl"===A.bookDoc.dir?"right":"left";A.bookDoc.sections[0].pageSpread=O?"":b,u(a)?.renderer.setAttribute("spread",M),y(a,B),(0,aN.saveViewSettings)(m,a,"keepCoverSpread",O,!0,!1)},[O]);let T=Math.max(z?.lastSyncedAtConfig||0,z?.lastSyncedAtNotes||0);return(0,c.jsxs)(aP.default,{className:(0,j.default)("view-menu dropdown-content dropdown-right no-triangle z-20 mt-1 border","bgcolor-base-200 shadow-2xl"),style:{maxWidth:`${window.innerWidth-40}px`,marginRight:window.innerWidth<640?"-36px":"0px"},onCancel:()=>b?.(!1),children:[A.bookDoc?.rendition?.layout==="pre-paginated"&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("div",{title:g("Zoom Level"),className:(0,j.default)("flex items-center justify-between rounded-md"),children:[(0,c.jsx)("button",{title:g("Zoom Out"),onClick:()=>J(a=>Math.max(a-ap.ZOOM_STEP,ap.MIN_ZOOM_LEVEL)),className:(0,j.default)("hover:bg-base-300 text-base-content rounded-full p-2",I<=ap.MIN_ZOOM_LEVEL&&"btn-disabled text-gray-400"),children:(0,c.jsx)(aF.MdZoomOut,{})}),(0,c.jsxs)("button",{title:g("Reset Zoom"),className:(0,j.default)("hover:bg-base-300 text-base-content h-8 min-h-8 w-[50%] rounded-md p-1 text-center"),onClick:()=>J(100),children:[I,"%"]}),(0,c.jsx)("button",{title:g("Zoom In"),onClick:()=>J(a=>Math.min(a+ap.ZOOM_STEP,ap.MAX_ZOOM_LEVEL)),className:(0,j.default)("hover:bg-base-300 text-base-content rounded-full p-2",I>=ap.MAX_ZOOM_LEVEL&&"btn-disabled text-gray-400"),children:(0,c.jsx)(aF.MdZoomIn,{})})]}),(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("div",{title:g("Zoom Mode"),className:(0,j.default)("my-2 flex items-center justify-between rounded-md"),children:[(0,c.jsx)("button",{title:g("Single Page"),onClick:N.bind(null,"none"),className:(0,j.default)("hover:bg-base-300 text-base-content rounded-full p-2","none"===M&&"bg-base-300/75"),children:(0,c.jsx)(ed.TbColumns1,{})}),(0,c.jsx)("button",{title:g("Auto Spread"),onClick:N.bind(null,"auto"),className:(0,j.default)("hover:bg-base-300 text-base-content rounded-full p-2","auto"===M&&"bg-base-300/75"),children:(0,c.jsx)(ed.TbColumns2,{})}),(0,c.jsx)("div",{className:"bg-base-300 mx-2 h-6 w-[1px]"}),(0,c.jsx)("button",{title:g("Fit Page"),onClick:L.bind(null,"fit-page"),className:(0,j.default)("hover:bg-base-300 text-base-content rounded-full p-2","fit-page"===K&&"bg-base-300/75"),children:(0,c.jsx)(ca.IoMdExpand,{})}),(0,c.jsx)("button",{title:g("Fit Width"),onClick:L.bind(null,"fit-width"),className:(0,j.default)("hover:bg-base-300 text-base-content rounded-full p-2","fit-width"===K&&"bg-base-300/75"),children:(0,c.jsx)(ed.TbArrowAutofitWidth,{})})]}),(0,c.jsx)(aO.default,{label:g("Separate Cover Page"),Icon:O?aF.MdCheck:void 0,onClick:()=>Q(!O),disabled:"none"===M})]}),(0,c.jsx)("hr",{"aria-hidden":"true",className:"border-base-300 my-1"})]}),(0,c.jsx)(aO.default,{label:g("Font & Layout"),shortcut:"Shift+F",onClick:()=>{b?.(!1),t(a),s(!0)}}),(0,c.jsx)(aO.default,{label:g("Scrolled Mode"),shortcut:"Shift+J",Icon:G?aF.MdCheck:void 0,onClick:()=>H(!G),disabled:A.isFixedLayout}),(0,c.jsx)("hr",{"aria-hidden":"true",className:"border-base-300 my-1"}),(0,c.jsx)(aO.default,{label:l?T?g("Synced at {{time}}",{time:new Date(T).toLocaleString()}):g("Never synced"):g("Sign in to Sync"),Icon:l?aF.MdSync:aF.MdSyncProblem,iconClassName:l&&C?.syncing?"animate-reverse-spin":"",onClick:()=>{l?x.eventDispatcher.dispatch("sync-book-progress",{bookKey:a}):((0,ag.navigateToLogin)(i),b?.(!1))}}),(0,c.jsx)("hr",{"aria-hidden":"true",className:"border-base-300 my-1"}),p?.hasWindow&&(0,c.jsx)(aO.default,{label:g("Fullscreen"),onClick:()=>{(0,ae.tauriHandleToggleFullScreen)(),b?.(!1)}}),(0,c.jsx)(aO.default,{label:g("dark"===D?"Dark Mode":"light"===D?"Light Mode":"Auto Mode"),Icon:"dark"===D?el.BiMoon:"light"===D?el.BiSun:ed.TbSunMoon,onClick:()=>{F("auto"===D?"light":"light"===D?"dark":"auto")}}),(0,c.jsx)(aO.default,{label:g("Invert Image In Dark Mode"),disabled:!E,Icon:R?aF.MdCheck:void 0,onClick:()=>S(!R)})]})},en=({bookKey:a,bookTitle:b,isTopLeft:g,isHoveredAnim:i,gridInsets:k,onCloseBook:l})=>{let m=(0,f.useTranslation)(),{envConfig:p,appService:q}=(0,e.useEnv)(),{settings:r}=(0,h.useSettingsStore)(),{isTrafficLightVisible:t}=(0,aG.useTrafficLight)(),{trafficLightInFullscreen:u,setTrafficLightVisibility:v}=(0,d7.useTrafficLightStore)(),{bookKeys:w,hoveredBookKey:x}=(0,o.useReaderStore)(),{isDarkMode:y,systemUIVisible:z,statusBarHeight:A}=(0,n.useThemeStore)(),{isSideBarVisible:B}=s(),{getView:C,getViewSettings:D,setHoveredBookKey:E}=(0,o.useReaderStore)(),F=D(a),[G,H]=(0,d.useState)(!1),I=C(a),J=(0,aH.useResponsiveSize)(16),K=(0,d.useRef)(null),L=q?.hasWindowBar&&!t,M=(I?.renderer.getContents()??[]).some(({doc:a})=>a?.body?.style.cursor==="pointer"),N=F?.enableAnnotationQuickActions,O=d9.annotationToolQuickActions.find(a=>a.type===F?.annotationQuickAction)||d9.annotationToolQuickActions[0],P=F?.annotationQuickAction,Q=O.Icon,R=r.globalReadSettings.highlightStyle,S=r.globalReadSettings.highlightStyles[R],T=d8(r,S),U=a=>{H(a),a||E("")};(0,d.useEffect)(()=>{q?.hasTrafficLight&&!B&&(x===a&&g?v(!0,{x:10,y:20}):x||v(!1))},[q,B,x]);let V=(0,d.useCallback)((a,b)=>{if(!K.current)return!0;let c=K.current.getBoundingClientRect();return a<=c.left||a>=c.right||b<=c.top||b>=c.bottom},[]),W=x===a||G,X=q?.hasTrafficLight&&!u&&!B&&g;return(0,c.jsxs)("div",{className:(0,j.default)("bg-base-100 absolute top-0 w-full"),style:{paddingTop:q?.hasSafeAreaInset?`${k.top}px`:"0px"},children:[(0,c.jsx)("div",{role:"none",className:(0,j.default)("absolute top-0 z-10 h-11 w-full",M&&"pointer-events-none"),onClick:()=>E(a),onMouseEnter:()=>!q?.isMobile&&E(a),onTouchStart:()=>!q?.isMobile&&E(a)}),(0,c.jsx)("div",{className:(0,j.default)("bg-base-100 absolute left-0 right-0 top-0 z-10",q?.hasRoundedWindow&&"rounded-window-top-right",W?"visible":"hidden"),style:{height:z?`${Math.max(k.top,A)}px`:"0px"}}),(0,c.jsxs)("div",{ref:K,role:"group","aria-label":m("Header Bar"),className:(0,j.default)("header-bar bg-base-100 absolute top-0 z-10 flex h-11 w-full items-center pr-4","shadow-xs transition-[opacity,margin-top] duration-300",X?"pl-20":"pl-4",q?.hasRoundedWindow&&"rounded-window-top-right",!B&&q?.hasRoundedWindow&&"rounded-window-top-left",i&&"hover-bar-anim",W?"pointer-events-auto visible":"pointer-events-none opacity-0",G&&"header-bar-pinned"),style:{marginTop:z?`${Math.max(k.top,A)}px`:`${k.top}px`},onFocus:()=>!q?.isMobile&&E(a),onMouseLeave:a=>{!q?.isMobile&&V(a.clientX,a.clientY)&&E("")},children:[(0,c.jsxs)("div",{className:"bg-base-100 sidebar-bookmark-toggler z-20 flex h-full items-center gap-x-4 pe-2",children:[(0,c.jsx)("div",{className:"hidden sm:flex",children:(0,c.jsx)(ef,{bookKey:a})}),(0,c.jsx)(eg,{bookKey:a}),(0,c.jsx)(ek,{bookKey:a}),N&&(0,c.jsx)(aI.default,{label:m(P?"Disable Quick Action":"Enable Quick Action on Selection"),className:"exclude-title-bar-mousedown dropdown-bottom",buttonClassName:(0,j.default)("btn btn-ghost h-8 min-h-8 w-8 p-0",F?.annotationQuickAction&&"bg-base-300/50"),toggleButton:"highlight"===P||null===P?(0,c.jsx)(ea,{size:J,tipColor:null===P?"#8F8F8F":T,tipStyle:{opacity:null===P?.5:.8,mixBlendMode:y?"screen":"multiply"}}):(0,c.jsx)(Q,{size:J}),onToggle:U,children:(0,c.jsx)(ec,{selectedAction:F.annotationQuickAction,onActionSelect:b=>{F?.annotationQuickAction===b&&(b=null),(0,aN.saveViewSettings)(p,a,"annotationQuickAction",b,!1,!0)}})})]}),(0,c.jsx)("div",{role:"contentinfo","aria-label":m("Title")+" - "+b,className:(0,j.default)("header-title z-15 bg-base-100 pointer-events-none hidden flex-1 items-center justify-center sm:flex",!L&&"absolute inset-0"),children:(0,c.jsx)("div",{"aria-hidden":"true",className:(0,j.default)("line-clamp-1 text-center text-xs font-semibold",!L&&"max-w-[50%]"),children:b})}),(0,c.jsxs)("div",{className:"bg-base-100 z-20 ml-auto flex h-full items-center space-x-4 ps-2",children:[(0,c.jsx)(ei,{bookKey:a}),(0,c.jsx)(eh,{bookKey:a}),(0,c.jsx)(aI.default,{label:m("View Options"),className:"exclude-title-bar-mousedown dropdown-bottom dropdown-end",buttonClassName:"btn btn-ghost h-8 min-h-8 w-8 p-0",toggleButton:(0,c.jsx)(cb.PiDotsThreeVerticalBold,{size:J}),onToggle:U,children:(0,c.jsx)(em,{bookKey:a})}),(0,c.jsx)(eb.default,{className:"window-buttons flex h-full items-center",headerRef:K,showMinimize:1==w.length&&L,showMaximize:1==w.length&&L,onClose:()=>{E(null),l(a)}})]})]})]})},eo=(a,b,c)=>a?c:b,ep=(a,b,c)=>a?c:b,eq=(a,b,c)=>a?c:b,er=({label:a,min:b=0,max:e=100,step:f=1,initialValue:g=50,heightPx:h=40,minLabel:i="",maxLabel:j="",minIcon:k,maxIcon:l,bubbleElement:m,bubbleLabel:n="",className:o="",minClassName:p="",maxClassName:q="",bubbleClassName:r="",onChange:s,valueToPosition:t,positionToValue:u})=>{let[v,w]=(0,d.useState)(g),[x,y]=(0,d.useState)(!1),z=(0,d.useRef)(null),A=u||((a,b,c)=>b+a/100*(c-b));(0,d.useEffect)(()=>{let a=z.current;for(;a;){if("rtl"===a.getAttribute("dir")){y(!0);break}a=a.parentElement}},[]),(0,d.useEffect)(()=>{w(g)},[g]);let B=(t||((a,b,c)=>(a-b)/(c-b)*100))(v,b,e),C=B/100*95;return(0,c.jsx)("div",{ref:z,"aria-label":a,className:`slider bg-base-200 mx-auto w-full rounded-xl ${o}`,dir:x?"rtl":void 0,children:(0,c.jsxs)("div",{className:"relative",style:{height:`${h}px`},children:[(0,c.jsx)("div",{className:"bg-base-300/40 absolute h-full w-full rounded-full"}),(0,c.jsx)("div",{className:"bg-base-300 absolute h-full rounded-full",style:{width:C>0?`max(calc(${C}% + ${h/2}px), ${h}px)`:"0px",[x?"right":"left"]:0}}),(0,c.jsxs)("div",{className:"absolute inset-0 flex items-center justify-between px-4 text-sm",children:[k||(0,c.jsx)("span",{className:`ml-2 ${p}`,children:i}),l||(0,c.jsx)("span",{className:`mr-2 ${q}`,children:j})]}),(0,c.jsx)("div",{className:"pointer-events-none absolute top-0 z-10",style:{[x?"right":"left"]:`max(${h/2}px, calc(${C}%))`,transform:x?"translateX(calc(50%))":"translateX(calc(-50%))",height:"100%"},children:(0,c.jsx)("div",{className:`bg-base-200 flex h-full items-center justify-center rounded-full text-xs shadow-md ${r}`,style:{width:`${h}px`},children:m||n})}),(0,c.jsx)("input",{type:"range",min:0,max:100,step:f,value:B,className:"absolute inset-0 h-full w-full cursor-pointer opacity-0",onChange:a=>{let c=Math.round(A(parseInt(a.target.value,10),b,e)/f)*f;w(c),s&&s(c)},"aria-label":a,"aria-valuemin":b,"aria-valuemax":e,"aria-valuenow":v,"aria-valuetext":`${v}`,"aria-orientation":"horizontal"})]})})},es=({bookKey:a,actionTab:b,progressFraction:e,progressValid:g,navigationHandlers:h,viewSettings:i,bottomOffset:k,sliderHeight:l})=>{let m=(0,f.useTranslation)(),{getView:n}=(0,o.useReaderStore)(),p=n(a),[q,r]=d.default.useState(g?100*e:0);(0,d.useEffect)(()=>{g&&r(100*e)},[g,e]);let s=(0,d.useCallback)(a=>{r(a),h.onProgressChange(a)},[h]),t=(0,j.default)("footerbar-progress-mobile bg-base-200 absolute flex w-full flex-col items-center gap-y-8 px-4 transition-all sm:hidden","progress"===b?"pointer-events-auto translate-y-0 pb-4 pt-8 ease-out":"pointer-events-none invisible translate-y-full overflow-hidden pb-0 pt-0 ease-in");return(0,c.jsxs)("div",{className:t,style:{bottom:k},children:[(0,c.jsx)("div",{className:"flex w-full items-center justify-between gap-x-6",children:(0,c.jsx)(er,{label:m("Reading Progress"),heightPx:l,bubbleLabel:`${Math.round(q)}%`,initialValue:q,onChange:s})}),(0,c.jsxs)("div",{className:"flex w-full items-center justify-between gap-x-6",children:[(0,c.jsx)(ee,{icon:eo(i?.rtl,(0,c.jsx)(O.RiArrowLeftDoubleLine,{}),(0,c.jsx)(O.RiArrowRightDoubleLine,{})),onClick:eq(i?.rtl,h.onPrevSection,h.onNextSection),label:ep(i?.rtl,m("Previous Section"),m("Next Section"))}),(0,c.jsx)(ee,{icon:eo(i?.rtl,(0,c.jsx)(O.RiArrowLeftSLine,{}),(0,c.jsx)(O.RiArrowRightSLine,{})),onClick:eq(i?.rtl,h.onPrevPage,h.onNextPage),label:ep(i?.rtl,m("Previous Page"),m("Next Page"))}),(0,c.jsx)(ee,{icon:eo(i?.rtl,(0,c.jsx)(O.RiArrowGoBackLine,{}),(0,c.jsx)(O.RiArrowGoForwardLine,{})),onClick:h.onGoBack,label:m("Go Back"),disabled:!p?.history.canGoBack}),(0,c.jsx)(ee,{icon:eo(i?.rtl,(0,c.jsx)(O.RiArrowGoForwardLine,{}),(0,c.jsx)(O.RiArrowGoBackLine,{})),onClick:h.onGoForward,label:m("Go Forward"),disabled:!p?.history.canGoForward}),(0,c.jsx)(ee,{icon:eo(i?.rtl,(0,c.jsx)(O.RiArrowRightSLine,{}),(0,c.jsx)(O.RiArrowLeftSLine,{})),onClick:eq(i?.rtl,h.onNextPage,h.onPrevPage),label:ep(i?.rtl,m("Next Page"),m("Previous Page"))}),(0,c.jsx)(ee,{icon:eo(i?.rtl,(0,c.jsx)(O.RiArrowRightDoubleLine,{}),(0,c.jsx)(O.RiArrowLeftDoubleLine,{})),onClick:eq(i?.rtl,h.onNextSection,h.onPrevSection),label:ep(i?.rtl,m("Next Section"),m("Previous Section"))})]})]})};function et(a){return(0,aC.GenIcon)({tag:"svg",attr:{viewBox:"0 0 15 15",fill:"none"},child:[{tag:"path",attr:{fillRule:"evenodd",clipRule:"evenodd",d:"M3.78233 2.21713C3.70732 2.14212 3.60557 2.09998 3.49949 2.09998C3.3934 2.09998 3.29166 2.14212 3.21664 2.21713L1.21664 4.21713C1.06044 4.37334 1.06044 4.62661 1.21664 4.78282C1.37285 4.93903 1.62612 4.93903 1.78233 4.78282L3.09949 3.46566L3.09949 11.5343L1.78233 10.2171C1.62612 10.0609 1.37285 10.0609 1.21664 10.2171C1.06043 10.3733 1.06043 10.6266 1.21664 10.7828L3.21664 12.7828C3.29166 12.8578 3.3934 12.9 3.49949 12.9C3.60557 12.9 3.70731 12.8578 3.78233 12.7828L5.78233 10.7828C5.93854 10.6266 5.93854 10.3733 5.78233 10.2171C5.62612 10.0609 5.37285 10.0609 5.21664 10.2171L3.89949 11.5343L3.89949 3.46566L5.21664 4.78282C5.37285 4.93903 5.62612 4.93903 5.78233 4.78282C5.93854 4.62661 5.93854 4.37334 5.78233 4.21713L3.78233 2.21713ZM8.49998 3.99997C8.22383 3.99997 7.99998 4.22382 7.99998 4.49997C7.99998 4.77611 8.22383 4.99997 8.49998 4.99997H14.5C14.7761 4.99997 15 4.77611 15 4.49997C15 4.22382 14.7761 3.99997 14.5 3.99997H8.49998ZM7.99998 7.49997C7.99998 7.22382 8.22383 6.99997 8.49998 6.99997H14.5C14.7761 6.99997 15 7.22382 15 7.49997C15 7.77611 14.7761 7.99997 14.5 7.99997H8.49998C8.22383 7.99997 7.99998 7.77611 7.99998 7.49997ZM8.49998 9.99997C8.22383 9.99997 7.99998 10.2238 7.99998 10.5C7.99998 10.7761 8.22383 11 8.49998 11H14.5C14.7761 11 15 10.7761 15 10.5C15 10.2238 14.7761 9.99997 14.5 9.99997H8.49998Z",fill:"currentColor"},child:[]}]})(a)}function eu(a){return(0,aC.GenIcon)({tag:"svg",attr:{viewBox:"0 0 15 15",fill:"none"},child:[{tag:"path",attr:{fillRule:"evenodd",clipRule:"evenodd",d:"M10.3004 7.49991C10.3004 8.4943 9.49426 9.30041 8.49988 9.30041C7.50549 9.30041 6.69938 8.4943 6.69938 7.49991C6.69938 6.50553 7.50549 5.69942 8.49988 5.69942C9.49426 5.69942 10.3004 6.50553 10.3004 7.49991ZM11.205 8C10.9699 9.28029 9.84816 10.2504 8.49988 10.2504C7.1516 10.2504 6.0299 9.28029 5.79473 8H0.5C0.223858 8 0 7.77614 0 7.5C0 7.22386 0.223858 7 0.5 7H5.7947C6.0298 5.71962 7.15154 4.74942 8.49988 4.74942C9.84822 4.74942 10.97 5.71962 11.2051 7H14.5C14.7761 7 15 7.22386 15 7.5C15 7.77614 14.7761 8 14.5 8H11.205Z",fill:"currentColor"},child:[]}]})(a)}let ev={MAX_MARGIN_PX:88,MAX_GAP_PERCENT:10,MARGIN_RATIO:50},ew=({bookKey:a,actionTab:b,bottomOffset:g,marginIconSize:h})=>{let i=(0,f.useTranslation)(),{envConfig:k}=(0,e.useEnv)(),{getView:l,getViewSettings:m}=(0,o.useReaderStore)(),n=m(a),p=l(a),q=(0,d.useCallback)(b=>{(0,aN.saveViewSettings)(k,a,"defaultFontSize",b)},[k,a]),r=(0,d.useCallback)(b=>{let c=m(a);if(!c)return;let{MAX_MARGIN_PX:d,MAX_GAP_PERCENT:e}=ev,f=Math.round(b/100*d),g=Math.round(b/100*e);c.marginTopPx=f,c.marginBottomPx=f/2,c.marginLeftPx=f/2,c.marginRightPx=f/2,(0,aN.saveViewSettings)(k,a,"gapPercent",g,!1,!1),p?.renderer.setAttribute("margin",`${f}px`),p?.renderer.setAttribute("gap",`${g}%`),c?.scrolled&&p?.renderer.setAttribute("flow","scrolled")},[k,a,p,m]),s=(0,d.useCallback)(b=>{(0,aN.saveViewSettings)(k,a,"lineHeight",b/10)},[k,a]),t=(0,d.useCallback)((a,b)=>{let{MAX_MARGIN_PX:c,MAX_GAP_PERCENT:d,MARGIN_RATIO:e}=ev;return(a/c+b/d)*e},[]),u=(0,j.default)("footerbar-font-mobile bg-base-200 absolute flex w-full flex-col items-center gap-y-8 px-4 transition-all sm:hidden","font"===b?"pointer-events-auto translate-y-0 pb-4 pt-8 ease-out":"pointer-events-none invisible translate-y-full overflow-hidden pb-0 pt-0 ease-in");return(0,c.jsxs)("div",{className:u,style:{bottom:g},children:[(0,c.jsx)(er,{label:i("Font Size"),initialValue:n?.defaultFontSize??16,bubbleLabel:`${n?.defaultFontSize??16}`,minLabel:"A",maxLabel:"A",minClassName:"text-xs",maxClassName:"text-base",onChange:q,min:8,max:30}),(0,c.jsxs)("div",{className:"flex w-full items-center justify-between gap-x-6",children:[(0,c.jsx)(er,{label:i("Page Margin"),initialValue:t(n?.marginTopPx??44,n?.gapPercent??5),bubbleElement:(0,c.jsx)(ed.TbBoxMargin,{size:h}),minLabel:i("Small"),maxLabel:i("Large"),step:10,onChange:r}),(0,c.jsx)(er,{label:i("Line Spacing"),initialValue:(n?.lineHeight??1.6)*10,bubbleElement:(0,c.jsx)(et,{size:h}),minLabel:i("Small"),maxLabel:i("Large"),min:8,max:24,onChange:s})]})]})};var ex=a.i(667954);let ey=({actionTab:a,bottomOffset:b})=>{let g=(0,f.useTranslation)(),{envConfig:i,appService:k}=(0,e.useEnv)(),{settings:l}=(0,h.useSettingsStore)(),{getScreenBrightness:m,setScreenBrightness:o}=(0,u.useDeviceControlStore)(),{themeMode:p,themeColor:q,isDarkMode:r,setThemeMode:s,setThemeColor:t}=(0,n.useThemeStore)(),[v,w]=(0,d.useState)(l.screenBrightness>=0?l.screenBrightness:50);(0,d.useEffect)(()=>{k?.isMobileApp&&"color"===a&&m().then(a=>{a>=0&&a<=1&&w(Math.round(100*a))})},[a,k,m]);let x=(0,d.useMemo)(()=>(0,J.debounce)(async a=>{(0,aN.saveSysSettings)(i,"screenBrightness",a),(0,aN.saveSysSettings)(i,"autoScreenBrightness",!1),await o(a/100)},100),[i,o]),y=(0,d.useCallback)(async a=>{k?.isMobileApp&&(w(a),x(a))},[k,x]),z=(0,j.default)("footerbar-color-mobile bg-base-200 absolute flex w-full flex-col items-center gap-y-8 px-4 transition-all sm:hidden","color"===a?"pointer-events-auto translate-y-0 pb-4 pt-8 ease-out":"pointer-events-none invisible translate-y-full overflow-hidden pb-0 pt-0 ease-in");return(0,c.jsxs)("div",{className:z,style:{bottom:b},children:[k?.hasScreenBrightness&&(0,c.jsx)(er,{label:g("Screen Brightness"),initialValue:v,bubbleLabel:`${v}`,minIcon:(0,c.jsx)(cb.PiSun,{size:16}),maxIcon:(0,c.jsx)(cb.PiSun,{size:24}),onChange:y,min:0,max:100,valueToPosition:(a,b,c)=>a<=b?0:a>=c?100:100*Math.pow(a/c,.5),positionToValue:(a,b,c)=>{if(a<=0)return b;if(a>=100)return c;let d=Math.pow(a/100,2)*c;return Math.max(b,Math.min(c,d))}}),(0,c.jsxs)("div",{className:"w-full",children:[(0,c.jsx)("div",{className:"flex items-center justify-between p-2",children:(0,c.jsx)("span",{className:"text-sm font-medium",children:g("Color")})}),(0,c.jsxs)("div",{className:"flex gap-3 overflow-x-auto p-2",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:[ex.themes.map(({name:a,label:b,colors:d})=>(0,c.jsx)("button",{onClick:()=>t(a),className:(0,j.default)("flex flex-shrink-0 flex-col items-center justify-center rounded-lg p-3 transition-all","h-[40px] min-w-[80px]",q===a?"ring-primary ring-offset-base-200 ring-2 ring-offset-2":"hover:opacity-80"),style:{backgroundColor:r?d.dark["base-100"]:d.light["base-100"],color:r?d.dark["base-content"]:d.light["base-content"]},children:(0,c.jsx)("span",{className:"text-xs font-medium",children:g(b)})},a)),(0,c.jsx)("button",{onClick:()=>void s("auto"===p?"light":"light"===p?"dark":"auto"),className:(0,j.default)("flex flex-shrink-0 flex-col items-center justify-center rounded-lg p-3 transition-all","h-[40px] min-w-[80px]","dark"===p?"ring-primary ring-offset-base-200 ring-2 ring-offset-2":"hover:opacity-80"),style:{backgroundColor:(ex.themes.find(a=>a.name===q)||ex.themes[0]).colors.dark["base-100"],color:(ex.themes.find(a=>a.name===q)||ex.themes[0]).colors.dark["base-content"]},children:"light"===p?(0,c.jsx)(cb.PiSun,{size:20}):"dark"===p?(0,c.jsx)(cb.PiMoon,{size:20}):(0,c.jsx)(ed.TbSunMoon,{size:20})})]})]})]})},ez=({bookKey:a,actionTab:b,navPadding:d,onSetActionTab:e})=>{let g=(0,f.useTranslation)(),{getViewState:h}=(0,o.useReaderStore)(),i=h(a),k=(0,aH.useResponsiveSize)(23),l=(0,aH.useResponsiveSize)(18);return(0,c.jsxs)("div",{className:(0,j.default)("bg-base-200 z-30 mt-auto flex w-full justify-between px-8 py-4 sm:hidden"),style:{paddingBottom:d},children:[(0,c.jsx)(ee,{label:g("Table of Contents"),icon:(0,c.jsx)(ca.IoIosList,{size:k}),onClick:()=>e("toc")}),(0,c.jsx)(ee,{label:g("Color"),icon:(0,c.jsx)(cb.PiSun,{className:(0,j.default)("color"===b&&"text-blue-500")}),onClick:()=>e("color")}),(0,c.jsx)(ee,{label:g("Reading Progress"),icon:(0,c.jsx)(eu,{className:(0,j.default)("progress"===b&&"text-blue-500")}),onClick:()=>e("progress")}),(0,c.jsx)(ee,{label:g("Font & Layout"),icon:(0,c.jsx)(O.RiFontFamily,{size:l,className:(0,j.default)("font"===b&&"text-blue-500")}),onClick:()=>e("font")}),(0,c.jsx)(ee,{label:g("Speak"),icon:(0,c.jsx)(aF.MdOutlineHeadphones,{className:i?.ttsEnabled?"text-blue-500":""}),onClick:()=>e("tts")})]})},eA=({bookKey:a,gridInsets:b,actionTab:d,progressValid:e,progressFraction:f,navigationHandlers:g,onSetActionTab:h})=>{let i=window.innerWidth<640||window.innerHeight<640,j=(0,aH.useResponsiveSize)(28),k=(0,aH.useResponsiveSize)(20),l=i?`${.33*b.bottom+64}px`:"64px",m=i?`${.33*b.bottom+16}px`:"0px";return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(ey,{actionTab:d,bottomOffset:l}),(0,c.jsx)(es,{bookKey:a,actionTab:d,progressFraction:f,progressValid:e,navigationHandlers:g,bottomOffset:l,sliderHeight:j}),(0,c.jsx)(ew,{bookKey:a,actionTab:d,bottomOffset:l,marginIconSize:k}),(0,c.jsx)(ez,{bookKey:a,actionTab:d,navPadding:m,onSetActionTab:h})]})};var eB=a.i(537447);let eC=(a,b,c=!1)=>{let d=b.toLowerCase();if(!d.startsWith("zh"))return a.toString();let e=d.includes("tw")||d.includes("hk"),f=c?"":"",g=(e?"":"").replace("",f),h=e?["","","","","",""]:["","","","","",""],i=String(a),j=i.length,k="";for(let a=0;a<j;a++){let b=Number(i[a]),c=j-a-1;0!==b?k+=g[b]+h[c%4]:!k.endsWith(f)&&a<j-1&&(k+=f),4===c&&(k+=h[4]),8===c&&(k+=h[5])}return k=k.replace(RegExp(`${f}+$`),"").replace(`${f}`,"").replace(`${f}`,"").replace(RegExp(`${f}+`,"g"),f),c||(k=e?k.replace(/^$/,"").replace(/(^|[^])([^]|$)/g,"$1$2"):k.replace(/^$/,"").replace(/(^|[^])([^]|$)/g,"$1$2")),k};function eD(a,b,c,d=!1,e="en",f=1){if(void 0===a||void 0===b||!(b>0)||!(a>=0))return"";{let g=d?eC(a+1,e,!0):String(a+1),h=d?eC(b,e,!0):String(b);return c.replace("{current}",g).replace("{total}",h).replace("{percent}",((a+1)/b*100).toFixed(f))}}function eE(a,b=!1,c="en"){return void 0===a||a<0?"":b?eC(a,c):String(a)}let eF=({bookKey:a,gridInsets:b,progressValid:e,progressFraction:g,navigationHandlers:h,onSpeakText:i})=>{let j=(0,f.useTranslation)(),{hoveredBookKey:k,getView:l,getViewState:m,getProgress:n,getViewSettings:p}=(0,o.useReaderStore)(),{getBookData:q}=(0,P.useBookDataStore)(),r=l(a),s=q(a),t=n(a),u=m(a),v=p(a),w=v?.progressStyle||"percentage",[x,y]=d.default.useState(e?100*g:0),{section:z,pageinfo:A}=t||{},B=s?.isFixedLayout?z:A,C=eD(B?.current,B?.total,"fraction"===w?"{current} / {total}":"{percent}%",!1,"en",0),D=(0,d.useRef)(null);(0,d.useEffect)(()=>{k!==a&&D.current&&document.activeElement===D.current&&D.current.blur()},[k,a]),(0,d.useEffect)(()=>{e&&y(100*g)},[e,g]);let E=(0,d.useCallback)(a=>{y(a),h.onProgressChange(a)},[h]),F=window.innerWidth<640||window.innerHeight<640;return(0,c.jsxs)("div",{className:"absolute hidden h-8 w-full items-center gap-x-4 px-4 sm:flex",style:{bottom:F?`${.33*b.bottom}px`:"0px"},children:[(0,c.jsx)(ee,{icon:eo(v?.rtl,(0,c.jsx)(O.RiArrowLeftDoubleLine,{}),(0,c.jsx)(O.RiArrowRightDoubleLine,{})),onClick:eq(v?.rtl,h.onPrevSection,h.onNextSection),label:ep(v?.rtl,j("Previous Section"),j("Next Section"))}),(0,c.jsx)(ee,{icon:eo(v?.rtl,(0,c.jsx)(O.RiArrowLeftSLine,{}),(0,c.jsx)(O.RiArrowRightSLine,{})),onClick:eq(v?.rtl,h.onPrevPage,h.onNextPage),label:ep(v?.rtl,j("Previous Page"),j("Next Page"))}),(0,c.jsx)(ee,{icon:eo(v?.rtl,(0,c.jsx)(O.RiArrowGoBackLine,{}),(0,c.jsx)(O.RiArrowGoForwardLine,{})),onClick:h.onGoBack,label:j("Go Back"),disabled:!r?.history.canGoBack}),(0,c.jsx)(ee,{icon:eo(v?.rtl,(0,c.jsx)(O.RiArrowGoForwardLine,{}),(0,c.jsx)(O.RiArrowGoBackLine,{})),onClick:h.onGoForward,label:j("Go Forward"),disabled:!r?.history.canGoForward}),e&&(0,c.jsx)("span",{title:j("Reading Progress"),"aria-label":`${j("Reading Progress")}: ${Math.round(100*g)}%`,className:"mx-2 text-center text-sm",children:(0,c.jsx)("span",{"aria-hidden":"true",children:C})}),(0,c.jsx)("input",{ref:D,type:"range",className:"text-base-content mx-2 min-w-0 flex-1",min:0,max:100,"aria-label":j("Jump to Location"),value:x,onChange:a=>E(parseInt(a.target.value,10))}),(0,c.jsx)(ee,{icon:(0,c.jsx)(eB.FaHeadphones,{className:u?.ttsEnabled?"text-blue-500":""}),onClick:i,label:j("Speak")}),(0,c.jsx)(ee,{icon:eo(v?.rtl,(0,c.jsx)(O.RiArrowRightSLine,{}),(0,c.jsx)(O.RiArrowLeftSLine,{})),onClick:eq(v?.rtl,h.onNextPage,h.onPrevPage),label:ep(v?.rtl,j("Next Page"),j("Previous Page"))}),(0,c.jsx)(ee,{icon:eo(v?.rtl,(0,c.jsx)(O.RiArrowRightDoubleLine,{}),(0,c.jsx)(O.RiArrowLeftDoubleLine,{})),onClick:eq(v?.rtl,h.onNextSection,h.onPrevSection),label:ep(v?.rtl,j("Next Section"),j("Previous Section"))})]})},eG=a=>a.replace(/\r\n/g,"  ").replace(/\r/g," ").replace(/\n/g," ").trimStart(),eH=(a,b)=>{let c="en",d=a.match(/xml:lang\s*=\s*"([^"]+)"/);if(d&&d[1]){let a=d[1].split("-");c=a.length>1?`${a[0].toLowerCase()}-${a[1].toUpperCase()}`:a[0].toLowerCase(),c=(0,ch.code6392to6391)(c)||c,(0,ch.isValidLang)(c)||(c="en")}b=(0,ch.code6392to6391)(b?.toLowerCase()||"")||b,"en"===c&&b&&!(0,ch.isSameLang)(c,b)&&(c=b.split("-")[0].toLowerCase());let e=a.replace(/<lang[^>]*>.*?<\/lang>/gs,"");return(0,ch.inferLangFromScript)(e,c)},eI=(a,b)=>{let c,d=eH(a,b)||"en";a=a.replace(/<speak[^>]*>/i,"").replace(/<\/speak>/i,"");let e="",f=[],g=null,h=d,i=[],j=/<(\/?)(\w+)([^>]*)>|([^<]+)/g;for(;null!==(c=j.exec(a));)if(c[4]){let a=c[4],b=eG(a);if(b&&g){let a=e.length;e+=b,f.push({offset:a,name:g,text:b,language:(0,ch.inferLangFromScript)(b,h)||h})}else e+=eG(a)}else{let a="/"===c[1],b=c[2],e=c[3];if("mark"!==b||a){if("lang"===b)if(a)h=i.pop()??d;else{i.push(h);let a=e?.match(/xml:lang="([^"]+)"/);a&&(h=a[1])}}else{let a=e?.match(/name="([^"]+)"/);a&&(g=a[1])}}return{plainText:e,marks:f}},eJ=["Albert","Bad News","Bahh","Bells","Boing","Bubbles","Cellos","Eddy","Flo","Fred","Good News","Grandma","Grandpa","Jester","Junior","Kathy","Organ","Ralph","Reed","Rocko","Sandy","Shelley","Superstar","Trinoids","Whisper","Wobble","Zarvox"];class eK{static LOCAL_STORAGE_KEY="ttsPreferredVoices";static PREFERRED_CLIENT_KEY="preferredClient";static normalizeLanguage(a){return a?a.toLowerCase().slice(0,2):"n/a"}static setPreferredClient(a){if(!a)return;let b=this.getPreferences();b[this.PREFERRED_CLIENT_KEY]=a,localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(b))}static setPreferredVoice(a,b,c){if(!a||!b||!c)return;let d=this.getPreferences(),e=this.normalizeLanguage(b);d[`${a}-${e}`]=c,localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(d))}static getPreferredClient(){return this.getPreferences()[this.PREFERRED_CLIENT_KEY]||null}static getPreferredVoice(a,b){let c=this.getPreferences(),d=this.normalizeLanguage(b);return c[`${a}-${d}`]||null}static getPreferences(){let a=localStorage.getItem(this.LOCAL_STORAGE_KEY);return a?JSON.parse(a):{}}static sortVoicesFunc(a,b){let c=a.lang.split("-")[1]||"",d=b.lang.split("-")[1]||"";return c===d?a.name<b.name?-1:+(a.name>b.name):"CN"===c?-1:"CN"===d?1:"TW"===c?-1:"TW"===d?1:"HK"===c?-1:"HK"===d?1:"US"===c?-1:"US"===d?1:"GB"===c?-1:"GB"===d?1:a.name<b.name?-1:+(a.name>b.name)}}async function*eL(a,b,c,d,e,f,g,h){let{marks:i}=eI(a,b),j=window.speechSynthesis,k=new SpeechSynthesisUtterance;for(let a of i){let{language:b}=a;h(a),k.text=a.text,k.rate=c(),k.pitch=d();let i=await e(b);i&&(k.voice=i,f(i.voiceURI)),b&&(k.lang=b,g(b)),yield{type:"boundary",speaking:!0,name:"sentence",mark:a.name};let l=await new Promise(a=>{k.onend=()=>a({type:"end",speaking:!1}),k.onerror=b=>a({type:"error",speaking:!1,error:b.error}),j.speak(k)});if(yield l,"error"===l.type)break}}class eM{name="web-speech";initialized=!1;controller;#a=[];#b="en";#c="";#d="";#e=1;#f=1;#g=window.speechSynthesis;constructor(a){this.controller=a}async init(){return this.#g?(await new Promise(a=>{let b=()=>{this.#a=this.#g.getVoices().map(a=>(a.id=a.voiceURI||a.name,a)),a()};this.#g.getVoices().length>0?b():void 0!==this.#g.onvoiceschanged?this.#g.onvoiceschanged=b:(console.warn("Voiceschanged event not supported."),a())}),this.initialized=!0):this.initialized=!1,this.initialized}getVoiceIdFromLang=async a=>{let b=eK.getPreferredVoice(this.name,a),c=this.#a.find(a=>a.id===b)||(await this.getVoices(a))[0]?.voices[0]||null;return c?.id||this.#d||""};getWebSpeechVoiceFromLang=async a=>{let b=await this.getVoiceIdFromLang(a);return this.#a.find(a=>a.id===b)||null};async *speak(a,b,c=!1){if(!c)for await(let c of eL(a,this.#b,()=>this.#e,()=>this.#f,this.getWebSpeechVoiceFromLang,a=>this.#d=a,a=>this.#c=a,a=>this.controller?.dispatchSpeakMark(a))){if(b.aborted){console.log("TTS aborted"),yield{code:"error",message:"Aborted"};return}"boundary"===c.type?yield{code:"boundary",mark:c.mark??"",message:`${c.name??"Unknown"} ${c.charIndex??0}/${c.charLength??0}`}:"error"===c.type?yield{code:"error",message:c.error??"Unknown error"}:"end"===c.type&&(yield{code:"end",message:"Speech finished"})}}async pause(){return this.#g.pause(),!0}async resume(){return this.#g.resume(),!0}async stop(){this.#g.cancel()}setPrimaryLang(a){this.#b=a}async setRate(a){this.#e=a}async setPitch(a){this.#f=a}async setVoice(a){let b=this.#a.find(b=>b.id===a);b&&(this.#d=b.id)}async getAllVoices(){return this.#a.map(a=>({id:a.id,name:a.name,lang:a.lang,disabled:!this.initialized}))}async getVoices(a){let b="en"===a&&(0,K.getUserLocale)(a)||a,c=this.#a.filter(c=>c.lang.startsWith(b)||"en"===a&&["en-US","en-GB"].includes(c.lang)).filter(a=>{let b;return!(b=a.voiceURI||"").includes("com.apple")||b.includes("com.apple.voice.compact")}).filter(a=>!1===eJ.some(b=>a.name.includes(b))),d=new Set,e=c.map(a=>({id:a.voiceURI,name:a.name,lang:a.lang})).filter(a=>!d.has(a.id)&&(d.add(a.id),!0));return e.forEach(a=>{a.disabled=!this.initialized}),[{id:"web-speech-api",name:"Web TTS",voices:e.sort(eK.sortVoicesFunc),disabled:!this.initialized||0===e.length}]}getGranularities(){return["sentence"]}getVoiceId(){return this.#d}getSpeakingLang(){return this.#c}async shutdown(){this.initialized=!1,this.#a=[],await this.stop()}}var eN=a.i(101986),eO=a.i(254799);class eP{capacity;map;onEvict;constructor(a,b){if(a<=0)throw Error("LRUCache capacity must be greater than 0");this.capacity=a,this.map=new Map,this.onEvict=b}get(a){if(!this.map.has(a))return;let b=this.map.get(a);return this.map.delete(a),this.map.set(a,b),b}set(a,b){if(this.map.has(a)){let b=this.map.get(a);this.map.delete(a),this.onEvict&&this.onEvict(a,b)}else if(this.map.size===this.capacity){let a=this.map.keys().next().value;if(a){let b=this.map.get(a);this.map.delete(a),this.onEvict&&this.onEvict(a,b)}}this.map.set(a,b)}has(a){return this.map.has(a)}delete(a){if(this.map.has(a)){let b=this.map.get(a),c=this.map.delete(a);return c&&this.onEvict&&this.onEvict(a,b),c}return!1}clear(){if(this.onEvict)for(let[a,b]of this.map)this.onEvict(a,b);this.map.clear()}size(){return this.map.size}entries(){return Array.from(this.map).reverse()}}var eQ=a.i(476719);let eR="6A5AA1D4EAFF4E9FB37E23D68491D6F4",eS="143.0.3650.75",eT=eS.split(".")[0],eU={"af-ZA":["af-ZA-AdriNeural","af-ZA-WillemNeural"],"am-ET":["am-ET-AmehaNeural","am-ET-MekdesNeural"],"ar-AE":["ar-AE-FatimaNeural","ar-AE-HamdanNeural"],"ar-BH":["ar-BH-AliNeural","ar-BH-LailaNeural"],"ar-DZ":["ar-DZ-AminaNeural","ar-DZ-IsmaelNeural"],"ar-EG":["ar-EG-SalmaNeural","ar-EG-ShakirNeural"],"ar-IQ":["ar-IQ-BasselNeural","ar-IQ-RanaNeural"],"ar-JO":["ar-JO-SanaNeural","ar-JO-TaimNeural"],"ar-KW":["ar-KW-FahedNeural","ar-KW-NouraNeural"],"ar-LB":["ar-LB-LaylaNeural","ar-LB-RamiNeural"],"ar-LY":["ar-LY-ImanNeural","ar-LY-OmarNeural"],"ar-MA":["ar-MA-JamalNeural","ar-MA-MounaNeural"],"ar-OM":["ar-OM-AbdullahNeural","ar-OM-AyshaNeural"],"ar-QA":["ar-QA-AmalNeural","ar-QA-MoazNeural"],"ar-SA":["ar-SA-HamedNeural","ar-SA-ZariyahNeural"],"ar-SY":["ar-SY-AmanyNeural","ar-SY-LaithNeural"],"ar-TN":["ar-TN-HediNeural","ar-TN-ReemNeural"],"ar-YE":["ar-YE-MaryamNeural","ar-YE-SalehNeural"],"az-AZ":["az-AZ-BabekNeural","az-AZ-BanuNeural"],"bg-BG":["bg-BG-BorislavNeural","bg-BG-KalinaNeural"],"bn-BD":["bn-BD-NabanitaNeural","bn-BD-PradeepNeural"],"bn-IN":["bn-IN-BashkarNeural","bn-IN-TanishaaNeural"],"bs-BA":["bs-BA-GoranNeural","bs-BA-VesnaNeural"],"ca-ES":["ca-ES-EnricNeural","ca-ES-JoanaNeural"],"cs-CZ":["cs-CZ-AntoninNeural","cs-CZ-VlastaNeural"],"cy-GB":["cy-GB-AledNeural","cy-GB-NiaNeural"],"da-DK":["da-DK-ChristelNeural","da-DK-JeppeNeural"],"de-AT":["de-AT-IngridNeural","de-AT-JonasNeural"],"de-CH":["de-CH-JanNeural","de-CH-LeniNeural"],"de-DE":["de-DE-AmalaNeural","de-DE-ConradNeural","de-DE-FlorianMultilingualNeural","de-DE-KatjaNeural","de-DE-KillianNeural","de-DE-SeraphinaMultilingualNeural"],"el-GR":["el-GR-AthinaNeural","el-GR-NestorasNeural"],"en-AU":["en-AU-NatashaNeural","en-AU-WilliamNeural"],"en-CA":["en-CA-ClaraNeural","en-CA-LiamNeural"],"en-GB":["en-GB-LibbyNeural","en-GB-MaisieNeural","en-GB-RyanNeural","en-GB-SoniaNeural","en-GB-ThomasNeural"],"en-HK":["en-HK-SamNeural","en-HK-YanNeural"],"en-IE":["en-IE-ConnorNeural","en-IE-EmilyNeural"],"en-IN":["en-IN-NeerjaExpressiveNeural","en-IN-NeerjaNeural","en-IN-PrabhatNeural"],"en-KE":["en-KE-AsiliaNeural","en-KE-ChilembaNeural"],"en-NG":["en-NG-AbeoNeural","en-NG-EzinneNeural"],"en-NZ":["en-NZ-MitchellNeural","en-NZ-MollyNeural"],"en-PH":["en-PH-JamesNeural","en-PH-RosaNeural"],"en-SG":["en-SG-LunaNeural","en-SG-WayneNeural"],"en-TZ":["en-TZ-ElimuNeural","en-TZ-ImaniNeural"],"en-US":["en-US-AnaNeural","en-US-AndrewMultilingualNeural","en-US-AndrewNeural","en-US-AriaNeural","en-US-AvaMultilingualNeural","en-US-AvaNeural","en-US-BrianMultilingualNeural","en-US-BrianNeural","en-US-ChristopherNeural","en-US-EmmaMultilingualNeural","en-US-EmmaNeural","en-US-EricNeural","en-US-GuyNeural","en-US-JennyNeural","en-US-MichelleNeural","en-US-RogerNeural","en-US-SteffanNeural"],"es-AR":["es-AR-ElenaNeural","es-AR-TomasNeural"],"es-BO":["es-BO-MarceloNeural","es-BO-SofiaNeural"],"es-CL":["es-CL-CatalinaNeural","es-CL-LorenzoNeural"],"es-CO":["es-CO-GonzaloNeural","es-CO-SalomeNeural"],"es-CR":["es-CR-JuanNeural","es-CR-MariaNeural"],"es-CU":["es-CU-BelkysNeural","es-CU-ManuelNeural"],"es-DO":["es-DO-EmilioNeural","es-DO-RamonaNeural"],"es-EC":["es-EC-AndreaNeural","es-EC-LuisNeural"],"es-ES":["es-ES-AlvaroNeural","es-ES-ElviraNeural","es-ES-XimenaNeural"],"es-US":["es-US-AlonsoNeural","es-US-PalomaNeural"],"et-EE":["et-EE-AnuNeural","et-EE-KertNeural"],"fa-IR":["fa-IR-DilaraNeural","fa-IR-FaridNeural"],"fi-FI":["fi-FI-HarriNeural","fi-FI-NooraNeural"],"fil-PH":["fil-PH-AngeloNeural","fil-PH-BlessicaNeural"],"fr-BE":["fr-BE-CharlineNeural","fr-BE-GerardNeural"],"fr-CA":["fr-CA-AntoineNeural","fr-CA-JeanNeural","fr-CA-SylvieNeural","fr-CA-ThierryNeural"],"fr-CH":["fr-CH-ArianeNeural","fr-CH-FabriceNeural"],"fr-FR":["fr-FR-DeniseNeural","fr-FR-EloiseNeural","fr-FR-HenriNeural","fr-FR-RemyMultilingualNeural","fr-FR-VivienneMultilingualNeural"],"ga-IE":["ga-IE-ColmNeural","ga-IE-OrlaNeural"],"gl-ES":["gl-ES-RoiNeural","gl-ES-SabelaNeural"],"gu-IN":["gu-IN-DhwaniNeural","gu-IN-NiranjanNeural"],"he-IL":["he-IL-AvriNeural","he-IL-HilaNeural"],"hi-IN":["hi-IN-MadhurNeural","hi-IN-SwaraNeural"],"hr-HR":["hr-HR-GabrijelaNeural","hr-HR-SreckoNeural"],"hu-HU":["hu-HU-NoemiNeural","hu-HU-TamasNeural"],"id-ID":["id-ID-ArdiNeural","id-ID-GadisNeural"],"is-IS":["is-IS-GudrunNeural","is-IS-GunnarNeural"],"it-IT":["it-IT-DiegoNeural","it-IT-ElsaNeural","it-IT-GiuseppeMultilingualNeural","it-IT-IsabellaNeural"],"iu-Cans-CA":["iu-Cans-CA-SiqiniqNeural","iu-Cans-CA-TaqqiqNeural"],"iu-Latn-CA":["iu-Latn-CA-SiqiniqNeural","iu-Latn-CA-TaqqiqNeural"],"ja-JP":["ja-JP-KeitaNeural","ja-JP-NanamiNeural"],"jv-ID":["jv-ID-DimasNeural","jv-ID-SitiNeural"],"ka-GE":["ka-GE-EkaNeural","ka-GE-GiorgiNeural"],"kk-KZ":["kk-KZ-AigulNeural","kk-KZ-DauletNeural"],"km-KH":["km-KH-PisethNeural","km-KH-SreymomNeural"],"kn-IN":["kn-IN-GaganNeural","kn-IN-SapnaNeural"],"ko-KR":["ko-KR-HyunsuMultilingualNeural","ko-KR-InJoonNeural","ko-KR-SunHiNeural"],"lo-LA":["lo-LA-ChanthavongNeural","lo-LA-KeomanyNeural"],"lt-LT":["lt-LT-LeonasNeural","lt-LT-OnaNeural"],"lv-LV":["lv-LV-EveritaNeural","lv-LV-NilsNeural"],"mk-MK":["mk-MK-AleksandarNeural","mk-MK-MarijaNeural"],"ml-IN":["ml-IN-MidhunNeural","ml-IN-SobhanaNeural"],"mn-MN":["mn-MN-BataaNeural","mn-MN-YesuiNeural"],"mr-IN":["mr-IN-AarohiNeural","mr-IN-ManoharNeural"],"ms-MY":["ms-MY-OsmanNeural","ms-MY-YasminNeural"],"mt-MT":["mt-MT-GraceNeural","mt-MT-JosephNeural"],"my-MM":["my-MM-NilarNeural","my-MM-ThihaNeural"],"nb-NO":["nb-NO-FinnNeural","nb-NO-PernilleNeural"],"ne-NP":["ne-NP-HemkalaNeural","ne-NP-SagarNeural"],"nl-BE":["nl-BE-ArnaudNeural","nl-BE-DenaNeural"],"nl-NL":["nl-NL-ColetteNeural","nl-NL-FennaNeural","nl-NL-MaartenNeural"],"pl-PL":["pl-PL-MarekNeural","pl-PL-ZofiaNeural"],"ps-AF":["ps-AF-GulNawazNeural","ps-AF-LatifaNeural"],"pt-BR":["pt-BR-AntonioNeural","pt-BR-FranciscaNeural","pt-BR-ThalitaMultilingualNeural"],"pt-PT":["pt-PT-DuarteNeural","pt-PT-RaquelNeural"],"ro-RO":["ro-RO-AlinaNeural","ro-RO-EmilNeural"],"ru-RU":["ru-RU-DmitryNeural","ru-RU-SvetlanaNeural"],"si-LK":["si-LK-SameeraNeural","si-LK-ThiliniNeural"],"sk-SK":["sk-SK-LukasNeural","sk-SK-ViktoriaNeural"],"sl-SI":["sl-SI-PetraNeural","sl-SI-RokNeural"],"so-SO":["so-SO-MuuseNeural","so-SO-UbaxNeural"],"sq-AL":["sq-AL-AnilaNeural","sq-AL-IlirNeural"],"sr-RS":["sr-RS-NicholasNeural","sr-RS-SophieNeural"],"su-ID":["su-ID-JajangNeural","su-ID-TutiNeural"],"sv-SE":["sv-SE-MattiasNeural","sv-SE-SofieNeural"],"sw-KE":["sw-KE-RafikiNeural","sw-KE-ZuriNeural"],"sw-TZ":["sw-TZ-DaudiNeural","sw-TZ-RehemaNeural"],"ta-IN":["ta-IN-PallaviNeural","ta-IN-ValluvarNeural"],"ta-LK":["ta-LK-KumarNeural","ta-LK-SaranyaNeural"],"ta-MY":["ta-MY-KaniNeural","ta-MY-SuryaNeural"],"ta-SG":["ta-SG-AnbuNeural","ta-SG-VenbaNeural"],"te-IN":["te-IN-MohanNeural","te-IN-ShrutiNeural"],"th-TH":["th-TH-NiwatNeural","th-TH-PremwadeeNeural"],"tr-TR":["tr-TR-AhmetNeural","tr-TR-EmelNeural"],"uk-UA":["uk-UA-OstapNeural","uk-UA-PolinaNeural"],"ur-IN":["ur-IN-GulNeural","ur-IN-SalmanNeural"],"ur-PK":["ur-PK-AsadNeural","ur-PK-UzmaNeural"],"uz-UZ":["uz-UZ-MadinaNeural","uz-UZ-SardorNeural"],"vi-VN":["vi-VN-HoaiMyNeural","vi-VN-NamMinhNeural"],"zh-CN":["zh-CN-XiaoxiaoNeural","zh-CN-XiaoyiNeural","zh-CN-YunjianNeural","zh-CN-YunxiNeural","zh-CN-YunxiaNeural","zh-CN-YunyangNeural","zh-CN-liaoning-XiaobeiNeural","zh-CN-shaanxi-XiaoniNeural"],"zh-HK":["zh-HK-HiuGaaiNeural","zh-HK-HiuMaanNeural","zh-HK-WanLungNeural"],"zh-TW":["zh-TW-HsiaoChenNeural","zh-TW-HsiaoYuNeural","zh-TW-YunJheNeural"],"zu-ZA":["zu-ZA-ThandoNeural","zu-ZA-ThembaNeural"]};class eV{static voices=Object.entries(eU).flatMap(([a,b])=>b.map(b=>({name:b.replace(`${a}-`,"").replace("Neural",""),id:b,lang:a})));static audioCache=new eP(200);static audioUrlCache=new eP(200,(a,b)=>{b.startsWith("blob:")&&URL.revokeObjectURL(b)});protocol="wss";constructor(a){a&&(this.protocol=a)}async #h({lang:a,text:b,voice:c,rate:d}){let e=(0,z.getNodeAPIBaseUrl)()+"/tts/edge",f=await (0,eQ.fetchWithAuth)(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:b,voice:c,rate:d,lang:a})});if(!f.ok)throw Error(`Edge TTS HTTP request failed: ${f.status} ${f.statusText}`);return f}async #i({lang:b,text:c,voice:d,rate:e}){let f,g,h,i,j=(0,K.randomMd5)(),k=new URLSearchParams({ConnectionId:j,TrustedClientToken:eR,"Sec-MS-GEC":(f=Math.floor(Date.now()/1e3)+0x2b6109100,f-=f%300,f*=1e7,g=`${f.toFixed(0)}${eR}`,(0,eO.createHash)("sha256").update(g,"ascii").digest("hex").toUpperCase()),"Sec-MS-GEC-Version":`1-${eS}`}),l=`wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1?${k.toString()}`,m=new Date().toString(),n={"User-Agent":`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${eT}.0.0.0 Safari/537.36 Edg/${eT}.0.0.0`,"Accept-Encoding":"gzip, deflate, br, zstd","Accept-Language":"en-US,en;q=0.9",Pragma:"no-cache","Cache-Control":"no-cache",Origin:"chrome-extension://jdiccldimpdaibmpdkjnbmckianbfold","Sec-WebSocket-Version":"13",Cookie:`muid=${(h=new Uint8Array(16),crypto.getRandomValues(h),Array.from(h).map(a=>a.toString(16).padStart(2,"0")).join("").toUpperCase())};`},o=JSON.stringify({context:{synthesis:{audio:{metadataoptions:{sentenceBoundaryEnabled:!1,wordBoundaryEnabled:!0},outputFormat:"audio-24khz-48kbitrate-mono-mp3"}}}}),p=(a,b)=>{let c="";for(let b of Object.keys(a))c+=`${b}: ${a[b]}\r
`;return`${c}\r
${b}`},q=a=>{let b=a.split("\n"),c={},d="",e=0;for(e=0;e<b.length;e++){let a=b[e].trim();if(!a)break;let d=a.indexOf(":");if(-1===d)continue;let f=a.slice(0,d).trim(),g=a.slice(d+1).trim();c[f]=g}for(e+=1;e<b.length;e++)d+=b[e]+"\n";return{headers:c,body:d}},r=p({"Content-Type":"application/ssml+xml",Path:"ssml","X-RequestId":j,"X-Timestamp":m},(i=c.replace(/^<break\b[^>]*>/i,""),`
    <speak version="1.0" xml:lang="${b}">
      <voice name="${d}">
        <prosody rate="${e}" >
            ${i}
        </prosody>
      </voice>
    </speak>
  `)),s=p({"Content-Type":"application/json; charset=utf-8",Path:"speech.config","X-Timestamp":m},o);return new Promise((0,z.isTauriAppPlatform)()?async(b,c)=>{try{let d=(await a.A(850973)).default,e=await d.connect(l,{headers:n}),f=new ArrayBuffer(0),g=await e.addListener(a=>{if("Text"===a.type){let{headers:d}=q(a.data);if("turn.end"===d.Path){if(e.disconnect(),g(),!f.byteLength)return c(Error("No audio data received."));let a=new Response(f);b(a)}}else if("Binary"===a.type){let b;b=a.data instanceof Uint8Array?a.data.buffer:new Uint8Array(a.data).buffer;let c=new DataView(b).getInt16(0);if(b.byteLength>c+2){let a=b.slice(2+c),d=new Uint8Array(f.byteLength+a.byteLength);d.set(new Uint8Array(f),0),d.set(new Uint8Array(a),f.byteLength),f=d.buffer}}});await e.send(s),await e.send(r)}catch(a){c(Error(`WebSocket error occurred: ${a}`))}}:(a,b)=>{let c=new eN.default(l,{headers:n});c.binaryType="arraybuffer";let d=new ArrayBuffer(0);c.addEventListener("open",()=>{c.send(s),c.send(r)}),c.addEventListener("message",e=>{if("string"==typeof e.data){let{headers:f}=q(e.data);if("turn.end"===f.Path){if(c.close(),!d.byteLength)return b(Error("No audio data received."));a(new Response(d))}}else if(e.data instanceof ArrayBuffer){let a=new DataView(e.data).getInt16(0);if(e.data.byteLength>a+2){let b=e.data.slice(2+a),c=new Uint8Array(d.byteLength+b.byteLength);c.set(new Uint8Array(d),0),c.set(new Uint8Array(b),d.byteLength),d=c.buffer}}}),c.addEventListener("close",()=>{d.byteLength||b(Error("No audio data received."))}),c.addEventListener("error",()=>{b(Error("WebSocket error occurred."))})})}async create(a){return"https"===this.protocol?this.#h(a):this.#i(a)}async createAudioUrl(a){let b,c=(b=JSON.stringify(a),(0,E.md5)(b));if(eV.audioUrlCache.has(c))return eV.audioUrlCache.get(c);try{let b=await this.create(a),d=await b.arrayBuffer(),e=new Blob([d],{type:"audio/mpeg"}),f=URL.createObjectURL(e);return eV.audioCache.set(c,e),eV.audioUrlCache.set(c,f),f}catch(a){throw a}}}class eW{name="edge-tts";initialized=!1;controller;#a=[];#b="en";#c="";#d="";#e=1;#f=1;#j=null;#k=null;#l=!1;#m=0;#n=0;#o=null;constructor(a){this.controller=a}async init(a="wss"){this.#j=new eV(a),this.#a=eV.voices;try{await this.#j.create({lang:"en",text:"test",voice:"en-US-AriaNeural",rate:1,pitch:1}),this.initialized=!0}catch{"wss"===a?this.controller?.isAuthenticated?await this.init("https"):this.controller?.dispatchEvent(new CustomEvent("tts-need-auth")):this.initialized=!1}return this.initialized}getPayload=(a,b,c)=>({lang:a,text:b,voice:c,rate:1,pitch:this.#f});getVoiceIdFromLang=async a=>{let b=eK.getPreferredVoice(this.name,a),c=this.#a.find(a=>a.id===b);if(c)return c.id;let d=((await this.getVoices(a))[0]?.voices||[])[0]||null;return d?.id==="en-US-AnaNeural"?"en-US-AriaNeural":d?.id||this.#d||"en-US-AriaNeural"};async *speak(a,b,c=!1){let{marks:d}=eI(a,this.#b);if(c){for(let a=0;a<Math.min(2,d.length)&&!b.aborted;a++){let b=d[a],{language:c}=b,e=await this.getVoiceIdFromLang(c);this.#d=e,await this.#j?.createAudioUrl(this.getPayload(c,b.text,e)).catch(b=>{console.warn("Error preloading mark",a,b)})}d.length>2&&(async()=>{for(let a=2;a<d.length;a++){let c=d[a];try{if(b.aborted)break;let{language:a}=c,d=await this.getVoiceIdFromLang(a);await this.#j?.createAudioUrl(this.getPayload(a,c.text,d))}catch(b){console.warn("Error preloading mark (bg)",a,b)}}})(),yield{code:"end",message:"Preload finished"};return}await this.stopInternal(),this.#k||(this.#k=new Audio);let e=this.#k;for(let a of(e.setAttribute("x-webkit-airplay","deny"),e.preload="auto",d)){this.controller?.dispatchSpeakMark(a);let c=null;try{let{language:d}=a,f=await this.getVoiceIdFromLang(d);this.#c=d;let g=await this.#j?.createAudioUrl(this.getPayload(d,a.text,f));if(b.aborted){yield{code:"error",message:"Aborted"};break}yield{code:"boundary",message:`Start chunk: ${a.name}`,mark:a.name};let h=await new Promise(d=>{let f=()=>{e.onended=null,e.onerror=null,e.src=""};(c=()=>{f(),d({code:"error",message:"Aborted"})},b.aborted)?c():(b.addEventListener("abort",c),e.onended=()=>{f(),d({code:"end",message:`Chunk finished: ${a.name}`})},e.onerror=a=>{f(),console.warn("Audio playback error:",a),d({code:"error",message:"Audio playback error"})},this.#l=!0,e.src=g||"",e.play().then(()=>e.playbackRate=this.#e).catch(a=>{f(),console.error("Failed to play audio:",a),d({code:"error",message:"Playback failed: "+a.message})}))});yield h}catch(c){if(c instanceof Error&&"No audio data received."===c.message){console.warn("No audio data received for:",a.text),yield{code:"end",message:`Chunk finished: ${a.name}`};continue}let b=c instanceof Error?c.message:String(c);console.warn("TTS error for mark:",a.text,b),yield{code:"error",message:b};break}finally{c&&b.removeEventListener("abort",c)}}await this.stopInternal()}async pause(){return!this.#l||!this.#k||(this.#m=this.#k.currentTime-this.#n,await this.#k.pause(),this.#l=!1,!0)}#p(){if(null!==this.#o)return this.#o;let a=navigator.userAgent,b=/Safari/.test(a)&&!/Chrome/.test(a),c=/iPad|iPhone|iPod/.test(a);return b||c?this.#o=.2:this.#o=0,this.#o}async resume(){if(this.#l||!this.#k)return!0;let a=this.#p();return this.#k.currentTime=Math.max(0,this.#k.currentTime-a),await this.#k.play(),this.#l=!0,this.#n=this.#k.currentTime-this.#m,!0}async stop(){await this.stopInternal()}async stopInternal(){this.#l=!1,this.#m=0,this.#n=0,this.#k&&(this.#k.pause(),this.#k.currentTime=0,this.#k?.onended&&this.#k.onended(new Event("stopped")),this.#k.src="")}async setRate(a){this.#e=a}async setPitch(a){this.#f=a}async setVoice(a){let b=this.#a.find(b=>b.id===a);b&&(this.#d=b.id)}async getAllVoices(){return this.#a.forEach(a=>{a.disabled=!this.initialized}),this.#a}async getVoices(a){let b="en"===a&&(0,K.getUserLocale)(a)||a,c=(await this.getAllVoices()).filter(c=>c.lang.startsWith(b)||"en"===a&&["en-US","en-GB"].includes(c.lang));return[{id:"edge-tts",name:"Edge TTS",voices:c.sort(eK.sortVoicesFunc),disabled:!this.initialized||0===c.length}]}setPrimaryLang(a){this.#b=a}getGranularities(){return["sentence"]}getVoiceId(){return this.#d}getSpeakingLang(){return this.#c}async shutdown(){this.initialized=!1,this.#k=null,this.#a=[]}}let eX={default:"System TTS",msctts:"Msc TTS",mstrans:"MSTrans TTS",microsoft:"Microsoft TTS",bytedance:"ByteDance TTS",peiyinya:"PeiYinYa TTS",huoshan:"HuoShan TTS",sougou:"Sougou TTS",xiaomi:"XiaoMi TTS",bdetts:"BDeTTS",bdotts:"BDoTTS",vcstts:"VcsTTS",isstts:"IssTTS",xfpeiyin:"XFPeiYin",azure:"Azure TTS",edgetts:"Edge TTS",google:"Google TTS",gemini:"Gemini TTS",weread:"WeRead TTS",aispeech:"Aispeech"};class eY{name="native-tts";initialized=!1;controller;#a=[];#b="en";#c="";#d="";#e=1;#f=1;#q=null;#r=new Map;constructor(a){this.controller=a}async setupEventListener(){try{if(this.#q)return;this.#q=await (0,ah.addPluginListener)("native-tts","tts_events",a=>{let{utteranceId:b,code:c,message:d,mark:e}=a,f=this.#r.get(b);if(!f)return;let g={code:c,message:d,mark:e};f.eventQueue.push(g),"end"===c||"error"===c?(f.finished=!0,f.resolver&&f.resolver({value:void 0,done:!0})):f.resolver&&(f.resolver({value:g,done:!1}),f.resolver=null)})}catch(a){console.error("Failed to setup TTS event listener:",a)}}async init(){let a=await (0,ah.invoke)("plugin:native-tts|init");return this.initialized=a.success,this.initialized&&this.setupEventListener(),this.initialized}async *speakMark(a,b,c){if(b)return void(yield{code:"end",message:"Dummy preload finished"});let{language:d}=a,e=await this.getVoiceIdFromLang(d);this.#d=e,this.#c=d,await this.setVoice(e);try{let d=(await (0,ah.invoke)("plugin:native-tts|speak",{payload:{text:a.text,preload:b}})).utteranceId;this.#r.set(d,{eventQueue:[],resolver:null,finished:!1});let e=()=>{let a=this.#r.get(d);a&&a.resolver&&(a.resolver({value:{code:"error",message:"Aborted"},done:!0}),a.resolver=null),this.stop()};c.addEventListener("abort",e);try{for(;;){let b=this.#r.get(d);if(!b)break;if(b.eventQueue.length>0){let c=b.eventQueue.shift();if(c.mark=a.name,yield c,"end"===c.code||"error"===c.code)break}else if(b.finished)break;else{let a=new Promise(a=>{let b=this.#r.get(d);if(!b)return a();b.resolver=b=>a(b.value?.code==="error"?b.value:void 0)}),b=new Promise(a=>setTimeout(()=>a(null),100)),c=await Promise.race([a,b]);c&&(yield c)}if(c.aborted)break}}finally{c.removeEventListener("abort",e),this.#r.delete(d)}}catch(a){throw console.error("Failed to speak:",a),a}}async *speak(a,b,c=!1){let{marks:d}=eI(a,this.#b);for(let a of d)for await(let d of(this.controller?.dispatchSpeakMark(a),this.speakMark(a,c,b))){if(b.aborted)return void(yield{code:"error",message:"Aborted"});yield d}}async getVoiceIdFromLang(a){let b=eK.getPreferredVoice(this.name,a),c=this.#a.find(a=>a.id===b)||(await this.getVoices(a))[0]?.voices[0]||null;return c?.id||""}async pause(){return await (0,ah.invoke)("plugin:native-tts|pause"),!1}async resume(){return await (0,ah.invoke)("plugin:native-tts|resume"),!1}async stop(){await (0,ah.invoke)("plugin:native-tts|stop"),this.#r.clear()}async setRate(a){this.#e=parseFloat(Math.pow(a,2.5).toFixed(2)),await (0,ah.invoke)("plugin:native-tts|set_rate",{payload:{rate:this.#e}})}async setPitch(a){this.#f=a,await (0,ah.invoke)("plugin:native-tts|set_pitch",{payload:{pitch:this.#f}})}async setVoice(a){this.#d=a,await (0,ah.invoke)("plugin:native-tts|set_voice",{payload:{voice:a}})}async getAllVoices(){if(this.#a.length>0)return this.#a;try{let a=await (0,ah.invoke)("plugin:native-tts|get_all_voices");return this.#a=a.voices,this.#a}catch(a){return console.error("Failed to get all voices:",a),[]}}async getVoices(a){let b="en"===a&&(0,K.getUserLocale)(a)||a,c=(await this.getAllVoices()).filter(c=>c.lang.startsWith(b)||"en"===a&&["en-US","en-GB"].includes(c.lang)),d=new Map;return c.forEach(a=>{let{name:b,lang:c}=a,e=a.id.split("_")[0];e in eX?a.name=b.replace(`${e}_`,"").replace(`${c}-`,"").replace("Neural","").trim():e="default",a.name=a.name.replace("NOT_SET",(0,K.stubTranslation)("Default")),d.has(e)||d.set(e,[]),d.get(e).push(a)}),Array.from(d.entries()).map(([a,b])=>({id:a,name:eX[a]||a,voices:b.sort(eK.sortVoicesFunc),disabled:!this.initialized||0===b.length})).sort((a,b)=>"default"===a.id?-1:"default"===b.id?1:a.id.localeCompare(b.id))}setPrimaryLang(a){this.#b=a}getGranularities(){return["sentence"]}getVoiceId(){return this.#d}getSpeakingLang(){return this.#c}async shutdown(){this.#q&&(this.#q.unregister(),this.#q=null),await this.stop()}}var eZ=a.i(822283);let e$="tts-highlight";class e_ extends EventTarget{appService=null;view;isAuthenticated=!1;preprocessCallback;#s=0;#t=null;#u=null;state="stopped";ttsLang="";ttsRate=1;ttsClient;ttsWebClient;ttsEdgeClient;ttsNativeClient=null;ttsWebVoices=[];ttsEdgeVoices=[];ttsNativeVoices=[];ttsTargetLang="";options={style:"highlight",color:"gray"};constructor(a,b,c=!1,d){super(),this.ttsWebClient=new eM(this),this.ttsEdgeClient=new eW(this),a?.isAndroidApp&&(this.ttsNativeClient=new eY(this)),this.ttsClient=this.ttsWebClient,this.appService=a,this.view=b,this.isAuthenticated=c,this.preprocessCallback=d}async init(){let a=[];await this.ttsEdgeClient.init()&&a.push(this.ttsEdgeClient),this.ttsNativeClient&&await this.ttsNativeClient.init()&&(a.push(this.ttsNativeClient),this.ttsNativeVoices=await this.ttsNativeClient.getAllVoices()),await this.ttsWebClient.init()&&a.push(this.ttsWebClient),this.ttsClient=a[0]||this.ttsWebClient;let b=eK.getPreferredClient();if(b){let c=a.find(a=>a.name===b);c&&(this.ttsClient=c)}this.ttsWebVoices=await this.ttsWebClient.getAllVoices(),this.ttsEdgeVoices=await this.ttsEdgeClient.getAllVoices()}#v(){return a=>{let{overlayer:b}=this.view.renderer.getContents()[0],{style:c,color:d}=this.options;b?.remove(e$),b?.add(e$,a,eZ.Overlayer[c],{color:d})}}#w(){let{overlayer:a}=this.view.renderer.getContents()?.[0]||{};a?.remove(e$)}async initViewTTS(a){a&&(this.options.style=a.style,this.options.color=a.color);let b=this.view.language.isCJK?"sentence":"word",c=this.ttsClient.getGranularities();c.includes(b)||(b=c[0]),await this.view.initTTS(b,ci({tags:["rt"],contents:[{tag:"a",content:/^[\[\(]?[\*\d]+[\)\]]?$/}]}),this.#v())}async preloadSSML(a,b){if(a)for await(let c of(await this.ttsClient.speak(a,b,!0)));}async preloadNextSSML(a=4){let b=this.view.tts;if(!b)return;let c=0;for(let d=0;d<a;d++){let a=await this.#x(b.next());this.preloadSSML(a,new AbortController().signal),a&&c++}for(let a=0;a<c;a++)b.prev()}async #x(a){if(a)return a=a.replace(/<emphasis[^>]*>([^<]+)<\/emphasis>/g,"$1").replace(/[]/g,",").replace("<break/>"," ").replace(/\.{3,}/g,"   ").replace(//g,"  ").replace(/\*/g," ").replace(//g," "),this.ttsTargetLang&&(a=((a,b,c)=>{let d,e=eH(a,c),f=(0,ch.code6392to6391)(b.toLowerCase())||b.toLowerCase();if((0,ch.isSameLang)(f,e))return a.replace(/<lang\s+xml:lang="([^"]+)"[^>]*>.*?<\/lang>/gs,(a,b)=>{let c=(0,ch.code6392to6391)(b.toLowerCase())||b.toLowerCase();return(0,ch.isSameLang)(c,e)?a:""});let g=[],h=/<lang\s+xml:lang="([^"]+)"[^>]*>(.*?)<\/lang>/gs,i=new RegExp(h.source,h.flags);for(;null!==(d=i.exec(a));){let a=(0,ch.code6392to6391)(d[1].toLowerCase())||d[1].toLowerCase();(0,ch.isSameLang)(a,f)&&g.push({match:d[0],lang:d[1],content:d[2]})}if(g.length>0){let b=a.match(/<speak[^>]*>/i),c=a.match(/<\/speak>/i);if(!b||!c)return a;let d=g.map(a=>a.match).join("");return`${b[0]}${d}${c[0]}`}return a})(a,this.ttsTargetLang)),this.preprocessCallback&&(a=await this.preprocessCallback(a)),a}async #y(a,b=!1){await this.stop(),this.#t=new AbortController;let{signal:c}=this.#t;this.#u=new Promise(async(d,e)=>{try{let e;if(console.log("TTS speak"),this.state="playing",c.addEventListener("abort",()=>{d()}),a=await this.#x(await a))this.#s=0;else{this.#s++,this.#s<10&&"playing"===this.state&&!b&&(d(),await this.view.next(),await this.forward()),console.log("no SSML, skipping for",this.#s);return}let{plainText:f,marks:g}=eI(a);if((!f||0===g.length)&&!b)return d(),await this.forward();for await(let{code:b}of(this.dispatchSpeakMark(g[0]),await this.preloadSSML(a,c),await this.ttsClient.speak(a,c))){if(c.aborted)return void d();e=b}"end"!==e||"playing"!==this.state||b||(d(),await this.forward()),d()}catch(a){c.aborted?d():e(a)}finally{this.#t&&(this.#t.abort(),this.#t=null)}}),await this.#u.catch(a=>this.error(a))}async speak(a,b=!1){await this.initViewTTS(),this.#y(a,b).catch(a=>this.error(a)),this.preloadNextSSML(),this.dispatchSpeakMark()}play(){"playing"!==this.state?this.start():this.pause()}async start(){await this.initViewTTS();let a=this.state.includes("paused")?this.view.tts?.resume():this.view.tts?.start();this.state.includes("paused")&&this.resume(),this.#y(a),this.preloadNextSSML()}async pause(){this.state="paused",await this.ttsClient.pause().catch(a=>this.error(a))||(await this.stop(),this.state="stop-paused")}async resume(){this.state="playing",await this.ttsClient.resume().catch(a=>this.error(a))}async stop(){if(this.#t&&this.#t.abort(),await this.ttsClient.stop().catch(a=>this.error(a)),this.#u){let a=new Promise((a,b)=>setTimeout(()=>b(Error("Stop operation timed out")),3e3));await Promise.race([this.#u.catch(a=>this.error(a)),a]).catch(a=>this.error(a)),this.#u=null}this.state="stopped"}async backward(a=!1){await this.initViewTTS(),"playing"===this.state?(await this.stop(),a?this.#y(this.view.tts?.prevMark()):this.#y(this.view.tts?.prev())):(await this.stop(),this.state="backward-paused",a?this.view.tts?.prevMark(!0):this.view.tts?.prev(!0))}async forward(a=!1){await this.initViewTTS(),"playing"===this.state?(await this.stop(),a?this.#y(this.view.tts?.nextMark()):(this.#y(this.view.tts?.next()),this.preloadNextSSML())):(await this.stop(),this.state="forward-paused",a?this.view.tts?.nextMark(!0):this.view.tts?.next(!0))}async setLang(a){this.ttsLang=a,this.setPrimaryLang(a)}async setPrimaryLang(a){this.ttsEdgeClient.initialized&&this.ttsEdgeClient.setPrimaryLang(a),this.ttsWebClient.initialized&&this.ttsWebClient.setPrimaryLang(a),this.ttsNativeClient?.initialized&&this.ttsNativeClient?.setPrimaryLang(a)}async setRate(a){this.state="setrate-paused",this.ttsRate=a,await this.ttsClient.setRate(this.ttsRate)}async getVoices(a){let b=await this.ttsWebClient.getVoices(a),c=await this.ttsEdgeClient.getVoices(a);return[...await this.ttsNativeClient?.getVoices(a)??[],...c,...b]}async setVoice(a,b){this.state="setvoice-paused";let c=!!this.ttsEdgeVoices.find(b=>(""===a||b.id===a)&&!b.disabled),d=!!this.ttsNativeVoices.find(b=>(""===a||b.id===a)&&!b.disabled);if(c)this.ttsClient=this.ttsEdgeClient,await this.ttsClient.setRate(this.ttsRate);else if(d){if(!this.ttsNativeClient)throw Error("Native TTS client is not available");this.ttsClient=this.ttsNativeClient,await this.ttsClient.setRate(this.ttsRate)}else this.ttsClient=this.ttsWebClient,await this.ttsClient.setRate(this.ttsRate);eK.setPreferredClient(this.ttsClient.name),eK.setPreferredVoice(this.ttsClient.name,b,a),await this.ttsClient.setVoice(a)}getVoiceId(){return this.ttsClient.getVoiceId()}getSpeakingLang(){return this.ttsClient.getSpeakingLang()}setTargetLang(a){this.ttsTargetLang=a}dispatchSpeakMark(a){if(this.dispatchEvent(new CustomEvent("tts-speak-mark",{detail:a||{text:""}})),a){let b=this.view.tts?.setMark(a.name);this.dispatchEvent(new CustomEvent("tts-highlight-mark",{detail:b}))}}error(a){console.error(a),this.state="stopped"}async shutdown(){await this.stop(),this.#w(),this.ttsWebClient.initialized&&await this.ttsWebClient.shutdown(),this.ttsEdgeClient.initialized&&await this.ttsEdgeClient.shutdown(),this.ttsNativeClient?.initialized&&await this.ttsNativeClient.shutdown()}}class e0{handlers={};eventListenerInited=!1;eventListeners=[];async requestPostNotificationPermission(){(await (0,ah.invoke)("plugin:native-tts|checkPermissions")).postNotification.startsWith("prompt")&&await (0,ah.invoke)("plugin:native-tts|requestPermissions",{permissions:["postNotification"]})}async initializeListeners(){if(this.eventListenerInited)return;this.eventListenerInited=!0;let a=await (0,ah.addPluginListener)("native-tts","media-session-play",()=>{this.handlers.play&&this.handlers.play()});this.eventListeners.push(a);let b=await (0,ah.addPluginListener)("native-tts","media-session-pause",()=>{this.handlers.pause&&this.handlers.pause()});this.eventListeners.push(b);let c=await (0,ah.addPluginListener)("native-tts","media-session-next",()=>{this.handlers.nexttrack&&this.handlers.nexttrack()});this.eventListeners.push(c);let d=await (0,ah.addPluginListener)("native-tts","media-session-previous",()=>{this.handlers.previoustrack&&this.handlers.previoustrack()});this.eventListeners.push(d);let e=await (0,ah.addPluginListener)("native-tts","media-session-seek",a=>{let b=a.payload.position;this.handlers.seekto&&this.handlers.seekto(b)});this.eventListeners.push(e)}async cleanupListeners(){for(let a of this.eventListeners)await a.unregister();this.eventListeners=[],this.eventListenerInited=!1}async updateMetadata(a){try{await (0,ah.invoke)("plugin:native-tts|update_media_session_metadata",{payload:a})}catch(a){console.error("Failed to update media metadata:",a)}}async updatePlaybackState(a){try{await (0,ah.invoke)("plugin:native-tts|update_media_session_state",{payload:a})}catch(a){console.error("Failed to update playback state:",a)}}async setActive(a){try{a.active?(a.keepAppInForeground&&await this.requestPostNotificationPermission(),await this.initializeListeners()):await this.cleanupListeners(),await (0,ah.invoke)("plugin:native-tts|set_media_session_active",{payload:a})}catch(a){console.error("Failed to set media session active state:",a)}}setActionHandler(a,b){b?this.handlers[a]=b:delete this.handlers[a]}}let e1=(a,b,c=1,d=1)=>{if(!b)return{left:0,right:0,top:0,bottom:0};let e=c*b.left+a.left,f=c*b.right+a.left;return{left:e,right:f,top:d*b.top+a.top,bottom:d*b.bottom+a.top}},e2=({x:a,y:b})=>a>0&&b>0&&a<window.innerWidth&&b<window.innerHeight,e3=(a,b,c)=>({x:Math.max(c,Math.min(a.x,b.right-b.left-c)),y:Math.max(c,Math.min(a.y,b.bottom-b.top-c))}),e4=(a,b,c,d=!1)=>{let{range:e,rect:f}=a&&"range"in a?a:{range:a,rect:void 0},g=(a=>{let b;for(b=a&&"object"==typeof a&&("tagName"in a)?a:a&&"object"==typeof a&&("collapse"in a)?a.commonAncestorContainer:a;b;){if(b.nodeType===Node.DOCUMENT_NODE){let a=b;if(a.defaultView&&a.defaultView.frameElement)return a.defaultView.frameElement}b=b.parentNode}return null})(e),h=(g?getComputedStyle(g).transform:"").match(/matrix\((.+)\)/),[i,,,j]=h?.[1]?.split(/\s*,\s*/)?.map(a=>parseFloat(a))??[],k=g?.getBoundingClientRect()??{top:0,left:0},l={top:0,right:0,bottom:0,left:0};if("nodeType"in e&&1===e.nodeType){let a=window.getComputedStyle(e);l={top:parseInt(a.paddingTop,10)||0,right:parseInt(a.paddingRight,10)||0,bottom:parseInt(a.paddingBottom,10)||0,left:parseInt(a.paddingLeft,10)||0}}let m=Array.from(e.getClientRects()).map(a=>({top:a.top+l.top,right:a.right-l.right,bottom:a.bottom-l.bottom,left:a.left+l.left})),n=f?e1(k,f,i,j):e1(k,m[0],i,j),o=f?e1(k,f,i,j):e1(k,m.at(-1),i,j);if(d){let a=n.left-b.left>b.right-n.right?"left":"right",d={point:e3({x:"left"===a?n.left-b.left-6:n.right-b.left+6,y:(n.top+n.bottom)/2-b.top},b,c),dir:a};return e2(d.point)?d:{point:{x:0,y:0},dir:a}}let p={point:e3({x:(n.left+n.right)/2-b.left,y:n.top-b.top-12},b,c),dir:"up"},q={point:e3({x:(o.left+o.right)/2-b.left,y:o.bottom-b.top+6},b,c),dir:"down"},r=e2(p.point),s=e2(q.point);return r||s?r?s?p.point.y>window.innerHeight-q.point.y?p:q:p:q:{point:{x:0,y:0}}},e5=(a,b,c,d,e)=>{let f={x:0,y:0};return"up"===a.dir?(f.x=a.point.x-c/2,f.y=a.point.y-d):"down"===a.dir?(f.x=a.point.x-c/2,f.y=a.point.y+6):"left"===a.dir?(f.x=a.point.x-c,f.y=a.point.y-d/2):"right"===a.dir&&(f.x=a.point.x+6,f.y=a.point.y-d/2),f.x<e&&(f.x=e),f.y<e&&(f.y=e),f.x+c>b.right-b.left-e&&(f.x=b.right-b.left-e-c),f.y+d>b.bottom-b.top-e&&(f.y=b.bottom-b.top-e-d),{point:f,dir:a.dir}};var e6=a.i(900616);let e7=(a,b,c)=>{if(!a)return{left:"-999px",top:"-999px"};let{dir:d,point:e}=a,f=0,g=0;switch(d){case"up":f=c;break;case"down":f=-c;break;case"left":g=c;break;case"right":g=-c}return{left:`${e.x+g}px`,top:`${e.y+f}px`,borderLeft:"right"===d?"none":"left"===d?`${b}px solid`:`${b}px solid transparent`,borderRight:"left"===d?"none":"right"===d?`${b}px solid`:`${b}px solid transparent`,borderTop:"down"===d?"none":"up"===d?`${b}px solid`:`${b}px solid transparent`,borderBottom:"up"===d?"none":"down"===d?`${b}px solid`:`${b}px solid transparent`,transform:"left"===d||"right"===d?"translateY(-50%)":"translateX(-50%)"}},e8=({width:a,height:b,minHeight:e,maxHeight:f,position:g,trianglePosition:h,children:i,className:k="",triangleClassName:l="",additionalStyle:m={},isOpen:n=!0,onDismiss:o})=>{let p=(0,d.useRef)(null),[q,r]=(0,d.useState)(g),[s,t]=(0,d.useState)(b||e||0);(0,e6.useKeyDownActions)({onCancel:o,elementRef:p,enabled:n});let u=(0,aH.useResponsiveSize)(10),v=window.innerHeight-2*u;h?.dir==="up"?v=h.point.y-u:h?.dir==="down"&&(v=window.innerHeight-h.point.y-u),f=Math.min(f||v,v),(0,d.useEffect)(()=>{if(!p.current)return;let a=new ResizeObserver(a=>{for(let b of a){let a=b.contentRect.height;if(a!==s)return void t(a)}});return a.observe(p.current),()=>{a.disconnect()}},[]),(0,d.useEffect)(()=>{if(!p.current)return;if(!g||!h||"up"!==g.dir)return void r(g);let a=s||p.current.offsetHeight;r({...g,point:{...g.point,y:Math.max(u,h.point.y-a)}})},[g,h,u,s]);let w=e7(h,7,0),x=e7(h,7,-1);return(0,c.jsxs)("div",{children:[(0,c.jsx)("div",{className:(0,j.default)("popup-triangle-outer text-base-300 absolute z-50",l),style:w}),(0,c.jsx)("div",{id:"popup-container",ref:p,className:(0,j.default)("popup-container bg-base-300 absolute z-50 rounded-lg font-sans","eink:border eink:border-base-content",h?.dir!=="up"&&"not-eink:shadow-xl",k),style:{width:`${a}px`,height:b?`${b}px`:"auto",minHeight:e?`${e}px`:"none",maxHeight:f?`${f}px`:"none",left:`${q?q.point.x:-999}px`,top:`${q?q.point.y:-999}px`,...m},children:i}),(0,c.jsx)("div",{className:(0,j.default)("popup-triangle-inner text-base-300 absolute z-50",l),style:x})]})},e9=a=>{let b=Date.now();if(a>b){let c=Math.floor((a-b)/1e3),d=60*Math.floor(c/3600)+Math.floor(c%3600/60),e=c%60;return`${d}:${e<10?"0":""}${e}`}return""},fa=({bookKey:a,ttsLang:b,isPlaying:g,timeoutOption:i,timeoutTimestamp:k,onTogglePlay:l,onBackward:m,onForward:n,onSetRate:p,onGetVoices:q,onSetVoice:r,onGetVoiceId:s,onSelectTimeout:t,onToogleTTSBar:u})=>{let v=(0,f.useTranslation)(),{envConfig:w}=(0,e.useEnv)(),{getViewSettings:x,setViewSettings:y}=(0,o.useReaderStore)(),{settings:z,setSettings:A,saveSettings:B}=(0,h.useSettingsStore)(),C=x(a),[D,E]=(0,d.useState)([]),[F,G]=(0,d.useState)(C?.ttsRate??1),[H,I]=(0,d.useState)(C?.ttsVoice??""),[J,K]=(0,d.useState)(()=>e9(k)),L=(0,aH.useDefaultIconSize)(),M=(0,aH.useResponsiveSize)(32),N=(0,aH.useResponsiveSize)(48);(0,d.useEffect)(()=>{setTimeout(()=>{let b;b=Date.now(),k>0&&k<b?(t(a,0),K("")):k>0&&K(e9(k))},1e3)},[k,J]),(0,d.useEffect)(()=>{I(s())},[]),(0,d.useEffect)(()=>{(async()=>{let a=await q(b),c=a.reduce((a,b)=>a+b.voices.length,0);a&&0!==c?E(a):(console.warn("No voices found for TTSPanel"),E([{id:"no-voices",name:v("Voices for {{lang}}",{lang:(0,ch.getLanguageName)(b)}),voices:[]}]))})()},[b]);let P=[{label:v("No Timeout"),value:0},{label:v("{{value}} minute",{value:1}),value:60},{label:v("{{value}} minutes",{value:3}),value:180},{label:v("{{value}} minutes",{value:5}),value:300},{label:v("{{value}} minutes",{value:10}),value:600},{label:v("{{value}} minutes",{value:20}),value:1200},{label:v("{{value}} minutes",{value:30}),value:1800},{label:v("{{value}} minutes",{value:45}),value:2700},{label:v("{{value}} hour",{value:1}),value:3600},{label:v("{{value}} hours",{value:2}),value:7200},{label:v("{{value}} hours",{value:3}),value:10800},{label:v("{{value}} hours",{value:4}),value:14400},{label:v("{{value}} hours",{value:6}),value:21600},{label:v("{{value}} hours",{value:8}),value:28800}];return(0,c.jsxs)("div",{className:"flex w-full flex-col items-center justify-center gap-2 rounded-2xl px-4 pt-4 sm:gap-1",children:[(0,c.jsxs)("div",{className:"flex w-full flex-col items-center gap-0.5",children:[(0,c.jsx)("input",{className:"range",type:"range",min:0,max:3,step:"0.1",value:F,onChange:b=>{let c=parseFloat(b.target.value);G(c=Math.max(.2,Math.min(3,c))),p(c);let d=x(a);d.ttsRate=c,z.globalViewSettings.ttsRate=c,y(a,d),A(z),B(w,z)}}),(0,c.jsxs)("div",{className:"grid w-full grid-cols-7 text-xs",children:[(0,c.jsx)("span",{className:"text-center",children:"|"}),(0,c.jsx)("span",{className:"text-center",children:"|"}),(0,c.jsx)("span",{className:"text-center",children:"|"}),(0,c.jsx)("span",{className:"text-center",children:"|"}),(0,c.jsx)("span",{className:"text-center",children:"|"}),(0,c.jsx)("span",{className:"text-center",children:"|"}),(0,c.jsx)("span",{className:"text-center",children:"|"})]}),(0,c.jsxs)("div",{className:"grid w-full grid-cols-7 text-xs",children:[(0,c.jsx)("span",{className:"text-center",children:v("Slow")}),(0,c.jsx)("span",{className:"text-center"}),(0,c.jsx)("span",{className:"text-center",children:"1.0"}),(0,c.jsx)("span",{className:"text-center",children:"1.5"}),(0,c.jsx)("span",{className:"text-center",children:"2.0"}),(0,c.jsx)("span",{className:"text-center"}),(0,c.jsx)("span",{className:"text-center",children:v("Fast")})]})]}),(0,c.jsxs)("div",{className:"flex items-center justify-between space-x-2",children:[(0,c.jsx)("button",{onClick:()=>m(),className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:v("Previous Paragraph"),"aria-label":v("Previous Paragraph"),children:(0,c.jsx)(aF.MdFastRewind,{size:M})}),(0,c.jsx)("button",{onClick:l,className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:g?v("Pause"):v("Play"),"aria-label":g?v("Pause"):v("Play"),children:g?(0,c.jsx)(aF.MdPauseCircle,{size:N,className:"fill-primary"}):(0,c.jsx)(aF.MdPlayCircle,{size:N,className:"fill-primary"})}),(0,c.jsx)("button",{onClick:()=>n(),className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:v("Next Paragraph"),"aria-label":v("Next Paragraph"),children:(0,c.jsx)(aF.MdFastForward,{size:M})}),(0,c.jsxs)("div",{className:"dropdown dropdown-top",children:[(0,c.jsxs)("button",{tabIndex:0,className:"flex flex-col items-center justify-center rounded-full p-1 transition-transform duration-200 hover:scale-105",onClick:a=>a.currentTarget.focus(),title:v("Set Timeout"),"aria-label":v("Set Timeout"),children:[(0,c.jsx)(aF.MdAlarm,{size:M}),J&&(0,c.jsx)("span",{className:(0,j.default)("absolute bottom-0 left-1/2 w-12 translate-x-[-50%] translate-y-[80%] px-1","bg-primary/80 text-base-100 rounded-full text-center text-xs"),children:J})]}),(0,c.jsx)("ul",{tabIndex:0,className:(0,j.default)("dropdown-content bgcolor-base-200 no-triangle menu menu-vertical rounded-box absolute right-0 z-[1] shadow","mt-4 inline max-h-96 w-[200px] overflow-y-scroll"),children:P.map((b,d)=>(0,c.jsx)("li",{onClick:()=>t(a,b.value),children:(0,c.jsxs)("div",{className:"flex items-center px-2",children:[(0,c.jsx)("span",{style:{width:`${L}px`,height:`${L}px`},children:i===b.value&&(0,c.jsx)(aF.MdCheck,{className:"text-base-content"})}),(0,c.jsx)("span",{className:(0,j.default)("text-base sm:text-sm"),children:b.label})]})},`${d}-${b.value}`))})]}),(0,c.jsxs)("div",{className:"dropdown dropdown-top",children:[(0,c.jsx)("button",{tabIndex:0,className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",onClick:a=>a.currentTarget.focus(),children:(0,c.jsx)(O.RiVoiceAiFill,{size:M})}),(0,c.jsx)("ul",{tabIndex:0,className:(0,j.default)("dropdown-content bgcolor-base-200 no-triangle menu menu-vertical rounded-box absolute right-0 z-[1] shadow","mt-4 inline max-h-96 w-[250px] overflow-y-scroll"),title:v("Select Voice"),"aria-label":v("Select Voice"),children:D.map((b,d)=>(0,c.jsxs)("div",{className:"",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2 px-2 py-1",children:[(0,c.jsx)("span",{style:{width:`${L}px`,height:`${L}px`}}),(0,c.jsx)("span",{className:"text-sm text-gray-400 sm:text-xs",children:v("{{engine}}: {{count}} voices",{engine:v(b.name),count:b.voices.length})})]}),b.voices.map((e,f)=>(0,c.jsx)("li",{onClick:()=>{var b;let c;return!e.disabled&&(r(b=e.id,e.lang),I(b),void((c=x(a)).ttsVoice=b,y(a,c)))},children:(0,c.jsxs)("div",{className:"flex items-center px-2",children:[(0,c.jsx)("span",{style:{width:`${L}px`,height:`${L}px`},children:H===e.id&&(0,c.jsx)(aF.MdCheck,{className:"text-base-content"})}),(0,c.jsx)("span",{className:(0,j.default)("max-w-[180px] overflow-hidden text-ellipsis text-base sm:text-sm",e.disabled&&"text-gray-400"),children:v(e.name)})]})},`${d}-${b.id}-${f}`))]},b.id))})]})]}),(0,c.jsx)("div",{className:"flex h-4 items-center justify-center opacity-60 transition-transform duration-200 hover:scale-105 hover:opacity-100",children:(0,c.jsx)("button",{onClick:u,className:"p-0",title:v("Toggle Sticky Bottom TTS Bar"),"aria-label":v("Toggle Sticky Bottom TTS Bar"),children:C?.showTTSBar?(0,c.jsx)(ed.TbChevronCompactUp,{size:N,style:{transform:"scaleY(0.85)"}}):(0,c.jsx)(ed.TbChevronCompactDown,{size:N,style:{transform:"scaleY(0.85)"}})})})]})},fb=({isPlaying:a,ttsInited:b,onClick:d})=>(0,c.jsxs)("button",{className:(0,j.default)("relative h-full w-full rounded-full",b?"cursor-pointer":"cursor-not-allowed"),style:{maskImage:"radial-gradient(circle, white 100%, transparent 100%)",WebkitMaskImage:"radial-gradient(circle, white 100%, transparent 100%)"},onClick:d,children:[(0,c.jsx)("div",{className:"absolute inset-0 overflow-hidden rounded-full bg-gradient-to-r from-blue-500 via-emerald-500 to-violet-500",children:(0,c.jsx)("div",{className:"absolute -inset-full rounded-full bg-gradient-to-r from-blue-500 via-emerald-500 to-violet-500",style:{animation:a&&b?"moveGradient 2s alternate infinite":"none"}})}),(0,c.jsxs)("div",{className:"absolute inset-0 flex items-center justify-center",children:[(0,c.jsx)("style",{children:`
          @keyframes moveGradient {
            0% { transform: translate(0, 0); }
            100% { transform: translate(25%, 25%); }
          }
          @keyframes bounce {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.6); }
          }
        `}),(0,c.jsx)("div",{className:"flex items-end space-x-1",children:[1,2,3,4].map(b=>(0,c.jsx)("div",{className:"w-1 rounded-t bg-white",style:{height:"16px",animationName:a?"bounce":"none",animationDuration:a?`${1+.1*b}s`:"0s",animationTimingFunction:"ease-in-out",animationIterationCount:"infinite",animationDelay:`${.1*b}s`}},b))})]})]}),fc=({bookKey:a,isPlaying:b,onTogglePlay:d,onBackward:g,onForward:h,gridInsets:i})=>{let k=(0,f.useTranslation)(),{appService:l}=(0,e.useEnv)(),{hoveredBookKey:m,setHoveredBookKey:n}=(0,o.useReaderStore)(),p=(0,aH.useResponsiveSize)(30),q=(0,aH.useResponsiveSize)(36);return(0,c.jsx)("div",{className:(0,j.default)("bg-base-100 absolute bottom-0 z-40","inset-x-0 mx-auto flex w-full justify-center sm:w-fit","transition-opacity duration-300",m!==a?"pointer-events-auto opacity-100":"pointer-events-none opacity-0"),style:{paddingBottom:l?.hasSafeAreaInset?`${.33*i.bottom}px`:0},onMouseEnter:()=>!l?.isMobile&&n(""),onTouchStart:()=>!l?.isMobile&&n(""),children:(0,c.jsxs)("div",{className:"text-base-content flex h-[52px] items-center space-x-2 px-2",children:[(0,c.jsx)("button",{onClick:g.bind(null,!1),className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:k("Previous Paragraph"),"aria-label":k("Previous Paragraph"),children:(0,c.jsx)(aF.MdFastRewind,{size:p})}),(0,c.jsx)("button",{onClick:g.bind(null,!0),className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:k("Previous Sentence"),"aria-label":k("Previous Sentence"),children:(0,c.jsx)(aF.MdSkipPrevious,{size:p})}),(0,c.jsx)("button",{onClick:d,className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:k(b?"Pause":"Play"),"aria-label":k(b?"Pause":"Play"),children:b?(0,c.jsx)(aF.MdOutlinePause,{size:q}):(0,c.jsx)(aF.MdPlayArrow,{size:q})}),(0,c.jsx)("button",{onClick:h.bind(null,!0),className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:k("Next Sentence"),"aria-label":k("Next Sentence"),children:(0,c.jsx)(aF.MdSkipNext,{size:p})}),(0,c.jsx)("button",{onClick:h.bind(null,!1),className:"rounded-full p-1 transition-transform duration-200 hover:scale-105",title:k("Next Paragraph"),"aria-label":k("Next Paragraph"),children:(0,c.jsx)(aF.MdFastForward,{size:p})})]})})},fd=({bookKey:a,gridInsets:b})=>{let g=(0,f.useTranslation)(),{appService:i}=(0,e.useEnv)(),{user:k}=(0,aK.useAuth)(),{safeAreaInsets:l,isDarkMode:m}=(0,n.useThemeStore)(),{settings:p}=(0,h.useSettingsStore)(),{getBookData:q}=(0,P.useBookDataStore)(),{hoveredBookKey:r,getView:s,getProgress:t,getViewSettings:u}=(0,o.useReaderStore)(),{setViewSettings:v,setTTSEnabled:w}=(0,o.useReaderStore)(),{getMergedRules:y}=Q(),A=u(a),[C,D]=(0,d.useState)("en"),[E,F]=(0,d.useState)(!1),[G,H]=(0,d.useState)(!1),[I,J]=(0,d.useState)(!1),[L,M]=(0,d.useState)(!1),[N,O]=(0,d.useState)(()=>!!A?.showTTSBar),[R,S]=(0,d.useState)(),[T,U]=(0,d.useState)(),[V,W]=(0,d.useState)(0),[X,Y]=(0,d.useState)(0),[Z,$]=(0,d.useState)(null),_=(0,d.useRef)(null),[aa,ab]=(0,d.useState)(!0),ac=(0,aH.useResponsiveSize)(10),ad=Math.min(window.innerWidth-2*ac,(0,aH.useResponsiveSize)(282)),ae=(0,aH.useResponsiveSize)(160),ag=(0,d.useRef)(null),ah=(0,d.useRef)(null),ai=(0,d.useRef)(null),aj=(0,d.useRef)(null),[al,am]=(0,d.useState)(null),[an,ao]=(0,d.useState)(!1),ap=async()=>{let b="mediaSession"in navigator?navigator.mediaSession:"android"===(0,K.getOSPlatform)()&&(0,z.isTauriAppPlatform)()?new e0:null;if(b&&(aj.current=b,b instanceof e0)){let c=q(a),d=t(a);if(!c||!c.book)return;let{title:e,author:f,coverImageUrl:h}=c.book,{sectionLabel:i}=d||{},j="/icon.png";try{j=await ak(h||"/icon.png")}catch{j=await ak("/icon.png")}await b.setActive({active:!0,keepAppInForeground:p.alwaysInForeground,notificationTitle:g("Read Aloud"),notificationText:g("Ready to read aloud"),foregroundServiceTitle:g("Read Aloud"),foregroundServiceText:g("Ready to read aloud")}),b.updateMetadata({title:e,artist:i||e,album:f,artwork:j})}},aq=async()=>{aj.current&&aj.current instanceof e0&&await aj.current.setActive({active:!1,keepAppInForeground:p.alwaysInForeground}),aj.current=null};(0,d.useEffect)(()=>()=>{ai.current&&(ai.current.shutdown(),ai.current=null)},[]),(0,d.useEffect)(()=>(x.eventDispatcher.on("tts-speak",av),x.eventDispatcher.on("tts-stop",aw),()=>{x.eventDispatcher.off("tts-speak",av),x.eventDispatcher.off("tts-stop",aw)}),[]),(0,d.useEffect)(()=>{if(!al||!a)return;let b=q(a);if(!b||!b.book)return;let{title:c,author:d,coverImageUrl:e}=b.book,f=()=>{x.eventDispatcher.dispatch("toast",{message:g("Please log in to use advanced TTS features"),type:"error",timeout:5e3})},h=b=>{let{sectionLabel:f}=t(a)||{},g=b.detail;if(aj.current){let a=aj.current;a instanceof e0?a.updateMetadata({title:g?.text||"",artist:f||c,album:d,artwork:""}):a.metadata=new MediaMetadata({title:g?.text||"",artist:f||c,album:d,artwork:[{src:e||"/icon.png",sizes:"512x512",type:"image/png"}]})}},i=b=>{let c=b.detail,d=s(a),e=t(a),f=u(a);if(!c||!d||!e||!f)return;let{location:g}=e,{index:h}=d.resolveCFI(g),i=d?.getCFI(h,c);if(i&&(f.ttsLocation=i||"",v(a,f)),!d.renderer.getContents().some(({doc:a})=>(a.getSelection()?.toString().length??0)>0))if(d.renderer.scrolled){let a=c.getBoundingClientRect(),{start:b,size:e,viewSize:g,sideProp:h}=d.renderer,i=a["height"===h?"y":"x"]+f.marginTopPx,j=a["height"===h?"height":"width"]+i,k="rtl"===d.book.dir?g-i:i,l="rtl"===d.book.dir?g-j:j,m=f.showHeader,n=f.showFooter,o=f.showBarsOnScroll,p=m&&o?44:0,q=f.scrollingOverlap;(l>b+e-(n&&o?44:0)-q||k<b+p+q)&&d.renderer.scrollToAnchor((k-p-q)/g)}else d.renderer.scrollToAnchor(c)};return al.addEventListener("tts-need-auth",f),al.addEventListener("tts-speak-mark",h),al.addEventListener("tts-highlight-mark",i),()=>{al.removeEventListener("tts-need-auth",f),al.removeEventListener("tts-speak-mark",h),al.removeEventListener("tts-highlight-mark",i)}},[al,a]);let ar=(0,d.useCallback)(()=>{let b=A?.ttsReadAloudText;if(A?.translationEnabled&&"translated"===b)return A?.translateTargetLang||(0,K.getLocale)();if(A?.translationEnabled&&"source"===b){let b=q(a);return b?.book?.primaryLanguage||""}return null},[a,q,A?.translationEnabled,A?.ttsReadAloudText,A?.translateTargetLang]);(0,d.useEffect)(()=>{ai.current?.setTargetLang(ar()||"")},[ar]);let as=(0,d.useMemo)(()=>({bookKey:a,viewSettings:u(a),userLocale:(0,K.getLocale)(),content:"",transformers:[],reversePunctuationTransform:!0}),[]),at=(0,d.useCallback)(async b=>{let c=y(a),d=u(a);return 0===c.filter(a=>a.enabled&&a.onlyForTTS&&("book"===a.scope||"library"===a.scope)).length?b:(as.content=b,as.viewSettings=d,b=await d0.transform(as,{docType:"text/xml",onlyForTTS:!0}))},[a,y,u,as]),au=(0,d.useCallback)((a,b)=>{let c=m?"#000000":"#ffffff",d=b?c:a.color;return{...a,color:d}},[m]);(0,d.useEffect)(()=>{let a=A?.ttsHighlightOptions;ai.current&&a&&ai.current.initViewTTS(au(a,A.isEink))},[A?.ttsHighlightOptions,A?.isEink,au]);let av=async b=>{let{bookKey:c,range:d,oneTime:e=!1}=b.detail;if(a!==c)return;let f=s(a),h=t(a),j=u(a),l=q(a);if(!f||!h||!j||!l||!l.book)return;if(l.book?.format==="PDF")return void x.eventDispatcher.dispatch("toast",{message:g("TTS not supported for PDF"),type:"warning"});let m=d;if(!m&&j.ttsLocation){let{location:a}=h,b=j.ttsLocation;if(b4(b,a)){let{index:a,anchor:c}=f.resolveCFI(b),{doc:d}=f.renderer.getContents().find(b=>b.index===a)||{};d&&(m=c(d))}}m||(m=h.range);let n=l.book.primaryLanguage;ai.current&&(ai.current.stop(),ai.current=null);try{i?.isIOSApp&&await (0,B.invokeUseBackgroundAudio)({enabled:!0}),i?.isMobile&&(ah.current||(ah.current=document.createElement("audio"),ah.current.setAttribute("x-webkit-airplay","deny"),ah.current.addEventListener("play",()=>{"mediaSession"in navigator&&(navigator.mediaSession.metadata=null)}),ah.current.preload="auto",ah.current.loop=!0,ah.current.src="data:audio/mp3;base64,//MkxAAHiAICWABElBeKPL/RANb2w+yiT1g/gTok//lP/W/l3h8QO/OCdCqCW2Cw//MkxAQHkAIWUAhEmAQXWUOFW2dxPu//9mr60ElY5sseQ+xxesmHKtZr7bsqqX2L//MkxAgFwAYiQAhEAC2hq22d3///9FTV6tA36JdgBJoOGgc+7qvqej5Zu7/7uI9l//MkxBQHAAYi8AhEAO193vt9KGOq+6qcT7hhfN5FTInmwk8RkqKImTM55pRQHQSq//MkxBsGkgoIAABHhTACIJLf99nVI///yuW1uBqWfEu7CgNPWGpUadBmZ////4sL//MkxCMHMAH9iABEmAsKioqKigsLCwtVTEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVV//MkxCkECAUYCAAAAFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV",ah.current.play())),await ap(),ao(!1),e||J(!0);let b=new e_(i,f,!!k?.id,at);ai.current=b,am(b),await b.init(),await b.initViewTTS(au(j.ttsHighlightOptions,j.isEink));let c=f.tts?.from(m);if(c){let a=eH(c,n)||"en";F(!0),D(a),b.setLang(a),b.setRate(j.ttsRate),b.speak(c,e),b.setTargetLang(ar()||"")}ao(!0),w(a,!0)}catch(a){x.eventDispatcher.dispatch("toast",{message:g("TTS not supported for this document"),type:"error"}),console.error(a)}},aw=async b=>{let{bookKey:c}=b.detail;ai.current&&a===c&&aC(a)},ax=(0,d.useCallback)(async()=>{let a=ai.current;if(a&&(E?(F(!1),H(!0),await a.pause()):G&&(F(!0),H(!1),"paused"===a.state?await a.resume():await a.start()),aj.current)){let a=aj.current;a instanceof e0?await a.updatePlaybackState({playing:!E}):a.playbackState=E?"paused":"playing"}},[E,G]),ay=(0,d.useCallback)(async(a=!1)=>{let b=ai.current;b&&await b.backward(a)},[]),az=(0,d.useCallback)(async(a=!1)=>{let b=ai.current;b&&await b.forward(a)},[]),aA=(0,d.useCallback)(async()=>{let a=ai.current;a&&(F(!1),H(!0),await a.pause())},[]),aC=(0,d.useCallback)(async a=>{let b=ai.current;b&&(await b.shutdown(),ai.current=null,am(null),s(a)?.deselect(),F(!1),M(!1),J(!1)),i?.isIOSApp&&await (0,B.invokeUseBackgroundAudio)({enabled:!1}),i?.isMobile&&(()=>{if(ah.current)try{ah.current.pause(),ah.current.currentTime=0,ah.current.removeAttribute("src"),ah.current.src="",ah.current.load(),ah.current=null,console.log("Unblock audio released")}catch(a){console.warn("Error releasing unblock audio:",a)}})(),await aq(),w(a,!1)},[i]),aD=(0,d.useCallback)((0,af.throttle)(async a=>{let b=ai.current;b&&("playing"===b.state?(await b.stop(),await b.setRate(a),await b.start()):await b.setRate(a))},3e3),[]),aE=(0,d.useCallback)((0,af.throttle)(async(a,b)=>{let c=ai.current;c&&("playing"===c.state?(await c.stop(),await c.setVoice(a,b),await c.start()):await c.setVoice(a,b))},3e3),[]),aF=async a=>{let b=ai.current;return b?b.getVoices(a):[]},aG=()=>{if(ag.current){let a=ag.current.getBoundingClientRect(),b=ag.current.parentElement?.getBoundingClientRect()||document.documentElement.getBoundingClientRect(),c={dir:"up",point:{x:a.left+a.width/2-b.left,y:a.top-12}};S(e5(c,b,ad,ae,ac)),U(c)}},aI=()=>{M(!1)};return(0,d.useEffect)(()=>{let{current:a}=aj;a&&(a.setActionHandler("play",()=>{ax()}),a.setActionHandler("pause",()=>{ax()}),a.setActionHandler("stop",()=>{aA()}),a.setActionHandler("seekforward",()=>{az(!0)}),a.setActionHandler("seekbackward",()=>{ay(!0)}),a.setActionHandler("nexttrack",()=>{az()}),a.setActionHandler("previoustrack",()=>{ay()}))},[ax,aA,az,ay]),(0,d.useEffect)(()=>{if(!ag.current||!L)return;let a=ag.current.parentElement;if(!a)return;let b=new ResizeObserver(()=>{aG()});return b.observe(a),()=>{b.disconnect()}},[L]),(0,d.useEffect)(()=>(r?(_.current&&(clearTimeout(_.current),_.current=null),_.current=setTimeout(()=>{ab(!0)},100)):(_.current&&(clearTimeout(_.current),_.current=null),_.current=setTimeout(()=>{ab(!1)},5e3)),()=>{_.current&&clearTimeout(_.current)}),[r]),(0,c.jsxs)(c.Fragment,{children:[L&&(0,c.jsx)(aB.Overlay,{onDismiss:aI}),(L||I&&aa)&&(0,c.jsx)("div",{ref:ag,className:(0,j.default)("absolute h-12 w-12","transition-transform duration-300",A?.rtl?"left-8":"right-6",!i?.hasSafeAreaInset&&"bottom-[70px] sm:bottom-14"),style:{bottom:i?.hasSafeAreaInset?`${.33*(l?.bottom||0)+(r?70:52)}px`:void 0},children:(0,c.jsx)(fb,{isPlaying:E,ttsInited:an,onClick:()=>{aG(),!L&&ai.current&&D(ai.current.getSpeakingLang()||C),M(a=>!a)}})}),L&&R&&T&&an&&(0,c.jsx)(e8,{width:ad,height:ae,position:R,trianglePosition:T,className:"bg-base-200 flex shadow-lg",onDismiss:aI,children:(0,c.jsx)(fa,{bookKey:a,ttsLang:C,isPlaying:E,timeoutOption:V,timeoutTimestamp:X,onTogglePlay:ax,onBackward:ay,onForward:az,onSetRate:aD,onGetVoices:aF,onSetVoice:aE,onGetVoiceId:()=>{let a=ai.current;return a?a.getVoiceId():""},onSelectTimeout:(a,b)=>{W(b),Z&&clearTimeout(Z),b>0?($(setTimeout(()=>{aC(a)},1e3*b)),Y(Date.now()+1e3*b)):Y(0)},onToogleTTSBar:()=>{let b=u(a);b.showTTSBar=!b.showTTSBar,O(b.showTTSBar),b.showTTSBar&&M(!1),v(a,b)}})}),I&&N&&an&&(0,c.jsx)(fc,{bookKey:a,isPlaying:E,onBackward:ay,onTogglePlay:ax,onForward:az,gridInsets:b})]})},fe=({bookKey:a,bookFormat:b,section:g,pageinfo:h,isHoveredAnim:i,gridInsets:k})=>{let l=(0,f.useTranslation)(),{appService:m}=(0,e.useEnv)(),{getConfig:n,setConfig:p,getBookData:q}=(0,P.useBookDataStore)(),{hoveredBookKey:r,setHoveredBookKey:t}=(0,o.useReaderStore)(),{getView:v,getViewState:w,getProgress:y,getViewSettings:z}=(0,o.useReaderStore)(),{isSideBarVisible:A,setSideBarVisible:B}=s(),{acquireBackKeyInterception:C,releaseBackKeyInterception:D}=(0,u.useDeviceControlStore)(),E=v(a),F=n(a),G=q(a),H=w(a),I=y(a),K=z(a),[L,M]=(0,d.useState)(""),N=r===a?L:"",O=r===a,Q=(E?.renderer.getContents()??[]).some(({doc:a})=>a?.body?.style.cursor==="pointer"),R=(0,d.useMemo)(()=>"PDF"===b?g:h,[b,g,h]),S=!!R&&R.total>0&&R.current>=0,T=(0,d.useMemo)(()=>S&&R.total>0&&R.current>=0?(R.current+1)/R.total:0,[S,R]),U=(0,d.useMemo)(()=>(0,J.debounce)(a=>{E?.goToFraction(a/100)},100),[E]),V=(0,d.useCallback)(()=>{av(E,K,"left","page")},[E,K]),W=(0,d.useCallback)(()=>{av(E,K,"right","page")},[E,K]),X=(0,d.useCallback)(()=>{E?.renderer.prevSection?.()},[E]),Y=(0,d.useCallback)(()=>{E?.renderer.nextSection?.()},[E]),Z=(0,d.useCallback)(()=>{E?.history.back()},[E]),$=(0,d.useCallback)(()=>{E?.history.forward()},[E]),_=(0,d.useCallback)(async()=>{if(!E||!I||!H)return;let b=H.ttsEnabled?"tts-stop":"tts-speak";x.eventDispatcher.dispatch(b,{bookKey:a})},[E,I,H,a]),aa=(0,d.useCallback)(b=>{M(a=>a===b?"":b),"tts"===b?(H?.ttsEnabled&&t(""),_()):"toc"===b?(t(""),F?.viewSettings&&p(a,{viewSettings:{...F.viewSettings,sideBarTab:"toc"}}),B(!0)):"note"===b&&(t(""),B(!0),F?.viewSettings&&p(a,{viewSettings:{...F.viewSettings,sideBarTab:"annotations"}}))},[F,a,H?.ttsEnabled,p,B,t,_]),ab=(0,d.useMemo)(()=>({onPrevPage:V,onNextPage:W,onPrevSection:X,onNextSection:Y,onGoBack:Z,onGoForward:$,onProgressChange:U}),[V,W,X,Y,Z,$,U]),ac=(0,d.useCallback)(a=>{if(a instanceof CustomEvent){if("Back"===a.detail.keyName)return t(""),!0}else"Escape"===a.key&&t(""),a.stopPropagation();return!1},[t]);(0,d.useEffect)(()=>{if(m?.isAndroidApp)return r&&(C(),x.eventDispatcher.onSync("native-key-down",ac)),()=>{r&&(D(),x.eventDispatcher.offSync("native-key-down",ac))}},[r]);let ad={bookKey:a,gridInsets:k,actionTab:N,progressValid:S,progressFraction:T,navigationHandlers:ab,onSetActionTab:aa,onSpeakText:_},ae=K?.vertical&&K?.scrolled||G?.isFixedLayout&&K?.zoomLevel&&K.zoomLevel>100,af=(0,j.default)("footer-bar shadow-xs bottom-0 z-10 flex w-full flex-col","sm:h-[52px] sm:justify-center","sm:bg-base-100 border-base-300/50 border-t sm:border-none","transition-[opacity,transform] duration-300",window.innerWidth<640?"fixed":"absolute",m?.hasRoundedWindow&&"rounded-window-bottom-right",!A&&m?.hasRoundedWindow&&"rounded-window-bottom-left",i&&"hover-bar-anim",ae&&"sm:!bottom-3 sm:!h-10 sm:justify-end",O?"pointer-events-auto translate-y-0 opacity-100":"pointer-events-none translate-y-full opacity-0 sm:translate-y-0"),ag=m?.isMobile||window.innerWidth<640;return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{role:"none",className:(0,j.default)("absolute bottom-0 left-0 z-10 flex h-[52px] w-full",ae&&"sm:!bottom-3 sm:!h-7",ag||Q?"pointer-events-none":""),onMouseEnter:()=>!ag&&t(a),onTouchStart:()=>!ag&&t(a)}),(0,c.jsxs)("div",{role:"group","aria-label":l("Footer Bar"),className:af,dir:K?.rtl?"rtl":"ltr",onFocus:()=>!m?.isMobile&&t(a),onMouseLeave:()=>window.innerWidth>=640&&t(""),children:[(0,c.jsx)(eA,{...ad}),(0,c.jsx)(eF,{...ad})]}),O&&ae&&(0,c.jsx)("div",{className:"bg-base-100 pointer-events-none absolute bottom-0 left-0 hidden h-3 w-full sm:block"}),(0,c.jsx)(fd,{bookKey:a,gridInsets:k})]})},ff=({bookKey:a,section:b,pageinfo:g,timeinfo:h,horizontalGap:i,contentInsets:k,gridInsets:l})=>{let m=(0,f.useTranslation)(),{envConfig:n,appService:p}=(0,e.useEnv)(),{getBookData:q}=(0,P.useBookDataStore)(),{getView:r,getViewSettings:s}=(0,o.useReaderStore)(),t=r(a),u=q(a),v=s(a),w=v.vertical&&v.doubleBorder,x=v.scrolled,y=v.vertical,z=v.isEink,{progressStyle:A}=v,B=localStorage?.getItem("i18nextLng")||"",C=y&&B.toLowerCase().startsWith("zh"),D=u?.isFixedLayout?b:g,E=eD(D?.current,D?.total,"fraction"===A?y?"{current}  {total}":"{current} / {total}":"{percent}%",C,B),F=h?m("{{time}} min left in chapter",{time:eE(Math.round(h.section),C,B)}):"",{page:G=0,pages:H=0}=t?.renderer||{},I=H-1>G?C?m("{{number}} pages left in chapter",{number:eE(H-G-1,C,B)}):m("{{count}} pages left in chapter",{count:H-G-1}):"",[J,K]=(0,d.useState)(v.progressInfoMode);(0,d.useEffect)(()=>{(0,aN.saveViewSettings)(n,a,"progressInfoMode",J)},[J]);let L=p?.isMobile||window.innerWidth<640;return(0,c.jsx)("div",{role:"presentation",className:(0,j.default)("progressinfo absolute bottom-0 flex items-center justify-between font-sans",z?"text-sm font-normal":"text-neutral-content text-xs font-extralight",y?"writing-vertical-rl":"w-full",x&&!y&&"bg-base-100",L?"pointer-events-auto":"pointer-events-none"),onClick:()=>(()=>{if(!v.tapToToggleFooter)return;let a=v.showRemainingTime||v.showRemainingPages,b=v.showProgressInfo,c=["all","remaining","progress","none"],d=c.indexOf(J);for(let e=1;e<=c.length;e++){let f=(d+e)%c.length,g=c[f],h={remaining:("all"===J||"remaining"===J)&&a,progress:("all"===J||"progress"===J)&&b},i={remaining:("all"===g||"remaining"===g)&&a,progress:("all"===g||"progress"===g)&&b};if(h.remaining!==i.remaining||h.progress!==i.progress)return void K(g)}let e=(d+1)%c.length;K(c[e])})(),"aria-label":[D?m("On {{current}} of {{total}} page",{current:D.current+1,total:D.total}):"",F,I].filter(Boolean).join(", "),style:y?{bottom:`${(k.bottom-l.bottom)*1.5}px`,left:w?`calc(${k.left}px)`:`calc(${Math.max(0,k.left-32)}px)`,width:w?"32px":`${k.left}px`,height:`calc(100% - ${(k.top+k.bottom)/2*3}px)`}:{paddingInlineStart:`calc(${i/2}% + ${k.left/2}px)`,paddingInlineEnd:`calc(${i/2}% + ${k.right/2}px)`,paddingBottom:p?.hasSafeAreaInset?`${.33*l.bottom}px`:0},children:(0,c.jsxs)("div",{"aria-hidden":"true",className:(0,j.default)("flex items-center justify-between",y?"h-full":"h-[52px] w-full"),children:[("all"===J||"remaining"===J)&&(0,c.jsx)(c.Fragment,{children:v.showRemainingTime?(0,c.jsx)("span",{className:"text-start",children:F}):v.showRemainingPages?(0,c.jsx)("span",{className:"text-start",children:I}):null}),("all"===J||"progress"===J)&&(0,c.jsx)(c.Fragment,{children:v.showProgressInfo&&(0,c.jsx)("span",{className:(0,j.default)("text-end",y?"mt-auto":"ms-auto"),children:E})})]})})},fg=({})=>{let{safeAreaInsets:a}=(0,n.useThemeStore)();return(0,c.jsx)("div",{className:(0,j.default)("ribbon absolute inset-0 z-10 flex w-8 justify-center sm:w-6"),style:{height:`${(a?.top||0)+44}px`},children:(0,c.jsx)("svg",{width:"100%",height:"100%",preserveAspectRatio:"none",viewBox:"0 0 100 100",xmlns:"http://www.w3.org/2000/svg",shapeRendering:"geometricPrecision",imageRendering:"optimizeQuality",children:(0,c.jsx)("polygon",{fill:"#F44336",points:"100 100, 50 78, 0 100, 0 0, 100 0"})})})},fh=({position:a,isVertical:b,type:e,color:f,onDragStart:g,onDrag:h,onDragEnd:i})=>{let k=(0,d.useRef)(!1),l=(0,aH.useResponsiveSize)(24),m=(0,aH.useResponsiveSize)(8),n=(0,aH.useResponsiveSize)(12),o=(0,d.useCallback)(a=>{a.preventDefault(),a.stopPropagation(),k.current=!0,g(),a.target.setPointerCapture(a.pointerId)},[g]),p=(0,d.useCallback)(a=>{k.current&&(a.preventDefault(),a.stopPropagation(),h({x:a.clientX,y:a.clientY}))},[h]),q=(0,d.useCallback)(a=>{k.current&&(a.preventDefault(),a.stopPropagation(),k.current=!1,a.target.releasePointerCapture(a.pointerId),i())},[i]);return(0,c.jsx)("div",{className:"pointer-events-auto absolute z-50 cursor-grab touch-none active:cursor-grabbing",style:{left:b&&"start"===e?a.x-l/2+n/4:a.x-l/2,top:b?"start"===e?a.y-l+n/2:a.y-l/2-n/2:"start"===e?a.y-l:a.y-l/2-n/8,width:l,height:l+n},onPointerDown:o,onPointerMove:p,onPointerUp:q,onPointerCancel:q,children:(0,c.jsxs)("svg",{width:l,height:l+n,viewBox:`0 0 ${l} ${l+n}`,className:(0,j.default)("start"===e&&"rotate-180"),style:{transform:b?"start"===e?"rotate(270deg)":"rotate(90deg)":"start"===e?"rotate(180deg)":void 0},children:[(0,c.jsx)("line",{x1:l/2,y1:0,x2:l/2,y2:n,stroke:f,strokeWidth:2,strokeLinecap:"round"}),(0,c.jsx)("circle",{cx:l/2,cy:n+m,r:m,fill:f})]})})},fi=({bookKey:a,isVertical:b,annotation:f,selection:g,handleColor:i,getAnnotationText:j,setSelection:k,onStartEdit:l})=>{let{settings:m}=(0,h.useSettingsStore)(),{isDarkMode:p}=(0,n.useThemeStore)(),q=m.globalViewSettings.isEink,r=p?"#ffffff":"#000000",{handlePositions:s,getHandlePositionsFromRange:t,handleAnnotationRangeChange:u}=(({bookKey:a,annotation:b,getAnnotationText:c,setSelection:f})=>{let{envConfig:g}=(0,e.useEnv)(),{settings:i}=(0,h.useSettingsStore)(),{getConfig:j,saveConfig:k,updateBooknotes:l}=(0,P.useBookDataStore)(),{getView:m,getViewsById:n}=(0,o.useReaderStore)(),p=m(a),q=(0,d.useRef)(b),[r,s]=(0,d.useState)(null),t=(0,d.useCallback)((b,c)=>{if(!document.querySelector(`#gridcell-${a}`))return null;let d=Array.from(b.getClientRects());if(0===d.length)return null;let e=d[0],f=d[d.length-1],g=b.commonAncestorContainer.ownerDocument?.defaultView?.frameElement,h=g?.getBoundingClientRect()??{top:0,left:0};return{start:{x:h.left+(c?e.right:e.left),y:h.top+e.top},end:{x:h.left+(c?f.left:f.right),y:h.top+f.bottom}}},[a]),u=(0,d.useCallback)(async(b,d,e,h)=>{if(!q.current||!p)return;let m=p.renderer.getContents();if(!m||0===m.length)return;let o=(a,b,c)=>{let d=a.defaultView?.frameElement,e=d?.getBoundingClientRect()??{top:0,left:0},f=b-e.left,g=c-e.top;if(a.caretPositionFromPoint){let b=a.caretPositionFromPoint(f,g);if(b)return{node:b.offsetNode,offset:b.offset}}if(a.caretRangeFromPoint){let b=a.caretRangeFromPoint(f,g);if(b)return{node:b.startContainer,offset:b.startOffset}}return null},r=null,u=null,v=null,w=0;for(let a of m){let{doc:c,index:e}=a;if(!c)continue;let f=o(c,b.x,b.y),g=o(c,d.x,d.y);if(f&&g){r=f,u=g,v=c,w=e??0;break}}if(!r||!u||!v)return;let x=v.createRange();try{if(r.node.compareDocumentPosition(u.node)&Node.DOCUMENT_POSITION_PRECEDING||r.node===u.node&&r.offset>u.offset?(x.setStart(u.node,u.offset),x.setEnd(r.node,r.offset)):(x.setStart(r.node,r.offset),x.setEnd(u.node,u.offset)),x.collapsed)return void console.warn("Range is collapsed")}catch(a){console.warn("Failed to create range:",a);return}let y=t(x,e);y&&s(y);let z=p.getCFI(w,x),A=await c(x);if(z&&A){let{booknotes:b=[]}=j(a),c=b.findIndex(a=>a.id===q.current.id&&!a.deletedAt);if(-1!==c){let d={...b[c],cfi:z,text:A,updatedAt:Date.now()},e=n(a.split("-")[0]);if(e.forEach(a=>a?.addAnnotation(q.current,!0)),e.forEach(a=>a?.addAnnotation(d)),q.current=d,!h){b[c]=d;let e=l(a,b);e&&k(g,a,e,i),f({key:a,annotated:!0,text:A,cfi:z,range:x,index:w})}}}},[a,t,c,f]);return{handlePositions:r,setHandlePositions:s,getHandlePositionsFromRange:t,handleAnnotationRangeChange:u}})({bookKey:a,annotation:f,getAnnotationText:j,setSelection:k}),v=(0,d.useRef)(!1),w=d8(m,i)??"#FFFF00",x=(0,d.useRef)(null),y=(0,d.useRef)({x:0,y:0}),z=(0,d.useRef)({x:0,y:0}),[A,B]=(0,d.useState)({x:0,y:0}),[C,D]=(0,d.useState)({x:0,y:0});(0,d.useEffect)(()=>{if(v.current)return;v.current=!0;let a=t(g.range,b);a&&(setTimeout(()=>{B(a.start),D(a.end)},0),y.current=a.start,z.current=a.end)},[f,g,b,t]),(0,d.useEffect)(()=>{s&&!x.current&&(setTimeout(()=>{B(s.start),D(s.end)},0),y.current=s.start,z.current=s.end)},[s]);let E=(0,d.useCallback)(()=>{x.current="start",l()},[l]),F=(0,d.useCallback)(()=>{x.current="end",l()},[l]),G=(0,d.useCallback)(a=>{B(a),y.current=a,u(a,z.current,b,!0)},[b,u]),H=(0,d.useCallback)(a=>{D(a),z.current=a,u(y.current,a,b,!0)},[b,u]),I=(0,d.useCallback)(()=>{x.current=null,u(y.current,z.current,b,!1)},[b,u]);return 0===A.x&&0===A.y?null:(0,c.jsxs)("div",{className:"pointer-events-none fixed inset-0 z-50",children:[(0,c.jsx)(fh,{position:A,isVertical:b,type:"start",color:q?r:w,onDragStart:E,onDrag:G,onDragEnd:I}),(0,c.jsx)(fh,{position:C,isVertical:b,type:"end",color:q?r:w,onDragStart:F,onDrag:H,onDragEnd:I})]})},fj=({showTooltip:a,tooltipText:b,disabled:e,Icon:f,onClick:g})=>{let[h,i]=(0,d.useState)(!1);return(0,c.jsx)("div",{className:"lg:tooltip lg:tooltip-bottom",title:!h&&a?b:void 0,children:(0,c.jsx)("button",{onClick:()=>{i(!0),g()},className:(0,j.default)("flex h-8 min-h-8 w-8 items-center justify-center p-0",e?"cursor-not-allowed opacity-50":"not-eink:hover:bg-gray-500 eink:hover:border rounded-md"),disabled:e,children:(0,c.jsx)(f,{})})})},fk=({bookKey:a,isVertical:b,notes:f,toolsVisible:g,triangleDir:h,popupWidth:i,popupHeight:k,onDismiss:l})=>{let{appService:m}=(0,e.useEnv)(),{getConfig:n,setConfig:p}=(0,P.useBookDataStore)(),{setHoveredBookKey:q}=(0,o.useReaderStore)(),{setSideBarVisible:r}=s(),t=n(a),u=(0,aH.useResponsiveSize)(250),v=(0,d.useMemo)(()=>[...f].sort((a,b)=>b.updatedAt-a.updatedAt),[f]),w=b=>{b.id&&(m?.isMobile&&l(),q(""),r(!0),t?.viewSettings&&p(a,{viewSettings:{...t.viewSettings,sideBarTab:"annotations"}}))};return(0,c.jsx)("div",{className:(0,j.default)("annotation-notes absolute flex rounded-lg text-white"),style:{...b?{right:"left"===h?`${g?i+16:0}px`:void 0,left:"right"===h?`${g?i+16:0}px`:void 0,height:`${k}px`,maxWidth:`${u}px`,overflowX:"auto"}:{top:"down"===h?`${g?k+16:0}px`:void 0,bottom:"up"===h?`${g?k+16:0}px`:void 0,width:`${i}px`,maxHeight:`${u}px`,overflowY:"auto"},scrollbarWidth:"thin"},children:(0,c.jsx)("div",{className:(0,j.default)("flex gap-4",b?"h-full flex-row":"w-full flex-col"),style:b?{display:"grid",gridAutoFlow:"column",gridAutoColumns:"max-content",minWidth:"min-content",height:`${k}px`,maxHeight:`${k}px`}:{},children:v.map((a,d)=>(0,c.jsx)("div",{role:"none",onClick:()=>w?.(a),className:(0,j.default)("popup-container cursor-pointer rounded-lg bg-gray-600 shadow-lg transition-colors"),style:b?{minWidth:"max-content",height:`${k}px`,maxHeight:`${k}px`}:{},children:a.note&&(0,c.jsx)("div",{dir:"auto",className:(0,j.default)("m-4 hyphens-auto text-justify font-sans text-sm","not-eink:text-white eink:text-base-content",b&&"writing-vertical-rl"),style:b?{fontFeatureSettings:"'vrt2' 1, 'vert' 1",minWidth:"max-content"}:{},children:(0,c.jsxs)("div",{className:(0,j.default)("flex flex-col justify-between gap-2"),children:[a.note,(0,c.jsx)("span",{className:"not-eink:text-white/50 eink:text-base-content/50 text-sm sm:text-xs",children:(0,a1.default)(a.createdAt).fromNow()})]})})},a.id||d))})})},fl=["highlight","underline","squiggly"],fm=["red","violet","blue","green","yellow"],fn=({isVertical:a,popupWidth:b,popupHeight:f,triangleDir:g,selectedStyle:i,selectedColor:k,onHandleHighlight:l})=>{let{envConfig:m}=(0,e.useEnv)(),{settings:o}=(0,h.useSettingsStore)(),{isDarkMode:p}=(0,n.useThemeStore)(),q=o.globalReadSettings,r=o.globalViewSettings.isEink,s=p?"#000000":"#ffffff",t=p?"#ffffff":"#000000",u=q.customHighlightColors,[v,w]=(0,d.useState)(i),[x,y]=(0,d.useState)(k),z=(0,aH.useResponsiveSize)(16),A=(0,aH.useResponsiveSize)(28),B=(0,aH.useResponsiveSize)(28),C=(0,aH.useResponsiveSize)(16);return(0,c.jsxs)("div",{className:(0,j.default)("highlight-options absolute flex items-center justify-between",a?"flex-col":"flex-row"),style:{width:`${b}px`,height:`${f}px`,...a?{left:`${(B+C)*("left"===g?-1:1)}px`}:{top:`${(B+C)*("up"===g?-1:1)}px`}},children:[(0,c.jsx)("div",{className:(0,j.default)("flex gap-2",a?"flex-col":"flex-row"),style:a?{width:A}:{height:A},children:fl.map(a=>(0,c.jsx)("button",{onClick:()=>{let b;return b={...q,highlightStyle:a},void((0,aN.saveSysSettings)(m,"globalReadSettings",b),w(a),y(q.highlightStyles[a]),l(!0))},className:"not-eink:bg-gray-700 eink-bordered flex items-center justify-center rounded-full p-0",style:{width:A,height:A,minHeight:A},children:(0,c.jsx)("div",{style:{width:z,height:z,..."highlight"===a&&"highlight"===v&&{backgroundColor:r?t:u[x],color:r?s:"#d1d5db",paddingTop:"2px"},..."highlight"===a&&"highlight"!==v&&{backgroundColor:"#d1d5db",paddingTop:"2px"},...("underline"===a||"squiggly"===a)&&{color:r?t:"#d1d5db",textDecoration:"underline",textDecorationThickness:"2px",textDecorationColor:v===a?r?t:u[x]:"#d1d5db",..."squiggly"===a&&{textDecorationStyle:"wavy"}}},className:"w-4 p-0 text-center leading-none",children:"A"})},a))}),(0,c.jsx)("div",{className:(0,j.default)("not-eink:bg-gray-700 eink-bordered flex items-center justify-center gap-2 rounded-3xl",a?"flex-col py-2":"flex-row px-2"),style:a?{width:A}:{height:A},children:fm.filter(a=>!r||x===a).map(a=>(0,c.jsx)("button",{onClick:()=>{let b;return b={...q,highlightStyle:v,highlightStyles:{...q.highlightStyles,[v]:a}},void((0,aN.saveSysSettings)(m,"globalReadSettings",b),y(a),l(!0))},style:{width:z,height:z,backgroundColor:x!==a?u[a]:"transparent"},className:"rounded-full p-0",children:x===a&&(0,c.jsx)(cg.FaCheckCircle,{size:z,style:{fill:r?t:u[a]}})},a))})]})},fo=({bookKey:a,dir:b,isVertical:d,buttons:e,notes:f,position:g,trianglePosition:h,highlightOptionsVisible:i,selectedStyle:k,selectedColor:l,popupWidth:m,popupHeight:n,onHighlight:o,onDismiss:p})=>(0,c.jsx)("div",{dir:b,children:(0,c.jsx)(e8,{width:d?n:m,height:d?m:n,minHeight:d?m:n,position:g,trianglePosition:h,className:(0,j.default)("selection-popup bg-gray-600 text-white",f.length>0&&"bg-transparent"),triangleClassName:"text-gray-600",onDismiss:p,children:(0,c.jsxs)("div",{className:(0,j.default)("flex h-full gap-4",d?"flex-row":"flex-col"),children:[(0,c.jsx)("div",{className:(0,j.default)("selection-buttons flex h-full w-full items-center justify-between p-2",d?"flex-col overflow-y-auto":"flex-row overflow-x-auto",f.length>0&&"hidden"),style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:e.map((a,b)=>!1===a.visible?null:(0,c.jsx)(fj,{showTooltip:!i,tooltipText:a.tooltipText,Icon:a.Icon,onClick:a.onClick,disabled:a.disabled},b))}),f.length>0?(0,c.jsx)(fk,{bookKey:a,isVertical:d,notes:f,toolsVisible:!1,triangleDir:h.dir,popupWidth:d?n:m,popupHeight:d?m:n,onDismiss:p}):i&&(0,c.jsx)(fn,{isVertical:d,triangleDir:h.dir,popupWidth:d?n:m,popupHeight:d?m:n,selectedStyle:k,selectedColor:l,onHandleHighlight:o})]})})}),fp=({word:a,lang:b,position:e,trianglePosition:g,popupWidth:h,popupHeight:i,onDismiss:j})=>{let k=(0,f.useTranslation)(),[l,m]=(0,d.useState)(a),n=(0,d.useRef)(!1);return(0,d.useEffect)(()=>{if(n.current)return;n.current=!0;let a=document.querySelector("main"),c=document.querySelector("footer");(async(b,d)=>{a.innerHTML="",c.dataset.state="loading";try{let e=await fetch(`https://en.wiktionary.org/api/rest_v1/page/definition/${b}`);if(!e.ok)throw Error("Failed to fetch definitions");let f=await e.json(),g=d?f[d]||f.en:f[Object.keys(f)[0]];if(!g||0===g.length)throw Error("No results found");let h=document.createElement("hgroup"),i=document.createElement("h1");i.innerText=b,i.className="text-lg font-bold";let j=document.createElement("p");j.innerText=g[0].language,j.className="text-sm italic opacity-75",h.append(i,j),a.append(h),g.forEach(({partOfSpeech:b,definitions:c})=>{let d=document.createElement("h2");d.innerText=b,d.className="text-base font-semibold mt-4";let e=document.createElement("ol");e.className="pl-8 list-decimal",c.forEach(({definition:a,examples:b})=>{let c;if(!a)return;let d=document.createElement("li"),f=((c=document.createElement("div")).innerHTML=a,c.querySelectorAll('a[rel="mw:WikiLink"]').forEach(a=>{let b=a.getAttribute("title");b&&(a.addEventListener("click",a=>{a.preventDefault(),m(b),n.current=!1}),a.className="text-primary underline cursor-pointer")}),Array.from(c.childNodes));if(d.append(...f),b){let a=document.createElement("ul");a.className="pl-8 list-disc text-sm italic opacity-75",b.forEach(b=>{let c=document.createElement("li");c.innerHTML=b,a.appendChild(c)}),d.appendChild(a)}e.appendChild(d)}),a.appendChild(d),a.appendChild(e)}),c.dataset.state="loaded"}catch(g){console.error(g),c.dataset.state="error";let d=document.createElement("div");d.className="flex flex-col items-center justify-center w-full h-full text-center absolute inset-0";let e=document.createElement("h1");e.innerText=k("Error"),e.className="text-lg font-bold";let f=document.createElement("p");f.innerHTML=k("Unable to load the word. Try searching directly on {{link}}.",{link:`<a href="https://en.wiktionary.org/w/index.php?search=${encodeURIComponent(b)}" target="_blank" rel="noopener noreferrer" class="text-primary underline">Wiktionary</a>`}),d.append(e,f),a.append(d)}})(l,"string"==typeof b?b:b?.[0])},[k,l,b]),(0,c.jsx)("div",{children:(0,c.jsx)(e8,{trianglePosition:g,width:h,height:i,position:e,className:"select-text",onDismiss:j,children:(0,c.jsxs)("div",{className:"flex h-full flex-col",children:[(0,c.jsx)("main",{className:"flex-grow overflow-y-auto p-4 font-sans"}),(0,c.jsx)("footer",{className:"mt-auto hidden data-[state=loaded]:block data-[state=error]:hidden data-[state=loading]:hidden",children:(0,c.jsx)("div",{className:"flex items-center px-4 py-2 text-sm opacity-60",children:"Source: Wiktionary (CC BY-SA)"})})]})})})},fq=({text:a,lang:b,position:e,trianglePosition:g,popupWidth:h,popupHeight:i,onDismiss:j})=>{let k=(0,f.useTranslation)(),l=(0,d.useRef)(!1);return(0,d.useEffect)(()=>{if(l.current)return;l.current=!0;let c=document.querySelector("main"),d=document.querySelector("footer"),e=async(a,b)=>{c.innerHTML="",d.dataset.state="loading";try{let e=await fetch(`https://${b}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(a)}`);if(!e.ok)throw Error("Failed to fetch Wikipedia summary");let f=await e.json(),g=document.createElement("hgroup");g.style.color="white",g.style.backgroundPosition="center center",g.style.backgroundSize="cover",g.style.backgroundColor="rgba(0, 0, 0, .4)",g.style.backgroundBlendMode="darken",g.style.borderRadius="6px",g.style.padding="12px",g.style.marginBottom="12px",g.style.minHeight="100px";let h=document.createElement("h1");if(h.innerHTML=f.titles.display,h.className="text-lg font-bold",g.append(h),f.description){let a=document.createElement("p");a.innerText=f.description,g.appendChild(a)}f.thumbnail&&(g.style.backgroundImage=`url("${f.thumbnail.source}")`);let i=document.createElement("div");i.innerHTML=f.extract_html,i.className="p-2 text-sm",i.dir=f.dir,c.append(g,i),d.dataset.state="loaded"}catch(h){console.error(h);let e=document.createElement("div"),f=document.createElement("h1");f.innerText=k("Error");let g=document.createElement("p");g.innerHTML=k("Unable to load the article. Try searching directly on {{link}}.",{link:`<a href="https://${b}.wikipedia.org/w/index.php?search=${encodeURIComponent(a)}" target="_blank" rel="noopener noreferrer" class="text-primary underline">Wikipedia</a>`}),e.append(f,g),c.appendChild(e),d.dataset.state="error"}},f="string"==typeof b?b:b?.[0];e(a,f?f.split("-")[0]:"en")},[k,a,b]),(0,c.jsx)("div",{children:(0,c.jsx)(e8,{width:h,height:i,position:e,trianglePosition:g,className:"select-text",onDismiss:j,children:(0,c.jsxs)("div",{className:"text-base-content flex h-full flex-col pt-2",children:[(0,c.jsx)("main",{className:"flex-grow overflow-y-auto px-2 font-sans"}),(0,c.jsx)("footer",{className:"mt-auto hidden data-[state=loaded]:block data-[state=error]:hidden data-[state=loading]:hidden",children:(0,c.jsx)("div",{className:"flex items-center px-4 py-2 text-sm opacity-60",children:"Source: Wikipedia (CC BY-SA)"})})]})})})};a.i(448083);var fr=a.i(394849),fs=a.i(907509);let ft=[""],fu=Object.fromEntries(Object.entries(ap.TRANSLATOR_LANGS).filter(([a])=>!ft.includes(a))),fv=({text:a,position:b,trianglePosition:e,popupWidth:g,popupHeight:i,onDismiss:j})=>{let k=(0,f.useTranslation)(),{token:l}=(0,aK.useAuth)(),{settings:m,setSettings:n}=(0,h.useSettingsStore)(),[o,p]=(0,d.useState)([]),[q,r]=(0,d.useState)("AUTO"),[s,t]=(0,d.useState)(m.globalReadSettings.translateTargetLang),[u,v]=(0,d.useState)(m.globalReadSettings.translationProvider),[w,x]=(0,d.useState)(null),[y,z]=(0,d.useState)(null),[A,B]=(0,d.useState)(!1),[C,D]=(0,d.useState)(null),{translate:E,translators:F}=(0,aV.useTranslator)({provider:u,sourceLang:q,targetLang:s});return(0,d.useEffect)(()=>{p(F.map(a=>{let b=a.label;return a.authRequired&&!l?b=`${b} (${k("Login Required")})`:a.quotaExceeded&&(b=`${b} (${k("Quota Exceeded")})`),{name:a.name,label:b}}))},[F]),(0,d.useEffect)(()=>{B(!0),(async()=>{D(null),x(null);try{let b=a.replaceAll("\n","").trim(),c=(await E([b]))[0];if(!c)throw Error("No translation found");x(c)}catch(a){console.error(a),l?D(k("Unable to fetch the translation. Try again later.")):D(k("Unable to fetch the translation. Please log in first and try again."))}finally{B(!1)}})()},[a,l,q,s,u,E]),(0,c.jsx)("div",{children:(0,c.jsxs)(e8,{trianglePosition:e,width:g,minHeight:i,maxHeight:720,position:b,className:"not-eink:text-white grid h-full select-text grid-rows-[1fr,auto,1fr] bg-gray-600",triangleClassName:"text-gray-600",onDismiss:j,children:[(0,c.jsxs)("div",{className:"overflow-y-auto p-4 font-sans",children:[(0,c.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,c.jsx)("h1",{className:"text-sm font-normal",children:k("Original Text")}),(0,c.jsx)(fs.default,{className:"not-eink:bg-gray-600 not-eink:text-white eink:bg-base-100",value:q,onChange:a=>{r(a.target.value)},options:[{value:"AUTO",label:k("Auto Detect")},...Object.entries(fu).sort((a,b)=>a[1].localeCompare(b[1])).map(([a,b])=>{let c=y&&"AUTO"===q&&"AUTO"===a?`${fu[y]||y} `+k("(detected)"):b;return{value:a,label:c}})]})]}),(0,c.jsx)("p",{className:"not-eink:text-white/90 text-base",children:a})]}),(0,c.jsx)("div",{className:"mx-4 flex-shrink-0 border-t border-gray-500/30"}),(0,c.jsxs)("div",{className:"overflow-y-auto px-4 pb-8 pt-4 font-sans",children:[(0,c.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,c.jsx)("h2",{className:"text-sm font-normal",children:k("Translated Text")}),(0,c.jsx)(fs.default,{className:"not-eink:bg-gray-600 not-eink:text-white eink:bg-base-100",value:s,onChange:a=>{m.globalReadSettings.translateTargetLang=a.target.value,n(m),t(a.target.value)},options:[{value:"",label:k("System Language")},...Object.entries(fu).sort((a,b)=>a[1].localeCompare(b[1])).map(([a,b])=>({value:a,label:b}))]})]}),A?(0,c.jsx)("p",{className:"text-base italic text-gray-500",children:k("Loading...")}):(0,c.jsx)("div",{children:C?(0,c.jsx)("p",{className:"text-base text-red-600",children:C}):(0,c.jsx)("p",{className:"not-eink:text-white/90 text-base",children:w||k("No translation available.")})})]}),(0,c.jsxs)("div",{className:"absolute bottom-0 flex h-8 w-full items-center justify-between px-4",children:[(0,c.jsx)("div",{className:"line-clamp-1 text-xs opacity-60",children:u&&!A&&!C&&k("Translated by {{provider}}.",{provider:o.find(a=>a.name===u)?.label})}),(0,c.jsx)(fs.default,{className:"not-eink:bg-gray-600 not-eink:text-white eink:bg-base-100",value:u,onChange:a=>{let b=a.target.value,c=(0,fr.getTranslators)().filter(a=>(!a.authRequired||!!l)&&!a.quotaExceeded),d=c.find(a=>a.name===b)||c[0];d&&(m.globalReadSettings.translationProvider=d.name,n(m),v(d.name))},options:o.map(({name:a,label:b})=>({value:a,label:b}))})]})]})})},fw=({bookKey:a,selection:b,position:g,trianglePosition:h,popupWidth:i,popupHeight:k,onConfirm:l,onDismiss:m})=>{var n;let p=(0,f.useTranslation)(),{envConfig:q}=(0,e.useEnv)(),{getProgress:r,getView:s,recreateViewer:t}=(0,o.useReaderStore)(),{addRule:u}=Q(),v=r(a),[w,y]=(0,d.useState)(""),[z,A]=(0,d.useState)(!0),[B,C]=(0,d.useState)((n=b?.text||"",!/^[\p{P}\p{S}\s]+$/u.test(n))),[D,E]=(0,d.useState)("selection"),[F,G]=(0,d.useState)(!1),H=(0,d.useRef)(null);(0,cM.useAutoFocus)({ref:H});let I=async()=>{if(!b)return;let c=b?.range;if(c){let d=((a,b)=>{try{let c=b.trim();if(!c)return!1;let d=/[\p{L}\p{N}\p{M}_]/u;if(!d.test(c))return!1;if(/[\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Hangul}]/u.test(c)||/[\s\p{P}\p{S}]/u.test(c))return!0;let{charBefore:e,charAfter:f}=(a=>{let b="",c="";try{let d=a.startContainer;if(d.nodeType===Node.TEXT_NODE)if(a.startOffset>0)b=d.textContent?.charAt(a.startOffset-1)||"";else{let a=d.previousSibling;for(;a&&a.nodeType!==Node.TEXT_NODE;)a=a.previousSibling;if(a?.nodeType===Node.TEXT_NODE){let c=a.textContent||"";b=c.charAt(c.length-1)}}let e=a.endContainer;if(e.nodeType===Node.TEXT_NODE){let b=e.textContent||"";if(a.endOffset<b.length)c=b.charAt(a.endOffset);else{let a=e.nextSibling;for(;a&&a.nodeType!==Node.TEXT_NODE;)a=a.nextSibling;a?.nodeType===Node.TEXT_NODE&&(c=(a.textContent||"").charAt(0))}}}catch(a){console.warn("[getBoundaryChars] Error:",a)}return{charBefore:b,charAfter:c}})(a);return(!e||!d.test(e))&&(!f||!d.test(f))}catch(a){return console.warn("Failed to check whole word:",a),/[\p{L}\p{N}\p{M}_]/u.test(b)}})(c,b?.text||"");if(B&&!d)return void x.eventDispatcher.dispatch("toast",{type:"warning",message:'Please select a whole word or uncheck the "Whole word" option.',timeout:5e3});if("selection"===D){c.deleteContents();let a=document.createTextNode(w);c.insertNode(a)}let e={scope:D,pattern:b.text,replacement:w.trim(),cfi:b.cfi,sectionHref:v?.sectionHref,isRegex:!1,enabled:!0,caseSensitive:z,wholeWord:B,onlyForTTS:"selection"!==D?F:void 0};l?.(e),await u(q,a,e),m(),"selection"!==D&&!F&&s(a)&&t(q,a)}},J=[{value:"selection",label:p("Current selection")},{value:"book",label:p("All occurrences in this book")},{value:"library",label:p("All occurrences in your library")}];return(0,c.jsx)("div",{children:(0,c.jsxs)(e8,{trianglePosition:h,width:i,minHeight:k,position:g,className:"not-eink:text-gray-400 flex flex-col justify-between rounded-lg bg-gray-700",triangleClassName:"text-gray-700",onDismiss:m,children:[(0,c.jsxs)("div",{className:"flex flex-col gap-6 p-4",children:[(0,c.jsxs)("div",{className:"not-eink:text-gray-400 flex gap-1 text-xs",children:[(0,c.jsx)("span",{className:"text-nowrap",children:p("Selected text:")}),(0,c.jsxs)("span",{className:"not-eink:text-yellow-300 line-clamp-1 select-text break-words font-medium",children:['"',b?.text||"",'"']})]}),(0,c.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,c.jsx)("label",{htmlFor:"replacement-input",className:"text-xs",children:p("Replace with:")}),(0,c.jsx)("input",{ref:H,type:"text",value:w,onChange:a=>{y(a.target.value)},onKeyDown:a=>{"Enter"===a.key&&w&&I()},placeholder:p("Enter text..."),className:(0,j.default)("w-full flex-1 rounded-md p-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-0","not-eink:bg-gray-600 not-eink:text-white eink:border eink:border-base-content")}),(0,c.jsx)("button",{onClick:I,disabled:!w,className:(0,j.default)("btn btn-sm btn-ghost btn-primary disabled:text-base-content/75 text-blue-600 disabled:opacity-75","bg-transparent hover:bg-transparent disabled:bg-transparent"),children:p("Apply")})]})]}),(0,c.jsxs)("div",{className:"flex flex-wrap items-center gap-4 p-4",children:[(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("span",{className:"line-clamp-1 text-xs",title:p("Case sensitive:"),children:p("Case sensitive:")}),(0,c.jsx)("input",{type:"checkbox",className:"toggle toggle-sm bg-gray-500 checked:bg-black hover:bg-gray-500 hover:checked:bg-black",style:{"--tglbg":"#4B5563"},checked:z,onChange:a=>A(a.target.checked)})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("span",{className:"line-clamp-1 text-xs",title:p("Whole word:"),children:p("Whole word:")}),(0,c.jsx)("input",{type:"checkbox",className:"toggle toggle-sm bg-gray-500 checked:bg-black hover:bg-gray-500 hover:checked:bg-black",style:{"--tglbg":"#4B5563"},checked:B,onChange:a=>C(a.target.checked)})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("span",{className:"line-clamp-1 text-xs",title:p("Only for TTS:"),children:p("Only for TTS:")}),(0,c.jsx)("input",{type:"checkbox",disabled:"selection"===D,className:"toggle toggle-sm bg-gray-500 checked:bg-black hover:bg-gray-500 hover:checked:bg-black",style:{"--tglbg":"#4B5563"},checked:F,onChange:a=>G(a.target.checked)})]})]}),(0,c.jsxs)("div",{className:"flex flex-1 items-center justify-between gap-2 p-4",children:[(0,c.jsx)("label",{htmlFor:"scope-select",className:"line-clamp-1 text-xs",title:p("Scope:"),children:p("Scope:")}),(0,c.jsx)(fs.default,{className:"not-eink:bg-gray-600 eink:bg-base-100 not-eink:text-white max-w-[85%]",value:D,onChange:a=>{E(a.target.value)},options:J})]})]})})},fx=(a,b)=>{let c=(a,b)=>{let c=a.trim().split("."),d=b;for(let a of c)d=d?.[a];return d},d=a,e=d.match(/\{%\s*for\s+(\w+)\s+in\s+(\w+(?:\.\w+)*)\s*%\}/);if(e){let a=e[1],f=e[2],g=0,h=-1,i=e.index+e[0].length;for(let a=i;a<d.length;a++){let b=d.slice(a);if(b.startsWith("{% for "))g++,a+=6;else if(b.startsWith("{% endfor %}")){if(0===g){h=a;break}g--,a+=11}}if(-1!==h){let g=d.slice(0,e.index),j=d.slice(i,h),k=d.slice(h+13),l=c(f,b);return Array.isArray(l)?(d=g+l.map(c=>fx(j,{...b,[a]:c})).join("")+k,fx(d,b)):fx(d=g+k,b)}}return(d=d.replace(/\{%\s*if\s+([^%]+?)\s*%\}([\s\S]*?)\{%\s*endif\s*%\}/g,(a,d,e)=>c(d,b)?fx(e,b):"")).replace(/\{\{\s*([^}|]+?)(?:\s*\|\s*(\w+)(?:\s*\((['"]?)([^)'"]*)\3\))?)?\s*\}\}/g,(a,d,e,f,g)=>{let h=c(d,b);if(null==h)return"";if(e){if("date"===e&&"number"==typeof h){let a=new Date(h);return g?g.replace("%Y",a.getFullYear().toString()).replace("%m",String(a.getMonth()+1).padStart(2,"0")).replace("%d",String(a.getDate()).padStart(2,"0")).replace("%H",String(a.getHours()).padStart(2,"0")).replace("%M",String(a.getMinutes()).padStart(2,"0")).replace("%S",String(a.getSeconds()).padStart(2,"0")):a.toLocaleString()}return h}return String(h)})},fy=({bookKey:a,isOpen:b,bookTitle:g,bookAuthor:h,booknotes:i,booknoteGroups:k,onCancel:l,onExport:m})=>{let n=(0,f.useTranslation)(),{envConfig:p}=(0,e.useEnv)(),{getViewSettings:q}=(0,o.useReaderStore)(),r=q(a),s=`## {{ title }}
**${n("Author")}**: {{ author }}

**${n("Exported from Readest")}**: {{ exportDate }}

---

### ${n("Highlights & Annotations")}

{% for chapter in chapters %}
#### {{ chapter.title }}
{% for annotation in chapter.annotations %}
> {{ annotation.text }}
{% if annotation.note %}
**${n("Note:")}** {{ annotation.note }}
{% endif %}
*${n("Time:")} {{ annotation.timestamp | date('%Y-%m-%d %H:%M') }}*
{% endfor %}

---
{% endfor %}`,[t,u]=(0,d.useState)(()=>{let a=r?.noteExportConfig||ap.DEFAULT_NOTE_EXPORT_CONFIG;return a.customTemplate?a:{...a,customTemplate:s}}),[v,w]=(0,d.useState)(!1),[x,y]=(0,d.useState)(!1);(0,d.useEffect)(()=>{let b=t.customTemplate,c={...t,customTemplate:b===s?"":b};(0,aN.saveViewSettings)(p,a,"noteExportConfig",c,!1,!1)},[t,p,a]);let z=(0,d.useMemo)(()=>{if(t.useCustomTemplate){let a=Object.values(k).sort((a,b)=>a.id-b.id),b={title:g,author:h,exportDate:new Date().toISOString().slice(0,10),chapters:a.map(a=>({title:a.label||n("Untitled"),annotations:a.booknotes.map(a=>({text:a.text||"",note:a.note||"",style:a.style,color:a.color,timestamp:a.updatedAt}))}))};return fx(t.customTemplate,b)}let a=Object.values(k).sort((a,b)=>a.id-b.id),b=[];for(let c of(t.includeTitle&&b.push(`# ${g}`),t.includeAuthor&&h&&(b.push(`**${n("Author")}**: ${h}`),b.push("")),t.includeDate&&(b.push(`**${n("Exported from Readest")}**: ${new Date().toISOString().slice(0,10)}`),b.push("")),(t.includeTitle||t.includeAuthor||t.includeDate)&&(b.push("---"),b.push("")),b.push(`## ${n("Highlights & Annotations")}`),b.push(""),a)){if(t.includeChapterTitles){let a=c.label||n("Untitled");b.push(`### ${a}`)}for(let a of c.booknotes){if(t.includeQuotes&&a.text&&b.push(`> ${a.text}`),t.includeNotes&&a.note&&(b.push(""),b.push(`**${n("Note")}**:: ${a.note}`)),t.includeTimestamp&&a.updatedAt){let c=new Date(a.updatedAt).toLocaleString();b.push(""),b.push(`*${n("Time:")} ${c}*`)}b.push(t.noteSeparator)}t.includeChapterSeparator&&(b.push("---"),b.push(""))}return b.join("\n")},[t,k,g,h,n]),A=(0,d.useMemo)(()=>z?b2.parse(z):"",[z]),B=a=>{u(b=>({...b,[a]:!b[a]}))};return(0,c.jsx)(L.default,{isOpen:b,title:n("Export Annotations"),onClose:l,boxClassName:"sm:!w-[75%] sm:h-auto sm:!max-h-[90vh] sm:!max-w-5xl",contentClassName:"sm:!px-8 sm:!py-2",children:(0,c.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsx)("h3",{className:"font-bold",children:n("Format Options")}),(0,c.jsxs)("div",{className:(0,j.default)("grid grid-cols-2 gap-x-6 gap-y-3 sm:grid-cols-3",t.useCustomTemplate&&"pointer-events-none opacity-50"),children:[(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeTitle,onChange:()=>B("includeTitle"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Title")})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeAuthor,onChange:()=>B("includeAuthor"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Author")})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeDate,onChange:()=>B("includeDate"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Export Date")})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeChapterTitles,onChange:()=>B("includeChapterTitles"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Chapter Titles")})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeChapterSeparator,onChange:()=>B("includeChapterSeparator"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Chapter Separator")})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeQuotes,onChange:()=>B("includeQuotes"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Highlights")})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeNotes,onChange:()=>B("includeNotes"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Notes")})]}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.includeTimestamp,onChange:()=>B("includeTimestamp"),className:"checkbox checkbox-sm",disabled:t.useCustomTemplate}),(0,c.jsx)("span",{className:"text-sm",children:n("Note Date")})]})]})]}),(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsxs)("div",{className:"flex items-center justify-between",children:[(0,c.jsx)("h3",{className:"font-bold",children:n("Advanced")}),(0,c.jsx)("button",{onClick:()=>y(!x),className:"text-sm text-blue-500 hover:underline",children:x?n("Hide"):n("Show")})]}),x&&(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:t.useCustomTemplate,onChange:()=>B("useCustomTemplate"),className:"checkbox checkbox-sm"}),(0,c.jsx)("span",{className:"text-sm font-medium",children:n("Use Custom Template")})]}),t.useCustomTemplate&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsxs)("div",{className:"space-y-2",children:[(0,c.jsx)("label",{className:"text-sm font-medium",children:n("Export Template")}),(0,c.jsx)("textarea",{value:t.customTemplate,onChange:a=>u({...t,customTemplate:a.target.value}),className:"textarea textarea-bordered w-full font-mono text-xs",rows:12,placeholder:s})]}),(0,c.jsxs)("div",{className:"bg-base-200 space-y-3 rounded-lg p-3 text-xs",children:[(0,c.jsxs)("div",{children:[(0,c.jsx)("p",{className:"mb-2 font-bold",children:n("Template Syntax:")}),(0,c.jsxs)("ul",{className:"space-y-1 font-mono",children:[(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"{{ variable }}"})," -"," ",n("Insert value")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"{{ variable | date }}"})," ","- ",n("Format date (locale)")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"{{ variable | date('%Y-%m-%d') }}"})," ","- ",n("Format date (custom)")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"{% if variable %}...{% endif %}"})," ","- ",n("Conditional")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"{% for item in list %}...{% endfor %}"})," ","- ",n("Loop")]})]})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("p",{className:"mb-2 font-bold",children:n("Available Variables:")}),(0,c.jsxs)("ul",{className:"space-y-1",children:[(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"title"})," -"," ",n("Book title")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"author"})," -"," ",n("Book author")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"exportDate"})," -"," ",n("Export date")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"chapters"})," -"," ",n("Array of chapters")]}),(0,c.jsxs)("li",{className:"ml-4",children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"chapter.title"})," -"," ",n("Chapter title")]}),(0,c.jsxs)("li",{className:"ml-4",children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"chapter.annotations"})," -"," ",n("Array of annotations")]}),(0,c.jsxs)("li",{className:"ml-8",children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"annotation.text"})," -"," ",n("Highlighted text")]}),(0,c.jsxs)("li",{className:"ml-8",children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"annotation.note"})," -"," ",n("Annotation note")]}),(0,c.jsxs)("li",{className:"ml-8",children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"annotation.timestamp"})," -"," ",n("Update time")]})]})]}),(0,c.jsxs)("div",{children:[(0,c.jsx)("p",{className:"mb-2 font-bold",children:n("Date Format Tokens:")}),(0,c.jsxs)("ul",{className:"space-y-1 font-mono",children:[(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"%Y"})," -"," ",n("Year (4 digits)")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"%m"})," -"," ",n("Month (01-12)")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"%d"})," - ",n("Day (01-31)")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"%H"})," - ",n("Hour (00-23)")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"%M"})," -"," ",n("Minute (00-59)")]}),(0,c.jsxs)("li",{children:[(0,c.jsx)("code",{className:"bg-base-300 rounded px-1",children:"%S"})," -"," ",n("Second (00-59)")]})]})]})]})]})]})]}),(0,c.jsxs)("div",{className:"space-y-2",children:[(0,c.jsxs)("div",{className:"flex items-center justify-between",children:[(0,c.jsx)("h3",{className:"font-bold",children:n("Preview")}),(0,c.jsxs)("label",{className:"flex cursor-pointer items-center gap-2",children:[(0,c.jsx)("input",{type:"checkbox",checked:v,onChange:()=>w(!v),className:"checkbox checkbox-sm"}),(0,c.jsx)("span",{className:"text-sm",children:n("Show Source")})]})]}),v?(0,c.jsx)("div",{className:(0,j.default)("bg-base-200 max-h-[40vh] overflow-y-auto rounded-lg p-4 font-mono text-xs","select-text whitespace-pre-wrap break-words"),children:z||n("No content to preview")}):(0,c.jsx)("div",{className:(0,j.default)("bg-base-200 prose prose-sm max-w-none overflow-y-auto rounded-lg p-4","max-h-[40vh] select-text break-words"),dangerouslySetInnerHTML:{__html:A||`<p class="text-base-content/50">${n("No content to preview")}</p>`}})]}),(0,c.jsxs)("div",{className:"mt-4 flex justify-end gap-4",children:[(0,c.jsx)("button",{onClick:l,className:"btn btn-ghost btn-sm",children:n("Cancel")}),(0,c.jsx)("button",{onClick:()=>{m(z)},className:"btn btn-primary btn-sm",disabled:0===i.length,children:n("Export")})]})]})})},fz=({bookKey:a})=>{let b=(0,f.useTranslation)(),{envConfig:g,appService:i}=(0,e.useEnv)(),{settings:j}=(0,h.useSettingsStore)(),{isDarkMode:k}=(0,n.useThemeStore)(),{getConfig:l,saveConfig:m,getBookData:p,updateBooknotes:q}=(0,P.useBookDataStore)(),{getProgress:r,getView:s,getViewsById:v,getViewSettings:w}=(0,o.useReaderStore)(),{setNotebookVisible:y,setNotebookNewAnnotation:z}=t(),{listenToNativeTouchEvents:A}=(0,u.useDeviceControlStore)();(a=>{let{user:b}=(0,aK.useAuth)(),{syncedNotes:c,syncNotes:e,lastSyncedAtNotes:f}=(0,cF.useSync)(a),{getConfig:g,setConfig:h,getBookData:i}=(0,P.useBookDataStore)(),j=g(a),k=(0,d.useCallback)(()=>{let c=g(a),d=i(a)?.book;if(!c?.location||!d||!b)return{};let e=(c.booknotes??[]).filter(a=>f<a.updatedAt||f<(a.deletedAt??0));return e.forEach(a=>{a.bookHash=d.hash,a.metaHash=d.metaHash}),{notes:e,lastSyncedAt:f}},[b,a,f,g,i]),l=(0,d.useCallback)((0,af.throttle)(()=>{let b=i(a)?.book;e(k().notes,b?.hash,b?.metaHash,"both")},1e3*ap.SYNC_NOTES_INTERVAL_SEC,{emitLast:!1}),[e]);(0,d.useEffect)(()=>{j?.location&&b&&l()},[j?.booknotes,l]),(0,d.useEffect)(()=>{if(c?.length&&j){let b=i(a)?.book,d=c.filter(a=>a.bookHash===b?.hash||a.metaHash===b?.metaHash);if(!d.length)return;let e=[...(j.booknotes??[]).filter(a=>!d.some(b=>b.id===a.id)),...d.map(b=>{let c=g(a),d=(c?.booknotes??[]).find(a=>a.id===b.id);if(d)if(d.updatedAt<b.updatedAt||(d.deletedAt??0)<(b.deletedAt??0))return{...d,...b};else return{...b,...d};return b})];h(a,{booknotes:e})}},[c])})(a);let B=(0,K.getOSPlatform)(),C=l(a),D=r(a),E=p(a),F=s(a),G=w(a),H=E.book?.primaryLanguage||"en",I=d.default.useRef(null),[J,L]=(0,d.useState)(null),[M,N]=(0,d.useState)(!1),[Q,R]=(0,d.useState)(!1),[S,T]=(0,d.useState)(!1),[U,V]=(0,d.useState)(!1),[W,X]=(0,d.useState)(!1),[Y,Z]=(0,d.useState)(),[$,_]=(0,d.useState)(),[aa,ab]=(0,d.useState)(),[ac,ad]=(0,d.useState)(),[ae,ag]=(0,d.useState)(),[ah,ai]=(0,d.useState)(!1),[aj,ak]=(0,d.useState)(!1),[al,am]=(0,d.useState)([]),[an,ao]=(0,d.useState)(null),[aq,ar]=(0,d.useState)(!1),[as,at]=(0,d.useState)(null),[au,av]=(0,d.useState)(j.globalReadSettings.highlightStyle),[ax,ay]=(0,d.useState)(j.globalReadSettings.highlightStyles[au]),az=M||Q||S||U||W,aA=(0,aH.useResponsiveSize)(10),aB=2*aA+6,aC=window.innerWidth-2*aA,aD=window.innerHeight-2*aA,aE=Math.min(480,aC),aF=Math.min(300,aD),aG=Math.min(480,aC),aI=Math.min(265,aD),aJ=Math.min(440,aC),aL=Math.min(200,aD),aM=Math.min((0,aH.useResponsiveSize)(300),aC),aN=(0,aH.useResponsiveSize)(44),aO=(0,d.useCallback)(()=>{if(!J||!J.text)return;let b=document.querySelector(`#gridcell-${a}`);if(!b)return;let c=b.getBoundingClientRect(),d=e4(J,c,aB,G.vertical),e=e5(d,c,G.vertical?aN:aM,G.vertical?aM:aN,aA);"down"===e.dir&&"android"===B&&(d.point.y+=0,e.point.y+=0);let f=e5(d,c,aE,aF,aA),g=e5(d,c,aG,aI,aA),h=e5(d,c,aJ,aL,aA);0!=d.point.x&&0!=d.point.y&&(_(e),ab(f),ad(g),ag(h),Z(d))},[J,a,G.vertical]);(0,d.useEffect)(()=>{av(j.globalReadSettings.highlightStyle)},[j.globalReadSettings.highlightStyle]),(0,d.useEffect)(()=>{ay(j.globalReadSettings.highlightStyles[au])},[j.globalReadSettings.highlightStyles,au]);let aP=(0,d.useMemo)(()=>({bookKey:a,viewSettings:w(a),userLocale:(0,K.getLocale)(),content:"",transformers:["punctuation"],reversePunctuationTransform:!0}),[]),aQ=(0,d.useCallback)(async a=>(aP.content=((a,b=[])=>{let c,d=a.cloneRange().cloneContents(),e=document.createTreeWalker(d,NodeFilter.SHOW_TEXT,{acceptNode:a=>{let c=a.parentElement;return b.includes(c?.tagName.toLowerCase()||"")?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}}),f="";for(;c=e.nextNode();)f+=c.nodeValue??"";return f})(a,H.startsWith("ja")?["rt"]:[]),await d2(aP)),[H,aP]),aR=(0,d.useCallback)((0,af.throttle)(()=>{L(null),N(!1),R(!1),T(!1),V(!1),X(!1),ao(null)},500),[]),{isTextSelected:aS,handleScroll:aT,handleTouchStart:aV,handleTouchMove:aW,handleTouchEnd:aX,handlePointerDown:aY,handlePointerMove:aZ,handlePointerCancel:a$,handlePointerUp:a_,handleSelectionchange:a1,handleShowPopup:a2,handleUpToPopup:a3,handleContextmenu:a4}=((a,b,c,f)=>{let{appService:g}=(0,e.useEnv)(),{getView:i,getViewSettings:j}=(0,o.useReaderStore)(),k=i(a),l=(0,K.getOSPlatform)(),m=(0,d.useRef)(!1),n=(0,d.useRef)(!1),p=(0,d.useRef)(!1),q=(0,d.useRef)(!1),r=(0,d.useRef)(null),s=(0,d.useRef)("mouse"),t=(0,d.useRef)(!1),u=(0,d.useRef)(!1),{isInstantAnnotationEnabled:v,handleInstantAnnotationPointerDown:w,handleInstantAnnotationPointerMove:y,handleInstantAnnotationPointerCancel:z,handleInstantAnnotationPointerUp:A}=(({bookKey:a,getAnnotationText:b})=>{let{envConfig:c}=(0,e.useEnv)(),{settings:f}=(0,h.useSettingsStore)(),{getConfig:g,saveConfig:i,updateBooknotes:j}=(0,P.useBookDataStore)(),{getView:k,getViewsById:l,getViewSettings:m}=(0,o.useReaderStore)(),n=(0,d.useRef)(null),p=(0,d.useRef)(null),q=(0,d.useRef)(0),r=(0,d.useRef)(null),s=(0,d.useRef)((0,K.uniqueId)()),t=(0,d.useCallback)(()=>{let b=m(a);return b?.enableAnnotationQuickActions&&b?.annotationQuickAction==="highlight"},[a,m]),u=(0,d.useCallback)(()=>{r.current&&(l(a.split("-")[0]).forEach(a=>a?.addAnnotation(r.current,!0)),r.current=null)},[a,l]),v=(0,d.useCallback)((a,b,c)=>{if(a.caretPositionFromPoint){let d=a.caretPositionFromPoint(b,c);if(d)return{node:d.offsetNode,offset:d.offset}}if(a.caretRangeFromPoint){let d=a.caretRangeFromPoint(b,c);if(d)return{node:d.startContainer,offset:d.startOffset}}return null},[]),w=(0,d.useCallback)((a,b,c)=>{let d=v(a,b,c);if(!d||d.node.nodeType!==Node.TEXT_NODE)return!1;let e=d.node,f=e.length;if(0===f)return!1;let g=a.createRange();try{let a=Math.min(d.offset,f-1),h=Math.min(d.offset+1,f);for(let d of(g.setStart(e,a),g.setEnd(e,h),g.getClientRects()))if(b>=d.left-20&&b<=d.right+20&&c>=d.top-20&&c<=d.bottom+20)return!0}catch{}return!1},[v]),x=(0,d.useCallback)((a,b,c)=>{let d=v(a,b.x,b.y),e=v(a,c.x,c.y);if(!d||!e)return null;let f=a.createRange();try{if(d.node.compareDocumentPosition(e.node)&Node.DOCUMENT_POSITION_PRECEDING||d.node===e.node&&d.offset>e.offset?(f.setStart(e.node,e.offset),f.setEnd(d.node,d.offset)):(f.setStart(d.node,d.offset),f.setEnd(e.node,e.offset)),f.collapsed)return null;return f}catch(a){return console.warn("Failed to create range:",a),null}},[v]),y=(0,d.useCallback)((a,b)=>{let c=f.globalReadSettings.highlightStyle,d=f.globalReadSettings.highlightStyles[c];return{id:s.current,type:"annotation",cfi:a,style:c,color:d,text:b??"",note:"",createdAt:Date.now(),updatedAt:Date.now()}},[]),z=(0,d.useCallback)((a,b,c)=>!!t()&&0===c.button&&!!w(a,c.clientX,c.clientY)&&(n.current={x:c.clientX,y:c.clientY},p.current=a,q.current=b,r.current=null,s.current=(0,K.uniqueId)(),!0),[t,w]),A=(0,d.useCallback)((b,c,d)=>{if(!t())return!1;let e=k(a);if(!n.current||!p.current||!e)return!1;let f={x:d.clientX,y:d.clientY},g=n.current,h=Math.abs(f.x-g.x),i=Math.abs(f.y-g.y),j=Math.sqrt(Math.pow(h,2)+Math.pow(i,2));if(j<20||h/i<5&&i/h<5&&j<30)return!1;let m=x(b,g,f);if(!m)return!1;let o=e.getCFI(c,m);if(!o)return!1;u();let q=y(o);return l(a.split("-")[0]).forEach(a=>a?.addAnnotation(q)),r.current=q,!0},[t,x]),B=(0,d.useCallback)(()=>!!t()&&(n.current=null,p.current=null,u(),!0),[t,u]),C=(0,d.useCallback)(async(d,e,h)=>{if(!t())return!1;let m=k(a);if(!n.current||!m)return n.current=null,p.current=null,u(),!1;let o={x:h.clientX,y:h.clientY},q=n.current;if(n.current=null,p.current=null,10>Math.sqrt(Math.pow(o.x-q.x,2)+Math.pow(o.y-q.y,2)))return u(),!1;let r=x(d,q,o);if(!r)return u(),!1;let s=await b(r),v=m.getCFI(e,r);if(!s||!v||0===s.trim().length)return u(),!1;u();let w=y(v,s);l(a.split("-")[0]).forEach(a=>a?.addAnnotation(w));let{booknotes:z=[]}=g(a),A=z.findIndex(a=>a.cfi===v&&"annotation"===a.type&&a.style&&!a.deletedAt);-1!==A?z[A]={...z[A],...w,id:z[A].id}:z.push(w);let B=j(a,z);return B&&i(c,a,B,f),!0},[t,x,b,u]);return{isInstantAnnotationEnabled:t,handleInstantAnnotationPointerDown:z,handleInstantAnnotationPointerMove:A,handleInstantAnnotationPointerCancel:B,handleInstantAnnotationPointerUp:C,cancelInstantAnnotation:(0,d.useCallback)(()=>{n.current=null,p.current=null,u()},[u])}})({bookKey:a,getAnnotationText:c,setSelection:b}),B=a=>a&&a.toString().trim().length>0&&a.rangeCount>0,C=async(d,e,f=!1)=>{p.current=!0;let g=d.getRangeAt(0);f&&(d.removeAllRanges(),d.addRange(g)),b({key:a,text:await c(g),cfi:k?.getCFI(e,g),range:g,index:e})},D=async(d,e)=>{p.current=!0;let f=d.getRangeAt(0);setTimeout(()=>{d.removeAllRanges(),setTimeout(async()=>{p.current&&(d.addRange(f),b({key:a,text:await c(f),cfi:k?.getCFI(e,f),range:f,index:e}))},30)},30)},E=a=>{t.current=!1,u.current=!1,k&&(k.renderer.scrollLocked=!1),a.target.style.userSelect=""},F=async(a,b,c)=>{if(t.current&&c){if(E(c),await A(a,b,c)){p.current=!0;return}c.target?.dispatchEvent(new MouseEvent("mousedown",{...c,bubbles:!0,cancelable:!0}))}let d=a.getSelection();if(B(d)){let a=c&&((a,b)=>{if(0===a.rangeCount)return!1;let c=a.getRangeAt(0).getClientRects();for(let a=0;a<c.length;a++){let d=c[a];if(b.clientX>=d.left-80&&b.clientX<=d.right+80&&b.clientY>=d.top-80&&b.clientY<=d.bottom+80)return!0}return!1})(d,c),e="ios"===l||g?.isIOSApp;a&&e?D(d,b):a&&(n.current=!0,C(d,b,!0))}};return(0,d.useEffect)(()=>{let a=()=>n.current?(n.current=!1,!0):p.current?(f(),p.current=!1,k?.deselect(),!0):!!m.current&&(f(),!0);return x.eventDispatcher.onSync("iframe-single-click",a),()=>{x.eventDispatcher.offSync("iframe-single-click",a)}},[]),{isTextSelected:p,handleScroll:()=>{if("android"!==l||!g?.isAndroidApp)return;let b=j(a);!b?.scrolled&&p.current&&k?.renderer?.containerPosition&&r.current&&(console.warn("Keep container position",r.current),k.renderer.containerPosition=r.current)},handleTouchStart:()=>{q.current=!0},handleTouchMove:a=>{t.current&&u.current&&a.preventDefault()},handleTouchEnd:()=>{q.current=!1},handlePointerDown:(a,b,c)=>{(s.current=c.pointerType,v()&&w(a,b,c))&&(c.preventDefault(),t.current=!0,u.current=!1,k&&(k.renderer.scrollLocked=!0),c.target.style.userSelect="none")},handlePointerMove:(a,b,c)=>{t.current&&(c.preventDefault(),u.current=y(a,b,c))},handlePointerCancel:(a,b,c)=>{t.current&&(E(c),z())},handlePointerUp:F,handleSelectionchange:(a,b)=>{if("android"!==l||!g?.isAndroidApp)return;let c=a.getSelection();B(c)?(r.current||(r.current=k?.renderer?.start||null),C(c,b,!1)):r.current=null},handleShowPopup:a=>{setTimeout(()=>{a&&!m.current&&(n.current=!1),m.current=a},500)},handleUpToPopup:()=>{n.current=!0},handleContextmenu:a=>g?.isMobile||"touch"===s.current||"pen"===s.current?(a.preventDefault(),a.stopPropagation(),!1):void 0}})(a,L,aQ,aR),a5=()=>{aR(),F?.deselect(),aS.current=!1};cE(F,{onLoad:b=>{let c=b.detail,{doc:d,index:e}=c;i?.isAndroidApp&&(A(),x.eventDispatcher.on("native-touch",a=>{let b=a.detail;"touchstart"===b.type?aV():"touchend"===b.type&&(aX(),a_(d,e))})),F?.renderer?.addEventListener("scroll",aT),F?.renderer?.addEventListener("scroll",()=>{aO()});let f={passive:!1};c.doc?.addEventListener("touchstart",aV,f),c.doc?.addEventListener("touchmove",a=>{N(!1),ao(null),aW(a)},f),c.doc?.addEventListener("touchend",aX),c.doc?.addEventListener("pointerdown",aY.bind(null,d,e),f),c.doc?.addEventListener("pointermove",aZ.bind(null,d,e),f),c.doc?.addEventListener("pointercancel",a$.bind(null,d,e)),c.doc?.addEventListener("pointerup",a_.bind(null,d,e)),c.doc?.addEventListener("selectionchange",a1.bind(null,d,e)),E.book?.format==="PDF"&&c.doc?.addEventListener("contextmenu",b=>{try{let b=d.getSelection?.();if(b&&!b.isCollapsed){let c=b.getRangeAt(0),d=b.toString();d.trim()&&(L({key:a,text:d,range:c,index:e,cfi:F?.getCFI(e,c)}),N(!1),V(!0),R(!1),T(!1))}}catch(a){console.warn("PDF context menu translation failed:",a)}return b.preventDefault(),b.stopPropagation(),!1}),c.doc?.addEventListener("contextmenu",a4)},onDrawAnnotation:b=>{let c=w(a),d=c.isEink,{draw:e,annotation:f,doc:g,range:h}=b.detail,{style:l,color:m}=f,n=d8(j,m);if(f.note){let{defaultView:a}=g,b=h.startContainer,c=1===b.nodeType?b:b.parentElement,{writingMode:d}=a.getComputedStyle(c);e(eZ.Overlayer.bubble,{writingMode:d})}else if("highlight"===l)e(eZ.Overlayer.highlight,{color:d?k?"#000000":"#ffffff":n});else if(["underline","squiggly"].includes(l)){let{defaultView:a}=g,b=h.startContainer,f=1===b.nodeType?b:b.parentElement,{writingMode:j,lineHeight:m,fontSize:o}=a.getComputedStyle(f),p=parseFloat(o)||c.defaultFontSize,q=parseFloat(m)||c.lineHeight*p,r=i?.isMobile?0:-1,s=i?.isMobile?-1:0,t=c.vertical?(q-p)/2-2+r:(q-p)/2-2+s;e(eZ.Overlayer[l],{writingMode:j,color:d?k?"#ffffff":"#000000":n,padding:t})}},onShowAnnotation:b=>{let c=b.detail,{value:d,index:e,range:f}=c,{booknotes:g=[]}=l(a),h=d.startsWith(b3),i=h?d.replace(b3,""):d,j=g.filter(a=>"annotation"===a.type&&!a.deletedAt&&a.cfi===i).find(a=>!h&&a.style||h&&a.note);if(!j)return;let{style:k,color:m,text:n,note:o}=j,p={key:a,annotated:!0,text:n??"",note:o??"",rect:h?c.rect:void 0,cfi:i,range:f,index:e};h?(ak(!0),ai(!1),ao(null)):(ak(!1),am([]),k&&m&&(av(k),ay(m)),k&&f&&ao(j)),L(p),a3()}}),(0,d.useEffect)(()=>{a2(az)},[az]),(0,d.useEffect)(()=>{let b=s(a);if(!b?.renderer)return;let c=()=>{az&&aO()};return b.renderer.addEventListener("scroll",c),()=>{b.renderer.removeEventListener("scroll",c)}},[a,az,aO]),(0,d.useEffect)(()=>(x.eventDispatcher.on("export-annotations",bh),()=>{x.eventDispatcher.off("export-annotations",bh)}),[]),(0,d.useEffect)(()=>{if(ai(!!(J&&J.annotated)),J&&J.text.trim().length>0){let b=document.querySelector(`#gridcell-${a}`);if(!b)return;let c=b.getBoundingClientRect(),d=e4(J,c,aB,G.vertical),e=e5(d,c,G.vertical?aN:aM,G.vertical?aM:aN,aA);"down"===e.dir&&"android"===B&&(d.point.y+=0,e.point.y+=0);let f=e5(d,c,aE,aF,aA),g=e5(d,c,aG,aI,aA),h=e5(d,c,aJ,aL,aA);if(0==d.point.x||0==d.point.y)return;_(e),ab(f),ad(g),ag(h),Z(d);let{enableAnnotationQuickActions:i,annotationQuickAction:j}=G;if(i&&j&&aS.current)switch(G.annotationQuickAction){case"copy":a7(!1),a5();break;case"highlight":a5();break;case"search":ba();break;case"dictionary":bb();break;case"wikipedia":bc();break;case"translate":bd();break;case"tts":be(!0)}else a6()}},[J,a]),(0,d.useEffect)(()=>{if(!D)return;let{location:a}=D,{booknotes:b=[]}=C,c=b.filter(b=>!b.deletedAt&&"annotation"===b.type&&b.style&&b4(b.cfi,a)),d=b.filter(b=>!b.deletedAt&&"annotation"===b.type&&b.note&&b.note.trim().length>0&&b4(b.cfi,a));try{Promise.all(c.map(a=>F?.addAnnotation(a))),Promise.all(d.map(a=>F?.addAnnotation({...a,value:`${b3}${a.cfi}`})))}catch(a){console.warn(a)}},[D]),(0,d.useEffect)(()=>{C.booknotes&&J?.cfi&&aj&&am(C.booknotes.filter(a=>"annotation"===a.type&&!a.deletedAt&&a.cfi===J.cfi).filter(a=>a.note&&a.note.trim().length>0))},[J?.cfi,aj,C.booknotes]);let a6=()=>{i?.isMobile||I.current?.focus(),N(!0),V(!1),R(!1),T(!1)},a7=(c=!0)=>{if(!J||!J.text||(setTimeout(()=>{navigator.clipboard?.writeText(J.text)},100),c&&a5(),!G?.copyToNotebook))return;x.eventDispatcher.dispatch("toast",{type:"info",message:b("Copied to notebook"),className:"whitespace-nowrap",timeout:2e3});let{booknotes:d=[]}=C,e=F?.getCFI(J.index,J.range);if(!e)return;let f={id:(0,K.uniqueId)(),type:"excerpt",cfi:e,text:J.text,note:"",createdAt:Date.now(),updatedAt:Date.now()},h=d.findIndex(a=>a.cfi===e&&"excerpt"===a.type&&!a.deletedAt);-1!==h?d[h]=f:d.push(f);let k=q(a,d);k&&m(g,a,k,j),i?.isMobile||y(!0)},a8=(b=!1,c)=>{if(!J||!J.text)return;ai(!0);let{booknotes:d=[]}=C,e=F?.getCFI(J.index,J.range);if(!e)return;let f=c||j.globalReadSettings.highlightStyle,h=j.globalReadSettings.highlightStyles[f],i={id:(0,K.uniqueId)(),type:"annotation",cfi:e,style:f,color:h,text:J.text,note:"",createdAt:Date.now(),updatedAt:Date.now()},k=d.findIndex(a=>a.cfi===e&&"annotation"===a.type&&a.style&&!a.deletedAt),l=v(a.split("-")[0]);-1!==k?(l.forEach(a=>a?.addAnnotation(i,!0)),b?(i.id=d[k].id,d[k]=i,l.forEach(a=>a?.addAnnotation(i))):(d[k].deletedAt=Date.now(),aR())):(d.push(i),l.forEach(a=>a?.addAnnotation(i)),L({...J,cfi:e,annotated:!0}));let n=q(a,d);n&&m(g,a,n,j)},a9=()=>{if(!J||!J.text)return;let{sectionHref:a}=D;J.href=a,a8(!0),y(!0),z(J),aR()},ba=()=>{if(!J||!J.text)return;a5();let b=J.text,c=G.convertChineseVariant;c&&"none"!==c&&(b=(0,dX.runSimpleCC)(b,c,!0)),x.eventDispatcher.dispatch("search-term",{term:b,bookKey:a})},bb=()=>{J&&J.text&&(N(!1),R(!0))},bc=()=>{J&&J.text&&(N(!1),T(!0))},bd=()=>{J&&J.text&&(N(!1),V(!0))},be=async(b=!1)=>{J&&J.text&&(N(!1),x.eventDispatcher.dispatch("tts-speak",{bookKey:a,range:J.range,oneTime:b}))},bf=()=>{if(J&&J.text){var a;if(N(!1),X(!0),((a=J.text)?a.trim().split(/\s+/).filter(Boolean).length:0)>30)return void x.eventDispatcher.dispatch("toast",{type:"warning",message:b("Word limit of 30 words exceeded."),timeout:3e3})}},bg=(0,d.useCallback)(()=>{N(!1)},[]);(0,aw.default)({onHighlightSelection:()=>{a8(!1,"highlight")},onUnderlineSelection:()=>{a8(!1,"underline")},onAnnotateSelection:()=>{a9()},onSearchSelection:()=>{ba()},onCopySelection:()=>{a7(!1)},onTranslateSelection:()=>{bd()},onDictionarySelection:()=>{bb()},onWikipediaSelection:()=>{bc()},onReadAloudSelection:()=>{be()},onProofreadSelection:()=>{bf()}},[J?.text]);let bh=async c=>{let{bookKey:d}=c.detail;if(a!==d)return;let{bookDoc:e,book:f}=E;if(!e||!f||!e.toc)return;let{booknotes:g=[]}=l(a),h=g.filter(a=>!a.deletedAt);if(0===h.length)return void x.eventDispatcher.dispatch("toast",{type:"info",message:b("No annotations to export"),className:"whitespace-nowrap",timeout:2e3});let i={};for(let a of h){let b=(0,aU.findTocItemBS)(e.toc??[],a.cfi),c=b?.href||"",d=b?.label||"",f=b?.id||0;i[c]||(i[c]={id:f,href:c,label:d,booknotes:[]}),i[c].booknotes.push(a)}Object.values(i).forEach(a=>{a.booknotes.sort((a,b)=>a0.compare(a.cfi,b.cfi))}),at({booknotes:h,booknoteGroups:i}),ar(!0)},bi=async a=>{let{book:c}=E;if(!c)return;setTimeout(()=>{navigator.clipboard?.writeText(a)},100);let d=`${(0,K.makeSafeFilename)(c.title)}.md`,e=await i?.saveFile(d,a,"text/markdown");x.eventDispatcher.dispatch("toast",{type:"info",message:e?b("Exported successfully"):b("Copied to clipboard"),timeout:2e3}),ar(!1),at(null)},bj=J?.annotated,bk=d9.annotationToolButtons.map(({type:a,label:c,Icon:d})=>{switch(a){case"copy":return{tooltipText:b(c),Icon:d,onClick:a7};case"highlight":return{tooltipText:bj?b("Delete Highlight"):b(c),Icon:bj?O.RiDeleteBinLine:d,onClick:a8,disabled:E.book?.format==="PDF"};case"annotate":return{tooltipText:b(c),Icon:d,onClick:a9,disabled:E.book?.format==="PDF"};case"search":return{tooltipText:b(c),Icon:d,onClick:ba,disabled:E.book?.format==="PDF"};case"dictionary":return{tooltipText:b(c),Icon:d,onClick:bb};case"wikipedia":return{tooltipText:b(c),Icon:d,onClick:bc};case"translate":return{tooltipText:b(c),Icon:d,onClick:bd};case"tts":return{tooltipText:b(c),Icon:d,onClick:be,disabled:E.book?.format==="PDF"};case"proofread":return{tooltipText:b(c),Icon:d,onClick:bf,disabled:E.book?.format!=="EPUB"};default:return{tooltipText:"",Icon:d,onClick:()=>{}}}});return(0,c.jsxs)("div",{ref:I,role:"toolbar",tabIndex:-1,children:[Q&&Y&&aa&&(0,c.jsx)(fp,{word:J?.text,lang:E.bookDoc?.metadata.language,position:aa,trianglePosition:Y,popupWidth:aE,popupHeight:aF,onDismiss:a5}),S&&Y&&aa&&(0,c.jsx)(fq,{text:J?.text,lang:E.bookDoc?.metadata.language,position:aa,trianglePosition:Y,popupWidth:aE,popupHeight:aF,onDismiss:a5}),U&&Y&&ac&&(0,c.jsx)(fv,{text:J?.text,position:ac,trianglePosition:Y,popupWidth:aG,popupHeight:aI,onDismiss:a5}),M&&Y&&$&&(0,c.jsx)(fo,{bookKey:a,dir:G.rtl?"rtl":"ltr",isVertical:G.vertical,buttons:bk,notes:al,position:$,trianglePosition:Y,highlightOptionsVisible:ah,selectedStyle:au,selectedColor:ax,popupWidth:aM,popupHeight:aN,onHighlight:a8,onDismiss:a5}),W&&Y&&ae&&J&&(0,c.jsx)(fw,{bookKey:a,selection:J,position:ae,trianglePosition:Y,popupWidth:aJ,popupHeight:aL,onDismiss:a5}),an&&an.color&&J&&(0,c.jsx)(fi,{bookKey:a,isVertical:G.vertical,annotation:an,selection:J,handleColor:ax,getAnnotationText:aQ,setSelection:L,onStartEdit:bg}),aq&&as&&E.book&&(0,c.jsx)(fy,{bookKey:a,isOpen:aq,bookTitle:E.book.title,bookAuthor:E.book.author||"",booknotes:as.booknotes,booknoteGroups:as.booknoteGroups,onCancel:()=>{ar(!1),at(null)},onExport:bi})]})},fA=a=>new Set([...a?.getAttributeNS?.("http://www.idpf.org/2007/ops","type")?.split(" ")??[],...a?.attributes?.getNamedItem?.("epub:type")?.value?.split(" ")??[]]),fB=a=>new Set(a?.getAttribute?.("role")?.split(" ")),fC=a=>{if(a.matches("sup"))return!0;let{verticalAlign:b}=getComputedStyle(a);return"super"===b||"top"===b||"text-top"===b||/^\d/.test(b)},fD=["biblioref","glossref","noteref"],fE=["doc-biblioref","doc-glossref","doc-noteref"],fF="a, span, sup, sub, em, strong, i, b, small, big";class fG extends EventTarget{detectFootnotes=!0;#z(a,{index:b,anchor:c},d){let e=document.createElement("foliate-view");return new Promise((f,g)=>{e.addEventListener("load",a=>{try{let b,g,{doc:h}=a.detail,i=c(h),j=(b=fA(i),(g=fB(i)).has("doc-biblioentry")||b.has("biblioentry")?"biblioentry":g.has("definition")||b.has("glossdef")?"definition":g.has("doc-endnote")||b.has("endnote")||b.has("rearnote")?"endnote":g.has("doc-footnote")||b.has("footnote")?"footnote":g.has("note")||b.has("note")?"note":null),k=i?.matches?.("aside")&&"footnote"===j;if(i){let a;if(i.startContainer)a=i;else if(i.matches("li, aside"))(a=h.createRange()).selectNodeContents(i);else if(i.matches("dt")){(a=h.createRange()).setStartBefore(i);let b=i.nextElementSibling,c=null;for(;b&&b.matches("dd");)c=b,b=b.nextElementSibling;a.setEndAfter(c||i)}else if(i.closest("li"))(a=h.createRange()).selectNodeContents(i.closest("li"));else if(i.closest(".note"))(a=h.createRange()).selectNodeContents(i.closest(".note"));else if(i.querySelector("a")){(a=h.createRange()).setStartBefore(i);let b=i.nextElementSibling;for(;b&&!b.querySelector("a");)b=b.nextElementSibling;b?a.setEndBefore(b):a.setEndAfter(i.parentNode.lastChild)}else a=h.createRange(),!(i.textContent?.trim()||i.children.length>0)&&i.parentElement?a.selectNodeContents(i.parentElement):a.selectNode(i);let b=a.extractContents();h.body.replaceChildren(),h.body.appendChild(b)}this.dispatchEvent(new CustomEvent("render",{detail:{view:e,href:d,type:j,hidden:k,target:i}})),f()}catch(a){g(a)}}),e.open(a).then(()=>this.dispatchEvent(new CustomEvent("before-render",{detail:{view:e}}))).then(()=>e.goTo(b)).catch(g)})}handle(a,b){let c,d,{a:e,href:f,follow:g}=b.detail,{yes:h,maybe:i}=(c=fA(e),d=fB(e),{yes:fE.some(a=>d.has(a))||fD.some(a=>c.has(a)),maybe:()=>!c.has("backlink")&&!d.has("doc-backlink")&&(fC(e)||1===e.children.length&&fC(e.children[0])||fC(e.parentElement))});return h||g?(b.preventDefault(),Promise.resolve(a.resolveHref(f)).then(b=>this.#z(a,b,f))):this.detectFootnotes&&i()?(b.preventDefault(),Promise.resolve(a.resolveHref(f)).then(({index:b,anchor:c})=>this.#z(a,{index:b,anchor:a=>((a,b)=>{let c=b(a),d=c;for(;c.matches(fF);){let a=c.parentElement;if(!a)break;c=a}if(c===a.body){let a=d.nextElementSibling;if(a&&!a.matches(fF))return a;throw Error("Failed to extract footnote")}return c})(a,c)},f))):void 0}}let fH=({bookKey:a,bookDoc:b})=>{let e=(0,d.useRef)(null),f=(0,d.useRef)(null),[g,h]=(0,d.useState)(),[i,j]=(0,d.useState)(),[k,l]=(0,d.useState)(!1),{getBookData:m}=(0,P.useBookDataStore)(),{getView:n,getViewSettings:p}=(0,o.useReaderStore)(),{getLoadedFonts:q}=(0,cD.useCustomFontStore)(),r=n(a),s=p(a),t=new fG,u=(0,d.useRef)(null),[v,w]=(0,d.useState)(null),[y,z]=(0,d.useState)(360),[B,C]=(0,d.useState)(88),D=(a,b)=>Math.min(a,(b?window.innerWidth/2:window.innerHeight/2)-10-12),E=a=>Math.min(a,window.innerWidth-10-12),F=a=>Math.min(a,window.innerHeight-10-12);(0,d.useEffect)(()=>{let c=c=>{let{view:d}=c.detail;d.addEventListener("link",c=>{c.preventDefault();let{detail:d}=c;d.follow=!0,t.handle(b,c)?.catch(b=>{console.warn(b),n(a)?.goTo(d.href)})}),d.addEventListener("load",b=>{let{doc:c}=b.detail,d=m(a);(0,A.mountAdditionalFonts)(c,(0,ch.isCJKLang)(d.book?.primaryLanguage)),q().forEach(a=>{(0,A.mountCustomFont)(c,a)})}),f.current=d,e.current?.replaceChildren(d);let{renderer:g}=d;g.setAttribute("flow","scrolled"),g.setAttribute("margin-top","0px"),g.setAttribute("margin-right","0px"),g.setAttribute("margin-bottom","0px"),g.setAttribute("margin-left","0px"),g.setAttribute("gap","0%");let h=p(a),i={...(0,at.getThemeCode)()},j=document.getElementById("popup-container");j&&(i.bg=getComputedStyle(j).backgroundColor);let k=(0,at.getStyles)(h,i),l=(0,at.getFootnoteStyles)();g.setStyles?.(`${k}
${l}`)},d=b=>{let{view:c}=b.detail;c.addEventListener("relocate",()=>{let{renderer:b}=c;p(a).vertical?z(E(D(b.viewSize,!0))):C(F(D(b.viewSize,!1))),l(!0)})};return t.addEventListener("before-render",c),t.addEventListener("render",d),()=>{t.removeEventListener("before-render",c),t.removeEventListener("render",d)}},[r]),(0,d.useEffect)(()=>{k&&u.current?.focus()},[k]),(0,d.useEffect)(()=>{s.vertical?(z(E(88)),C(F(Math.max(360,window.innerHeight/4)))):(z(E(Math.max(360,window.innerWidth/4))),C(F(88)))},[s]),(0,d.useEffect)(()=>{g&&v&&j(e5(g,v,y,B,10))},[g,v,y,B]);let G=async c=>{let d=c.detail,e=document.querySelector(`#gridcell-${a}`);if(!e)return;let f=e.getBoundingClientRect(),g=p(a),i=e4(d.a,f,10,g.vertical);w(f),h(i);let{a:j}=d;["duokan-footnote","footnote-link","footnote"].some(a=>j.classList.contains(a))&&(d.follow=!0),t.handle(b,c)?.catch(a=>{console.warn(a);let b=c.detail;r?.goTo(b.href)})},H=()=>{let a;a=e.current?.querySelector("foliate-view"),a?.close(),a?.remove(),w(null),j(null),h(null),l(!1)},I=b=>{let{element:c,footnote:d}=b.detail,f=document.querySelector(`#gridcell-${a}`);if(!f)return;let g=f.getBoundingClientRect(),i=p(a),j=e4(c,g,10,i.vertical);if(e.current){let a=document.createElement("p");a.textContent=d,a.setAttribute("style","padding: 1em; hanging-punctuation: allow-end last;"),a.style.visibility="hidden",i.vertical?a.style.height=`${B}px`:a.style.width=`${y}px`,document.body.appendChild(a);let b=a.getBoundingClientRect();i.vertical?z(D(b.width,!0)):C(D(b.height,!1)),document.body.removeChild(a),a.style.visibility="visible",e.current.replaceChildren(a),w(g),h(j),l(!0)}};return cE(r,{onLinkClick:G}),(0,d.useEffect)(()=>(window.addEventListener("resize",H),x.eventDispatcher.on("footnote-popup",I),()=>{window.removeEventListener("resize",H),x.eventDispatcher.off("footnote-popup",I)}),[]),(0,d.useEffect)(()=>{f.current&&e.current?.replaceChildren(f.current)},[e]),(0,c.jsxs)("div",{ref:u,role:"toolbar",tabIndex:-1,children:[k&&(0,c.jsx)(aB.Overlay,{onDismiss:H}),(0,c.jsx)(e8,{isOpen:k,width:y,height:B,position:k?i:void 0,trianglePosition:k?g:void 0,className:"select-text overflow-y-auto",onDismiss:H,children:(0,c.jsx)("div",{className:"footnote-content",ref:e,style:{width:`${y}px`,height:`${B}px`}})})]})},fI=({bookKey:a,showDoubleBorder:b,isScrolled:f,isVertical:g,isEink:h,horizontalGap:i,contentInsets:k,gridInsets:l})=>{let{appService:m}=(0,e.useEnv)(),{systemUIVisible:o,statusBarHeight:p}=(0,n.useThemeStore)(),q=Math.max(l.top,m?.isAndroidApp&&o?p/2:0),[r,s]=d.default.useState(null),t=(0,d.useRef)(2e3),u=(0,d.useRef)(null),v=b=>{let{message:c,bookKey:d,timeout:e=2e3}=b.detail;d===a&&(s(c),t.current=e)};return((0,d.useEffect)(()=>(x.eventDispatcher.on("hint",v),()=>{x.eventDispatcher.off("hint",v)}),[]),(0,d.useEffect)(()=>(u.current&&clearTimeout(u.current),u.current=setTimeout(()=>s(""),t.current),()=>{u.current&&clearTimeout(u.current)}),[r]),r)?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:(0,j.default)("absolute left-0 right-0 top-0 z-10",r?"":"bg-transparent"),style:{height:`${q}px`}}),(0,c.jsx)("div",{className:(0,j.default)("hintinfo absolute flex items-center justify-end overflow-hidden ps-2",r?"":"bg-transparent",g?"writing-vertical-rl":"top-0 h-[44px]",f?g?"h-full":"w-full":g?"max-h-[50%]":"max-w-[50%]"),style:g?{bottom:`${(k.bottom-l.bottom)*1.5}px`,right:b?`calc(${k.right}px)`:`calc(${Math.max(0,k.right-32)}px)`,width:b?"30px":`${k.right}px`}:{top:`${q}px`,insetInlineEnd:`calc(${i/2}% + ${k.right/2}px)`},children:(0,c.jsx)("h2",{className:(0,j.default)("text-center font-sans",h?"text-sm font-normal":"text-neutral-content text-xs font-light"),children:r||""})})]}):null},fJ=({borderColor:a,showHeader:b,showFooter:d,insets:e})=>(0,c.jsxs)("div",{children:[(0,c.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{border:`4px solid ${a}`,height:`calc(100% - ${e.top+e.bottom}px + 20px)`,top:`calc(${e.top}px - 10px)`,left:`calc(${e.left}px - 10px)`,right:`calc(${e.right}px - 10px)`}}),(0,c.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{border:`1px solid ${a}`,height:`calc(100% - ${e.top+e.bottom}px)`,top:`${e.top}px`,left:`calc(${e.left+32*!!d}px`,right:`calc(${e.right+32*!!b}px`}}),d&&(0,c.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{borderTop:`1px solid ${a}`,borderBottom:`1px solid ${a}`,borderLeft:`1px solid ${a}`,width:"32px",height:`calc(100% - ${e.top+e.bottom}px)`,top:`${e.top}px`,left:`calc(${e.left}px)`}}),b&&(0,c.jsx)("div",{className:"borderframe pointer-events-none absolute",style:{borderTop:`1px solid ${a}`,borderBottom:`1px solid ${a}`,borderRight:`1px solid ${a}`,width:"32px",height:`calc(100% - ${e.top+e.bottom}px)`,top:`${e.top}px`,left:`calc(100% - ${e.right}px - 32px)`}})]}),fK=({bookKeys:a,onCloseBook:b})=>{let g=(0,f.useTranslation)(),{appService:h}=(0,e.useEnv)(),{getConfig:i,getBookData:k}=(0,P.useBookDataStore)(),{getProgress:l,getViewState:m,getViewSettings:p}=(0,o.useReaderStore)(),{setGridInsets:q,hoveredBookKey:r}=(0,o.useReaderStore)(),{sideBarBookKey:t}=s(),{safeAreaInsets:u}=(0,n.useThemeStore)(),v=window.innerWidth/window.innerHeight,w=cw(a.length,v);(0,d.useEffect)(()=>{if(!t)return;let a=k(t);a&&a.book&&(document.title=a.book.title)},[t]);let x=(a,b)=>{let c,d,e,f,g;if(!u)return{top:0,right:0,bottom:0,left:0};let{top:h,right:i,bottom:j,left:k}=(d=(c=cw(b,v)).columns.split(" ").length,e=c.rows.split(" ").length,{top:0===(f=Math.floor(a/d)),right:(g=a%d)==d-1,bottom:f===e-1,left:0===g});return{top:h?u.top:0,right:i?u.right:0,bottom:j?u.bottom:0,left:k?u.left:0}};return((0,d.useEffect)(()=>{u&&a.forEach((b,c)=>{q(b,x(c,a.length))})},[a,u]),u)?(0,c.jsx)("div",{className:(0,j.default)("books-grid bg-base-100 relative grid h-full flex-grow"),style:{gridTemplateColumns:w.columns,gridTemplateRows:w.rows},role:"main","aria-label":g("Books Content"),children:a.map((d,e)=>{let f=k(d),g=i(d),n=l(d),o=p(d),q=m(d),s=x(e,a.length),{book:t,bookDoc:u}=f||{};if(!t||!g||!u||!o||!q)return null;let{section:v,pageinfo:w,timeinfo:y,sectionLabel:z}=n||{},A=q.ribbonVisible,B=q.viewerKey,C=o.gapPercent,D=cx(o),E={top:s.top+D.top,right:s.right+D.right,bottom:s.bottom+D.bottom,left:s.left+D.left},F=o.scrolled,G=o.showBarsOnScroll,H=o.showHeader&&(!F||G),I=o.showFooter&&(!F||G);return(0,c.jsxs)("div",{id:`gridcell-${d}`,className:(0,j.default)("relative h-full w-full overflow-hidden",h?.hasRoundedWindow&&"rounded-window"),children:[A&&!r&&(0,c.jsx)(fg,{width:`${C}%`}),(0,c.jsx)(en,{bookKey:d,bookTitle:t.title,isTopLeft:0===e,isHoveredAnim:a.length>2,onCloseBook:b,gridInsets:s}),(0,c.jsx)(d5,{bookKey:d,bookDoc:u,config:g,gridInsets:s,contentInsets:E},B),o.vertical&&o.scrolled&&(0,c.jsxs)(c.Fragment,{children:[(I||o.doubleBorder)&&(0,c.jsx)("div",{className:"bg-base-100 absolute left-0 top-0 h-full",style:{width:`calc(${E.left+32*!!I}px)`,height:"calc(100%)"}}),(H||o.doubleBorder)&&(0,c.jsx)("div",{className:"bg-base-100 absolute right-0 top-0 h-full",style:{width:`calc(${E.right+32*!!H}px)`,height:"calc(100%)"}})]}),o.vertical&&o.doubleBorder&&(0,c.jsx)(fJ,{showHeader:H,showFooter:I,borderColor:o.borderColor,horizontalGap:C,insets:D}),H&&(0,c.jsx)(d6,{bookKey:d,section:z,showDoubleBorder:o.vertical&&o.doubleBorder,isScrolled:o.scrolled,isVertical:o.vertical,isEink:o.isEink,horizontalGap:C,contentInsets:E,gridInsets:s}),(0,c.jsx)(fI,{bookKey:d,showDoubleBorder:o.vertical&&o.doubleBorder,isScrolled:o.scrolled,isVertical:o.vertical,isEink:o.isEink,horizontalGap:C,contentInsets:E,gridInsets:s}),I&&(0,c.jsx)(ff,{bookKey:d,section:v,pageinfo:w,timeinfo:y,horizontalGap:C,contentInsets:E,gridInsets:s}),(0,c.jsx)(fz,{bookKey:d}),(0,c.jsx)(cA,{bookKey:d,gridInsets:s}),(0,c.jsx)(cB,{bookKey:d,gridInsets:s,toc:u.toc||[]}),(0,c.jsx)(fH,{bookKey:d,bookDoc:u}),(0,c.jsx)(fe,{bookKey:d,bookFormat:t.format,section:v,pageinfo:w,isHoveredAnim:!1,gridInsets:s})]},d)})}):null};var fL=a.i(642196);let fM=({ids:a,settings:b})=>{let g=(0,f.useTranslation)(),i=(0,k.useRouter)(),j=(0,k.useSearchParams)(),{envConfig:l,appService:m}=(0,e.useEnv)(),{bookKeys:n,dismissBook:p,getNextBookKey:q}=as(),{sideBarBookKey:r,setSideBarBookKey:u}=s(),{saveSettings:v}=(0,h.useSettingsStore)(),{getConfig:w,getBookData:y,saveConfig:A}=(0,P.useBookDataStore)(),{getView:B,setBookKeys:C,getViewSettings:D}=(0,o.useReaderStore)(),{initViewState:E,getViewState:F,clearViewState:G}=(0,o.useReaderStore)(),{isSettingsDialogOpen:H,settingsDialogBookKey:I}=(0,h.useSettingsStore)(),[J,L]=(0,d.useState)(null),M=(0,d.useRef)(!1),[N,O]=(0,d.useState)(!1),[Q,R]=(0,d.useState)(!1);(({sideBarBookKey:a,bookKeys:b})=>{let{getView:c,getViewState:e,getViewSettings:f,setViewSettings:g}=(0,o.useReaderStore)(),{toggleSideBar:i,setSideBarBookKey:j}=s(),{setSettingsDialogOpen:k}=(0,h.useSettingsStore)(),{getBookData:l}=(0,P.useBookDataStore)(),{toggleNotebook:m}=t(),{getNextBookKey:n}=as(),p=f(a??""),q=(p?.defaultFontSize??16)*(p?.lineHeight??1.6)*3,r=async()=>{(0,z.isTauriAppPlatform)()&&await (0,ae.tauriHandleToggleFullScreen)()},u=async()=>{(0,z.isTauriAppPlatform)()&&await (0,ae.tauriHandleClose)()},v=async()=>{(0,z.isTauriAppPlatform)()&&await (0,ae.tauriQuitApp)()},w=b=>{if(!a)return;let d=c(a),e=l(a),h=f(a);h.zoomLevel=b,g(a,h),d?.renderer.setStyles?.((0,at.getStyles)(h)),e?.bookDoc?.rendition?.layout==="pre-paginated"&&d?.renderer.setAttribute("scale-factor",b)},y=(b=1)=>{a&&w(Math.min(f(a).zoomLevel+ap.ZOOM_STEP*b,ap.MAX_ZOOM_LEVEL))},A=(b=1)=>{a&&w(Math.max(f(a).zoomLevel-ap.ZOOM_STEP*b,ap.MIN_ZOOM_LEVEL))},B=a=>{y(a.detail?.factor||1)},C=a=>{A(a.detail?.factor||1)},D=()=>{a&&w(100)};(0,d.useEffect)(()=>(x.eventDispatcher.on("zoom-in",B),x.eventDispatcher.on("zoom-out",C),x.eventDispatcher.on("reset-zoom",D),()=>{x.eventDispatcher.off("zoom-in",B),x.eventDispatcher.off("zoom-out",C),x.eventDispatcher.off("reset-zoom",D)}),[a]),(0,aw.default)({onSwitchSideBar:()=>{a&&j(n(a))},onToggleSideBar:i,onToggleNotebook:m,onToggleScrollMode:()=>{let b=f(a??"");if(b&&a){b.scrolled=!b.scrolled,g(a,b);let d=b.scrolled?"scrolled":"paginated";c(a)?.renderer.setAttribute("flow",d)}},onToggleBookmark:()=>{a&&x.eventDispatcher.dispatch("toggle-bookmark",{bookKey:a})},onOpenFontLayoutSettings:()=>k(!0),onShowSearchBar:()=>{setTimeout(()=>{x.eventDispatcher.dispatch("search-term",{term:null,bookKey:a})},100)},onToggleFullscreen:r,onToggleTTS:()=>{if(!a)return;let b=e(a);x.eventDispatcher.dispatch(b?.ttsEnabled?"tts-stop":"tts-speak",{bookKey:a})},onReloadPage:()=>{window.location.reload()},onCloseWindow:u,onQuitApp:v,onGoLeft:()=>{let b=f(a??"");av(c(a),b,"left","pan",q)},onGoRight:()=>{let b=f(a??"");av(c(a),b,"right","pan",q)},onGoUp:b=>{let d=c(a),e=f(a??"");d?.renderer.scrolled&&b instanceof MessageEvent||av(d,e,"up","pan",q)},onGoDown:b=>{let d=c(a),e=f(a??"");d?.renderer.scrolled&&b instanceof MessageEvent||av(d,e,"down","pan",q)},onGoPrev:()=>{c(a)?.prev(q)},onGoNext:()=>{c(a)?.next(q)},onGoHalfPageDown:()=>{let b=c(a),d=f(a??"");b&&d&&d.scrolled&&b.next(b.renderer.size/2)},onGoHalfPageUp:()=>{let b=c(a),d=f(a??"");b&&d&&d.scrolled&&b.prev(b.renderer.size/2)},onGoPrevSection:()=>{let b=f(a??"");av(c(a),b,"up","section")},onGoNextSection:()=>{let b=f(a??"");av(c(a),b,"down","section")},onGoLeftSection:()=>{let b=f(a??"");av(c(a),b,"left","section")},onGoRightSection:()=>{let b=f(a??"");av(c(a),b,"right","section")},onGoBack:()=>{c(a)?.history.back()},onGoForward:()=>{c(a)?.history.forward()},onZoomIn:()=>{y()},onZoomOut:()=>{A()},onResetZoom:D},[a,b])})({sideBarBookKey:r,bookKeys:n}),(0,d.useEffect)(()=>{if(M.current)return;M.current=!0;let b=window.location.pathname,c=(a||j?.get("ids")||b.split("/reader/")[1]||"").split(ap.BOOK_IDS_SEPARATOR).filter(Boolean).map(a=>`${a}-${(0,K.uniqueId)()}`);C(c);let d=new Set;console.log("Initialize books",c),c.forEach((a,b)=>{let c=a.split("-")[0],e=!d.has(c);d.add(c),F(a)||(E(l,c,a,e).catch(b=>{console.log("Error initializing book",a,b),R(!0),x.eventDispatcher.dispatch("toast",{message:g("Unable to open book"),callback:()=>U(),timeout:2e3,type:"error"})}),0===b&&u(a))})},[]),(0,d.useEffect)(()=>{let a=a=>(L(a.detail),!0);return x.eventDispatcher.onSync("show-book-details",a),()=>{x.eventDispatcher.offSync("show-book-details",a)}},[]),(0,d.useEffect)(()=>{let a;if(n&&n.length>0){let a=h.useSettingsStore.getState().settings,b=n.map(a=>a.split("-")[0]);a.lastOpenBooks?.toString()!==b.toString()&&(a.lastOpenBooks=b,v(l,a))}return(0,z.isTauriAppPlatform)()&&(a=(0,ae.tauriHandleOnCloseWindow)(V)),window.addEventListener("beforeunload",V),x.eventDispatcher.on("beforereload",V),x.eventDispatcher.on("close-reader",V),x.eventDispatcher.on("quit-app",V),()=>{window.removeEventListener("beforeunload",V),x.eventDispatcher.off("beforereload",V),x.eventDispatcher.off("close-reader",V),x.eventDispatcher.off("quit-app",V),a?.then(a=>a())}},[n]);let S=async a=>{let b=w(a),{book:c}=y(a)||{},{isPrimary:d}=F(a)||{};if(d&&c&&b){let c=h.useSettingsStore.getState().settings;x.eventDispatcher.dispatch("sync-book-progress",{bookKey:a}),x.eventDispatcher.dispatch("flush-kosync",{bookKey:a}),await A(l,a,b,c)}},T=async a=>{console.log("Closing book",a);let b=F(a);b?.isPrimary&&m?.isDesktopApp&&await ao(m);try{B(a)?.close(),B(a)?.remove()}catch{console.info("Error closing book",a)}x.eventDispatcher.dispatch("tts-stop",{bookKey:a}),await S(a),G(a)},U=()=>{(0,ag.navigateToLibrary)(i,"",void 0,!0)},V=(0,af.throttle)(async()=>{let a=h.useSettingsStore.getState().settings;await Promise.all(n.map(async a=>await T(a))),await v(l,a)},200),W=async a=>{if(T(a),r===a&&u(q(r)),p(a),0==n.filter(b=>b!==a).length){let a=await (0,ac.parseOpenWithFiles)(m)||[];if(m?.hasWindow){if(a.length>0)return(0,ae.tauriHandleOnCloseWindow)(V),await (0,ae.tauriHandleClose)();let b=(0,ad.getCurrentWindow)();if(b.label.startsWith("reader"))return await b.close()}v(l,b),U()}};if(!n||0===n.length)return null;let X=y(n[0]),Y=D(n[0]);return X&&X.book&&X.bookDoc&&Y?(0,c.jsxs)("div",{className:"reader-content full-height flex",children:[(0,c.jsx)(cp,{onGoToLibrary:()=>{if(V(),(0,z.isTauriAppPlatform)()){let a=(0,ad.getCurrentWindow)();"main"===a.label?U():a.close()}else U()}}),(0,c.jsx)(fK,{bookKeys:n,onCloseBook:W}),H&&(0,c.jsx)(fL.default,{bookKey:I}),(0,c.jsx)(cv,{}),J&&(0,c.jsx)(aq.BookDetailModal,{isOpen:!!J,book:J,onClose:()=>L(null)})]}):(setTimeout(()=>O(!0),200),N&&!Q&&(0,c.jsx)("div",{className:"hero hero-content full-height",children:(0,c.jsx)(ax.default,{loading:!0})}))},fN=({ids:a})=>{let b=(0,k.useRouter)(),{appService:f}=(0,e.useEnv)(),{settings:g}=(0,h.useSettingsStore)(),{libraryLoaded:i}=(0,m.useLibrary)(),{sideBarBookKey:p}=s(),{hoveredBookKey:q}=(0,o.useReaderStore)(),{showSystemUI:r,dismissSystemUI:E}=(0,n.useThemeStore)(),{getScreenBrightness:F,setScreenBrightness:G}=(0,u.useDeviceControlStore)(),{acquireBackKeyInterception:H,releaseBackKeyInterception:I}=(0,u.useDeviceControlStore)(),{isSideBarVisible:J,isSideBarPinned:L}=s(),{getIsSideBarVisible:M,setSideBarVisible:O}=s(),{isNotebookVisible:P,isNotebookPinned:Q}=t(),{getIsNotebookVisible:R,setNotebookVisible:S}=t(),{isDarkMode:T,systemUIAlwaysHidden:U,isRoundedWindow:V}=(0,n.useThemeStore)();(0,l.useTheme)({systemUIVisible:g.alwaysShowStatusBar,appThemeColor:"base-100"}),(0,v.useScreenWakeLock)(g.screenWakeLock),(0,w.useTransferQueue)(i,5e3),(0,d.useEffect)(()=>{let a;(0,A.mountAdditionalFonts)(document),a=window.open,globalThis.open=function(b,c,d){return(0,z.isTauriAppPlatform)()?((0,y.openUrl)(b?.toString()||""),null):a(b,c,d)},(0,z.isTauriAppPlatform)()&&setTimeout(B.getSysFontsList,3e3),(0,ab.initDayjs)((0,K.getLocale)())},[]),(0,d.useEffect)(()=>{let a=g.screenBrightness,b=g.autoScreenBrightness;f?.hasScreenBrightness&&!b&&a>=0&&G(a/100);let c=-1;return f?.isIOSApp&&F().then(a=>{c=a}),()=>{f?.hasScreenBrightness&&!b&&G(c)}},[f]);let W=a=>"Back"===a.detail.keyName&&(M()&&!L?O(!1):R()&&!Q?S(!1):(x.eventDispatcher.dispatch("close-reader"),b.back()),!0);return(0,d.useEffect)(()=>{if(f?.isAndroidApp)return H(),()=>{I()}},[f?.isAndroidApp]),(0,d.useEffect)(()=>(f?.isAndroidApp&&x.eventDispatcher.onSync("native-key-down",W),()=>{f?.isAndroidApp&&x.eventDispatcher.offSync("native-key-down",W)}),[f?.isAndroidApp,p,L,J,Q,P]),(0,d.useEffect)(()=>{if(!f?.isMobileApp)return;let a=!!((q||g.alwaysShowStatusBar)&&!U);(0,B.setSystemUIVisibility)({visible:a,darkMode:T}),a?r():E()},[q]),i&&g.globalReadSettings?(0,c.jsx)("div",{className:(0,j.default)("reader-page bg-base-100 text-base-content full-height select-none overflow-hidden",f?.hasRoundedWindow&&V&&"window-border rounded-window"),children:(0,c.jsxs)(d.Suspense,{fallback:(0,c.jsx)("div",{className:"full-height"}),children:[(0,c.jsx)(fM,{ids:a,settings:g}),(0,c.jsx)(C.AboutWindow,{}),(0,c.jsx)(D.UpdaterWindow,{}),(0,c.jsx)(N,{}),(0,c.jsx)(_,{}),(0,c.jsx)(aa.Toast,{})]})}):(0,c.jsx)("div",{className:(0,j.default)("full-height",!f?.isLinuxApp&&"bg-base-100")})};function fO(){let a=(0,f.useTranslation)(),{appService:b}=(0,e.useEnv)(),{settings:j}=(0,h.useSettingsStore)();return(0,g.useOpenWithBooks)(),(0,d.useEffect)(()=>{(async()=>{b?.hasUpdater&&j.autoCheckUpdates?await (0,i.checkForAppUpdates)(a):b?.hasUpdater===!1&&(0,i.checkAppReleaseNotes)()})()},[b?.hasUpdater,j.autoCheckUpdates]),(0,c.jsx)(fN,{})}a.s(["default",()=>fO],625725)}];

//# sourceMappingURL=_7e8c1d57._.js.map