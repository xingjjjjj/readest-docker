module.exports=[475030,a=>{"use strict";let b=a=>{if(!a)return"";let b=document.createElement("textarea");return b.innerHTML=a,b.value},c="application/xhtml+xml",d="text/html",e="image/svg+xml",f={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},g={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},h={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},i={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},j={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},k={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},l={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},m={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},n={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},o={magic:[0,4,"string"],numEntries:[8,4,"uint"]},p={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},q={1252:"windows-1252",65001:"utf-8"},r={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},s={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},t=(a,b)=>{let c=new a.constructor(a.length+b.length);return c.set(a),c.set(b,a.length),c},u=(a,b,c)=>{let d=new a.constructor(a.length+b.length+c.length);return d.set(a),d.set(b,a.length),d.set(c,a.length+b.length),d},v=new TextDecoder,w=a=>v.decode(a),x=a=>{if(!a)return;let b=a.byteLength;return new DataView(a)[4===b?"getUint32":2===b?"getUint16":"getUint8"](0)},y=(a,b)=>Object.fromEntries(Array.from(Object.entries(a)).map(([a,[c,d,e]])=>[a,("string"===e?w:x)(b.slice(c,c+d))])),z=a=>new TextDecoder(q[a]),A=(a,b=0)=>{let c=0,d=0;for(let e of a.subarray(b,b+4))if(c=c<<7|(127&e)>>>0,d++,128&e)break;return{value:c,length:d}},B=a=>{let b=0;for(let c of a.subarray(-4))128&c&&(b=0),b=b<<7|127&c;return b},C=a=>{let b=0;for(;a>0;a>>=1)(1&a)==1&&b++;return b},D=a=>{let b=0;for(;(1&a)==0;)a>>=1,b++;return b},E=a=>{let b=[];for(let c=0;c<a.length;c++){let d=a[c];if(0===d)b.push(0);else if(d<=8)for(let e of a.subarray(c+1,(c+=d)+1))b.push(e);else if(d<=127)b.push(d);else if(d<=191){let e=d<<8|a[c+++1],f=(16383&e)>>>3,g=(7&e)+3;for(let a=0;a<g;a++)b.push(b[b.length-f])}else b.push(32,128^d)}return Uint8Array.from(b)},F=(a,b)=>{let c=b>>3,d=b+32,e=d>>3,f=0n;for(let b=c;b<=e;b++)f=f<<8n|BigInt(a[b]??0);return f>>8n-BigInt(7&d)&4294967295n},G=async(a,b)=>{let c=await b(a.huffcdic),{magic:d,offset1:e,offset2:f}=y(m,c);if("HUFF"!==d)throw Error("Invalid HUFF record");let g=Array.from({length:256},(a,b)=>e+4*b).map(a=>x(c.slice(a,a+4))).map(a=>[128&a,31&a,a>>>8]),h=[null].concat(Array.from({length:32},(a,b)=>f+8*b).map(a=>[x(c.slice(a,a+4)),x(c.slice(a+4,a+8))])),i=[];for(let c=1;c<a.numHuffcdic;c++){let d=await b(a.huffcdic+c),e=y(n,d);if("CDIC"!==e.magic)throw Error("Invalid CDIC record");let f=Math.min(1<<e.codeLength,e.numEntries-i.length),g=d.slice(e.length);for(let a=0;a<f;a++){let b=x(g.slice(2*a,2*a+2)),c=x(g.slice(b,b+2)),d=32767&c,e=32768&c,f=new Uint8Array(g.slice(b+2,b+2+d));i.push([f,e])}}let j=a=>{let b=new Uint8Array,c=8*a.byteLength;for(let d=0;d<c;){let e=Number(F(a,d)),[f,k,l]=g[e>>>24];if(!f){for(;e>>>32-k<h[k][0];)k+=1;l=h[k][1]}if((d+=k)>c)break;let m=l-(e>>>32-k),[n,o]=i[m];o||(n=j(n),i[m]=[n,!0]),b=t(b,n)}return b};return j},H=async(a,b)=>{let c=await b(a),d=y(k,c);if("INDX"!==d.magic)throw Error("Invalid INDX record");let e=z(d.encoding),f=c.slice(d.length),g=y(l,f);if("TAGX"!==g.magic)throw Error("Invalid TAGX section");let h=Array.from({length:(g.length-12)/4},(a,b)=>new Uint8Array(f.slice(12+4*b,12+4*b+4))),i={},j=0;for(let c=0;c<d.numCncx;c++){let f=await b(a+d.numRecords+c+1),g=new Uint8Array(f);for(let a=0;a<g.byteLength;){let b=a,{value:c,length:d}=A(g,a);a+=d;let h=f.slice(a,a+c);a+=c,i[j+b]=e.decode(h)}j+=65536}let m=[];for(let c=0;c<d.numRecords;c++){let d=await b(a+1+c),e=new Uint8Array(d),f=y(k,d);if("INDX"!==f.magic)throw Error("Invalid INDX record");for(let a=0;a<f.numRecords;a++){let b=f.idxt+4+2*a,c=x(d.slice(b,b+2)),i=x(d.slice(c,c+1)),j=w(d.slice(c+1,c+1+i)),k=[],l=c+1+i,n=0,o=l+g.numControlBytes;for(let[a,b,c,f]of h){if(1&f){n++;continue}let g=l+n,h=x(d.slice(g,g+1))&c;if(h===c)if(C(c)>1){let{value:c,length:d}=A(e,o);k.push([a,null,c,b]),o+=d}else k.push([a,1,null,b]);else k.push([a,h>>D(c),null,b])}let p={};for(let[a,b,c,d]of k){let f=[];if(null!=b)for(let a=0;a<b*d;a++){let{value:a,length:b}=A(e,o);f.push(a),o+=b}else{let a=0;for(;a<c;){let{value:b,length:c}=A(e,o);f.push(b),o+=c,a+=c}}p[a]=f}m.push({name:j,tagMap:p})}}return{table:m,cncx:i}},I=async(a,b)=>{let{table:c,cncx:d}=await H(a,b),e=c.map(({tagMap:a},b)=>({index:b,offset:a[1]?.[0],size:a[2]?.[0],label:d[a[3]]??"",headingLevel:a[4]?.[0],pos:a[6],parent:a[21]?.[0],firstChild:a[22]?.[0],lastChild:a[23]?.[0]})),f=a=>(null==a.firstChild||(a.children=e.filter(b=>b.parent===a.index).map(f)),a);return e.filter(a=>0===a.headingLevel).map(f)},J=async(a,b)=>{let{flags:c,dataStart:d,keyLength:e,keyStart:f}=y(p,a),g=new Uint8Array(a.slice(d));if(2&c){let b=new Uint8Array(a.slice(f,f+e)),c=Math.min(16===e?1024:1040,g.length);for(var h=0;h<c;h++)g[h]=g[h]^b[h%b.length]}if(1&c)try{return await b(g)}catch(a){console.warn(a),console.warn("Failed to decompress font")}return g},K=async a=>"BOOKMOBI"===w(await a.slice(60,68).arrayBuffer());class L{#a;#b;pdb;async open(a){this.#a=a;let b=y(f,await a.slice(0,78).arrayBuffer());this.pdb=b;let c=await a.slice(78,78+8*b.numRecords).arrayBuffer();this.#b=Array.from({length:b.numRecords},(a,b)=>x(c.slice(8*b,8*b+4))).map((a,b,c)=>[a,c[b+1]])}loadRecord(a){let b=this.#b[a];if(!b)throw RangeError("Record index out of bounds");return this.#a.slice(...b).arrayBuffer()}async loadMagic(a){let b=this.#b[a][0];return w(await this.#a.slice(b,b+4).arrayBuffer())}}class M extends L{#c=0;#d;#e;#f;#g;#h;constructor({unzlib:a}){super(),this.unzlib=a}async open(a){await super.open(a),this.headers=this.#i(await super.loadRecord(0)),this.#d=this.headers.mobi.resourceStart;let b=this.headers.mobi.version>=8;if(!b){let a=this.headers.exth?.boundary;if(a<0xffffffff)try{this.headers=this.#i(await super.loadRecord(a)),this.#c=a,b=!0}catch(a){console.warn(a),console.warn("Failed to open KF8; falling back to MOBI")}}return await this.#j(),b?new X(this).init():new P(this).init()}#i(a){let b=y(g,a),c=y(h,a);if("MOBI"!==c.magic)throw Error("Missing MOBI header");let{titleOffset:d,titleLength:e,localeLanguage:f,localeRegion:k}=c;c.title=a.slice(d,d+e);let l=s[f];c.language=l?.[k>>2]??l?.[0];let m=64&c.exthFlag?((a,b)=>{let{magic:c,count:d}=y(j,a);if("EXTH"!==c)throw Error("Invalid EXTH header");let e=z(b),f={},g=12;for(let b=0;b<d;b++){let b=x(a.slice(g,g+4)),c=x(a.slice(g+4,g+8));if(b in r){let[d,h,i]=r[b],j=a.slice(g+8,g+c),k="uint"===h?x(j):e.decode(j);i?(f[d]??=[],f[d].push(k)):f[d]=k}g+=c}return f})(a.slice(c.length+16),c.encoding):null,n=c.version>=8?y(i,a):null;return{palmdoc:b,mobi:c,exth:m,kf8:n}}async #j(){let{palmdoc:a,mobi:b}=this.headers;this.#e=z(b.encoding),this.#f=new TextEncoder;let{compression:c}=a;if(this.#g=1===c?a=>a:2===c?E:17480===c?await G(b,this.loadRecord.bind(this)):null,!this.#g)throw Error("Unknown compression type");let{trailingFlags:d}=b,e=1&d,f=C(d>>>1);this.#h=a=>{for(let b=0;b<f;b++){let b=B(a);a=a.subarray(0,-b)}if(e){let b=(3&a[a.length-1])+1;a=a.subarray(0,-b)}return a}}decode(...a){return this.#e.decode(...a)}encode(...a){return this.#f.encode(...a)}loadRecord(a){return super.loadRecord(this.#c+a)}loadMagic(a){return super.loadMagic(this.#c+a)}loadText(a){return this.loadRecord(a+1).then(a=>new Uint8Array(a)).then(this.#h).then(this.#g)}async loadResource(a){let b=await super.loadRecord(this.#d+a),c=w(b.slice(0,4));return"FONT"===c?J(b,this.unzlib):"VIDE"===c||"AUDI"===c?b.slice(12):b}getNCX(){let a=this.headers.mobi.indx;if(a<0xffffffff)return I(a,this.loadRecord.bind(this))}getMetadata(){let{mobi:a,exth:c}=this.headers;return{identifier:a.uid.toString(),title:b(c?.title||this.decode(a.title)),author:c?.creator?.map(b),publisher:b(c?.publisher),language:c?.language??a.language,published:c?.date,description:b(c?.description),subject:c?.subject?.map(b),rights:b(c?.rights),contributor:c?.contributor}}async getCover(){let{exth:a}=this.headers,b=a?.coverOffset<0xffffffff?a?.coverOffset:a?.thumbnailOffset<0xffffffff?a?.thumbnailOffset:null;if(null!=b)return new Blob([await this.loadResource(b)])}}let N=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,O=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi;class P{parser=new DOMParser;serializer=new XMLSerializer;#k=new Map;#l=new Map;#m=new Map;#n;#o=[];#p=d;constructor(a){this.mobi=a}async init(){let a=[];for(let b=0;b<this.mobi.headers.palmdoc.numTextRecords;b++){let c=await this.mobi.loadText(b);a.push(c)}let b=new Uint8Array(a.reduce((a,b)=>a+b.byteLength,0));a.reduce((a,c)=>(b.set(new Uint8Array(c),a),a+c.byteLength),0);let c=function(a){let b="";for(let c=0;c<a.length;c+=32768)b+=String.fromCharCode.apply(null,a.subarray(c,c+32768));return b}(b);this.#n=[0].concat(Array.from(c.matchAll(N),a=>a.index)).map((a,c,d)=>{let e=d[c+1]??b.length;return{book:this,raw:b.subarray(a,e)}}).map((a,b,c)=>(a.start=c[b-1]?.end??0,a.end=a.start+a.raw.byteLength,a)),this.sections=this.#n.map((a,b)=>({id:b,load:()=>this.loadSection(a),createDocument:()=>this.createDocument(a),size:a.end-a.start}));try{this.landmarks=await this.getGuide();let a=this.landmarks.find(({type:a})=>a?.includes("toc"))?.href;if(a){let b,{index:c}=this.resolveHref(a),d=await this.sections[c].createDocument(),e=0,f=0,g=new Map,h=new Map;this.toc=Array.from(d.querySelectorAll("a[filepos]")).reduce((a,c)=>{let d=(a=>{let b=0;for(;a;){let c=a.parentElement;if(c){let a=c.tagName.toLowerCase();"p"===a?b+=1.5:"blockquote"===a&&(b+=2)}a=c}return b})(c),i={label:c.innerText?.trim()??"",href:`filepos:${c.getAttribute("filepos")}`},j=d>f?e+1:d===f?e:g.get(d)??Math.max(0,e-1);if(j>e)b?(b.subitems??=[],b.subitems.push(i),h.set(j,b)):a.push(i);else{let b=h.get(j);b?b.subitems.push(i):a.push(i)}return b=i,e=j,f=d,g.set(d,j),a},[])}}catch(a){console.warn(a)}return this.#o=[...new Set(Array.from(c.matchAll(O),a=>a[1]))].map(a=>({filepos:a,number:Number(a)})).sort((a,b)=>a.number-b.number),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){return Array.from((await this.createDocument(this.#n[0])).getElementsByTagName("reference"),a=>({label:a.getAttribute("title"),type:a.getAttribute("type")?.split(/\s/),href:`filepos:${a.getAttribute("filepos")}`}))}async loadResource(a){if(this.#k.has(a))return this.#k.get(a);let b=await this.mobi.loadResource(a),c=URL.createObjectURL(new Blob([b]));return this.#k.set(a,c),c}async loadRecindex(a){return this.loadResource(Number(a)-1)}async replaceResources(a){for(let b of a.querySelectorAll("img[recindex]")){let a=b.getAttribute("recindex");try{b.src=await this.loadRecindex(a)}catch{console.warn(`Failed to load image ${a}`)}}for(let b of a.querySelectorAll("[mediarecindex]")){let a=b.getAttribute("mediarecindex"),c=b.getAttribute("recindex");try{b.src=await this.loadRecindex(a),c&&(b.poster=await this.loadRecindex(c))}catch{console.warn(`Failed to load media ${a}`)}}for(let b of a.querySelectorAll("[filepos]")){let a=b.getAttribute("filepos");b.href=`filepos:${a}`}}async loadText(a){if(this.#l.has(a))return this.#l.get(a);let{raw:b}=a,c=this.#o.filter(({number:b})=>b>=a.start&&b<a.end).map(b=>({...b,offset:b.number-a.start})),d=b;c.length&&(d=b.subarray(0,c[0].offset),c.forEach(({filepos:a,offset:e},f)=>{let g=c[f+1],h=this.mobi.encode(`<a id="filepos${a}"></a>`);d=u(d,h,b.subarray(e,g?.offset))}));let e=this.mobi.decode(d).replaceAll(N,"");return this.#l.set(a,e),e}async createDocument(a){let b=await this.loadText(a);return this.parser.parseFromString(b,this.#p)}async loadSection(a){if(this.#m.has(a))return this.#m.get(a);let b=await this.createDocument(a),c=b.createElement("style");b.head.append(c),c.append(b.createTextNode(`blockquote {
            margin-block-start: 0;
            margin-block-end: 0;
            margin-inline-start: 1em;
            margin-inline-end: 0;
        }`)),await this.replaceResources(b);let d=this.serializer.serializeToString(b),e=URL.createObjectURL(new Blob([d],{type:this.#p}));return this.#m.set(a,e),e}resolveHref(a){let b=a.match(/filepos:(.*)/)[1],c=Number(b);return{index:this.#n.findIndex(a=>a.end>c),anchor:a=>a.getElementById(`filepos${b}`)}}splitTOCHref(a){let b=a.match(/filepos:(.*)/)[1],c=Number(b);return[this.#n.findIndex(a=>a.end>c),`filepos${b}`]}getTOCFragment(a,b){return a.getElementById(b)}isExternal(a){return/^(?!blob|filepos)\w+:/i.test(a)}destroy(){for(let a of this.#k.values())URL.revokeObjectURL(a);for(let a of this.#m.values())URL.revokeObjectURL(a)}}let Q=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,R=/kindle:pos:fid:(\w+):off:(\w+)/,S=a=>{let[b,c]=a.match(R).slice(1);return{fid:parseInt(b,32),off:parseInt(c,32)}},T=(a=0,b=0)=>`kindle:pos:fid:${a.toString(32).toUpperCase().padStart(4,"0")}:off:${b.toString(32).toUpperCase().padStart(10,"0")}`,U=a=>{let b=a.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!b)return;let[,c,d]=b;return`[${c}="${CSS.escape(d)}"]`},V=async(a,b,c)=>{let d=[];a.replace(b,(...a)=>(d.push(a),null));let e=[];for(let a of d)e.push(await c(...a));return a.replace(b,()=>e.shift())},W=a=>{for(let b of a){if("page-spread-left"===b||"rendition:page-spread-left"===b)return"left";if("page-spread-right"===b||"rendition:page-spread-right"===b)return"right";if("rendition:page-spread-center"===b)return"center"}};class X{parser=new DOMParser;serializer=new XMLSerializer;transformTarget=new EventTarget;#m=new Map;#q=new Map;#r=new Map;#s={};#n;#t;#u=new Uint8Array;#v=new Uint8Array;#w=-1;#x=-1;#p=c;#y=new Map;constructor(a){this.mobi=a}async init(){let a=this.mobi.loadRecord.bind(this.mobi),{kf8:c}=this.mobi.headers;try{let b=await a(c.fdst),d=y(o,b);if("FDST"!==d.magic)throw Error("Missing FDST record");let e=Array.from({length:d.numEntries},(a,b)=>12+8*b).map(a=>[x(b.slice(a,a+4)),x(b.slice(a+4,a+8))]);this.#s.fdstTable=e,this.#t=e[e.length-1][1]}catch{}let d=(await H(c.skel,a)).table.map(({name:a,tagMap:b},c)=>({index:c,name:a,numFrag:b[1][0],offset:b[6][0],length:b[6][1]})),e=await H(c.frag,a),f=e.table.map(({name:a,tagMap:b})=>({insertOffset:parseInt(a),selector:e.cncx[b[2][0]],index:b[4][0],offset:b[6][0],length:b[6][1]}));this.#s.skelTable=d,this.#s.fragTable=f,this.#n=d.reduce((a,b)=>{let c=a[a.length-1],d=c?.fragEnd??0,e=d+b.numFrag,g=f.slice(d,e),h=b.length+g.map(a=>a.length).reduce((a,b)=>a+b,0),i=(c?.totalLength??0)+h;return a.concat({skel:b,frags:g,fragEnd:e,length:h,totalLength:i})},[]);let g=await this.getResourcesByMagic(["RESC","PAGE"]),h=new Map;if(g.RESC){let a=await this.mobi.loadRecord(g.RESC),b=this.mobi.decode(a.slice(16)).replace(/\0/g,""),c=b.search(/\?>/),d=`<package>${b.slice(c)}</package>`;for(let a of this.parser.parseFromString(d,"application/xml").querySelectorAll("spine > itemref")){let b=parseInt(a.getAttribute("skelid"));h.set(b,W(a.getAttribute("properties")?.split(" ")??[]))}}this.sections=this.#n.map((a,b)=>a.frags.length?{id:b,load:()=>this.loadSection(a),createDocument:()=>this.createDocument(a),size:a.length,pageSpread:h.get(b)}:{linear:"no"});try{let a=await this.mobi.getNCX(),c=({label:a,pos:d,children:e})=>{let[f,g]=d,h=T(f,g),i=this.#q.get(f);return i?i.push(g):this.#q.set(f,[g]),{label:b(a),href:h,subitems:e?.map(c)}};this.toc=a?.map(c),this.landmarks=await this.getGuide()}catch(a){console.warn(a)}let{exth:i}=this.mobi.headers;return this.dir=i.pageProgressionDirection,this.rendition={layout:"true"===i.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(i.originalResolution?.split("x")?.slice(0,2)?.map((a,b)=>[b?"height":"width",a])??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(a){let b={},c=this.mobi.headers.kf8.resourceStart,d=this.mobi.pdb.numRecords;for(let e=c;e<d;e++)try{let c=await this.mobi.loadMagic(e),d=a.find(a=>a===c);d&&(b[d]=e)}catch{}return b}async getGuide(){let a=this.mobi.headers.kf8.guide;if(a<0xffffffff){let b=this.mobi.loadRecord.bind(this.mobi),{table:c,cncx:d}=await H(a,b);return c.map(({name:a,tagMap:b})=>({label:d[b[1][0]]??"",type:a?.split(/\s/),href:T(b[6]?.[0]??b[3]?.[0])}))}}async loadResourceBlob(a){let{resourceType:b,id:f,type:g}=(a=>{let[b,c,d]=a.match(Q).slice(1);return{resourceType:b,id:parseInt(c,32),type:d}})(a),h="flow"===b?await this.loadFlow(f):await this.mobi.loadResource(f-1),i=new CustomEvent("data",{detail:{data:[c,d,"text/css",e].includes(g)?await this.replaceResources(this.mobi.decode(h)):h,type:g}});this.transformTarget.dispatchEvent(i);let j=await i.detail.data,k=await i.detail.type,l=k===e?this.parser.parseFromString(j,k):null;return[new Blob([j],{newType:k}),l?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")?.length?l.documentElement:null]}async loadResource(a){if(this.#m.has(a))return this.#m.get(a);let[b,c]=await this.loadResourceBlob(a),d=c?a:URL.createObjectURL(b);return c&&this.#y.set(d,c),this.#m.set(a,d),d}replaceResources(a){return V(a,RegExp(Q,"g"),this.loadResource.bind(this))}async loadRaw(a,b){let c=b-this.#u.length,d=null==this.#t?1/0:this.#t-this.#v.length-a;if(c<0||c<d){for(;this.#u.length<b;){let a=++this.#w,b=await this.mobi.loadText(a);this.#u=t(this.#u,b)}return this.#u.slice(a,b)}for(;this.#t-this.#v.length>a;){let a=this.mobi.headers.palmdoc.numTextRecords-1-++this.#x,b=await this.mobi.loadText(a);this.#v=t(b,this.#v)}let e=this.#t-this.#v.length;return this.#v.slice(a-e,b-e)}loadFlow(a){if(a<0xffffffff)return this.loadRaw(...this.#s.fdstTable[a])}async loadText(a){let{skel:b,frags:c,length:d}=a,e=await this.loadRaw(b.offset,b.offset+d),f=e.slice(0,b.length);for(let a of c){let c=a.insertOffset-b.offset,d=b.length+a.offset,g=e.slice(d,d+a.length);f=u(f.slice(0,c),g,f.slice(c));let h=this.#q.get(a.index);if(h)for(let b of h){let c=U(this.mobi.decode(g.slice(b)));this.#z(a.index,b,c)}}return this.mobi.decode(f)}async createDocument(a){let b=await this.loadText(a);return this.parser.parseFromString(b,this.#p)}async loadSection(a){if(this.#m.has(a))return this.#m.get(a);let b=await this.loadText(a),c=await this.replaceResources(b),e=this.parser.parseFromString(c,this.#p);for(let[a,b]of((e.querySelector("parsererror")||!e.documentElement?.namespaceURI)&&(this.#p=d,e=this.parser.parseFromString(c,this.#p)),this.#y))for(let c of e.querySelectorAll(`img[src="${a}"]`))c.replaceWith(b);let f=URL.createObjectURL(new Blob([this.serializer.serializeToString(e)],{type:this.#p}));return this.#m.set(a,f),f}getIndexByFID(a){return this.#n.findIndex(b=>b.frags.some(b=>b.index===a))}#z(a,b,c){let d=this.#r.get(a);if(d)d.set(b,c);else{let d=new Map;this.#r.set(a,d),d.set(b,c)}}async resolveHref(a){let{fid:b,off:c}=S(a),d=this.getIndexByFID(b);if(d<0)return;let e=this.#r.get(b)?.get(c);if(e)return{index:d,anchor:a=>a.querySelector(e)};let{skel:f,frags:g}=this.#n[d],h=g.find(a=>a.index===b),i=f.offset+f.length+h.offset,j=await this.loadRaw(i,i+h.length),k=U(this.mobi.decode(j.slice(c)));return this.#z(b,c,k),{index:d,anchor:a=>a.querySelector(k)}}splitTOCHref(a){let b=S(a);return[this.getIndexByFID(b.fid),b]}getTOCFragment(a,{fid:b,off:c}){let d=this.#r.get(b)?.get(c);return a.querySelector(d)}isExternal(a){return/^(?!blob|kindle)\w+:/i.test(a)}destroy(){for(let a of this.#m.values())URL.revokeObjectURL(a)}}a.s(["MOBI",()=>M,"isMOBI",0,K])}];

//# sourceMappingURL=packages_foliate-js_mobi_a25e0f9e.js.map