module.exports=[927131,a=>{"use strict";var b=a.i(887287);let c=a=>a.map(a=>a.subitems?.length?[a,c(a.subitems)].flat():a).flat();class d{async init({toc:a,ids:b,splitHref:d,getFragment:e}){(a=>{let b=0,c=a=>{if(a.id=b++,a.subitems)for(let b of a.subitems)c(b)};for(let b of a)c(b)})(a);let f=c(a),g=new Map;for(let[a,b]of f.entries()){let[c,e]=await d(b?.href)??[],h={fragment:e,item:b};g.has(c)?g.get(c).items.push(h):g.set(c,{prev:f[a-1],items:[h]})}let h=new Map;for(let[a,c]of b.entries())g.has(c)?h.set(c,g.get(c)):h.set(c,h.get(b[a-1]));this.ids=b,this.map=h,this.getFragment=e}getProgress(a,b){if(!this.ids)return;let c=this.ids[a],d=this.map.get(c);if(!d)return null;let{prev:e,items:f}=d;if(!f)return e;if(!b||1===f.length&&!f[0].fragment)return f[0].item;let g=b.startContainer.getRootNode();for(let[a,{fragment:c}]of f.entries()){let d=this.getFragment(g,c);if(d&&b.comparePoint(d,0)>0)return f[a-1]?.item??e}return f[f.length-1].item}}class e{constructor(a,b,c){this.sizes=a.map(a=>"no"!=a.linear&&a.size>0?a.size:0),this.sizePerLoc=b,this.sizePerTimeUnit=c,this.sizeTotal=this.sizes.reduce((a,b)=>a+b,0),this.sectionFractions=this.#a()}#a(){let{sizeTotal:a}=this,b=[0],c=0;for(let d of this.sizes)b.push((c+=d)/a);return b}getProgress(a,b,c=0){let{sizes:d,sizePerLoc:e,sizePerTimeUnit:f,sizeTotal:g}=this,h=d[a]??0,i=d.slice(0,a).reduce((a,b)=>a+b,0)+b*h,j=i+c*h;return{fraction:j/g,section:{current:a,total:d.length},location:{current:Math.floor(i/e),next:Math.floor(j/e),total:Math.ceil(g/e)},time:{section:(1-b)*h/f,total:(g-i)/f}}}getSection(a){if(a<=0)return[0,0];if(a>=1)return[this.sizes.length-1,1];a+=Number.EPSILON;let{sizeTotal:b}=this,c=this.sectionFractions.findIndex(b=>b>a)-1;if(c<0)return[0,0];for(;!this.sizes[c];)c++;let d=(a-this.sectionFractions[c])/(this.sizes[c]/b);return[c,d]}}var f=a.i(640219);let g=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_CDATA_SECTION,h=a=>{if(1===a.nodeType){let b=a.tagName.toLowerCase();return"script"===b||"style"===b?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}return NodeFilter.FILTER_ACCEPT},i=function*(a,b,c){let d=a.commonAncestorContainer??a.body??a,e=document.createTreeWalker(d,g,{acceptNode:c||h}),f=(a.commonAncestorContainer?(a,b)=>{let c=[];for(let d=b.currentNode;d;d=b.nextNode()){let b=a.comparePoint(d,0);if(0===b)c.push(d);else if(b>0)break}return c}:(a,b)=>{let c=[];for(let a=b.nextNode();a;a=b.nextNode())c.push(a);return c})(a,e);for(let a of b(f.map(a=>a.nodeValue??""),(a,b,c,d)=>{let e=document.createRange();return e.setStart(f[a],b),e.setEnd(f[c],d),e}))yield a},j="foliate-search:",k="foliate-note:",l=async a=>{let b=new Uint8Array(await a.slice(0,4).arrayBuffer());return 80===b[0]&&75===b[1]&&3===b[2]&&4===b[3]},m=async a=>{let b=new Uint8Array(await a.slice(0,5).arrayBuffer());return 37===b[0]&&80===b[1]&&68===b[2]&&70===b[3]&&45===b[4]},n=async b=>{let{configure:c,ZipReader:d,BlobReader:e,TextWriter:f,BlobWriter:g}=await a.A(431726);c({useWebWorkers:!1});let h=new d(new e(b)),i=await h.getEntries(),j=new Map(i.map(a=>[a.filename,a])),k=a=>(b,...c)=>j.has(b)?a(j.get(b),...c):null,l=k(a=>a.getData(new f));return{entries:i,loadText:l,loadBlob:k((a,b)=>a.getData(new g(b))),getSize:a=>j.get(a)?.uncompressedSize??0}},o=async a=>a.isFile?a:(await Promise.all(Array.from(await new Promise((b,c)=>a.createReader().readEntries(a=>b(a),a=>c(a))),o))).flat(),p=async a=>{let b=await o(a),c=new Map((await Promise.all(b.map(a=>new Promise((b,c)=>a.file(c=>b([c,a.fullPath]),a=>c(a)))))).map(([b,c])=>[c.replace(a.fullPath+"/",""),b])),d=new TextDecoder;return{loadText:async a=>{let b;return(b=await (c.get(a)?.arrayBuffer()??null))?d.decode(b):null},loadBlob:a=>c.get(a),getSize:a=>c.get(a)?.size??0}};class q extends Error{}class r extends Error{}class s extends Error{}let t=async a=>{let b=await fetch(a);if(!b.ok)throw new q(`${b.status} ${b.statusText}`,{cause:b});return new File([await b.blob()],new URL(b.url).pathname)},u=async b=>{let c;if("string"==typeof b&&(b=await t(b)),b.isDirectory){let d=await p(b),{EPUB:e}=await a.A(6876);c=await new e(d).init()}else if(b.size)if(await l(b)){let d=await n(b);if((({name:a,type:b})=>"application/vnd.comicbook+zip"===b||a.endsWith(".cbz"))(b)){let{makeComicBook:e}=await a.A(702827);c=e(d,b)}else if((({name:a,type:b})=>"application/x-zip-compressed-fb2"===b||a.endsWith(".fb2.zip")||a.endsWith(".fbz"))(b)){let{makeFB2:b}=await a.A(224845),{entries:e}=d,f=e.find(a=>a.filename.endsWith(".fb2")),g=await d.loadBlob((f??e[0]).filename);c=await b(g)}else{let{EPUB:b}=await a.A(6876);c=await new b(d).init()}}else if(await m(b)){let{makePDF:d}=await a.A(848765);c=await d(b)}else{let{isMOBI:d,MOBI:e}=await a.A(732123);if(await d(b)){let d=await a.A(774348);c=await new e({unzlib:d.unzlibSync}).open(b)}else if((({name:a,type:b})=>"application/x-fictionbook+xml"===b||a.endsWith(".fb2"))(b)){let{makeFB2:d}=await a.A(224845);c=await d(b)}}else throw new r("File not found");if(!c)throw new s("File type not supported");return c};class v{#b;#c;#d;#e;constructor(a,b,c={}){this.#c=a,this.#d=b,this.#e=c,this.#e.hidden&&this.hide(),this.#c.addEventListener("mousemove",({screenX:a,screenY:c})=>{(a!==this.#e.x||c!==this.#e.y)&&(this.#e.x=a,this.#e.y=c,this.show(),this.#b&&clearTimeout(this.#b),b()&&(this.#b=setTimeout(this.hide.bind(this),1e3)))},!1)}cloneFor(a){return new v(a,this.#d,this.#e)}hide(){this.#c.style.cursor="none",this.#e.hidden=!0}show(){this.#c.style.removeProperty("cursor"),this.#e.hidden=!1}}class w extends EventTarget{#f=[];#g=-1;pushState(a){let b=this.#f[this.#g];b===a||b?.fraction&&b.fraction===a.fraction||(this.#f[++this.#g]=a,this.#f.length=this.#g+1,this.dispatchEvent(new Event("index-change")))}replaceState(a){let b=this.#g;this.#f[b]=a}back(){let a=this.#g;if(a<=0)return;let b={state:this.#f[a-1]};this.#g=a-1,this.dispatchEvent(new CustomEvent("popstate",{detail:b})),this.dispatchEvent(new Event("index-change"))}forward(){let a=this.#g;if(a>=this.#f.length-1)return;let b={state:this.#f[a+1]};this.#g=a+1,this.dispatchEvent(new CustomEvent("popstate",{detail:b})),this.dispatchEvent(new Event("index-change"))}get canGoBack(){return this.#g>0}get canGoForward(){return this.#g<this.#f.length-1}clear(){this.#f=[],this.#g=-1}}class x extends HTMLElement{#h=this.attachShadow({mode:"open"});#i;#j;#k;#l=new Map;#m=new v(this,()=>this.hasAttribute("autohide-cursor"));isFixedLayout=!1;lastLocation;history=new w;constructor(){super(),this.history.addEventListener("popstate",({detail:a})=>{let b=this.resolveNavigation(a.state);this.renderer.goTo(b)})}async open(b){if(("string"==typeof b||"function"==typeof b.arrayBuffer||b.isDirectory)&&(b=await u(b)),this.book=b,this.language=(a=>{if(!a)return{};try{let b=Intl.getCanonicalLocales(a)[0],c=new Intl.Locale(b),d=["zh","ja","kr"].includes(c.language),e=(c.getTextInfo?.()??c.textInfo)?.direction;return{canonical:b,locale:c,isCJK:d,direction:e}}catch(a){return console.warn(a),{}}})(b.metadata?.language),b.splitTOCHref&&b.getTOCFragment){let a=b.sections.map(a=>a.id);this.#i=new e(b.sections,1500,1600);let c=b.splitTOCHref.bind(b),f=b.getTOCFragment.bind(b);this.#j=new d,await this.#j.init({toc:b.toc??[],ids:a,splitHref:c,getFragment:f}),this.#k=new d,await this.#k.init({toc:b.pageList??[],ids:a,splitHref:c,getFragment:f})}if(this.isFixedLayout=this.book.rendition?.layout==="pre-paginated",this.isFixedLayout?(await a.A(945249),this.renderer=document.createElement("foliate-fxl")):(await a.A(885235),this.renderer=document.createElement("foliate-paginator")),this.renderer.setAttribute("exportparts","head,foot,filter,container"),this.renderer.addEventListener("load",a=>this.#n(a.detail)),this.renderer.addEventListener("relocate",a=>this.#o(a.detail)),this.renderer.addEventListener("create-overlayer",a=>a.detail.attach(this.#p(a.detail))),this.renderer.open(b),this.#h.append(this.renderer),b.sections.some(a=>a.mediaOverlay)){let a,c=b.media.activeClass,d=b.media.playbackActiveClass;this.mediaOverlay=b.getMediaOverlay(),this.mediaOverlay.addEventListener("highlight",b=>{let e=this.resolveNavigation(b.detail.text);this.renderer.goTo(e).then(()=>{let{doc:b}=this.renderer.getContents().find(a=>a.index=e.index),f=e.anchor(b);f.classList.add(c),d&&f.ownerDocument.documentElement.classList.add(d),a=new WeakRef(f)})}),this.mediaOverlay.addEventListener("unhighlight",()=>{let b=a?.deref();b&&(b.classList.remove(c),d&&b.ownerDocument.documentElement.classList.remove(d))})}}close(){this.renderer?.destroy(),this.renderer?.remove(),this.#i=null,this.#j=null,this.#k=null,this.#l=new Map,this.lastLocation=null,this.history.clear(),this.tts=null,this.mediaOverlay=null}goToTextStart(){return this.goTo(this.book.landmarks?.find(a=>a.type.includes("bodymatter")||a.type.includes("text"))?.href??this.book.sections.findIndex(a=>"no"!==a.linear))}async init({lastLocation:a,showTextStart:b}){let c=a?this.resolveNavigation(a):null;c?(await this.renderer.goTo(c),this.history.pushState(a)):b?await this.goToTextStart():(this.history.pushState(0),await this.next())}#q(a,b,c){return this.dispatchEvent(new CustomEvent(a,{detail:b,cancelable:c}))}#o({reason:a,range:b,index:c,fraction:d,size:e}){let f=this.#i?.getProgress(c,d,e)??{},g=this.#j?.getProgress(c,b),h=this.#k?.getProgress(c,b),i=this.getCFI(c,b);this.lastLocation={...f,tocItem:g,pageItem:h,cfi:i,range:b},("snap"===a||"page"===a||"scroll"===a)&&this.history.replaceState(i),this.#q("relocate",this.lastLocation)}#n({doc:a,index:b}){a.documentElement.lang||=this.language.canonical??"",this.language.isCJK||(a.documentElement.dir||=this.language.direction??""),this.#r(a,b),this.#m.cloneFor(a.documentElement),this.#q("load",{doc:a,index:b})}#r(a,b){let{book:c}=this,d=c.sections[b];a.addEventListener("click",a=>{let b=a.target.closest("a[href]");if(!b)return;a.preventDefault();let e=b.getAttribute("href"),f=d?.resolveHref?.(e)??e;if(c?.isExternal?.(f))Promise.resolve(this.#q("external-link",{a:b,href:f},!0)).then(a=>a?globalThis.open(f,"_blank"):null).catch(a=>console.error(a));else{let a=f;if(!c.resolveHref(f)){let b=e.indexOf("#");if(b>=0){let c=e.slice(b);a=d?.resolveHref?.(c)??f}}Promise.resolve(this.#q("link",{a:b,href:a},!0)).then(b=>b?this.goTo(a):null).catch(a=>console.error(a))}})}async addAnnotation(a,b){let{value:c}=a;if(c.startsWith(j)){let a=c.replace(j,""),{index:d,anchor:e}=await this.resolveNavigation(a),g=this.#s(d);if(g){let{overlayer:a,doc:d}=g;if(b)return void a.remove(c);let h=d?e(d):e;a.add(c,h,f.Overlayer.outline)}return}if(c.startsWith(k)){let d=c.replace(k,""),{index:e,anchor:f}=await this.resolveNavigation(d),g=this.#s(e);if(g){let{overlayer:d,doc:e}=g;if(b)return void d.remove(c);let h=e?f(e):f;this.#q("draw-annotation",{draw:(a,b)=>d.add(c,h,a,b),annotation:a,doc:e,range:h})}return}let{index:d,anchor:e}=await this.resolveNavigation(c),g=this.#s(d);if(g){let{overlayer:d,doc:f}=g;if(d.remove(c),!b){let b=f?e(f):e;this.#q("draw-annotation",{draw:(a,e)=>d.add(c,b,a,e),annotation:a,doc:f,range:b})}}let h=this.#j.getProgress(d)?.label??"";return{index:d,label:h}}deleteAnnotation(a){return this.addAnnotation(a,!0)}#s(a){return this.renderer.getContents().find(b=>b.index===a&&b.overlayer)}#p({doc:a,index:b}){let c=new f.Overlayer(a);a.addEventListener("click",a=>{let[d,e,f]=c.hitTest(a);d&&!d.startsWith(j)&&this.#q("show-annotation",{value:d,index:b,range:e,rect:f})},!1);let d=0,e=/Android/i.test(navigator.userAgent);a.addEventListener("mousemove",b=>{if(e)return;let f=performance.now();if(f-d<200)return;d=f;let[g]=c.hitTest(b);g&&!g.startsWith(j)?a.body.style.cursor="pointer":a.body.style.cursor=""});let g=this.#l.get(b);if(g)for(let a of g)this.addAnnotation(a);return this.#q("create-overlay",{index:b}),c}async showAnnotation(a){let{value:b}=a,c=await this.goTo(b);if(c){let{index:a,anchor:d}=c,{doc:e}=this.#s(a),f=d(e);this.#q("show-annotation",{value:b,index:a,range:f})}}getCFI(a,c){let d=this.book.sections[a].cfi??b.fake.fromIndex(a);return c?b.joinIndir(d,b.fromRange(c)):d}resolveCFI(a){if(this.book.resolveCFI)return this.book.resolveCFI(a);{let c=b.parse(a);return{index:b.fake.toIndex((c.parent??c).shift()),anchor:a=>b.toRange(a,c)}}}resolveNavigation(a){try{if("number"==typeof a)return{index:a};if("number"==typeof a.fraction){let[b,c]=this.#i.getSection(a.fraction);return{index:b,anchor:c}}if(b.isCFI.test(a))return this.resolveCFI(a);return this.book.resolveHref(a)}catch(b){console.error(b),console.error(`Could not resolve target ${a}`)}}async goTo(a){let b=this.resolveNavigation(a);try{return await this.renderer.goTo(b),this.history.pushState(a),b}catch(b){console.error(b),console.error(`Could not go to ${a}`)}}async goToFraction(a){let[b,c]=this.#i.getSection(a);await this.renderer.goTo({index:b,anchor:c}),this.history.pushState({fraction:a})}async select(a){try{let b=await this.resolveNavigation(a);await this.renderer.goTo({...b,select:!0}),this.history.pushState(a)}catch(b){console.error(b),console.error(`Could not go to ${a}`)}}deselect(){for(let{doc:a}of this.renderer.getContents())a.defaultView.getSelection().removeAllRanges()}getSectionFractions(){return(this.#i?.sectionFractions??[]).map(a=>a+Number.EPSILON)}getProgressOf(a,b){return{tocItem:this.#j?.getProgress(a,b),pageItem:this.#k?.getProgress(a,b)}}async getTOCItemOf(a){try{let{index:b,anchor:c}=await this.resolveNavigation(a),d=await this.book.sections[b].createDocument(),e=c(d),f=e instanceof Range,g=f?e:d.createRange();return f||g.selectNodeContents(e),this.#j.getProgress(b,g)}catch(b){console.error(b),console.error(`Could not get ${a}`)}}async prev(a){await this.renderer.prev(a)}async next(a){await this.renderer.next(a)}async pan(a,b){await this.renderer.pan(a,b)}isOverflowX(){return this.renderer.isOverflowX}isOverflowY(){return this.renderer.isOverflowY}goLeft(){return"rtl"===this.book.dir?this.next():this.prev()}goRight(){return"rtl"===this.book.dir?this.prev():this.next()}async *#t(a,b,c){for(let{range:d,excerpt:e}of a(await this.book.sections[c].createDocument(),b))yield{cfi:this.getCFI(c,d),excerpt:e}}async *#u(a,b){let{sections:c}=this.book;for(let[d,{createDocument:e}]of c.entries()){if(!e)continue;let f=Array.from(a(await e(),b),({range:a,excerpt:b})=>({cfi:this.getCFI(d,a),excerpt:b})),g=(d+1)/c.length;yield{progress:g},f.length&&(yield{index:d,subitems:f})}}async *search(b){this.clearSearch();let{searchMatcher:c}=await a.A(275357),{sections:d}=this.book,{query:e,index:f,results:g}=b,h=c(i,{defaultLocale:this.language,...b}),k=g?.length?async function*(){for(let a of g)if(a.subitems){let b=(a.index+1)/d.length;yield{progress:b},yield{index:a.index,subitems:a.subitems}}else yield{cfi:a.cfi,excerpt:a.excerpt}}():null!=f?this.#t(h,e,f):this.#u(h,e),l=[];for await(let a of(this.#l.set(f,l),k))if(a.subitems){let b=a.subitems.map(({cfi:a})=>({value:j+a}));for(let c of(this.#l.set(a.index,b),b))this.addAnnotation(c);yield{index:a.index,label:this.#j.getProgress(a.index)?.label??"",subitems:a.subitems}}else{if(a.cfi){let b={value:j+a.cfi};l.push(b),this.addAnnotation(b)}yield a}yield"done"}clearSearch(){for(let a of this.#l.values())for(let b of a)this.deleteAnnotation(b);this.#l.clear()}async initTTS(b="word",c,d){let e=this.renderer.getContents()[0].doc;if(this.tts&&this.tts.doc===e)return;let{TTS:f}=await a.A(307225);this.tts=new f(e,i,c,d||(a=>this.renderer.scrollToAnchor(a,!0)),b)}startMediaOverlay(){let{index:a}=this.renderer.getContents()[0];return this.mediaOverlay.start(a)}}customElements.define("foliate-view",x),a.s(["NotFoundError",()=>r,"ResponseError",()=>q,"UnsupportedTypeError",()=>s,"View",()=>x,"makeBook",0,u],927131)}];

//# sourceMappingURL=packages_foliate-js_view_ac735dd6.js.map