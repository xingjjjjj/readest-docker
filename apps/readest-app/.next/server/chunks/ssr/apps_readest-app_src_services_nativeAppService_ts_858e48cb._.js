module.exports=[523556,a=>{"use strict";var b=a.i(800676),c=a.i(461937),d=a.i(11491);async function e(a={}){return"object"==typeof a&&Object.freeze(a),await (0,d.invoke)("plugin:dialog|open",{options:a})}async function f(a={}){return"object"==typeof a&&Object.freeze(a),await (0,d.invoke)("plugin:dialog|save",{options:a})}var g=a.i(619974);async function h(a,b){await (0,d.invoke)("plugin:sharekit|share_file",{url:a,...b})}var i=a.i(73552),j=a.i(941287),k=a.i(41162),l=a.i(649661);let m=async(a,b,c)=>{let d=[];try{d=await a.readDirectory(b,"None")}catch{throw Error(`Dir ${b} failed to read.`)}for(let e=0;e<d.length;e++){let f=d[e],g=`${b}/${f.path}`,h=`${c}/${f.path}`;await a.copyFile(g,h,"None")}let e=await a.readDirectory(c,"None");for(let a of d)if(!e.find(b=>b.path===a.path&&b.size===a.size))throw Error(`File ${a.path} failed to copy.`)};var n=a.i(157849),o=a.i(657123);let p=null,q=()=>(null===p&&(p=(0,g.type)()),p),r=({customRootDir:a,isPortable:b,execDir:d}={})=>{let e=a?0:void 0,f=!!a,g=f?b=>()=>{let c=["Settings","Data","Books","Fonts","Images"].includes(b)?"":b;return c?`${a}/${c}`:a}:void 0,h=g?a=>async()=>g(a)():void 0;return(a,i)=>{let j=g?.(i),k=h?.(i);switch(i){case"Settings":return{baseDir:b?0:c.BaseDirectory.AppConfig,basePrefix:b&&d?async()=>d:c.appConfigDir,fp:b&&d?`${d}${a?`/${a}`:""}`:a,base:i};case"Cache":return{baseDir:c.BaseDirectory.AppCache,basePrefix:c.appCacheDir,fp:a,base:i};case"Log":return{baseDir:f?0:c.BaseDirectory.AppLog,basePrefix:k??c.appLogDir,fp:j?`${j()}${a?`/${a}`:""}`:a,base:i};case"Data":return{baseDir:e??c.BaseDirectory.AppData,basePrefix:k??c.appDataDir,fp:j?`${j()}/${o.DATA_SUBDIR}${a?`/${a}`:""}`:`${o.DATA_SUBDIR}${a?`/${a}`:""}`,base:i};case"Books":return{baseDir:e??c.BaseDirectory.AppData,basePrefix:k||c.appDataDir,fp:j?`${j()}/${o.LOCAL_BOOKS_SUBDIR}${a?`/${a}`:""}`:`${o.LOCAL_BOOKS_SUBDIR}${a?`/${a}`:""}`,base:i};case"Fonts":return{baseDir:e??c.BaseDirectory.AppData,basePrefix:k||c.appDataDir,fp:j?`${j()}/${o.LOCAL_FONTS_SUBDIR}${a?`/${a}`:""}`:`${o.LOCAL_FONTS_SUBDIR}${a?`/${a}`:""}`,base:i};case"Images":return{baseDir:e??c.BaseDirectory.AppData,basePrefix:k||c.appDataDir,fp:j?`${j()}/${o.LOCAL_IMAGES_SUBDIR}${a?`/${a}`:""}`:`${o.LOCAL_IMAGES_SUBDIR}${a?`/${a}`:""}`,base:i};case"None":return{baseDir:0,basePrefix:async()=>"",fp:a,base:i};default:return{baseDir:c.BaseDirectory.Temp,basePrefix:c.tempDir,fp:a,base:i}}}},s={resolvePath:r(),async getPrefix(a){let{basePrefix:b,fp:d,baseDir:e}=this.resolvePath("",a),f=await b();return f=f.replace(/\/+$/,""),d?0===e?d:await (0,c.join)(f,d):f},getURL:a=>(0,i.isValidURL)(a)?a:(0,d.convertFileSrc)(a),async getBlobURL(a,b){let c=await this.readFile(a,b,"binary");return URL.createObjectURL(new Blob([c]))},async getImageURL(a){return this.getURL(a)},async openFile(a,b,d){let{fp:e,baseDir:f}=this.resolvePath(a,b),g=d||(0,j.getFilename)(e);if((0,i.isValidURL)(a))return await new k.RemoteFile(a,g).open();if((0,i.isContentURI)(a)||(0,i.isFileURI)(a)&&"ios"===q()){if(g=await (0,c.basename)(a),a.includes("com.android.externalstorage"))return await new k.NativeFile(e,g,f||null).open();{let b=await this.getPrefix("Cache"),d=await (0,c.join)(b,decodeURIComponent(g)),e=await (0,l.copyURIToPath)({uri:a,dst:d});if(!e.success)throw console.error("Failed to open file:",e),Error("Failed to open file");return await new k.NativeFile(d,g,f||null).open()}}{if((0,i.isFileURI)(a)||"android"===q())return await new k.NativeFile(e,g,f||null).open();let d=await this.getPrefix(b),h=d?await (0,c.join)(d,a):a;return await new k.RemoteFile(this.getURL(h),g).open()}},async copyFile(a,d,e){try{await this.exists((0,j.getDirPath)(d),e)||await this.createDir((0,j.getDirPath)(d),e,!0)}catch(a){console.log("Failed to create directory for copying file:",a)}if((0,i.isContentURI)(a)){let b=await this.getPrefix(e);if(!b)throw Error("Invalid base directory");let f=await (0,l.copyURIToPath)({uri:a,dst:await (0,c.join)(b,d)});if(!f.success)throw console.error("Failed to copy file:",f),Error("Failed to copy file")}else{let{fp:c,baseDir:f}=this.resolvePath(d,e);await (0,b.copyFile)(a,c,f?{toPathBaseDir:f}:void 0)}},async readFile(a,c,d){let{fp:e,baseDir:f}=this.resolvePath(a,c);return"text"===d?(0,b.readTextFile)(e,f?{baseDir:f}:void 0):(await (0,b.readFile)(e,f?{baseDir:f}:void 0)).buffer},async writeFile(a,c,d){let{fp:e,baseDir:f}=this.resolvePath(a,c);return(await this.exists((0,j.getDirPath)(a),c)||await this.createDir((0,j.getDirPath)(a),c,!0),"string"==typeof d)?(0,b.writeTextFile)(e,d,f?{baseDir:f}:void 0):d instanceof File?await (0,b.writeFile)(e,d.stream(),{write:!0,create:!0,baseDir:f||void 0}):await (0,b.writeFile)(e,new Uint8Array(d),f?{baseDir:f}:void 0)},async removeFile(a,c){let{fp:d,baseDir:e}=this.resolvePath(a,c);await (0,b.remove)(d,e?{baseDir:e}:void 0)},async createDir(a,c,d=!1){let{fp:e,baseDir:f}=this.resolvePath(a,c);await (0,b.mkdir)(e,{baseDir:f||void 0,recursive:d})},async removeDir(a,c,d=!1){let{fp:e,baseDir:f}=this.resolvePath(a,c);await (0,b.remove)(e,{baseDir:f||void 0,recursive:d})},async readDir(a,e){let{fp:f,baseDir:g}=this.resolvePath(a,e);if(!g||0===g)try{return(await (0,d.invoke)("read_dir",{path:f,recursive:!0,extensions:["*"]})).map(a=>{var b;let c;return{path:(b=a.path,c=b,b.toLowerCase().startsWith(f.toLowerCase())&&(c=b.substring(f.length)),(c.startsWith("\\")||c.startsWith("/"))&&(c=c.substring(1)),c),size:a.size}})}catch(a){console.error("Rust read_dir failed, falling back to JS recursion",a)}let h=await (0,b.readDir)(f,g?{baseDir:g}:void 0),i=[],j=async(a,d,e,f)=>{for(let h of e)if(h.isDirectory){let e=await (0,c.join)(a,h.name),i=d?await (0,c.join)(d,h.name):h.name;try{let a=await (0,b.readDir)(e,g?{baseDir:g}:void 0);await j(e,i,a,f)}catch{console.warn(`Skipping unreadable dir: ${e}`)}}else{let e=await (0,c.join)(a,h.name),i=d?await (0,c.join)(d,h.name):h.name,j=g?{baseDir:g}:void 0,k=await (0,b.stat)(e,j).then(a=>a.size).catch(()=>0);f.push({path:i,size:k})}};return await j(f,"",h,i),i},async exists(a,c){let{fp:d,baseDir:e}=this.resolvePath(a,c);try{return await (0,b.exists)(d,e?{baseDir:e}:void 0)}catch{return!1}},async stats(a,c){let{fp:d,baseDir:e}=this.resolvePath(a,c);return await (0,b.stat)(d,e?{baseDir:e}:void 0)}},t=process.env.NEXT_PUBLIC_DIST_CHANNEL||"readest";class u extends n.BaseAppService{fs=s;appPlatform="tauri";isAppDataSandbox=!1;isMobile=!1;isAndroidApp=!1;isIOSApp=!1;isMacOSApp=!1;isLinuxApp=!1;isMobileApp=!1;isDesktopApp=!1;isEink=!!window.__READEST_IS_EINK;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir="appstore"!==t;canReadExternalDir="appstore"!==t&&"playstore"!==t;distChannel=t;execDir=void 0;async init(){let a=q();this.isAppDataSandbox=["android","ios"].includes(a),this.isMobile=["android","ios"].includes(a),this.isAndroidApp="android"===a,this.isIOSApp="ios"===a,this.isMacOSApp="macos"===a,this.isLinuxApp="linux"===a,this.isMobileApp=["android","ios"].includes(a),this.isDesktopApp=["macos","windows","linux"].includes(a),this.hasTrafficLight="macos"===a,this.hasWindow="ios"!==a&&"android"!==a,this.hasWindowBar="ios"!==a&&"android"!==a,this.hasContextMenu="ios"!==a&&"android"!==a,this.hasRoundedWindow="linux"===a,this.hasSafeAreaInset="ios"===a||"android"===a,this.hasHaptics="ios"===a||"android"===a,this.hasUpdater="ios"!==a&&!process.env.NEXT_PUBLIC_DISABLE_UPDATER&&!window.__READEST_UPDATER_DISABLED,this.hasOrientationLock="ios"===a&&"ios"===(0,i.getOSPlatform)()||"android"===a,this.hasScreenBrightness="ios"===a||"android"===a,this.hasIAP="ios"===a||"android"===a&&"playstore"===t;let b=await (0,d.invoke)("get_executable_dir");this.execDir=b,(process.env.NEXT_PUBLIC_PORTABLE_APP||await this.fs.exists(`${b}/${o.SETTINGS_FILENAME}`,"None"))&&(this.isPortableApp=!0,this.fs.resolvePath=r({customRootDir:b,isPortable:this.isPortableApp,execDir:b}));let c=await this.loadSettings();c.customRootDir&&(this.fs.resolvePath=r({customRootDir:c.customRootDir,isPortable:this.isPortableApp,execDir:b})),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let a=await this.loadSettings(),b=a.migrationVersion||0;if(await super.runMigrations(b),b<0x1350195)try{await this.migrate20251029()}catch(a){console.error("Error migrating to version 20251029:",a)}b<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...a,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(a){console.error("Failed to run migrations:",a)}}resolvePath(a,b){return this.fs.resolvePath(a,b)}async setCustomRootDir(a){this.fs.resolvePath=r({customRootDir:a,isPortable:this.isPortableApp,execDir:this.execDir}),await this.prepareBooksDir()}async selectDirectory(){return await e({directory:!0,multiple:!1,recursive:!0})}async selectFiles(a,b){let c=await e({multiple:!0,filters:[{name:a,extensions:b}]});return Array.isArray(c)?c:c?[c]:[]}async saveFile(a,c,d,e){try{let g=a.split(".").pop()||"";if(this.isIOSApp)await h(d,{mimeType:e||"application/octet-stream"});else{let d=await f({defaultPath:a,filters:[{name:g.toUpperCase(),extensions:[g]}]});if(!d)return!1;"string"==typeof c?await (0,b.writeTextFile)(d,c):await (0,b.writeFile)(d,new Uint8Array(c))}return!0}catch(a){return console.error("Failed to save file:",a),!1}}async migrate20251029(){console.log("Running migration 20251029 to update paths in Images dir...");let a=await this.resolveFilePath("..","Data"),b=await this.fs.getPrefix("Images"),d=await (0,c.join)(a,"Images","Readest","Images");await m(this,d,b);let e=await (0,c.join)(a,"Images","Readest");await this.deleteDir(e,"None",!0)}}a.s(["NativeAppService",()=>u,"nativeFileSystem",0,s],523556)}];

//# sourceMappingURL=apps_readest-app_src_services_nativeAppService_ts_858e48cb._.js.map