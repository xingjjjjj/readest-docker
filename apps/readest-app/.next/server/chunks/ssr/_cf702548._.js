module.exports=[943221,a=>{"use strict";a.i(138559);var b,c,d=a.i(177898);function e(a){return{isFile:a.isFile,isDirectory:a.isDirectory,isSymlink:a.isSymlink,size:a.size,mtime:null!==a.mtime?new Date(a.mtime):null,atime:null!==a.atime?new Date(a.atime):null,birthtime:null!==a.birthtime?new Date(a.birthtime):null,readonly:a.readonly,fileAttributes:a.fileAttributes,dev:a.dev,ino:a.ino,mode:a.mode,nlink:a.nlink,uid:a.uid,gid:a.gid,rdev:a.rdev,blksize:a.blksize,blocks:a.blocks}}(b=c||(c={}))[b.Start=0]="Start",b[b.Current=1]="Current",b[b.End=2]="End";class f extends d.Resource{async read(a){if(0===a.byteLength)return 0;let b=await (0,d.invoke)("plugin:fs|read",{rid:this.rid,len:a.byteLength}),c=function(a){let b=new Uint8ClampedArray(a),c=b.byteLength,d=0;for(let a=0;a<c;a++)d*=256,d+=b[a];return d}(b.slice(-8)),e=b instanceof ArrayBuffer?new Uint8Array(b):b;return a.set(e.slice(0,e.length-8)),0===c?null:c}async seek(a,b){return await (0,d.invoke)("plugin:fs|seek",{rid:this.rid,offset:a,whence:b})}async stat(){return e(await (0,d.invoke)("plugin:fs|fstat",{rid:this.rid}))}async truncate(a){await (0,d.invoke)("plugin:fs|ftruncate",{rid:this.rid,len:a})}async write(a){return await (0,d.invoke)("plugin:fs|write",{rid:this.rid,data:a})}}async function g(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");return new f(await (0,d.invoke)("plugin:fs|open",{path:a instanceof URL?a.toString():a,options:b}))}async function h(a,b,c){if(a instanceof URL&&"file:"!==a.protocol||b instanceof URL&&"file:"!==b.protocol)throw TypeError("Must be a file URL.");await (0,d.invoke)("plugin:fs|copy_file",{fromPath:a instanceof URL?a.toString():a,toPath:b instanceof URL?b.toString():b,options:c})}async function i(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");await (0,d.invoke)("plugin:fs|mkdir",{path:a instanceof URL?a.toString():a,options:b})}async function j(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");return await (0,d.invoke)("plugin:fs|read_dir",{path:a instanceof URL?a.toString():a,options:b})}async function k(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");let c=await (0,d.invoke)("plugin:fs|read_file",{path:a instanceof URL?a.toString():a,options:b});return c instanceof ArrayBuffer?new Uint8Array(c):Uint8Array.from(c)}async function l(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");let c=await (0,d.invoke)("plugin:fs|read_text_file",{path:a instanceof URL?a.toString():a,options:b}),e=c instanceof ArrayBuffer?c:Uint8Array.from(c);return new TextDecoder().decode(e)}async function m(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");await (0,d.invoke)("plugin:fs|remove",{path:a instanceof URL?a.toString():a,options:b})}async function n(a,b){return e(await (0,d.invoke)("plugin:fs|stat",{path:a instanceof URL?a.toString():a,options:b}))}async function o(a,b,c){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");if(b instanceof ReadableStream){let d=await g(a,{read:!1,create:!0,write:!0,...c}),e=b.getReader();try{for(;;){let{done:a,value:b}=await e.read();if(a)break;await d.write(b)}}finally{e.releaseLock(),await d.close()}}else await (0,d.invoke)("plugin:fs|write_file",b,{headers:{path:encodeURIComponent(a instanceof URL?a.toString():a),options:JSON.stringify(c)}})}async function p(a,b,c){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");let e=new TextEncoder;await (0,d.invoke)("plugin:fs|write_text_file",e.encode(b),{headers:{path:encodeURIComponent(a instanceof URL?a.toString():a),options:JSON.stringify(c)}})}async function q(a,b){if(a instanceof URL&&"file:"!==a.protocol)throw TypeError("Must be a file URL.");return await (0,d.invoke)("plugin:fs|exists",{path:a instanceof URL?a.toString():a,options:b})}d.Resource,a.s(["SeekMode",()=>c,"copyFile",()=>h,"exists",()=>q,"mkdir",()=>i,"open",()=>g,"readDir",()=>j,"readFile",()=>k,"readTextFile",()=>l,"remove",()=>m,"stat",()=>n,"writeFile",()=>o,"writeTextFile",()=>p])},750740,a=>{"use strict";var b=a.i(943221),c=a.i(465863);class d extends Blob{#a;#b;constructor(a,b){super(),this.#a=a,this.#b=b}async arrayBuffer(){return await this.#a}async text(){let a=await this.#a;return new TextDecoder().decode(a)}stream(){return new ReadableStream({start:async a=>{let b=await this.#a,c=new ReadableStream({start(a){a.enqueue(new Uint8Array(b)),a.close()}}).getReader(),d=()=>c.read().then(({done:b,value:c})=>b?(a.close(),Promise.resolve()):(a.enqueue(c),d()));return d()}})}get type(){return this.#b}}class e extends File{#c=null;#d;#e;#f;#g=0;#h=-1;#b="";static MAX_CACHE_CHUNK_SIZE=1048576;static MAX_CACHE_ITEMS_SIZE=50;#i=[];#j=new Map;#k=new Map;constructor(a,b,c=null,d=""){super([],b||a,{type:d}),this.#d=a,this.#f=c,this.#e=b||a}async open(){this.#c=await (0,b.open)(this.#d,this.#f?{baseDir:this.#f}:void 0);let a=await this.#c.stat();return this.#h=a.size,this.#g=a.mtime?a.mtime.getTime():Date.now(),this}async close(){this.#c&&(await this.#c.close(),this.#c=null),this.#j.clear(),this.#i=[]}get name(){return this.#e}get type(){return this.#b}get size(){return this.#h}get lastModified(){return this.#g}async stat(){return this.#c?.stat()}async seek(a,b){if(!this.#c)throw Error("File handle is not open");return this.#c.seek(a,b)}async readData(a,c){let d=(c=Math.max(a=Math.max(0,a),Math.min(this.size,c)))-a;if(d>e.MAX_CACHE_CHUNK_SIZE){let c=await (0,b.open)(this.#d,this.#f?{baseDir:this.#f}:void 0);try{await c.seek(a,b.SeekMode.Start);let e=new Uint8Array(d);return await c.read(e),e.buffer}finally{await c.close()}}let f=Array.from(this.#j.keys()).find(b=>{let d=this.#j.get(b);return a>=b&&c<=b+d.byteLength});if(void 0!==f){this.#l(f);let b=this.#j.get(f),c=a-f;return b.slice(c,c+d)}let g=`${a}-${c}`,h=this.#k.get(g);if(h)return h;let i=this.#m(a,d);this.#k.set(g,i);try{return await i}finally{this.#k.delete(g)}}async #m(a,c){let d=await (0,b.open)(this.#d,this.#f?{baseDir:this.#f}:void 0);try{let f=Math.max(0,a-1024),g=Math.min(this.size,a+e.MAX_CACHE_CHUNK_SIZE)-f;await d.seek(f,b.SeekMode.Start);let h=new Uint8Array(g);await d.read(h),this.#j.set(f,h.buffer),this.#l(f),this.#n();let i=a-f;return h.buffer.slice(i,i+c)}finally{await d.close()}}#l(a){let b=this.#i.indexOf(a);b>-1&&this.#i.splice(b,1),this.#i.unshift(a)}#n(){for(;this.#j.size>e.MAX_CACHE_ITEMS_SIZE;){let a=this.#i.pop();void 0!==a&&this.#j.delete(a)}}slice(a=0,b=this.size,c=this.type){return new d(this.readData(a,b),c)}stream(){let a=0;return new ReadableStream({pull:async c=>{if(!this.#c)return void c.error(Error("File handle is not open"));if(a>=this.size)return void c.close();let d=new Uint8Array(Math.min(a+1048576,this.size)-a);await this.#c.seek(a,b.SeekMode.Start);let e=await this.#c.read(d);null===e||0===e?c.close():(c.enqueue(d.subarray(0,e)),a+=e)},cancel:async()=>{await this.#c?.close()}})}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}class f extends File{url;#e;#g;#h=-1;#b="";#i=[];#j=new Map;#o=new Map;static MAX_CACHE_CHUNK_SIZE=131072;static MAX_CACHE_ITEMS_SIZE=128;constructor(a,b,c="",d=Date.now()){const e=a.split("/").pop()||"remote-file";super([],b||e,{type:c,lastModified:d}),this.url=a,this.#e=b||e,this.#b=c,this.#g=d}get name(){return this.#e}get type(){return this.#b}get size(){return this.#h}get lastModified(){return this.#g}async _open_with_head(){let a=await fetch(this.url,{method:"HEAD"});if(!a.ok)throw Error(`Failed to fetch file size: ${a.status}`);return this.#h=Number(a.headers.get("content-length")),this.#b=a.headers.get("content-type")||"",this}async _open_with_range(){let a=await fetch(this.url,{headers:{Range:"bytes=0-1023"}});if(!a.ok)throw Error(`Failed to fetch file size: ${a.status}`);return this.#h=Number(a.headers.get("content-range")?.split("/")[1]),this.#b=a.headers.get("content-type")||"",this}async open(){return"android"===(0,c.getOSPlatform)()?this._open_with_range():this._open_with_head()}async close(){this.#j.clear(),this.#i=[]}async fetchRangePart(a,b){a=Math.max(0,a),b=Math.min(this.size-1,b);let c=await fetch(this.url,{headers:{Range:`bytes=${a}-${b}`}});if(!c.ok)throw Error(`Failed to fetch range: ${c.status}`);return c.arrayBuffer()}async fetchRange(a,b){let c=b-a+1;if(c>1024e3){let c=[];for(let d=a;d<=b;d+=1024e3){let a=Math.min(d+1024e3-1,b);c.push(await this.fetchRangePart(d,a))}let d=new Uint8Array(c.reduce((a,b)=>a+b.byteLength,0)),e=0;for(let a of c)d.set(new Uint8Array(a),e),e+=a.byteLength;return d.buffer}{if(c>f.MAX_CACHE_CHUNK_SIZE)return this.fetchRangePart(a,b);let d=Array.from(this.#j.keys()).find(c=>{let d=this.#j.get(c).byteLength;return a>=c&&b<=c+d});if(void 0!==d){this.#l(d);let b=this.#j.get(d),e=a-d;return b.slice(e,e+c)}let e=`${a}-${b}`,g=this.#o.get(e);if(g)return g;let h=this.#p(a,b,c);this.#o.set(e,h);try{return await h}finally{this.#o.delete(e)}}}async #p(a,b,c){let d=Math.max(0,a-1024),e=Math.max(b,a+f.MAX_CACHE_CHUNK_SIZE-1024-1),g=await this.fetchRangePart(d,e);this.#j.set(d,g),this.#l(d),this.#n();let h=a-d;return g.slice(h,h+c)}#l(a){let b=this.#i.indexOf(a);b>-1&&this.#i.splice(b,1),this.#i.unshift(a)}#n(){for(;this.#j.size>f.MAX_CACHE_ITEMS_SIZE;){let a=this.#i.pop();void 0!==a&&this.#j.delete(a)}}slice(a=0,b=this.size,c=this.type){return new d(this.fetchRange(a,b-1),c)}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}a.s(["NativeFile",()=>e,"RemoteFile",()=>f])},355629,a=>{"use strict";let b="files",c=new class{db=null;initPromise=null;async init(){if(!this.db)return this.initPromise||(this.initPromise=new Promise((a,c)=>{let d=indexedDB.open("readest-cache",1);d.onerror=()=>{console.error("[IndexedDBCache] Failed to open database:",d.error),c(d.error)},d.onsuccess=()=>{this.db=d.result,console.log("[IndexedDBCache] ✓ Database opened successfully"),a()},d.onupgradeneeded=a=>{let c=a.target.result;c.objectStoreNames.contains(b)||(c.createObjectStore(b,{keyPath:"key"}).createIndex("expiresAt","expiresAt",{unique:!1}),console.log("[IndexedDBCache] ✓ Object store created"))}})),this.initPromise}async get(a){return(await this.init(),this.db)?new Promise((c,d)=>{let e=this.db.transaction(b,"readonly").objectStore(b).get(a);e.onerror=()=>d(e.error),e.onsuccess=()=>{let b=e.result;b&&b.expiresAt&&Date.now()>b.expiresAt?(console.log("[IndexedDBCache] Cache expired for:",a),this.delete(a).catch(a=>console.error("Failed to delete expired cache:",a)),c(null)):(b&&console.log("[IndexedDBCache] ✓ Cache hit for:",a),c(b||null))}}):null}async set(a,c,d,e){if(await this.init(),!this.db)return;let f={key:a,data:c,mimeType:d,etag:e?.etag,timestamp:Date.now(),expiresAt:e?.ttl?Date.now()+e.ttl:void 0};return new Promise((c,d)=>{let e=this.db.transaction(b,"readwrite").objectStore(b).put(f);e.onerror=()=>d(e.error),e.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache saved for:",a),c()}})}async delete(a){if(await this.init(),this.db)return new Promise((c,d)=>{let e=this.db.transaction(b,"readwrite").objectStore(b).delete(a);e.onerror=()=>d(e.error),e.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache deleted for:",a),c()}})}async clear(){if(await this.init(),this.db)return new Promise((a,c)=>{let d=this.db.transaction(b,"readwrite").objectStore(b).clear();d.onerror=()=>c(d.error),d.onsuccess=()=>{console.log("[IndexedDBCache] ✓ All caches cleared"),a()}})}async clearExpired(){return(await this.init(),this.db)?new Promise((a,c)=>{let d=this.db.transaction(b,"readwrite").objectStore(b),e=d.index("expiresAt"),f=IDBKeyRange.upperBound(Date.now()),g=e.openCursor(f),h=0;g.onerror=()=>c(g.error),g.onsuccess=b=>{let c=b.target.result;c?(console.log("[IndexedDBCache] Deleting expired cache:",c.key),d.delete(c.primaryKey),h++,c.continue()):(console.log("[IndexedDBCache] ✓ Cleared",h,"expired caches"),a(h))}}):0}async getStats(){return(await this.init(),this.db)?new Promise((a,c)=>{let d=this.db.transaction(b,"readonly").objectStore(b).getAll();d.onerror=()=>c(d.error),d.onsuccess=()=>{let b,c,e=d.result,f=0;e.forEach(a=>{f+=a.data.byteLength,(!b||a.timestamp<b.timestamp)&&(b={key:a.key,timestamp:a.timestamp}),(!c||a.timestamp>c.timestamp)&&(c={key:a.key,timestamp:a.timestamp})}),console.log("[IndexedDBCache] Stats:",{entries:e.length,size:(f/1024/1024).toFixed(2)+" MB"}),a({totalEntries:e.length,totalSize:f,oldestEntry:b,newestEntry:c})}}):{totalEntries:0,totalSize:0}}},d={cacheStrategy:"cache-first",cacheTTL:2592e6};async function e(a,b={}){let f={...d,...b},g=`file_${a}`;console.log(`[cachedFetch] Fetching: ${a}, strategy: ${f.cacheStrategy}`);try{if("cache-first"===f.cacheStrategy&&!f.bypassCache){let b=await c.get(g);if(b){console.log(`[cachedFetch] ✓ Using cached data for: ${a}`);let c=new Headers({"Content-Type":b.mimeType,"Content-Length":b.data.byteLength.toString(),...b.etag&&{ETag:b.etag}});return{data:b.data,headers:c,fromCache:!0}}}let b=new Headers(f.headers||{}),d=await fetch(a,{method:"GET",headers:b,signal:AbortSignal.timeout(3e4)});if(304===d.status){console.log(`[cachedFetch] 304 Not Modified for: ${a}`);let b=await c.get(g);if(b){let a=new Headers({"Content-Type":b.mimeType,"Content-Length":b.data.byteLength.toString(),ETag:d.headers.get("ETag")||b.etag||""});return{data:b.data,headers:a,fromCache:!0}}}if(!d.ok)throw Error(`HTTP ${d.status}: ${d.statusText}`);let e=parseInt(d.headers.get("Content-Length")||"0",10),h=d.body?.getReader(),i=[],j=0;if(h)for(;;){let{done:a,value:b}=await h.read();if(a)break;if(i.push(b),j+=b.length,e>0&&f.onProgress){let a=Math.round(j/e*100);f.onProgress(a)}}else i.push(new Uint8Array(await d.arrayBuffer()));let k=new ArrayBuffer(j),l=new Uint8Array(k),m=0;for(let a of i)l.set(a,m),m+=a.length;let n=d.headers.get("Content-Type")||"application/octet-stream",o=d.headers.get("ETag");return f.bypassCache||200!==d.status||c.set(g,k,n,{etag:o||void 0,ttl:f.cacheTTL}).catch(b=>{console.warn(`[cachedFetch] Failed to cache ${a}:`,b)}),console.log(`[cachedFetch] ✓ Fetched ${(k.byteLength/1024/1024).toFixed(2)} MB from network`),{data:k,headers:d.headers,fromCache:!1}}catch(d){console.warn(`[cachedFetch] Network error for ${a}:`,d);let b=await c.get(g);if(b){console.log(`[cachedFetch] ℹ Using stale cache due to network error: ${a}`);let c=new Headers({"Content-Type":b.mimeType,"Content-Length":b.data.byteLength.toString(),Warning:'199 - "Stale cache used due to network error"'});return{data:b.data,headers:c,fromCache:!0}}throw d}}async function f(a,b={}){let{data:c,headers:d}=await e(a,b),g=new Blob([c],{type:d.get("Content-Type")||"application/octet-stream"});return URL.createObjectURL(g)}a.s(["cachedFetchAsUrl",()=>f],355629)},599535,a=>a.a(async(b,c)=>{try{var d=a.i(907105),e=a.i(589911),f=a.i(890392),g=b([f]);[f]=g.then?(await g)():g;let h={lastAccessDate:new Date(0),lastModDate:new Date(0)},i=a=>a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"";class j{async convert(a){let{file:b,author:c,language:g}=a,h=await b.arrayBuffer(),i=this.detectEncoding(h)||"utf-8";console.log(`Detected encoding: ${i}`);let j=new TextDecoder(i).decode(h).trim(),k=this.extractBookTitle((0,e.getBaseFilename)(b.name)),l=`${k}.epub`,m=j.slice(0,1024),n=m.match(/[【\[]?作者[】\]]?[:：\s]\s*(.+)\r?\n/)||m.match(/[【\[]?\s*(.+)\s+著\s*[】\]]?\r?\n/),o=n?n[1].trim():c||"";try{o=o.replace(/^[\p{P}\p{S}]+|[\p{P}\p{S}]+$/gu,"")}catch{}let p=o||c||"",q=g||(0,f.detectLanguage)(m);console.log(`Detected language: ${q}`);let r=await (0,d.partialMD5)(b),s={bookTitle:k,author:p,language:q,identifier:r},t=[];for(let a=8;a>=6;a--){if(t=this.extractChapters(j,s,{linesBetweenSegments:a,fallbackParagraphsPerChapter:100}),0===t.length)throw Error("No chapters detected.");if(t.length>1)break}let u=await this.createEpub(t,s);return{file:new File([u],l),bookTitle:k,chapterCount:t.length,language:q}}extractChapters(a,b,c){let{language:d}=b,{linesBetweenSegments:e,fallbackParagraphsPerChapter:f}=c,g=RegExp(`(?:\\r?\\n){${e},}|-{8,}\r?
`),h=[];if("zh"===d)h.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`第[零〇一二三四五六七八九十0-9][零〇一二三四五六七八九十百千万0-9]*(?:[章卷节回讲篇封本册部话])(?:[：:、 　\(\)0-9]*[^\n-]{0,24})(?!\S)`,String.raw`(?:楔子|前言|简介|引言|序言|序章|总论|概论|后记)(?:[：: 　][^\n-]{0,24})?(?!\S)`,String.raw`chapter[\s.]*[0-9]+(?:[：:. 　]+[^\n-]{0,50})?(?!\S)`].join("|")+")","gui")),h.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`[一二三四五六七八九十][零〇一二三四五六七八九十百千万]?[：:、 　][^\n-]{0,24}(?=\n|$)`,String.raw`[0-9]+[^\n]{0,16}(?=\n|$)`].join("|")+")","gu"));else{let a=String.raw`(\d+|(?:[IVXLCDM]{2,}|V|X|L|C|D|M)\b)`,b=String.raw`\.\d{1,4}`,c=String.raw`[^\n]{0,50}`,d=["Chapter","Part","Section","Book","Volume","Act"].map(d=>String.raw`${d}\s*(?:${a}|${b})(?:[:.\-–—]?\s*${c})?`).join("|"),e=["Prologue","Epilogue","Introduction","Foreword","Preface","Afterword"].map(a=>String.raw`${a}(?:[:.\-–—]?\s*${c})?`).join("|"),f=String.raw`(?:^|\n|\s)(?:${d}|${e})(?=\s|$)`;h.push(RegExp(f,"gi"))}let j=a=>(a=i(a)).replace(/-{8,}|_{8,}/g,"\n").split(/\n+/).map(a=>a.trim()).filter(a=>a).join("</p><p>"),k=a=>a.reduce((a,b,c,d)=>(void 0===b&&c>0&&c<d.length-1&&void 0!==d[c-1]&&void 0!==d[c+1]?a[a.length-1]+=d[c+1]:void 0!==b&&(0===c||void 0!==d[c-1])&&a.push(b),a),[]),l=(a,b=1e5)=>{let c=a.filter(a=>a&&a.trim().length>0);return!(c.length<=1)&&!c.some(a=>a.length>b)},m=[];for(let b of a.split(g)){let a=b.replace(/<!--.*?-->/g,"").trim();if(!a)continue;let c=[],e=[];for(let b of h){let c=a.split(b);if(l(c)){e=k(c);break}}if(0===e.length&&f>0){let b=a.split(/\n+/),c=b.length;for(let a=0;a<c;a+=f){let c=b.slice(a,a+f),d=j(c.join("\n")),e=`${m.length+1}`,g=`<h2>${e}</h2><p>${d}</p>`;m.push({title:e,content:g,text:c.join("\n"),isVolume:!1})}continue}for(let a=1;a<e.length;a+=2){let b=e[a]?.trim()||"",f=e[a+1]?.trim()||"",g=!1,h=(g="zh"===d?/第[零〇一二三四五六七八九十百千万0-9]+(卷|本|册|部)/.test(b):/\b(Part|Volume|Book)\b/i.test(b))?`<h1>${b}</h1>`:`<h2>${b}</h2>`,k=j(f);c.push({title:i(b),content:`${h}<p>${k}</p>`,text:f,isVolume:g})}if(e[0]&&e[0].trim()){let a=e[0].trim(),b=a.split("\n")[0].trim(),d=(b.length>16?a.split(/[\n\s\p{P}]/u)[0].trim():b)||a.slice(0,16),f=j(a);c.unshift({title:i(d),content:`<h3></h3><p>${f}</p>`,text:a,isVolume:!1})}m.push(...c)}return m}async createEpub(b,c){let{BlobWriter:d,TextReader:e,ZipWriter:g}=await a.A(831930),{bookTitle:j,author:k,language:l,identifier:m}=c,n=new g(new d("application/epub+zip"),{extendedTimestamp:!1});await n.add("mimetype",new e("application/epub+zip"),h),await n.add("META-INF/container.xml",new e(`<?xml version="1.0" encoding="UTF-8"?>
    <container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
      <rootfiles>
        <rootfile full-path="content.opf" media-type="application/oebps-package+xml"/>
      </rootfiles>
    </container>`.trim()),h);let o=!1,p="";for(let a=0;a<b.length;a++){let c=`chapter${a+1}`,d=a+1;b[a].isVolume&&o&&(p+=`</navPoint>
`,o=!o),p+=`<navPoint id="navPoint-${c}" playOrder="${d}">
<navLabel><text>${b[a].title}</text></navLabel>
<content src="./OEBPS/${c}.xhtml" />
`,b[a].isVolume&&!o?o=!o:p+=`</navPoint>
`}o&&(p+="</navPoint>");let q=`<?xml version="1.0" encoding="UTF-8"?>
    <ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
      <head>
        <meta name="dtb:uid" content="book-id" />
        <meta name="dtb:depth" content="1" />
        <meta name="dtb:totalPageCount" content="0" />
        <meta name="dtb:maxPageNumber" content="0" />
      </head>
      <docTitle>
        <text>${i(j)}</text>
      </docTitle>
      <docAuthor>
        <text>${i(k)}</text>
      </docAuthor>
      <navMap>
        ${p}
      </navMap>
    </ncx>`.trim();await n.add("toc.ncx",new e(q),h);let r=b.map((a,b)=>`
      <item id="chap${b+1}" href="OEBPS/chapter${b+1}.xhtml" media-type="application/xhtml+xml"/>
    `).join("\n").trim(),s=b.map((a,b)=>`
      <itemref idref="chap${b+1}"/>`).join("\n").trim(),t=`
      body { line-height: 1.6; font-size: 1em; font-family: 'Arial', sans-serif; text-align: justify; }
      p { text-indent: 2em; margin: 0; }
    `;await n.add("style.css",new e(t),h);for(let a=0;a<b.length;a++){let c=b[a],d=(0,f.detectLanguage)(c.text),g=`<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" lang="${d}" xml:lang="${d}">
          <head>
            <title>${c.title}</title>
            <link rel="stylesheet" type="text/css" href="../style.css"/>
          </head>
          <body>${c.content}</body>
        </html>`.trim();await n.add(`OEBPS/chapter${a+1}.xhtml`,new e(g),h)}let u=`<?xml version="1.0" encoding="UTF-8"?>
      <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="book-id" version="2.0">
        <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
          <dc:title>${i(j)}</dc:title>
          <dc:language>${l}</dc:language>
          <dc:creator>${i(k)}</dc:creator>
          <dc:identifier id="book-id">${m}</dc:identifier>
        </metadata>
        <manifest>
          ${r}
          <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
          <item id="css" href="style.css" media-type="text/css"/>
        </manifest>
        <spine toc="ncx">
          ${s}
        </spine>
      </package>`.trim();return await n.add("content.opf",new e(u),h),await n.close()}detectEncoding(a){try{return new TextDecoder("utf-8",{fatal:!0}).decode(a),"utf-8"}catch{let b=new Uint8Array(a),c=0,d=0,e=Math.min(b.length,1e4);for(let a=0;a<e;a++)try{new TextDecoder("utf-8",{fatal:!0}).decode(b.slice(a,a+100)),c+=100,d+=100,a+=99}catch{d++}let f=c/d*100;if(console.log(`UTF-8 validity: ${f.toFixed(2)}%`),f>80)return console.log("Treating as UTF-8 despite some invalid sequences"),"utf-8"}let b=new Uint8Array(a.slice(0,4));if(255===b[0]&&254===b[1])return"utf-16le";if(254===b[0]&&255===b[1])return"utf-16be";if(239===b[0]&&187===b[1]&&191===b[2])return"utf-8";let c=new Uint8Array(a.slice(0,Math.min(1024,a.byteLength))),d=0;for(let a=0;a<c.length;a++)c[a]>=128&&d++;let e=d/c.length;if(e>.3)return"gbk";if(e>.1){let a=!1;for(let b=0;b<c.length-1;b++){let d=c[b],e=c[b+1];if((d>=129&&d<=159||d>=224&&d<=252)&&(e>=64&&e<=126||e>=128&&e<=252)){a=!0;break}}return a?"shift-jis":"gb18030"}return"utf-8"}extractBookTitle(a){let b=a.match(/《([^》]+)》/);return b?b[1]:a.split(".")[0]}}a.s(["TxtToEpubConverter",()=>j]),c()}catch(a){c(a)}},!1),987974,a=>{"use strict";a.s(["BOOK_FILE_NOT_FOUND_ERROR",0,"Book file not found"])},36873,a=>{"use strict";var b=a.i(465863);let c=new Set([1028,2052,3076,4100,19,33]);a.s(["parseFontInfo",0,(a,d)=>{let e=d.replace(/\.[^/.]+$/,"");try{var f,g,h,i;let d,e=new DataView(a),j=e.getUint32(0,!1);if(65536!==j&&0x74727565!==j&&0x4f54544f!==j)throw Error("Unsupported font format");let k=e.getUint16(4,!1),l=0,m=0,n=0;for(let a=0;a<k;a++){let b=12+16*a,c=String.fromCharCode(e.getUint8(b),e.getUint8(b+1),e.getUint8(b+2),e.getUint8(b+3));"name"===c?l=e.getUint32(b+8,!1):"OS/2"===c?m=e.getUint32(b+8,!1):"fvar"===c&&(n=e.getUint32(b+8,!1))}if(0===l)throw Error("Name table not found");let o=e.getUint16(l+2,!1),p=e.getUint16(l+4,!1),q=(0,b.getUserLang)(),r=[],s=[],t=[],u=[];for(let a=0;a<o;a++){let b=l+6+12*a,c=e.getUint16(b,!1),d=e.getUint16(b+4,!1),f=e.getUint16(b+6,!1),g=e.getUint16(b+8,!1),h=e.getUint16(b+10,!1);if(1===f||2===f||16===f||17===f){let a=l+p+h,b="";if(0===c||3===c?b=function(a,b,c){let d=[];for(let e=0;e<c;e+=2){let c=a.getUint16(b+e,!1);0!==c&&d.push(String.fromCharCode(c))}return d.join("")}(e,a,g):1===c&&(b=function(a,b,c){let d=[];for(let e=0;e<c;e++){let c=a.getUint8(b+e);d.push(String.fromCharCode(c))}return d.join("")}(e,a,g)),b&&b.trim()){let a=function(a,b,c){let d=0;0===a?d+=100:3===a?d+=90:1===a&&(d+=50);let e=c.toLowerCase();return 0===a||3===a?(e.startsWith("zh")?2052===b?d+=50:1028===b?d+=45:3076===b?d+=40:4100===b&&(d+=35):e.startsWith("ja")?1041===b&&(d+=50):e.startsWith("ko")?1042===b&&(d+=50):e.startsWith("en")&&(1033===b?d+=50:2057===b&&(d+=45)),1033===b&&(d+=10)):1===a&&(e.startsWith("zh")?33===b?d+=50:19===b&&(d+=45):e.startsWith("ja")?11===b&&(d+=50):e.startsWith("ko")?23===b&&(d+=50):e.startsWith("en")&&0===b&&(d+=50),0===b&&(d+=10)),d}(c,d,q),e={name:b.trim(),platformID:c,languageID:d,priority:a};1===f?r.push(e):2===f?s.push(e):16===f?t.push(e):17===f&&u.push(e)}}}if(0===r.length)throw Error("Font family name not found");r.sort((a,b)=>b.priority-a.priority),s.sort((a,b)=>b.priority-a.priority),t.sort((a,b)=>b.priority-a.priority),u.sort((a,b)=>b.priority-a.priority);let v=(t[0]||r[0]).name,w=u[0]||s[0],x=w?.name||"",y=400,z="normal",A=0;if(m>0)try{f=m,y=(g=e.getUint16(f+4,!1))>=1&&g<=100?100:g>=101&&g<=200?200:g>=201&&g<=300?300:g>=301&&g<=400?400:g>=401&&g<=500?500:g>=501&&g<=600?600:g>=601&&g<=700?700:g>=701&&g<=800?800:g>=801&&g<=900?900:400,h=m,A=e.getUint16(h+62,!1)}catch{console.warn("Failed to parse OS/2 table, falling back to style name analysis")}let B=!1;if(n>0){let a=function(a,b){try{let c=a.getUint16(b+4,!1),d=a.getUint16(b+6,!1),e=[],f=b+16;for(let b=0;b<c;b++){let b=String.fromCharCode(a.getUint8(f),a.getUint8(f+1),a.getUint8(f+2),a.getUint8(f+3)),c=a.getInt32(f+4,!1)/65536,g=a.getInt32(f+8,!1)/65536,h=a.getInt32(f+12,!1)/65536;e.push({tag:b,minValue:c,defaultValue:g,maxValue:h}),f+=d}return e}catch(a){return console.warn("Failed to parse fvar table:",a),[]}}(e,n);a&&a.length>0&&(B=!0)}if(400===y&&x){let a,b=(a=x.toLowerCase()).includes("thin")||a.includes("hairline")?100:a.includes("extralight")||a.includes("ultralight")?200:!a.includes("light")||a.includes("extralight")||a.includes("ultralight")?a.includes("medium")?500:a.includes("semibold")||a.includes("demibold")?600:a.includes("extrabold")||a.includes("ultrabold")?800:a.includes("black")||a.includes("heavy")?900:!a.includes("bold")||a.includes("semibold")||a.includes("extrabold")||a.includes("ultrabold")?400:700:300;400!==b&&(y=b)}return i=A,d=x.toLowerCase(),z=512&i?"oblique":1&i?"italic":d.includes("oblique")?"oblique":d.includes("italic")||d.includes("slant")?"italic":"normal",{name:w&&!c.has(w.languageID)?`${v} ${x}`:v,family:v,weight:y,style:z,variable:B}}catch(a){return console.warn(`Failed to parse font: ${a}`),{name:e,family:e,weight:400,style:"normal",variable:!1}}}])},23486,a=>{"use strict";function b(a){let b=parseFloat(a);if(!isNaN(b))return b}async function c(a,d=700,e=1050){let f=await a.text(),g=new DOMParser().parseFromString(f,"image/svg+xml").documentElement,h=g.getAttribute("width"),i=g.getAttribute("height");if(h&&i)return{width:b(h)||d,height:b(i)||e};let j=g.getAttribute("viewBox");if(j){let a=j.split(/\s+/).map(Number);if(4===a.length&&!a.some(isNaN)){let[,,b,c]=a;return{width:b||d,height:c||e}}}return{width:d,height:e}}async function d(a,b=.9){let e=await a.text(),f=URL.createObjectURL(new Blob([e],{type:"image/svg+xml"})),g=new Image;g.crossOrigin="anonymous",await new Promise((a,b)=>{g.onload=()=>a(),g.onerror=()=>b(Error("Failed to load SVG")),g.src=f}),await new Promise(a=>requestAnimationFrame(a)),await new Promise(a=>requestAnimationFrame(a));let h=document.createElement("canvas"),{width:i,height:j}=await c(a);return h.width=i,h.height=j,h.getContext("2d").drawImage(g,0,0),URL.revokeObjectURL(f),new Promise(a=>{h.toBlob(b=>a(b),"image/png",b)})}a.s(["svg2png",()=>d])},843660,a=>a.a(async(b,c)=>{try{var d=a.i(696351),e=a.i(679496),f=a.i(936114),g=a.i(907105),h=a.i(399577),i=a.i(589911),j=a.i(762774),k=a.i(654617),l=a.i(355629),m=a.i(579950),n=a.i(465863),o=a.i(827689),p=a.i(599535),q=a.i(987974),r=a.i(36873),s=a.i(23486),t=b([d,f,p]);[d,f,p]=t.then?(await t)():t;class u{osPlatform=(0,n.getOSPlatform)();appPlatform="tauri";localBooksDir="";isMobile=!1;isMacOSApp=!1;isLinuxApp=!1;isAppDataSandbox=!1;isAndroidApp=!1;isIOSApp=!1;isMobileApp=!1;isPortableApp=!1;isDesktopApp=!1;isEink=!1;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir=!1;canReadExternalDir=!1;distChannel="readest";CURRENT_MIGRATION_VERSION=0x1352519;async runMigrations(a){if(a<0x13501f4)try{await this.migrate20251124()}catch(a){console.error("Error migrating to version 20251124:",a)}if(a<0x1352519)try{await this.migrate20260121()}catch(a){console.error("Error migrating to version 20260121:",a)}}async prepareBooksDir(){this.localBooksDir=await this.fs.getPrefix("Books"),await this.ensureConfigFilesExist()}async ensureConfigFilesExist(){try{if(!await this.fs.exists(k.SETTINGS_FILENAME,"Settings")){console.log("[Init] settings.json not found, creating with defaults...");let a={...k.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?k.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:k.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),globalReadSettings:{...k.DEFAULT_READSETTINGS,...this.isMobile?k.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()};await this.safeSaveJSON(k.SETTINGS_FILENAME,"Settings",a),console.log("[Init] ✓ settings.json created successfully")}let a=(0,f.getLibraryFilename)();await this.fs.exists(a,"Books")||(console.log("[Init] library.json not found, creating with defaults..."),await this.safeSaveJSON(a,"Books",[]),console.log("[Init] ✓ library.json created successfully")),console.log("[Init] ✓ All configuration files are ready")}catch(a){console.error("[Init] Error ensuring config files exist:",a)}}async openFile(a,b){return await this.fs.openFile(a,b)}async copyFile(a,b,c){return await this.fs.copyFile(a,b,c)}async readFile(a,b,c){return await this.fs.readFile(a,b,c)}async writeFile(a,b,c){return await this.fs.writeFile(a,b,c)}async createDir(a,b,c=!0){return await this.fs.createDir(a,b,c)}async deleteFile(a,b){return await this.fs.removeFile(a,b)}async deleteDir(a,b,c=!0){return await this.fs.removeDir(a,b,c)}async resolveFilePath(a,b){let c=await this.fs.getPrefix(b);return a?`${c}/${a}`:c}async readDirectory(a,b){return await this.fs.readDir(a,b)}async exists(a,b){return await this.fs.exists(a,b)}async getImageURL(a){return await this.fs.getImageURL(a)}getCoverImageUrl=a=>{let b=(0,f.getCoverFilename)(a),c=this.fs.resolvePath(b,"Books");return this.fs.getURL(c.fp)||`${this.localBooksDir}/${b}`};getCoverImageBlobUrl=async a=>{let b=(0,f.getCoverFilename)(a);if("web"===this.appPlatform)try{let a=this.fs.getURL(this.fs.resolvePath(b,"Books").fp)||`${this.localBooksDir}/${b}`;return await (0,l.cachedFetchAsUrl)(a,{cacheStrategy:"cache-first",cacheTTL:2592e6}).catch(()=>`${this.localBooksDir}/${b}`)}catch{return`${this.localBooksDir}/${b}`}try{return await this.fs.getBlobURL(b,"Books")}catch{return`${this.localBooksDir}/${b}`}};async getCachedImageUrl(a){let b=`img_${(0,h.md5)(a)}`,c=await this.fs.getPrefix("Cache"),d=`${c}/${b}`;if(await this.fs.exists(d,"None"))return await this.fs.getImageURL(d);{let c=await this.fs.openFile(a,"None");return await this.fs.writeFile(b,"Cache",await c.arrayBuffer()),await this.fs.getImageURL(d)}}getDefaultViewSettings(){return{...k.DEFAULT_BOOK_LAYOUT,...k.DEFAULT_BOOK_STYLE,...k.DEFAULT_BOOK_FONT,...k.DEFAULT_BOOK_LANGUAGE,...this.isMobile?k.DEFAULT_MOBILE_VIEW_SETTINGS:{},...this.isEink?k.DEFAULT_EINK_VIEW_SETTINGS:{},...(0,n.isCJKEnv)()?k.DEFAULT_CJK_VIEW_SETTINGS:{},...k.DEFAULT_VIEW_CONFIG,...k.DEFAULT_TTS_CONFIG,...k.DEFAULT_SCREEN_CONFIG,...k.DEFAULT_ANNOTATOR_CONFIG,...{...k.DEFAULT_TRANSLATOR_CONFIG,translateTargetLang:(0,n.getTargetLang)()}}}async loadSettings(){let a={...k.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?k.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:k.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),koreaderSyncDeviceId:(0,d.v4)(),globalReadSettings:{...k.DEFAULT_READSETTINGS,...this.isMobile?k.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()},b=await this.safeLoadJSON(k.SETTINGS_FILENAME,"Settings",a),c=b.version??0;return(this.isAppDataSandbox||c<k.SYSTEM_SETTINGS_VERSION)&&(b.version=k.SYSTEM_SETTINGS_VERSION),(b={...k.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?k.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},...b}).globalReadSettings={...k.DEFAULT_READSETTINGS,...this.isMobile?k.DEFAULT_MOBILE_READSETTINGS:{},...b.globalReadSettings},b.globalViewSettings={...this.getDefaultViewSettings(),...b.globalViewSettings},b.localBooksDir=await this.fs.getPrefix("Books"),b.kosync.deviceId||(b.kosync.deviceId=(0,d.v4)(),await this.saveSettings(b)),this.localBooksDir=b.localBooksDir,b}async saveSettings(a){await this.safeSaveJSON(k.SETTINGS_FILENAME,"Settings",a)}async importFont(a){let b,c;if("string"==typeof a)b=(await this.fs.openFile(a,"None")).name||(0,i.getFilename)(a),await this.fs.copyFile(a,b,"Fonts"),c=await this.fs.openFile(b,"Fonts");else{if(!a)return null;b=(0,i.getFilename)(a.name),await this.fs.writeFile(b,"Fonts",a),c=a}return{path:b,...(0,r.parseFontInfo)(await c.arrayBuffer(),b)}}async deleteFont(a){await this.fs.removeFile(a.path,"Fonts")}async importImage(a){let b;if("string"==typeof a)b=(await this.fs.openFile(a,"None")).name||(0,i.getFilename)(a),await this.fs.copyFile(a,b,"Images");else{if(!a)return null;b=(0,i.getFilename)(a.name),await this.fs.writeFile(b,"Images",a)}return{name:b.replace(/\.[^/.]+$/,""),path:b}}async deleteImage(a){await this.fs.removeFile(a.path,"Images")}async importBook(a,b,c=!0,d=!0,e=!1,h=!1,k){let l=Date.now(),m="";try{let o,q,r;if(h&&"string"!=typeof a)throw Error("Transient import is only supported for file paths");try{"string"==typeof a?m=(r=await this.fs.openFile(a,"None")).name||(0,i.getFilename)(a):(r=a,m=a.name);let b=r.size/1048576;if(console.log(`[importBook] Processing: ${m}, size: ${b.toFixed(2)} MB`),0===r.size)throw Error("Invalid or empty book file");if(r.size>0x6400000&&console.warn(`[importBook] ⚠️ Large file: ${b.toFixed(2)} MB, processing may take longer`),/\.txt$/i.test(m)){let a=new p.TxtToEpubConverter;({file:r}=await a.convert({file:r}))}if(console.log(`[importBook] Opening document: ${m}`),{book:o,format:q}=await new j.DocumentLoader(r).open(),!o)throw Error("Unsupported or corrupted book file");let c=(0,f.formatTitle)(o.metadata.title);c&&c.trim()&&c!==m||(o.metadata.title=(0,i.getBaseFilename)(m)),console.log(`[importBook] ✓ Document opened successfully: ${m}`)}catch(b){let a=b.message||String(b);throw console.error(`[importBook] ✗ Failed to open book: ${m}`,a),Error(`Failed to open the book: ${a}`)}console.log(`[importBook] Computing hash for: ${m}`);let t=await (0,g.partialMD5)(r),u=b.filter(a=>a.hash===t)[0],v=Date.now();u&&(h||(u.deletedAt=null),u.createdAt=v,u.updatedAt=v);let w=(0,f.getPrimaryLanguage)(o.metadata.language),x={hash:t,format:q,title:(0,f.formatTitle)(o.metadata.title),sourceTitle:(0,f.formatTitle)(o.metadata.title),primaryLanguage:w,author:(0,f.formatAuthors)(o.metadata.author,w),createdAt:u?u.createdAt:v,uploadedAt:u?u.uploadedAt:h?null:v,deletedAt:h?v:null,downloadedAt:v,updatedAt:v};u&&(u.format=x.format,u.title=u.title.trim()?u.title.trim():x.title,u.sourceTitle=u.sourceTitle??x.sourceTitle,u.author=u.author??x.author,u.primaryLanguage=u.primaryLanguage??x.primaryLanguage,u.downloadedAt=Date.now());let y="web"===this.appPlatform;console.log("[ImportBook] appPlatform:",this.appPlatform,"STORAGE_MODE (runtime):",!1,"STORAGE_MODE (env):","local","shouldUseLocalFlatStorage:",y);let z=j.EXTS[q]||q.toLowerCase?.()||"book",A=(0,n.makeSafeFilename)(x.sourceTitle||x.title),B=k?.targetGroupName?.trim();if(y){let a=k?.targetRelativePath?k.targetRelativePath:`${B?`${B}/`:""}${A}.${z}`;if(!a)throw Error("targetRelativePath is required for local storage mode. Please provide a valid relative path.");x.relativePath=a,console.log("[ImportBook] 5. Setting book.relativePath to:",a),console.log("[ImportBook] 6. Book hash:",x.hash),u&&(u.relativePath=a),B&&!x.groupName&&(x.groupName=B,u&&!u.groupName&&(u.groupName=B))}else if("web"===this.appPlatform){let a=k?.targetRelativePath?k.targetRelativePath:`${B?`${B}/`:""}${A}.${z}`;x.relativePath=a,u&&(u.relativePath=a)}await this.ensureLocalBookDirs(x);let C=(0,f.getLocalBookFilename)(x);if(c&&!h&&(!await this.fs.exists(C,"Books")||e))if(/\.txt$/i.test(m))await this.fs.writeFile(C,"Books",r);else if("string"==typeof a&&(0,n.isContentURI)(a))await this.fs.copyFile(a,C,"Books");else if("string"!=typeof a||(0,n.isValidURL)(a))await this.fs.writeFile(C,"Books",r);else try{await this.fs.copyFile(a,C,"Books")}catch{await this.fs.writeFile(C,"Books",await r.arrayBuffer())}if(d&&(!await this.fs.exists((0,f.getCoverFilename)(x),"Books")||e)){console.log("[ImportBook] 7. Preparing to save cover");let a=await o.getCover();if(a?.type==="image/svg+xml")try{console.log("[ImportBook] Converting SVG cover to PNG..."),a=await (0,s.svg2png)(a)}catch{}if(a){let b=(0,f.getCoverFilename)(x);console.log("[ImportBook] 8. Saving cover with filename:",b),console.log("[ImportBook] 9. Cover size:",a.size,"bytes"),await this.fs.writeFile(b,"Books",await a.arrayBuffer()),console.log("[ImportBook] 10. Cover saved successfully")}}u||(await this.saveBookConfig(x,f.INIT_BOOK_CONFIG),b.splice(0,0,x)),"string"==typeof a&&((0,n.isValidURL)(a)&&(x.url=a,u&&(u.url=a)),h&&(x.filePath=a,u&&(u.filePath=a))),x.coverImageUrl=await this.generateCoverImageUrl(x),a&&a.close&&await a.close();let D=Date.now()-l;return console.log(`[importBook] ✓ Import completed in ${D}ms: ${m}`),u||x}catch(e){let b=Date.now()-l,c=e.message||String(e),d=e.stack;if(console.error(`[importBook] ✗ Import failed after ${b}ms`),console.error(`[importBook] File: ${m||("string"==typeof a?a:"unknown")}`),console.error(`[importBook] Error: ${c}`),d&&console.error("[importBook] Stack trace:",d),c.includes("memory")||c.includes("ENOMEM"))throw Error(`内存不足：文件可能过大。请尝试导入较小的文件或关闭其他程序。原始错误：${c}`);throw c.includes("too large")||c.includes("Maximum size"),e}}async importBookFromPath(a,b,c){try{let d=b.split("/").slice(0,-1).join("/");return await this.importBook(a,c,!1,!0,!1,!0,{targetRelativePath:b,targetGroupName:d||""})}catch(b){return console.error("Error importing book from path:",a,b),null}}async reclassifyBook(a,b,c){if("web"!==this.appPlatform)return void console.log("[Reclassify] 非本地存储模式，跳过文件移动");if(!a.relativePath)return void console.log("[Reclassify] 书籍未使用新存储结构，跳过文件移动:",a.title);try{let d,e,f=(await this.loadSettings()).groupDirectories||{},g=a.relativePath;if(c&&g.startsWith(`${c}/`))d=g.substring(c.length+1);else{let a=g.split("/");d=a[a.length-1]||""}let h=(e=b&&f[b]?f[b]:b||"")?`${e}/${d}`:d;if(g===h)return void console.log("[Reclassify] 书籍分组未改变，无需移动文件");console.log("[Reclassify] 准备移动书籍文件"),console.log("  旧路径:",g),console.log("  新路径:",h),console.log("  文件名:",d),console.log("  新分组:",b),console.log("  目标目录:",e);let i=await fetch("/api/storage/reclassify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPath:g,newPath:h})});if(!i.ok){let a=await i.text();throw console.error("[Reclassify] 文件移动失败:",a),Error(`Failed to move book files: ${a}`)}let j=await i.json();a.relativePath=h,a.groupName=b||void 0,j.absolutePath&&(a.absolutePath=j.absolutePath),console.log("[Reclassify] 文件移动成功:",j)}catch(a){throw console.error("[Reclassify] 重新分类书籍时出错:",a),a}}async deleteBook(a,b){if(console.log("Deleting book with action:",b,a.title),"local"===b||"both"===b){for(let c of"local"===b?[(0,f.getLocalBookFilename)(a)]:[(0,f.getLocalBookFilename)(a),(0,f.getCoverFilename)(a)])console.log("Deleting local file:",c),await this.fs.removeFile(c,"Books");"local"===b?a.downloadedAt=null:(a.deletedAt=Date.now(),a.downloadedAt=null,a.coverDownloadedAt=null)}("cloud"===b||"both"===b)&&a.uploadedAt&&(console.log("Cloud delete operation skipped - cloud storage removed"),a.uploadedAt=null)}async exportBook(a){let{file:b}=await this.loadBookContent(a),c=await b.arrayBuffer(),d=`${(0,n.makeSafeFilename)(a.title)}.${a.format.toLowerCase()}`,e=await this.resolveFilePath((0,f.getLocalBookFilename)(a),"Books"),g=b.type||"application/octet-stream";return await this.saveFile(d,c,e,g)}async isBookAvailable(a){let b=(0,f.getLocalBookFilename)(a);return!!await this.fs.exists(b,"Books")||(a.filePath?await this.fs.exists(a.filePath,"None"):!!a.url&&(0,n.isValidURL)(a.url))}async getBookFileSize(a){let b=(0,f.getLocalBookFilename)(a);if(await this.fs.exists(b,"Books")){let a=await this.fs.openFile(b,"Books"),c=a.size;return a&&a.close&&await a.close(),c}return null}async loadBookContent(a){let b,c=(0,f.getLocalBookFilename)(a);if(await this.fs.exists(c,"Books"))b=await this.fs.openFile(c,"Books");else if(a.filePath)b=await this.fs.openFile(a.filePath,"None");else if(a.url)b=await this.fs.openFile(a.url,"None");else{let c=(0,f.getDir)(a),d=await this.fs.readDir((0,f.getDir)(a),"Books");if(d.length>0){let e=d.find(b=>b.path.endsWith(`.${j.EXTS[a.format]}`));if(e)b=await this.fs.openFile(`${c}/${e.path}`,"Books");else throw Error(q.BOOK_FILE_NOT_FOUND_ERROR)}else throw Error(q.BOOK_FILE_NOT_FOUND_ERROR)}return{book:a,file:b}}async loadBookConfig(a,b){let c={...b.globalViewSettings,...e.FIXED_LAYOUT_FORMATS.has(a.format)?k.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};try{let b="{}";return await this.fs.exists((0,f.getConfigFilename)(a),"Books")&&(b=await this.fs.readFile((0,f.getConfigFilename)(a),"Books","text")),(0,o.deserializeConfig)(b,c,k.DEFAULT_BOOK_SEARCH_CONFIG)}catch{return(0,o.deserializeConfig)("{}",c,k.DEFAULT_BOOK_SEARCH_CONFIG)}}async fetchBookDetails(a){let b=(0,f.getLocalBookFilename)(a);if(!await this.fs.exists(b,"Books")&&a.uploadedAt)throw console.warn("Book file not found locally and cloud download is disabled:",a.title),Error("Book file not found locally");let{file:c}=await this.loadBookContent(a),d=(await new j.DocumentLoader(c).open()).book;return c&&c.close&&await c.close(),d.metadata}async saveBookConfig(a,b,c){let d;if(c){let f={...c.globalViewSettings,...e.FIXED_LAYOUT_FORMATS.has(a.format)?k.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};d=(0,o.serializeConfig)(b,f,k.DEFAULT_BOOK_SEARCH_CONFIG)}else d=JSON.stringify(b);await this.fs.writeFile((0,f.getConfigFilename)(a),"Books",d)}async generateCoverImageUrl(a){return"web"===this.appPlatform?await this.getCoverImageBlobUrl(a):this.getCoverImageUrl(a)}async loadLibraryBooks(){console.log("Loading library books...");let a=(0,f.getLibraryFilename)();await this.fs.exists("","Books")||await this.fs.createDir("","Books",!0);let b=await this.safeLoadJSON(a,"Books",[]);return await Promise.all(b.map(async a=>(a.coverImageUrl=await this.generateCoverImageUrl(a),a.updatedAt??=a.lastUpdated||Date.now(),a))),b}async saveLibraryBooks(a){let b=a.map(({coverImageUrl:a,...b})=>b);await this.safeSaveJSON((0,f.getLibraryFilename)(),"Books",b)}async reconcileBookPaths(a){if("web"!==this.appPlatform)return console.log("[Reconcile] 非本地存储模式，跳过路径校准"),{success:!1,error:"Not in local storage mode"};try{console.log("[Reconcile] 开始校准书籍路径，共",a.length,"本书");let b=a.filter(a=>!a.deletedAt).map(a=>({hash:a.hash,relativePath:a.relativePath,absolutePath:a.absolutePath,title:a.title,groupName:a.groupName})),c=await fetch("/api/storage/reconcile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({library:b})});if(!c.ok){let a=await c.text();throw console.error("[Reconcile] 路径校准失败:",a),Error(`Failed to reconcile paths: ${a}`)}let d=await c.json();return console.log("[Reconcile] 路径校准完成:",d.summary),d}catch(a){throw console.error("[Reconcile] 路径校准出错:",a),a}}async applyReconciliation(a,b){let c=[...a];for(let a of b)if("moved"===a.status){let b=c.findIndex(b=>b.hash===a.hash);if(-1!==b){let d=c[b];d&&(d.relativePath=a.newRelativePath,d.absolutePath=a.absolutePath,void 0!==a.suggestedGroupName&&(d.groupName=a.suggestedGroupName,d.groupId=a.suggestedGroupName?(0,g.md5Fingerprint)(a.suggestedGroupName):""),d.updatedAt=Date.now(),console.log("[Reconcile] 更新书籍:",d.title,"新路径:",d.relativePath))}}return await this.saveLibraryBooks(c),c}imageToArrayBuffer(a,b){return new Promise((c,d)=>{a||b?"web"===this.appPlatform&&a&&a.startsWith("blob:")?fetch(a).then(a=>a.arrayBuffer()).then(a=>c(a)).catch(a=>d(a)):"tauri"===this.appPlatform&&b?this.fs.openFile(b,"None").then(a=>a.arrayBuffer()).then(a=>c(a)).catch(a=>d(a)):"tauri"===this.appPlatform&&a?(0,m.fetch)(a,{method:"GET"}).then(a=>a.arrayBuffer()).then(a=>c(a)).catch(a=>d(a)):d(Error("Unsupported platform or missing image data")):d(Error("No image URL or file provided"))})}async updateCoverImage(a,b,c){if("_blank"===b)await this.fs.removeFile((0,f.getCoverFilename)(a),"Books");else if(b||c){let d=await this.imageToArrayBuffer(b,c);await this.fs.writeFile((0,f.getCoverFilename)(a),"Books",d)}}async loadJSONFile(a,b){try{let c=await this.fs.readFile(a,b,"text");if(!c||"string"!=typeof c||0===c.trim().length)return{success:!1,error:"File is empty or invalid"};try{let a=JSON.parse(c);return{success:!0,data:a}}catch(a){return{success:!1,error:`JSON parse error: ${a}`}}}catch(a){return{success:!1,error:a}}}async safeLoadJSON(a,b,c){let d=`${a}.bak`,e=await this.loadJSONFile(a,b);if(e.success)return e.data;console.warn(`Failed to load ${a}, attempting backup...`,e.error);let f=await this.loadJSONFile(d,b);if(f.success){console.warn(`Loaded from backup: ${d}`);try{let c=JSON.stringify(f.data,null,2);await this.fs.writeFile(a,b,c),console.log(`Restored ${a} from backup`)}catch(b){console.error(`Failed to restore ${a} from backup:`,b)}return f.data}return console.error(`Both ${a} and ${d} failed to load`),c}async safeSaveJSON(a,b,c){let d=`${a}.bak`,e=JSON.stringify(c,null,2);try{await this.fs.writeFile(d,b,e),await this.fs.writeFile(a,b,e)}catch(b){throw console.error(`Failed to save ${a}:`,b),Error(`Failed to save ${a}: ${b}`)}}async ensureLocalBookDirs(a){if(a.relativePath){let b=a.relativePath.split("/").slice(0,-1).join("/"),c=a.relativePath.replace(/\.[^.]+$/,"");b&&await this.fs.createDir(b,"Books",!0),await this.fs.createDir(c,"Books",!0);return}await this.fs.exists((0,f.getDir)(a),"Books")||await this.fs.createDir((0,f.getDir)(a),"Books")}async migrate20251124(){console.log("Running migration for version 20251124 to rename the backup library file...");let a=(0,f.getLibraryBackupFilename)(),b=`${(0,f.getLibraryFilename)()}.bak`;if(await this.fs.exists(a,"Books"))try{let c=await this.fs.readFile(a,"Books","text");await this.fs.writeFile(b,"Books",c),await this.fs.removeFile(a,"Books"),console.log("Migration to rename backup library file completed successfully.")}catch(a){console.error("Error during migration to rename backup library file:",a)}}async migrate20260121(){if("web"!==this.appPlatform)return void console.log("[Migration 20260121] Skip (not web/local mode)");console.log("[Migration 20260121] Start migrating legacy hash-based books to flat layout");let a=await this.loadLibraryBooks(),b=0;for(let c of a){if(c.relativePath)continue;let a=j.EXTS[c.format]||c.format?.toLowerCase?.()||"book",d=(0,n.makeSafeFilename)(c.sourceTitle||c.title||c.hash),e=`${c.groupName?`${c.groupName}/`:""}${d}.${a}`,f=`${c.hash}/${d}.${a}`,g=`${c.hash}/cover.png`,h=`${c.hash}/config.json`,i=e.replace(/\.[^.]+$/,"")+"/cover.png",k=e.replace(/\.[^.]+$/,"")+"/config.json";try{if(await this.fs.exists(f,"Books")){await this.ensureLocalBookDirs({...c,relativePath:e});let a=await this.fs.openFile(f,"Books");await this.fs.writeFile(e,"Books",a),await this.fs.removeFile(f,"Books")}if(await this.fs.exists(g,"Books")){let a=await this.fs.openFile(g,"Books");await this.fs.writeFile(i,"Books",a),await this.fs.removeFile(g,"Books")}if(await this.fs.exists(h,"Books")){let a=await this.fs.readFile(h,"Books","text");await this.fs.writeFile(k,"Books",a),await this.fs.removeFile(h,"Books")}c.relativePath=e,b++}catch(a){console.error("[Migration 20260121] Failed to migrate book:",c.title,a)}}b>0?(await this.saveLibraryBooks(a),console.log(`[Migration 20260121] Migrated ${b} book(s) to flat layout`)):console.log("[Migration 20260121] No legacy books to migrate")}}a.s(["BaseAppService",()=>u]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=_cf702548._.js.map