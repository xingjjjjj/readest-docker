module.exports=[177242,a=>{"use strict";var b=a.i(621823);let c="http://www.idpf.org/2007/opf",d="http://www.idpf.org/2007/ops",e="http://purl.org/dc/elements/1.1/",f="http://www.w3.org/2001/04/xmlenc#",g="http://www.w3.org/1999/xlink",h="application/xhtml+xml",i="text/html",j="text/css",k="image/svg+xml",l=/\/(x-)?(javascript|ecmascript)/,m={a11y:"http://www.idpf.org/epub/vocab/package/a11y/#",dcterms:"http://purl.org/dc/terms/",marc:"http://id.loc.gov/vocabulary/",media:"http://www.idpf.org/epub/vocab/overlays/#",onix:"http://www.editeur.org/ONIX/book/codelists/current.html#",rendition:"http://www.idpf.org/vocab/rendition/#",schema:"http://schema.org/",xsd:"http://www.w3.org/2001/XMLSchema#",msv:"http://www.idpf.org/epub/vocab/structure/magazine/#",prism:"http://www.prismstandard.org/specifications/3.0/PRISM_CV_Spec_3.0.htm#"},n={art:"artist",aut:"author",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},o={"02":"isbn","06":"doi",15:"isbn",26:"doi",34:"issn"},p=a=>a.toLowerCase().replace(/[-:](.)/g,(a,b)=>b.toUpperCase()),q=(...a)=>b=>b?Object.fromEntries(a.map(a=>[p(a),b.getAttribute(a)])):null,r=a=>{let b;return(b=a?.textContent)?b.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):""},s=(a,b)=>{let c=a.lookupNamespaceURI(null)===b||a.lookupPrefix(b),d=c?(a,c)=>a=>a.namespaceURI===b&&a.localName===c:(a,b)=>a=>a.localName===b;return{$:(a,b)=>[...a.children].find(d(a,b)),$$:(a,b)=>[...a.children].filter(d(a,b)),$$$:c?(a,c)=>[...a.getElementsByTagNameNS(b,c)]:(a,b)=>[...a.getElementsByTagName(b)]}},t=(a,b)=>{try{if(a=a.replace(/%2c/gi,",").replace(/%3a/gi,":"),b.includes(":")&&!b.startsWith("OEBPS"))return new URL(a,b);let c="https://invalid.invalid/",d=new URL(a,c+b);return d.search="",decodeURI(d.href.replace(c,""))}catch(b){return console.warn(b),a}},u=async(a,b,c)=>{let d=[];a.replace(b,(...a)=>(d.push(a),null));let e=[];for(let a of d)e.push(await c(...a));return a.replace(b,()=>e.shift())},v=a=>a.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),w=a=>{for(let[b,c]of Object.entries(a))null==c?delete a[b]:Array.isArray(c)?(a[b]=c.filter(a=>a).map(a=>"object"!=typeof a||Array.isArray(a)?a:w(a)),a[b].length?1===a[b].length&&(a[b]=a[b][0]):delete a[b]):"object"==typeof c&&(a[b]=w(c),Object.keys(c).length||delete a[b]);let b=Object.keys(a);return 1===b.length&&"name"===b[0]?a[b[0]]:a},x=(a,b)=>{if(!a)return null;let[c,d]=a.split(":"),e=d||c,f=b.get(d?c:null);return f?f+e:null},y=a=>{if(!a)return;let b=a.split(":").map(a=>parseFloat(a));if(3===b.length){let[a,c,d]=b;return 60*a*60+60*c+d}if(2===b.length){let[a,c]=b;return 60*a+c}let[c,d]=a.split(/(?=[^\d.])/);return parseFloat(c)*("h"===d?3600:"min"===d?60:"ms"===d?.001:1)},z=["jpg","jpeg","png","gif","webp"];class A extends EventTarget{#a;#b;#c;#d;#e;#f;#g=1;#h=1;#i;constructor(a,b){super(),this.book=a,this.loadXML=b}async #j(a){if(this.#b===a)return;let b=await this.loadXML(a.href),c=b=>b?t(b,a.href):null,{$:d,$$$:e}=s(b,"http://www.w3.org/ns/SMIL");this.#d=-1,this.#e=-1,this.#a=e(b,"par").reduce((a,b)=>{let e=c(d(b,"text")?.getAttribute("src")),f=d(b,"audio");if(!e||!f)return a;let g=c(f.getAttribute("src")),h=y(f.getAttribute("clipBegin")),i=y(f.getAttribute("clipEnd")),j=a.at(-1);return j?.src===g?j.items.push({text:e,begin:h,end:i}):a.push({src:g,items:[{text:e,begin:h,end:i}]}),a},[]),this.#b=a}get #k(){return this.#a[this.#d]}get #l(){return this.#k?.items?.[this.#e]}#m(a){console.error(a),this.dispatchEvent(new CustomEvent("error",{detail:a}))}#n(){this.dispatchEvent(new CustomEvent("highlight",{detail:this.#l}))}#o(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:this.#l}))}async #p(a,b){this.#q(),this.#d=a,this.#e=b;let c=this.#k?.src;if(!c||!this.#l)return this.start(this.#c+1);let d=URL.createObjectURL(await this.book.loadBlob(c)),e=new Audio(d);this.#f=e,e.volume=this.#g,e.playbackRate=this.#h,e.addEventListener("timeupdate",()=>{if(e.paused)return;let a=e.currentTime,{items:b}=this.#k;if(a>this.#l?.end&&(this.#o(),this.#e===b.length-1))return void this.#p(this.#d+1,0).catch(a=>this.#m(a));let c=this.#e;for(;b[this.#e+1]?.begin<=a;)this.#e++;this.#e!==c&&this.#n()}),e.addEventListener("error",()=>this.#m(Error(`Failed to load ${c}`))),e.addEventListener("playing",()=>this.#n()),e.addEventListener("ended",()=>{this.#o(),URL.revokeObjectURL(d),this.#f=null,this.#p(a+1,0).catch(a=>this.#m(a))}),"paused"===this.#i?(this.#n(),e.currentTime=this.#l.begin??0):e.addEventListener("canplaythrough",()=>{e.currentTime=this.#l.begin??0,this.#i="playing",e.play().catch(a=>this.#m(a))},{once:!0})}async start(a,b=()=>!0){this.#f?.pause();let c=this.book.sections[a],d=c?.id;if(!d)return;let{mediaOverlay:e}=c;if(!e)return this.start(a+1);this.#c=a,await this.#j(e);for(let a=0;a<this.#a.length;a++){let{items:c}=this.#a[a];for(let e=0;e<c.length;e++)if(c[e].text.split("#")[0]===d&&b(c[e],e,c))return this.#p(a,e).catch(a=>this.#m(a))}}pause(){this.#i="paused",this.#f?.pause()}resume(){this.#i="playing",this.#f?.play().catch(a=>this.#m(a))}#q(){this.#f&&(this.#f.pause(),URL.revokeObjectURL(this.#f.src),this.#f=null,this.#o())}stop(){this.#i="stopped",this.#q()}prev(){this.#e>0?this.#p(this.#d,this.#e-1):this.#d>0?this.#p(this.#d-1,this.#a[this.#d-1].items.length-1):this.#c>0&&this.start(this.#c-1,(a,b,c)=>b===c.length-1)}next(){this.#p(this.#d,this.#e+1)}setVolume(a){this.#g=a,this.#f&&(this.#f.volume=a)}setRate(a){this.#h=a,this.#f&&(this.#f.playbackRate=a)}}let B=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,C=a=>r(a.getElementById(a.documentElement.getAttribute("unique-identifier"))??a.getElementsByTagNameNS(e,"identifier")[0]),D=async(a,b,c)=>{let d=new Uint8Array(await c.slice(0,b).arrayBuffer());b=Math.min(b,d.length);for(var e=0;e<b;e++)d[e]=d[e]^a[e%a.length];return new Blob([d,c.slice(b)],{type:c.type})},E=async a=>{let b=new TextEncoder().encode(a);return new Uint8Array(await globalThis.crypto.subtle.digest("SHA-1",b))};class F{#r=new Map;#s=new Map;#t;constructor(a){this.#t=a}async init(a,b){if(a)for(let{algorithm:c,uri:d}of Array.from(a.getElementsByTagNameNS(f,"EncryptedData"),a=>({algorithm:a.getElementsByTagNameNS(f,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:a.getElementsByTagNameNS(f,"CipherReference")[0]?.getAttribute("URI")}))){if(!this.#s.has(c)){let a=this.#t[c];if(!a){console.warn("Unknown encryption algorithm");continue}let d=await a.key(b);this.#s.set(c,b=>a.decode(d,b))}this.#r.set(d,c)}}getDecoder(a){return this.#s.get(this.#r.get(a))??(a=>a)}}class G{constructor({opf:a,resolveHref:d}){this.opf=a;const{$:e,$$:f,$$$:g}=s(a,c),h=e(a.documentElement,"manifest"),i=e(a.documentElement,"spine"),j=f(i,"itemref");this.manifest=f(h,"item").map(q("href","id","media-type","properties","media-overlay")).map(a=>(a.href=d(a.href),a.properties=a.properties?.split(/\s/),a)),this.manifestById=new Map(this.manifest.map(a=>[a.id,a])),this.spine=j.map(q("idref","id","linear","properties")).map(a=>(a.properties=a.properties?.split(/\s/),a)),this.pageProgressionDirection=i.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(i.getAttribute("toc"))??this.manifest.find(a=>"application/x-dtbncx+xml"===a.mediaType))?.href;const k=e(a.documentElement,"guide");k&&(this.guide=f(k,"reference").map(q("type","title","href")).map(({type:a,title:b,href:c})=>({label:b,type:a.split(/\s/),href:d(c)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(g(a,"meta").find(((a,b,c)=>"function"==typeof b?c=>b(c.getAttribute(a)):c=>c.getAttribute(a)===b)("name","cover"))?.getAttribute("content"))??this.manifest.find(a=>"cover"===a.id&&a.mediaType.startsWith("image"))??this.manifest.find(a=>a.href.includes("cover")&&a.mediaType.startsWith("image"))??this.getItemByHref(this.guide?.find(a=>a.type.includes("cover"))?.href)??this.manifest.find(a=>a.mediaType.startsWith("image")),this.cfis=b.fromElements(j)}getItemByID(a){return this.manifestById.get(a)}getItemByHref(a){return this.manifest.find(b=>b.href===a)}getItemByProperty(a){return this.manifest.find(b=>b.properties?.includes(a))}resolveCFI(a){let c=b.parse(a),d=(c.parent??c).shift(),e=b.toElement(this.opf,d);e&&"idref"!==e.nodeName&&(d.at(-1).id=null,e=b.toElement(this.opf,d));let f=e?.getAttribute("idref");return{index:this.spine.findIndex(a=>a.idref===f),anchor:a=>b.toRange(a,c)}}}class H{#u=new Map;#v=new Map;#w=new Map;#x=new Map;eventTarget=new EventTarget;constructor({loadText:a,loadBlob:b,resources:c,entries:d}){this.loadText=a,this.loadBlob=b,this.manifest=c.manifest,this.assets=c.manifest,this.entries=d}async createURL(a,b,c,d){if(!b)return"";let e={data:b,type:c};Object.defineProperty(e,"name",{value:a});let f=new CustomEvent("data",{detail:e});this.eventTarget.dispatchEvent(f);let g=await f.detail.data,i=await f.detail.type,j=URL.createObjectURL(new Blob([g],{type:i}));if(this.#u.set(a,j),this.#x.set(a,1),i===h&&this.#v.set(j,{href:a,type:i,data:g}),d){let b=this.#w.get(d);b?b.push(a):this.#w.set(d,[a])}return j}ref(a,b){let c=this.#w.get(b);return c?.includes(a)||(this.#x.set(a,this.#x.get(a)+1),c?c.push(a):this.#w.set(b,[a])),this.#u.get(a)}unref(a){if(!this.#x.has(a))return;let b=this.#x.get(a)-1;if(b<1){let b=this.#u.get(a);URL.revokeObjectURL(b),this.#u.delete(a),this.#v.delete(b),this.#x.delete(a);let c=this.#w.get(a);if(c)for(;c.length;)this.unref(c.pop());this.#w.delete(a)}else this.#x.set(a,b)}async loadItem(a,b=[]){if(!a)return null;let{href:c,mediaType:d}=a,e=l.test(a.mediaType),f=new CustomEvent("load",{detail:{type:d,isScript:e,allow:!0}});if(this.eventTarget.dispatchEvent(f),!await f.detail.allow)return null;let g=b.at(-1);if(this.#u.has(c))return this.ref(c,g);if((e||[h,i,j,k].includes(d))&&b.every(a=>a!==c))return this.loadReplaced(a,b);let m=Promise.resolve().then(()=>this.loadBlob(c));return this.createURL(c,m,d,g)}async loadItemXHTMLContent(a,b=[]){let c=await this.loadItem(a,b);if(c)return this.#v.get(c)?.data}tryImageEntryItem(a){return z.some(b=>a.toLowerCase().endsWith(`.${b}`))&&this.entries.get(a)?{href:a,mediaType:({jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp"})[a.toLowerCase().split(".").pop()]||"image/jpeg"}:null}async loadHref(a,b,c=[]){if(/^(?!blob)\w+:/i.test(a))return a;let d=t(a,b),e=this.manifest.find(a=>a.href===d);return e||(e=this.tryImageEntryItem(d))?this.loadItem(e,c.concat(b)):a}async loadReplaced(a,b=[]){let{href:c,mediaType:d}=a,e=b.at(-1),f="";try{f=await this.loadText(c)}catch(a){return this.createURL(c,Promise.reject(a),d,e)}if(!f)return null;if([h,i,k].includes(d)){let j=new DOMParser().parseFromString(f,d);if(d===h&&(j.querySelector("parsererror")||!j.documentElement?.namespaceURI)&&(console.warn(j.querySelector("parsererror")?.innerText??"Invalid XHTML"),a.mediaType=i,j=new DOMParser().parseFromString(f,a.mediaType)),[h,k].includes(a.mediaType)){let a=j.firstChild;for(;a instanceof ProcessingInstruction;){if(a.data){let d=await u(a.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(a,d,e,f)=>this.loadHref(e,c,b).then(a=>`${d}${a}${f}`));a.replaceWith(j.createProcessingInstruction(a.target,d))}a=a.nextSibling}}let l=async(a,d)=>a.setAttribute(d,await this.loadHref(a.getAttribute(d),c,b));for(let a of j.querySelectorAll("link[href]"))await l(a,"href");for(let a of j.querySelectorAll("[src]"))await l(a,"src");for(let a of j.querySelectorAll("[poster]"))await l(a,"poster");for(let a of j.querySelectorAll("object[data]"))await l(a,"data");for(let a of j.querySelectorAll("[*|href]:not([href])"))a.setAttributeNS(g,"href",await this.loadHref(a.getAttributeNS(g,"href"),c,b));for(let a of j.querySelectorAll("[srcset]"))a.setAttribute("srcset",await u(a.getAttribute("srcset"),/(\s*)(.+?)\s*((?:\s[\d.]+[wx])+\s*(?:,|$)|,\s+|$)/g,(a,d,e,f)=>this.loadHref(e,c,b).then(a=>`${d}${a}${f}`)));for(let a of j.querySelectorAll("style"))a.textContent&&(a.textContent=await this.replaceCSS(a.textContent,c,b));for(let a of j.querySelectorAll("[style]"))a.setAttribute("style",await this.replaceCSS(a.getAttribute("style"),c,b));let m=new XMLSerializer().serializeToString(j);return this.createURL(c,m,a.mediaType,e)}let l=d===j?await this.replaceCSS(f,c,b):await this.replaceString(f,c,b);return this.createURL(c,l,d,e)}async replaceCSS(a,b,c=[]){let d=await u(a,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(a,d)=>this.loadHref(d,b,c).then(a=>`url("${a}")`));return u(d,/@import\s*["']([^"'\n]*?)["']/gi,(a,d)=>this.loadHref(d,b,c).then(a=>`@import "${a}"`))}replaceString(a,b,c=[]){let d=new Map,e=this.assets.map(a=>{if(a.href===b)return;let c=((a,b)=>{if(!a)return b;let c=a.replace(/\/$/,"").split("/"),d=b.replace(/\/$/,"").split("/"),e=(c.length>d.length?c:d).findIndex((a,b)=>c[b]!==d[b]);return e<0?"":Array(c.length-e).fill("..").concat(d.slice(e)).join("/")})(b.slice(0,b.lastIndexOf("/")+1),a.href),e=encodeURI(c),f="/"+a.href,g=encodeURI(f),h=new Set([c,e,f,g]);for(let b of h)d.set(b,a);return Array.from(h)}).flat().filter(a=>a);return e.length?u(a,RegExp(e.map(v).join("|"),"g"),async a=>this.loadItem(d.get(a.replace(/^\//,"")),c.concat(b))):a}unloadItem(a){this.unref(a?.href)}destroy(){for(let a of this.#u.values())URL.revokeObjectURL(a)}}class I{parser=new DOMParser;#y;#z;constructor({entries:a,loadText:b,loadBlob:c,getSize:d,sha1:f}){this.entries=a.reduce((a,b)=>(a.set(b.filename,b),a),new Map),this.loadText=b,this.loadBlob=c,this.getSize=d,this.#z=new F(((a=E)=>({"http://www.idpf.org/2008/embedding":{key:b=>a(C(b).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(a,b)=>D(a,1040,b)},"http://ns.adobe.com/pdf/enc#RC":{key:a=>{let b=(a=>{for(let b of a.getElementsByTagNameNS(e,"identifier")){let[a]=r(b).split(":").slice(-1);if(B.test(a))return a}return""})(a).replaceAll("-","");return Uint8Array.from({length:16},(a,c)=>parseInt(b.slice(2*c,2*c+2),16))},decode:(a,b)=>D(a,1024,b)}}))(f))}#A(a){let b={nbsp:"&#160;",mdash:"&#8212;",ndash:"&#8211;",ldquo:"&#8220;",rdquo:"&#8221;",lsquo:"&#8216;",rsquo:"&#8217;",hellip:"&#8230;",copy:"&#169;",reg:"&#174;",trade:"&#8482;",bull:"&#8226;",middot:"&#183;"};return a.replace(/&([a-z]+);/gi,(a,c)=>b[c.toLowerCase()]||a)}async #B(a){let b=await this.loadText(a);if(!b)return null;let c=this.#A(b),d=this.parser.parseFromString(c,"application/xml");if(d.querySelector("parsererror"))throw Error(`XML parsing error: ${a}
${d.querySelector("parsererror").innerText}`);return d}async init(){var a;let b=await this.#B("META-INF/container.xml");if(!b)throw Error("Failed to load container file");let f=Array.from(b.getElementsByTagNameNS("urn:oasis:names:tc:opendocument:xmlns:container","rootfile"),q("full-path","media-type")).filter(a=>"application/oebps-package+xml"===a.mediaType);if(!f.length)throw Error("No package document defined in container");let g=f[0].fullPath,h=await this.#B(g);if(!h)throw Error("Failed to load package document");let i=await this.#B("META-INF/encryption.xml");await this.#z.init(i,h),this.resources=new G({opf:h,resolveHref:a=>t(a,g)}),this.#y=new H({loadText:this.loadText,loadBlob:a=>Promise.resolve(this.loadBlob(a)).then(this.#z.getDecoder(a)),resources:this.resources,entries:this.entries}),this.transformTarget=this.#y.eventTarget,this.sections=this.resources.spine.map((a,b)=>{let{idref:c,linear:d,properties:e=[]}=a,f=this.resources.getItemByID(c);return f?{id:f.href,load:()=>this.#y.loadItem(f),unload:()=>this.#y.unloadItem(f),loadContent:()=>this.#y.loadItemXHTMLContent(f),createDocument:()=>this.loadDocument(f),size:this.getSize(f.href),cfi:this.resources.cfis[b],linear:d,pageSpread:(a=>{for(let b of a){if("page-spread-left"===b||"rendition:page-spread-left"===b)return"left";if("page-spread-right"===b||"rendition:page-spread-right"===b)return"right";if("rendition:page-spread-center"===b)return"center"}})(e),resolveHref:a=>t(a,f.href),mediaOverlay:f.mediaOverlay?this.resources.getItemByID(f.mediaOverlay):null}:(console.warn(`Could not find item with ID "${c}" in manifest`),null)}).filter(a=>a);let{navPath:j,ncxPath:k}=this.resources;if(j)try{let a=((a,b=a=>a)=>{let{$:c,$$:e,$$$:f}=s(a,"http://www.w3.org/1999/xhtml"),g=(a,f)=>a?e(a,"li").map(a=>{let e,h=c(a,"a")??c(a,"span"),i=c(a,"ol"),j=(e=h?.getAttribute("href"))?decodeURI(b(e)):null,k={label:r(h)||h?.getAttribute("title"),href:j,subitems:g(i)};return f&&(k.type=h?.getAttributeNS(d,"type")?.split(/\s/)),k}):null,h=(a,b)=>g(c(a,"ol"),b),i=f(a,"nav"),j=null,k=null,l=null,m=[];for(let a of i){let b=a.getAttributeNS(d,"type")?.split(/\s/)??[];b.includes("toc")?j??=h(a):b.includes("page-list")?k??=h(a):b.includes("landmarks")?l??=h(a,!0):m.push({label:r(a.firstElementChild),type:b,list:h(a)})}return{toc:j,pageList:k,landmarks:l,others:m}})(await this.#B(j),a=>t(a,j));this.toc=a.toc,this.pageList=a.pageList,this.landmarks=a.landmarks}catch(a){console.warn(a)}if(!this.toc&&k)try{let a=((a,b=a=>a)=>{let{$:c,$$:d}=s(a,"http://www.daisy.org/z3986/2005/ncx/"),e=a=>{let f,g=c(a,"navLabel"),h=c(a,"content"),i=r(g),j=(f=h.getAttribute("src"))?decodeURI(b(f)):null;if("navPoint"===a.localName){let b=d(a,"navPoint");return{label:i,href:j,subitems:b.length?b.map(e):null}}return{label:i,href:j}},f=(a,b)=>d(a,b).map(e),g=(b,d)=>{let e=c(a.documentElement,b);return e?f(e,d):null};return{toc:g("navMap","navPoint"),pageList:g("pageList","pageTarget"),others:d(a.documentElement,"navList").map(a=>({label:r(c(a,"navLabel")),list:f(a,"navTarget")}))}})(await this.#B(k),a=>t(a,k));this.toc=a.toc,this.pageList=a.pageList}catch(a){console.warn(a)}this.landmarks??=this.resources.guide;let{metadata:l,rendition:u,media:v}=(a=>{let{$:b}=s(a,c),f=b(a.documentElement,"metadata"),g=Object.groupBy(f.children,a=>a.namespaceURI===e?"dc":a.namespaceURI===c&&"meta"===a.localName?a.hasAttribute("name")?"legacyMeta":"meta":""),h=f.getAttribute("xml:lang")??a.documentElement.getAttribute("xml:lang")??"und",i=(a=>{let b=new Map(Object.entries(m)),c=a.documentElement.getAttributeNS(d,"prefix")||a.documentElement.getAttribute("prefix");if(c)for(let[,a,d]of c.matchAll(/(.+): +(.+)[ \t\r\n]*/g))b.set(a,d);return b})(a),j=a=>{let b=a.getAttribute("property"),d=a.getAttribute("scheme");return{property:x(b,i)??b,scheme:x(d,i)??d,lang:a.getAttribute("xml:lang"),value:r(a),props:l(a),attrs:Object.fromEntries(Array.from(a.attributes).filter(a=>a.namespaceURI===c).map(a=>[a.localName,a.value]))}},k=Map.groupBy(g.meta??[],a=>a.getAttribute("refines")),l=a=>{let b=k.get(a?"#"+a.getAttribute("id"):null);return b?Object.groupBy(b.map(j),a=>a.property):null},q=Object.fromEntries(Object.entries(Object.groupBy(g.dc||[],a=>a.localName)).map(([a,b])=>[a,b.map(j)])),t=l()??{},u=Object.fromEntries(g.legacyMeta?.map(a=>[a.getAttribute("name"),a.getAttribute("content")])??[]),v=a=>a?.[0]?.value,z=(a,b)=>v(a?.props?.[b]),A=a=>{if(!a)return null;let b=a.props?.["alternate-script"]??[],c=a.attrs["alt-rep"];if(!b.length&&(!a.lang||a.lang===h)&&!c)return a.value;let d={[a.lang??h]:a.value};for(let e of(c&&(d[a.attrs["alt-rep-lang"]]=c),b))d[e.lang]??=e.value;return d},B=a=>a?{name:A(a),sortAs:A(a.props?.["file-as"]?.[0])??a.attrs["file-as"],role:a.props?.role?.filter(a=>a.scheme===m.marc+"relators")?.map(a=>a.value)??[a.attrs.role],code:z(a,"term")??a.attrs.term,scheme:z(a,"authority")??a.attrs.authority}:null,D=a=>({name:A(a),position:v(a.props?.["group-position"])}),E=a=>{let{value:b}=a;if(/^urn:/i.test(b))return b;if(/^doi:/i.test(b))return`urn:${b}`;let c=a.props?.["identifier-type"];if(!c){let c=a.attrs.scheme;return c?/^(doi|isbn|uuid)$/i.test(c)?`urn:${c}:${b}`:{scheme:c,value:b}:b}if(c.scheme===m.onix+"codelist5"){let a=o[c.value];if(a)return`urn:${a}:${b}`}return b},F=Object.groupBy(t["belongs-to-collection"]??[],a=>"series"===z(a,"collection-type")?"series":"collection"),G=q.title?.find(a=>"main"===z(a,"title-type"))??q.title?.[0],H={identifier:C(a),title:A(G),sortAs:A(G?.props?.["file-as"]?.[0])??G?.attrs?.["file-as"]??u?.["calibre:title_sort"],subtitle:q.title?.find(a=>"subtitle"===z(a,"title-type"))?.value,language:q.language?.map(a=>a.value),description:v(q.description),publisher:B(q.publisher?.[0]),published:q.date?.find(a=>"publication"===a.attrs.event)?.value??v(q.date),modified:v(t[m.dcterms+"modified"])??q.date?.find(a=>"modification"===a.attrs.event)?.value,subject:q.subject?.map(B),belongsTo:{collection:F.collection?.map(D),series:F.series?.map(D)??u?.["calibre:series"]?{name:u?.["calibre:series"],position:parseFloat(u?.["calibre:series_index"])}:null},altIdentifier:q.identifier?.map(E),source:q.source?.map(E),rights:v(q.rights)},I=a=>b=>{let c=new Set(b.role?.map(b=>n[b]??a));return[c.size?c:[a],b]};for(let[a,b]of[].concat(q.creator?.map(B)?.map(I("author"))??[],q.contributor?.map(B)?.map(I("contributor"))??[]))for(let c of a)"publisher"===c&&H.publisher||(H[c]?H[c].push(b):H[c]=[b]);w(H),H.altIdentifier===H.identifier&&delete H.altIdentifier;let J={},K={};for(let[a,b]of Object.entries(t))a.startsWith(m.rendition)?J[p(a.replace(m.rendition,""))]=v(b):a.startsWith(m.media)&&(K[p(a.replace(m.media,""))]=v(b));return K.duration&&(K.duration=y(K.duration)),{metadata:H,rendition:J,media:K}})(h);this.metadata=l,this.rendition=u,this.media=v,this.dir=this.resources.pageProgressionDirection;let z=(a=await this.#B("META-INF/com.apple.ibooks.display-options.xml")??await this.#B("META-INF/com.kobobooks.display-options.xml"))?{fixedLayout:r(a.querySelector('option[name="fixed-layout"]')),openToSpread:r(a.querySelector('option[name="open-to-spread"]'))}:null;return z&&("true"===z.fixedLayout&&(this.rendition.layout??="pre-paginated"),"false"===z.openToSpread&&(this.sections.find(a=>"no"!==a.linear).pageSpread??="rtl"===this.dir?"left":"right")),this}async loadDocument(a){let b=await this.loadText(a.href);return this.parser.parseFromString(b,a.mediaType)}getMediaOverlay(){return new A(this,this.#B.bind(this))}resolveCFI(a){return this.resources.resolveCFI(a)}resolveHref(a){let[b,c]=a.split("#"),d=this.resources.getItemByHref(decodeURI(b));return d?{index:this.resources.spine.findIndex(({idref:a})=>a===d.id),anchor:c?a=>a.getElementById(c)??a.querySelector(`[name="${CSS.escape(c)}"]`):()=>0}:null}splitTOCHref(a){return a?.split("#")??[]}getTOCFragment(a,b){return a.getElementById(b)??a.querySelector(`[name="${CSS.escape(b)}"]`)}isExternal(a){return/^(?!blob)\w+:/i.test(a)}async getCover(){let a=this.resources?.cover;return a?.href?new Blob([await this.loadBlob(a.href)],{type:a.mediaType}):null}async getCalibreBookmarks(){let a=await this.loadText("META-INF/calibre_bookmarks.txt"),b="encoding=json+base64:";if(a?.startsWith(b))return JSON.parse(atob(a.slice(b.length)))}destroy(){this.#y?.destroy()}}a.s(["EPUB",()=>I])}];

//# sourceMappingURL=packages_foliate-js_epub_b1bb2d68.js.map