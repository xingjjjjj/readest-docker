module.exports=[986055,a=>{"use strict";var b=a.i(177898);async function c(a={}){return"object"==typeof a&&Object.freeze(a),await (0,b.invoke)("plugin:dialog|open",{options:a})}async function d(a={}){return"object"==typeof a&&Object.freeze(a),await (0,b.invoke)("plugin:dialog|save",{options:a})}a.s(["open",()=>c,"save",()=>d])},681304,a=>{"use strict";let b=async(a,b,c)=>{let d=[];try{d=await a.readDirectory(b,"None")}catch{throw Error(`Dir ${b} failed to read.`)}for(let e=0;e<d.length;e++){let f=d[e],g=`${b}/${f.path}`,h=`${c}/${f.path}`;await a.copyFile(g,h,"None")}let e=await a.readDirectory(c,"None");for(let a of d)if(!e.find(b=>b.path===a.path&&b.size===a.size))throw Error(`File ${a.path} failed to copy.`)};a.s(["copyFiles",0,b])},709376,a=>a.a(async(b,c)=>{try{var d=a.i(943221),e=a.i(138559),f=a.i(177898),g=a.i(986055),h=a.i(607032),i=a.i(413414),j=a.i(465863),k=a.i(589911),l=a.i(750740),m=a.i(545251),n=a.i(681304),o=a.i(843660),p=a.i(654617),q=b([i,o]);[i,o]=q.then?(await q)():q;let r=null,s=()=>(null===r&&(r=(0,h.type)()),r),t=({customRootDir:a,isPortable:b,execDir:c}={})=>{let d=a?0:void 0,f=!!a,g=f?b=>()=>{let c=["Settings","Data","Books","Fonts","Images"].includes(b)?"":b;return c?`${a}/${c}`:a}:void 0,h=g?a=>async()=>g(a)():void 0;return(a,i)=>{let j=g?.(i),k=h?.(i);switch(i){case"Settings":return{baseDir:b?0:e.BaseDirectory.AppConfig,basePrefix:b&&c?async()=>c:e.appConfigDir,fp:b&&c?`${c}${a?`/${a}`:""}`:a,base:i};case"Cache":return{baseDir:e.BaseDirectory.AppCache,basePrefix:e.appCacheDir,fp:a,base:i};case"Log":return{baseDir:f?0:e.BaseDirectory.AppLog,basePrefix:k??e.appLogDir,fp:j?`${j()}${a?`/${a}`:""}`:a,base:i};case"Data":return{baseDir:d??e.BaseDirectory.AppData,basePrefix:k??e.appDataDir,fp:j?`${j()}/${p.DATA_SUBDIR}${a?`/${a}`:""}`:`${p.DATA_SUBDIR}${a?`/${a}`:""}`,base:i};case"Books":return{baseDir:d??e.BaseDirectory.AppData,basePrefix:k||e.appDataDir,fp:j?`${j()}/${p.LOCAL_BOOKS_SUBDIR}${a?`/${a}`:""}`:`${p.LOCAL_BOOKS_SUBDIR}${a?`/${a}`:""}`,base:i};case"Fonts":return{baseDir:d??e.BaseDirectory.AppData,basePrefix:k||e.appDataDir,fp:j?`${j()}/${p.LOCAL_FONTS_SUBDIR}${a?`/${a}`:""}`:`${p.LOCAL_FONTS_SUBDIR}${a?`/${a}`:""}`,base:i};case"Images":return{baseDir:d??e.BaseDirectory.AppData,basePrefix:k||e.appDataDir,fp:j?`${j()}/${p.LOCAL_IMAGES_SUBDIR}${a?`/${a}`:""}`:`${p.LOCAL_IMAGES_SUBDIR}${a?`/${a}`:""}`,base:i};case"None":return{baseDir:0,basePrefix:async()=>"",fp:a,base:i};default:return{baseDir:e.BaseDirectory.Temp,basePrefix:e.tempDir,fp:a,base:i}}}},u={resolvePath:t(),async getPrefix(a){let{basePrefix:b,fp:c,baseDir:d}=this.resolvePath("",a),f=await b();return f=f.replace(/\/+$/,""),c?0===d?c:await (0,e.join)(f,c):f},getURL:a=>(0,j.isValidURL)(a)?a:(0,f.convertFileSrc)(a),async getBlobURL(a,b){let c=await this.readFile(a,b,"binary");return URL.createObjectURL(new Blob([c]))},async getImageURL(a){return this.getURL(a)},async openFile(a,b,c){let{fp:d,baseDir:f}=this.resolvePath(a,b),g=c||(0,k.getFilename)(d);if((0,j.isValidURL)(a))return await new l.RemoteFile(a,g).open();if((0,j.isContentURI)(a)||(0,j.isFileURI)(a)&&"ios"===s()){if(g=await (0,e.basename)(a),a.includes("com.android.externalstorage"))return await new l.NativeFile(d,g,f||null).open();{let b=await this.getPrefix("Cache"),c=await (0,e.join)(b,decodeURIComponent(g)),d=await (0,m.copyURIToPath)({uri:a,dst:c});if(!d.success)throw console.error("Failed to open file:",d),Error("Failed to open file");return await new l.NativeFile(c,g,f||null).open()}}{if((0,j.isFileURI)(a)||"android"===s())return await new l.NativeFile(d,g,f||null).open();let c=await this.getPrefix(b),h=c?await (0,e.join)(c,a):a;return await new l.RemoteFile(this.getURL(h),g).open()}},async copyFile(a,b,c){try{await this.exists((0,k.getDirPath)(b),c)||await this.createDir((0,k.getDirPath)(b),c,!0)}catch(a){console.log("Failed to create directory for copying file:",a)}if((0,j.isContentURI)(a)){let d=await this.getPrefix(c);if(!d)throw Error("Invalid base directory");let f=await (0,m.copyURIToPath)({uri:a,dst:await (0,e.join)(d,b)});if(!f.success)throw console.error("Failed to copy file:",f),Error("Failed to copy file")}else{let{fp:e,baseDir:f}=this.resolvePath(b,c);await (0,d.copyFile)(a,e,f?{toPathBaseDir:f}:void 0)}},async readFile(a,b,c){let{fp:e,baseDir:f}=this.resolvePath(a,b);return"text"===c?(0,d.readTextFile)(e,f?{baseDir:f}:void 0):(await (0,d.readFile)(e,f?{baseDir:f}:void 0)).buffer},async writeFile(a,b,c){let{fp:e,baseDir:f}=this.resolvePath(a,b);return(await this.exists((0,k.getDirPath)(a),b)||await this.createDir((0,k.getDirPath)(a),b,!0),"string"==typeof c)?(0,d.writeTextFile)(e,c,f?{baseDir:f}:void 0):c instanceof File?await (0,d.writeFile)(e,c.stream(),{write:!0,create:!0,baseDir:f||void 0}):await (0,d.writeFile)(e,new Uint8Array(c),f?{baseDir:f}:void 0)},async removeFile(a,b){let{fp:c,baseDir:e}=this.resolvePath(a,b);await (0,d.remove)(c,e?{baseDir:e}:void 0)},async createDir(a,b,c=!1){let{fp:e,baseDir:f}=this.resolvePath(a,b);await (0,d.mkdir)(e,{baseDir:f||void 0,recursive:c})},async removeDir(a,b,c=!1){let{fp:e,baseDir:f}=this.resolvePath(a,b);await (0,d.remove)(e,{baseDir:f||void 0,recursive:c})},async readDir(a,b){let{fp:c,baseDir:g}=this.resolvePath(a,b);if(!g||0===g)try{return(await (0,f.invoke)("read_dir",{path:c,recursive:!0,extensions:["*"]})).map(a=>{var b;let d;return{path:(b=a.path,d=b,b.toLowerCase().startsWith(c.toLowerCase())&&(d=b.substring(c.length)),(d.startsWith("\\")||d.startsWith("/"))&&(d=d.substring(1)),d),size:a.size}})}catch(a){console.error("Rust read_dir failed, falling back to JS recursion",a)}let h=await (0,d.readDir)(c,g?{baseDir:g}:void 0),i=[],j=async(a,b,c,f)=>{for(let h of c)if(h.isDirectory){let c=await (0,e.join)(a,h.name),i=b?await (0,e.join)(b,h.name):h.name;try{let a=await (0,d.readDir)(c,g?{baseDir:g}:void 0);await j(c,i,a,f)}catch{console.warn(`Skipping unreadable dir: ${c}`)}}else{let c=await (0,e.join)(a,h.name),i=b?await (0,e.join)(b,h.name):h.name,j=g?{baseDir:g}:void 0,k=await (0,d.stat)(c,j).then(a=>a.size).catch(()=>0);f.push({path:i,size:k})}};return await j(c,"",h,i),i},async exists(a,b){let{fp:c,baseDir:e}=this.resolvePath(a,b);try{return await (0,d.exists)(c,e?{baseDir:e}:void 0)}catch{return!1}},async stats(a,b){let{fp:c,baseDir:e}=this.resolvePath(a,b);return await (0,d.stat)(c,e?{baseDir:e}:void 0)}},v=process.env.NEXT_PUBLIC_DIST_CHANNEL||"readest";class w extends o.BaseAppService{fs=u;appPlatform="tauri";isAppDataSandbox=!1;isMobile=!1;isAndroidApp=!1;isIOSApp=!1;isMacOSApp=!1;isLinuxApp=!1;isMobileApp=!1;isDesktopApp=!1;isEink=!!window.__READEST_IS_EINK;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir="appstore"!==v;canReadExternalDir="appstore"!==v&&"playstore"!==v;distChannel=v;execDir=void 0;async init(){let a=s();this.isAppDataSandbox=["android","ios"].includes(a),this.isMobile=["android","ios"].includes(a),this.isAndroidApp="android"===a,this.isIOSApp="ios"===a,this.isMacOSApp="macos"===a,this.isLinuxApp="linux"===a,this.isMobileApp=["android","ios"].includes(a),this.isDesktopApp=["macos","windows","linux"].includes(a),this.hasTrafficLight="macos"===a,this.hasWindow="ios"!==a&&"android"!==a,this.hasWindowBar="ios"!==a&&"android"!==a,this.hasContextMenu="ios"!==a&&"android"!==a,this.hasRoundedWindow="linux"===a,this.hasSafeAreaInset="ios"===a||"android"===a,this.hasHaptics="ios"===a||"android"===a,this.hasUpdater="ios"!==a&&!process.env.NEXT_PUBLIC_DISABLE_UPDATER&&!window.__READEST_UPDATER_DISABLED,this.hasOrientationLock="ios"===a&&"ios"===(0,j.getOSPlatform)()||"android"===a,this.hasScreenBrightness="ios"===a||"android"===a,this.hasIAP="ios"===a||"android"===a&&"playstore"===v;let b=await (0,f.invoke)("get_executable_dir");this.execDir=b,(process.env.NEXT_PUBLIC_PORTABLE_APP||await this.fs.exists(`${b}/${p.SETTINGS_FILENAME}`,"None"))&&(this.isPortableApp=!0,this.fs.resolvePath=t({customRootDir:b,isPortable:this.isPortableApp,execDir:b}));let c=await this.loadSettings();c.customRootDir&&(this.fs.resolvePath=t({customRootDir:c.customRootDir,isPortable:this.isPortableApp,execDir:b})),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let a=await this.loadSettings(),b=a.migrationVersion||0;if(await super.runMigrations(b),b<0x1350195)try{await this.migrate20251029()}catch(a){console.error("Error migrating to version 20251029:",a)}b<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...a,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(a){console.error("Failed to run migrations:",a)}}resolvePath(a,b){return this.fs.resolvePath(a,b)}async setCustomRootDir(a){this.fs.resolvePath=t({customRootDir:a,isPortable:this.isPortableApp,execDir:this.execDir}),await this.prepareBooksDir()}async selectDirectory(){return await (0,g.open)({directory:!0,multiple:!1,recursive:!0})}async selectFiles(a,b){let c=await (0,g.open)({multiple:!0,filters:[{name:a,extensions:b}]});return Array.isArray(c)?c:c?[c]:[]}async saveFile(a,b,c,e){try{let f=a.split(".").pop()||"";if(this.isIOSApp)await (0,i.shareFile)(c,{mimeType:e||"application/octet-stream"});else{let c=await (0,g.save)({defaultPath:a,filters:[{name:f.toUpperCase(),extensions:[f]}]});if(!c)return!1;"string"==typeof b?await (0,d.writeTextFile)(c,b):await (0,d.writeFile)(c,new Uint8Array(b))}return!0}catch(a){return console.error("Failed to save file:",a),!1}}async migrate20251029(){console.log("Running migration 20251029 to update paths in Images dir...");let a=await this.resolveFilePath("..","Data"),b=await this.fs.getPrefix("Images"),c=await (0,e.join)(a,"Images","Readest","Images");await (0,n.copyFiles)(this,c,b);let d=await (0,e.join)(a,"Images","Readest");await this.deleteDir(d,"None",!0)}}a.s(["NativeAppService",()=>w,"nativeFileSystem",0,u]),c()}catch(a){c(a)}},!1)];

//# sourceMappingURL=_efc332e3._.js.map