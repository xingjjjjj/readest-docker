{"version":3,"sources":["../../../../../../packages/foliate-js/tts.js"],"sourcesContent":["const NS = {\n    XML: 'http://www.w3.org/XML/1998/namespace',\n    SSML: 'http://www.w3.org/2001/10/synthesis',\n}\n\nconst blockTags = new Set([\n    'article', 'aside', 'audio', 'blockquote', 'caption',\n    'details', 'dialog', 'div', 'dl', 'dt', 'dd',\n    'figure', 'footer', 'form', 'figcaption',\n    'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'header', 'hgroup', 'hr', 'li',\n    'main', 'math', 'nav', 'ol', 'p', 'pre', 'section', 'tr',\n])\n\nconst getLang = el => {\n    const x = el.lang || el?.getAttributeNS?.(NS.XML, 'lang')\n    return x ? x : el.parentElement ? getLang(el.parentElement) : null\n}\n\nconst getAlphabet = el => {\n    const x = el?.getAttributeNS?.(NS.XML, 'lang')\n    return x ? x : el.parentElement ? getAlphabet(el.parentElement) : null\n}\n\nconst getSegmenter = (lang = 'en', granularity = 'word') => {\n    const segmenter = new Intl.Segmenter(lang, { granularity })\n    const granularityIsWord = granularity === 'word'\n    return function* (strs, makeRange) {\n        const str = strs.join('').replace(/\\r\\n/g, '  ').replace(/\\r/g, ' ').replace(/\\n/g, ' ')\n        let name = 0\n        let strIndex = -1\n        let sum = 0\n        const rawSegments = Array.from(segmenter.segment(str))\n        const mergedSegments = []\n        for (let i = 0; i < rawSegments.length; i++) {\n            const current = rawSegments[i]\n            const next = rawSegments[i + 1]\n            const segment = current.segment.trim()\n            const nextSegment = next?.segment?.trim()\n            const endsWithAbbr = /(?:^|\\s)([A-Z][a-z]{1,5})\\.$/.test(segment)\n            const nextStartsWithCapital = /^[A-Z]/.test(nextSegment || '')\n            if (endsWithAbbr && nextStartsWithCapital) {\n                const mergedSegment = {\n                    index: current.index,\n                    segment: current.segment + (next?.segment || ''),\n                    isWordLike: true,\n                }\n                mergedSegments.push(mergedSegment)\n                i++\n            } else {\n                mergedSegments.push(current)\n            }\n        }\n        for (const { index, segment, isWordLike } of mergedSegments) {\n            if (granularityIsWord && !isWordLike) continue\n            while (sum <= index) sum += strs[++strIndex].length\n            const startIndex = strIndex\n            const startOffset = index - (sum - strs[strIndex].length)\n            const end = index + segment.length - 1\n            if (end < str.length) while (sum <= end) sum += strs[++strIndex].length\n            const endIndex = strIndex\n            const endOffset = end - (sum - strs[strIndex].length) + 1\n            yield [(name++).toString(),\n                makeRange(startIndex, startOffset, endIndex, endOffset)]\n        }\n    }\n}\n\nconst fragmentToSSML = (fragment, nodeFilter, inherited) => {\n    const ssml = document.implementation.createDocument(NS.SSML, 'speak')\n    const { lang } = inherited\n    if (lang) ssml.documentElement.setAttributeNS(NS.XML, 'lang', lang)\n\n    const convert = (node, parent, inheritedAlphabet) => {\n        if (!node) return\n        if (node.nodeType === 3) return ssml.createTextNode(node.textContent)\n        if (node.nodeType === 4) return ssml.createCDATASection(node.textContent)\n        if (node.nodeType !== 1 && node.nodeType !== 11) return\n        if (nodeFilter && nodeFilter(node) === NodeFilter.FILTER_REJECT) return\n\n        let el\n        const nodeName = node.nodeName.toLowerCase()\n        if (nodeName === 'foliate-mark') {\n            el = ssml.createElementNS(NS.SSML, 'mark')\n            el.setAttribute('name', node.dataset.name)\n        }\n        else if (nodeName === 'br')\n            el = ssml.createElementNS(NS.SSML, 'break')\n        else if (nodeName === 'em' || nodeName === 'strong')\n            el = ssml.createElementNS(NS.SSML, 'emphasis')\n\n        const lang = node.lang || node.getAttributeNS?.(NS.XML, 'lang')\n        if (lang) {\n            if (!el) el = ssml.createElementNS(NS.SSML, 'lang')\n            el.setAttributeNS(NS.XML, 'lang', lang)\n        }\n\n        const alphabet = node.getAttributeNS?.(NS.SSML, 'alphabet') || inheritedAlphabet\n        if (!el) {\n            const ph = node.getAttributeNS?.(NS.SSML, 'ph')\n            if (ph) {\n                el = ssml.createElementNS(NS.SSML, 'phoneme')\n                if (alphabet) el.setAttribute('alphabet', alphabet)\n                el.setAttribute('ph', ph)\n            }\n        }\n\n        if (!el) el = parent\n\n        let child = node.firstChild\n        while (child) {\n            const childEl = convert(child, el, alphabet)\n            if (childEl && el !== childEl) el.append(childEl)\n            child = child.nextSibling\n        }\n        return el\n    }\n    convert(fragment, ssml.documentElement, inherited.alphabet)\n    return ssml\n}\n\nconst getFragmentWithMarks = (range, textWalker, nodeFilter, granularity) => {\n    const lang = getLang(range.commonAncestorContainer)\n    const alphabet = getAlphabet(range.commonAncestorContainer)\n\n    const segmenter = getSegmenter(lang, granularity)\n    const fragment = range.cloneContents()\n\n    // we need ranges on both the original document (for highlighting)\n    // and the document fragment (for inserting marks)\n    // so unfortunately need to do it twice, as you can't copy the ranges\n    const entries = [...textWalker(range, segmenter, nodeFilter)]\n    const fragmentEntries = [...textWalker(fragment, segmenter, nodeFilter)]\n\n    for (const [name, range] of fragmentEntries) {\n        const mark = document.createElement('foliate-mark')\n        mark.dataset.name = name\n        range.insertNode(mark)\n    }\n    const ssml = fragmentToSSML(fragment, nodeFilter, { lang, alphabet })\n    return { entries, ssml }\n}\n\nconst rangeIsEmpty = range => !range.toString().trim()\n\nfunction* getBlocks(doc) {\n    let last\n    const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT)\n    for (let node = walker.nextNode(); node; node = walker.nextNode()) {\n        const name = node.tagName.toLowerCase()\n        if (blockTags.has(name)) {\n            if (last) {\n                last.setEndBefore(node)\n                if (!rangeIsEmpty(last)) yield last\n            }\n            last = doc.createRange()\n            last.setStart(node, 0)\n        }\n    }\n    if (!last) {\n        last = doc.createRange()\n        last.setStart(doc.body.firstChild ?? doc.body, 0)\n    }\n    last.setEndAfter(doc.body.lastChild ?? doc.body)\n    if (!rangeIsEmpty(last)) yield last\n}\n\nclass ListIterator {\n    #arr = []\n    #iter\n    #index = -1\n    #f\n    constructor(iter, f = x => x) {\n        this.#iter = iter\n        this.#f = f\n    }\n    current() {\n        if (this.#arr[this.#index]) return this.#f(this.#arr[this.#index])\n    }\n    first() {\n        const newIndex = 0\n        if (this.#arr[newIndex]) {\n            this.#index = newIndex\n            return this.#f(this.#arr[newIndex])\n        }\n    }\n    prev() {\n        const newIndex = this.#index - 1\n        if (this.#arr[newIndex]) {\n            this.#index = newIndex\n            return this.#f(this.#arr[newIndex])\n        }\n    }\n    next() {\n        const newIndex = this.#index + 1\n        if (this.#arr[newIndex]) {\n            this.#index = newIndex\n            return this.#f(this.#arr[newIndex])\n        }\n        while (true) {\n            const { done, value } = this.#iter.next()\n            if (done) break\n            this.#arr.push(value)\n            if (this.#arr[newIndex]) {\n                this.#index = newIndex\n                return this.#f(this.#arr[newIndex])\n            }\n        }\n    }\n    find(f) {\n        const index = this.#arr.findIndex(x => f(x))\n        if (index > -1) {\n            this.#index = index\n            return this.#f(this.#arr[index])\n        }\n        while (true) {\n            const { done, value } = this.#iter.next()\n            if (done) break\n            this.#arr.push(value)\n            if (f(value)) {\n                this.#index = this.#arr.length - 1\n                return this.#f(value)\n            }\n        }\n    }\n}\n\nexport class TTS {\n    #list\n    #ranges\n    #lastMark\n    #serializer = new XMLSerializer()\n    constructor(doc, textWalker, nodeFilter, highlight, granularity) {\n        this.doc = doc\n        this.highlight = highlight\n        this.#list = new ListIterator(getBlocks(doc), range => {\n            const { entries, ssml } = getFragmentWithMarks(range, textWalker, nodeFilter, granularity)\n            this.#ranges = new Map(entries)\n            return [ssml, range]\n        })\n    }\n    #getMarkElement(doc, mark) {\n        if (!mark) return null\n        return doc.querySelector(`mark[name=\"${CSS.escape(mark)}\"`)\n    }\n    #speak(doc, getNode) {\n        if (!doc) return\n        if (!getNode) return this.#serializer.serializeToString(doc)\n        const ssml = document.implementation.createDocument(NS.SSML, 'speak')\n        ssml.documentElement.replaceWith(ssml.importNode(doc.documentElement, true))\n        let node = getNode(ssml)?.previousSibling\n        while (node) {\n            const next = node.previousSibling ?? node.parentNode?.previousSibling\n            node.parentNode.removeChild(node)\n            node = next\n        }\n        const ssmlStr = this.#serializer.serializeToString(ssml)\n        return ssmlStr\n    }\n    start() {\n        this.#lastMark = null\n        const [doc] = this.#list.first() ?? []\n        if (!doc) return this.next()\n        return this.#speak(doc, ssml => this.#getMarkElement(ssml, this.#lastMark))\n    }\n    resume() {\n        const [doc] = this.#list.current() ?? []\n        if (!doc) return this.next()\n        return this.#speak(doc, ssml => this.#getMarkElement(ssml, this.#lastMark))\n    }\n    prev(paused) {\n        this.#lastMark = null\n        const [doc, range] = this.#list.prev() ?? []\n        if (paused && range) this.highlight(range.cloneRange())\n        return this.#speak(doc)\n    }\n    next(paused) {\n        this.#lastMark = null\n        const [doc, range] = this.#list.next() ?? []\n        if (paused && range) this.highlight(range.cloneRange())\n        return this.#speak(doc)\n    }\n    prevMark(paused) {\n        const marks = Array.from(this.#ranges.keys())\n        if (marks.length === 0) return\n\n        const currentIndex = this.#lastMark ? marks.indexOf(this.#lastMark) : -1\n        if (currentIndex > 0) {\n            const prevMarkName = marks[currentIndex - 1]\n            const range = this.#ranges.get(prevMarkName)\n            if (range) {\n                this.#lastMark = prevMarkName\n                if (paused) this.highlight(range.cloneRange())\n\n                const [doc] = this.#list.current() ?? []\n                return this.#speak(doc, ssml => this.#getMarkElement(ssml, prevMarkName))\n            }\n        } else {\n            const [doc, range] = this.#list.prev() ?? []\n            if (doc && range) {\n                const prevMarks = Array.from(this.#ranges.keys())\n                if (prevMarks.length > 0) {\n                    const lastMarkName = prevMarks[prevMarks.length - 1]\n                    const lastMarkRange = this.#ranges.get(lastMarkName)\n                    if (lastMarkRange) {\n                        this.#lastMark = lastMarkName\n                        if (paused) this.highlight(lastMarkRange.cloneRange())\n                        return this.#speak(doc, ssml => this.#getMarkElement(ssml, lastMarkName))\n                    }\n                } else {\n                    this.#lastMark = null\n                    if (paused) this.highlight(range.cloneRange())\n                    return this.#speak(doc)\n                }\n            }\n        }\n    }\n    nextMark(paused) {\n        const marks = Array.from(this.#ranges.keys())\n        if (marks.length === 0) return\n\n        const currentIndex = this.#lastMark ? marks.indexOf(this.#lastMark) : -1\n        if (currentIndex >= 0 && currentIndex < marks.length - 1) {\n            const nextMarkName = marks[currentIndex + 1]\n            const range = this.#ranges.get(nextMarkName)\n            if (range) {\n                this.#lastMark = nextMarkName\n                if (paused) this.highlight(range.cloneRange())\n                const [doc] = this.#list.current() ?? []\n                return this.#speak(doc, ssml => this.#getMarkElement(ssml, nextMarkName))\n            }\n        } else {\n            const [doc, range] = this.#list.next() ?? []\n            if (doc && range) {\n                const nextMarks = Array.from(this.#ranges.keys())\n                if (nextMarks.length > 0) {\n                    const firstMarkName = nextMarks[0]\n                    const firstMarkRange = this.#ranges.get(firstMarkName)\n                    if (firstMarkRange) {\n                        this.#lastMark = firstMarkName\n                        if (paused) this.highlight(firstMarkRange.cloneRange())\n                        return this.#speak(doc, ssml => this.#getMarkElement(ssml, firstMarkName))\n                    }\n                } else {\n                    this.#lastMark = null\n                    if (paused) this.highlight(range.cloneRange())\n                    return this.#speak(doc)\n                }\n            }\n        }\n    }\n    from(range) {\n        this.#lastMark = null\n        const [doc] = this.#list.find(range_ =>\n            range.compareBoundaryPoints(Range.END_TO_START, range_) <= 0)\n        let mark\n        for (const [name, range_] of this.#ranges.entries())\n            if (range.compareBoundaryPoints(Range.START_TO_START, range_) <= 0) {\n                mark = name\n                break\n            }\n        return this.#speak(doc, ssml => this.#getMarkElement(ssml, mark))\n    }\n    setMark(mark) {\n        const range = this.#ranges.get(mark)\n        if (range) {\n            this.#lastMark = mark\n            this.highlight(range.cloneRange())\n            return range\n        }\n    }\n}\n"],"names":[],"mappings":"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"}