{"version":3,"sources":["../../../../../../packages/foliate-js/search.js"],"sourcesContent":["// length for context in excerpts\nconst CONTEXT_LENGTH = 50\n\nconst normalizeWhitespace = str => str.replace(/\\s+/g, ' ')\n\nconst makeExcerpt = (strs, { startIndex, startOffset, endIndex, endOffset }) => {\n    const start = strs[startIndex]\n    const end = strs[endIndex]\n    const match = start === end\n        ? start.slice(startOffset, endOffset)\n        : start.slice(startOffset)\n            + strs.slice(start + 1, end).join('')\n            + end.slice(0, endOffset)\n    const trimmedStart = normalizeWhitespace(start.slice(0, startOffset)).trimStart()\n    const trimmedEnd = normalizeWhitespace(end.slice(endOffset)).trimEnd()\n    const ellipsisPre = trimmedStart.length < CONTEXT_LENGTH ? '' : '…'\n    const ellipsisPost = trimmedEnd.length < CONTEXT_LENGTH ? '' : '…'\n    const pre = `${ellipsisPre}${trimmedStart.slice(-CONTEXT_LENGTH)}`\n    const post = `${trimmedEnd.slice(0, CONTEXT_LENGTH)}${ellipsisPost}`\n    return { pre, match, post }\n}\n\nconst simpleSearch = function* (strs, query, options = {}) {\n    const { locales = 'en', sensitivity } = options\n    const matchCase = sensitivity === 'variant'\n    const haystack = strs.join('')\n    const lowerHaystack = matchCase ? haystack : haystack.toLocaleLowerCase(locales)\n    const needle = matchCase ? query : query.toLocaleLowerCase(locales)\n    const needleLength = needle.length\n    let index = -1\n    let strIndex = -1\n    let sum = 0\n    do {\n        index = lowerHaystack.indexOf(needle, index + 1)\n        if (index > -1) {\n            while (sum <= index) sum += strs[++strIndex].length\n            const startIndex = strIndex\n            const startOffset = index - (sum - strs[strIndex].length)\n            const end = index + needleLength\n            while (sum <= end) sum += strs[++strIndex].length\n            const endIndex = strIndex\n            const endOffset = end - (sum - strs[strIndex].length)\n            const range = { startIndex, startOffset, endIndex, endOffset }\n            yield { range, excerpt: makeExcerpt(strs, range) }\n        }\n    } while (index > -1)\n}\n\nconst segmenterSearch = function* (strs, query, options = {}) {\n    const { locales = 'en', granularity = 'word', sensitivity = 'base' } = options\n    let segmenter, collator\n    try {\n        segmenter = new Intl.Segmenter(locales, { usage: 'search', granularity })\n        collator = new Intl.Collator(locales, { sensitivity })\n    } catch (e) {\n        console.warn(e)\n        segmenter = new Intl.Segmenter('en', { usage: 'search', granularity })\n        collator = new Intl.Collator('en', { sensitivity })\n    }\n    const queryLength = Array.from(segmenter.segment(query)).length\n\n    const substrArr = []\n    let strIndex = 0\n    let segments = segmenter.segment(strs[strIndex])[Symbol.iterator]()\n    main: while (strIndex < strs.length) {\n        while (substrArr.length < queryLength) {\n            const { done, value } = segments.next()\n            if (done) {\n                // the current string is exhausted\n                // move on to the next string\n                strIndex++\n                if (strIndex < strs.length) {\n                    segments = segmenter.segment(strs[strIndex])[Symbol.iterator]()\n                    continue\n                } else break main\n            }\n            const { index, segment } = value\n            // ignore formatting characters\n            if (!/[^\\p{Format}]/u.test(segment)) continue\n            // normalize whitespace\n            if (/\\s/u.test(segment)) {\n                if (!/\\s/u.test(substrArr[substrArr.length - 1]?.segment))\n                    substrArr.push({ strIndex, index, segment: ' ' })\n                continue\n            }\n            value.strIndex = strIndex\n            substrArr.push(value)\n        }\n        const substr = substrArr.map(x => x.segment).join('')\n        if (collator.compare(query, substr) === 0) {\n            const endIndex = strIndex\n            const lastSeg = substrArr[substrArr.length - 1]\n            const endOffset = lastSeg.index + lastSeg.segment.length\n            const startIndex = substrArr[0].strIndex\n            const startOffset = substrArr[0].index\n            const range = { startIndex, startOffset, endIndex, endOffset }\n            yield { range, excerpt: makeExcerpt(strs, range) }\n        }\n        substrArr.shift()\n    }\n}\n\nexport const search = (strs, query, options) => {\n    const { granularity = 'grapheme', sensitivity = 'base' } = options\n    if (!Intl?.Segmenter || granularity === 'grapheme'\n    && (sensitivity === 'variant' || sensitivity === 'accent'))\n        return simpleSearch(strs, query, options)\n    return segmenterSearch(strs, query, options)\n}\n\nexport const searchMatcher = (textWalker, opts) => {\n    const { defaultLocale, matchCase, matchDiacritics, matchWholeWords, acceptNode } = opts\n    return function* (doc, query) {\n        const iter = textWalker(doc, function* (strs, makeRange) {\n            for (const result of search(strs, query, {\n                locales: doc.body.lang || doc.documentElement.lang || defaultLocale || 'en',\n                granularity: matchWholeWords ? 'word' : 'grapheme',\n                sensitivity: matchDiacritics && matchCase ? 'variant'\n                : matchDiacritics && !matchCase ? 'accent'\n                : !matchDiacritics && matchCase ? 'case'\n                : 'base',\n            })) {\n                const { startIndex, startOffset, endIndex, endOffset } = result.range\n                result.range = makeRange(startIndex, startOffset, endIndex, endOffset)\n                yield result\n            }\n        }, acceptNode)\n        for (const result of iter) yield result\n    }\n}\n"],"names":[],"mappings":"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"}