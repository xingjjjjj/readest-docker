module.exports=[463783,373852,e=>{"use strict";var t,i,a,r,o=e.i(826165);async function s(){return(0,o.invoke)("plugin:path|resolve_directory",{directory:a.AppConfig})}async function n(){return(0,o.invoke)("plugin:path|resolve_directory",{directory:a.AppData})}async function l(){return(0,o.invoke)("plugin:path|resolve_directory",{directory:a.AppCache})}async function c(){return(0,o.invoke)("plugin:path|resolve_directory",{directory:a.AppLog})}async function h(){return(0,o.invoke)("plugin:path|resolve_directory",{directory:a.Temp})}async function f(...e){return(0,o.invoke)("plugin:path|join",{paths:e})}async function d(e,t){return(0,o.invoke)("plugin:path|basename",{path:e,ext:t})}(t=a||(a={}))[t.Audio=1]="Audio",t[t.Cache=2]="Cache",t[t.Config=3]="Config",t[t.Data=4]="Data",t[t.LocalData=5]="LocalData",t[t.Document=6]="Document",t[t.Download=7]="Download",t[t.Picture=8]="Picture",t[t.Public=9]="Public",t[t.Video=10]="Video",t[t.Resource=11]="Resource",t[t.Temp=12]="Temp",t[t.AppConfig=13]="AppConfig",t[t.AppData=14]="AppData",t[t.AppLocalData=15]="AppLocalData",t[t.AppCache=16]="AppCache",t[t.AppLog=17]="AppLog",t[t.Desktop=18]="Desktop",t[t.Executable=19]="Executable",t[t.Font=20]="Font",t[t.Home=21]="Home",t[t.Runtime=22]="Runtime",t[t.Template=23]="Template",e.s(["BaseDirectory",()=>a,"appCacheDir",()=>l,"appConfigDir",()=>s,"appDataDir",()=>n,"appLogDir",()=>c,"basename",()=>d,"join",()=>f,"tempDir",()=>h],373852);var u=o;function g(e){return{isFile:e.isFile,isDirectory:e.isDirectory,isSymlink:e.isSymlink,size:e.size,mtime:null!==e.mtime?new Date(e.mtime):null,atime:null!==e.atime?new Date(e.atime):null,birthtime:null!==e.birthtime?new Date(e.birthtime):null,readonly:e.readonly,fileAttributes:e.fileAttributes,dev:e.dev,ino:e.ino,mode:e.mode,nlink:e.nlink,uid:e.uid,gid:e.gid,rdev:e.rdev,blksize:e.blksize,blocks:e.blocks}}(i=r||(r={}))[i.Start=0]="Start",i[i.Current=1]="Current",i[i.End=2]="End";class p extends u.Resource{async read(e){if(0===e.byteLength)return 0;let t=await (0,u.invoke)("plugin:fs|read",{rid:this.rid,len:e.byteLength}),i=function(e){let t=new Uint8ClampedArray(e),i=t.byteLength,a=0;for(let e=0;e<i;e++)a*=256,a+=t[e];return a}(t.slice(-8)),a=t instanceof ArrayBuffer?new Uint8Array(t):t;return e.set(a.slice(0,a.length-8)),0===i?null:i}async seek(e,t){return await (0,u.invoke)("plugin:fs|seek",{rid:this.rid,offset:e,whence:t})}async stat(){return g(await (0,u.invoke)("plugin:fs|fstat",{rid:this.rid}))}async truncate(e){await (0,u.invoke)("plugin:fs|ftruncate",{rid:this.rid,len:e})}async write(e){return await (0,u.invoke)("plugin:fs|write",{rid:this.rid,data:e})}}async function m(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return new p(await (0,u.invoke)("plugin:fs|open",{path:e instanceof URL?e.toString():e,options:t}))}async function w(e,t,i){if(e instanceof URL&&"file:"!==e.protocol||t instanceof URL&&"file:"!==t.protocol)throw TypeError("Must be a file URL.");await (0,u.invoke)("plugin:fs|copy_file",{fromPath:e instanceof URL?e.toString():e,toPath:t instanceof URL?t.toString():t,options:i})}async function y(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");await (0,u.invoke)("plugin:fs|mkdir",{path:e instanceof URL?e.toString():e,options:t})}async function b(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return await (0,u.invoke)("plugin:fs|read_dir",{path:e instanceof URL?e.toString():e,options:t})}async function k(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let i=await (0,u.invoke)("plugin:fs|read_file",{path:e instanceof URL?e.toString():e,options:t});return i instanceof ArrayBuffer?new Uint8Array(i):Uint8Array.from(i)}async function S(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let i=await (0,u.invoke)("plugin:fs|read_text_file",{path:e instanceof URL?e.toString():e,options:t}),a=i instanceof ArrayBuffer?i:Uint8Array.from(i);return new TextDecoder().decode(a)}async function F(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");await (0,u.invoke)("plugin:fs|remove",{path:e instanceof URL?e.toString():e,options:t})}async function v(e,t){return g(await (0,u.invoke)("plugin:fs|stat",{path:e instanceof URL?e.toString():e,options:t}))}async function E(e,t,i){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");if(t instanceof ReadableStream){let a=await m(e,{read:!1,create:!0,write:!0,...i}),r=t.getReader();try{for(;;){let{done:e,value:t}=await r.read();if(e)break;await a.write(t)}}finally{r.releaseLock(),await a.close()}}else await (0,u.invoke)("plugin:fs|write_file",t,{headers:{path:encodeURIComponent(e instanceof URL?e.toString():e),options:JSON.stringify(i)}})}async function B(e,t,i){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let a=new TextEncoder;await (0,u.invoke)("plugin:fs|write_text_file",a.encode(t),{headers:{path:encodeURIComponent(e instanceof URL?e.toString():e),options:JSON.stringify(i)}})}async function A(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return await (0,u.invoke)("plugin:fs|exists",{path:e instanceof URL?e.toString():e,options:t})}u.Resource,e.s(["SeekMode",()=>r,"copyFile",()=>w,"exists",()=>A,"mkdir",()=>y,"open",()=>m,"readDir",()=>b,"readFile",()=>k,"readTextFile",()=>S,"remove",()=>F,"stat",()=>v,"writeFile",()=>E,"writeTextFile",()=>B],463783)},227711,929492,225575,289821,344423,995787,e=>{"use strict";var t=e.i(463783),i=e.i(509979);class a extends Blob{#e;#t;constructor(e,t){super(),this.#e=e,this.#t=t}async arrayBuffer(){return await this.#e}async text(){let e=await this.#e;return new TextDecoder().decode(e)}stream(){return new ReadableStream({start:async e=>{let t=await this.#e,i=new ReadableStream({start(e){e.enqueue(new Uint8Array(t)),e.close()}}).getReader(),a=()=>i.read().then(({done:t,value:i})=>t?(e.close(),Promise.resolve()):(e.enqueue(i),a()));return a()}})}get type(){return this.#t}}class r extends File{#i=null;#a;#r;#o;#s=0;#n=-1;#t="";static MAX_CACHE_CHUNK_SIZE=1048576;static MAX_CACHE_ITEMS_SIZE=50;#l=[];#c=new Map;#h=new Map;constructor(e,t,i=null,a=""){super([],t||e,{type:a}),this.#a=e,this.#o=i,this.#r=t||e}async open(){this.#i=await (0,t.open)(this.#a,this.#o?{baseDir:this.#o}:void 0);let e=await this.#i.stat();return this.#n=e.size,this.#s=e.mtime?e.mtime.getTime():Date.now(),this}async close(){this.#i&&(await this.#i.close(),this.#i=null),this.#c.clear(),this.#l=[]}get name(){return this.#r}get type(){return this.#t}get size(){return this.#n}get lastModified(){return this.#s}async stat(){return this.#i?.stat()}async seek(e,t){if(!this.#i)throw Error("File handle is not open");return this.#i.seek(e,t)}async readData(e,i){let a=(i=Math.max(e=Math.max(0,e),Math.min(this.size,i)))-e;if(a>r.MAX_CACHE_CHUNK_SIZE){let i=await (0,t.open)(this.#a,this.#o?{baseDir:this.#o}:void 0);try{await i.seek(e,t.SeekMode.Start);let r=new Uint8Array(a);return await i.read(r),r.buffer}finally{await i.close()}}let o=Array.from(this.#c.keys()).find(t=>{let a=this.#c.get(t);return e>=t&&i<=t+a.byteLength});if(void 0!==o){this.#f(o);let t=this.#c.get(o),i=e-o;return t.slice(i,i+a)}let s=`${e}-${i}`,n=this.#h.get(s);if(n)return n;let l=this.#d(e,a);this.#h.set(s,l);try{return await l}finally{this.#h.delete(s)}}async #d(e,i){let a=await (0,t.open)(this.#a,this.#o?{baseDir:this.#o}:void 0);try{let o=Math.max(0,e-1024),s=Math.min(this.size,e+r.MAX_CACHE_CHUNK_SIZE)-o;await a.seek(o,t.SeekMode.Start);let n=new Uint8Array(s);await a.read(n),this.#c.set(o,n.buffer),this.#f(o),this.#u();let l=e-o;return n.buffer.slice(l,l+i)}finally{await a.close()}}#f(e){let t=this.#l.indexOf(e);t>-1&&this.#l.splice(t,1),this.#l.unshift(e)}#u(){for(;this.#c.size>r.MAX_CACHE_ITEMS_SIZE;){let e=this.#l.pop();void 0!==e&&this.#c.delete(e)}}slice(e=0,t=this.size,i=this.type){return new a(this.readData(e,t),i)}stream(){let e=0;return new ReadableStream({pull:async i=>{if(!this.#i)return void i.error(Error("File handle is not open"));if(e>=this.size)return void i.close();let a=new Uint8Array(Math.min(e+1048576,this.size)-e);await this.#i.seek(e,t.SeekMode.Start);let r=await this.#i.read(a);null===r||0===r?i.close():(i.enqueue(a.subarray(0,r)),e+=r)},cancel:async()=>{await this.#i?.close()}})}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}class o extends File{url;#r;#s;#n=-1;#t="";#l=[];#c=new Map;#g=new Map;static MAX_CACHE_CHUNK_SIZE=131072;static MAX_CACHE_ITEMS_SIZE=128;constructor(e,t,i="",a=Date.now()){const r=e.split("/").pop()||"remote-file";super([],t||r,{type:i,lastModified:a}),this.url=e,this.#r=t||r,this.#t=i,this.#s=a}get name(){return this.#r}get type(){return this.#t}get size(){return this.#n}get lastModified(){return this.#s}async _open_with_head(){let e=await fetch(this.url,{method:"HEAD"});if(!e.ok)throw Error(`Failed to fetch file size: ${e.status}`);return this.#n=Number(e.headers.get("content-length")),this.#t=e.headers.get("content-type")||"",this}async _open_with_range(){let e=await fetch(this.url,{headers:{Range:"bytes=0-1023"}});if(!e.ok)throw Error(`Failed to fetch file size: ${e.status}`);return this.#n=Number(e.headers.get("content-range")?.split("/")[1]),this.#t=e.headers.get("content-type")||"",this}async open(){return"android"===(0,i.getOSPlatform)()?this._open_with_range():this._open_with_head()}async close(){this.#c.clear(),this.#l=[]}async fetchRangePart(e,t){e=Math.max(0,e),t=Math.min(this.size-1,t);let i=await fetch(this.url,{headers:{Range:`bytes=${e}-${t}`}});if(!i.ok)throw Error(`Failed to fetch range: ${i.status}`);return i.arrayBuffer()}async fetchRange(e,t){let i=t-e+1;if(i>1024e3){let i=[];for(let a=e;a<=t;a+=1024e3){let e=Math.min(a+1024e3-1,t);i.push(await this.fetchRangePart(a,e))}let a=new Uint8Array(i.reduce((e,t)=>e+t.byteLength,0)),r=0;for(let e of i)a.set(new Uint8Array(e),r),r+=e.byteLength;return a.buffer}{if(i>o.MAX_CACHE_CHUNK_SIZE)return this.fetchRangePart(e,t);let a=Array.from(this.#c.keys()).find(i=>{let a=this.#c.get(i).byteLength;return e>=i&&t<=i+a});if(void 0!==a){this.#f(a);let t=this.#c.get(a),r=e-a;return t.slice(r,r+i)}let r=`${e}-${t}`,s=this.#g.get(r);if(s)return s;let n=this.#p(e,t,i);this.#g.set(r,n);try{return await n}finally{this.#g.delete(r)}}}async #p(e,t,i){let a=Math.max(0,e-1024),r=Math.max(t,e+o.MAX_CACHE_CHUNK_SIZE-1024-1),s=await this.fetchRangePart(a,r);this.#c.set(a,s),this.#f(a),this.#u();let n=e-a;return s.slice(n,n+i)}#f(e){let t=this.#l.indexOf(e);t>-1&&this.#l.splice(t,1),this.#l.unshift(e)}#u(){for(;this.#c.size>o.MAX_CACHE_ITEMS_SIZE;){let e=this.#l.pop();void 0!==e&&this.#c.delete(e)}}slice(e=0,t=this.size,i=this.type){return new a(this.fetchRange(e,t-1),i)}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}e.s(["NativeFile",()=>r,"RemoteFile",()=>o],227711);var s=e.i(254799);let n={randomUUID:s.randomUUID},l=new Uint8Array(256),c=l.length,h=[];for(let e=0;e<256;++e)h.push((e+256).toString(16).slice(1));e.s(["v4",0,function(e,t,i){if(n.randomUUID&&!t&&!e)return n.randomUUID();let a=(e=e||{}).random??e.rng?.()??(c>l.length-16&&((0,s.randomFillSync)(l),c=0),l.slice(c,c+=16));if(a.length<16)throw Error("Random bytes length must be >= 16");if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){if((i=i||0)<0||i+16>t.length)throw RangeError(`UUID byte range ${i}:${i+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[i+e]=a[e];return t}return function(e,t=0){return(h[e[t+0]]+h[e[t+1]]+h[e[t+2]]+h[e[t+3]]+"-"+h[e[t+4]]+h[e[t+5]]+"-"+h[e[t+6]]+h[e[t+7]]+"-"+h[e[t+8]]+h[e[t+9]]+"-"+h[e[t+10]]+h[e[t+11]]+h[e[t+12]]+h[e[t+13]]+h[e[t+14]]+h[e[t+15]]).toLowerCase()}(a)}],929492);let f=new Set(["PDF","CBZ"]);e.s(["FIXED_LAYOUT_FORMATS",0,f],225575),e.i(612206);let d={EPUB:"epub",PDF:"pdf",MOBI:"mobi",AZW:"azw",AZW3:"azw3",CBZ:"cbz",FB2:"fb2",FBZ:"fbz",TXT:"txt",MD:"md"};class u{file;constructor(e){this.file=e}async isZip(){let e=new Uint8Array(await this.file.slice(0,4).arrayBuffer());return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}async isPDF(){let e=new Uint8Array(await this.file.slice(0,5).arrayBuffer());return 37===e[0]&&80===e[1]&&68===e[2]&&70===e[3]&&45===e[4]}async makeZipLoader(){let t=async()=>{let e=Math.min(65536,this.file.size),t=new Uint8Array(await this.file.slice(this.file.size-e,this.file.size).arrayBuffer());for(let e=t.length-22;e>=0;e--)if(80===t[e]&&75===t[e+1]&&5===t[e+2]&&6===t[e+3]){let i=t[e+20]+(t[e+21]<<8),a=e+22,r=t.slice(a,a+i);return new TextDecoder().decode(r)}return null},{configure:i,ZipReader:a,BlobReader:r,TextWriter:o,BlobWriter:s}=await e.A(310848);i({useWebWorkers:!1});let n=new a(new r(this.file)),l=await n.getEntries(),c=new Map(l.map(e=>[e.filename,e])),h=e=>(t,...i)=>c.has(t)?e(c.get(t),...i):null,f=h(e=>e.getData?e.getData(new o):null);return{entries:l,loadText:f,loadBlob:h((e,t)=>e.getData?e.getData(new s(t)):null),getSize:e=>c.get(e)?.uncompressedSize??0,getComment:t,sha1:void 0}}isCBZ(){return"application/vnd.comicbook+zip"===this.file.type||this.file.name.endsWith(`.${d.CBZ}`)}isFB2(){return"application/x-fictionbook+xml"===this.file.type||this.file.name.endsWith(`.${d.FB2}`)}isFBZ(){return"application/x-zip-compressed-fb2"===this.file.type||this.file.name.endsWith(".fb.zip")||this.file.name.endsWith(".fb2.zip")||this.file.name.endsWith(`.${d.FBZ}`)}async open(){let t=null,i="EPUB";if(!this.file.size)throw Error("File is empty");try{if(await this.isZip()){let a=await this.makeZipLoader(),{entries:r}=a;if(this.isCBZ()){let{makeComicBook:r}=await e.A(121014);t=await r(a,this.file),i="CBZ"}else if(this.isFBZ()){let o=r.find(e=>e.filename.endsWith(`.${d.FB2}`)),s=await a.loadBlob((o??r[0]).filename),{makeFB2:n}=await e.A(829768);t=await n(s),i="FBZ"}else{let{EPUB:r}=await e.A(926413);t=await new r(a).init(),i="EPUB"}}else if(await this.isPDF()){let{makePDF:a}=await e.A(228371);t=await a(this.file),i="PDF"}else if(await (await e.A(260943)).isMOBI(this.file)){let a=await e.A(704396),{MOBI:r}=await e.A(260943);switch(t=await new r({unzlib:a.unzlibSync}).open(this.file),this.file.name.split(".").pop()?.toLowerCase()){case"azw":i="AZW";break;case"azw3":i="AZW3";break;default:i="MOBI"}}else if(this.isFB2()){let{makeFB2:a}=await e.A(829768);t=await a(this.file),i="FB2"}}catch(e){if(console.error("Failed to open document:",e),e instanceof Error&&e.message?.includes("not a valid zip"))throw Error("Unsupported or corrupted book file");throw e}return{book:t,format:i}}}e.s(["DocumentLoader",()=>u,"EXTS",0,d],289821),e.i(57990);var g=e.i(745622),p=e.i(275666);function m(e){return(0,p.md5)(e).slice(0,7)}async function w(e){let t=p.md5.create();for(let i=-1;i<=10;i++){let a=Math.min(e.size,1024<<2*i),r=Math.min(a+1024,e.size);if(a>=e.size)break;let o=e.slice(a,r),s=new Uint8Array(await o.arrayBuffer());t.update(s)}return t.hex()}e.s(["md5Fingerprint",()=>m,"partialMD5",()=>w],344423);let y=(e,t=!1)=>{let a=(0,i.getUserLang)();if(!e)return"";if("string"==typeof e)return e;let r=Object.keys(e);return t?e[r[0]]:e[a]||e[r[0]]},b=["ar","bo","de","en","es","fr","hi","it","nl","pl","pt","ru","th","tr","uk"],k=(e,t)=>{if(!e)return"";let i=e.split(" ");return t&&i.length>1?`${i[i.length-1]}, ${i.slice(0,-1).join(" ")}`:e};e.s(["INIT_BOOK_CONFIG",0,{updatedAt:0},"formatAuthors",0,(e,t,a)=>{let r=(e=>{try{let t="string"==typeof e?e:e?.[0];return t?t.split("-")[0]:""}catch{return""}})(t)||"en",o=!!a&&b.includes(r);return Array.isArray(e)?((e=!1,t="")=>(t=t||(0,i.getUserLang)(),e)?new Intl.ListFormat("en",{style:"narrow",type:"unit"}):new Intl.ListFormat(t,{style:"long",type:"conjunction"}))("zh"===r,r).format(e.map(e=>"string"==typeof e?k(e,o):k(y(e?.name),o))):"string"==typeof e?k(e,o):k(y(e?.name),o)},"formatTitle",0,e=>"string"==typeof e?e:y(e),"getConfigFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,"");return`${t}/config.json`},"getCoverFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,""),i=`${t}/cover.png`;return console.log("[getCoverFilename] ✓ Using relativePath:",e.relativePath),console.log("[getCoverFilename] ✓ Cover path result:",i),i},"getDir",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath.replace(/\.[^.]+$/,"")},"getLibraryBackupFilename",0,()=>"library_backup.json","getLibraryFilename",0,()=>"library.json","getLocalBookFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath},"getPrimaryLanguage",0,e=>{let t=Array.isArray(e)?e[0]:e;if((0,g.isValidLang)(t)){let e=(0,g.normalizedLangCode)(t);return(0,g.code6392to6391)(e)||e}return"en"}],995787)},187984,e=>{"use strict";e.i(373852);var t=e.i(509979);e.s(["getBaseFilename",0,e=>{let t=e.replace(/\\/g,"/").split("/").pop()||"",i=t.split(".");return i.length<=1?t:i.slice(0,-1).join(".")},"getDirPath",0,e=>{let t=e.replace(/\\/g,"/").split("/");return t.pop(),t.join("/")},"getFilename",0,e=>(((0,t.isValidURL)(e)||(0,t.isContentURI)(e)||(0,t.isFileURI)(e))&&(e=decodeURI(e)),e.replace(/\\/g,"/").split("/").pop().split("?")[0])])},199236,e=>{"use strict";var t=e.i(929492),i=e.i(225575),a=e.i(995787),r=e.i(344423),o=e.i(275666),s=e.i(187984),n=e.i(289821),l=e.i(57990);let c="files",h=new class{db=null;initPromise=null;async init(){if(!this.db)return this.initPromise||(this.initPromise=new Promise((e,t)=>{let i=indexedDB.open("readest-cache",1);i.onerror=()=>{console.error("[IndexedDBCache] Failed to open database:",i.error),t(i.error)},i.onsuccess=()=>{this.db=i.result,console.log("[IndexedDBCache] ✓ Database opened successfully"),e()},i.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(c)||(t.createObjectStore(c,{keyPath:"key"}).createIndex("expiresAt","expiresAt",{unique:!1}),console.log("[IndexedDBCache] ✓ Object store created"))}})),this.initPromise}async get(e){return(await this.init(),this.db)?new Promise((t,i)=>{let a=this.db.transaction(c,"readonly").objectStore(c).get(e);a.onerror=()=>i(a.error),a.onsuccess=()=>{let i=a.result;i&&i.expiresAt&&Date.now()>i.expiresAt?(console.log("[IndexedDBCache] Cache expired for:",e),this.delete(e).catch(e=>console.error("Failed to delete expired cache:",e)),t(null)):(i&&console.log("[IndexedDBCache] ✓ Cache hit for:",e),t(i||null))}}):null}async set(e,t,i,a){if(await this.init(),!this.db)return;let r={key:e,data:t,mimeType:i,etag:a?.etag,timestamp:Date.now(),expiresAt:a?.ttl?Date.now()+a.ttl:void 0};return new Promise((t,i)=>{let a=this.db.transaction(c,"readwrite").objectStore(c).put(r);a.onerror=()=>i(a.error),a.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache saved for:",e),t()}})}async delete(e){if(await this.init(),this.db)return new Promise((t,i)=>{let a=this.db.transaction(c,"readwrite").objectStore(c).delete(e);a.onerror=()=>i(a.error),a.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache deleted for:",e),t()}})}async clear(){if(await this.init(),this.db)return new Promise((e,t)=>{let i=this.db.transaction(c,"readwrite").objectStore(c).clear();i.onerror=()=>t(i.error),i.onsuccess=()=>{console.log("[IndexedDBCache] ✓ All caches cleared"),e()}})}async clearExpired(){return(await this.init(),this.db)?new Promise((e,t)=>{let i=this.db.transaction(c,"readwrite").objectStore(c),a=i.index("expiresAt"),r=IDBKeyRange.upperBound(Date.now()),o=a.openCursor(r),s=0;o.onerror=()=>t(o.error),o.onsuccess=t=>{let a=t.target.result;a?(console.log("[IndexedDBCache] Deleting expired cache:",a.key),i.delete(a.primaryKey),s++,a.continue()):(console.log("[IndexedDBCache] ✓ Cleared",s,"expired caches"),e(s))}}):0}async getStats(){return(await this.init(),this.db)?new Promise((e,t)=>{let i=this.db.transaction(c,"readonly").objectStore(c).getAll();i.onerror=()=>t(i.error),i.onsuccess=()=>{let t,a,r=i.result,o=0;r.forEach(e=>{o+=e.data.byteLength,(!t||e.timestamp<t.timestamp)&&(t={key:e.key,timestamp:e.timestamp}),(!a||e.timestamp>a.timestamp)&&(a={key:e.key,timestamp:e.timestamp})}),console.log("[IndexedDBCache] Stats:",{entries:r.length,size:(o/1024/1024).toFixed(2)+" MB"}),e({totalEntries:r.length,totalSize:o,oldestEntry:t,newestEntry:a})}}):{totalEntries:0,totalSize:0}}},f={cacheStrategy:"cache-first",cacheTTL:2592e6};async function d(e,t={}){let i={...f,...t},a=`file_${e}`;console.log(`[cachedFetch] Fetching: ${e}, strategy: ${i.cacheStrategy}`);try{if("cache-first"===i.cacheStrategy&&!i.bypassCache){let t=await h.get(a);if(t){console.log(`[cachedFetch] ✓ Using cached data for: ${e}`);let i=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),...t.etag&&{ETag:t.etag}});return{data:t.data,headers:i,fromCache:!0}}}let t=new Headers(i.headers||{}),r=await fetch(e,{method:"GET",headers:t,signal:AbortSignal.timeout(3e4)});if(304===r.status){console.log(`[cachedFetch] 304 Not Modified for: ${e}`);let t=await h.get(a);if(t){let e=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),ETag:r.headers.get("ETag")||t.etag||""});return{data:t.data,headers:e,fromCache:!0}}}if(!r.ok)throw Error(`HTTP ${r.status}: ${r.statusText}`);let o=parseInt(r.headers.get("Content-Length")||"0",10),s=r.body?.getReader(),n=[],l=0;if(s)for(;;){let{done:e,value:t}=await s.read();if(e)break;if(n.push(t),l+=t.length,o>0&&i.onProgress){let e=Math.round(l/o*100);i.onProgress(e)}}else n.push(new Uint8Array(await r.arrayBuffer()));let c=new ArrayBuffer(l),f=new Uint8Array(c),d=0;for(let e of n)f.set(e,d),d+=e.length;let u=r.headers.get("Content-Type")||"application/octet-stream",g=r.headers.get("ETag");return i.bypassCache||200!==r.status||h.set(a,c,u,{etag:g||void 0,ttl:i.cacheTTL}).catch(t=>{console.warn(`[cachedFetch] Failed to cache ${e}:`,t)}),console.log(`[cachedFetch] ✓ Fetched ${(c.byteLength/1024/1024).toFixed(2)} MB from network`),{data:c,headers:r.headers,fromCache:!1}}catch(i){console.warn(`[cachedFetch] Network error for ${e}:`,i);let t=await h.get(a);if(t){console.log(`[cachedFetch] ℹ Using stale cache due to network error: ${e}`);let i=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),Warning:'199 - "Stale cache used due to network error"'});return{data:t.data,headers:i,fromCache:!0}}throw i}}async function u(e,t={}){let{data:i,headers:a}=await d(e,t),r=new Blob([i],{type:a.get("Content-Type")||"application/octet-stream"});return URL.createObjectURL(r)}var g=e.i(826165);let p="Request cancelled";async function m(e,t){let i=t?.signal;if(i?.aborted)throw Error(p);let a=t?.maxRedirections,r=t?.connectTimeout,o=t?.proxy,s=t?.danger;t&&(delete t.maxRedirections,delete t.connectTimeout,delete t.proxy,delete t.danger);let n=t?.headers?t.headers instanceof Headers?t.headers:new Headers(t.headers):new Headers,l=new Request(e,t),c=await l.arrayBuffer(),h=0!==c.byteLength?Array.from(new Uint8Array(c)):null;for(let[e,t]of l.headers)n.get(e)||n.set(e,t);let f=(n instanceof Headers?Array.from(n.entries()):Array.isArray(n)?n:Object.entries(n)).map(([e,t])=>[e,"string"==typeof t?t:t.toString()]);if(i?.aborted)throw Error(p);let d=await (0,g.invoke)("plugin:http|fetch",{clientConfig:{method:l.method,url:l.url,headers:f,data:h,maxRedirections:a,connectTimeout:r,proxy:o,danger:s}}),u=()=>(0,g.invoke)("plugin:http|fetch_cancel",{rid:d});if(i?.aborted)throw u(),Error(p);i?.addEventListener("abort",()=>void u());let{status:m,statusText:w,url:y,headers:b,rid:k}=await (0,g.invoke)("plugin:http|fetch_send",{rid:d}),S=()=>(0,g.invoke)("plugin:http|fetch_cancel_body",{rid:k}),F=async e=>{let t;try{t=await (0,g.invoke)("plugin:http|fetch_read_body",{rid:k})}catch(t){e.error(t),S();return}let i=new Uint8Array(t),a=i[i.byteLength-1],r=i.slice(0,i.byteLength-1);1===a?e.close():e.enqueue(r)},v=new Response([101,103,204,205,304].includes(m)?null:new ReadableStream({start:e=>{i?.addEventListener("abort",()=>{e.error(p),S()})},pull:e=>F(e)}),{status:m,statusText:w});return Object.defineProperty(v,"url",{value:y}),Object.defineProperty(v,"headers",{value:new Headers(b)}),v}var w=e.i(509979);let y=(e,t,i)=>{let a=JSON.parse(e),{viewSettings:r,searchConfig:o}=a;return a.viewSettings={...t,...r},a.searchConfig={...i,...o},a.updatedAt??=Date.now(),a};var b=e.i(745622);let k={lastAccessDate:new Date(0),lastModDate:new Date(0)},S=e=>e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"";class F{async convert(e){let{file:t,author:i,language:a}=e,o=await t.arrayBuffer(),n=this.detectEncoding(o)||"utf-8";console.log(`Detected encoding: ${n}`);let l=new TextDecoder(n).decode(o).trim(),c=this.extractBookTitle((0,s.getBaseFilename)(t.name)),h=`${c}.epub`,f=l.slice(0,1024),d=f.match(/[【\[]?作者[】\]]?[:：\s]\s*(.+)\r?\n/)||f.match(/[【\[]?\s*(.+)\s+著\s*[】\]]?\r?\n/),u=d?d[1].trim():i||"";try{u=u.replace(/^[\p{P}\p{S}]+|[\p{P}\p{S}]+$/gu,"")}catch{}let g=u||i||"",p=a||(0,b.detectLanguage)(f);console.log(`Detected language: ${p}`);let m={bookTitle:c,author:g,language:p,identifier:await (0,r.partialMD5)(t)},w=[];for(let e=8;e>=6;e--){if(0===(w=this.extractChapters(l,m,{linesBetweenSegments:e,fallbackParagraphsPerChapter:100})).length)throw Error("No chapters detected.");if(w.length>1)break}return{file:new File([await this.createEpub(w,m)],h),bookTitle:c,chapterCount:w.length,language:p}}extractChapters(e,t,i){let{language:a}=t,{linesBetweenSegments:r,fallbackParagraphsPerChapter:o}=i,s=RegExp(`(?:\\r?\\n){${r},}|-{8,}\r?
`),n=[];if("zh"===a)n.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`第[零〇一二三四五六七八九十0-9][零〇一二三四五六七八九十百千万0-9]*(?:[章卷节回讲篇封本册部话])(?:[：:、 　\(\)0-9]*[^\n-]{0,24})(?!\S)`,String.raw`(?:楔子|前言|简介|引言|序言|序章|总论|概论|后记)(?:[：: 　][^\n-]{0,24})?(?!\S)`,String.raw`chapter[\s.]*[0-9]+(?:[：:. 　]+[^\n-]{0,50})?(?!\S)`].join("|")+")","gui")),n.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`[一二三四五六七八九十][零〇一二三四五六七八九十百千万]?[：:、 　][^\n-]{0,24}(?=\n|$)`,String.raw`[0-9]+[^\n]{0,16}(?=\n|$)`].join("|")+")","gu"));else{let e=String.raw`(\d+|(?:[IVXLCDM]{2,}|V|X|L|C|D|M)\b)`,t=String.raw`\.\d{1,4}`,i=String.raw`[^\n]{0,50}`,a=["Chapter","Part","Section","Book","Volume","Act"].map(a=>String.raw`${a}\s*(?:${e}|${t})(?:[:.\-–—]?\s*${i})?`).join("|"),r=["Prologue","Epilogue","Introduction","Foreword","Preface","Afterword"].map(e=>String.raw`${e}(?:[:.\-–—]?\s*${i})?`).join("|"),o=String.raw`(?:^|\n|\s)(?:${a}|${r})(?=\s|$)`;n.push(RegExp(o,"gi"))}let l=e=>(e=S(e)).replace(/-{8,}|_{8,}/g,"\n").split(/\n+/).map(e=>e.trim()).filter(e=>e).join("</p><p>"),c=e=>e.reduce((e,t,i,a)=>(void 0===t&&i>0&&i<a.length-1&&void 0!==a[i-1]&&void 0!==a[i+1]?e[e.length-1]+=a[i+1]:void 0!==t&&(0===i||void 0!==a[i-1])&&e.push(t),e),[]),h=(e,t=1e5)=>{let i=e.filter(e=>e&&e.trim().length>0);return!(i.length<=1)&&!i.some(e=>e.length>t)},f=[];for(let t of e.split(s)){let e=t.replace(/<!--.*?-->/g,"").trim();if(!e)continue;let i=[],r=[];for(let t of n){let i=e.split(t);if(h(i)){r=c(i);break}}if(0===r.length&&o>0){let t=e.split(/\n+/),i=t.length;for(let e=0;e<i;e+=o){let i=t.slice(e,e+o),a=l(i.join("\n")),r=`${f.length+1}`,s=`<h2>${r}</h2><p>${a}</p>`;f.push({title:r,content:s,text:i.join("\n"),isVolume:!1})}continue}for(let e=1;e<r.length;e+=2){let t=r[e]?.trim()||"",o=r[e+1]?.trim()||"",s=!1,n=(s="zh"===a?/第[零〇一二三四五六七八九十百千万0-9]+(卷|本|册|部)/.test(t):/\b(Part|Volume|Book)\b/i.test(t))?`<h1>${t}</h1>`:`<h2>${t}</h2>`,c=l(o);i.push({title:S(t),content:`${n}<p>${c}</p>`,text:o,isVolume:s})}if(r[0]&&r[0].trim()){let e=r[0].trim(),t=e.split("\n")[0].trim(),a=(t.length>16?e.split(/[\n\s\p{P}]/u)[0].trim():t)||e.slice(0,16),o=l(e);i.unshift({title:S(a),content:`<h3></h3><p>${o}</p>`,text:e,isVolume:!1})}f.push(...i)}return f}async createEpub(t,i){let{BlobWriter:a,TextReader:r,ZipWriter:o}=await e.A(310848),{bookTitle:s,author:n,language:l,identifier:c}=i,h=new o(new a("application/epub+zip"),{extendedTimestamp:!1});await h.add("mimetype",new r("application/epub+zip"),k),await h.add("META-INF/container.xml",new r(`<?xml version="1.0" encoding="UTF-8"?>
    <container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
      <rootfiles>
        <rootfile full-path="content.opf" media-type="application/oebps-package+xml"/>
      </rootfiles>
    </container>`.trim()),k);let f=!1,d="";for(let e=0;e<t.length;e++){let i=`chapter${e+1}`,a=e+1;t[e].isVolume&&f&&(d+=`</navPoint>
`,f=!f),d+=`<navPoint id="navPoint-${i}" playOrder="${a}">
<navLabel><text>${t[e].title}</text></navLabel>
<content src="./OEBPS/${i}.xhtml" />
`,t[e].isVolume&&!f?f=!f:d+=`</navPoint>
`}f&&(d+="</navPoint>");let u=`<?xml version="1.0" encoding="UTF-8"?>
    <ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
      <head>
        <meta name="dtb:uid" content="book-id" />
        <meta name="dtb:depth" content="1" />
        <meta name="dtb:totalPageCount" content="0" />
        <meta name="dtb:maxPageNumber" content="0" />
      </head>
      <docTitle>
        <text>${S(s)}</text>
      </docTitle>
      <docAuthor>
        <text>${S(n)}</text>
      </docAuthor>
      <navMap>
        ${d}
      </navMap>
    </ncx>`.trim();await h.add("toc.ncx",new r(u),k);let g=t.map((e,t)=>`
      <item id="chap${t+1}" href="OEBPS/chapter${t+1}.xhtml" media-type="application/xhtml+xml"/>
    `).join("\n").trim(),p=t.map((e,t)=>`
      <itemref idref="chap${t+1}"/>`).join("\n").trim(),m=`
      body { line-height: 1.6; font-size: 1em; font-family: 'Arial', sans-serif; text-align: justify; }
      p { text-indent: 2em; margin: 0; }
    `;await h.add("style.css",new r(m),k);for(let e=0;e<t.length;e++){let i=t[e],a=(0,b.detectLanguage)(i.text),o=`<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" lang="${a}" xml:lang="${a}">
          <head>
            <title>${i.title}</title>
            <link rel="stylesheet" type="text/css" href="../style.css"/>
          </head>
          <body>${i.content}</body>
        </html>`.trim();await h.add(`OEBPS/chapter${e+1}.xhtml`,new r(o),k)}let w=`<?xml version="1.0" encoding="UTF-8"?>
      <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="book-id" version="2.0">
        <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
          <dc:title>${S(s)}</dc:title>
          <dc:language>${l}</dc:language>
          <dc:creator>${S(n)}</dc:creator>
          <dc:identifier id="book-id">${c}</dc:identifier>
        </metadata>
        <manifest>
          ${g}
          <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
          <item id="css" href="style.css" media-type="text/css"/>
        </manifest>
        <spine toc="ncx">
          ${p}
        </spine>
      </package>`.trim();return await h.add("content.opf",new r(w),k),await h.close()}detectEncoding(e){try{return new TextDecoder("utf-8",{fatal:!0}).decode(e),"utf-8"}catch{let t=new Uint8Array(e),i=0,a=0,r=Math.min(t.length,1e4);for(let e=0;e<r;e++)try{new TextDecoder("utf-8",{fatal:!0}).decode(t.slice(e,e+100)),i+=100,a+=100,e+=99}catch{a++}let o=i/a*100;if(console.log(`UTF-8 validity: ${o.toFixed(2)}%`),o>80)return console.log("Treating as UTF-8 despite some invalid sequences"),"utf-8"}let t=new Uint8Array(e.slice(0,4));if(255===t[0]&&254===t[1])return"utf-16le";if(254===t[0]&&255===t[1])return"utf-16be";if(239===t[0]&&187===t[1]&&191===t[2])return"utf-8";let i=new Uint8Array(e.slice(0,Math.min(1024,e.byteLength))),a=0;for(let e=0;e<i.length;e++)i[e]>=128&&a++;let r=a/i.length;if(r>.3)return"gbk";if(r>.1){let e=!1;for(let t=0;t<i.length-1;t++){let a=i[t],r=i[t+1];if((a>=129&&a<=159||a>=224&&a<=252)&&(r>=64&&r<=126||r>=128&&r<=252)){e=!0;break}}return e?"shift-jis":"gb18030"}return"utf-8"}extractBookTitle(e){let t=e.match(/《([^》]+)》/);return t?t[1]:e.split(".")[0]}}let v="Book file not found",E=new Set([1028,2052,3076,4100,19,33]);function B(e){let t=parseFloat(e);if(!isNaN(t))return t}async function A(e,t=700,i=1050){let a=await e.text(),r=new DOMParser().parseFromString(a,"image/svg+xml").documentElement,o=r.getAttribute("width"),s=r.getAttribute("height");if(o&&s)return{width:B(o)||t,height:B(s)||i};let n=r.getAttribute("viewBox");if(n){let e=n.split(/\s+/).map(Number);if(4===e.length&&!e.some(isNaN)){let[,,a,r]=e;return{width:a||t,height:r||i}}}return{width:t,height:i}}async function T(e,t=.9){let i=await e.text(),a=URL.createObjectURL(new Blob([i],{type:"image/svg+xml"})),r=new Image;r.crossOrigin="anonymous",await new Promise((e,t)=>{r.onload=()=>e(),r.onerror=()=>t(Error("Failed to load SVG")),r.src=a}),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>requestAnimationFrame(e));let o=document.createElement("canvas"),{width:s,height:n}=await A(e);return o.width=s,o.height=n,o.getContext("2d").drawImage(r,0,0),URL.revokeObjectURL(a),new Promise(e=>{o.toBlob(t=>e(t),"image/png",t)})}class D{osPlatform=(0,w.getOSPlatform)();appPlatform="tauri";localBooksDir="";isMobile=!1;isMacOSApp=!1;isLinuxApp=!1;isAppDataSandbox=!1;isAndroidApp=!1;isIOSApp=!1;isMobileApp=!1;isPortableApp=!1;isDesktopApp=!1;isEink=!1;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir=!1;canReadExternalDir=!1;distChannel="readest";CURRENT_MIGRATION_VERSION=0x1352519;async runMigrations(e){if(e<0x13501f4)try{await this.migrate20251124()}catch(e){console.error("Error migrating to version 20251124:",e)}if(e<0x1352519)try{await this.migrate20260121()}catch(e){console.error("Error migrating to version 20260121:",e)}}async prepareBooksDir(){this.localBooksDir=await this.fs.getPrefix("Books"),await this.ensureConfigFilesExist()}async ensureConfigFilesExist(){try{if(!await this.fs.exists(l.SETTINGS_FILENAME,"Settings")){console.log("[Init] settings.json not found, creating with defaults...");let e={...l.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?l.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:l.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),globalReadSettings:{...l.DEFAULT_READSETTINGS,...this.isMobile?l.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()};await this.safeSaveJSON(l.SETTINGS_FILENAME,"Settings",e),console.log("[Init] ✓ settings.json created successfully")}let e=(0,a.getLibraryFilename)();await this.fs.exists(e,"Books")||(console.log("[Init] library.json not found, creating with defaults..."),await this.safeSaveJSON(e,"Books",[]),console.log("[Init] ✓ library.json created successfully")),console.log("[Init] ✓ All configuration files are ready")}catch(e){console.error("[Init] Error ensuring config files exist:",e)}}async openFile(e,t){return await this.fs.openFile(e,t)}async copyFile(e,t,i){return await this.fs.copyFile(e,t,i)}async readFile(e,t,i){return await this.fs.readFile(e,t,i)}async writeFile(e,t,i){return await this.fs.writeFile(e,t,i)}async createDir(e,t,i=!0){return await this.fs.createDir(e,t,i)}async deleteFile(e,t){return await this.fs.removeFile(e,t)}async deleteDir(e,t,i=!0){return await this.fs.removeDir(e,t,i)}async resolveFilePath(e,t){let i=await this.fs.getPrefix(t);return e?`${i}/${e}`:i}async readDirectory(e,t){return await this.fs.readDir(e,t)}async exists(e,t){return await this.fs.exists(e,t)}async getImageURL(e){return await this.fs.getImageURL(e)}getCoverImageUrl=e=>{let t=(0,a.getCoverFilename)(e),i=this.fs.resolvePath(t,"Books");return this.fs.getURL(i.fp)||`${this.localBooksDir}/${t}`};getCoverImageBlobUrl=async e=>{let t=(0,a.getCoverFilename)(e);if("web"===this.appPlatform)try{let e=this.fs.getURL(this.fs.resolvePath(t,"Books").fp)||`${this.localBooksDir}/${t}`;return await u(e,{cacheStrategy:"cache-first",cacheTTL:2592e6}).catch(()=>`${this.localBooksDir}/${t}`)}catch{return`${this.localBooksDir}/${t}`}try{return await this.fs.getBlobURL(t,"Books")}catch{return`${this.localBooksDir}/${t}`}};async getCachedImageUrl(e){let t=`img_${(0,o.md5)(e)}`,i=await this.fs.getPrefix("Cache"),a=`${i}/${t}`;if(await this.fs.exists(a,"None"))return await this.fs.getImageURL(a);{let i=await this.fs.openFile(e,"None");return await this.fs.writeFile(t,"Cache",await i.arrayBuffer()),await this.fs.getImageURL(a)}}getDefaultViewSettings(){return{...l.DEFAULT_BOOK_LAYOUT,...l.DEFAULT_BOOK_STYLE,...l.DEFAULT_BOOK_FONT,...l.DEFAULT_BOOK_LANGUAGE,...this.isMobile?l.DEFAULT_MOBILE_VIEW_SETTINGS:{},...this.isEink?l.DEFAULT_EINK_VIEW_SETTINGS:{},...(0,w.isCJKEnv)()?l.DEFAULT_CJK_VIEW_SETTINGS:{},...l.DEFAULT_VIEW_CONFIG,...l.DEFAULT_TTS_CONFIG,...l.DEFAULT_SCREEN_CONFIG,...l.DEFAULT_ANNOTATOR_CONFIG,...{...l.DEFAULT_TRANSLATOR_CONFIG,translateTargetLang:(0,w.getTargetLang)()}}}async loadSettings(){let e={...l.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?l.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:l.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),koreaderSyncDeviceId:(0,t.v4)(),globalReadSettings:{...l.DEFAULT_READSETTINGS,...this.isMobile?l.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()},i=await this.safeLoadJSON(l.SETTINGS_FILENAME,"Settings",e),a=i.version??0;return(this.isAppDataSandbox||a<l.SYSTEM_SETTINGS_VERSION)&&(i.version=l.SYSTEM_SETTINGS_VERSION),(i={...l.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?l.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},...i}).globalReadSettings={...l.DEFAULT_READSETTINGS,...this.isMobile?l.DEFAULT_MOBILE_READSETTINGS:{},...i.globalReadSettings},i.globalViewSettings={...this.getDefaultViewSettings(),...i.globalViewSettings},i.localBooksDir=await this.fs.getPrefix("Books"),i.kosync.deviceId||(i.kosync.deviceId=(0,t.v4)(),await this.saveSettings(i)),this.localBooksDir=i.localBooksDir,i}async saveSettings(e){await this.safeSaveJSON(l.SETTINGS_FILENAME,"Settings",e)}async importFont(e){let t,i;if("string"==typeof e)t=(await this.fs.openFile(e,"None")).name||(0,s.getFilename)(e),await this.fs.copyFile(e,t,"Fonts"),i=await this.fs.openFile(t,"Fonts");else{if(!e)return null;t=(0,s.getFilename)(e.name),await this.fs.writeFile(t,"Fonts",e),i=e}return{path:t,...((e,t)=>{let i=t.replace(/\.[^/.]+$/,"");try{var a,r,o,s;let t,i=new DataView(e),n=i.getUint32(0,!1);if(65536!==n&&0x74727565!==n&&0x4f54544f!==n)throw Error("Unsupported font format");let l=i.getUint16(4,!1),c=0,h=0,f=0;for(let e=0;e<l;e++){let t=12+16*e,a=String.fromCharCode(i.getUint8(t),i.getUint8(t+1),i.getUint8(t+2),i.getUint8(t+3));"name"===a?c=i.getUint32(t+8,!1):"OS/2"===a?h=i.getUint32(t+8,!1):"fvar"===a&&(f=i.getUint32(t+8,!1))}if(0===c)throw Error("Name table not found");let d=i.getUint16(c+2,!1),u=i.getUint16(c+4,!1),g=(0,w.getUserLang)(),p=[],m=[],y=[],b=[];for(let e=0;e<d;e++){let t=c+6+12*e,a=i.getUint16(t,!1),r=i.getUint16(t+4,!1),o=i.getUint16(t+6,!1),s=i.getUint16(t+8,!1),n=i.getUint16(t+10,!1);if(1===o||2===o||16===o||17===o){let e=c+u+n,t="";if(0===a||3===a?t=function(e,t,i){let a=[];for(let r=0;r<i;r+=2){let i=e.getUint16(t+r,!1);0!==i&&a.push(String.fromCharCode(i))}return a.join("")}(i,e,s):1===a&&(t=function(e,t,i){let a=[];for(let r=0;r<i;r++){let i=e.getUint8(t+r);a.push(String.fromCharCode(i))}return a.join("")}(i,e,s)),t&&t.trim()){let e=function(e,t,i){let a=0;0===e?a+=100:3===e?a+=90:1===e&&(a+=50);let r=i.toLowerCase();return 0===e||3===e?(r.startsWith("zh")?2052===t?a+=50:1028===t?a+=45:3076===t?a+=40:4100===t&&(a+=35):r.startsWith("ja")?1041===t&&(a+=50):r.startsWith("ko")?1042===t&&(a+=50):r.startsWith("en")&&(1033===t?a+=50:2057===t&&(a+=45)),1033===t&&(a+=10)):1===e&&(r.startsWith("zh")?33===t?a+=50:19===t&&(a+=45):r.startsWith("ja")?11===t&&(a+=50):r.startsWith("ko")?23===t&&(a+=50):r.startsWith("en")&&0===t&&(a+=50),0===t&&(a+=10)),a}(a,r,g),i={name:t.trim(),platformID:a,languageID:r,priority:e};1===o?p.push(i):2===o?m.push(i):16===o?y.push(i):17===o&&b.push(i)}}}if(0===p.length)throw Error("Font family name not found");p.sort((e,t)=>t.priority-e.priority),m.sort((e,t)=>t.priority-e.priority),y.sort((e,t)=>t.priority-e.priority),b.sort((e,t)=>t.priority-e.priority);let k=(y[0]||p[0]).name,S=b[0]||m[0],F=S?.name||"",v=400,B="normal",A=0;if(h>0)try{a=h,v=(r=i.getUint16(a+4,!1))>=1&&r<=100?100:r>=101&&r<=200?200:r>=201&&r<=300?300:r>=301&&r<=400?400:r>=401&&r<=500?500:r>=501&&r<=600?600:r>=601&&r<=700?700:r>=701&&r<=800?800:r>=801&&r<=900?900:400,o=h,A=i.getUint16(o+62,!1)}catch{console.warn("Failed to parse OS/2 table, falling back to style name analysis")}let T=!1;if(f>0){let e=function(e,t){try{let i=e.getUint16(t+4,!1),a=e.getUint16(t+6,!1),r=[],o=t+16;for(let t=0;t<i;t++){let t=String.fromCharCode(e.getUint8(o),e.getUint8(o+1),e.getUint8(o+2),e.getUint8(o+3)),i=e.getInt32(o+4,!1)/65536,s=e.getInt32(o+8,!1)/65536,n=e.getInt32(o+12,!1)/65536;r.push({tag:t,minValue:i,defaultValue:s,maxValue:n}),o+=a}return r}catch(e){return console.warn("Failed to parse fvar table:",e),[]}}(i,f);e&&e.length>0&&(T=!0)}if(400===v&&F){let e,t=(e=F.toLowerCase()).includes("thin")||e.includes("hairline")?100:e.includes("extralight")||e.includes("ultralight")?200:!e.includes("light")||e.includes("extralight")||e.includes("ultralight")?e.includes("medium")?500:e.includes("semibold")||e.includes("demibold")?600:e.includes("extrabold")||e.includes("ultrabold")?800:e.includes("black")||e.includes("heavy")?900:!e.includes("bold")||e.includes("semibold")||e.includes("extrabold")||e.includes("ultrabold")?400:700:300;400!==t&&(v=t)}return s=A,t=F.toLowerCase(),B=512&s?"oblique":1&s?"italic":t.includes("oblique")?"oblique":t.includes("italic")||t.includes("slant")?"italic":"normal",{name:S&&!E.has(S.languageID)?`${k} ${F}`:k,family:k,weight:v,style:B,variable:T}}catch(e){return console.warn(`Failed to parse font: ${e}`),{name:i,family:i,weight:400,style:"normal",variable:!1}}})(await i.arrayBuffer(),t)}}async deleteFont(e){await this.fs.removeFile(e.path,"Fonts")}async importImage(e){let t;if("string"==typeof e)t=(await this.fs.openFile(e,"None")).name||(0,s.getFilename)(e),await this.fs.copyFile(e,t,"Images");else{if(!e)return null;t=(0,s.getFilename)(e.name),await this.fs.writeFile(t,"Images",e)}return{name:t.replace(/\.[^/.]+$/,""),path:t}}async deleteImage(e){await this.fs.removeFile(e.path,"Images")}async importBook(e,t,i=!0,o=!0,l=!1,c=!1,h){let f=Date.now(),d="";try{let u,g,p;if(c&&"string"!=typeof e)throw Error("Transient import is only supported for file paths");try{"string"==typeof e?d=(p=await this.fs.openFile(e,"None")).name||(0,s.getFilename)(e):(p=e,d=e.name);let t=p.size/1048576;if(console.log(`[importBook] Processing: ${d}, size: ${t.toFixed(2)} MB`),0===p.size)throw Error("Invalid or empty book file");if(p.size>0x6400000&&console.warn(`[importBook] ⚠️ Large file: ${t.toFixed(2)} MB, processing may take longer`),/\.txt$/i.test(d)){let e=new F;({file:p}=await e.convert({file:p}))}if(console.log(`[importBook] Opening document: ${d}`),{book:u,format:g}=await new n.DocumentLoader(p).open(),!u)throw Error("Unsupported or corrupted book file");let i=(0,a.formatTitle)(u.metadata.title);i&&i.trim()&&i!==d||(u.metadata.title=(0,s.getBaseFilename)(d)),console.log(`[importBook] ✓ Document opened successfully: ${d}`)}catch(t){let e=t.message||String(t);throw console.error(`[importBook] ✗ Failed to open book: ${d}`,e),Error(`Failed to open the book: ${e}`)}console.log(`[importBook] Computing hash for: ${d}`);let m=await (0,r.partialMD5)(p),y=t.filter(e=>e.hash===m)[0],b=Date.now();y&&(c||(y.deletedAt=null),y.createdAt=b,y.updatedAt=b);let k=(0,a.getPrimaryLanguage)(u.metadata.language),S={hash:m,format:g,title:(0,a.formatTitle)(u.metadata.title),sourceTitle:(0,a.formatTitle)(u.metadata.title),primaryLanguage:k,author:(0,a.formatAuthors)(u.metadata.author,k),createdAt:y?y.createdAt:b,uploadedAt:y?y.uploadedAt:c?null:b,deletedAt:c?b:null,downloadedAt:b,updatedAt:b};y&&(y.format=S.format,y.title=y.title.trim()?y.title.trim():S.title,y.sourceTitle=y.sourceTitle??S.sourceTitle,y.author=y.author??S.author,y.primaryLanguage=y.primaryLanguage??S.primaryLanguage,y.downloadedAt=Date.now());let v="web"===this.appPlatform;console.log("[ImportBook] appPlatform:",this.appPlatform,"STORAGE_MODE (runtime):",!1,"STORAGE_MODE (env):","local","shouldUseLocalFlatStorage:",v);let E=n.EXTS[g]||g.toLowerCase?.()||"book",B=(0,w.makeSafeFilename)(S.sourceTitle||S.title),A=h?.targetGroupName?.trim();if(v){let e=h?.targetRelativePath?h.targetRelativePath:`${A?`${A}/`:""}${B}.${E}`;if(!e)throw Error("targetRelativePath is required for local storage mode. Please provide a valid relative path.");S.relativePath=e,console.log("[ImportBook] 5. Setting book.relativePath to:",e),console.log("[ImportBook] 6. Book hash:",S.hash),y&&(y.relativePath=e),A&&!S.groupName&&(S.groupName=A,y&&!y.groupName&&(y.groupName=A))}else if("web"===this.appPlatform){let e=h?.targetRelativePath?h.targetRelativePath:`${A?`${A}/`:""}${B}.${E}`;S.relativePath=e,y&&(y.relativePath=e)}await this.ensureLocalBookDirs(S);let D=(0,a.getLocalBookFilename)(S);if(i&&!c&&(!await this.fs.exists(D,"Books")||l))if(/\.txt$/i.test(d))await this.fs.writeFile(D,"Books",p);else if("string"==typeof e&&(0,w.isContentURI)(e))await this.fs.copyFile(e,D,"Books");else if("string"!=typeof e||(0,w.isValidURL)(e))await this.fs.writeFile(D,"Books",p);else try{await this.fs.copyFile(e,D,"Books")}catch{await this.fs.writeFile(D,"Books",await p.arrayBuffer())}if(o&&(!await this.fs.exists((0,a.getCoverFilename)(S),"Books")||l)){console.log("[ImportBook] 7. Preparing to save cover");let e=await u.getCover();if(e?.type==="image/svg+xml")try{console.log("[ImportBook] Converting SVG cover to PNG..."),e=await T(e)}catch{}if(e){let t=(0,a.getCoverFilename)(S);console.log("[ImportBook] 8. Saving cover with filename:",t),console.log("[ImportBook] 9. Cover size:",e.size,"bytes"),await this.fs.writeFile(t,"Books",await e.arrayBuffer()),console.log("[ImportBook] 10. Cover saved successfully")}}y||(await this.saveBookConfig(S,a.INIT_BOOK_CONFIG),t.splice(0,0,S)),"string"==typeof e&&((0,w.isValidURL)(e)&&(S.url=e,y&&(y.url=e)),c&&(S.filePath=e,y&&(y.filePath=e))),S.coverImageUrl=await this.generateCoverImageUrl(S),e&&e.close&&await e.close();let L=Date.now()-f;return console.log(`[importBook] ✓ Import completed in ${L}ms: ${d}`),y||S}catch(r){let t=Date.now()-f,i=r.message||String(r),a=r.stack;if(console.error(`[importBook] ✗ Import failed after ${t}ms`),console.error(`[importBook] File: ${d||("string"==typeof e?e:"unknown")}`),console.error(`[importBook] Error: ${i}`),a&&console.error("[importBook] Stack trace:",a),i.includes("memory")||i.includes("ENOMEM"))throw Error(`内存不足：文件可能过大。请尝试导入较小的文件或关闭其他程序。原始错误：${i}`);throw i.includes("too large")||i.includes("Maximum size"),r}}async importBookFromPath(e,t,i){try{let a=t.split("/").slice(0,-1).join("/");return await this.importBook(e,i,!1,!0,!1,!0,{targetRelativePath:t,targetGroupName:a||""})}catch(t){return console.error("Error importing book from path:",e,t),null}}async reclassifyBook(e,t,i){if("web"!==this.appPlatform)return void console.log("[Reclassify] 非本地存储模式，跳过文件移动");if(!e.relativePath)return void console.log("[Reclassify] 书籍未使用新存储结构，跳过文件移动:",e.title);try{let a,r,o=(await this.loadSettings()).groupDirectories||{},s=e.relativePath;if(i&&s.startsWith(`${i}/`))a=s.substring(i.length+1);else{let e=s.split("/");a=e[e.length-1]||""}let n=(r=t&&o[t]?o[t]:t||"")?`${r}/${a}`:a;if(s===n)return void console.log("[Reclassify] 书籍分组未改变，无需移动文件");console.log("[Reclassify] 准备移动书籍文件"),console.log("  旧路径:",s),console.log("  新路径:",n),console.log("  文件名:",a),console.log("  新分组:",t),console.log("  目标目录:",r);let l=await fetch("/api/storage/reclassify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPath:s,newPath:n})});if(!l.ok){let e=await l.text();throw console.error("[Reclassify] 文件移动失败:",e),Error(`Failed to move book files: ${e}`)}let c=await l.json();e.relativePath=n,e.groupName=t||void 0,c.absolutePath&&(e.absolutePath=c.absolutePath),console.log("[Reclassify] 文件移动成功:",c)}catch(e){throw console.error("[Reclassify] 重新分类书籍时出错:",e),e}}async deleteBook(e,t){if(console.log("Deleting book with action:",t,e.title),"local"===t||"both"===t){for(let i of"local"===t?[(0,a.getLocalBookFilename)(e)]:[(0,a.getLocalBookFilename)(e),(0,a.getCoverFilename)(e)])console.log("Deleting local file:",i),await this.fs.removeFile(i,"Books");"local"===t?e.downloadedAt=null:(e.deletedAt=Date.now(),e.downloadedAt=null,e.coverDownloadedAt=null)}("cloud"===t||"both"===t)&&e.uploadedAt&&(console.log("Cloud delete operation skipped - cloud storage removed"),e.uploadedAt=null)}async exportBook(e){let{file:t}=await this.loadBookContent(e),i=await t.arrayBuffer(),r=`${(0,w.makeSafeFilename)(e.title)}.${e.format.toLowerCase()}`,o=await this.resolveFilePath((0,a.getLocalBookFilename)(e),"Books"),s=t.type||"application/octet-stream";return await this.saveFile(r,i,o,s)}async isBookAvailable(e){let t=(0,a.getLocalBookFilename)(e);return!!await this.fs.exists(t,"Books")||(e.filePath?await this.fs.exists(e.filePath,"None"):!!e.url&&(0,w.isValidURL)(e.url))}async getBookFileSize(e){let t=(0,a.getLocalBookFilename)(e);if(await this.fs.exists(t,"Books")){let e=await this.fs.openFile(t,"Books"),i=e.size;return e&&e.close&&await e.close(),i}return null}async loadBookContent(e){let t,i=(0,a.getLocalBookFilename)(e);if(await this.fs.exists(i,"Books"))t=await this.fs.openFile(i,"Books");else if(e.filePath)t=await this.fs.openFile(e.filePath,"None");else if(e.url)t=await this.fs.openFile(e.url,"None");else{let i=(0,a.getDir)(e),r=await this.fs.readDir((0,a.getDir)(e),"Books");if(r.length>0){let a=r.find(t=>t.path.endsWith(`.${n.EXTS[e.format]}`));if(a)t=await this.fs.openFile(`${i}/${a.path}`,"Books");else throw Error(v)}else throw Error(v)}return{book:e,file:t}}async loadBookConfig(e,t){let r={...t.globalViewSettings,...i.FIXED_LAYOUT_FORMATS.has(e.format)?l.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};try{let t="{}";return await this.fs.exists((0,a.getConfigFilename)(e),"Books")&&(t=await this.fs.readFile((0,a.getConfigFilename)(e),"Books","text")),y(t,r,l.DEFAULT_BOOK_SEARCH_CONFIG)}catch{return y("{}",r,l.DEFAULT_BOOK_SEARCH_CONFIG)}}async fetchBookDetails(e){let t=(0,a.getLocalBookFilename)(e);if(!await this.fs.exists(t,"Books")&&e.uploadedAt)throw console.warn("Book file not found locally and cloud download is disabled:",e.title),Error("Book file not found locally");let{file:i}=await this.loadBookContent(e),r=(await new n.DocumentLoader(i).open()).book;return i&&i.close&&await i.close(),r.metadata}async saveBookConfig(e,t,r){let o;if(r){var s,n;let a,c,h={...r.globalViewSettings,...i.FIXED_LAYOUT_FORMATS.has(e.format)?l.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};s=t,n=l.DEFAULT_BOOK_SEARCH_CONFIG,a=(s=JSON.parse(JSON.stringify(s))).viewSettings,c=s.searchConfig,s.viewSettings=Object.entries(a).reduce((e,[t,i])=>(h[t]!==i&&(e[t]=i),e),{}),s.searchConfig=Object.entries(c).reduce((e,[t,i])=>(n[t]!==i&&(e[t]=i),e),{}),o=JSON.stringify(s)}else o=JSON.stringify(t);await this.fs.writeFile((0,a.getConfigFilename)(e),"Books",o)}async generateCoverImageUrl(e){return"web"===this.appPlatform?await this.getCoverImageBlobUrl(e):this.getCoverImageUrl(e)}async loadLibraryBooks(){console.log("Loading library books...");let e=(0,a.getLibraryFilename)();await this.fs.exists("","Books")||await this.fs.createDir("","Books",!0);let t=await this.safeLoadJSON(e,"Books",[]);return await Promise.all(t.map(async e=>(e.coverImageUrl=await this.generateCoverImageUrl(e),e.updatedAt??=e.lastUpdated||Date.now(),e))),t}async saveLibraryBooks(e){let t=e.map(({coverImageUrl:e,...t})=>t);await this.safeSaveJSON((0,a.getLibraryFilename)(),"Books",t)}async reconcileBookPaths(e){if("web"!==this.appPlatform)return console.log("[Reconcile] 非本地存储模式，跳过路径校准"),{success:!1,error:"Not in local storage mode"};try{console.log("[Reconcile] 开始校准书籍路径，共",e.length,"本书");let t=e.filter(e=>!e.deletedAt).map(e=>({hash:e.hash,relativePath:e.relativePath,absolutePath:e.absolutePath,title:e.title,groupName:e.groupName})),i=await fetch("/api/storage/reconcile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({library:t})});if(!i.ok){let e=await i.text();throw console.error("[Reconcile] 路径校准失败:",e),Error(`Failed to reconcile paths: ${e}`)}let a=await i.json();return console.log("[Reconcile] 路径校准完成:",a.summary),a}catch(e){throw console.error("[Reconcile] 路径校准出错:",e),e}}async applyReconciliation(e,t){let i=[...e];for(let e of t)if("moved"===e.status){let t=i.findIndex(t=>t.hash===e.hash);if(-1!==t){let a=i[t];a&&(a.relativePath=e.newRelativePath,a.absolutePath=e.absolutePath,void 0!==e.suggestedGroupName&&(a.groupName=e.suggestedGroupName,a.groupId=e.suggestedGroupName?(0,r.md5Fingerprint)(e.suggestedGroupName):""),a.updatedAt=Date.now(),console.log("[Reconcile] 更新书籍:",a.title,"新路径:",a.relativePath))}}return await this.saveLibraryBooks(i),i}imageToArrayBuffer(e,t){return new Promise((i,a)=>{e||t?"web"===this.appPlatform&&e&&e.startsWith("blob:")?fetch(e).then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):"tauri"===this.appPlatform&&t?this.fs.openFile(t,"None").then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):"tauri"===this.appPlatform&&e?m(e,{method:"GET"}).then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):a(Error("Unsupported platform or missing image data")):a(Error("No image URL or file provided"))})}async updateCoverImage(e,t,i){if("_blank"===t)await this.fs.removeFile((0,a.getCoverFilename)(e),"Books");else if(t||i){let r=await this.imageToArrayBuffer(t,i);await this.fs.writeFile((0,a.getCoverFilename)(e),"Books",r)}}async loadJSONFile(e,t){try{let i=await this.fs.readFile(e,t,"text");if(!i||"string"!=typeof i||0===i.trim().length)return{success:!1,error:"File is empty or invalid"};try{let e=JSON.parse(i);return{success:!0,data:e}}catch(e){return{success:!1,error:`JSON parse error: ${e}`}}}catch(e){return{success:!1,error:e}}}async safeLoadJSON(e,t,i){let a=`${e}.bak`,r=await this.loadJSONFile(e,t);if(r.success)return r.data;console.warn(`Failed to load ${e}, attempting backup...`,r.error);let o=await this.loadJSONFile(a,t);if(o.success){console.warn(`Loaded from backup: ${a}`);try{let i=JSON.stringify(o.data,null,2);await this.fs.writeFile(e,t,i),console.log(`Restored ${e} from backup`)}catch(t){console.error(`Failed to restore ${e} from backup:`,t)}return o.data}return console.error(`Both ${e} and ${a} failed to load`),i}async safeSaveJSON(e,t,i){let a=`${e}.bak`,r=JSON.stringify(i,null,2);try{await this.fs.writeFile(a,t,r),await this.fs.writeFile(e,t,r)}catch(t){throw console.error(`Failed to save ${e}:`,t),Error(`Failed to save ${e}: ${t}`)}}async ensureLocalBookDirs(e){if(e.relativePath){let t=e.relativePath.split("/").slice(0,-1).join("/"),i=e.relativePath.replace(/\.[^.]+$/,"");t&&await this.fs.createDir(t,"Books",!0),await this.fs.createDir(i,"Books",!0);return}await this.fs.exists((0,a.getDir)(e),"Books")||await this.fs.createDir((0,a.getDir)(e),"Books")}async migrate20251124(){console.log("Running migration for version 20251124 to rename the backup library file...");let e=(0,a.getLibraryBackupFilename)(),t=`${(0,a.getLibraryFilename)()}.bak`;if(await this.fs.exists(e,"Books"))try{let i=await this.fs.readFile(e,"Books","text");await this.fs.writeFile(t,"Books",i),await this.fs.removeFile(e,"Books"),console.log("Migration to rename backup library file completed successfully.")}catch(e){console.error("Error during migration to rename backup library file:",e)}}async migrate20260121(){if("web"!==this.appPlatform)return void console.log("[Migration 20260121] Skip (not web/local mode)");console.log("[Migration 20260121] Start migrating legacy hash-based books to flat layout");let e=await this.loadLibraryBooks(),t=0;for(let i of e){if(i.relativePath)continue;let e=n.EXTS[i.format]||i.format?.toLowerCase?.()||"book",a=(0,w.makeSafeFilename)(i.sourceTitle||i.title||i.hash),r=`${i.groupName?`${i.groupName}/`:""}${a}.${e}`,o=`${i.hash}/${a}.${e}`,s=`${i.hash}/cover.png`,l=`${i.hash}/config.json`,c=r.replace(/\.[^.]+$/,"")+"/cover.png",h=r.replace(/\.[^.]+$/,"")+"/config.json";try{if(await this.fs.exists(o,"Books")){await this.ensureLocalBookDirs({...i,relativePath:r});let e=await this.fs.openFile(o,"Books");await this.fs.writeFile(r,"Books",e),await this.fs.removeFile(o,"Books")}if(await this.fs.exists(s,"Books")){let e=await this.fs.openFile(s,"Books");await this.fs.writeFile(c,"Books",e),await this.fs.removeFile(s,"Books")}if(await this.fs.exists(l,"Books")){let e=await this.fs.readFile(l,"Books","text");await this.fs.writeFile(h,"Books",e),await this.fs.removeFile(l,"Books")}i.relativePath=r,t++}catch(e){console.error("[Migration 20260121] Failed to migrate book:",i.title,e)}}t>0?(await this.saveLibraryBooks(e),console.log(`[Migration 20260121] Migrated ${t} book(s) to flat layout`)):console.log("[Migration 20260121] No legacy books to migrate")}}e.s(["BaseAppService",()=>D],199236)}];

//# sourceMappingURL=_3024491f._.js.map