module.exports=[940232,e=>{"use strict";let t;var r=e.i(369955),i=e.i(602072),a=e.i(839721),o=e.i(734759),n=e.i(240963),s=e.i(347364),l=e.i(465427),u=e.i(522032),c=e.i(123884),d=e.i(77187),h=e.i(171603),p=e.i(702259),m=e.i(697626),g=e.i(614258),f=e.i(524194),v=e.i(138657),y=e.i(193695);e.i(769036);var b=e.i(874096),w=e.i(834798),R=e.i(509979),I=e.i(304998);class E{maxResults=5;async search(e){let t=!!e.isbn&&e.isbn.trim().length>0,r=!!e.title&&e.title.trim().length>0,i=[];try{if(t?i=await this.searchByISBN(e.isbn.trim()):r&&(i=await this.searchByTitle(e.title.trim(),e.author?.trim(),e.language?.trim())),i&&i.length>0)return i.map(t=>{let r=this.calculateConfidence(t,e);return{metadata:t,confidence:r,providerName:this.name,providerLabel:this.label}});return[]}catch(e){throw console.error(`${this.name} provider search failed:`,e),e}}calculateConfidence(e,t){let r=50;return t.isbn&&e.identifier&&this.cleanISBN(t.isbn)===this.cleanISBN(e.identifier)&&(r+=40),t.title&&e.title&&(r+=Math.floor(30*this.calculateStringSimilarity(t.title.toLowerCase(),e.title.toLowerCase()))),t.author&&e.author&&(r+=Math.floor(20*this.calculateStringSimilarity(t.author.toLowerCase(),e.author.toLowerCase()))),e.coverImageUrl||(r-=20),Math.min(100,Math.max(0,r+=this.getProviderConfidenceBonus()))}getProviderConfidenceBonus(){return 0}calculateStringSimilarity(e,t){let r=e.length>t.length?e:t,i=e.length>t.length?t:e;if(0===r.length)return 1;let a=this.levenshteinDistance(r,i);return(r.length-a)/r.length}levenshteinDistance(e,t){let r=[];for(let e=0;e<=t.length;e++)r[e]=[e];for(let t=0;t<=e.length;t++)r[0][t]=t;for(let i=1;i<=t.length;i++)for(let a=1;a<=e.length;a++)t.charAt(i-1)===e.charAt(a-1)?r[i][a]=r[i-1][a-1]:r[i][a]=Math.min(r[i-1][a-1]+1,r[i][a-1]+1,r[i-1][a]+1);return r[t.length][e.length]}cleanISBN(e){return e.replace(/[-\s]/g,"")}validateISBN(e){let t=this.cleanISBN(e);return/^\d{10}(\d{3})?$/.test(t)}}var S=e.i(745622);class B extends E{name="openlibrary";label=(0,R.stubTranslation)("Open Library");baseUrl="https://openlibrary.org";getProviderConfidenceBonus(){return 0}async searchByISBN(e){if(!this.validateISBN(e))throw Error("Invalid ISBN format");try{let t=await (0,I.fetchWithTimeout)(`${this.baseUrl}/api/books?bibkeys=ISBN:${e}&format=json&jscmd=data`);if(!t.ok)throw Error(`Open Library API error: ${t.status}`);let r=(await t.json())[`ISBN:${e}`];if(!r)return[];return[this.formatBookData(r,e)]}catch(e){throw console.error("Open Library ISBN search failed:",e),e}}async searchByTitle(e,t,r){if(!e||0===e.trim().length)throw Error("Title is required");try{let i=`title=${encodeURIComponent(e.trim())}`;t&&t.trim()&&(i+=`&author=${encodeURIComponent(t.trim())}`),r&&r.trim()&&(i+=`&lang=${encodeURIComponent((0,S.normalizedLangCode)(r.trim()))}`);let a=await (0,I.fetchWithTimeout)(`${this.baseUrl}/search.json?${i}`);if(!a.ok)throw Error(`Open Library API error: ${a.status}`);let o=await a.json();if(console.log("Open Library search results:",o),!o.docs||0===o.docs.length)return[];return o.docs.map(e=>this.formatSearchResult(e)).filter(e=>!r||e.language===r).slice(0,this.maxResults)}catch(e){throw console.error("Open Library title search failed:",e),e}}formatBookData(e,t){return{title:e.title||"",author:e.authors?.[0]?.name||"",publisher:e.publishers?.[0]?.name,published:e.publish_date,language:(0,S.code6392to6391)(e.languages?.[0]?.name||""),identifier:t,coverImage:e.cover?.large||e.cover?.medium||e.cover?.small,subjects:e.subjects?.map(e=>e.name).slice(0,5)||[],description:this.extractDescription(e.description||"")}}formatSearchResult(e){return{title:e.title||"",author:e.author_name?.[0]||"",publisher:e.publisher?.[0],published:e.first_publish_year?.toString(),language:(0,S.code6392to6391)(e.language?.[0]||""),identifier:e.isbn?.[0],coverImageUrl:e.cover_i?`https://covers.openlibrary.org/b/id/${e.cover_i}-L.jpg`:void 0,subjects:e.subject?.slice(0,5)||[],description:e.description?.[0]}}extractDescription(e){if(e){if("string"==typeof e)return e;if(e.value)return e.value}}}class C extends E{name="googlebooks";label=(0,R.stubTranslation)("Google Books");baseUrl="https://www.googleapis.com/books/v1";apiKeys;constructor(e){if(super(),!e)throw Error("Google Books API keys are required");this.apiKeys=e.split(",").map(e=>e.trim())}getProviderConfidenceBonus(){return 10}get apiKey(){return this.apiKeys[Math.floor(Math.random()*this.apiKeys.length)]}async searchByISBN(e){if(!this.validateISBN(e))throw Error("Invalid ISBN format");try{let t=await (0,I.fetchWithTimeout)(`${this.baseUrl}/volumes?q=isbn:${e}&key=${this.apiKey}`);if(!t.ok){if(429===t.status)throw Error("Google Books API rate limit exceeded");if(403===t.status)throw Error("Google Books API access forbidden. Check your API key.");throw Error(`Google Books API error: ${t.status}`)}let r=await t.json();if(!r.items||0===r.items.length)return[];return r.items.slice(0,this.maxResults).map(e=>this.formatBookData(e.volumeInfo))}catch(e){throw console.error("Google Books ISBN search failed:",e),e}}async searchByTitle(e,t,r){if(!e||0===e.trim().length)throw Error("Title is required");try{let i=`intitle:${e.trim()}`;t&&t.trim()&&(i+=`+inauthor:${t.trim()}`),r&&r.trim()&&(i+=`+language:${(0,S.normalizedLangCode)(r.trim())}`);let a=await (0,I.fetchWithTimeout)(`${this.baseUrl}/volumes?q=${encodeURIComponent(i)}&key=${this.apiKey}`);if(!a.ok){if(429===a.status)throw Error("Google Books API rate limit exceeded");if(403===a.status)throw Error("Google Books API access forbidden. Check your API key.");throw Error(`Google Books API error: ${a.status}`)}let o=await a.json();if(!o.items||0===o.items.length)return[];return o.items.slice(0,this.maxResults).map(e=>this.formatBookData(e.volumeInfo))}catch(e){throw console.error("Google Books title search failed:",e),e}}formatBookData(e){return{title:e.title||"",subtitle:e.subtitle||"",author:this.formatAuthors(e.authors),publisher:e.publisher,published:e.publishedDate,language:e.language||"en",identifier:this.extractISBN(e.industryIdentifiers),coverImageUrl:this.getCoverImage(e.imageLinks),subjects:e.categories||[],description:this.cleanDescription(e.description)}}formatAuthors(e){return e&&0!==e.length?1===e.length?e[0]:2===e.length?e.join(" & "):`${e[0]} et al.`:""}extractISBN(e){if(!e||0===e.length)return;let t=e.find(e=>"ISBN_13"===e.type);if(t)return t.identifier;let r=e.find(e=>"ISBN_10"===e.type);return r?r.identifier:e[0].identifier}getCoverImage(e){if(!e)return;let t=e.extraLarge||e.large||e.medium||e.small||e.thumbnail||e.smallThumbnail;return t?t.replace("http:","https:"):void 0}cleanDescription(e){if(e)return e.replace(/<[^>]*>/g,"").replace(/\s+/g," ").trim()}}class N{providers=[];constructor(e={}){this.providers.push(new B),e.googleBooksApiKeys&&this.providers.push(new C(e.googleBooksApiKeys)),e.providers&&this.providers.push(...e.providers)}async search(e){let t=[],r=this.providers.map(async t=>{try{return await t.search(e)||[]}catch(e){return console.warn(`Provider ${t.name} failed:`,e),[]}});return(await Promise.allSettled(r)).forEach(e=>{"fulfilled"===e.status&&t.push(...e.value)}),t.sort((e,t)=>t.confidence-e.confidence)}getProviders(){return this.providers.map(e=>e.name)}getProviderCount(){return this.providers.length}}var A=e.i(155724);function k(e,t=null,r=null,i){return{success:e,data:t||void 0,error:r||void 0,timestamp:new Date().toISOString(),responseTime:i}}async function x(e){let{user:r,token:i}=await (0,A.validateUserAndToken)(e.headers.get("authorization"));if(!r||!i)return w.NextResponse.json({error:"Not authenticated"},{status:403});let a=Date.now();try{let r=await e.json(),i=function(e){let{title:t,isbn:r,author:i,language:a}=e;if((!t||"string"!=typeof t||0===t.trim().length)&&(!r||"string"!=typeof r||0===r.trim().length))return{isValid:!1,error:"Either title or isbn parameter is required and must be a non-empty string"};if(t&&"string"!=typeof t)return{isValid:!1,error:"Title must be a string if provided"};if(r&&"string"!=typeof r)return{isValid:!1,error:"ISBN must be a string if provided"};if(i&&"string"!=typeof i)return{isValid:!1,error:"Author must be a string if provided"};if(r){let e=r.replace(/[-\s]/g,"");if(!/^\d{10}(\d{3})?$/.test(e))return{isValid:!1,error:"Invalid ISBN format. Must be 10 or 13 digits"}}return{isValid:!0,data:{title:t?.trim(),isbn:r?.trim(),author:i?.trim(),language:a?.trim()}}}(r);if(!i.isValid){let e=Date.now()-a;return w.NextResponse.json(k(!1,null,i.error,e),{status:400})}let o=(t||(t=new N({googleBooksApiKeys:process.env.GOOGLE_BOOKS_API_KEYS})),t),n=await o.search(i.data),s=Date.now()-a;if(!n)return w.NextResponse.json(k(!1,null,"Book not found",s),{status:404});return w.NextResponse.json(k(!0,n,null,s),{status:200})}catch(i){let e=Date.now()-a;console.error("Search API error:",i);let t="Internal server error",r=500;return i instanceof Error&&(t=i.message,i.message.includes("rate limit")?r=429:i.message.includes("forbidden")||i.message.includes("API key")?r=403:i.message.includes("Invalid ISBN")&&(r=400)),w.NextResponse.json(k(!1,null,t,e),{status:r})}}e.s(["POST",()=>x],495361);var P=e.i(495361);let T=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/metadata/search/route",pathname:"/api/metadata/search",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/apps/readest-app/src/app/api/metadata/search/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:$,workUnitAsyncStorage:O,serverHooks:_}=T;function D(){return(0,a.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:O})}async function U(e,t,r){T.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/metadata/search/route";a=a.replace(/\/index$/,"")||"/";let w=await T.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:I,nextConfig:E,parsedUrl:S,isDraftMode:B,prerenderManifest:C,routerServerContext:N,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,resolvedPathname:x,clientReferenceManifest:P,serverActionsManifest:$}=w,O=(0,u.normalizeAppPath)(a),_=!!(C.dynamicRoutes[O]||C.routes[x]),D=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,S,!1):t.end("This page could not be found"),null);if(_&&!B){let e=!!C.routes[x],t=C.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await D();throw new y.NoFallbackError}}let U=null;!_||T.isDev||B||(U="/index"===(U=x)?"/":U);let j=!0===T.isDev||!_,M=_&&!j;$&&P&&(0,s.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:P,serverActionsManifest:$,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:$})});let L=e.method||"GET",q=(0,n.getTracer)(),K=q.getActiveScopeSpan(),H={params:I,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i)=>T.onRequestError(e,t,i,N)},sharedContext:{buildId:R}},G=new c.NodeNextRequest(e),V=new c.NodeNextResponse(t),F=d.NextRequestAdapter.fromNodeNextRequest(G,(0,d.signalFromNodeResponse)(t));try{let s=async e=>T.handle(F,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${L} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${a}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),u=async o=>{var n,u;let c=async({previousCacheEntry:i})=>{try{if(!l&&A&&k&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(o);e.fetchMetrics=H.renderOpts.fetchMetrics;let n=H.renderOpts.pendingWaitUntil;n&&r.waitUntil&&(r.waitUntil(n),n=void 0);let u=H.renderOpts.collectedTags;if(!_)return await (0,m.sendResponse)(G,V,a,H.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[v.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,i=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})},N),t}},d=await T.handleResponse({req:e,nextConfig:E,cacheKey:U,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!_)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),B&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&_||h.delete(v.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(G,V,new Response(d.value.body,{headers:h,status:d.value.status||200})),null};K?await u(K):await q.withPropagatedContext(e.headers,()=>q.trace(h.BaseServerSpan.handleRequest,{spanName:`${L} ${a}`,kind:n.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},u))}catch(t){if(t instanceof y.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})}),_)throw t;return await (0,m.sendResponse)(G,V,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>D,"routeModule",()=>T,"serverHooks",()=>_,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>O],940232)}];

//# sourceMappingURL=004ea_next_dist_esm_build_templates_app-route_d674c856.js.map