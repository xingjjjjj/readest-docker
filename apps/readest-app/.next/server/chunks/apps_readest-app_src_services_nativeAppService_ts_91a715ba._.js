module.exports=[516268,e=>{"use strict";var i=e.i(463783),t=e.i(373852),a=e.i(826165);async function r(e={}){return"object"==typeof e&&Object.freeze(e),await (0,a.invoke)("plugin:dialog|open",{options:e})}async function s(e={}){return"object"==typeof e&&Object.freeze(e),await (0,a.invoke)("plugin:dialog|save",{options:e})}async function o(e,i){await (0,a.invoke)("plugin:sharekit|share_file",{url:e,...i})}var n=e.i(509979),l=e.i(187984),c=e.i(227711);async function p(e){return await (0,a.invoke)("plugin:native-bridge|copy_uri_to_path",{payload:e})}let h=async(e,i,t)=>{let a=[];try{a=await e.readDirectory(i,"None")}catch{throw Error(`Dir ${i} failed to read.`)}for(let r=0;r<a.length;r++){let s=a[r],o=`${i}/${s.path}`,n=`${t}/${s.path}`;await e.copyFile(o,n,"None")}let r=await e.readDirectory(t,"None");for(let e of a)if(!r.find(i=>i.path===e.path&&i.size===e.size))throw Error(`File ${e.path} failed to copy.`)};var d=e.i(199236),w=e.i(57990);let u=null,D=()=>(null===u&&(u=window.__TAURI_OS_PLUGIN_INTERNALS__.os_type),u),f=({customRootDir:e,isPortable:i,execDir:a}={})=>{let r=e?0:void 0,s=!!e,o=s?i=>()=>{let t=["Settings","Data","Books","Fonts","Images"].includes(i)?"":i;return t?`${e}/${t}`:e}:void 0,n=o?e=>async()=>o(e)():void 0;return(e,l)=>{let c=o?.(l),p=n?.(l);switch(l){case"Settings":return{baseDir:i?0:t.BaseDirectory.AppConfig,basePrefix:i&&a?async()=>a:t.appConfigDir,fp:i&&a?`${a}${e?`/${e}`:""}`:e,base:l};case"Cache":return{baseDir:t.BaseDirectory.AppCache,basePrefix:t.appCacheDir,fp:e,base:l};case"Log":return{baseDir:s?0:t.BaseDirectory.AppLog,basePrefix:p??t.appLogDir,fp:c?`${c()}${e?`/${e}`:""}`:e,base:l};case"Data":return{baseDir:r??t.BaseDirectory.AppData,basePrefix:p??t.appDataDir,fp:c?`${c()}/${w.DATA_SUBDIR}${e?`/${e}`:""}`:`${w.DATA_SUBDIR}${e?`/${e}`:""}`,base:l};case"Books":return{baseDir:r??t.BaseDirectory.AppData,basePrefix:p||t.appDataDir,fp:c?`${c()}/${w.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`:`${w.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Fonts":return{baseDir:r??t.BaseDirectory.AppData,basePrefix:p||t.appDataDir,fp:c?`${c()}/${w.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`:`${w.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Images":return{baseDir:r??t.BaseDirectory.AppData,basePrefix:p||t.appDataDir,fp:c?`${c()}/${w.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`:`${w.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`,base:l};case"None":return{baseDir:0,basePrefix:async()=>"",fp:e,base:l};default:return{baseDir:t.BaseDirectory.Temp,basePrefix:t.tempDir,fp:e,base:l}}}},y={resolvePath:f(),async getPrefix(e){let{basePrefix:i,fp:a,baseDir:r}=this.resolvePath("",e),s=await i();return s=s.replace(/\/+$/,""),a?0===r?a:await (0,t.join)(s,a):s},getURL:e=>(0,n.isValidURL)(e)?e:(0,a.convertFileSrc)(e),async getBlobURL(e,i){let t=await this.readFile(e,i,"binary");return URL.createObjectURL(new Blob([t]))},async getImageURL(e){return this.getURL(e)},async openFile(e,i,a){let{fp:r,baseDir:s}=this.resolvePath(e,i),o=a||(0,l.getFilename)(r);if((0,n.isValidURL)(e))return await new c.RemoteFile(e,o).open();if((0,n.isContentURI)(e)||(0,n.isFileURI)(e)&&"ios"===D()){if(o=await (0,t.basename)(e),e.includes("com.android.externalstorage"))return await new c.NativeFile(r,o,s||null).open();{let i=await this.getPrefix("Cache"),a=await (0,t.join)(i,decodeURIComponent(o)),r=await p({uri:e,dst:a});if(!r.success)throw console.error("Failed to open file:",r),Error("Failed to open file");return await new c.NativeFile(a,o,s||null).open()}}{if((0,n.isFileURI)(e)||"android"===D())return await new c.NativeFile(r,o,s||null).open();let a=await this.getPrefix(i),l=a?await (0,t.join)(a,e):e;return await new c.RemoteFile(this.getURL(l),o).open()}},async copyFile(e,a,r){try{await this.exists((0,l.getDirPath)(a),r)||await this.createDir((0,l.getDirPath)(a),r,!0)}catch(e){console.log("Failed to create directory for copying file:",e)}if((0,n.isContentURI)(e)){let i=await this.getPrefix(r);if(!i)throw Error("Invalid base directory");let s=await p({uri:e,dst:await (0,t.join)(i,a)});if(!s.success)throw console.error("Failed to copy file:",s),Error("Failed to copy file")}else{let{fp:t,baseDir:s}=this.resolvePath(a,r);await (0,i.copyFile)(e,t,s?{toPathBaseDir:s}:void 0)}},async readFile(e,t,a){let{fp:r,baseDir:s}=this.resolvePath(e,t);return"text"===a?(0,i.readTextFile)(r,s?{baseDir:s}:void 0):(await (0,i.readFile)(r,s?{baseDir:s}:void 0)).buffer},async writeFile(e,t,a){let{fp:r,baseDir:s}=this.resolvePath(e,t);return(await this.exists((0,l.getDirPath)(e),t)||await this.createDir((0,l.getDirPath)(e),t,!0),"string"==typeof a)?(0,i.writeTextFile)(r,a,s?{baseDir:s}:void 0):a instanceof File?await (0,i.writeFile)(r,a.stream(),{write:!0,create:!0,baseDir:s||void 0}):await (0,i.writeFile)(r,new Uint8Array(a),s?{baseDir:s}:void 0)},async removeFile(e,t){let{fp:a,baseDir:r}=this.resolvePath(e,t);await (0,i.remove)(a,r?{baseDir:r}:void 0)},async createDir(e,t,a=!1){let{fp:r,baseDir:s}=this.resolvePath(e,t);await (0,i.mkdir)(r,{baseDir:s||void 0,recursive:a})},async removeDir(e,t,a=!1){let{fp:r,baseDir:s}=this.resolvePath(e,t);await (0,i.remove)(r,{baseDir:s||void 0,recursive:a})},async readDir(e,r){let{fp:s,baseDir:o}=this.resolvePath(e,r);if(!o||0===o)try{return(await (0,a.invoke)("read_dir",{path:s,recursive:!0,extensions:["*"]})).map(e=>{var i;let t;return{path:(i=e.path,t=i,i.toLowerCase().startsWith(s.toLowerCase())&&(t=i.substring(s.length)),(t.startsWith("\\")||t.startsWith("/"))&&(t=t.substring(1)),t),size:e.size}})}catch(e){console.error("Rust read_dir failed, falling back to JS recursion",e)}let n=await (0,i.readDir)(s,o?{baseDir:o}:void 0),l=[],c=async(e,a,r,s)=>{for(let n of r)if(n.isDirectory){let r=await (0,t.join)(e,n.name),l=a?await (0,t.join)(a,n.name):n.name;try{let e=await (0,i.readDir)(r,o?{baseDir:o}:void 0);await c(r,l,e,s)}catch{console.warn(`Skipping unreadable dir: ${r}`)}}else{let r=await (0,t.join)(e,n.name),l=a?await (0,t.join)(a,n.name):n.name,c=o?{baseDir:o}:void 0,p=await (0,i.stat)(r,c).then(e=>e.size).catch(()=>0);s.push({path:l,size:p})}};return await c(s,"",n,l),l},async exists(e,t){let{fp:a,baseDir:r}=this.resolvePath(e,t);try{return await (0,i.exists)(a,r?{baseDir:r}:void 0)}catch{return!1}},async stats(e,t){let{fp:a,baseDir:r}=this.resolvePath(e,t);return await (0,i.stat)(a,r?{baseDir:r}:void 0)}},g=process.env.NEXT_PUBLIC_DIST_CHANNEL||"readest";class v extends d.BaseAppService{fs=y;appPlatform="tauri";isAppDataSandbox=!1;isMobile=!1;isAndroidApp=!1;isIOSApp=!1;isMacOSApp=!1;isLinuxApp=!1;isMobileApp=!1;isDesktopApp=!1;isEink=!!window.__READEST_IS_EINK;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir="appstore"!==g;canReadExternalDir="appstore"!==g&&"playstore"!==g;distChannel=g;execDir=void 0;async init(){let e=D();this.isAppDataSandbox=["android","ios"].includes(e),this.isMobile=["android","ios"].includes(e),this.isAndroidApp="android"===e,this.isIOSApp="ios"===e,this.isMacOSApp="macos"===e,this.isLinuxApp="linux"===e,this.isMobileApp=["android","ios"].includes(e),this.isDesktopApp=["macos","windows","linux"].includes(e),this.hasTrafficLight="macos"===e,this.hasWindow="ios"!==e&&"android"!==e,this.hasWindowBar="ios"!==e&&"android"!==e,this.hasContextMenu="ios"!==e&&"android"!==e,this.hasRoundedWindow="linux"===e,this.hasSafeAreaInset="ios"===e||"android"===e,this.hasHaptics="ios"===e||"android"===e,this.hasUpdater="ios"!==e&&!process.env.NEXT_PUBLIC_DISABLE_UPDATER&&!window.__READEST_UPDATER_DISABLED,this.hasOrientationLock="ios"===e&&"ios"===(0,n.getOSPlatform)()||"android"===e,this.hasScreenBrightness="ios"===e||"android"===e,this.hasIAP="ios"===e||"android"===e&&"playstore"===g;let i=await (0,a.invoke)("get_executable_dir");this.execDir=i,(process.env.NEXT_PUBLIC_PORTABLE_APP||await this.fs.exists(`${i}/${w.SETTINGS_FILENAME}`,"None"))&&(this.isPortableApp=!0,this.fs.resolvePath=f({customRootDir:i,isPortable:this.isPortableApp,execDir:i}));let t=await this.loadSettings();t.customRootDir&&(this.fs.resolvePath=f({customRootDir:t.customRootDir,isPortable:this.isPortableApp,execDir:i})),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let e=await this.loadSettings(),i=e.migrationVersion||0;if(await super.runMigrations(i),i<0x1350195)try{await this.migrate20251029()}catch(e){console.error("Error migrating to version 20251029:",e)}i<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...e,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(e){console.error("Failed to run migrations:",e)}}resolvePath(e,i){return this.fs.resolvePath(e,i)}async setCustomRootDir(e){this.fs.resolvePath=f({customRootDir:e,isPortable:this.isPortableApp,execDir:this.execDir}),await this.prepareBooksDir()}async selectDirectory(){return await r({directory:!0,multiple:!1,recursive:!0})}async selectFiles(e,i){let t=await r({multiple:!0,filters:[{name:e,extensions:i}]});return Array.isArray(t)?t:t?[t]:[]}async saveFile(e,t,a,r){try{let n=e.split(".").pop()||"";if(this.isIOSApp)await o(a,{mimeType:r||"application/octet-stream"});else{let a=await s({defaultPath:e,filters:[{name:n.toUpperCase(),extensions:[n]}]});if(!a)return!1;"string"==typeof t?await (0,i.writeTextFile)(a,t):await (0,i.writeFile)(a,new Uint8Array(t))}return!0}catch(e){return console.error("Failed to save file:",e),!1}}async migrate20251029(){console.log("Running migration 20251029 to update paths in Images dir...");let e=await this.resolveFilePath("..","Data"),i=await this.fs.getPrefix("Images"),a=await (0,t.join)(e,"Images","Readest","Images");await h(this,a,i);let r=await (0,t.join)(e,"Images","Readest");await this.deleteDir(r,"None",!0)}}e.s(["NativeAppService",()=>v,"nativeFileSystem",0,y],516268)}];

//# sourceMappingURL=apps_readest-app_src_services_nativeAppService_ts_91a715ba._.js.map