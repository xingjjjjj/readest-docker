{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/config.ts"],"sourcesContent":["import { ViewSettings } from '@/types/book';\n\nexport const getMaxInlineSize = (viewSettings: ViewSettings) => {\n  const isVertical = viewSettings.vertical;\n  const screenWidth = window.innerWidth;\n  const screenHeight = window.innerHeight;\n\n  const screenAspectRatio = isVertical ? screenHeight / screenWidth : screenWidth / screenHeight;\n  const isUnfoldedScreen = screenAspectRatio < 1.3 && screenAspectRatio > 0.77 && screenWidth > 600;\n\n  return isVertical\n    ? Math.max(screenWidth, screenHeight, 720, viewSettings.maxInlineSize)\n    : isUnfoldedScreen\n      ? viewSettings.maxInlineSize * 0.8\n      : viewSettings.maxInlineSize;\n};\n\nexport const getDefaultMaxInlineSize = () => {\n  if (typeof window === 'undefined') return 720;\n\n  const screenWidth = window.innerWidth;\n  const screenHeight = window.innerHeight;\n  return screenWidth < screenHeight ? Math.max(screenWidth, 720) : 720;\n};\n\nexport const getDefaultMaxBlockSize = () => {\n  if (typeof window === 'undefined') return 1440;\n\n  const screenWidth = window.innerWidth;\n  const screenHeight = window.innerHeight;\n  return Math.max(screenWidth, screenHeight, 1440);\n};\n"],"names":[],"mappings":";;;;;;;;AAEO,MAAM,mBAAmB,CAAC;IAC/B,MAAM,aAAa,aAAa,QAAQ;IACxC,MAAM,cAAc,OAAO,UAAU;IACrC,MAAM,eAAe,OAAO,WAAW;IAEvC,MAAM,oBAAoB,aAAa,eAAe,cAAc,cAAc;IAClF,MAAM,mBAAmB,oBAAoB,OAAO,oBAAoB,QAAQ,cAAc;IAE9F,OAAO,aACH,KAAK,GAAG,CAAC,aAAa,cAAc,KAAK,aAAa,aAAa,IACnE,mBACE,aAAa,aAAa,GAAG,MAC7B,aAAa,aAAa;AAClC;AAEO,MAAM,0BAA0B;IACrC;;IAEA,MAAM,cAAc,OAAO,UAAU;IACrC,MAAM,eAAe,OAAO,WAAW;IACvC,OAAO,cAAc,eAAe,KAAK,GAAG,CAAC,aAAa,OAAO;AACnE;AAEO,MAAM,yBAAyB;IACpC;;IAEA,MAAM,cAAc,OAAO,UAAU;IACrC,MAAM,eAAe,OAAO,WAAW;IACvC,OAAO,KAAK,GAAG,CAAC,aAAa,cAAc;AAC7C"}},
    {"offset": {"line": 41, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/misc.ts"],"sourcesContent":["import { OsPlatform } from '@/types/system';\nimport { md5 } from 'js-md5';\n\nexport const uniqueId = () => Math.random().toString(36).substring(2, 9);\n\nexport const randomMd5 = () => md5(Math.random().toString());\n\nexport const getContentMd5 = (content: unknown) => md5(JSON.stringify(content));\n\nexport const makeSafeFilename = (filename: string, replacement = '_') => {\n  // Windows restricted characters + control characters and reserved names\n  const unsafeCharacters = /[<>:%\"\\/\\\\|?*\\x00-\\x1F]/g;\n  const reservedFilenames = /^(con|prn|aux|nul|com[1-9]|lpt[1-9])$/i;\n  // Unsafe to use filename including file extensions over 255 bytes on Android\n  const maxFilenameBytes = 250;\n\n  let safeName = filename.replace(unsafeCharacters, replacement);\n\n  if (reservedFilenames.test(safeName)) {\n    safeName = `${safeName}${replacement}`;\n  }\n\n  const encoder = new TextEncoder();\n  let utf8Bytes = encoder.encode(safeName);\n\n  while (utf8Bytes.length > maxFilenameBytes) {\n    safeName = safeName.slice(0, -1);\n    utf8Bytes = encoder.encode(safeName);\n  }\n\n  return safeName.trim();\n};\n\nexport const getLocale = () => {\n  return localStorage?.getItem('i18nextLng') || navigator?.language || '';\n};\n\nexport const getUserLang = () => {\n  const locale = getLocale();\n  return locale.split('-')[0] || 'en';\n};\n\nexport const getTargetLang = () => {\n  const locale = getLocale();\n  if (locale.startsWith('zh')) {\n    return locale === 'zh-Hant' || locale === 'zh-HK' || locale === 'zh-TW' ? 'zh-Hant' : 'zh-Hans';\n  }\n  return locale.split('-')[0] || 'en';\n};\n\nexport const isCJKEnv = () => {\n  const browserLanguage = navigator.language || '';\n  const uiLanguage = localStorage?.getItem('i18nextLng') || '';\n  const isCJKUI = ['zh', 'ja', 'ko'].some((lang) => uiLanguage.startsWith(lang));\n  const isCJKLocale = ['zh', 'ja', 'ko'].some((lang) => browserLanguage.startsWith(lang));\n  return isCJKLocale || isCJKUI;\n};\n\nexport const getUserLocale = (lang: string): string | undefined => {\n  const languages =\n    navigator.languages && navigator.languages.length > 0\n      ? navigator.languages\n      : [navigator.language];\n\n  const filteredLocales = languages.filter((locale) => locale.startsWith(lang));\n  return filteredLocales.length > 0 ? filteredLocales[0] : undefined;\n};\n\n// Note that iPad may have a user agent string like a desktop browser\n// when possible please use appService.isIOSApp || getOSPlatform() === 'ios'\n// to check if the app is running on iOS\nexport const getOSPlatform = (): OsPlatform => {\n  const userAgent = navigator.userAgent.toLowerCase();\n\n  if (/iphone|ipad|ipod/.test(userAgent)) return 'ios';\n  if (userAgent.includes('android')) return 'android';\n  if (userAgent.includes('macintosh') || userAgent.includes('mac os x')) return 'macos';\n  if (userAgent.includes('windows nt')) return 'windows';\n  if (userAgent.includes('linux')) return 'linux';\n\n  return 'unknown';\n};\n\nexport const isContentURI = (uri: string) => {\n  return uri.startsWith('content://');\n};\n\nexport const isFileURI = (uri: string) => {\n  return uri.startsWith('file://');\n};\n\nexport const isValidURL = (url: string, allowedSchemes: string[] = ['http', 'https']) => {\n  try {\n    const { protocol } = new URL(url);\n    return allowedSchemes.some((scheme) => `${scheme}:` === protocol);\n  } catch {\n    return false;\n  }\n};\n\nexport const stubTranslation = (stubKey: string) => {\n  return stubKey;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/telemetry.ts"],"sourcesContent":["import posthog from 'posthog-js';\n\nexport const TELEMETRY_OPT_OUT_KEY = 'readest-telemetry-opt-out';\n\nexport const hasOptedOutTelemetry = () => {\n  return localStorage.getItem(TELEMETRY_OPT_OUT_KEY) === 'true';\n};\n\nexport const captureEvent = (event: string, properties?: Record<string, unknown>) => {\n  if (!hasOptedOutTelemetry()) {\n    posthog.capture(event, properties);\n  }\n};\n\nexport const optInTelemetry = () => {\n  localStorage.setItem(TELEMETRY_OPT_OUT_KEY, 'false');\n  posthog.opt_in_capturing();\n};\nexport const optOutTelemetry = () => {\n  localStorage.setItem(TELEMETRY_OPT_OUT_KEY, 'true');\n  posthog.opt_out_capturing();\n};\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;AAEO,MAAM,wBAAwB;AAE9B,MAAM,uBAAuB;IAClC,OAAO,aAAa,OAAO,CAAC,2BAA2B;AACzD;AAEO,MAAM,eAAe,CAAC,OAAe;IAC1C,IAAI,CAAC,wBAAwB;QAC3B,kNAAO,CAAC,OAAO,CAAC,OAAO;IACzB;AACF;AAEO,MAAM,iBAAiB;IAC5B,aAAa,OAAO,CAAC,uBAAuB;IAC5C,kNAAO,CAAC,gBAAgB;AAC1B;AACO,MAAM,kBAAkB;IAC7B,aAAa,OAAO,CAAC,uBAAuB;IAC5C,kNAAO,CAAC,iBAAiB;AAC3B"}},
    {"offset": {"line": 204, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/version.ts"],"sourcesContent":["import packageJson from '../../package.json';\n\nexport const getAppVersion = () => {\n  return packageJson.version;\n};\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,gBAAgB;IAC3B,OAAO,oHAAW,CAAC,OAAO;AAC5B"}},
    {"offset": {"line": 220, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/color.ts"],"sourcesContent":["import tinycolor from 'tinycolor2';\n\nfunction srgbToLinear(v: number): number {\n  // Standard formula for gamma decoding of sRGB\n  return v <= 0.04045 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);\n}\n\nexport function hexToOklch(hexColor: string): string {\n  // 1) Convert from hex → sRGB (0..255) → [0..1]\n  const { r, g, b } = tinycolor(hexColor).toRgb();\n  const R = srgbToLinear(r / 255);\n  const G = srgbToLinear(g / 255);\n  const B = srgbToLinear(b / 255);\n\n  // 2) Convert linear sRGB → L'M'S'  (the Oklab-specific \"LMS\" space)\n  const l_ = Math.cbrt(0.4122214708 * R + 0.5363325363 * G + 0.0514459929 * B);\n  const m_ = Math.cbrt(0.2119034982 * R + 0.6806995451 * G + 0.1073969566 * B);\n  const s_ = Math.cbrt(0.0883024619 * R + 0.2817188376 * G + 0.6299787005 * B);\n\n  // 3) Convert L'M'S' → Oklab\n  const L = 0.2104542553 * l_ + 0.793617785 * m_ - 0.0040720468 * s_;\n  const a = 1.9779984951 * l_ - 2.428592205 * m_ + 0.4505937099 * s_;\n  const b_ = 0.0259040371 * l_ + 0.7827717662 * m_ - 0.808675766 * s_;\n\n  // 4) Convert Oklab → Oklch\n  const C = Math.sqrt(a * a + b_ * b_);\n  let h = Math.atan2(b_, a) * (180 / Math.PI);\n  if (h < 0) h += 360;\n\n  // 5) Format as l% c h, with a bit of rounding\n  const lPercent = (L * 100).toFixed(4);\n  const cValue = Number(C.toFixed(6));\n  const hValue = Number(h.toFixed(3));\n\n  if (cValue === 0) {\n    return `${lPercent}% 0 0deg`;\n  }\n\n  return `${lPercent}% ${cValue} ${hValue}deg`;\n}\n\nexport const getContrastOklch = (hexColor: string): string => {\n  return tinycolor(hexColor).isDark() ? '100% 0 0deg' : '0% 0 0deg';\n};\n\nexport const getContrastHex = (hexColor: string): string => {\n  return tinycolor(hexColor).isDark() ? '#FFFFFF' : '#000000';\n};\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,SAAS,aAAa,CAAS;IAC7B,8CAA8C;IAC9C,OAAO,KAAK,UAAU,IAAI,QAAQ,KAAK,GAAG,CAAC,CAAC,IAAI,KAAK,IAAI,OAAO;AAClE;AAEO,SAAS,WAAW,QAAgB;IACzC,+CAA+C;IAC/C,MAAM,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,GAAG,IAAA,4MAAS,EAAC,UAAU,KAAK;IAC7C,MAAM,IAAI,aAAa,IAAI;IAC3B,MAAM,IAAI,aAAa,IAAI;IAC3B,MAAM,IAAI,aAAa,IAAI;IAE3B,oEAAoE;IACpE,MAAM,KAAK,KAAK,IAAI,CAAC,eAAe,IAAI,eAAe,IAAI,eAAe;IAC1E,MAAM,KAAK,KAAK,IAAI,CAAC,eAAe,IAAI,eAAe,IAAI,eAAe;IAC1E,MAAM,KAAK,KAAK,IAAI,CAAC,eAAe,IAAI,eAAe,IAAI,eAAe;IAE1E,4BAA4B;IAC5B,MAAM,IAAI,eAAe,KAAK,cAAc,KAAK,eAAe;IAChE,MAAM,IAAI,eAAe,KAAK,cAAc,KAAK,eAAe;IAChE,MAAM,KAAK,eAAe,KAAK,eAAe,KAAK,cAAc;IAEjE,2BAA2B;IAC3B,MAAM,IAAI,KAAK,IAAI,CAAC,IAAI,IAAI,KAAK;IACjC,IAAI,IAAI,KAAK,KAAK,CAAC,IAAI,KAAK,CAAC,MAAM,KAAK,EAAE;IAC1C,IAAI,IAAI,GAAG,KAAK;IAEhB,8CAA8C;IAC9C,MAAM,WAAW,CAAC,IAAI,GAAG,EAAE,OAAO,CAAC;IACnC,MAAM,SAAS,OAAO,EAAE,OAAO,CAAC;IAChC,MAAM,SAAS,OAAO,EAAE,OAAO,CAAC;IAEhC,IAAI,WAAW,GAAG;QAChB,OAAO,GAAG,SAAS,QAAQ,CAAC;IAC9B;IAEA,OAAO,GAAG,SAAS,EAAE,EAAE,OAAO,CAAC,EAAE,OAAO,GAAG,CAAC;AAC9C;AAEO,MAAM,mBAAmB,CAAC;IAC/B,OAAO,IAAA,4MAAS,EAAC,UAAU,MAAM,KAAK,gBAAgB;AACxD;AAEO,MAAM,iBAAiB,CAAC;IAC7B,OAAO,IAAA,4MAAS,EAAC,UAAU,MAAM,KAAK,YAAY;AACpD"}},
    {"offset": {"line": 274, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/style.ts"],"sourcesContent":["import {\n  MONOSPACE_FONTS,\n  SANS_SERIF_FONTS,\n  SERIF_FONTS,\n  FALLBACK_FONTS,\n  CJK_SANS_SERIF_FONTS,\n  CJK_SERIF_FONTS,\n} from '@/services/constants';\nimport { ViewSettings } from '@/types/book';\nimport {\n  themes,\n  Palette,\n  CustomTheme,\n  generateLightPalette,\n  generateDarkPalette,\n} from '@/styles/themes';\nimport { getOSPlatform } from './misc';\n\nconst getFontStyles = (\n  serif: string,\n  sansSerif: string,\n  monospace: string,\n  defaultFont: string,\n  defaultCJKFont: string,\n  fontSize: number,\n  minFontSize: number,\n  fontWeight: number,\n  overrideFont: boolean,\n) => {\n  const lastSerifFonts = ['Georgia', 'Times New Roman'];\n  const serifFonts = [\n    serif,\n    ...(defaultCJKFont !== serif ? [defaultCJKFont] : []),\n    ...SERIF_FONTS.filter(\n      (font) => font !== serif && font !== defaultCJKFont && !lastSerifFonts.includes(font),\n    ),\n    ...CJK_SERIF_FONTS.filter((font) => font !== serif && font !== defaultCJKFont),\n    ...lastSerifFonts.filter(\n      (font) => SERIF_FONTS.includes(font) && !lastSerifFonts.includes(defaultCJKFont),\n    ),\n    ...FALLBACK_FONTS,\n  ];\n  const sansSerifFonts = [\n    sansSerif,\n    ...(defaultCJKFont !== sansSerif ? [defaultCJKFont] : []),\n    ...SANS_SERIF_FONTS.filter((font) => font !== sansSerif && font !== defaultCJKFont),\n    ...CJK_SANS_SERIF_FONTS.filter((font) => font !== sansSerif && font !== defaultCJKFont),\n    ...FALLBACK_FONTS,\n  ];\n  const monospaceFonts = [monospace, ...MONOSPACE_FONTS.filter((font) => font !== monospace)];\n  const defaultFontFamily = defaultFont.toLowerCase() === 'serif' ? '--serif' : '--sans-serif';\n  const fontStyles = `\n    html {\n      --serif: ${serifFonts.map((font) => `\"${font}\"`).join(', ')}, serif;\n      --sans-serif: ${sansSerifFonts.map((font) => `\"${font}\"`).join(', ')}, sans-serif;\n      --monospace: ${monospaceFonts.map((font) => `\"${font}\"`).join(', ')}, monospace;\n      --font-size: ${fontSize}px;\n      --min-font-size: ${minFontSize}px;\n      --font-weight: ${fontWeight};\n    }\n    html, body {\n      font-size: ${fontSize}px !important;\n      font-weight: ${fontWeight};\n      -webkit-text-size-adjust: none;\n      text-size-adjust: none;\n    }\n    /* lower specificity than ebook built-in font styles */\n    html {\n      font-family: var(${defaultFontFamily}) ${overrideFont ? '!important' : ''};\n    }\n    /* higher specificity than ebook built-in font styles */\n    html body {\n      ${overrideFont ? `font-family: var(${defaultFontFamily}) !important;` : ''}\n    }\n    font[size=\"1\"] {\n      font-size: ${minFontSize}px;\n    }\n    font[size=\"2\"] {\n      font-size: ${minFontSize * 1.5}px;\n    }\n    font[size=\"3\"] {\n      font-size: ${fontSize}px;\n    }\n    font[size=\"4\"] {\n      font-size: ${fontSize * 1.2}px;\n    }\n    font[size=\"5\"] {\n      font-size: ${fontSize * 1.5}px;\n    }\n    font[size=\"6\"] {\n      font-size: ${fontSize * 2}px;\n    }\n    font[size=\"7\"] {\n      font-size: ${fontSize * 3}px;\n    }\n    /* hardcoded inline font size */\n    [style*=\"font-size: 16px\"], [style*=\"font-size:16px\"] {\n      font-size: 1rem !important;\n    }\n    pre, code, kbd {\n      font-family: var(--monospace);\n    }\n    body *:not(pre, code, kbd, .code):not(pre *, code *, kbd *, .code *) {\n      ${overrideFont ? 'font-family: revert !important;' : ''}\n    }\n  `;\n  return fontStyles;\n};\n\nconst getColorStyles = (\n  overrideColor: boolean,\n  invertImgColorInDark: boolean,\n  themeCode: ThemeCode,\n  backgroundTextureId: string,\n  isEink: boolean,\n) => {\n  const { bg, fg, primary, isDarkMode } = themeCode;\n  const colorStyles = `\n    html {\n      --bg-texture-id: ${backgroundTextureId};\n      --theme-bg-color: ${bg};\n      --theme-fg-color: ${fg};\n      --theme-primary-color: ${primary};\n      --override-color: ${overrideColor};\n      color-scheme: ${isDarkMode ? 'dark' : 'light'};\n    }\n    html, body {\n      color: ${fg};\n    }\n    html[has-background], body[has-background] {\n      --background-set: var(--theme-bg-color);\n    }\n    html {\n      background-color: var(--theme-bg-color, transparent);\n      background: var(--background-set, none);\n    }\n    section, aside, blockquote, article, nav, header, footer, main, figure,\n    div, p, font, h1, h2, h3, h4, h5, h6, li, span {\n      ${overrideColor ? `background-color: ${bg} !important;` : ''}\n      ${overrideColor ? `color: ${fg} !important;` : ''}\n      ${overrideColor ? `border-color: ${fg} !important;` : ''}\n    }\n    pre, span { /* inline code blocks */\n      ${overrideColor ? `background-color: ${bg} !important;` : ''}\n    }\n    a:any-link {\n      ${overrideColor ? `color: ${primary} !important;` : isDarkMode ? `color: lightblue;` : ''}\n      text-decoration: ${isEink ? 'underline' : 'none'};\n    }\n    body.pbg {\n      ${isDarkMode ? `background-color: ${bg} !important;` : ''}\n    }\n    img {\n      ${isDarkMode && invertImgColorInDark ? 'filter: invert(100%);' : ''}\n      ${!isDarkMode && overrideColor ? 'mix-blend-mode: multiply;' : ''}\n    }\n    /* horizontal rule #1649 */\n    *:has(> hr.background-img):not(body) {\n      background-color: ${bg};\n    }\n    hr {\n      mix-blend-mode: multiply;\n    }\n    /* inline images */\n    p img, span img, sup img {\n      mix-blend-mode: ${isDarkMode ? 'screen' : 'multiply'};\n    }\n    table {\n      max-width: calc(var(--available-width));\n      overflow: auto;\n      table-layout: fixed;\n    }\n    /* code */\n    body.theme-dark code {\n      ${isDarkMode ? `color: ${fg}cc;` : ''}\n      ${isDarkMode ? `background: color-mix(in srgb, ${bg} 90%, #000);` : ''}\n      ${isDarkMode ? `background-color: color-mix(in srgb, ${bg} 90%, #000);` : ''}\n    }\n    blockquote {\n      ${isDarkMode ? `background: color-mix(in srgb, ${bg} 80%, #000);` : ''}\n    }\n    blockquote, table * {\n      ${isDarkMode && overrideColor ? `background: color-mix(in srgb, ${bg} 80%, #000);` : ''}\n      ${isDarkMode && overrideColor ? `background-color: color-mix(in srgb, ${bg} 80%, #000);` : ''}\n    }\n    /* override inline hardcoded text color */\n    font[color=\"#000000\"], font[color=\"#000\"], font[color=\"black\"],\n    font[color=\"rgb(0,0,0)\"], font[color=\"rgb(0, 0, 0)\"],\n    *[style*=\"color: rgb(0,0,0)\"], *[style*=\"color: rgb(0, 0, 0)\"],\n    *[style*=\"color: #000\"], *[style*=\"color: #000000\"], *[style*=\"color: black\"],\n    *[style*=\"color:rgb(0,0,0)\"], *[style*=\"color:rgb(0, 0, 0)\"],\n    *[style*=\"color:#000\"], *[style*=\"color:#000000\"], *[style*=\"color:black\"] {\n      color: ${fg} !important;\n    }\n    /* for the Gutenberg eBooks */\n    #pg-header * {\n      color: inherit !important;\n    }\n    .x-ebookmaker, .x-ebookmaker-cover, .x-ebookmaker-coverpage {\n      background-color: unset !important;\n    }\n    /* for the Feedbooks eBooks */\n    .chapterHeader, .chapterHeader * {\n      border-color: unset;\n      background-color: ${bg} !important;\n    }\n  `;\n  return colorStyles;\n};\n\nconst getLayoutStyles = (\n  overrideLayout: boolean,\n  marginTop: number,\n  marginRight: number,\n  marginBottom: number,\n  marginLeft: number,\n  paragraphMargin: number,\n  lineSpacing: number,\n  wordSpacing: number,\n  letterSpacing: number,\n  textIndent: number,\n  justify: boolean,\n  hyphenate: boolean,\n  zoomLevel: number,\n  writingMode: string,\n  vertical: boolean,\n) => {\n  const layoutStyle = `\n  @namespace epub \"http://www.idpf.org/2007/ops\";\n  html {\n    --default-text-align: ${justify ? 'justify' : 'start'};\n    --margin-top: ${marginTop}px;\n    --margin-right: ${marginRight}px;\n    --margin-bottom: ${marginBottom}px;\n    --margin-left: ${marginLeft}px;\n    hanging-punctuation: allow-end last;\n    orphans: 2;\n    widows: 2;\n  }\n  [align=\"left\"] { text-align: left; }\n  [align=\"right\"] { text-align: right; }\n  [align=\"center\"] { text-align: center; }\n  [align=\"justify\"] { text-align: justify; }\n  :is(hgroup, header) p {\n      text-align: unset;\n      hyphens: unset;\n  }\n  html, body {\n    ${writingMode === 'auto' ? '' : `writing-mode: ${writingMode} !important;`}\n    text-align: var(--default-text-align);\n    max-height: unset;\n    -webkit-touch-callout: none;\n    -webkit-user-select: text;\n  }\n  body {\n    overflow: unset;\n    zoom: ${zoomLevel};\n  }\n  svg, img {\n    height: auto;\n    width: auto;\n    background-color: transparent !important;\n  }\n  figure > div:has(img) {\n    height: auto !important;\n  }\n  /* enlarge the clickable area of links */\n  a {\n    position: relative !important;\n  }\n  a::before {\n    content: '';\n    position: absolute;\n    inset: -10px;\n  }\n  p, blockquote, dd, div:not(:has(*:not(b, a, em, i, strong, u, span))) {\n    line-height: ${lineSpacing} ${overrideLayout ? '!important' : ''};\n    word-spacing: ${wordSpacing}px ${overrideLayout ? '!important' : ''};\n    letter-spacing: ${letterSpacing}px ${overrideLayout ? '!important' : ''};\n    text-indent: ${textIndent}em ${overrideLayout ? '!important' : ''};\n    -webkit-hyphens: ${hyphenate ? 'auto' : 'manual'};\n    hyphens: ${hyphenate ? 'auto' : 'manual'};\n    -webkit-hyphenate-limit-before: 3;\n    -webkit-hyphenate-limit-after: 2;\n    -webkit-hyphenate-limit-lines: 2;\n    hanging-punctuation: allow-end last;\n    widows: 2;\n  }\n  p.aligned-center, blockquote.aligned-center,\n  dd.aligned-center, div.aligned-center {\n    text-align: center ${overrideLayout ? '!important' : ''};\n  }\n  p.aligned-left, blockquote.aligned-left,\n  dd.aligned-left, div.aligned-left {\n    ${justify && overrideLayout ? 'text-align: justify !important;' : ''}\n  }\n  p.aligned-right, blockquote.aligned-right,\n  dd.aligned-right, div.aligned-right {\n    text-align: right ${overrideLayout ? '!important' : ''};\n  }\n  p.aligned-justify, blockquote.aligned-justify,\n  dd.aligned-justify, div.aligned-justify {\n    ${!justify && overrideLayout ? 'text-align: initial !important;' : ''};\n  }\n  p:has(> img:only-child), p:has(> span:only-child > img:only-child),\n  p:has(> img:not(.has-text-siblings)),\n  p:has(> a:first-child + img:last-child) {\n    text-indent: initial !important;\n  }\n  blockquote[align=\"center\"], div[align=\"center\"],\n  p[align=\"center\"], dd[align=\"center\"],\n  p.aligned-center, blockquote.aligned-center,\n  dd.aligned-center, div.aligned-center,\n  li p, ol p, ul p, td p {\n    text-indent: initial !important;\n  }\n  p {\n    ${vertical ? `margin-left: ${paragraphMargin}em ${overrideLayout ? '!important' : ''};` : ''}\n    ${vertical ? `margin-right: ${paragraphMargin}em ${overrideLayout ? '!important' : ''};` : ''}\n    ${vertical ? `margin-top: unset ${overrideLayout ? '!important' : ''};` : ''}\n    ${vertical ? `margin-bottom: unset ${overrideLayout ? '!important' : ''};` : ''}\n    ${!vertical ? `margin-top: ${paragraphMargin}em ${overrideLayout ? '!important' : ''};` : ''}\n    ${!vertical ? `margin-bottom: ${paragraphMargin}em ${overrideLayout ? '!important' : ''};` : ''}\n    ${!vertical ? `margin-left: unset ${overrideLayout ? '!important' : ''};` : ''}\n    ${!vertical ? `margin-right: unset ${overrideLayout ? '!important' : ''};` : ''}\n  }\n  div {\n    ${vertical && overrideLayout ? `margin-left: ${paragraphMargin}em !important;` : ''}\n    ${vertical && overrideLayout ? `margin-right: ${paragraphMargin}em !important;` : ''}\n    ${!vertical && overrideLayout ? `margin-top: ${paragraphMargin}em !important;` : ''}\n    ${!vertical && overrideLayout ? `margin-bottom: ${paragraphMargin}em !important;` : ''}\n  }\n\n  :lang(zh), :lang(ja), :lang(ko) {\n    widows: 1;\n    orphans: 1;\n  }\n\n  pre {\n    white-space: pre-wrap !important;\n  }\n\n  .epubtype-footnote,\n  aside[epub|type~=\"endnote\"],\n  aside[epub|type~=\"footnote\"],\n  aside[epub|type~=\"note\"],\n  aside[epub|type~=\"rearnote\"] {\n    display: none;\n  }\n\n  /* Now begins really dirty hacks to fix some badly designed epubs */\n  body {\n    line-height: unset;\n  }\n\n  img.pi {\n    ${vertical ? 'transform: rotate(90deg);' : ''}\n    ${vertical ? 'transform-origin: center;' : ''}\n    ${vertical ? 'height: 2em;' : ''}\n    ${vertical ? `width: ${lineSpacing}em;` : ''}\n    ${vertical ? `vertical-align: unset;` : ''}\n  }\n\n  .duokan-footnote-content,\n  .duokan-footnote-item {\n    display: none;\n  }\n\n  .calibre {\n    color: unset;\n  }\n\n  div:has(> img, > svg) {\n    max-width: 100% !important;\n  }\n\n  body.paginated-mode td:has(img), body.paginated-mode td :has(img) {\n    max-height: calc(var(--available-height) * 0.8 * 1px);\n  }\n\n  /* some epubs set insane inline-block for p */\n  p {\n    display: block;\n  }\n\n  /* inline images without dimension */\n  .ie6 img {\n    width: unset;\n    height: unset;\n  }\n  sup img {\n    height: 1em;\n  }\n  img.has-text-siblings {\n    ${vertical ? 'width: 1em;' : 'height: 1em;'}\n    vertical-align: baseline;\n  }\n  :is(div) > img.has-text-siblings[style*=\"object-fit\"] {\n    display: block;\n    height: auto;\n    vertical-align: unset;\n  }\n  .duokan-footnote img:not([class]) {\n    width: 0.8em;\n    height: 0.8em;\n  }\n  div:has(img.singlepage) {\n    position: relative;\n    width: auto;\n    height: auto;\n  }\n\n  /* page break */\n  body.paginated-mode div[style*=\"page-break-after: always\"],\n  body.paginated-mode div[style*=\"page-break-after:always\"],\n  body.paginated-mode p[style*=\"page-break-after: always\"],\n  body.paginated-mode p[style*=\"page-break-after:always\"] {\n    margin-bottom: calc(var(--available-height) * 1px);\n  }\n\n  /* workaround for some badly designed epubs */\n  div.left *, p.left * { text-align: left; }\n  div.right *, p.right * { text-align: right; }\n  div.center *, p.center * { text-align: center; }\n  div.justify *, p.justify * { text-align: justify; }\n\n  .br {\n    display: flow-root;\n  }\n\n  .h5_mainbody {\n    overflow: unset !important;\n  }\n\n  .nonindent, .noindent {\n    text-indent: unset !important;\n  }\n`;\n  return layoutStyle;\n};\n\nexport const getFootnoteStyles = () => `\n  .duokan-footnote-content,\n  .duokan-footnote-item {\n    display: block !important;\n  }\n\n  body {\n    padding: 1em !important;\n  }\n\n  a:any-link {\n    cursor: default;\n    pointer-events: none;\n    text-decoration: none;\n    padding: unset;\n    margin: unset;\n  }\n\n  ol {\n    margin: 0;\n    padding: 0;\n  }\n\n  p, li, blockquote, dd {\n    margin: unset !important;\n    text-indent: unset !important;\n  }\n\n  div {\n    margin: unset !important;\n    padding: unset !important;\n  }\n\n  dt {\n    font-weight: bold;\n    line-height: 1.6;\n  }\n\n  .epubtype-footnote,\n  aside[epub|type~=\"endnote\"],\n  aside[epub|type~=\"footnote\"],\n  aside[epub|type~=\"note\"],\n  aside[epub|type~=\"rearnote\"] {\n    display: block;\n  }\n`;\n\nconst getTranslationStyles = (showSource: boolean) => `\n  .translation-source {\n  }\n  .translation-target {\n  }\n  .translation-target.hidden {\n    display: none !important;\n  }\n  .translation-target-block {\n    display: block !important;\n    ${showSource ? 'margin: 0.5em 0 !important;' : ''}\n  }\n  .translation-target-toc {\n    display: block !important;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n`;\n\nexport interface ThemeCode {\n  bg: string;\n  fg: string;\n  primary: string;\n  palette: Palette;\n  isDarkMode: boolean;\n}\n\nexport const getThemeCode = () => {\n  let themeMode = 'auto';\n  let themeColor = 'default';\n  let systemIsDarkMode = false;\n  let customThemes: CustomTheme[] = [];\n  if (typeof window !== 'undefined') {\n    themeColor = localStorage.getItem('themeColor') || 'default';\n    themeMode = localStorage.getItem('themeMode') || 'auto';\n    customThemes = JSON.parse(localStorage.getItem('customThemes') || '[]');\n    systemIsDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;\n  }\n  const isDarkMode = themeMode === 'dark' || (themeMode === 'auto' && systemIsDarkMode);\n  let currentTheme = themes.find((theme) => theme.name === themeColor);\n  if (!currentTheme) {\n    const customTheme = customThemes.find((theme) => theme.name === themeColor);\n    if (customTheme) {\n      currentTheme = {\n        name: customTheme.name,\n        label: customTheme.label,\n        colors: {\n          light: generateLightPalette(customTheme.colors.light),\n          dark: generateDarkPalette(customTheme.colors.dark),\n        },\n      };\n    }\n  }\n  if (!currentTheme) currentTheme = themes[0];\n  const defaultPalette = isDarkMode ? currentTheme!.colors.dark : currentTheme!.colors.light;\n  return {\n    bg: defaultPalette['base-100'],\n    fg: defaultPalette['base-content'],\n    primary: defaultPalette.primary,\n    palette: defaultPalette,\n    isDarkMode,\n  } as ThemeCode;\n};\n\nexport const getStyles = (viewSettings: ViewSettings, themeCode?: ThemeCode) => {\n  if (!themeCode) {\n    themeCode = getThemeCode();\n  }\n  const layoutStyles = getLayoutStyles(\n    viewSettings.overrideLayout!,\n    viewSettings.marginTopPx,\n    viewSettings.marginRightPx,\n    viewSettings.marginBottomPx,\n    viewSettings.marginLeftPx,\n    viewSettings.paragraphMargin!,\n    viewSettings.lineHeight!,\n    viewSettings.wordSpacing!,\n    viewSettings.letterSpacing!,\n    viewSettings.textIndent!,\n    viewSettings.fullJustification!,\n    viewSettings.hyphenation!,\n    1.0,\n    viewSettings.writingMode!,\n    viewSettings.vertical!,\n  );\n  // scale the font size on-the-fly so that we can sync the same font size on different devices\n  const isMobile = ['ios', 'android'].includes(getOSPlatform());\n  const fontScale = isMobile ? 1.25 : 1;\n  // Only for backward compatibility, new viewSettings.zoomLevel will always be 100 for EPUBs\n  const zoomScale = (viewSettings.zoomLevel || 100) / 100.0;\n  const fontStyles = getFontStyles(\n    viewSettings.serifFont!,\n    viewSettings.sansSerifFont!,\n    viewSettings.monospaceFont!,\n    viewSettings.defaultFont!,\n    viewSettings.defaultCJKFont!,\n    viewSettings.defaultFontSize! * fontScale * zoomScale,\n    viewSettings.minimumFontSize!,\n    viewSettings.fontWeight!,\n    viewSettings.overrideFont!,\n  );\n  const colorStyles = getColorStyles(\n    viewSettings.overrideColor!,\n    viewSettings.invertImgColorInDark!,\n    themeCode,\n    viewSettings.backgroundTextureId,\n    viewSettings.isEink,\n  );\n  const translationStyles = getTranslationStyles(viewSettings.showTranslateSource!);\n  const userStylesheet = viewSettings.userStylesheet!;\n  return `${layoutStyles}\\n${fontStyles}\\n${colorStyles}\\n${translationStyles}\\n${userStylesheet}`;\n};\n\nexport const applyTranslationStyle = (viewSettings: ViewSettings) => {\n  const styleId = 'translation-style';\n\n  const existingStyle = document.getElementById(styleId);\n  if (existingStyle) {\n    existingStyle.remove();\n  }\n\n  const styleElement = document.createElement('style');\n  styleElement.id = styleId;\n  styleElement.textContent = getTranslationStyles(viewSettings.showTranslateSource);\n\n  document.head.appendChild(styleElement);\n};\n\nexport const transformStylesheet = (css: string, vw: number, vh: number, vertical: boolean) => {\n  const isMobile = ['ios', 'android'].includes(getOSPlatform());\n  const fontScale = isMobile ? 1.25 : 1;\n  const isInlineStyle = !css.includes('{');\n  const ruleRegex = /([^{]+)({[^}]+})/g;\n  css = css.replace(ruleRegex, (match, selector, block) => {\n    const hasTextAlignCenter = /text-align\\s*:\\s*center\\s*[;$]/.test(block);\n    const hasTextIndentZero = /text-indent\\s*:\\s*0(?:\\.0+)?(?:px|em|rem|%)?\\s*[;$]/.test(block);\n\n    if (hasTextAlignCenter && hasTextIndentZero) {\n      block = block.replace(/(text-align\\s*:\\s*center)(\\s*;|\\s*$)/g, '$1 !important$2');\n      block = block.replace(\n        /(text-indent\\s*:\\s*0(?:\\.0+)?(?:px|em|rem|%)?)(\\s*;|\\s*$)/g,\n        '$1 !important$2',\n      );\n      return selector + block;\n    }\n    return match;\n  });\n\n  // clip nowrapped elements\n  css = css.replace(ruleRegex, (match, selector, block) => {\n    const hasWhiteSpaceNowrap = /white-space\\s*:\\s*nowrap\\s*[;$]/.test(block);\n    if (hasWhiteSpaceNowrap) {\n      if (!/overflow\\s*:/.test(block)) {\n        block = block.replace(/}$/, ' overflow: clip !important; }');\n      }\n      return selector + block;\n    }\n    return match;\n  });\n\n  if (isInlineStyle) {\n    const hasPageBreakAfterAlways = /page-break-after\\s*:\\s*always\\s*[;]?/.test(css);\n    if (hasPageBreakAfterAlways && !/margin-bottom\\s*:/.test(css)) {\n      css = css.replace(/;?\\s*$/, '') + '; margin-bottom: calc(var(--available-height) * 1px)';\n    }\n  } else {\n    css = css.replace(ruleRegex, (match, selector, block) => {\n      const hasPageBreakAfterAlways = /page-break-after\\s*:\\s*always\\s*[;$]/.test(block);\n      if (hasPageBreakAfterAlways) {\n        if (!/margin-bottom\\s*:/.test(block)) {\n          block = block.replace(/}$/, ' margin-bottom: calc(var(--available-height) * 1px); }');\n        }\n        return selector + block;\n      }\n      return match;\n    });\n  }\n\n  // Process duokan-bleed\n  css = css.replace(ruleRegex, (_, selector, block) => {\n    if (vertical) return selector + block;\n\n    const directions: string[] = [];\n    let hasBleed = false;\n    for (const dir of ['top', 'bottom', 'left', 'right']) {\n      const bleedRegex = new RegExp(`duokan-bleed\\\\s*:\\\\s*[^;]*${dir}[^;]*;`);\n      const marginRegex = new RegExp(`margin-${dir}\\\\s*:`);\n      if (bleedRegex.test(block) && !marginRegex.test(block)) {\n        hasBleed = true;\n        directions.push(dir);\n        block = block.replace(\n          /}$/,\n          ` margin-${dir}: calc(-1 * var(--page-margin-${dir})) !important; }`,\n        );\n      }\n    }\n    if (hasBleed) {\n      if (!/position\\s*:/.test(block)) {\n        block = block.replace(/}$/, ' position: relative !important; }');\n      }\n      if (!/overflow\\s*:/.test(block)) {\n        block = block.replace(/}$/, ' overflow: hidden !important; }');\n      }\n      if (!/display\\s*:/.test(block)) {\n        block = block.replace(/}$/, ' display: flow-root !important; }');\n      }\n      if (!/width\\s*:/.test(block) && directions.includes('left') && directions.includes('right')) {\n        block = block\n          .replace(\n            /}$/,\n            ' width: calc(var(--_max-width) + var(--page-margin-left) + var(--page-margin-right)) !important; }',\n          )\n          .replace(/}$/, ' max-width: 100vw !important; }');\n      }\n      if (\n        !/height\\s*:/.test(block) &&\n        directions.includes('top') &&\n        directions.includes('bottom')\n      ) {\n        block = block\n          .replace(\n            /}$/,\n            ' height: calc(100% + var(--page-margin-top) + var(--page-margin-bottom)) !important; }',\n          )\n          .replace(/}$/, ' max-height: 100vh !important; }');\n      }\n    }\n    return selector + block;\n  });\n\n  // replace absolute font sizes with rem units\n  // replace vw and vh as they cause problems with layout\n  // replace hardcoded colors\n  css = css\n    .replace(/font-size\\s*:\\s*xx-small/gi, 'font-size: 0.6rem')\n    .replace(/font-size\\s*:\\s*x-small/gi, 'font-size: 0.75rem')\n    .replace(/font-size\\s*:\\s*small/gi, 'font-size: 0.875rem')\n    .replace(/font-size\\s*:\\s*medium/gi, 'font-size: 1rem')\n    .replace(/font-size\\s*:\\s*large/gi, 'font-size: 1.2rem')\n    .replace(/font-size\\s*:\\s*x-large/gi, 'font-size: 1.5rem')\n    .replace(/font-size\\s*:\\s*xx-large/gi, 'font-size: 2rem')\n    .replace(/font-size\\s*:\\s*xxx-large/gi, 'font-size: 3rem')\n    .replace(/font-size\\s*:\\s*(\\d+(?:\\.\\d+)?)px/gi, (_, px) => {\n      const rem = parseFloat(px) / fontScale / 16;\n      return `font-size: ${rem}rem`;\n    })\n    .replace(/font-size\\s*:\\s*(\\d+(?:\\.\\d+)?)pt/gi, (_, pt) => {\n      const rem = parseFloat(pt) / fontScale / 12;\n      return `font-size: ${rem}rem`;\n    })\n    .replace(/font-size\\s*:\\s*(\\d*\\.?\\d+)(px|rem|em|%)?/gi, (_, size, unit = 'px') => {\n      return `font-size: max(${size}${unit}, var(--min-font-size, 8px))`;\n    })\n    .replace(/(\\d*\\.?\\d+)vw/gi, (_, d) => (parseFloat(d) * vw) / 100 + 'px')\n    .replace(/(\\d*\\.?\\d+)vh/gi, (_, d) => (parseFloat(d) * vh) / 100 + 'px')\n    .replace(/([\\s;])font-family\\s*:\\s*monospace/gi, '$1font-family: var(--monospace)')\n    .replace(/([\\s;])font-weight\\s*:\\s*normal/gi, '$1font-weight: var(--font-weight)')\n    .replace(/([\\s;])color\\s*:\\s*black/gi, '$1color: var(--theme-fg-color)')\n    .replace(/([\\s;])color\\s*:\\s*#000000/gi, '$1color: var(--theme-fg-color)')\n    .replace(/([\\s;])color\\s*:\\s*#000/gi, '$1color: var(--theme-fg-color)')\n    .replace(/([\\s;])color\\s*:\\s*rgb\\(0,\\s*0,\\s*0\\)/gi, '$1color: var(--theme-fg-color)');\n  return css;\n};\n\nexport const applyThemeModeClass = (document: Document, isDarkMode: boolean) => {\n  document.body.classList.remove('theme-light', 'theme-dark');\n  document.body.classList.add(isDarkMode ? 'theme-dark' : 'theme-light');\n};\n\nexport const applyScrollModeClass = (document: Document, isScrollMode: boolean) => {\n  document.body.classList.remove('scroll-mode', 'paginated-mode');\n  document.body.classList.add(isScrollMode ? 'scroll-mode' : 'paginated-mode');\n};\n\nexport const applyImageStyle = (document: Document) => {\n  document.querySelectorAll('img').forEach((img) => {\n    const widthAttr = img.getAttribute('width');\n    if (widthAttr && (widthAttr.endsWith('%') || widthAttr.endsWith('vw'))) {\n      const percentage = parseFloat(widthAttr);\n      if (!isNaN(percentage)) {\n        img.style.width = `${(percentage / 100) * window.innerWidth}px`;\n        img.removeAttribute('width');\n      }\n    }\n\n    const heightAttr = img.getAttribute('height');\n    if (heightAttr && (heightAttr.endsWith('%') || heightAttr.endsWith('vh'))) {\n      const percentage = parseFloat(heightAttr);\n      if (!isNaN(percentage)) {\n        img.style.height = `${(percentage / 100) * window.innerHeight}px`;\n        img.removeAttribute('height');\n      }\n    }\n\n    const parent = img.parentNode;\n    if (!parent || parent.nodeType !== Node.ELEMENT_NODE) return;\n    const hasTextSiblings = Array.from(parent.childNodes).some(\n      (node) => node.nodeType === Node.TEXT_NODE && node.textContent?.trim(),\n    );\n    const isInline = Array.from(parent.childNodes).every(\n      (node) => node.nodeType !== Node.ELEMENT_NODE || (node as Element).tagName !== 'BR',\n    );\n    if (hasTextSiblings && isInline) {\n      img.classList.add('has-text-siblings');\n    }\n  });\n  document.querySelectorAll('hr').forEach((hr) => {\n    const computedStyle = window.getComputedStyle(hr);\n    if (computedStyle.backgroundImage && computedStyle.backgroundImage !== 'none') {\n      hr.classList.add('background-img');\n    }\n  });\n};\n\nexport const applyTableStyle = (document: Document) => {\n  document.querySelectorAll('table').forEach((table) => {\n    const parent = table.parentNode;\n    if (!parent || parent.nodeType !== Node.ELEMENT_NODE) return;\n\n    // Calculate total width from td elements with width attribute or inline style\n    let totalTableWidth = 0;\n    const rows = table.querySelectorAll('tr');\n\n    // Check all rows and use the widest one\n    for (const row of rows) {\n      const cells = row.querySelectorAll('td, th');\n      let rowWidth = 0;\n\n      cells.forEach((cell) => {\n        const cellElement = cell as HTMLElement;\n\n        const widthAttr = cellElement.getAttribute('width');\n        const styleWidth = cellElement.style.width;\n        const widthStr = widthAttr || styleWidth;\n\n        if (widthStr) {\n          const widthValue = parseFloat(widthStr);\n          const widthUnit = widthStr.replace(widthValue.toString(), '').trim();\n\n          if (widthUnit === 'px' || !widthUnit) {\n            rowWidth += widthValue;\n          } else if (widthUnit === '%') {\n            rowWidth += (window.innerWidth * widthValue) / 100;\n          }\n        }\n      });\n\n      if (rowWidth > totalTableWidth) {\n        totalTableWidth = rowWidth;\n      }\n    }\n\n    if (totalTableWidth > 0) {\n      const scale = `calc(min(1, var(--available-width) / ${totalTableWidth}))`;\n      table.style.transformOrigin = 'left top';\n      table.style.transform = `scale(${scale})`;\n    }\n  });\n};\n\nexport const keepTextAlignment = (document: Document) => {\n  document.querySelectorAll('div, p, blockquote, dd').forEach((el) => {\n    const computedStyle = window.getComputedStyle(el);\n    if (computedStyle.textAlign === 'center') {\n      el.classList.add('aligned-center');\n    } else if (computedStyle.textAlign === 'left') {\n      el.classList.add('aligned-left');\n    } else if (computedStyle.textAlign === 'right') {\n      el.classList.add('aligned-right');\n    } else if (computedStyle.textAlign === 'justify') {\n      el.classList.add('aligned-justify');\n    }\n  });\n};\n\nexport const applyFixedlayoutStyles = (\n  document: Document,\n  viewSettings: ViewSettings,\n  themeCode?: ThemeCode,\n) => {\n  if (!themeCode) {\n    themeCode = getThemeCode();\n  }\n  const { bg, fg, primary, isDarkMode } = themeCode;\n  const overrideColor = viewSettings.overrideColor!;\n  const invertImgColorInDark = viewSettings.invertImgColorInDark!;\n  const darkMixBlendMode = bg === '#000000' ? 'luminosity' : 'overlay';\n  const existingStyleId = 'fixed-layout-styles';\n  let style = document.getElementById(existingStyleId) as HTMLStyleElement;\n  if (style) {\n    style.remove();\n  }\n  style = document.createElement('style');\n  style.id = existingStyleId;\n  style.textContent = `\n    html {\n      --theme-bg-color: ${bg};\n      --theme-fg-color: ${fg};\n      --theme-primary-color: ${primary};\n      color-scheme: ${isDarkMode ? 'dark' : 'light'};\n    }\n    body {\n      position: relative;\n      background-color: var(--theme-bg-color);\n    }\n    #canvas {\n      display: inline-block;\n      width: fit-content;\n      height: fit-content;\n      background-color: var(--theme-bg-color);\n    }\n    img, canvas {\n      ${isDarkMode && invertImgColorInDark ? 'filter: invert(100%);' : ''}\n      ${overrideColor ? `mix-blend-mode: ${isDarkMode ? darkMixBlendMode : 'multiply'};` : ''}\n    }\n    img.singlePage {\n      position: relative;\n    }\n  `;\n  document.head.appendChild(style);\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1067, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/bridge.ts"],"sourcesContent":["import { invoke } from '@tauri-apps/api/core';\n\nexport interface CopyURIRequest {\n  uri: string;\n  dst: string;\n}\n\nexport interface CopyURIResponse {\n  success: boolean;\n  error?: string;\n}\n\nexport interface UseBackgroundAudioRequest {\n  enabled: boolean;\n}\n\nexport interface InstallPackageRequest {\n  path: string;\n}\n\nexport interface InstallPackageResponse {\n  success: boolean;\n  error?: string;\n}\n\nexport interface SetSystemUIVisibilityRequest {\n  visible: boolean;\n  darkMode: boolean;\n}\n\nexport interface SetSystemUIVisibilityResponse {\n  success: boolean;\n  error?: string;\n}\n\nexport interface GetStatusBarHeightResponse {\n  height: number;\n  error?: string;\n}\n\nexport interface GetSystemFontsListResponse {\n  fonts: Record<string, string>; // { fontName: fontFamily }\n  error?: string;\n}\n\nexport interface InterceptKeysRequest {\n  volumeKeys?: boolean;\n  backKey?: boolean;\n}\n\nexport interface LockScreenRequest {\n  orientation: 'portrait' | 'landscape' | 'auto';\n}\n\nexport interface GetSystemColorSchemeResponse {\n  colorScheme: 'light' | 'dark';\n  error?: string;\n}\n\nexport interface GetSafeAreaInsetsResponse {\n  top: number;\n  right: number;\n  bottom: number;\n  left: number;\n  error?: string;\n}\n\ninterface GetScreenBrightnessResponse {\n  brightness: number; // 0.0 to 1.0\n  error?: string;\n}\n\ninterface SetScreenBrightnessRequest {\n  brightness: number; // 0.0 to 1.0\n}\n\ninterface SetScreenBrightnessResponse {\n  success: boolean;\n  error?: string;\n}\n\ninterface GetExternalSDCardPathResponse {\n  path: string | null;\n  error?: string;\n}\n\ninterface SelectDirectoryResponse {\n  cancelled?: boolean;\n  uri?: string;\n  path?: string;\n  error?: string;\n}\n\nexport async function copyURIToPath(request: CopyURIRequest): Promise<CopyURIResponse> {\n  const result = await invoke<CopyURIResponse>('plugin:native-bridge|copy_uri_to_path', {\n    payload: request,\n  });\n\n  return result;\n}\n\nexport async function invokeUseBackgroundAudio(request: UseBackgroundAudioRequest): Promise<void> {\n  await invoke('plugin:native-bridge|use_background_audio', {\n    payload: request,\n  });\n}\n\nexport async function installPackage(\n  request: InstallPackageRequest,\n): Promise<InstallPackageResponse> {\n  const result = await invoke<InstallPackageResponse>('plugin:native-bridge|install_package', {\n    payload: request,\n  });\n  return result;\n}\n\nexport async function setSystemUIVisibility(\n  request: SetSystemUIVisibilityRequest,\n): Promise<SetSystemUIVisibilityResponse> {\n  const result = await invoke<SetSystemUIVisibilityResponse>(\n    'plugin:native-bridge|set_system_ui_visibility',\n    {\n      payload: request,\n    },\n  );\n  return result;\n}\n\nexport async function getStatusBarHeight(): Promise<GetStatusBarHeightResponse> {\n  const result = await invoke<GetStatusBarHeightResponse>(\n    'plugin:native-bridge|get_status_bar_height',\n  );\n  return result;\n}\n\nlet cachedSysFontsResult: GetSystemFontsListResponse | null = null;\n\nexport async function getSysFontsList(): Promise<GetSystemFontsListResponse> {\n  if (cachedSysFontsResult) {\n    return cachedSysFontsResult;\n  }\n  const result = await invoke<GetSystemFontsListResponse>(\n    'plugin:native-bridge|get_sys_fonts_list',\n  );\n  cachedSysFontsResult = result;\n  return result;\n}\n\nexport async function interceptKeys(request: InterceptKeysRequest): Promise<void> {\n  await invoke('plugin:native-bridge|intercept_keys', {\n    payload: request,\n  });\n}\n\nexport async function lockScreenOrientation(request: LockScreenRequest): Promise<void> {\n  await invoke('plugin:native-bridge|lock_screen_orientation', {\n    payload: request,\n  });\n}\n\nexport async function getSystemColorScheme(): Promise<GetSystemColorSchemeResponse> {\n  const result = await invoke<GetSystemColorSchemeResponse>(\n    'plugin:native-bridge|get_system_color_scheme',\n  );\n  return result;\n}\n\nexport async function getSafeAreaInsets(): Promise<GetSafeAreaInsetsResponse> {\n  const result = await invoke<GetSafeAreaInsetsResponse>(\n    'plugin:native-bridge|get_safe_area_insets',\n  );\n  return result;\n}\n\nexport async function getScreenBrightness(): Promise<GetScreenBrightnessResponse> {\n  const result = await invoke<GetScreenBrightnessResponse>(\n    'plugin:native-bridge|get_screen_brightness',\n  );\n  return result;\n}\n\nexport async function setScreenBrightness(\n  request: SetScreenBrightnessRequest,\n): Promise<SetScreenBrightnessResponse> {\n  const result = await invoke<SetScreenBrightnessResponse>(\n    'plugin:native-bridge|set_screen_brightness',\n    {\n      payload: request,\n    },\n  );\n  return result;\n}\n\nexport async function getExternalSDCardPath(): Promise<GetExternalSDCardPathResponse> {\n  const result = await invoke<GetExternalSDCardPathResponse>(\n    'plugin:native-bridge|get_external_sdcard_path',\n  );\n  return result;\n}\n\nexport async function selectDirectory(): Promise<SelectDirectoryResponse> {\n  const result = await invoke<SelectDirectoryResponse>('plugin:native-bridge|select_directory');\n  return result;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AA6FO,eAAe,cAAc,OAAuB;IACzD,MAAM,SAAS,MAAM,IAAA,uNAAM,EAAkB,yCAAyC;QACpF,SAAS;IACX;IAEA,OAAO;AACT;AAEO,eAAe,yBAAyB,OAAkC;IAC/E,MAAM,IAAA,uNAAM,EAAC,6CAA6C;QACxD,SAAS;IACX;AACF;AAEO,eAAe,eACpB,OAA8B;IAE9B,MAAM,SAAS,MAAM,IAAA,uNAAM,EAAyB,wCAAwC;QAC1F,SAAS;IACX;IACA,OAAO;AACT;AAEO,eAAe,sBACpB,OAAqC;IAErC,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB,iDACA;QACE,SAAS;IACX;IAEF,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB;IAEF,OAAO;AACT;AAEA,IAAI,uBAA0D;AAEvD,eAAe;IACpB,IAAI,sBAAsB;QACxB,OAAO;IACT;IACA,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB;IAEF,uBAAuB;IACvB,OAAO;AACT;AAEO,eAAe,cAAc,OAA6B;IAC/D,MAAM,IAAA,uNAAM,EAAC,uCAAuC;QAClD,SAAS;IACX;AACF;AAEO,eAAe,sBAAsB,OAA0B;IACpE,MAAM,IAAA,uNAAM,EAAC,gDAAgD;QAC3D,SAAS;IACX;AACF;AAEO,eAAe;IACpB,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB;IAEF,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB;IAEF,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB;IAEF,OAAO;AACT;AAEO,eAAe,oBACpB,OAAmC;IAEnC,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB,8CACA;QACE,SAAS;IACX;IAEF,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,SAAS,MAAM,IAAA,uNAAM,EACzB;IAEF,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,SAAS,MAAM,IAAA,uNAAM,EAA0B;IACrD,OAAO;AACT"}},
    {"offset": {"line": 1178, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/time.ts"],"sourcesContent":["import dayjs from 'dayjs';\nimport relativeTime from 'dayjs/plugin/relativeTime';\n\nimport 'dayjs/locale/en';\nimport 'dayjs/locale/zh';\nimport 'dayjs/locale/de';\nimport 'dayjs/locale/ja';\nimport 'dayjs/locale/ko';\nimport 'dayjs/locale/ru';\nimport 'dayjs/locale/fr';\nimport 'dayjs/locale/el';\nimport 'dayjs/locale/es';\nimport 'dayjs/locale/it';\nimport 'dayjs/locale/pt';\nimport 'dayjs/locale/pt-br';\nimport 'dayjs/locale/ar';\nimport 'dayjs/locale/id';\nimport 'dayjs/locale/hi';\nimport 'dayjs/locale/th';\nimport 'dayjs/locale/tr';\nimport 'dayjs/locale/vi';\nimport 'dayjs/locale/uk';\nimport 'dayjs/locale/pl';\nimport 'dayjs/locale/fi';\nimport 'dayjs/locale/nl';\nimport 'dayjs/locale/ro';\nimport 'dayjs/locale/zh-tw';\nimport 'dayjs/locale/zh-cn';\n\nexport const initDayjs = (locale: string) => {\n  dayjs.locale(locale);\n  dayjs.extend(relativeTime);\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEO,MAAM,YAAY,CAAC;IACxB,gMAAK,CAAC,MAAM,CAAC;IACb,gMAAK,CAAC,MAAM,CAAC,0MAAY;AAC3B"}},
    {"offset": {"line": 1247, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/ua.ts"],"sourcesContent":["import { AppService } from '@/types/system';\n\nexport const parseWebViewInfo = (appService: AppService | null): string => {\n  const ua = navigator.userAgent;\n\n  if (appService?.isAndroidApp) {\n    // Android WebView\n    const chromeMatch = ua.match(/Chrome\\/([0-9.]+)/);\n    return chromeMatch ? `WebView ${chromeMatch[1]}` : 'Android WebView';\n  } else if (appService?.isIOSApp) {\n    // iOS WebView\n    const webkitMatch = ua.match(/AppleWebKit\\/([0-9.]+)/);\n    return webkitMatch ? `WebView ${webkitMatch[1]}` : 'iOS WebView';\n  } else if (appService?.isMacOSApp) {\n    // macOS WebView\n    const webkitMatch = ua.match(/AppleWebKit\\/([0-9.]+)/);\n    return webkitMatch ? `WebView ${webkitMatch[1]}` : 'macOS WebView';\n  } else if (appService?.appPlatform === 'tauri' && appService?.osPlatform === 'windows') {\n    // Windows WebView2\n    const match = ua.match(/Edg\\/([0-9.]+)/);\n    return match ? `Edge ${match[1]}` : 'Edge WebView2';\n  } else if (appService?.appPlatform === 'tauri' && appService?.osPlatform === 'linux') {\n    // Linux WebView\n    const match = ua.match(/AppleWebKit\\/([0-9.]+)/);\n    return match ? `WebView ${match[1]}` : 'Linux WebView';\n  } else if (ua.includes('CriOS') && ua.includes('Mobile/') && ua.includes('Safari')) {\n    // iOS Chrome WebView\n    const match = ua.match(/CriOS\\/([0-9.]+)/);\n    return match ? `Chrome ${match[1]}` : 'iOS Chrome';\n  } else if (ua.includes('FxiOS') && ua.includes('Mobile/') && ua.includes('Safari')) {\n    // iOS Firefox WebView\n    const match = ua.match(/FxiOS\\/([0-9.]+)/);\n    return match ? `Firefox ${match[1]}` : 'iOS Firefox';\n  } else if (ua.includes('Chrome') && ua.includes('AppleWebKit') && ua.includes('Macintosh')) {\n    // macOS Chrome\n    const match = ua.match(/Chrome\\/([0-9.]+)/);\n    return match ? `Chrome ${match[1]}` : 'macOS Chrome';\n  } else if (ua.includes('Safari') && ua.includes('AppleWebKit') && ua.includes('Macintosh')) {\n    // macOS Safari\n    const match = ua.match(/Safari\\/([0-9.]+)/);\n    return match ? `Safari ${match[1]}` : 'macOS Safari';\n  } else if (ua.includes('Edg/')) {\n    // Microsoft Edge\n    const match = ua.match(/Edg\\/([0-9.]+)/);\n    return match ? `Edge ${match[1]}` : 'Edge WebView';\n  } else if (ua.includes('Firefox/')) {\n    // Firefox\n    const match = ua.match(/Firefox\\/([0-9.]+)/);\n    return match ? `Firefox ${match[1]}` : 'Firefox Gecko';\n  } else if (ua.includes('Chrome/') && !ua.includes('Chromium')) {\n    // Chrome\n    const match = ua.match(/Chrome\\/([0-9.]+)/);\n    return match ? `Chrome ${match[1]}` : 'Chrome';\n  } else if (ua.includes('Chromium/')) {\n    // Chromium\n    const match = ua.match(/Chromium\\/([0-9.]+)/);\n    return match ? `Chromium ${match[1]}` : 'Chromium';\n  } else if (ua.includes('MSIE ')) {\n    // Internet Explorer\n    const match = ua.match(/MSIE ([0-9.]+)/);\n    return match ? `IE ${match[1]}` : 'Internet Explorer';\n  } else {\n    return 'Unknown';\n  }\n};\n\nexport const parseWebViewVersion = (appService: AppService | null): number => {\n  const webViewInfo = parseWebViewInfo(appService);\n  const versionMatch = webViewInfo.match(/([0-9]+)\\./);\n  return versionMatch ? parseFloat(versionMatch[1]!) : 0;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1327, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/md5.ts"],"sourcesContent":["import { md5 } from 'js-md5';\n\nexport function isMd5(value: string): boolean {\n  return /^[0-9a-f]{32}$/.test(value);\n}\n\nexport function md5Fingerprint(value: string): string {\n  return md5(value).slice(0, 7);\n}\n\nexport async function partialMD5(file: File): Promise<string> {\n  const step = 1024;\n  const size = 1024;\n  const hasher = md5.create();\n\n  for (let i = -1; i <= 10; i++) {\n    const start = Math.min(file.size, step << (2 * i));\n    const end = Math.min(start + size, file.size);\n\n    if (start >= file.size) break;\n\n    const blobSlice = file.slice(start, end);\n    const arrayBuffer = await blobSlice.arrayBuffer();\n    const uint8Array = new Uint8Array(arrayBuffer);\n\n    hasher.update(uint8Array);\n  }\n\n  return hasher.hex();\n}\n\nexport { md5 };\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEO,SAAS,MAAM,KAAa;IACjC,OAAO,iBAAiB,IAAI,CAAC;AAC/B;AAEO,SAAS,eAAe,KAAa;IAC1C,OAAO,IAAA,gMAAG,EAAC,OAAO,KAAK,CAAC,GAAG;AAC7B;AAEO,eAAe,WAAW,IAAU;IACzC,MAAM,OAAO;IACb,MAAM,OAAO;IACb,MAAM,SAAS,gMAAG,CAAC,MAAM;IAEzB,IAAK,IAAI,IAAI,CAAC,GAAG,KAAK,IAAI,IAAK;QAC7B,MAAM,QAAQ,KAAK,GAAG,CAAC,KAAK,IAAI,EAAE,QAAS,IAAI;QAC/C,MAAM,MAAM,KAAK,GAAG,CAAC,QAAQ,MAAM,KAAK,IAAI;QAE5C,IAAI,SAAS,KAAK,IAAI,EAAE;QAExB,MAAM,YAAY,KAAK,KAAK,CAAC,OAAO;QACpC,MAAM,cAAc,MAAM,UAAU,WAAW;QAC/C,MAAM,aAAa,IAAI,WAAW;QAElC,OAAO,MAAM,CAAC;IAChB;IAEA,OAAO,OAAO,GAAG;AACnB"}},
    {"offset": {"line": 1366, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/simplecc.ts"],"sourcesContent":["import init, { simplecc } from '@simplecc/simplecc_wasm';\nimport { ConvertChineseVariant } from '@/types/book';\n\nlet initialized = false;\n\nconst initSimpleCC = async () => {\n  if (initialized) return;\n\n  await init('/vendor/simplecc/simplecc_wasm_bg.wasm');\n  initialized = true;\n};\n\nconst convertReverseMap: Record<ConvertChineseVariant, ConvertChineseVariant> = {\n  none: 'none',\n  s2t: 't2s',\n  t2s: 's2t',\n  s2tw: 'tw2s',\n  s2hk: 'hk2s',\n  s2twp: 'tw2sp',\n  tw2s: 's2tw',\n  hk2s: 's2hk',\n  tw2sp: 's2twp',\n};\n\nconst runSimpleCC = (text: string, variant: ConvertChineseVariant, reverse = false): string => {\n  return reverse ? simplecc(text, convertReverseMap[variant]) : simplecc(text, variant);\n};\n\nexport { initSimpleCC, runSimpleCC };\n"],"names":[],"mappings":";;;;;;AAAA;;AAGA,IAAI,cAAc;AAElB,MAAM,eAAe;IACnB,IAAI,aAAa;IAEjB,MAAM,IAAA,8KAAI,EAAC;IACX,cAAc;AAChB;AAEA,MAAM,oBAA0E;IAC9E,MAAM;IACN,KAAK;IACL,KAAK;IACL,MAAM;IACN,MAAM;IACN,OAAO;IACP,MAAM;IACN,MAAM;IACN,OAAO;AACT;AAEA,MAAM,cAAc,CAAC,MAAc,SAAgC,UAAU,KAAK;IAChF,OAAO,UAAU,IAAA,+KAAQ,EAAC,MAAM,iBAAiB,CAAC,QAAQ,IAAI,IAAA,+KAAQ,EAAC,MAAM;AAC/E"}},
    {"offset": {"line": 1402, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/toc.ts"],"sourcesContent":["import { ConvertChineseVariant } from '@/types/book';\nimport { SectionItem, TOCItem, CFI, BookDoc } from '@/libs/document';\nimport { initSimpleCC, runSimpleCC } from '@/utils/simplecc';\n\nexport const findParentPath = (toc: TOCItem[], href: string): TOCItem[] => {\n  for (const item of toc) {\n    if (item.href === href) {\n      return [item];\n    }\n    if (item.subitems) {\n      const path = findParentPath(item.subitems, href);\n      if (path.length) {\n        return [item, ...path];\n      }\n    }\n  }\n  return [];\n};\n\nexport const findTocItemBS = (toc: TOCItem[], cfi: string): TOCItem | null => {\n  let left = 0;\n  let right = toc.length - 1;\n  let result: TOCItem | null = null;\n\n  while (left <= right) {\n    const mid = Math.floor((left + right) / 2);\n    const item = toc[mid]!;\n    const currentCfi = toc[mid]!.cfi || '';\n    const comparison = CFI.compare(currentCfi, cfi);\n    if (comparison === 0) {\n      return findInSubitems(item, cfi) ?? item;\n    } else if (comparison < 0) {\n      result = findInSubitems(item, cfi) ?? item;\n      left = mid + 1;\n    } else {\n      right = mid - 1;\n    }\n  }\n\n  return result;\n};\n\nconst findInSubitems = (item: TOCItem, cfi: string): TOCItem | null => {\n  if (!item.subitems?.length) return null;\n  return findTocItemBS(item.subitems, cfi);\n};\n\nexport const updateToc = async (\n  bookDoc: BookDoc,\n  sortedTOC: boolean,\n  convertChineseVariant: ConvertChineseVariant,\n) => {\n  const items = bookDoc?.toc || [];\n  if (!items.length) return;\n\n  if (convertChineseVariant && convertChineseVariant !== 'none') {\n    await initSimpleCC();\n    convertTocLabels(items, convertChineseVariant);\n  }\n\n  const sections = bookDoc?.sections || [];\n  if (!sections.length) return;\n\n  const sizes = sections.map((s) => (s.linear != 'no' && s.size > 0 ? s.size : 0));\n  let cumulativeSize = 0;\n  const cumulativeSizes = sizes.reduce((acc: number[], size) => {\n    acc.push(cumulativeSize);\n    cumulativeSize += size;\n    return acc;\n  }, []);\n  const totalSize = cumulativeSizes[cumulativeSizes.length - 1] || 0;\n  const sizePerLoc = 1500;\n  sections.forEach((section, index) => {\n    section.location = {\n      current: Math.floor(cumulativeSizes[index]! / sizePerLoc),\n      next: Math.floor((cumulativeSizes[index]! + sizes[index]!) / sizePerLoc),\n      total: Math.floor(totalSize / sizePerLoc),\n    };\n  });\n\n  const sectionsMap = sections.reduce((map: Record<string, SectionItem>, section) => {\n    map[section.id] = section;\n    return map;\n  }, {});\n\n  updateTocData(bookDoc, items, sections, sectionsMap);\n\n  if (sortedTOC) {\n    sortTocItems(items);\n  }\n};\n\nconst convertTocLabels = (items: TOCItem[], convertChineseVariant: ConvertChineseVariant) => {\n  items.forEach((item) => {\n    if (item.label) {\n      item.label = runSimpleCC(item.label, convertChineseVariant);\n    }\n    if (item.subitems) {\n      convertTocLabels(item.subitems, convertChineseVariant);\n    }\n  });\n};\n\nconst updateTocData = (\n  bookDoc: BookDoc,\n  items: TOCItem[],\n  sections: SectionItem[],\n  sectionsMap: { [id: string]: SectionItem },\n  index = 0,\n): number => {\n  items.forEach((item) => {\n    item.id ??= index++;\n    if (item.href) {\n      const id = bookDoc.splitTOCHref(item.href)[0]!;\n      const section = sectionsMap[id];\n      if (section) {\n        item.cfi = section.cfi;\n        // Add location only when toc item is at the same level as the section\n        // otherwise the location will not be accurate\n        if (id === item.href || items.length <= sections.length) {\n          item.location = section.location;\n        }\n      }\n    }\n    if (item.subitems) {\n      index = updateTocData(bookDoc, item.subitems, sections, sectionsMap, index);\n    }\n  });\n  return index;\n};\n\nconst sortTocItems = (items: TOCItem[]): void => {\n  items.sort((a, b) => {\n    if (a.location && b.location) {\n      return a.location.current - b.location.current;\n    }\n    return 0;\n  });\n};\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;;;AAEO,MAAM,iBAAiB,CAAC,KAAgB;IAC7C,KAAK,MAAM,QAAQ,IAAK;QACtB,IAAI,KAAK,IAAI,KAAK,MAAM;YACtB,OAAO;gBAAC;aAAK;QACf;QACA,IAAI,KAAK,QAAQ,EAAE;YACjB,MAAM,OAAO,eAAe,KAAK,QAAQ,EAAE;YAC3C,IAAI,KAAK,MAAM,EAAE;gBACf,OAAO;oBAAC;uBAAS;iBAAK;YACxB;QACF;IACF;IACA,OAAO,EAAE;AACX;AAEO,MAAM,gBAAgB,CAAC,KAAgB;IAC5C,IAAI,OAAO;IACX,IAAI,QAAQ,IAAI,MAAM,GAAG;IACzB,IAAI,SAAyB;IAE7B,MAAO,QAAQ,MAAO;QACpB,MAAM,MAAM,KAAK,KAAK,CAAC,CAAC,OAAO,KAAK,IAAI;QACxC,MAAM,OAAO,GAAG,CAAC,IAAI;QACrB,MAAM,aAAa,GAAG,CAAC,IAAI,CAAE,GAAG,IAAI;QACpC,MAAM,aAAa,oJAAG,CAAC,OAAO,CAAC,YAAY;QAC3C,IAAI,eAAe,GAAG;YACpB,OAAO,eAAe,MAAM,QAAQ;QACtC,OAAO,IAAI,aAAa,GAAG;YACzB,SAAS,eAAe,MAAM,QAAQ;YACtC,OAAO,MAAM;QACf,OAAO;YACL,QAAQ,MAAM;QAChB;IACF;IAEA,OAAO;AACT;AAEA,MAAM,iBAAiB,CAAC,MAAe;IACrC,IAAI,CAAC,KAAK,QAAQ,EAAE,QAAQ,OAAO;IACnC,OAAO,cAAc,KAAK,QAAQ,EAAE;AACtC;AAEO,MAAM,YAAY,OACvB,SACA,WACA;IAEA,MAAM,QAAQ,SAAS,OAAO,EAAE;IAChC,IAAI,CAAC,MAAM,MAAM,EAAE;IAEnB,IAAI,yBAAyB,0BAA0B,QAAQ;QAC7D,MAAM,IAAA,8JAAY;QAClB,iBAAiB,OAAO;IAC1B;IAEA,MAAM,WAAW,SAAS,YAAY,EAAE;IACxC,IAAI,CAAC,SAAS,MAAM,EAAE;IAEtB,MAAM,QAAQ,SAAS,GAAG,CAAC,CAAC,IAAO,EAAE,MAAM,IAAI,QAAQ,EAAE,IAAI,GAAG,IAAI,EAAE,IAAI,GAAG;IAC7E,IAAI,iBAAiB;IACrB,MAAM,kBAAkB,MAAM,MAAM,CAAC,CAAC,KAAe;QACnD,IAAI,IAAI,CAAC;QACT,kBAAkB;QAClB,OAAO;IACT,GAAG,EAAE;IACL,MAAM,YAAY,eAAe,CAAC,gBAAgB,MAAM,GAAG,EAAE,IAAI;IACjE,MAAM,aAAa;IACnB,SAAS,OAAO,CAAC,CAAC,SAAS;QACzB,QAAQ,QAAQ,GAAG;YACjB,SAAS,KAAK,KAAK,CAAC,eAAe,CAAC,MAAM,GAAI;YAC9C,MAAM,KAAK,KAAK,CAAC,CAAC,eAAe,CAAC,MAAM,GAAI,KAAK,CAAC,MAAM,AAAC,IAAI;YAC7D,OAAO,KAAK,KAAK,CAAC,YAAY;QAChC;IACF;IAEA,MAAM,cAAc,SAAS,MAAM,CAAC,CAAC,KAAkC;QACrE,GAAG,CAAC,QAAQ,EAAE,CAAC,GAAG;QAClB,OAAO;IACT,GAAG,CAAC;IAEJ,cAAc,SAAS,OAAO,UAAU;IAExC,IAAI,WAAW;QACb,aAAa;IACf;AACF;AAEA,MAAM,mBAAmB,CAAC,OAAkB;IAC1C,MAAM,OAAO,CAAC,CAAC;QACb,IAAI,KAAK,KAAK,EAAE;YACd,KAAK,KAAK,GAAG,IAAA,6JAAW,EAAC,KAAK,KAAK,EAAE;QACvC;QACA,IAAI,KAAK,QAAQ,EAAE;YACjB,iBAAiB,KAAK,QAAQ,EAAE;QAClC;IACF;AACF;AAEA,MAAM,gBAAgB,CACpB,SACA,OACA,UACA,aACA,QAAQ,CAAC;IAET,MAAM,OAAO,CAAC,CAAC;QACb,KAAK,EAAE,KAAK;QACZ,IAAI,KAAK,IAAI,EAAE;YACb,MAAM,KAAK,QAAQ,YAAY,CAAC,KAAK,IAAI,CAAC,CAAC,EAAE;YAC7C,MAAM,UAAU,WAAW,CAAC,GAAG;YAC/B,IAAI,SAAS;gBACX,KAAK,GAAG,GAAG,QAAQ,GAAG;gBACtB,sEAAsE;gBACtE,8CAA8C;gBAC9C,IAAI,OAAO,KAAK,IAAI,IAAI,MAAM,MAAM,IAAI,SAAS,MAAM,EAAE;oBACvD,KAAK,QAAQ,GAAG,QAAQ,QAAQ;gBAClC;YACF;QACF;QACA,IAAI,KAAK,QAAQ,EAAE;YACjB,QAAQ,cAAc,SAAS,KAAK,QAAQ,EAAE,UAAU,aAAa;QACvE;IACF;IACA,OAAO;AACT;AAEA,MAAM,eAAe,CAAC;IACpB,MAAM,IAAI,CAAC,CAAC,GAAG;QACb,IAAI,EAAE,QAAQ,IAAI,EAAE,QAAQ,EAAE;YAC5B,OAAO,EAAE,QAAQ,CAAC,OAAO,GAAG,EAAE,QAAQ,CAAC,OAAO;QAChD;QACA,OAAO;IACT;AACF"}},
    {"offset": {"line": 1537, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/rtl.ts"],"sourcesContent":["import { getUserLang } from './misc';\n\nexport const getDirFromLanguage = (lang: string) => {\n  if (!lang) return 'auto';\n  const rtlLanguages = new Set(['ar', 'he', 'fa', 'ur', 'dv', 'ps', 'sd', 'yi']);\n  const primaryLang = lang.split('-')[0]!.toLowerCase();\n  return rtlLanguages.has(primaryLang) ? 'rtl' : 'auto';\n};\n\nexport const getDirFromUILanguage = () => {\n  const lang = getUserLang();\n  return getDirFromLanguage(lang);\n};\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,qBAAqB,CAAC;IACjC,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,eAAe,IAAI,IAAI;QAAC;QAAM;QAAM;QAAM;QAAM;QAAM;QAAM;QAAM;KAAK;IAC7E,MAAM,cAAc,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE,CAAE,WAAW;IACnD,OAAO,aAAa,GAAG,CAAC,eAAe,QAAQ;AACjD;AAEO,MAAM,uBAAuB;IAClC,MAAM,OAAO,IAAA,yJAAW;IACxB,OAAO,mBAAmB;AAC5B"}},
    {"offset": {"line": 1571, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/lang.ts"],"sourcesContent":["import { LocaleWithTextInfo } from '@/types/misc';\nimport { franc } from 'franc-min';\nimport { iso6392 } from 'iso-639-2';\nimport { iso6393To1 } from 'iso-639-3';\n\nexport const isCJKStr = (str: string) => {\n  return /[\\p{Script=Han}\\p{Script=Hiragana}\\p{Script=Katakana}\\p{Script=Hangul}]/u.test(str ?? '');\n};\n\nexport const isCJKLang = (lang: string | null | undefined): boolean => {\n  if (!lang) return false;\n  const normalizedLang = normalizedLangCode(lang);\n  return ['zh', 'ja', 'ko', 'zho', 'jpn', 'kor'].includes(normalizedLang);\n};\n\nconst ZH_SCRIPTS_MAPPING: Record<string, string> = {\n  zh: 'zh-Hans',\n  'zh-cn': 'zh-Hans',\n  'zh-hk': 'zh-Hant',\n  'zh-tw': 'zh-Hant',\n  'zh-mo': 'zh-Hant',\n  'zh-hans': 'zh-Hans',\n  'zh-hant': 'zh-Hant',\n};\n\nexport const normalizeToFullLang = (langCode: string): string => {\n  try {\n    const locale = new Intl.Locale(langCode.toLowerCase());\n    const maximized = locale.maximize();\n\n    if (maximized.language === 'zh') {\n      return maximized.script === 'Hant' ? 'zh-Hant' : 'zh-Hans';\n    }\n\n    return maximized.region ? `${maximized.language}-${maximized.region}` : langCode;\n  } catch {\n    return ZH_SCRIPTS_MAPPING[langCode.toLowerCase()] || langCode;\n  }\n};\n\nexport const normalizeToShortLang = (langCode: string): string => {\n  const lang = langCode.toLowerCase();\n  if (lang.startsWith('zh')) {\n    return ZH_SCRIPTS_MAPPING[lang] || 'zh-Hans';\n  }\n  return lang.split('-')[0]!;\n};\n\nexport const normalizedLangCode = (lang: string | null | undefined): string => {\n  if (!lang) return '';\n  return lang.split('-')[0]!.toLowerCase();\n};\n\nexport const isSameLang = (lang1?: string | null, lang2?: string | null): boolean => {\n  if (!lang1 || !lang2) return false;\n  const normalizedLang1 = normalizedLangCode(lang1);\n  const normalizedLang2 = normalizedLangCode(lang2);\n  return normalizedLang1 === normalizedLang2;\n};\n\nexport const isValidLang = (lang?: string) => {\n  if (!lang) return false;\n  if (typeof lang !== 'string') return false;\n  if (['und', 'mul', 'mis', 'zxx'].includes(lang)) return false;\n  const code = normalizedLangCode(lang);\n  return iso6392.some((l) => l.iso6391 === code || l.iso6392B === code);\n};\n\nexport const code6392to6391 = (code: string): string => {\n  const lang = iso6392.find((l) => l.iso6392B === code);\n  return lang?.iso6391 || '';\n};\n\nconst commonIndivToMacro: Record<string, string> = {\n  cmn: 'zho',\n  arb: 'ara',\n  arz: 'ara',\n  ind: 'msa',\n  zsm: 'msa',\n  nob: 'nor',\n  nno: 'nor',\n  pes: 'fas',\n  quy: 'que',\n};\n\nexport const code6393to6391 = (code: string): string => {\n  const macro = commonIndivToMacro[code] || code;\n  return iso6393To1[macro] || '';\n};\n\nexport const getLanguageName = (code: string): string => {\n  const lang = normalizedLangCode(code);\n  const language = iso6392.find((l) => l.iso6391 === lang || l.iso6392B === lang);\n  return language ? language.name : lang;\n};\n\nexport const inferLangFromScript = (text: string, lang: string): string => {\n  if (!lang || lang === 'en') {\n    if (/[\\p{Script=Hangul}]/u.test(text)) {\n      return 'ko';\n    } else if (/[\\p{Script=Hiragana}\\p{Script=Katakana}]/u.test(text)) {\n      return 'ja';\n    } else if (/[\\p{Script=Han}]/u.test(text)) {\n      return 'zh';\n    }\n  }\n  return lang;\n};\n\nexport const detectLanguage = (content: string): string => {\n  try {\n    const iso6393Lang = franc(content.substring(0, 1000));\n    const iso6391Lang = code6393to6391(iso6393Lang) || 'en';\n    return iso6391Lang;\n  } catch {\n    console.warn('Language detection failed, defaulting to en.');\n    return 'en';\n  }\n};\n\nexport const getLanguageInfo = (lang: string) => {\n  if (!lang) return {};\n  try {\n    const canonical = Intl.getCanonicalLocales(lang)[0]!;\n    const locale = new Intl.Locale(canonical) as LocaleWithTextInfo;\n    const isCJK = ['zh', 'ja', 'kr'].includes(locale.language);\n    const direction = (locale.getTextInfo?.() ?? locale.textInfo)?.direction;\n    return { canonical, locale, isCJK, direction };\n  } catch (e) {\n    console.warn(e);\n    return {};\n  }\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1745, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/book.ts"],"sourcesContent":["import { BookMetadata, EXTS } from '@/libs/document';\nimport { Book, BookConfig, BookProgress, WritingMode } from '@/types/book';\nimport { SUPPORTED_LANGS } from '@/services/constants';\nimport { getUserLang } from './misc';\nimport { getDirFromLanguage } from './rtl';\nimport { code6392to6391, isValidLang, normalizedLangCode } from './lang';\nimport { md5 } from './md5';\n\nexport const getDir = (book: Book) => {\n  // In local storage mode, return the folder name (same as book name without extension)\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  return book.relativePath.replace(/\\.[^.]+$/, '');\n};\nexport const getLibraryFilename = () => {\n  return 'library.json';\n};\nexport const getLibraryBackupFilename = () => {\n  return 'library_backup.json';\n};\nexport const getLocalBookFilename = (book: Book) => {\n  // In local storage mode, books are stored in their original relative paths\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  return book.relativePath;\n};\nexport const getCoverFilename = (book: Book) => {\n  // In local storage mode, covers are stored in a folder next to the book with the same name\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  // Remove extension from book path to get folder name\n  const pathWithoutExt = book.relativePath.replace(/\\.[^.]+$/, '');\n  const result = `${pathWithoutExt}/cover.png`;\n  console.log('[getCoverFilename] ✓ Using relativePath:', book.relativePath);\n  console.log('[getCoverFilename] ✓ Cover path result:', result);\n  return result;\n};\nexport const getConfigFilename = (book: Book) => {\n  // In local storage mode, configs are stored in a folder next to the book with the same name\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  // Remove extension from book path to get folder name\n  const pathWithoutExt = book.relativePath.replace(/\\.[^.]+$/, '');\n  return `${pathWithoutExt}/config.json`;\n};\nexport const isBookFile = (filename: string) => {\n  return Object.values(EXTS).includes(filename.split('.').pop()!);\n};\n\nexport const INIT_BOOK_CONFIG: BookConfig = {\n  updatedAt: 0,\n};\n\nexport interface LanguageMap {\n  [key: string]: string;\n}\n\nexport interface Identifier {\n  scheme: string;\n  value: string;\n}\n\nexport interface Contributor {\n  name: LanguageMap;\n}\n\nconst formatLanguageMap = (x: string | LanguageMap, defaultLang = false): string => {\n  const userLang = getUserLang();\n  if (!x) return '';\n  if (typeof x === 'string') return x;\n  const keys = Object.keys(x);\n  return defaultLang ? x[keys[0]!]! : x[userLang] || x[keys[0]!]!;\n};\n\nexport const listFormater = (narrow = false, lang = '') => {\n  lang = lang ? lang : getUserLang();\n  if (narrow) {\n    return new Intl.ListFormat('en', { style: 'narrow', type: 'unit' });\n  } else {\n    return new Intl.ListFormat(lang, { style: 'long', type: 'conjunction' });\n  }\n};\n\nexport const getBookLangCode = (lang: string | string[] | undefined) => {\n  try {\n    const bookLang = typeof lang === 'string' ? lang : lang?.[0];\n    return bookLang ? bookLang.split('-')[0]! : '';\n  } catch {\n    return '';\n  }\n};\n\nexport const flattenContributors = (\n  contributors: string | string[] | Contributor | Contributor[],\n) => {\n  if (!contributors) return '';\n  return Array.isArray(contributors)\n    ? contributors\n      .map((contributor) =>\n        typeof contributor === 'string' ? contributor : formatLanguageMap(contributor?.name),\n      )\n      .join(', ')\n    : typeof contributors === 'string'\n      ? contributors\n      : formatLanguageMap(contributors?.name);\n};\n\n// prettier-ignore\nconst LASTNAME_AUTHOR_SORT_LANGS = ['ar', 'bo', 'de', 'en', 'es', 'fr', 'hi', 'it', 'nl', 'pl', 'pt', 'ru', 'th', 'tr', 'uk'];\n\nconst formatAuthorName = (name: string, lastNameFirst: boolean) => {\n  if (!name) return '';\n  const parts = name.split(' ');\n  if (lastNameFirst && parts.length > 1) {\n    return `${parts[parts.length - 1]}, ${parts.slice(0, -1).join(' ')}`;\n  }\n  return name;\n};\n\nexport const formatAuthors = (\n  contributors: string | string[] | Contributor | Contributor[],\n  bookLang?: string | string[],\n  sortAs?: boolean,\n) => {\n  const langCode = getBookLangCode(bookLang) || 'en';\n  const lastNameFirst = !!sortAs && LASTNAME_AUTHOR_SORT_LANGS.includes(langCode);\n  return Array.isArray(contributors)\n    ? listFormater(langCode === 'zh', langCode).format(\n      contributors.map((contributor) =>\n        typeof contributor === 'string'\n          ? formatAuthorName(contributor, lastNameFirst)\n          : formatAuthorName(formatLanguageMap(contributor?.name), lastNameFirst),\n      ),\n    )\n    : typeof contributors === 'string'\n      ? formatAuthorName(contributors, lastNameFirst)\n      : formatAuthorName(formatLanguageMap(contributors?.name), lastNameFirst);\n};\n\nexport const formatTitle = (title: string | LanguageMap) => {\n  return typeof title === 'string' ? title : formatLanguageMap(title);\n};\n\nexport const formatDescription = (description?: string | LanguageMap) => {\n  if (!description) return '';\n  const text = typeof description === 'string' ? description : formatLanguageMap(description);\n  return text\n    .replace(/<\\/?[^>]+(>|$)/g, '')\n    .replace(/&#\\d+;/g, '')\n    .trim();\n};\n\nexport const formatPublisher = (publisher: string | LanguageMap) => {\n  return typeof publisher === 'string' ? publisher : formatLanguageMap(publisher);\n};\n\nconst langCodeToLangName = (langCode: string) => {\n  return SUPPORTED_LANGS[langCode] || langCode.toUpperCase();\n};\n\nexport const formatLanguage = (lang: string | string[] | undefined): string => {\n  return Array.isArray(lang)\n    ? lang.map(langCodeToLangName).join(', ')\n    : langCodeToLangName(lang || '');\n};\n\n// Should return valid ISO-639-1 language code, fallback to 'en' if not valid\nexport const getPrimaryLanguage = (lang: string | string[] | undefined) => {\n  const primaryLang = Array.isArray(lang) ? lang[0] : lang;\n  if (isValidLang(primaryLang)) {\n    const normalizedLang = normalizedLangCode(primaryLang);\n    return code6392to6391(normalizedLang) || normalizedLang;\n  }\n  return 'en';\n};\n\nexport const formatDate = (date: string | number | Date | null | undefined, isUTC = false) => {\n  if (!date) return;\n  const userLang = getUserLang();\n  try {\n    return new Date(date).toLocaleDateString(userLang, {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      timeZone: isUTC ? 'UTC' : undefined,\n    });\n  } catch {\n    return;\n  }\n};\n\nexport const formatBytes = (bytes?: number | null, locale = 'en-US') => {\n  if (!bytes) return '';\n  const units = ['byte', 'kilobyte', 'megabyte', 'gigabyte', 'terabyte'];\n  const i = Math.floor(Math.log(bytes) / Math.log(1024));\n  const value = bytes / Math.pow(1024, i);\n  const formatter = new Intl.NumberFormat(locale, {\n    style: 'unit',\n    unit: units[i],\n    unitDisplay: 'short',\n    maximumFractionDigits: 2,\n  });\n  return formatter.format(value);\n};\n\nexport const getCurrentPage = (book: Book, progress: BookProgress) => {\n  const bookFormat = book.format;\n  const { section, pageinfo } = progress;\n  return bookFormat === 'PDF'\n    ? section\n      ? section.current + 1\n      : 0\n    : pageinfo\n      ? pageinfo.current + 1\n      : 0;\n};\n\nexport const getBookDirFromWritingMode = (writingMode: WritingMode) => {\n  switch (writingMode) {\n    case 'horizontal-tb':\n      return 'ltr';\n    case 'horizontal-rl':\n    case 'vertical-rl':\n      return 'rtl';\n    default:\n      return 'auto';\n  }\n};\n\nexport const getBookDirFromLanguage = (language: string | string[] | undefined) => {\n  const lang = getPrimaryLanguage(language) || '';\n  return getDirFromLanguage(lang);\n};\n\nconst getTitleForHash = (title: string | LanguageMap) => {\n  return typeof title === 'string' ? title : formatLanguageMap(title, true);\n};\n\nconst getAuthorsList = (contributors: string | string[] | Contributor | Contributor[]) => {\n  if (!contributors) return [];\n  return Array.isArray(contributors)\n    ? contributors\n      .map((contributor) =>\n        typeof contributor === 'string'\n          ? contributor\n          : formatLanguageMap(contributor?.name, true),\n      )\n      .filter(Boolean)\n    : [\n      typeof contributors === 'string'\n        ? contributors\n        : formatLanguageMap(contributors?.name, true),\n    ];\n};\n\nconst normalizeIdentifier = (identifier: string) => {\n  try {\n    if (identifier.includes('urn:')) {\n      // Slice after the last ':'\n      return identifier.match(/[^:]+$/)?.[0] || '';\n    } else if (identifier.includes(':')) {\n      // Slice after the first ':'\n      return identifier.match(/^[^:]+:(.+)$/)?.[1] || '';\n    }\n  } catch {\n    return identifier;\n  }\n  return identifier;\n};\n\nconst getPreferredIdentifier = (identifiers: string[] | Identifier[]) => {\n  for (const scheme of ['uuid', 'calibre', 'isbn']) {\n    const found = identifiers.find((identifier) =>\n      typeof identifier === 'string'\n        ? identifier.toLowerCase().includes(scheme)\n        : identifier.scheme.toLowerCase() === scheme,\n    );\n    if (found) {\n      return typeof found === 'string' ? normalizeIdentifier(found) : found.value;\n    }\n  }\n  return;\n};\n\nconst getIdentifiersList = (\n  identifiers: undefined | string | string[] | Identifier | Identifier[],\n) => {\n  if (!identifiers) return [];\n  if (Array.isArray(identifiers)) {\n    const preferred = getPreferredIdentifier(identifiers);\n    if (preferred) {\n      return [preferred];\n    }\n  }\n  return Array.isArray(identifiers)\n    ? identifiers\n      .map((identifier) =>\n        typeof identifier === 'string' ? normalizeIdentifier(identifier) : identifier.value,\n      )\n      .filter(Boolean)\n    : typeof identifiers === 'string'\n      ? [normalizeIdentifier(identifiers)]\n      : [identifiers.value];\n};\n\nexport const getMetadataHash = (metadata: BookMetadata) => {\n  try {\n    const title = getTitleForHash(metadata.title);\n    const authors = getAuthorsList(metadata.author).join(',');\n    const identifiers = getIdentifiersList(metadata.altIdentifier || metadata.identifier).join(',');\n    const hashSource = `${title}|${authors}|${identifiers}`;\n    const metaHash = md5(hashSource.normalize('NFC'));\n    return metaHash;\n  } catch (error) {\n    console.error('Error generating metadata hash:', error);\n  }\n  return;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2067, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/path.ts"],"sourcesContent":["import { join } from '@tauri-apps/api/path';\nimport { isContentURI, isFileURI, isValidURL } from './misc';\n\nexport const getFilename = (fileOrUri: string) => {\n  if (isValidURL(fileOrUri) || isContentURI(fileOrUri) || isFileURI(fileOrUri)) {\n    fileOrUri = decodeURI(fileOrUri);\n  }\n  const normalizedPath = fileOrUri.replace(/\\\\/g, '/');\n  const parts = normalizedPath.split('/');\n  const lastPart = parts.pop()!;\n  return lastPart.split('?')[0]!;\n};\n\nexport const getBaseFilename = (filename: string) => {\n  const normalizedPath = filename.replace(/\\\\/g, '/');\n  const name = normalizedPath.split('/').pop() || '';\n\n  const parts = name.split('.');\n  if (parts.length <= 1) {\n    return name;\n  }\n\n  return parts.slice(0, -1).join('.');\n};\n\nexport const getDirPath = (filePath: string) => {\n  const normalizedPath = filePath.replace(/\\\\/g, '/');\n  const parts = normalizedPath.split('/');\n  parts.pop();\n  return parts.join('/');\n};\n\nexport const joinPaths = async (...paths: string[]) => {\n  return await join(...paths);\n};\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;;;AAEO,MAAM,cAAc,CAAC;IAC1B,IAAI,IAAA,wJAAU,EAAC,cAAc,IAAA,0JAAY,EAAC,cAAc,IAAA,uJAAS,EAAC,YAAY;QAC5E,YAAY,UAAU;IACxB;IACA,MAAM,iBAAiB,UAAU,OAAO,CAAC,OAAO;IAChD,MAAM,QAAQ,eAAe,KAAK,CAAC;IACnC,MAAM,WAAW,MAAM,GAAG;IAC1B,OAAO,SAAS,KAAK,CAAC,IAAI,CAAC,EAAE;AAC/B;AAEO,MAAM,kBAAkB,CAAC;IAC9B,MAAM,iBAAiB,SAAS,OAAO,CAAC,OAAO;IAC/C,MAAM,OAAO,eAAe,KAAK,CAAC,KAAK,GAAG,MAAM;IAEhD,MAAM,QAAQ,KAAK,KAAK,CAAC;IACzB,IAAI,MAAM,MAAM,IAAI,GAAG;QACrB,OAAO;IACT;IAEA,OAAO,MAAM,KAAK,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC;AACjC;AAEO,MAAM,aAAa,CAAC;IACzB,MAAM,iBAAiB,SAAS,OAAO,CAAC,OAAO;IAC/C,MAAM,QAAQ,eAAe,KAAK,CAAC;IACnC,MAAM,GAAG;IACT,OAAO,MAAM,IAAI,CAAC;AACpB;AAEO,MAAM,YAAY,OAAO,GAAG;IACjC,OAAO,MAAM,IAAA,qNAAI,KAAI;AACvB"}},
    {"offset": {"line": 2115, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/event.ts"],"sourcesContent":["class EventDispatcher {\n  private syncListeners: Map<string, Array<(event: CustomEvent) => boolean>>;\n  private asyncListeners: Map<string, Set<(event: CustomEvent) => Promise<void> | void>>;\n\n  constructor() {\n    this.syncListeners = new Map();\n    this.asyncListeners = new Map();\n  }\n\n  on(event: string, callback: (event: CustomEvent) => Promise<void> | void): void {\n    if (!this.asyncListeners.has(event)) {\n      this.asyncListeners.set(event, new Set());\n    }\n    this.asyncListeners.get(event)!.add(callback);\n  }\n\n  off(event: string, callback: (event: CustomEvent) => Promise<void> | void): void {\n    this.asyncListeners.get(event)?.delete(callback);\n  }\n\n  async dispatch(event: string, detail?: unknown): Promise<void> {\n    const listeners = this.asyncListeners.get(event);\n    if (listeners) {\n      const customEvent = new CustomEvent(event, { detail });\n      for (const listener of listeners) {\n        await listener(customEvent);\n      }\n    }\n  }\n\n  onSync(event: string, callback: (event: CustomEvent) => boolean): void {\n    if (!this.syncListeners.has(event)) {\n      this.syncListeners.set(event, []);\n    }\n    this.syncListeners.get(event)!.push(callback);\n  }\n\n  offSync(event: string, callback: (event: CustomEvent) => boolean): void {\n    const listeners = this.syncListeners.get(event);\n    if (listeners) {\n      this.syncListeners.set(\n        event,\n        listeners.filter((listener) => listener !== callback),\n      );\n    }\n  }\n\n  dispatchSync(event: string, detail?: unknown): boolean {\n    const listeners = this.syncListeners.get(event);\n    if (listeners) {\n      const customEvent = new CustomEvent(event, { detail });\n      for (const listener of [...listeners].reverse()) {\n        const consumed = listener(customEvent);\n        if (consumed) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n}\n\nexport const eventDispatcher = new EventDispatcher();\n"],"names":[],"mappings":";;;;AAAA,MAAM;IACI,cAAmE;IACnE,eAA+E;IAEvF,aAAc;QACZ,IAAI,CAAC,aAAa,GAAG,IAAI;QACzB,IAAI,CAAC,cAAc,GAAG,IAAI;IAC5B;IAEA,GAAG,KAAa,EAAE,QAAsD,EAAQ;QAC9E,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,QAAQ;YACnC,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,OAAO,IAAI;QACrC;QACA,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,OAAQ,GAAG,CAAC;IACtC;IAEA,IAAI,KAAa,EAAE,QAAsD,EAAQ;QAC/E,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,QAAQ,OAAO;IACzC;IAEA,MAAM,SAAS,KAAa,EAAE,MAAgB,EAAiB;QAC7D,MAAM,YAAY,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC;QAC1C,IAAI,WAAW;YACb,MAAM,cAAc,IAAI,YAAY,OAAO;gBAAE;YAAO;YACpD,KAAK,MAAM,YAAY,UAAW;gBAChC,MAAM,SAAS;YACjB;QACF;IACF;IAEA,OAAO,KAAa,EAAE,QAAyC,EAAQ;QACrE,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ;YAClC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,OAAO,EAAE;QAClC;QACA,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,OAAQ,IAAI,CAAC;IACtC;IAEA,QAAQ,KAAa,EAAE,QAAyC,EAAQ;QACtE,MAAM,YAAY,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC;QACzC,IAAI,WAAW;YACb,IAAI,CAAC,aAAa,CAAC,GAAG,CACpB,OACA,UAAU,MAAM,CAAC,CAAC,WAAa,aAAa;QAEhD;IACF;IAEA,aAAa,KAAa,EAAE,MAAgB,EAAW;QACrD,MAAM,YAAY,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC;QACzC,IAAI,WAAW;YACb,MAAM,cAAc,IAAI,YAAY,OAAO;gBAAE;YAAO;YACpD,KAAK,MAAM,YAAY;mBAAI;aAAU,CAAC,OAAO,GAAI;gBAC/C,MAAM,WAAW,SAAS;gBAC1B,IAAI,UAAU;oBACZ,OAAO;gBACT;YACF;QACF;QACA,OAAO;IACT;AACF;AAEO,MAAM,kBAAkB,IAAI"}},
    {"offset": {"line": 2184, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/open.ts"],"sourcesContent":["import { openUrl } from '@tauri-apps/plugin-opener';\nimport { isTauriAppPlatform } from '@/services/environment';\n\nexport const interceptWindowOpen = () => {\n  const windowOpen = window.open;\n  globalThis.open = function (\n    url?: string | URL,\n    target?: string,\n    features?: string,\n  ): Window | null {\n    if (isTauriAppPlatform()) {\n      openUrl(url?.toString() || '');\n      return null;\n    } else {\n      return windowOpen(url, target, features);\n    }\n  };\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,MAAM,sBAAsB;IACjC,MAAM,aAAa,OAAO,IAAI;IAC9B,WAAW,IAAI,GAAG,SAChB,GAAkB,EAClB,MAAe,EACf,QAAiB;QAEjB,IAAI,IAAA,0KAAkB,KAAI;YACxB,IAAA,iQAAO,EAAC,KAAK,cAAc;YAC3B,OAAO;QACT,OAAO;YACL,OAAO,WAAW,KAAK,QAAQ;QACjC;IACF;AACF"}},
    {"offset": {"line": 2210, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/jwt.ts"],"sourcesContent":["import { jwtVerify, SignJWT } from 'jose';\n\n// 单用户认证配置\n// 为确保中间件与API一致，开发环境使用固定默认密钥\nconst SECRET_KEY = process.env['AUTH_SECRET'] || 'dev-secret';\nconst USER_PASSWORD = process.env['AUTH_PASSWORD'] || 'changeme-' + Math.random().toString(36).substring(2, 15);\nconst USERNAME = 'xingjjjjj';\n\n// 在服务器端启动时打印认证信息\nif (typeof window === 'undefined' && process.env['NODE_ENV'] !== 'production') {\n    console.log('\\n========== READEST AUTHENTICATION (Development) ==========');\n    console.log(`Username: ${USERNAME}`);\n    console.log(`Password: ${USER_PASSWORD}`);\n    console.log(`Secret Key: ${SECRET_KEY}`);\n    console.log('==========================================================\\n');\n}\n\nconst key = new TextEncoder().encode(SECRET_KEY);\n\nexport interface AuthPayload {\n    username: string;\n    iat?: number;\n    exp?: number;\n}\n\n/**\n * 创建 JWT 令牌\n */\nexport async function createJWT(username: string): Promise<string> {\n    const token = await new SignJWT({ username })\n        .setProtectedHeader({ alg: 'HS256' })\n        .setIssuedAt()\n        .setExpirationTime('30d')\n        .sign(key);\n\n    return token;\n}\n\n/**\n * 验证 JWT 令牌\n */\nexport async function verifyJWT(token: string): Promise<AuthPayload | null> {\n    try {\n        const verified = await jwtVerify(token, key);\n        return verified.payload as unknown as AuthPayload;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * 验证用户名和密码\n */\nexport function validateCredentials(username: string, password: string): boolean {\n    return username === USERNAME && password === USER_PASSWORD;\n}\n\n/**\n * 从 Authorization header 中提取令牌\n */\nexport function extractToken(authHeader: string | null): string | null {\n    if (!authHeader) return null;\n\n    const parts = authHeader.split(' ');\n    if (parts.length !== 2 || parts[0] !== 'Bearer') {\n        return null;\n    }\n\n    return parts[1] ?? null;\n}\n\n/**\n * 生成凭证字符串（用于调试）\n */\nexport function getCredentials(): { username: string; password: string; secret: string } {\n    return {\n        username: USERNAME,\n        password: USER_PASSWORD,\n        secret: SECRET_KEY,\n    };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAImB;AAJnB;AAAA;;AAEA,UAAU;AACV,4BAA4B;AAC5B,MAAM,aAAa,sUAAO,CAAC,GAAG,CAAC,cAAc,IAAI;AACjD,MAAM,gBAAgB,sUAAO,CAAC,GAAG,CAAC,gBAAgB,IAAI,cAAc,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG;AAC5G,MAAM,WAAW;AAEjB,iBAAiB;AACjB;;AAQA,MAAM,MAAM,IAAI,cAAc,MAAM,CAAC;AAW9B,eAAe,UAAU,QAAgB;IAC5C,MAAM,QAAQ,MAAM,IAAI,+MAAO,CAAC;QAAE;IAAS,GACtC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,OAClB,IAAI,CAAC;IAEV,OAAO;AACX;AAKO,eAAe,UAAU,KAAa;IACzC,IAAI;QACA,MAAM,WAAW,MAAM,IAAA,mNAAS,EAAC,OAAO;QACxC,OAAO,SAAS,OAAO;IAC3B,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAKO,SAAS,oBAAoB,QAAgB,EAAE,QAAgB;IAClE,OAAO,aAAa,YAAY,aAAa;AACjD;AAKO,SAAS,aAAa,UAAyB;IAClD,IAAI,CAAC,YAAY,OAAO;IAExB,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,IAAI,MAAM,MAAM,KAAK,KAAK,KAAK,CAAC,EAAE,KAAK,UAAU;QAC7C,OAAO;IACX;IAEA,OAAO,KAAK,CAAC,EAAE,IAAI;AACvB;AAKO,SAAS;IACZ,OAAO;QACH,UAAU;QACV,UAAU;QACV,QAAQ;IACZ;AACJ"}},
    {"offset": {"line": 2276, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/access.ts"],"sourcesContent":["import { jwtDecode } from 'jwt-decode';\nimport { verifyJWT } from '@/utils/jwt';\nimport { UserPlan } from '@/types/quota';\nimport { DEFAULT_DAILY_TRANSLATION_QUOTA, DEFAULT_STORAGE_QUOTA } from '@/services/constants';\nimport { isWebAppPlatform } from '@/services/environment';\nimport { getDailyUsage } from '@/services/translators/utils';\n\ninterface Token {\n  plan: UserPlan;\n  storage_usage_bytes: number;\n  storage_purchased_bytes: number;\n  [key: string]: string | number;\n}\n\nexport const getSubscriptionPlan = (token: string): UserPlan => {\n  const data = jwtDecode<Token>(token) || {};\n  return data['plan'] || 'free';\n};\n\nexport const getUserProfilePlan = (token: string): UserPlan => {\n  const data = jwtDecode<Token>(token) || {};\n  let plan = data['plan'] || 'free';\n  if (plan === 'free') {\n    const purchasedQuota = data['storage_purchased_bytes'] || 0;\n    if (purchasedQuota > 0) {\n      plan = 'purchase';\n    }\n  }\n  return plan;\n};\n\nexport const STORAGE_QUOTA_GRACE_BYTES = 10 * 1024 * 1024; // 10 MB grace\n\nexport const getStoragePlanData = (token: string) => {\n  const data = jwtDecode<Token>(token) || {};\n  const plan = data['plan'] || 'free';\n  const usage = data['storage_usage_bytes'] || 0;\n  const purchasedQuota = data['storage_purchased_bytes'] || 0;\n  const fixedQuota = parseInt(process.env['NEXT_PUBLIC_STORAGE_FIXED_QUOTA'] || '0');\n  const planQuota = fixedQuota || DEFAULT_STORAGE_QUOTA[plan] || DEFAULT_STORAGE_QUOTA['free'];\n  const quota = planQuota + purchasedQuota;\n\n  return {\n    plan,\n    usage,\n    quota,\n  };\n};\n\nexport const getTranslationPlanData = (token: string) => {\n  const data = jwtDecode<Token>(token) || {};\n  const plan: UserPlan = data['plan'] || 'free';\n  const usage = getDailyUsage() || 0;\n  const quota = DEFAULT_DAILY_TRANSLATION_QUOTA[plan];\n\n  return {\n    plan,\n    usage,\n    quota,\n  };\n};\n\nexport const getDailyTranslationPlanData = (token: string) => {\n  const data = jwtDecode<Token>(token) || {};\n  const plan = data['plan'] || 'free';\n  const fixedQuota = parseInt(process.env['NEXT_PUBLIC_TRANSLATION_FIXED_QUOTA'] || '0');\n  const quota =\n    fixedQuota || DEFAULT_DAILY_TRANSLATION_QUOTA[plan] || DEFAULT_DAILY_TRANSLATION_QUOTA['free'];\n\n  return {\n    plan,\n    quota,\n  };\n};\n\nexport const getAccessToken = async (): Promise<string | null> => {\n  // Get token from localStorage (client-side) or from request (server-side)\n  if (isWebAppPlatform()) {\n    return localStorage.getItem('token') ?? null;\n  }\n  return null;\n};\n\nexport const getUserID = async (): Promise<string | null> => {\n  if (isWebAppPlatform()) {\n    const user = localStorage.getItem('user') ?? '{}';\n    return JSON.parse(user).id ?? null;\n  }\n  return null;\n};\n\nexport const validateUserAndToken = async (authHeader: string | null | undefined) => {\n  if (!authHeader) return {};\n\n  const token = authHeader.replace('Bearer ', '');\n  try {\n    const payload = await verifyJWT(token);\n    if (!payload) return {};\n    return { user: { id: 'xingjjjjj', email: 'admin@local' }, token };\n  } catch (error) {\n    return {};\n  }\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAsC8B;AAtC9B;AACA;AAEA;AACA;AACA;;;;;;AASO,MAAM,sBAAsB,CAAC;IAClC,MAAM,OAAO,IAAA,yNAAS,EAAQ,UAAU,CAAC;IACzC,OAAO,IAAI,CAAC,OAAO,IAAI;AACzB;AAEO,MAAM,qBAAqB,CAAC;IACjC,MAAM,OAAO,IAAA,yNAAS,EAAQ,UAAU,CAAC;IACzC,IAAI,OAAO,IAAI,CAAC,OAAO,IAAI;IAC3B,IAAI,SAAS,QAAQ;QACnB,MAAM,iBAAiB,IAAI,CAAC,0BAA0B,IAAI;QAC1D,IAAI,iBAAiB,GAAG;YACtB,OAAO;QACT;IACF;IACA,OAAO;AACT;AAEO,MAAM,4BAA4B,KAAK,OAAO,MAAM,cAAc;AAElE,MAAM,qBAAqB,CAAC;IACjC,MAAM,OAAO,IAAA,yNAAS,EAAQ,UAAU,CAAC;IACzC,MAAM,OAAO,IAAI,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,IAAI,CAAC,sBAAsB,IAAI;IAC7C,MAAM,iBAAiB,IAAI,CAAC,0BAA0B,IAAI;IAC1D,MAAM,aAAa,SAAS,sUAAO,CAAC,GAAG,CAAC,kCAAkC,IAAI;IAC9E,MAAM,YAAY,cAAc,2KAAqB,CAAC,KAAK,IAAI,2KAAqB,CAAC,OAAO;IAC5F,MAAM,QAAQ,YAAY;IAE1B,OAAO;QACL;QACA;QACA;IACF;AACF;AAEO,MAAM,yBAAyB,CAAC;IACrC,MAAM,OAAO,IAAA,yNAAS,EAAQ,UAAU,CAAC;IACzC,MAAM,OAAiB,IAAI,CAAC,OAAO,IAAI;IACvC,MAAM,QAAQ,IAAA,8KAAa,OAAM;IACjC,MAAM,QAAQ,qLAA+B,CAAC,KAAK;IAEnD,OAAO;QACL;QACA;QACA;IACF;AACF;AAEO,MAAM,8BAA8B,CAAC;IAC1C,MAAM,OAAO,IAAA,yNAAS,EAAQ,UAAU,CAAC;IACzC,MAAM,OAAO,IAAI,CAAC,OAAO,IAAI;IAC7B,MAAM,aAAa,SAAS,sUAAO,CAAC,GAAG,CAAC,sCAAsC,IAAI;IAClF,MAAM,QACJ,cAAc,qLAA+B,CAAC,KAAK,IAAI,qLAA+B,CAAC,OAAO;IAEhG,OAAO;QACL;QACA;IACF;AACF;AAEO,MAAM,iBAAiB;IAC5B,0EAA0E;IAC1E,IAAI,IAAA,wKAAgB,KAAI;QACtB,OAAO,aAAa,OAAO,CAAC,YAAY;IAC1C;IACA,OAAO;AACT;AAEO,MAAM,YAAY;IACvB,IAAI,IAAA,wKAAgB,KAAI;QACtB,MAAM,OAAO,aAAa,OAAO,CAAC,WAAW;QAC7C,OAAO,KAAK,KAAK,CAAC,MAAM,EAAE,IAAI;IAChC;IACA,OAAO;AACT;AAEO,MAAM,uBAAuB,OAAO;IACzC,IAAI,CAAC,YAAY,OAAO,CAAC;IAEzB,MAAM,QAAQ,WAAW,OAAO,CAAC,WAAW;IAC5C,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,sJAAS,EAAC;QAChC,IAAI,CAAC,SAAS,OAAO,CAAC;QACtB,OAAO;YAAE,MAAM;gBAAE,IAAI;gBAAa,OAAO;YAAc;YAAG;QAAM;IAClE,EAAE,OAAO,OAAO;QACd,OAAO,CAAC;IACV;AACF"}},
    {"offset": {"line": 2396, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/transfer.ts"],"sourcesContent":["import { invoke, Channel } from '@tauri-apps/api/core';\n\nexport type UploadMethod = 'POST' | 'PUT';\n\nexport const enum UploadFileError {\n  Unauthorized = 'Unauthorized access',\n  DownloadFailed = 'File download failed',\n}\n\nexport interface ProgressPayload {\n  progress: number;\n  total: number;\n  transferSpeed: number;\n}\n\nexport type ProgressHandler = (progress: ProgressPayload) => void;\n\nexport const webUpload = (file: File, uploadUrl: string, onProgress?: ProgressHandler) => {\n  return new Promise<void>((resolve, reject) => {\n    const startTime = Date.now();\n    const xhr = new XMLHttpRequest();\n    xhr.open('PUT', uploadUrl, true);\n\n    xhr.upload.onprogress = (event) => {\n      if (onProgress && event.lengthComputable) {\n        onProgress({\n          progress: event.loaded,\n          total: event.total,\n          transferSpeed: event.loaded / ((Date.now() - startTime) / 1000),\n        });\n      }\n    };\n\n    xhr.onload = () => {\n      if (xhr.status >= 200 && xhr.status < 300) {\n        resolve();\n      } else {\n        reject(new Error(`Upload failed with status ${xhr.status}`));\n      }\n    };\n\n    xhr.onerror = () => reject(new Error('Upload failed'));\n\n    xhr.send(file);\n  });\n};\n\nexport const webDownload = async (\n  downloadUrl: string,\n  onProgress?: ProgressHandler,\n  headers?: Record<string, string>,\n) => {\n  const response = await fetch(downloadUrl, {\n    method: 'GET',\n    headers: headers ? headers : undefined,\n  });\n  if (!response.ok) {\n    if (response.status === 401 || response.status === 403) {\n      throw new Error(UploadFileError.Unauthorized);\n    }\n    throw new Error(UploadFileError.DownloadFailed);\n  }\n\n  const responseHeaders = Object.fromEntries(response.headers.entries());\n  const contentLength =\n    response.headers.get('Content-Length') || response.headers.get('X-Content-Length');\n  if (!contentLength) throw new Error('Cannot track progress: Content-Length missing');\n\n  const totalSize = parseInt(contentLength, 10);\n  let receivedSize = 0;\n  const reader = response.body!.getReader();\n  const chunks: Uint8Array[] = [];\n\n  const startTime = Date.now();\n  while (true) {\n    const { done, value } = await reader.read();\n    if (done) break;\n\n    chunks.push(value);\n    receivedSize += value.length;\n\n    if (onProgress) {\n      onProgress({\n        progress: receivedSize,\n        total: totalSize,\n        transferSpeed: receivedSize / ((Date.now() - startTime) / 1000),\n      });\n    }\n  }\n\n  return { headers: responseHeaders, blob: new Blob(chunks as BlobPart[]) };\n};\n\nexport const tauriUpload = async (\n  url: string,\n  filePath: string,\n  method: UploadMethod,\n  progressHandler?: ProgressHandler,\n  headers?: Map<string, string>,\n): Promise<string> => {\n  const ids = new Uint32Array(1);\n  window.crypto.getRandomValues(ids);\n  const id = ids[0];\n\n  const onProgress = new Channel<ProgressPayload>();\n  if (progressHandler) {\n    onProgress.onmessage = progressHandler;\n  }\n\n  return await invoke('upload_file', {\n    id,\n    url,\n    filePath,\n    method,\n    headers: headers ?? {},\n    onProgress,\n  });\n};\n\nexport const tauriDownload = async (\n  url: string,\n  filePath: string,\n  progressHandler?: ProgressHandler,\n  headers?: Record<string, string>,\n  body?: string,\n  singleThreaded?: boolean,\n  skipSslVerification?: boolean,\n): Promise<Record<string, string>> => {\n  const ids = new Uint32Array(1);\n  window.crypto.getRandomValues(ids);\n  const id = ids[0];\n\n  const onProgress = new Channel<ProgressPayload>();\n  if (progressHandler) {\n    onProgress.onmessage = progressHandler;\n  }\n\n  const responseHeaders = await invoke<Record<string, string>>('download_file', {\n    id,\n    url,\n    filePath,\n    headers: headers ?? {},\n    onProgress,\n    body,\n    singleThreaded,\n    skipSslVerification,\n  });\n  return responseHeaders;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2521, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/network.ts"],"sourcesContent":["export const isLanAddress = (url: string) => {\n  try {\n    const urlObj = new URL(url);\n    const hostname = urlObj.hostname;\n\n    if (hostname === 'localhost' || hostname === '127.0.0.1') {\n      return true;\n    }\n\n    // Check for IPv4 private ranges\n    const ipv4Regex = /^(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})$/;\n    const match = hostname.match(ipv4Regex);\n\n    if (match) {\n      const [, a, b, c, d] = match.map(Number);\n      if (a === undefined || b === undefined || c === undefined || d === undefined) {\n        return false;\n      }\n\n      // Validate IP format\n      if (a > 255 || b > 255 || c > 255 || d > 255) {\n        return false;\n      }\n\n      // Check private IP ranges:\n      // 10.0.0.0/8 (10.0.0.0 to 10.255.255.255)\n      if (a === 10) return true;\n\n      // 172.16.0.0/12 (172.16.0.0 to 172.31.255.255)\n      if (a === 172 && b >= 16 && b <= 31) return true;\n\n      // 192.168.0.0/16 (192.168.0.0 to 192.168.255.255)\n      if (a === 192 && b === 168) return true;\n\n      // 169.254.0.0/16 (link-local addresses)\n      if (a === 169 && b === 254) return true;\n\n      // Tailscale IPv4 range: 100.64.0.0/10 (100.64.0.0 to 100.127.255.255)\n      if (a === 100 && b >= 64 && b <= 127) return true;\n    }\n\n    // Check for IPv6 private addresses (simplified check)\n    if (hostname.includes(':')) {\n      if (\n        hostname.startsWith('::1') ||\n        hostname.startsWith('fe80:') ||\n        hostname.startsWith('fc00:') ||\n        hostname.startsWith('fd00:')\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  } catch {\n    return false;\n  }\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,eAAe,CAAC;IAC3B,IAAI;QACF,MAAM,SAAS,IAAI,IAAI;QACvB,MAAM,WAAW,OAAO,QAAQ;QAEhC,IAAI,aAAa,eAAe,aAAa,aAAa;YACxD,OAAO;QACT;QAEA,gCAAgC;QAChC,MAAM,YAAY;QAClB,MAAM,QAAQ,SAAS,KAAK,CAAC;QAE7B,IAAI,OAAO;YACT,MAAM,GAAG,GAAG,GAAG,GAAG,EAAE,GAAG,MAAM,GAAG,CAAC;YACjC,IAAI,MAAM,aAAa,MAAM,aAAa,MAAM,aAAa,MAAM,WAAW;gBAC5E,OAAO;YACT;YAEA,qBAAqB;YACrB,IAAI,IAAI,OAAO,IAAI,OAAO,IAAI,OAAO,IAAI,KAAK;gBAC5C,OAAO;YACT;YAEA,2BAA2B;YAC3B,0CAA0C;YAC1C,IAAI,MAAM,IAAI,OAAO;YAErB,+CAA+C;YAC/C,IAAI,MAAM,OAAO,KAAK,MAAM,KAAK,IAAI,OAAO;YAE5C,kDAAkD;YAClD,IAAI,MAAM,OAAO,MAAM,KAAK,OAAO;YAEnC,wCAAwC;YACxC,IAAI,MAAM,OAAO,MAAM,KAAK,OAAO;YAEnC,sEAAsE;YACtE,IAAI,MAAM,OAAO,KAAK,MAAM,KAAK,KAAK,OAAO;QAC/C;QAEA,sDAAsD;QACtD,IAAI,SAAS,QAAQ,CAAC,MAAM;YAC1B,IACE,SAAS,UAAU,CAAC,UACpB,SAAS,UAAU,CAAC,YACpB,SAAS,UAAU,CAAC,YACpB,SAAS,UAAU,CAAC,UACpB;gBACA,OAAO;YACT;QACF;QAEA,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 2574, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/debounce.ts"],"sourcesContent":["interface DebounceOptions {\n  emitLast?: boolean;\n}\n\n/**\n * Debounces a function by waiting `delay` ms after the last call before executing it.\n * If `emitLast` is false, it cancels the call instead of delaying it.\n *\n * @returns A debounced function with additional `flush` and `cancel` methods.\n */\nexport const debounce = <T extends (...args: Parameters<T>) => void | Promise<void>>(\n  func: T,\n  delay: number,\n  options: DebounceOptions = { emitLast: true },\n): ((...args: Parameters<T>) => void) & { flush: () => void; cancel: () => void } => {\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  let lastArgs: Parameters<T> | null = null;\n\n  const debounced = (...args: Parameters<T>): void => {\n    lastArgs = args;\n    if (timeout) {\n      clearTimeout(timeout);\n    }\n\n    if (options.emitLast) {\n      timeout = setTimeout(() => {\n        if (lastArgs) {\n          func(...(lastArgs as Parameters<T>));\n          lastArgs = null;\n        }\n        timeout = null;\n      }, delay);\n    } else {\n      timeout = setTimeout(() => {\n        func(...args);\n        timeout = null;\n      }, delay);\n    }\n  };\n\n  /**\n   * Immediately executes the last pending debounced function call.\n   */\n  debounced.flush = () => {\n    if (timeout) {\n      clearTimeout(timeout);\n      timeout = null;\n      if (lastArgs) {\n        func(...(lastArgs as Parameters<T>));\n        lastArgs = null;\n      }\n    }\n  };\n\n  /**\n   * Cancels the pending debounced function call.\n   */\n  debounced.cancel = () => {\n    if (timeout) {\n      clearTimeout(timeout);\n      timeout = null;\n      lastArgs = null;\n    }\n  };\n\n  return debounced;\n};\n"],"names":[],"mappings":";;;;AAUO,MAAM,WAAW,CACtB,MACA,OACA,UAA2B;IAAE,UAAU;AAAK,CAAC;IAE7C,IAAI,UAAgD;IACpD,IAAI,WAAiC;IAErC,MAAM,YAAY,CAAC,GAAG;QACpB,WAAW;QACX,IAAI,SAAS;YACX,aAAa;QACf;QAEA,IAAI,QAAQ,QAAQ,EAAE;YACpB,UAAU,WAAW;gBACnB,IAAI,UAAU;oBACZ,QAAS;oBACT,WAAW;gBACb;gBACA,UAAU;YACZ,GAAG;QACL,OAAO;YACL,UAAU,WAAW;gBACnB,QAAQ;gBACR,UAAU;YACZ,GAAG;QACL;IACF;IAEA;;GAEC,GACD,UAAU,KAAK,GAAG;QAChB,IAAI,SAAS;YACX,aAAa;YACb,UAAU;YACV,IAAI,UAAU;gBACZ,QAAS;gBACT,WAAW;YACb;QACF;IACF;IAEA;;GAEC,GACD,UAAU,MAAM,GAAG;QACjB,IAAI,SAAS;YACX,aAAa;YACb,UAAU;YACV,WAAW;QACb;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 2633, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/window.ts"],"sourcesContent":["import { getCurrentWindow } from '@tauri-apps/api/window';\nimport { emitTo, TauriEvent } from '@tauri-apps/api/event';\nimport { exit } from '@tauri-apps/plugin-process';\nimport { type as osType } from '@tauri-apps/plugin-os';\nimport { eventDispatcher } from './event';\n\nexport const tauriGetWindowLogicalPosition = async () => {\n  const currentWindow = getCurrentWindow();\n  const factor = await currentWindow.scaleFactor();\n  const physicalPos = await currentWindow.outerPosition();\n  return { x: physicalPos.x / factor, y: physicalPos.y / factor };\n};\n\nexport const tauriHandleMinimize = async () => {\n  getCurrentWindow().minimize();\n};\n\n// workaround to reset transparent background when toggling fullscreen/maximize\nconst linuxWindowRestoreTransparentBg = async () => {\n  const currentSize = await getCurrentWindow().innerSize();\n  currentSize.width -= 1;\n  currentSize.height -= 1;\n  await getCurrentWindow().setSize(currentSize);\n  setTimeout(async () => {\n    const currentSize = await getCurrentWindow().innerSize();\n    currentSize.width += 1;\n    currentSize.height += 1;\n    await getCurrentWindow().setSize(currentSize);\n  }, 100);\n};\n\nexport const tauriHandleToggleMaximize = async () => {\n  const currentWindow = getCurrentWindow();\n  const isFullscreen = await currentWindow.isFullscreen();\n  if (isFullscreen) {\n    await currentWindow.setFullscreen(false);\n    await currentWindow.unmaximize();\n  } else {\n    await currentWindow.toggleMaximize();\n  }\n  if ((await osType()) === 'linux') {\n    linuxWindowRestoreTransparentBg();\n  }\n};\n\nexport const tauriHandleClose = async () => {\n  getCurrentWindow().close();\n};\n\nexport const tauriHandleOnCloseWindow = async (callback: () => void) => {\n  const currentWindow = getCurrentWindow();\n  return await currentWindow.onCloseRequested(async (event) => {\n    event.preventDefault();\n    await callback();\n    if (currentWindow.label.startsWith('reader')) {\n      await emitTo('main', 'close-reader-window', { label: currentWindow.label });\n      setTimeout(() => currentWindow.destroy(), 300);\n    } else if (currentWindow.label === 'main') {\n      await currentWindow.destroy();\n    }\n  });\n};\n\nexport const tauriHandleToggleFullScreen = async () => {\n  const currentWindow = getCurrentWindow();\n  const isFullscreen = await currentWindow.isFullscreen();\n  const isMaximized = await currentWindow.isMaximized();\n  if (isMaximized) {\n    await currentWindow.unmaximize();\n  } else {\n    await currentWindow.setFullscreen(!isFullscreen);\n  }\n  if ((await osType()) === 'linux') {\n    linuxWindowRestoreTransparentBg();\n  }\n};\n\nexport const tauriHandleSetAlwaysOnTop = async (isAlwaysOnTop: boolean) => {\n  const currentWindow = getCurrentWindow();\n  await currentWindow.setAlwaysOnTop(isAlwaysOnTop);\n};\n\nexport const tauriGetAlwaysOnTop = async () => {\n  const currentWindow = getCurrentWindow();\n  return await currentWindow.isAlwaysOnTop();\n};\n\nexport const tauriHandleOnWindowFocus = async (callback: () => void) => {\n  const currentWindow = getCurrentWindow();\n  return currentWindow.listen(TauriEvent.WINDOW_FOCUS, async () => {\n    await callback();\n  });\n};\n\nexport const tauriQuitApp = async () => {\n  await eventDispatcher.dispatch('quit-app');\n  await exit(0);\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,MAAM,gCAAgC;IAC3C,MAAM,gBAAgB,IAAA,mPAAgB;IACtC,MAAM,SAAS,MAAM,cAAc,WAAW;IAC9C,MAAM,cAAc,MAAM,cAAc,aAAa;IACrD,OAAO;QAAE,GAAG,YAAY,CAAC,GAAG;QAAQ,GAAG,YAAY,CAAC,GAAG;IAAO;AAChE;AAEO,MAAM,sBAAsB;IACjC,IAAA,mPAAgB,IAAG,QAAQ;AAC7B;AAEA,+EAA+E;AAC/E,MAAM,kCAAkC;IACtC,MAAM,cAAc,MAAM,IAAA,mPAAgB,IAAG,SAAS;IACtD,YAAY,KAAK,IAAI;IACrB,YAAY,MAAM,IAAI;IACtB,MAAM,IAAA,mPAAgB,IAAG,OAAO,CAAC;IACjC,WAAW;QACT,MAAM,cAAc,MAAM,IAAA,mPAAgB,IAAG,SAAS;QACtD,YAAY,KAAK,IAAI;QACrB,YAAY,MAAM,IAAI;QACtB,MAAM,IAAA,mPAAgB,IAAG,OAAO,CAAC;IACnC,GAAG;AACL;AAEO,MAAM,4BAA4B;IACvC,MAAM,gBAAgB,IAAA,mPAAgB;IACtC,MAAM,eAAe,MAAM,cAAc,YAAY;IACrD,IAAI,cAAc;QAChB,MAAM,cAAc,aAAa,CAAC;QAClC,MAAM,cAAc,UAAU;IAChC,OAAO;QACL,MAAM,cAAc,cAAc;IACpC;IACA,IAAI,AAAC,MAAM,IAAA,sPAAM,QAAQ,SAAS;QAChC;IACF;AACF;AAEO,MAAM,mBAAmB;IAC9B,IAAA,mPAAgB,IAAG,KAAK;AAC1B;AAEO,MAAM,2BAA2B,OAAO;IAC7C,MAAM,gBAAgB,IAAA,mPAAgB;IACtC,OAAO,MAAM,cAAc,gBAAgB,CAAC,OAAO;QACjD,MAAM,cAAc;QACpB,MAAM;QACN,IAAI,cAAc,KAAK,CAAC,UAAU,CAAC,WAAW;YAC5C,MAAM,IAAA,wNAAM,EAAC,QAAQ,uBAAuB;gBAAE,OAAO,cAAc,KAAK;YAAC;YACzE,WAAW,IAAM,cAAc,OAAO,IAAI;QAC5C,OAAO,IAAI,cAAc,KAAK,KAAK,QAAQ;YACzC,MAAM,cAAc,OAAO;QAC7B;IACF;AACF;AAEO,MAAM,8BAA8B;IACzC,MAAM,gBAAgB,IAAA,mPAAgB;IACtC,MAAM,eAAe,MAAM,cAAc,YAAY;IACrD,MAAM,cAAc,MAAM,cAAc,WAAW;IACnD,IAAI,aAAa;QACf,MAAM,cAAc,UAAU;IAChC,OAAO;QACL,MAAM,cAAc,aAAa,CAAC,CAAC;IACrC;IACA,IAAI,AAAC,MAAM,IAAA,sPAAM,QAAQ,SAAS;QAChC;IACF;AACF;AAEO,MAAM,4BAA4B,OAAO;IAC9C,MAAM,gBAAgB,IAAA,mPAAgB;IACtC,MAAM,cAAc,cAAc,CAAC;AACrC;AAEO,MAAM,sBAAsB;IACjC,MAAM,gBAAgB,IAAA,mPAAgB;IACtC,OAAO,MAAM,cAAc,aAAa;AAC1C;AAEO,MAAM,2BAA2B,OAAO;IAC7C,MAAM,gBAAgB,IAAA,mPAAgB;IACtC,OAAO,cAAc,MAAM,CAAC,4NAAU,CAAC,YAAY,EAAE;QACnD,MAAM;IACR;AACF;AAEO,MAAM,eAAe;IAC1B,MAAM,8JAAe,CAAC,QAAQ,CAAC;IAC/B,MAAM,IAAA,gQAAI,EAAC;AACb"}},
    {"offset": {"line": 2759, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/throttle.ts"],"sourcesContent":["interface ThrottleOptions {\n  emitLast?: boolean;\n}\n\nexport const throttle = <T extends (...args: Parameters<T>) => void | Promise<void>>(\n  func: T,\n  delay: number,\n  options: ThrottleOptions = { emitLast: true },\n): ((...args: Parameters<T>) => void) => {\n  let lastCall = 0;\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  let lastArgs: Parameters<T> | null = null;\n\n  return (...args: Parameters<T>): void => {\n    const now = Date.now();\n    const remaining = delay - (now - lastCall);\n\n    const callFunc = () => {\n      lastCall = Date.now();\n      timeout = null;\n      func(...args);\n    };\n\n    if (remaining <= 0) {\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = null;\n      }\n      callFunc();\n    } else {\n      lastArgs = args;\n      if (!timeout) {\n        timeout = setTimeout(() => {\n          timeout = null;\n          if (lastArgs && options.emitLast) {\n            func(...(lastArgs as Parameters<T>));\n            lastArgs = null;\n          }\n        }, remaining);\n      }\n    }\n  };\n};\n"],"names":[],"mappings":";;;;AAIO,MAAM,WAAW,CACtB,MACA,OACA,UAA2B;IAAE,UAAU;AAAK,CAAC;IAE7C,IAAI,WAAW;IACf,IAAI,UAAgD;IACpD,IAAI,WAAiC;IAErC,OAAO,CAAC,GAAG;QACT,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,YAAY,QAAQ,CAAC,MAAM,QAAQ;QAEzC,MAAM,WAAW;YACf,WAAW,KAAK,GAAG;YACnB,UAAU;YACV,QAAQ;QACV;QAEA,IAAI,aAAa,GAAG;YAClB,IAAI,SAAS;gBACX,aAAa;gBACb,UAAU;YACZ;YACA;QACF,OAAO;YACL,WAAW;YACX,IAAI,CAAC,SAAS;gBACZ,UAAU,WAAW;oBACnB,UAAU;oBACV,IAAI,YAAY,QAAQ,QAAQ,EAAE;wBAChC,QAAS;wBACT,WAAW;oBACb;gBACF,GAAG;YACL;QACF;IACF;AACF"}},
    {"offset": {"line": 2804, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/nav.ts"],"sourcesContent":["'use client';\n\nimport { useRouter, redirect } from 'next/navigation';\nimport { getCurrentWindow } from '@tauri-apps/api/window';\nimport { WebviewWindow } from '@tauri-apps/api/webviewWindow';\nimport { isPWA, isWebAppPlatform } from '@/services/environment';\nimport { BOOK_IDS_SEPARATOR } from '@/services/constants';\nimport { AppService } from '@/types/system';\n\nlet readerWindowsCount = 0;\nconst createReaderWindow = (appService: AppService, url: string) => {\n  const currentWindow = getCurrentWindow();\n  const label = currentWindow.label;\n  const newLabelPrefix = label === 'main' ? 'reader' : label;\n  const win = new WebviewWindow(`${newLabelPrefix}-${readerWindowsCount}`, {\n    url,\n    width: 800,\n    height: 600,\n    center: true,\n    resizable: true,\n    title: appService.isMacOSApp ? '' : 'Readest',\n    decorations: appService.isMacOSApp ? true : false,\n    transparent: appService.isMacOSApp ? false : true,\n    shadow: appService.isMacOSApp ? undefined : true,\n    titleBarStyle: appService.isMacOSApp ? 'overlay' : undefined,\n  });\n  win.once('tauri://created', () => {\n    console.log('new window created');\n    readerWindowsCount += 1;\n  });\n  win.once('tauri://error', (e) => {\n    console.error('error creating window', e);\n  });\n  win.once('tauri://destroyed', () => {\n    readerWindowsCount -= 1;\n  });\n};\n\nexport const showReaderWindow = (appService: AppService, bookIds: string[]) => {\n  const ids = bookIds.join(BOOK_IDS_SEPARATOR);\n  const params = new URLSearchParams('');\n  params.set('ids', ids);\n  const url = `/reader?${params.toString()}`;\n  createReaderWindow(appService, url);\n};\n\nexport const showLibraryWindow = (appService: AppService, filenames: string[]) => {\n  const params = new URLSearchParams();\n  filenames.forEach((filename) => params.append('file', filename));\n  const url = `/library?${params.toString()}`;\n  createReaderWindow(appService, url);\n};\n\nexport const navigateToReader = (\n  router: ReturnType<typeof useRouter>,\n  bookIds: string[],\n  queryParams?: string,\n  navOptions?: { scroll?: boolean },\n) => {\n  const ids = bookIds.join(BOOK_IDS_SEPARATOR);\n  if (isWebAppPlatform() && !isPWA()) {\n    router.push(`/reader/${ids}${queryParams ? `?${queryParams}` : ''}`, navOptions);\n  } else {\n    const params = new URLSearchParams(queryParams || '');\n    params.set('ids', ids);\n    router.push(`/reader?${params.toString()}`, navOptions);\n  }\n};\n\nexport const navigateToLogin = (router: ReturnType<typeof useRouter>) => {\n  const pathname = window.location.pathname;\n  const search = window.location.search;\n  const currentPath = pathname !== '/auth' ? pathname + search : '/';\n  router.push(`/auth?redirect=${encodeURIComponent(currentPath)}`);\n};\n\nexport const navigateToProfile = (router: ReturnType<typeof useRouter>) => {\n  router.push('/user');\n};\n\nexport const navigateToLibrary = (\n  router: ReturnType<typeof useRouter>,\n  queryParams?: string,\n  navOptions?: { scroll?: boolean },\n  navBack?: boolean,\n) => {\n  const lastLibraryParams =\n    typeof window !== 'undefined' ? sessionStorage.getItem('lastLibraryParams') : null;\n  if (navBack && lastLibraryParams) {\n    queryParams = lastLibraryParams;\n  }\n\n  router.replace(`/library${queryParams ? `?${queryParams}` : ''}`, navOptions);\n};\n\nexport const redirectToLibrary = () => {\n  redirect('/library');\n};\n\nexport const navigateToResetPassword = (router: ReturnType<typeof useRouter>) => {\n  const pathname = window.location.pathname;\n  const search = window.location.search;\n  const currentPath = pathname !== '/auth' ? pathname + search : '/';\n  router.push(`/auth/recovery?redirect=${encodeURIComponent(currentPath)}`);\n};\n\nexport const navigateToUpdatePassword = (router: ReturnType<typeof useRouter>) => {\n  const pathname = window.location.pathname;\n  const search = window.location.search;\n  const currentPath = pathname !== '/auth' ? pathname + search : '/';\n  router.push(`/auth/update?redirect=${encodeURIComponent(currentPath)}`);\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2924, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/image.ts"],"sourcesContent":["/**\n * Process book cover for Discord Rich Presence:\n * - Fit to 512x512 with transparent background\n * - Add Readest icon overlay at bottom right (10px padding)\n * - Return as JPEG blob\n */\nexport async function processDiscordCover(coverUrl: string, iconUrl: string): Promise<Blob> {\n  const SIZE = 512;\n  const ICON_WIDTH = 224;\n  const ICON_HEIGHT = 182;\n  const PADDING = 10;\n\n  try {\n    const coverResponse = await fetch(coverUrl);\n    const coverBlob = await coverResponse.blob();\n    const coverImg = new Image();\n    coverImg.crossOrigin = 'anonymous';\n\n    const iconResponse = await fetch(iconUrl);\n    const iconBlob = await iconResponse.blob();\n    const iconImg = new Image();\n    iconImg.crossOrigin = 'anonymous';\n\n    return new Promise((resolve, reject) => {\n      let coverLoaded = false;\n      let iconLoaded = false;\n\n      const checkBothLoaded = () => {\n        if (!coverLoaded || !iconLoaded) return;\n\n        try {\n          const canvas = document.createElement('canvas');\n          const ctx = canvas.getContext('2d');\n\n          if (!ctx) {\n            reject(new Error('Failed to get canvas context'));\n            return;\n          }\n\n          canvas.width = SIZE;\n          canvas.height = SIZE;\n\n          // Calculate cover dimensions to fit in 512x512\n          const aspectRatio = coverImg.width / coverImg.height;\n          let drawWidth, drawHeight, offsetX, offsetY;\n\n          if (aspectRatio > 1) {\n            // Wider than tall\n            drawWidth = SIZE;\n            drawHeight = SIZE / aspectRatio;\n            offsetX = 0;\n            offsetY = (SIZE - drawHeight) / 2;\n          } else {\n            // Taller than wide\n            drawHeight = SIZE;\n            drawWidth = SIZE * aspectRatio;\n            offsetX = (SIZE - drawWidth) / 2;\n            offsetY = 0;\n          }\n\n          // Draw cover image centered\n          ctx.imageSmoothingEnabled = true;\n          ctx.imageSmoothingQuality = 'high';\n          ctx.drawImage(coverImg, offsetX, offsetY, drawWidth, drawHeight);\n\n          // Draw icon at bottom right\n          ctx.drawImage(\n            iconImg,\n            SIZE - ICON_WIDTH - PADDING,\n            SIZE - ICON_HEIGHT - PADDING,\n            ICON_WIDTH,\n            ICON_HEIGHT,\n          );\n\n          // Convert to JPEG blob\n          canvas.toBlob(\n            (blob) => {\n              if (blob) {\n                resolve(blob);\n              } else {\n                reject(new Error('Failed to create blob'));\n              }\n            },\n            'image/jpeg',\n            0.9,\n          );\n        } catch (error) {\n          reject(new Error(`Failed to process cover: ${error}`));\n        }\n      };\n\n      coverImg.onload = () => {\n        coverLoaded = true;\n        checkBothLoaded();\n      };\n\n      iconImg.onload = () => {\n        iconLoaded = true;\n        checkBothLoaded();\n      };\n\n      coverImg.onerror = () => reject(new Error('Failed to load cover image'));\n      iconImg.onerror = () => reject(new Error('Failed to load icon image'));\n\n      const coverObjectUrl = URL.createObjectURL(coverBlob);\n      const iconObjectUrl = URL.createObjectURL(iconBlob);\n\n      coverImg.src = coverObjectUrl;\n      iconImg.src = iconObjectUrl;\n\n      coverImg.onload = function () {\n        URL.revokeObjectURL(coverObjectUrl);\n        coverLoaded = true;\n        checkBothLoaded();\n      };\n\n      iconImg.onload = function () {\n        URL.revokeObjectURL(iconObjectUrl);\n        iconLoaded = true;\n        checkBothLoaded();\n      };\n    });\n  } catch (error) {\n    console.error('Error processing Discord cover:', error);\n    throw error;\n  }\n}\n\nexport async function fetchImageAsBase64(\n  url: string,\n  options: {\n    targetWidth?: number;\n    format?: 'image/jpeg' | 'image/png' | 'image/webp';\n    quality?: number;\n  } = {},\n): Promise<string> {\n  const { targetWidth = 256, format = 'image/jpeg', quality = 0.85 } = options;\n\n  try {\n    const response = await fetch(url);\n    if (!response.ok) {\n      throw new Error(`Failed to fetch image: ${response.status} ${response.statusText}`);\n    }\n    const blob = await response.blob();\n\n    const img = new Image();\n    img.crossOrigin = 'anonymous';\n\n    return new Promise((resolve, reject) => {\n      img.onload = () => {\n        try {\n          const aspectRatio = img.height / img.width;\n          const newWidth = targetWidth;\n          const newHeight = Math.round(newWidth * aspectRatio);\n\n          const canvas = document.createElement('canvas');\n          const ctx = canvas.getContext('2d');\n\n          if (!ctx) {\n            reject(new Error('Failed to get canvas context'));\n            return;\n          }\n\n          canvas.width = newWidth;\n          canvas.height = newHeight;\n\n          ctx.imageSmoothingEnabled = true;\n          ctx.imageSmoothingQuality = 'high';\n\n          ctx.drawImage(img, 0, 0, newWidth, newHeight);\n\n          const base64 = canvas.toDataURL(format, quality);\n          resolve(base64);\n        } catch (error) {\n          reject(new Error(`Failed to scale image: ${error}`));\n        }\n      };\n\n      img.onerror = () => reject(new Error('Failed to load image for scaling'));\n\n      const objectUrl = URL.createObjectURL(blob);\n      img.src = objectUrl;\n\n      const cleanup = () => URL.revokeObjectURL(objectUrl);\n      const originalOnload = img.onload;\n      const originalOnerror = img.onerror;\n\n      img.onload = function (ev) {\n        cleanup();\n        if (originalOnload) originalOnload.call(this, ev);\n      };\n\n      img.onerror = function (ev) {\n        cleanup();\n        if (originalOnerror) originalOnerror.call(this, ev);\n      };\n    });\n  } catch (error) {\n    console.error('Error fetching and encoding image:', error);\n    throw error;\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3087, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/discord.ts"],"sourcesContent":["import { invoke } from '@tauri-apps/api/core';\nimport { Book } from '@/types/book';\nimport { AppService } from '@/types/system';\nimport { getCoverFilename } from './book';\nimport { processDiscordCover } from './image';\n\ntype CacheEntry = {\n  url: string | null;\n  timestamp: number;\n};\n\nconst coverUrlCache = new Map<string, CacheEntry>();\nconst CACHE_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds\n\ntype BookPresence = {\n  bookHash: string;\n  title: string;\n  author: string | null;\n  coverUrl: string | null;\n  sessionStart: number;\n};\n\n/**\n * Get an HTTPS cover URL suitable for Discord Rich Presence\n * - Caches successful uploads for session\n * - Caches failures (undefined) for 1 hour to avoid retries\n * - Processes cover with Readest icon overlay\n */\nconst getCoverUrlForDiscord = async (\n  book: Book,\n  appService: AppService,\n): Promise<string | undefined> => {\n  const cached = coverUrlCache.get(book.hash);\n  if (cached) {\n    const isExpired = Date.now() - cached.timestamp > CACHE_DURATION;\n    if (!isExpired) {\n      return cached.url ?? undefined;\n    }\n    if (!cached.url) {\n      coverUrlCache.delete(book.hash);\n    }\n  }\n\n  try {\n    const fp = getCoverFilename(book);\n\n    const exists = await appService.exists(fp, 'Books');\n    if (!exists) {\n      coverUrlCache.set(book.hash, { url: null, timestamp: Date.now() });\n      return undefined;\n    }\n\n    // Process cover for Discord without cloud upload\n    const fullPath = await appService.resolveFilePath(fp, 'Books');\n    const coverUrl = await appService.getImageURL(fullPath);\n    const iconUrl = '/icon-tiny.png';\n\n    const processedBlob = await processDiscordCover(coverUrl, iconUrl);\n    console.log('Processed Discord cover for book:', book.title);\n\n    // Note: Discord Rich Presence doesn't support local file URLs\n    // This would require an external URL accessible by Discord's servers\n    coverUrlCache.set(book.hash, { url: null, timestamp: Date.now() });\n    return undefined;\n  } catch (error) {\n    console.warn('Failed to process cover for Discord:', error);\n    coverUrlCache.set(book.hash, { url: null, timestamp: Date.now() });\n    return undefined;\n  }\n};\n\n/**\n * Update Discord Rich Presence with current book information\n */\nexport const updateDiscordPresence = async (\n  book: Book,\n  sessionStart: number,\n  appService: AppService,\n): Promise<void> => {\n  if (!appService?.isDesktopApp) return;\n\n  try {\n    const coverUrl = await getCoverUrlForDiscord(book, appService);\n    const bookPresence: BookPresence = {\n      bookHash: book.hash,\n      title: book.title,\n      author: book.author || null,\n      coverUrl: coverUrl || null,\n      sessionStart,\n    };\n\n    await invoke('update_book_presence', { presence: bookPresence });\n  } catch (error) {\n    console.warn('Failed to update Discord presence:', error);\n  }\n};\n\n/**\n * Clear Discord Rich Presence\n */\nexport const clearDiscordPresence = async (appService: AppService): Promise<void> => {\n  if (!appService?.isDesktopApp) return;\n\n  try {\n    await invoke('clear_book_presence');\n  } catch (error) {\n    console.warn('Failed to clear Discord presence:', error);\n  }\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAGA;AACA;;;;AAOA,MAAM,gBAAgB,IAAI;AAC1B,MAAM,iBAAiB,KAAK,KAAK,MAAM,yBAAyB;AAUhE;;;;;CAKC,GACD,MAAM,wBAAwB,OAC5B,MACA;IAEA,MAAM,SAAS,cAAc,GAAG,CAAC,KAAK,IAAI;IAC1C,IAAI,QAAQ;QACV,MAAM,YAAY,KAAK,GAAG,KAAK,OAAO,SAAS,GAAG;QAClD,IAAI,CAAC,WAAW;YACd,OAAO,OAAO,GAAG,IAAI;QACvB;QACA,IAAI,CAAC,OAAO,GAAG,EAAE;YACf,cAAc,MAAM,CAAC,KAAK,IAAI;QAChC;IACF;IAEA,IAAI;QACF,MAAM,KAAK,IAAA,8JAAgB,EAAC;QAE5B,MAAM,SAAS,MAAM,WAAW,MAAM,CAAC,IAAI;QAC3C,IAAI,CAAC,QAAQ;YACX,cAAc,GAAG,CAAC,KAAK,IAAI,EAAE;gBAAE,KAAK;gBAAM,WAAW,KAAK,GAAG;YAAG;YAChE,OAAO;QACT;QAEA,iDAAiD;QACjD,MAAM,WAAW,MAAM,WAAW,eAAe,CAAC,IAAI;QACtD,MAAM,WAAW,MAAM,WAAW,WAAW,CAAC;QAC9C,MAAM,UAAU;QAEhB,MAAM,gBAAgB,MAAM,IAAA,kKAAmB,EAAC,UAAU;QAC1D,QAAQ,GAAG,CAAC,qCAAqC,KAAK,KAAK;QAE3D,8DAA8D;QAC9D,qEAAqE;QACrE,cAAc,GAAG,CAAC,KAAK,IAAI,EAAE;YAAE,KAAK;YAAM,WAAW,KAAK,GAAG;QAAG;QAChE,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,IAAI,CAAC,wCAAwC;QACrD,cAAc,GAAG,CAAC,KAAK,IAAI,EAAE;YAAE,KAAK;YAAM,WAAW,KAAK,GAAG;QAAG;QAChE,OAAO;IACT;AACF;AAKO,MAAM,wBAAwB,OACnC,MACA,cACA;IAEA,IAAI,CAAC,YAAY,cAAc;IAE/B,IAAI;QACF,MAAM,WAAW,MAAM,sBAAsB,MAAM;QACnD,MAAM,eAA6B;YACjC,UAAU,KAAK,IAAI;YACnB,OAAO,KAAK,KAAK;YACjB,QAAQ,KAAK,MAAM,IAAI;YACvB,UAAU,YAAY;YACtB;QACF;QAEA,MAAM,IAAA,uNAAM,EAAC,wBAAwB;YAAE,UAAU;QAAa;IAChE,EAAE,OAAO,OAAO;QACd,QAAQ,IAAI,CAAC,sCAAsC;IACrD;AACF;AAKO,MAAM,uBAAuB,OAAO;IACzC,IAAI,CAAC,YAAY,cAAc;IAE/B,IAAI;QACF,MAAM,IAAA,uNAAM,EAAC;IACf,EAAE,OAAO,OAAO;QACd,QAAQ,IAAI,CAAC,qCAAqC;IACpD;AACF"}},
    {"offset": {"line": 3182, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/validation.ts"],"sourcesContent":["/**\n * Validation utilities for metadata fields\n */\n\n// ISO 639-1 language codes (2-letter codes)\n// prettier-ignore\nconst ISO_639_1_CODES = new Set([\n  'aa', 'ab', 'ae', 'af', 'ak', 'am', 'an', 'ar', 'as', 'av', 'ay', 'az',\n  'ba', 'be', 'bg', 'bh', 'bi', 'bm', 'bn', 'bo', 'br', 'bs',\n  'ca', 'ce', 'ch', 'co', 'cr', 'cs', 'cu', 'cv', 'cy',\n  'da', 'de', 'dv', 'dz',\n  'ee', 'el', 'en', 'eo', 'es', 'et', 'eu',\n  'fa', 'ff', 'fi', 'fj', 'fo', 'fr', 'fy',\n  'ga', 'gd', 'gl', 'gn', 'gu', 'gv',\n  'ha', 'he', 'hi', 'ho', 'hr', 'ht', 'hu', 'hy', 'hz',\n  'ia', 'id', 'ie', 'ig', 'ii', 'ik', 'io', 'is', 'it', 'iu',\n  'ja', 'jv',\n  'ka', 'kg', 'ki', 'kj', 'kk', 'kl', 'km', 'kn', 'ko', 'kr', 'ks', 'ku', 'kv', 'kw', 'ky',\n  'la', 'lb', 'lg', 'li', 'ln', 'lo', 'lt', 'lu', 'lv',\n  'mg', 'mh', 'mi', 'mk', 'ml', 'mn', 'mr', 'ms', 'mt', 'my',\n  'na', 'nb', 'nd', 'ne', 'ng', 'nl', 'nn', 'no', 'nr', 'nv', 'ny',\n  'oc', 'oj', 'om', 'or', 'os',\n  'pa', 'pi', 'pl', 'ps', 'pt',\n  'qu',\n  'rm', 'rn', 'ro', 'ru', 'rw',\n  'sa', 'sc', 'sd', 'se', 'sg', 'si', 'sk', 'sl', 'sm', 'sn', 'so', 'sq', 'sr', 'ss', 'st', 'su', 'sv', 'sw',\n  'ta', 'te', 'tg', 'th', 'ti', 'tk', 'tl', 'tn', 'to', 'tr', 'ts', 'tt', 'tw', 'ty',\n  'ug', 'uk', 'ur', 'uz',\n  've', 'vi', 'vo',\n  'wa', 'wo',\n  'xh',\n  'yi', 'yo',\n  'za', 'zh', 'zu'\n]);\n\nexport interface ValidationResult<T> {\n  isValid: boolean;\n  value: T | null;\n  error?: string;\n}\n\n/**\n * Validates and normalizes date input\n * Accepts YYYY, YYYY-MM, or YYYY-MM-DD formats\n * Returns ISO string if valid, null if invalid\n */\nexport const validateAndNormalizeDate = (dateInput: string): ValidationResult<string> => {\n  if (!dateInput) {\n    return { isValid: true, value: '' };\n  }\n\n  const cleaned = dateInput.trim();\n  // Pattern for YYYY, YYYY-MM, or YYYY-MM-DD\n  const datePatterns = [\n    { pattern: /^\\d{4}$/, format: 'YYYY' },\n    { pattern: /^\\d{4}-\\d{2}$/, format: 'YYYY-MM' },\n    { pattern: /^\\d{4}-\\d{2}-\\d{2}$/, format: 'YYYY-MM-DD' },\n  ];\n\n  const matchingPattern = datePatterns.find(({ pattern }) => pattern.test(cleaned));\n  if (!matchingPattern) {\n    return {\n      isValid: false,\n      value: null,\n      error: 'Invalid date format. Use YYYY, YYYY-MM, or YYYY-MM-DD',\n    };\n  }\n\n  try {\n    let date: Date;\n\n    if (cleaned.length === 4) {\n      // YYYY format - set to January 1st\n      date = new Date(`${cleaned}-01-01`);\n    } else if (cleaned.length === 7) {\n      // YYYY-MM format - set to 1st day of month\n      date = new Date(`${cleaned}-01`);\n    } else {\n      // YYYY-MM-DD format\n      date = new Date(cleaned);\n    }\n\n    // Check if date is valid\n    if (isNaN(date.getTime())) {\n      return {\n        isValid: false,\n        value: null,\n        error: 'Invalid date',\n      };\n    }\n\n    // Check if year is reasonable (between 1000 and current year + 10)\n    const year = date.getFullYear();\n    const currentYear = new Date().getFullYear();\n    if (year < 1000 || year > currentYear + 10) {\n      return {\n        isValid: false,\n        value: null,\n        error: `Year must be between 1000 and ${currentYear + 10}`,\n      };\n    }\n\n    // Validate month and day if provided\n    if (cleaned.length >= 7) {\n      const month = parseInt(cleaned.substring(5, 7));\n      if (month < 1 || month > 12) {\n        return {\n          isValid: false,\n          value: null,\n          error: 'Month must be between 01 and 12',\n        };\n      }\n    }\n\n    if (cleaned.length === 10) {\n      const day = parseInt(cleaned.substring(8, 10));\n      if (day < 1 || day > 31) {\n        return {\n          isValid: false,\n          value: null,\n          error: 'Day must be between 01 and 31',\n        };\n      }\n    }\n\n    return {\n      isValid: true,\n      value: date.toISOString(),\n    };\n  } catch {\n    return {\n      isValid: false,\n      value: null,\n      error: 'Failed to parse date',\n    };\n  }\n};\n\n/**\n * Validates and normalizes language code input\n * Accepts ISO 639-1 codes with optional country codes (e.g., en, en-US, zh-CN)\n * Returns normalized language code if valid, null if invalid\n */\nexport const validateAndNormalizeLanguage = (languageInput: string): ValidationResult<string> => {\n  if (!languageInput) {\n    return { isValid: true, value: 'unknown' };\n  }\n\n  const cleaned = languageInput.trim().toLowerCase();\n  // Pattern for language codes with optional country codes (e.g., en-US, zh-CN)\n  const languagePattern = /^[a-z]{2}(-[a-z]{2,4})?$/i;\n  if (!languagePattern.test(cleaned)) {\n    return {\n      isValid: false,\n      value: null,\n      error: 'Invalid language format. Use ISO 639-1 codes (e.g., en, zh-CN)',\n    };\n  }\n\n  const languageCode = cleaned.substring(0, 2);\n  if (!ISO_639_1_CODES.has(languageCode)) {\n    return {\n      isValid: false,\n      value: null,\n      error: `Invalid language code: ${languageCode}. Must be a valid ISO 639-1 code`,\n    };\n  }\n\n  return {\n    isValid: true,\n    value: cleaned,\n  };\n};\n\nexport const validateISBN = (isbn: string): ValidationResult<string> => {\n  if (!isbn) {\n    return { isValid: true, value: '' };\n  }\n\n  const cleaned = isbn.replace(/[-\\s]/g, '');\n  if (cleaned.length !== 10 && cleaned.length !== 13) {\n    return {\n      isValid: false,\n      value: null,\n      error: 'ISBN must be 10 or 13 digits',\n    };\n  }\n\n  // Validate ISBN-10\n  if (cleaned.length === 10) {\n    const isValid = validateISBN10(cleaned);\n    return {\n      isValid,\n      value: isValid ? cleaned : null,\n      error: isValid ? undefined : 'Invalid ISBN-10 checksum',\n    };\n  }\n\n  // Validate ISBN-13\n  if (cleaned.length === 13) {\n    const isValid = validateISBN13(cleaned);\n    return {\n      isValid,\n      value: isValid ? cleaned : null,\n      error: isValid ? undefined : 'Invalid ISBN-13 checksum',\n    };\n  }\n\n  return { isValid: false, value: null, error: 'Invalid ISBN format' };\n};\n\nconst validateISBN10 = (isbn: string): boolean => {\n  let sum = 0;\n  for (let i = 0; i < 9; i++) {\n    const digit = parseInt(isbn[i]!);\n    if (isNaN(digit)) return false;\n    sum += digit * (10 - i);\n  }\n\n  const lastChar = isbn[9]!;\n  const checkDigit = lastChar === 'X' ? 10 : parseInt(lastChar);\n  if (isNaN(checkDigit)) return false;\n\n  sum += checkDigit;\n  return sum % 11 === 0;\n};\n\nconst validateISBN13 = (isbn: string): boolean => {\n  let sum = 0;\n  for (let i = 0; i < 12; i++) {\n    const digit = parseInt(isbn[i]!);\n    if (isNaN(digit)) return false;\n    sum += digit * (i % 2 === 0 ? 1 : 3);\n  }\n\n  const checkDigit = parseInt(isbn[12]!);\n  if (isNaN(checkDigit)) return false;\n\n  const calculatedCheck = (10 - (sum % 10)) % 10;\n  return checkDigit === calculatedCheck;\n};\n\n/**\n * Validates subjects/genres input\n * Accepts comma-separated values and returns cleaned array\n */\nexport const validateAndNormalizeSubjects = (subjectsInput: string): ValidationResult<string[]> => {\n  if (!subjectsInput) {\n    return { isValid: true, value: [] };\n  }\n\n  const subjects = subjectsInput.split(',').map((s) => s.trim());\n\n  const maxSubjects = 20;\n  const maxSubjectLength = 100;\n\n  if (subjects.length > maxSubjects) {\n    return {\n      isValid: false,\n      value: null,\n      error: `Too many subjects (max ${maxSubjects})`,\n    };\n  }\n\n  const tooLongSubject = subjects.find((s) => s.length > maxSubjectLength);\n  if (tooLongSubject) {\n    return {\n      isValid: false,\n      value: null,\n      error: `Subject too long (max ${maxSubjectLength} characters): ${tooLongSubject}`,\n    };\n  }\n\n  return {\n    isValid: true,\n    value: subjects,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3607, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/fetch.ts"],"sourcesContent":["import { getAccessToken } from './access';\n\nexport const fetchWithTimeout = (url: string, options: RequestInit = {}, timeout = 10000) => {\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort('Request timed out'), timeout);\n\n  return fetch(url, {\n    ...options,\n    signal: controller.signal,\n  }).finally(() => clearTimeout(id));\n};\n\nexport const fetchWithAuth = async (url: string, options: RequestInit) => {\n  const token = await getAccessToken();\n  if (!token) {\n    throw new Error('Not authenticated');\n  }\n  const headers = {\n    ...options.headers,\n    Authorization: `Bearer ${token}`,\n  };\n\n  const response = await fetch(url, { ...options, headers });\n\n  if (!response.ok) {\n    const errorData = await response.json();\n    console.error('Error:', errorData.error || response.statusText);\n    throw new Error(errorData.error || 'Request failed');\n  }\n\n  return response;\n};\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,mBAAmB,CAAC,KAAa,UAAuB,CAAC,CAAC,EAAE,UAAU,KAAK;IACtF,MAAM,aAAa,IAAI;IACvB,MAAM,KAAK,WAAW,IAAM,WAAW,KAAK,CAAC,sBAAsB;IAEnE,OAAO,MAAM,KAAK;QAChB,GAAG,OAAO;QACV,QAAQ,WAAW,MAAM;IAC3B,GAAG,OAAO,CAAC,IAAM,aAAa;AAChC;AAEO,MAAM,gBAAgB,OAAO,KAAa;IAC/C,MAAM,QAAQ,MAAM,IAAA,8JAAc;IAClC,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM;IAClB;IACA,MAAM,UAAU;QACd,GAAG,QAAQ,OAAO;QAClB,eAAe,CAAC,OAAO,EAAE,OAAO;IAClC;IAEA,MAAM,WAAW,MAAM,MAAM,KAAK;QAAE,GAAG,OAAO;QAAE;IAAQ;IAExD,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,YAAY,MAAM,SAAS,IAAI;QACrC,QAAQ,KAAK,CAAC,UAAU,UAAU,KAAK,IAAI,SAAS,UAAU;QAC9D,MAAM,IAAI,MAAM,UAAU,KAAK,IAAI;IACrC;IAEA,OAAO;AACT"}},
    {"offset": {"line": 3650, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/walk.ts"],"sourcesContent":["export const walkTextNodes = (root: HTMLElement, rejectTags: string[] = []): HTMLElement[] => {\n  const elements: HTMLElement[] = [];\n  const walk = (node: HTMLElement | Document | ShadowRoot, depth = 0) => {\n    if (depth > 15) return;\n    if (node instanceof HTMLElement && node.shadowRoot) {\n      walk(node.shadowRoot, depth + 1);\n    }\n    const children = 'children' in node ? (Array.from(node.children) as HTMLElement[]) : [];\n    for (const child of children) {\n      if (\n        child.tagName === 'STYLE' ||\n        child.tagName === 'LINK' ||\n        rejectTags.includes(child.tagName.toLowerCase())\n      ) {\n        continue;\n      }\n      if (child.shadowRoot) {\n        walk(child.shadowRoot, depth + 1);\n      }\n      if (child.tagName === 'IFRAME') {\n        const iframe = child as HTMLIFrameElement;\n        const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;\n        if (iframeDoc && iframeDoc.body) {\n          walk(iframeDoc.body, depth + 1);\n        }\n      }\n      const hasDirectText =\n        child.childNodes &&\n        Array.from(child.childNodes).some((node) => {\n          if (node.nodeType === Node.TEXT_NODE && node.textContent?.trim()) {\n            return true;\n          }\n          if (\n            node.nodeType === Node.ELEMENT_NODE &&\n            (node as HTMLElement).tagName === 'SPAN' &&\n            node.textContent?.trim()\n          ) {\n            return true;\n          }\n          return false;\n        });\n      if (child.children.length === 0 && child.textContent?.trim()) {\n        elements.push(child);\n      } else if (hasDirectText) {\n        elements.push(child);\n      } else if (child.children.length > 0) {\n        walk(child, depth + 1);\n      }\n    }\n  };\n\n  walk(root);\n  return elements;\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,gBAAgB,CAAC,MAAmB,aAAuB,EAAE;IACxE,MAAM,WAA0B,EAAE;IAClC,MAAM,OAAO,CAAC,MAA2C,QAAQ,CAAC;QAChE,IAAI,QAAQ,IAAI;QAChB,IAAI,gBAAgB,eAAe,KAAK,UAAU,EAAE;YAClD,KAAK,KAAK,UAAU,EAAE,QAAQ;QAChC;QACA,MAAM,WAAW,cAAc,OAAQ,MAAM,IAAI,CAAC,KAAK,QAAQ,IAAsB,EAAE;QACvF,KAAK,MAAM,SAAS,SAAU;YAC5B,IACE,MAAM,OAAO,KAAK,WAClB,MAAM,OAAO,KAAK,UAClB,WAAW,QAAQ,CAAC,MAAM,OAAO,CAAC,WAAW,KAC7C;gBACA;YACF;YACA,IAAI,MAAM,UAAU,EAAE;gBACpB,KAAK,MAAM,UAAU,EAAE,QAAQ;YACjC;YACA,IAAI,MAAM,OAAO,KAAK,UAAU;gBAC9B,MAAM,SAAS;gBACf,MAAM,YAAY,OAAO,eAAe,IAAI,OAAO,aAAa,EAAE;gBAClE,IAAI,aAAa,UAAU,IAAI,EAAE;oBAC/B,KAAK,UAAU,IAAI,EAAE,QAAQ;gBAC/B;YACF;YACA,MAAM,gBACJ,MAAM,UAAU,IAChB,MAAM,IAAI,CAAC,MAAM,UAAU,EAAE,IAAI,CAAC,CAAC;gBACjC,IAAI,KAAK,QAAQ,KAAK,KAAK,SAAS,IAAI,KAAK,WAAW,EAAE,QAAQ;oBAChE,OAAO;gBACT;gBACA,IACE,KAAK,QAAQ,KAAK,KAAK,YAAY,IACnC,AAAC,KAAqB,OAAO,KAAK,UAClC,KAAK,WAAW,EAAE,QAClB;oBACA,OAAO;gBACT;gBACA,OAAO;YACT;YACF,IAAI,MAAM,QAAQ,CAAC,MAAM,KAAK,KAAK,MAAM,WAAW,EAAE,QAAQ;gBAC5D,SAAS,IAAI,CAAC;YAChB,OAAO,IAAI,eAAe;gBACxB,SAAS,IAAI,CAAC;YAChB,OAAO,IAAI,MAAM,QAAQ,CAAC,MAAM,GAAG,GAAG;gBACpC,KAAK,OAAO,QAAQ;YACtB;QACF;IACF;IAEA,KAAK;IACL,OAAO;AACT"}},
    {"offset": {"line": 3704, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/cfi.ts"],"sourcesContent":["import * as CFI from 'foliate-js/epubcfi.js';\n\nexport function isCfiInLocation(cfi: string, location: string | null | undefined): boolean {\n  if (!location) return false;\n\n  const start = CFI.collapse(location);\n  const end = CFI.collapse(location, true);\n\n  return CFI.compare(cfi, start) >= 0 && CFI.compare(cfi, end) <= 0;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,gBAAgB,GAAW,EAAE,QAAmC;IAC9E,IAAI,CAAC,UAAU,OAAO;IAEtB,MAAM,QAAQ,4IAAY,CAAC;IAC3B,MAAM,MAAM,4IAAY,CAAC,UAAU;IAEnC,OAAO,2IAAW,CAAC,KAAK,UAAU,KAAK,2IAAW,CAAC,KAAK,QAAQ;AAClE"}},
    {"offset": {"line": 3723, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/node.ts"],"sourcesContent":["export const createRejectFilter = ({\n  tags = [],\n  classes = [],\n  attributes = [],\n  contents = [],\n}: {\n  tags?: string[];\n  classes?: string[];\n  attributes?: string[];\n  contents?: { tag: string; content: RegExp }[];\n}) => {\n  return (node: Node): number => {\n    if (node.nodeType === Node.ELEMENT_NODE) {\n      const name = (node as Element).tagName.toLowerCase();\n      if (name === 'script' || name === 'style') {\n        return NodeFilter.FILTER_REJECT;\n      }\n      if (tags.includes(name)) {\n        return NodeFilter.FILTER_REJECT;\n      }\n      if (classes.some((cls) => (node as Element).classList.contains(cls))) {\n        return NodeFilter.FILTER_REJECT;\n      }\n      if (attributes.some((attr) => (node as Element).hasAttribute(attr))) {\n        return NodeFilter.FILTER_REJECT;\n      }\n      if (\n        contents.some(({ tag, content }) => {\n          return name === tag && content.test((node as Element).textContent || '');\n        })\n      ) {\n        return NodeFilter.FILTER_REJECT;\n      }\n      return NodeFilter.FILTER_SKIP;\n    }\n    return NodeFilter.FILTER_ACCEPT;\n  };\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,qBAAqB,CAAC,EACjC,OAAO,EAAE,EACT,UAAU,EAAE,EACZ,aAAa,EAAE,EACf,WAAW,EAAE,EAMd;IACC,OAAO,CAAC;QACN,IAAI,KAAK,QAAQ,KAAK,KAAK,YAAY,EAAE;YACvC,MAAM,OAAO,AAAC,KAAiB,OAAO,CAAC,WAAW;YAClD,IAAI,SAAS,YAAY,SAAS,SAAS;gBACzC,OAAO,WAAW,aAAa;YACjC;YACA,IAAI,KAAK,QAAQ,CAAC,OAAO;gBACvB,OAAO,WAAW,aAAa;YACjC;YACA,IAAI,QAAQ,IAAI,CAAC,CAAC,MAAQ,AAAC,KAAiB,SAAS,CAAC,QAAQ,CAAC,OAAO;gBACpE,OAAO,WAAW,aAAa;YACjC;YACA,IAAI,WAAW,IAAI,CAAC,CAAC,OAAS,AAAC,KAAiB,YAAY,CAAC,QAAQ;gBACnE,OAAO,WAAW,aAAa;YACjC;YACA,IACE,SAAS,IAAI,CAAC,CAAC,EAAE,GAAG,EAAE,OAAO,EAAE;gBAC7B,OAAO,SAAS,OAAO,QAAQ,IAAI,CAAC,AAAC,KAAiB,WAAW,IAAI;YACvE,IACA;gBACA,OAAO,WAAW,aAAa;YACjC;YACA,OAAO,WAAW,WAAW;QAC/B;QACA,OAAO,WAAW,aAAa;IACjC;AACF"}},
    {"offset": {"line": 3760, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/grid.ts"],"sourcesContent":["export const getGridTemplate = (count: number, aspectRatio: number) => {\n  if (count <= 1) {\n    return { columns: '1fr', rows: '1fr' };\n  } else if (count === 2) {\n    return aspectRatio < 1\n      ? { columns: '1fr', rows: '1fr 1fr' }\n      : { columns: '1fr 1fr', rows: '1fr' };\n  } else if (count === 3 || count === 4) {\n    return { columns: '1fr 1fr', rows: '1fr 1fr' };\n  } else {\n    return { columns: '1fr 1fr 1fr', rows: '1fr 1fr 1fr' };\n  }\n};\n\nexport const getInsetEdges = (index: number, count: number, aspectRatio: number) => {\n  const gridTemplate = getGridTemplate(count, aspectRatio);\n  const cols = gridTemplate.columns.split(' ').length;\n  const rows = gridTemplate.rows.split(' ').length;\n\n  const row = Math.floor(index / cols);\n  const col = index % cols;\n\n  return {\n    top: row === 0,\n    right: col === cols - 1,\n    bottom: row === rows - 1,\n    left: col === 0,\n  };\n};\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,kBAAkB,CAAC,OAAe;IAC7C,IAAI,SAAS,GAAG;QACd,OAAO;YAAE,SAAS;YAAO,MAAM;QAAM;IACvC,OAAO,IAAI,UAAU,GAAG;QACtB,OAAO,cAAc,IACjB;YAAE,SAAS;YAAO,MAAM;QAAU,IAClC;YAAE,SAAS;YAAW,MAAM;QAAM;IACxC,OAAO,IAAI,UAAU,KAAK,UAAU,GAAG;QACrC,OAAO;YAAE,SAAS;YAAW,MAAM;QAAU;IAC/C,OAAO;QACL,OAAO;YAAE,SAAS;YAAe,MAAM;QAAc;IACvD;AACF;AAEO,MAAM,gBAAgB,CAAC,OAAe,OAAe;IAC1D,MAAM,eAAe,gBAAgB,OAAO;IAC5C,MAAM,OAAO,aAAa,OAAO,CAAC,KAAK,CAAC,KAAK,MAAM;IACnD,MAAM,OAAO,aAAa,IAAI,CAAC,KAAK,CAAC,KAAK,MAAM;IAEhD,MAAM,MAAM,KAAK,KAAK,CAAC,QAAQ;IAC/B,MAAM,MAAM,QAAQ;IAEpB,OAAO;QACL,KAAK,QAAQ;QACb,OAAO,QAAQ,OAAO;QACtB,QAAQ,QAAQ,OAAO;QACvB,MAAM,QAAQ;IAChB;AACF"}},
    {"offset": {"line": 3812, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/insets.ts"],"sourcesContent":["import { Insets } from '@/types/misc';\nimport { ViewSettings } from '@/types/book';\n\nexport const getViewInsets = (viewSettings: ViewSettings) => {\n  const showHeader = viewSettings.showHeader!;\n  const showFooter = viewSettings.showFooter!;\n  const isVertical = viewSettings.vertical || viewSettings.writingMode.includes('vertical');\n  const fullMarginTopPx = viewSettings.marginPx || viewSettings.marginTopPx;\n  const compactMarginTopPx = viewSettings.compactMarginPx || viewSettings.compactMarginTopPx;\n  const fullMarginBottomPx = viewSettings.marginBottomPx;\n  const compactMarginBottomPx = viewSettings.compactMarginBottomPx;\n  const fullMarginLeftPx = viewSettings.marginLeftPx;\n  const fullMarginRightPx = viewSettings.marginRightPx;\n  const compactMarginLeftPx = viewSettings.compactMarginLeftPx;\n  const compactMarginRightPx = viewSettings.compactMarginRightPx;\n\n  return {\n    top: showHeader && !isVertical ? fullMarginTopPx : compactMarginTopPx,\n    right: showHeader && isVertical ? fullMarginRightPx : compactMarginRightPx,\n    bottom: showFooter && !isVertical ? fullMarginBottomPx : compactMarginBottomPx,\n    left: showFooter && isVertical ? fullMarginLeftPx : compactMarginLeftPx,\n  } as Insets;\n};\n"],"names":[],"mappings":";;;;AAGO,MAAM,gBAAgB,CAAC;IAC5B,MAAM,aAAa,aAAa,UAAU;IAC1C,MAAM,aAAa,aAAa,UAAU;IAC1C,MAAM,aAAa,aAAa,QAAQ,IAAI,aAAa,WAAW,CAAC,QAAQ,CAAC;IAC9E,MAAM,kBAAkB,aAAa,QAAQ,IAAI,aAAa,WAAW;IACzE,MAAM,qBAAqB,aAAa,eAAe,IAAI,aAAa,kBAAkB;IAC1F,MAAM,qBAAqB,aAAa,cAAc;IACtD,MAAM,wBAAwB,aAAa,qBAAqB;IAChE,MAAM,mBAAmB,aAAa,YAAY;IAClD,MAAM,oBAAoB,aAAa,aAAa;IACpD,MAAM,sBAAsB,aAAa,mBAAmB;IAC5D,MAAM,uBAAuB,aAAa,oBAAoB;IAE9D,OAAO;QACL,KAAK,cAAc,CAAC,aAAa,kBAAkB;QACnD,OAAO,cAAc,aAAa,oBAAoB;QACtD,QAAQ,cAAc,CAAC,aAAa,qBAAqB;QACzD,MAAM,cAAc,aAAa,mBAAmB;IACtD;AACF"}},
    {"offset": {"line": 3842, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/sanitize.ts"],"sourcesContent":["export const sanitizeString = (str?: string) => {\n  if (!str) return str;\n  return str.replace(/\\u0000/g, '');\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,iBAAiB,CAAC;IAC7B,IAAI,CAAC,KAAK,OAAO;IACjB,OAAO,IAAI,OAAO,CAAC,WAAW;AAChC"}},
    {"offset": {"line": 3857, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/transform.ts"],"sourcesContent":["import {\n  Book,\n  BookConfig,\n  BookFormat,\n  BookNote,\n  BookNoteType,\n  HighlightColor,\n  HighlightStyle,\n} from '@/types/book';\nimport { DBBookConfig, DBBook, DBBookNote } from '@/types/records';\nimport { sanitizeString } from './sanitize';\n\nexport const transformBookConfigToDB = (bookConfig: unknown, userId: string): DBBookConfig => {\n  const {\n    bookHash,\n    metaHash,\n    progress,\n    location,\n    xpointer,\n    searchConfig,\n    viewSettings,\n    updatedAt,\n  } = bookConfig as BookConfig;\n\n  return {\n    user_id: userId,\n    book_hash: bookHash!,\n    meta_hash: metaHash,\n    location: location,\n    xpointer: xpointer,\n    progress: progress && JSON.stringify(progress),\n    search_config: searchConfig && JSON.stringify(searchConfig),\n    view_settings: viewSettings && JSON.stringify(viewSettings),\n    updated_at: new Date(updatedAt ?? Date.now()).toISOString(),\n  };\n};\n\nexport const transformBookConfigFromDB = (dbBookConfig: DBBookConfig): BookConfig => {\n  const {\n    book_hash,\n    meta_hash,\n    progress,\n    location,\n    xpointer,\n    search_config,\n    view_settings,\n    updated_at,\n  } = dbBookConfig;\n  return {\n    bookHash: book_hash,\n    metaHash: meta_hash,\n    location,\n    xpointer,\n    progress: progress && JSON.parse(progress),\n    searchConfig: search_config && JSON.parse(search_config),\n    viewSettings: view_settings && JSON.parse(view_settings),\n    updatedAt: new Date(updated_at!).getTime(),\n  } as BookConfig;\n};\n\nexport const transformBookToDB = (book: unknown, userId: string): DBBook => {\n  const {\n    hash,\n    metaHash,\n    format,\n    title,\n    sourceTitle,\n    author,\n    groupId,\n    groupName,\n    tags,\n    progress,\n    metadata,\n    createdAt,\n    updatedAt,\n    deletedAt,\n    uploadedAt,\n  } = book as Book;\n\n  return {\n    user_id: userId,\n    book_hash: hash,\n    meta_hash: metaHash,\n    format,\n    title: sanitizeString(title)!,\n    author: sanitizeString(author)!,\n    group_id: groupId,\n    group_name: sanitizeString(groupName),\n    tags: tags,\n    progress: progress,\n    source_title: sanitizeString(sourceTitle),\n    metadata: metadata ? sanitizeString(JSON.stringify(metadata)) : null,\n    created_at: new Date(createdAt ?? Date.now()).toISOString(),\n    updated_at: new Date(updatedAt ?? Date.now()).toISOString(),\n    deleted_at: deletedAt ? new Date(deletedAt).toISOString() : null,\n    uploaded_at: uploadedAt ? new Date(uploadedAt).toISOString() : null,\n  };\n};\n\nexport const transformBookFromDB = (dbBook: DBBook): Book => {\n  const {\n    book_hash,\n    meta_hash,\n    format,\n    title,\n    author,\n    group_id,\n    group_name,\n    tags,\n    progress,\n    source_title,\n    metadata,\n    created_at,\n    updated_at,\n    deleted_at,\n    uploaded_at,\n  } = dbBook;\n\n  return {\n    hash: book_hash,\n    metaHash: meta_hash,\n    format: format as BookFormat,\n    title,\n    author,\n    groupId: group_id,\n    groupName: group_name,\n    tags: tags,\n    progress: progress,\n    sourceTitle: source_title,\n    metadata: metadata ? JSON.parse(metadata) : null,\n    createdAt: new Date(created_at!).getTime(),\n    updatedAt: new Date(updated_at!).getTime(),\n    deletedAt: deleted_at ? new Date(deleted_at).getTime() : null,\n    uploadedAt: uploaded_at ? new Date(uploaded_at).getTime() : null,\n  };\n};\n\nexport const transformBookNoteToDB = (bookNote: unknown, userId: string): DBBookNote => {\n  const {\n    bookHash,\n    metaHash,\n    id,\n    type,\n    cfi,\n    text,\n    style,\n    color,\n    note,\n    createdAt,\n    updatedAt,\n    deletedAt,\n  } = bookNote as BookNote;\n\n  return {\n    user_id: userId,\n    book_hash: bookHash!,\n    meta_hash: metaHash,\n    id,\n    type,\n    cfi,\n    text: sanitizeString(text),\n    style,\n    color,\n    note,\n    created_at: new Date(createdAt ?? Date.now()).toISOString(),\n    updated_at: new Date(updatedAt ?? Date.now()).toISOString(),\n    // note that only null deleted_at is updated to the database, undefined is not\n    deleted_at: deletedAt ? new Date(deletedAt).toISOString() : null,\n  };\n};\n\nexport const transformBookNoteFromDB = (dbBookNote: DBBookNote): BookNote => {\n  const {\n    book_hash,\n    meta_hash,\n    id,\n    type,\n    cfi,\n    text,\n    style,\n    color,\n    note,\n    created_at,\n    updated_at,\n    deleted_at,\n  } = dbBookNote;\n\n  return {\n    bookHash: book_hash,\n    metaHash: meta_hash,\n    id,\n    type: type as BookNoteType,\n    cfi,\n    text,\n    style: style as HighlightStyle,\n    color: color as HighlightColor,\n    note,\n    createdAt: new Date(created_at!).getTime(),\n    updatedAt: new Date(updated_at!).getTime(),\n    deletedAt: deleted_at ? new Date(deleted_at).getTime() : null,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3984, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/serializer.ts"],"sourcesContent":["import { BookConfig, BookSearchConfig, ViewSettings } from '@/types/book';\n\nexport const serializeConfig = (\n  config: BookConfig,\n  globalViewSettings: ViewSettings,\n  defaultSearchConfig: BookSearchConfig,\n): string => {\n  config = JSON.parse(JSON.stringify(config));\n  const viewSettings = config.viewSettings as Partial<ViewSettings>;\n  const searchConfig = config.searchConfig as Partial<BookSearchConfig>;\n  config.viewSettings = Object.entries(viewSettings).reduce(\n    (acc: Partial<Record<keyof ViewSettings, unknown>>, [key, value]) => {\n      if (globalViewSettings[key as keyof ViewSettings] !== value) {\n        acc[key as keyof ViewSettings] = value;\n      }\n      return acc;\n    },\n    {} as Partial<Record<keyof ViewSettings, unknown>>,\n  ) as Partial<ViewSettings>;\n  config.searchConfig = Object.entries(searchConfig).reduce(\n    (acc: Partial<Record<keyof BookSearchConfig, unknown>>, [key, value]) => {\n      if (defaultSearchConfig[key as keyof BookSearchConfig] !== value) {\n        acc[key as keyof BookSearchConfig] = value;\n      }\n      return acc;\n    },\n    {} as Partial<BookSearchConfig>,\n  ) as Partial<BookSearchConfig>;\n\n  return JSON.stringify(config);\n};\n\nexport const deserializeConfig = (\n  str: string,\n  globalViewSettings: ViewSettings,\n  defaultSearchConfig: BookSearchConfig,\n): BookConfig => {\n  const config = JSON.parse(str) as BookConfig;\n  const { viewSettings, searchConfig } = config;\n  config.viewSettings = { ...globalViewSettings, ...viewSettings };\n  config.searchConfig = { ...defaultSearchConfig, ...searchConfig };\n  config.updatedAt ??= Date.now();\n  return config;\n};\n\nexport const compressConfig = (\n  config: BookConfig,\n  globalViewSettings: ViewSettings,\n  defaultSearchConfig: BookSearchConfig,\n): string => {\n  return JSON.parse(serializeConfig(config, globalViewSettings, defaultSearchConfig));\n};\n"],"names":[],"mappings":";;;;;;;;AAEO,MAAM,kBAAkB,CAC7B,QACA,oBACA;IAEA,SAAS,KAAK,KAAK,CAAC,KAAK,SAAS,CAAC;IACnC,MAAM,eAAe,OAAO,YAAY;IACxC,MAAM,eAAe,OAAO,YAAY;IACxC,OAAO,YAAY,GAAG,OAAO,OAAO,CAAC,cAAc,MAAM,CACvD,CAAC,KAAmD,CAAC,KAAK,MAAM;QAC9D,IAAI,kBAAkB,CAAC,IAA0B,KAAK,OAAO;YAC3D,GAAG,CAAC,IAA0B,GAAG;QACnC;QACA,OAAO;IACT,GACA,CAAC;IAEH,OAAO,YAAY,GAAG,OAAO,OAAO,CAAC,cAAc,MAAM,CACvD,CAAC,KAAuD,CAAC,KAAK,MAAM;QAClE,IAAI,mBAAmB,CAAC,IAA8B,KAAK,OAAO;YAChE,GAAG,CAAC,IAA8B,GAAG;QACvC;QACA,OAAO;IACT,GACA,CAAC;IAGH,OAAO,KAAK,SAAS,CAAC;AACxB;AAEO,MAAM,oBAAoB,CAC/B,KACA,oBACA;IAEA,MAAM,SAAS,KAAK,KAAK,CAAC;IAC1B,MAAM,EAAE,YAAY,EAAE,YAAY,EAAE,GAAG;IACvC,OAAO,YAAY,GAAG;QAAE,GAAG,kBAAkB;QAAE,GAAG,YAAY;IAAC;IAC/D,OAAO,YAAY,GAAG;QAAE,GAAG,mBAAmB;QAAE,GAAG,YAAY;IAAC;IAChE,OAAO,SAAS,KAAK,KAAK,GAAG;IAC7B,OAAO;AACT;AAEO,MAAM,iBAAiB,CAC5B,QACA,oBACA;IAEA,OAAO,KAAK,KAAK,CAAC,gBAAgB,QAAQ,oBAAoB;AAChE"}},
    {"offset": {"line": 4034, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/xcfi.ts"],"sourcesContent":["/**\n * Converter between EPUB CFI and CREngine XPointer\n * Converts between Readest (foliate-js) CFI format and KOReader CREngine XPointer format\n */\n\nimport { BookDoc } from '@/libs/document';\nimport { parse, fake, collapse, fromRange, toRange, toElement } from 'foliate-js/epubcfi.js';\n\ntype XPointer = {\n  xpointer: string;\n  pos0?: string;\n  pos1?: string;\n};\n\nexport class XCFI {\n  private document: Document;\n  private spineItemIndex: number;\n\n  constructor(htmlDocument: Document, spineIndex: number = 0) {\n    this.document = htmlDocument;\n    this.spineItemIndex = spineIndex;\n  }\n\n  static extractSpineIndex(cfiOrXPath: string): number {\n    try {\n      if (cfiOrXPath.startsWith('epubcfi(')) {\n        const collapsed = collapse(parse(cfiOrXPath));\n        const spineStep = collapsed[0]?.[1]?.index;\n        if (spineStep === undefined) {\n          throw new Error('Cannot extract spine index from CFI');\n        }\n\n        // Convert CFI spine step to 0-based index\n        // CFI uses even numbers starting from 2: 2, 4, 6, 8, ...\n        // Convert to 0-based: (step - 2) / 2 = 0, 1, 2, 3, ...\n        return Math.floor((spineStep - 2) / 2);\n      } else if (cfiOrXPath.startsWith('/body/DocFragment[')) {\n        // Note that all indices in XPointer/XPath are 1-based\n        // but the text() offsets are 0-based\n        const match = cfiOrXPath.match(/DocFragment\\[(\\d+)\\]/);\n        if (match) {\n          return parseInt(match[1]!, 10) - 1;\n        }\n        throw new Error('Cannot extract spine index from XPath');\n      } else {\n        throw new Error('Unsupported format for spine index extraction');\n      }\n    } catch (error) {\n      throw new Error(`Cannot extract spine index from CFI/XPointer: ${cfiOrXPath} - ${error}`);\n    }\n  }\n\n  xPointerToCFI(startXPointer: string, endXPointer?: string): string {\n    try {\n      if (endXPointer) {\n        return this.convertRangeXPointerToCFI(startXPointer, endXPointer);\n      }\n\n      return this.convertPointXPointerToCFI(startXPointer);\n    } catch (error) {\n      throw new Error(`Failed to convert XPointer ${startXPointer}: ${error}`);\n    }\n  }\n\n  cfiToXPointer(cfi: string): XPointer {\n    try {\n      const parts = parse(cfi);\n      if (parts.parent) {\n        const index = fake.toIndex(parts.parent.shift()); // Remove the spine step\n        if (index !== this.spineItemIndex) {\n          throw new Error(\n            `CFI spine index ${index} does not match converter spine index ${this.spineItemIndex}`,\n          );\n        }\n        const range = toRange(this.document, parts);\n        const startXPointer = this.rangePointToXPointer(range.startContainer, range.startOffset);\n        const endXPointer = this.rangePointToXPointer(range.endContainer, range.endOffset);\n\n        return {\n          xpointer: startXPointer,\n          pos0: startXPointer,\n          pos1: endXPointer,\n        };\n      }\n\n      const collapsed = collapse(parts);\n      const index = fake.toIndex(parts.shift());\n      if (index !== this.spineItemIndex) {\n        throw new Error(\n          `CFI spine index ${index} does not match converter spine index ${this.spineItemIndex}`,\n        );\n      }\n      const element = toElement(this.document, parts[0]) as Element;\n      if (!element) {\n        throw new Error(`Element not found for CFI: ${cfi}`);\n      }\n      const lastPart =\n        collapsed[collapsed.length - 1]?.[collapsed[collapsed.length - 1].length - 1];\n      const textOffset = lastPart?.offset;\n\n      const xpointer =\n        textOffset !== undefined\n          ? this.handleTextOffset(element, textOffset)\n          : this.buildXPointerPath(element);\n\n      return { xpointer };\n    } catch (error) {\n      throw new Error(`Failed to convert CFI ${cfi}: ${error}`);\n    }\n  }\n\n  validateCFI(cfi: string): boolean {\n    try {\n      parse(cfi);\n      this.cfiToXPointer(cfi);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  validateXPointer(xpointer: string, pos1?: string): boolean {\n    try {\n      this.xPointerToCFI(xpointer, pos1);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Convert a single point XPointer to CFI\n   */\n  private convertPointXPointerToCFI(xpointer: string): string {\n    const { element, textOffset } = this.parseXPointer(xpointer);\n\n    const range = this.document.createRange();\n    if (textOffset !== undefined) {\n      const textNode = this.findTextNodeAtOffset(element, textOffset);\n      if (textNode) {\n        range.setStart(textNode.node, textNode.offset);\n        range.setEnd(textNode.node, textNode.offset);\n      } else {\n        // Fallback to element positioning\n        range.setStart(element, 0);\n        range.setEnd(element, 0);\n      }\n    } else {\n      range.setStart(element, 0);\n      range.setEnd(element, 0);\n    }\n\n    const cfi = fromRange(range);\n    return this.adjustSpineIndex(cfi);\n  }\n\n  private convertRangeXPointerToCFI(startXPointer: string, endXPointer: string): string {\n    const startInfo = this.parseXPointer(startXPointer);\n    const endInfo = this.parseXPointer(endXPointer);\n\n    const range = this.document.createRange();\n    if (startInfo.textOffset !== undefined) {\n      const startTextNode = this.findTextNodeAtOffset(startInfo.element, startInfo.textOffset);\n      if (startTextNode) {\n        range.setStart(startTextNode.node, startTextNode.offset);\n      } else {\n        range.setStart(startInfo.element, 0);\n      }\n    } else {\n      range.setStart(startInfo.element, 0);\n    }\n\n    if (endInfo.textOffset !== undefined) {\n      const endTextNode = this.findTextNodeAtOffset(endInfo.element, endInfo.textOffset);\n      if (endTextNode) {\n        range.setEnd(endTextNode.node, endTextNode.offset);\n      } else {\n        range.setEnd(endInfo.element, 0);\n      }\n    } else {\n      range.setEnd(endInfo.element, 0);\n    }\n\n    const cfi = fromRange(range);\n    return this.adjustSpineIndex(cfi);\n  }\n\n  /**\n   * Parse XPointer string to extract element and text offset\n   */\n  private parseXPointer(xpointer: string): { element: Element; textOffset?: number } {\n    const textOffsetMatch = xpointer.match(/\\/text\\(\\)\\.(\\d+)$/);\n    const textOffset = textOffsetMatch ? parseInt(textOffsetMatch[1]!, 10) : undefined;\n\n    const elementPath =\n      textOffset !== undefined ? xpointer.replace(/\\/text\\(\\)\\.\\d+$/, '') : xpointer;\n\n    const element = this.resolveXPointerPath(elementPath);\n    if (!element) {\n      throw new Error(`Cannot resolve XPointer path: ${elementPath}`);\n    }\n\n    return { element, textOffset };\n  }\n\n  private resolveXPointerPath(path: string): Element | null {\n    const pathMatch = path.match(/^\\/body\\/DocFragment\\[\\d+\\]\\/body(.*)$/);\n    if (!pathMatch) {\n      throw new Error(`Invalid XPointer format: ${path}`);\n    }\n\n    const elementPath = pathMatch[1]!;\n    let current: Element = this.document.body;\n\n    if (!elementPath || elementPath === '') {\n      return current;\n    }\n\n    const segments = elementPath.split('/').filter(Boolean);\n    for (const segment of segments) {\n      // Match both formats: tag[index] or just tag\n      const segmentWithIndexMatch = segment.match(/^(\\w+)\\[(\\d+)\\]$/);\n      const segmentWithoutIndexMatch = segment.match(/^(\\w+)$/);\n\n      let tagName: string;\n      let index: number;\n\n      if (segmentWithIndexMatch) {\n        // Format: tag[index] (1-based index)\n        const [, tag, indexStr] = segmentWithIndexMatch;\n        tagName = tag!;\n        index = Math.max(0, parseInt(indexStr!, 10) - 1);\n      } else if (segmentWithoutIndexMatch) {\n        // Format: tag (implicit index 0)\n        const [, tag] = segmentWithoutIndexMatch;\n        tagName = tag!;\n        index = 0;\n      } else {\n        throw new Error(`Invalid XPointer segment: ${segment}`);\n      }\n\n      // Find child elements with matching tag name\n      const children = Array.from(current.children).filter(\n        (child) => child.tagName.toLowerCase() === tagName?.toLowerCase(),\n      );\n\n      if (index >= children.length) {\n        throw new Error(`Element index ${index} out of bounds for tag ${tagName}`);\n      }\n\n      current = children[index]!;\n    }\n\n    return current;\n  }\n\n  /**\n   * Find text node and offset within element based on cumulative character offset\n   */\n  private findTextNodeAtOffset(\n    element: Element,\n    offset: number,\n  ): { node: Text; offset: number } | null {\n    const textNodes: Text[] = [];\n    this.collectTextNodes(element, textNodes);\n\n    let currentOffset = 0;\n\n    for (const textNode of textNodes) {\n      const nodeText = textNode.textContent || '';\n      const nodeLength = nodeText.length;\n\n      if (currentOffset + nodeLength >= offset) {\n        return {\n          node: textNode,\n          offset: offset - currentOffset,\n        };\n      }\n\n      currentOffset += nodeLength;\n    }\n\n    // If offset is beyond all text, return the last text node at its end\n    if (textNodes.length > 0) {\n      const lastNode = textNodes[textNodes.length - 1]!;\n      return {\n        node: lastNode,\n        offset: (lastNode.textContent || '').length,\n      };\n    }\n\n    return null;\n  }\n\n  private adjustSpineIndex(cfi: string): string {\n    const cfiMatch = cfi.match(/^epubcfi\\((.+)\\)$/);\n    if (!cfiMatch) {\n      throw new Error(`Invalid CFI format: ${cfi}`);\n    }\n\n    const innerCfi = cfiMatch[1]!;\n    const spineStep = (this.spineItemIndex + 1) * 2; // Convert 0-based to CFI format\n\n    if (innerCfi.match(/^\\/6\\/\\d+!/)) {\n      const adjustedInner = innerCfi.replace(/^\\/6\\/\\d+!/, `/6/${spineStep}!`);\n      return `epubcfi(${adjustedInner})`;\n    } else {\n      const adjustedInner = `/6/${spineStep}!${innerCfi}`;\n      return `epubcfi(${adjustedInner})`;\n    }\n  }\n\n  /**\n   * Convert a range point (container + offset) to XPointer\n   */\n  private rangePointToXPointer(container: Node, offset: number): string {\n    if (container.nodeType === Node.TEXT_NODE) {\n      // For text nodes, find the containing element\n      const element = container.parentElement || this.document.documentElement;\n      return this.handleTextOffsetInElement(element, container as Text, offset);\n    } else if (container.nodeType === Node.ELEMENT_NODE) {\n      const element = container as Element;\n      if (offset === 0) {\n        if (element.childNodes.length > 0) {\n          const firstChild = element.childNodes[0] as Element;\n          if (firstChild.nodeType === Node.ELEMENT_NODE) {\n            return this.buildXPointerPath(element.childNodes[0] as Element);\n          }\n        }\n        return this.buildXPointerPath(element);\n      } else {\n        // Offset points to a child node\n        const childNodes = Array.from(element.childNodes);\n        const targetChild = childNodes[offset - 1] || childNodes[childNodes.length - 1];\n\n        if (targetChild?.nodeType === Node.ELEMENT_NODE) {\n          return this.buildXPointerPath(targetChild as Element);\n        } else if (targetChild?.nodeType === Node.TEXT_NODE) {\n          return this.handleTextOffsetInElement(\n            element,\n            targetChild as Text,\n            (targetChild as Text).textContent?.length || 0,\n          );\n        } else {\n          return this.buildXPointerPath(element);\n        }\n      }\n    } else {\n      // Fallback to document element\n      return this.buildXPointerPath(this.document.documentElement);\n    }\n  }\n\n  /**\n   * Build XPointer path from DOM element\n   */\n  private buildXPointerPath(targetElement: Element): string {\n    const pathParts: string[] = [];\n    let current: Element | null = targetElement;\n\n    // Build path from target back to root\n    while (current && current !== this.document.documentElement) {\n      const parent: Element | null = current.parentElement;\n      if (!parent) break;\n\n      const tagName = current.tagName.toLowerCase();\n      // Count preceding siblings with same tag name (0-based for CREngine)\n      let siblingIndex = 0;\n      let totalSameTagSiblings = 0;\n      for (const sibling of Array.from(parent.children)) {\n        if (sibling.tagName.toLowerCase() === tagName) {\n          if (sibling === current) {\n            siblingIndex = totalSameTagSiblings;\n          }\n          totalSameTagSiblings++;\n        }\n      }\n\n      // Format as tag[index] (0-based for CREngine)\n      // Omit [0] if there's only one element with this tag name\n      if (totalSameTagSiblings === 1) {\n        pathParts.unshift(tagName);\n      } else {\n        pathParts.unshift(`${tagName}[${siblingIndex + 1}]`); // Convert to 1-based index for XPointer\n      }\n      current = parent;\n    }\n\n    let xpointer = `/body/DocFragment[${this.spineItemIndex + 1}]`;\n    if (pathParts.length > 0 && pathParts[0]!.startsWith('body')) {\n      pathParts.shift();\n    }\n    xpointer += '/body';\n\n    if (pathParts.length > 0) {\n      xpointer += '/' + pathParts.join('/');\n    }\n\n    return xpointer;\n  }\n\n  /**\n   * Handle text offset within an element by finding character position\n   */\n  private handleTextOffset(element: Element, cfiOffset: number): string {\n    const textNodes: Text[] = [];\n    this.collectTextNodes(element, textNodes);\n\n    let totalChars = 0;\n    let targetTextNode: Text | null = null;\n    let offsetInNode = 0;\n\n    for (const textNode of textNodes) {\n      const nodeText = textNode.textContent || '';\n      const nodeLength = nodeText.length;\n\n      if (totalChars + nodeLength >= cfiOffset) {\n        targetTextNode = textNode;\n        offsetInNode = cfiOffset - totalChars;\n        break;\n      }\n\n      totalChars += nodeLength;\n    }\n\n    if (!targetTextNode) {\n      // Offset beyond text content, use element end\n      return this.buildXPointerPath(element);\n    }\n\n    // Find the containing element for this text node\n    let textParent = targetTextNode.parentElement;\n    while (textParent && !this.isSignificantElement(textParent)) {\n      textParent = textParent.parentElement;\n    }\n\n    if (!textParent) {\n      textParent = element as HTMLElement;\n    }\n\n    const basePath = this.buildXPointerPath(textParent);\n    return `${basePath}/text().${offsetInNode}`;\n  }\n\n  /**\n   * Handle text offset for a specific text node within an element\n   */\n  private handleTextOffsetInElement(element: Element, textNode: Text, offset: number): string {\n    // Find all text nodes in the element to calculate cumulative offset\n    const textNodes: Text[] = [];\n    this.collectTextNodes(element, textNodes);\n\n    let cumulativeOffset = 0;\n    for (const node of textNodes) {\n      if (node === textNode) {\n        cumulativeOffset += offset;\n        break;\n      }\n      cumulativeOffset += (node.textContent || '').length;\n    }\n\n    return this.handleTextOffset(element, cumulativeOffset);\n  }\n\n  /**\n   * Collect all text nodes in document order\n   */\n  private collectTextNodes(element: Element, textNodes: Text[]): void {\n    for (const child of Array.from(element.childNodes)) {\n      if (child.nodeType === Node.TEXT_NODE) {\n        const text = child.textContent || '';\n        if (text.length > 0) {\n          textNodes.push(child as Text);\n        }\n      } else if (child.nodeType === Node.ELEMENT_NODE) {\n        this.collectTextNodes(child as Element, textNodes);\n      }\n    }\n  }\n\n  /**\n   * Check if an element is significant for XPointer path building\n   */\n  private isSignificantElement(element: Element): boolean {\n    const tagName = element.tagName.toLowerCase();\n\n    // Skip inline formatting elements that don't affect structure\n    const inlineElements = new Set([\n      'span',\n      'em',\n      'strong',\n      'i',\n      'b',\n      'u',\n      'small',\n      'mark',\n      'sup',\n      'sub',\n    ]);\n\n    return !inlineElements.has(tagName);\n  }\n}\n\nexport const getCFIFromXPointer = async (\n  xpointer: string,\n  doc?: Document,\n  index?: number,\n  bookDoc?: BookDoc,\n) => {\n  const xSpineIndex = XCFI.extractSpineIndex(xpointer);\n  let converter: XCFI;\n  if (index === xSpineIndex && doc) {\n    converter = new XCFI(doc, index || 0);\n  } else {\n    const doc = await bookDoc?.sections?.[xSpineIndex]?.createDocument();\n    if (!doc) throw new Error('Failed to load document for XPointer conversion.');\n    converter = new XCFI(doc, xSpineIndex || 0);\n  }\n\n  const cfi = converter.xPointerToCFI(xpointer);\n  return cfi;\n};\n\nexport const getXPointerFromCFI = async (\n  cfi: string,\n  doc?: Document,\n  index?: number,\n  bookDoc?: BookDoc,\n): Promise<XPointer> => {\n  const xSpineIndex = XCFI.extractSpineIndex(cfi);\n  let converter: XCFI;\n  if (index === xSpineIndex && doc) {\n    converter = new XCFI(doc, index || 0);\n  } else {\n    const doc = await bookDoc?.sections?.[xSpineIndex]?.createDocument();\n    if (!doc) throw new Error('Failed to load document for CFI conversion.');\n    converter = new XCFI(doc, xSpineIndex || 0);\n  }\n\n  const xpointer = converter.cfiToXPointer(cfi);\n  return xpointer;\n};\n\n// Koreader sometimes cannot recognize totally valid XPointer.\n// Workaround this by cleaning up any trailing /text().N segments.\n// Also remove any trailing .N suffixes after node steps.\n// This has neglectable effect on position accuracy as the XPointer still point to the correct element\n// while offset within the text node is usually ignored by pagination.\nexport const normalizeProgressXPointer = (xpointer: string): string => {\n  const tailingTextOffset = /\\/text\\(\\).*$/;\n  if (xpointer.match(tailingTextOffset)) {\n    xpointer = xpointer.replace(tailingTextOffset, '');\n  }\n  const suffixNodeOffset = /\\.\\d+$/;\n  if (xpointer.match(suffixNodeOffset)) {\n    xpointer = xpointer.replace(suffixNodeOffset, '');\n  }\n  return xpointer;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4492, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/highlightjs.ts"],"sourcesContent":["import { ViewSettings } from '@/types/book';\nimport hljs from 'highlight.js/lib/common';\n\nexport const CODE_LANGUAGES = [\n  'auto-detect',\n  'bash',\n  'c',\n  'cpp',\n  'csharp',\n  'css',\n  'diff',\n  'go',\n  'graphql',\n  'ini',\n  'java',\n  'javascript',\n  'json',\n  'kotlin',\n  'less',\n  'lua',\n  'makefile',\n  'markdown',\n  'objectivec',\n  'perl',\n  'php',\n  'php-t',\n  'python',\n  'python-r',\n  'r',\n  'ruby',\n  'rust',\n  'scss',\n  'shell',\n  'sql',\n  'swift',\n  'typescript',\n  'vbnet',\n  'wasm',\n  'xml',\n  'yaml',\n] as const;\n\nexport type CodeLanguage = (typeof CODE_LANGUAGES)[number];\n\n/** Toggle on or off the highlightjs stylesheet from the DOM and add relevant language styles */\nexport const manageSyntaxHighlighting = (doc: Document, viewSettings: ViewSettings) => {\n  const styleId = 'highlight-js-theme-style'; // arbitrary css id\n  const { codeHighlighting, codeLanguage } = viewSettings;\n\n  const existingStyleElement = doc.getElementById(styleId);\n  if (existingStyleElement) {\n    existingStyleElement.remove();\n  }\n\n  if (!codeHighlighting) {\n    // If disabling, remove the stylesheet and applied classes\n    const styleElement = doc.getElementById(styleId);\n    if (styleElement) styleElement.remove();\n    doc.querySelectorAll('pre').forEach((block) => {\n      if ((block as HTMLElement).dataset['highlighted']) {\n        block.innerHTML = block.textContent || '';\n      }\n    });\n    return;\n  }\n\n  const style = doc.createElement('style');\n  style.id = styleId;\n  style.textContent = getHighlightJsStyles();\n  doc.head.appendChild(style);\n\n  // Find all <pre> elements in available content\n  const codeBlocks = doc.querySelectorAll('pre');\n\n  // https://github.com/highlightjs/highlight.js/wiki/security\n  // I believe this is valid in this use case to ignore this warning.\n  hljs.configure({ ignoreUnescapedHTML: true });\n\n  codeBlocks.forEach((block) => {\n    // remove any previously applied classes by hljs\n    block.innerHTML = block.textContent || '';\n    block.className = block.className.replace(/language-\\S+/g, '');\n    block.classList.remove('hljs');\n    block.removeAttribute('data-highlighted');\n    if (codeLanguage && codeLanguage !== 'auto-detect') {\n      block.classList.add(`language-${codeLanguage}`);\n    }\n    hljs.highlightElement(block as HTMLElement);\n  });\n};\n\n/** Return either github light or dark theme */\nconst getHighlightJsStyles = () => {\n  // Potential improvement: add more themes following this pattern.\n  const githubLightTheme = `\n  pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!\n  Theme: GitHub\n  Description: Light theme as seen on github.com\n  Author: github.com\n  Maintainer: @Hirse\n  Updated: 2021-05-15\n\n  Outdated base version: https://github.com/primer/github-syntax-light\n  Current colors taken from GitHub's CSS\n  */.hljs{color:#24292e;background:#fff}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#d73a49}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#6f42c1}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-variable{color:#005cc5}.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#032f62}.hljs-built_in,.hljs-symbol{color:#e36209}.hljs-code,.hljs-comment,.hljs-formula{color:#6a737d}.hljs-name,.hljs-quote,.hljs-selector-pseudo,.hljs-selector-tag{color:#22863a}.hljs-subst{color:#24292e}.hljs-section{color:#005cc5;font-weight:700}.hljs-bullet{color:#735c0f}.hljs-emphasis{color:#24292e;font-style:italic}.hljs-strong{color:#24292e;font-weight:700}.hljs-addition{color:#22863a;background-color:#f0fff4}.hljs-deletion{color:#b31d28;background-color:#ffeef0}\n  `;\n  const githubDarkTheme = `\n  @media (prefers-color-scheme: dark) {\n    pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!\n    Theme: GitHub Dark\n    Description: Dark theme as seen on github.com\n    Author: github.com\n    Maintainer: @Hirse\n    Updated: 2021-05-15\n    \n    Outdated base version: https://github.com/primer/github-syntax-dark\n    Current colors taken from GitHub's CSS\n    */.hljs{color:#c9d1d9;background:#0d1117}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#ff7b72}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#d2a8ff}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-variable{color:#79c0ff}.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#a5d6ff}.hljs-built_in,.hljs-symbol{color:#ffa657}.hljs-code,.hljs-comment,.hljs-formula{color:#8b949e}.hljs-name,.hljs-quote,.hljs-selector-pseudo,.hljs-selector-tag{color:#7ee787}.hljs-subst{color:#c9d1d9}.hljs-section{color:#1f6feb;font-weight:700}.hljs-bullet{color:#f2cc60}.hljs-emphasis{color:#c9d1d9;font-style:italic}.hljs-strong{color:#c9d1d9;font-weight:700}.hljs-addition{color:#aff5b4;background-color:#033a16}.hljs-deletion{color:#ffdcd7;background-color:#67060c}\n  }`;\n  const githubTheme = `${githubLightTheme}\\n${githubDarkTheme}`;\n  return githubTheme;\n};\n"],"names":[],"mappings":";;;;;;AACA;;AAEO,MAAM,iBAAiB;IAC5B;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAKM,MAAM,2BAA2B,CAAC,KAAe;IACtD,MAAM,UAAU,4BAA4B,mBAAmB;IAC/D,MAAM,EAAE,gBAAgB,EAAE,YAAY,EAAE,GAAG;IAE3C,MAAM,uBAAuB,IAAI,cAAc,CAAC;IAChD,IAAI,sBAAsB;QACxB,qBAAqB,MAAM;IAC7B;IAEA,IAAI,CAAC,kBAAkB;QACrB,0DAA0D;QAC1D,MAAM,eAAe,IAAI,cAAc,CAAC;QACxC,IAAI,cAAc,aAAa,MAAM;QACrC,IAAI,gBAAgB,CAAC,OAAO,OAAO,CAAC,CAAC;YACnC,IAAI,AAAC,MAAsB,OAAO,CAAC,cAAc,EAAE;gBACjD,MAAM,SAAS,GAAG,MAAM,WAAW,IAAI;YACzC;QACF;QACA;IACF;IAEA,MAAM,QAAQ,IAAI,aAAa,CAAC;IAChC,MAAM,EAAE,GAAG;IACX,MAAM,WAAW,GAAG;IACpB,IAAI,IAAI,CAAC,WAAW,CAAC;IAErB,+CAA+C;IAC/C,MAAM,aAAa,IAAI,gBAAgB,CAAC;IAExC,4DAA4D;IAC5D,mEAAmE;IACnE,oOAAI,CAAC,SAAS,CAAC;QAAE,qBAAqB;IAAK;IAE3C,WAAW,OAAO,CAAC,CAAC;QAClB,gDAAgD;QAChD,MAAM,SAAS,GAAG,MAAM,WAAW,IAAI;QACvC,MAAM,SAAS,GAAG,MAAM,SAAS,CAAC,OAAO,CAAC,iBAAiB;QAC3D,MAAM,SAAS,CAAC,MAAM,CAAC;QACvB,MAAM,eAAe,CAAC;QACtB,IAAI,gBAAgB,iBAAiB,eAAe;YAClD,MAAM,SAAS,CAAC,GAAG,CAAC,CAAC,SAAS,EAAE,cAAc;QAChD;QACA,oOAAI,CAAC,gBAAgB,CAAC;IACxB;AACF;AAEA,6CAA6C,GAC7C,MAAM,uBAAuB;IAC3B,iEAAiE;IACjE,MAAM,mBAAmB,CAAC;;;;;;;;;;;EAW1B,CAAC;IACD,MAAM,kBAAkB,CAAC;;;;;;;;;;;;GAYxB,CAAC;IACF,MAAM,cAAc,GAAG,iBAAiB,EAAE,EAAE,iBAAiB;IAC7D,OAAO;AACT"}},
    {"offset": {"line": 4616, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/a11y.ts"],"sourcesContent":["export const removeTabIndex = (document: Document) => {\n  document.querySelectorAll('a').forEach((a) => {\n    a.setAttribute('tabindex', '-1');\n  });\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,iBAAiB,CAAC;IAC7B,SAAS,gBAAgB,CAAC,KAAK,OAAO,CAAC,CAAC;QACtC,EAAE,YAAY,CAAC,YAAY;IAC7B;AACF"}},
    {"offset": {"line": 4632, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/number.ts"],"sourcesContent":["export const localizeNumber = (num: number, language: string, isIndex = false): string => {\n  const lang = language.toLowerCase();\n  const isChinese = lang.startsWith('zh');\n  if (!isChinese) {\n    return num.toString();\n  }\n\n  const isTraditional = lang.includes('tw') || lang.includes('hk');\n\n  const baseDigits = isTraditional ? '零壹貳叁肆伍陸柒捌玖' : '零一二三四五六七八九';\n  const zeroChar = isIndex ? '〇' : '零';\n  const digits = baseDigits.replace('零', zeroChar);\n  const units = isTraditional\n    ? ['', '拾', '佰', '仟', '萬', '億']\n    : ['', '十', '百', '千', '万', '亿'];\n\n  const str = String(num);\n  const len = str.length;\n  let result = '';\n  for (let i = 0; i < len; i++) {\n    const n = Number(str[i]);\n    const pos = len - i - 1;\n    if (n !== 0) {\n      result += digits[n]! + units[pos % 4]!;\n    } else if (!result.endsWith(zeroChar) && i < len - 1) {\n      result += zeroChar;\n    }\n    if (pos === 4) result += units[4];\n    if (pos === 8) result += units[5];\n  }\n  result = result\n    .replace(new RegExp(`${zeroChar}+$`), '')\n    .replace(`${zeroChar}萬`, '萬')\n    .replace(`${zeroChar}万`, '万')\n    .replace(new RegExp(`${zeroChar}+`, 'g'), zeroChar);\n\n  if (!isIndex) {\n    if (isTraditional) {\n      result = result\n        .replace(/^貳$/, '兩')\n        .replace(/(^|[^壹貳叁肆伍陸柒捌玖])貳([^佰仟萬億壹貳叁肆伍陸柒捌玖]|$)/g, '$1兩$2');\n    } else {\n      result = result\n        .replace(/^二$/, '两')\n        .replace(/(^|[^一二三四五六七八九])二([^百千万亿一二三四五六七八九]|$)/g, '$1两$2');\n    }\n  }\n\n  return result;\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,iBAAiB,CAAC,KAAa,UAAkB,UAAU,KAAK;IAC3E,MAAM,OAAO,SAAS,WAAW;IACjC,MAAM,YAAY,KAAK,UAAU,CAAC;IAClC,IAAI,CAAC,WAAW;QACd,OAAO,IAAI,QAAQ;IACrB;IAEA,MAAM,gBAAgB,KAAK,QAAQ,CAAC,SAAS,KAAK,QAAQ,CAAC;IAE3D,MAAM,aAAa,gBAAgB,eAAe;IAClD,MAAM,WAAW,UAAU,MAAM;IACjC,MAAM,SAAS,WAAW,OAAO,CAAC,KAAK;IACvC,MAAM,QAAQ,gBACV;QAAC;QAAI;QAAK;QAAK;QAAK;QAAK;KAAI,GAC7B;QAAC;QAAI;QAAK;QAAK;QAAK;QAAK;KAAI;IAEjC,MAAM,MAAM,OAAO;IACnB,MAAM,MAAM,IAAI,MAAM;IACtB,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,KAAK,IAAK;QAC5B,MAAM,IAAI,OAAO,GAAG,CAAC,EAAE;QACvB,MAAM,MAAM,MAAM,IAAI;QACtB,IAAI,MAAM,GAAG;YACX,UAAU,MAAM,CAAC,EAAE,GAAI,KAAK,CAAC,MAAM,EAAE;QACvC,OAAO,IAAI,CAAC,OAAO,QAAQ,CAAC,aAAa,IAAI,MAAM,GAAG;YACpD,UAAU;QACZ;QACA,IAAI,QAAQ,GAAG,UAAU,KAAK,CAAC,EAAE;QACjC,IAAI,QAAQ,GAAG,UAAU,KAAK,CAAC,EAAE;IACnC;IACA,SAAS,OACN,OAAO,CAAC,IAAI,OAAO,GAAG,SAAS,EAAE,CAAC,GAAG,IACrC,OAAO,CAAC,GAAG,SAAS,CAAC,CAAC,EAAE,KACxB,OAAO,CAAC,GAAG,SAAS,CAAC,CAAC,EAAE,KACxB,OAAO,CAAC,IAAI,OAAO,GAAG,SAAS,CAAC,CAAC,EAAE,MAAM;IAE5C,IAAI,CAAC,SAAS;QACZ,IAAI,eAAe;YACjB,SAAS,OACN,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,0CAA0C;QACvD,OAAO;YACL,SAAS,OACN,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,0CAA0C;QACvD;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 4692, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/progress.ts"],"sourcesContent":["import { localizeNumber } from './number';\n\nexport function formatProgress(\n  current: number | undefined,\n  total: number | undefined,\n  template: string,\n  localize: boolean = false,\n  language: string = 'en',\n  fractionDigits: number = 1,\n): string {\n  if (current !== undefined && total !== undefined && total > 0 && current >= 0) {\n    const currentStr = localize ? localizeNumber(current + 1, language, true) : String(current + 1);\n    const totalStr = localize ? localizeNumber(total, language, true) : String(total);\n    return template\n      .replace('{current}', currentStr)\n      .replace('{total}', totalStr)\n      .replace('{percent}', (((current + 1) / total) * 100).toFixed(fractionDigits));\n  } else {\n    return '';\n  }\n}\n\nexport function formatNumber(\n  number: number | undefined,\n  localize: boolean = false,\n  language: string = 'en',\n): string {\n  if (number === undefined || number < 0) {\n    return '';\n  }\n  return localize ? localizeNumber(number, language) : String(number);\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,SAAS,eACd,OAA2B,EAC3B,KAAyB,EACzB,QAAgB,EAChB,WAAoB,KAAK,EACzB,WAAmB,IAAI,EACvB,iBAAyB,CAAC;IAE1B,IAAI,YAAY,aAAa,UAAU,aAAa,QAAQ,KAAK,WAAW,GAAG;QAC7E,MAAM,aAAa,WAAW,IAAA,8JAAc,EAAC,UAAU,GAAG,UAAU,QAAQ,OAAO,UAAU;QAC7F,MAAM,WAAW,WAAW,IAAA,8JAAc,EAAC,OAAO,UAAU,QAAQ,OAAO;QAC3E,OAAO,SACJ,OAAO,CAAC,aAAa,YACrB,OAAO,CAAC,WAAW,UACnB,OAAO,CAAC,aAAa,CAAC,AAAC,CAAC,UAAU,CAAC,IAAI,QAAS,GAAG,EAAE,OAAO,CAAC;IAClE,OAAO;QACL,OAAO;IACT;AACF;AAEO,SAAS,aACd,MAA0B,EAC1B,WAAoB,KAAK,EACzB,WAAmB,IAAI;IAEvB,IAAI,WAAW,aAAa,SAAS,GAAG;QACtC,OAAO;IACT;IACA,OAAO,WAAW,IAAA,8JAAc,EAAC,QAAQ,YAAY,OAAO;AAC9D"}},
    {"offset": {"line": 4722, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/ssml.ts"],"sourcesContent":["import { TTSMark } from '@/services/tts/types';\nimport { code6392to6391, inferLangFromScript, isSameLang, isValidLang } from './lang';\n\nconst cleanTextContent = (text: string) =>\n  text.replace(/\\r\\n/g, '  ').replace(/\\r/g, ' ').replace(/\\n/g, ' ').trimStart();\n\nexport const genSSML = (lang: string, text: string, voice: string, rate: number) => {\n  const cleanedText = text.replace(/^<break\\b[^>]*>/i, '');\n  return `\n    <speak version=\"1.0\" xml:lang=\"${lang}\">\n      <voice name=\"${voice}\">\n        <prosody rate=\"${rate}\" >\n            ${cleanedText}\n        </prosody>\n      </voice>\n    </speak>\n  `;\n};\n\nexport const parseSSMLLang = (ssml: string, primaryLang?: string): string => {\n  let lang = 'en';\n  const match = ssml.match(/xml:lang\\s*=\\s*\"([^\"]+)\"/);\n  if (match && match[1]) {\n    const parts = match[1].split('-');\n    lang =\n      parts.length > 1\n        ? `${parts[0]!.toLowerCase()}-${parts[1]!.toUpperCase()}`\n        : parts[0]!.toLowerCase();\n\n    lang = code6392to6391(lang) || lang;\n    if (!isValidLang(lang)) {\n      lang = 'en';\n    }\n  }\n  primaryLang = code6392to6391(primaryLang?.toLowerCase() || '') || primaryLang;\n  if (lang === 'en' && primaryLang && !isSameLang(lang, primaryLang)) {\n    lang = primaryLang.split('-')[0]!.toLowerCase();\n  }\n  const textWithoutLangTags = ssml.replace(/<lang[^>]*>.*?<\\/lang>/gs, '');\n  return inferLangFromScript(textWithoutLangTags, lang);\n};\n\nexport const parseSSMLMarks = (ssml: string, primaryLang?: string) => {\n  const defaultLang = parseSSMLLang(ssml, primaryLang) || 'en';\n  ssml = ssml.replace(/<speak[^>]*>/i, '').replace(/<\\/speak>/i, '');\n\n  let plainText = '';\n  const marks: TTSMark[] = [];\n\n  let activeMark: string | null = null;\n  let currentLang = defaultLang;\n  const langStack: string[] = [];\n\n  const tagRegex = /<(\\/?)(\\w+)([^>]*)>|([^<]+)/g;\n\n  let match: RegExpExecArray | null;\n  while ((match = tagRegex.exec(ssml)) !== null) {\n    if (match[4]) {\n      const rawText = match[4];\n      const text = cleanTextContent(rawText);\n      if (text && activeMark) {\n        const offset = plainText.length;\n        plainText += text;\n        marks.push({\n          offset,\n          name: activeMark,\n          text,\n          language: inferLangFromScript(text, currentLang) || currentLang,\n        });\n      } else {\n        plainText += cleanTextContent(rawText);\n      }\n    } else {\n      const isEnd = match[1] === '/';\n      const tagName = match[2];\n      const attr = match[3];\n\n      if (tagName === 'mark' && !isEnd) {\n        const nameMatch = attr?.match(/name=\"([^\"]+)\"/);\n        if (nameMatch) {\n          activeMark = nameMatch[1]!;\n        }\n      } else if (tagName === 'lang') {\n        if (!isEnd) {\n          langStack.push(currentLang);\n          const langMatch = attr?.match(/xml:lang=\"([^\"]+)\"/);\n          if (langMatch) {\n            currentLang = langMatch[1]!;\n          }\n        } else {\n          currentLang = langStack.pop() ?? defaultLang;\n        }\n      }\n    }\n  }\n\n  return { plainText, marks };\n};\n\nexport const findSSMLMark = (charIndex: number, marks: TTSMark[]) => {\n  let left = 0;\n  let right = marks.length - 1;\n  let result: TTSMark | null = null;\n\n  while (left <= right) {\n    const mid = Math.floor((left + right) / 2);\n    const mark = marks[mid]!;\n\n    if (mark.offset <= charIndex) {\n      result = mark;\n      left = mid + 1;\n    } else {\n      right = mid - 1;\n    }\n  }\n\n  return result;\n};\n\nexport const filterSSMLWithLang = (\n  ssml: string,\n  targetLang: string,\n  primaryLang?: string,\n): string => {\n  const mainLang = parseSSMLLang(ssml, primaryLang);\n\n  // Normalize target language\n  const normalizedTarget = code6392to6391(targetLang.toLowerCase()) || targetLang.toLowerCase();\n\n  // Check if target matches main language\n  if (isSameLang(normalizedTarget, mainLang)) {\n    // Remove all <lang> blocks that don't match the main language\n    return ssml.replace(/<lang\\s+xml:lang=\"([^\"]+)\"[^>]*>.*?<\\/lang>/gs, (match, langAttr) => {\n      const blockLang = code6392to6391(langAttr.toLowerCase()) || langAttr.toLowerCase();\n      // If the lang block matches the main language, keep it as is\n      if (isSameLang(blockLang, mainLang)) {\n        return match;\n      }\n      // Otherwise remove the entire block\n      return '';\n    });\n  }\n\n  // Check if target matches any <lang> block\n  const langBlocks: Array<{ match: string; lang: string; content: string }> = [];\n  const langBlockRegex = /<lang\\s+xml:lang=\"([^\"]+)\"[^>]*>(.*?)<\\/lang>/gs;\n  let match: RegExpExecArray | null;\n\n  const tempRegex = new RegExp(langBlockRegex.source, langBlockRegex.flags);\n  while ((match = tempRegex.exec(ssml)) !== null) {\n    const blockLang = code6392to6391(match[1]!.toLowerCase()) || match[1]!.toLowerCase();\n    if (isSameLang(blockLang, normalizedTarget)) {\n      langBlocks.push({\n        match: match[0]!,\n        lang: match[1]!,\n        content: match[2]!,\n      });\n    }\n  }\n\n  if (langBlocks.length > 0) {\n    const speakOpenMatch = ssml.match(/<speak[^>]*>/i);\n    const speakCloseMatch = ssml.match(/<\\/speak>/i);\n\n    if (!speakOpenMatch || !speakCloseMatch) {\n      return ssml;\n    }\n\n    const combinedContent = langBlocks.map((block) => block.match).join('');\n    return `${speakOpenMatch[0]}${combinedContent}${speakCloseMatch[0]}`;\n  }\n\n  return ssml;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4886, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/lru.ts"],"sourcesContent":["export class LRUCache<K, V> {\n  private capacity: number;\n  private map: Map<K, V>;\n  private onEvict?: (key: K, value: V) => void;\n\n  constructor(capacity: number, onEvict?: (key: K, value: V) => void) {\n    if (capacity <= 0) {\n      throw new Error('LRUCache capacity must be greater than 0');\n    }\n    this.capacity = capacity;\n    this.map = new Map();\n    this.onEvict = onEvict;\n  }\n\n  get(key: K): V | undefined {\n    if (!this.map.has(key)) {\n      return undefined;\n    }\n    const value = this.map.get(key)!;\n    this.map.delete(key);\n    this.map.set(key, value);\n    return value;\n  }\n\n  set(key: K, value: V): void {\n    if (this.map.has(key)) {\n      const oldValue = this.map.get(key)!;\n      this.map.delete(key);\n      if (this.onEvict) {\n        this.onEvict(key, oldValue);\n      }\n    } else if (this.map.size === this.capacity) {\n      const oldestKey = this.map.keys().next().value;\n      if (oldestKey) {\n        const oldestValue = this.map.get(oldestKey)!;\n        this.map.delete(oldestKey);\n        if (this.onEvict) {\n          this.onEvict(oldestKey, oldestValue);\n        }\n      }\n    }\n    this.map.set(key, value);\n  }\n\n  has(key: K): boolean {\n    return this.map.has(key);\n  }\n\n  delete(key: K): boolean {\n    if (this.map.has(key)) {\n      const value = this.map.get(key)!;\n      const deleted = this.map.delete(key);\n      if (deleted && this.onEvict) {\n        this.onEvict(key, value);\n      }\n      return deleted;\n    }\n    return false;\n  }\n\n  clear(): void {\n    if (this.onEvict) {\n      for (const [key, value] of this.map) {\n        this.onEvict(key, value);\n      }\n    }\n    this.map.clear();\n  }\n\n  size(): number {\n    return this.map.size;\n  }\n\n  entries(): Array<[K, V]> {\n    return Array.from(this.map).reverse();\n  }\n}\n"],"names":[],"mappings":";;;;AAAO,MAAM;IACH,SAAiB;IACjB,IAAe;IACf,QAAqC;IAE7C,YAAY,QAAgB,EAAE,OAAoC,CAAE;QAClE,IAAI,YAAY,GAAG;YACjB,MAAM,IAAI,MAAM;QAClB;QACA,IAAI,CAAC,QAAQ,GAAG;QAChB,IAAI,CAAC,GAAG,GAAG,IAAI;QACf,IAAI,CAAC,OAAO,GAAG;IACjB;IAEA,IAAI,GAAM,EAAiB;QACzB,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM;YACtB,OAAO;QACT;QACA,MAAM,QAAQ,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;QAC3B,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC;QAChB,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK;QAClB,OAAO;IACT;IAEA,IAAI,GAAM,EAAE,KAAQ,EAAQ;QAC1B,IAAI,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM;YACrB,MAAM,WAAW,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;YAC9B,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC;YAChB,IAAI,IAAI,CAAC,OAAO,EAAE;gBAChB,IAAI,CAAC,OAAO,CAAC,KAAK;YACpB;QACF,OAAO,IAAI,IAAI,CAAC,GAAG,CAAC,IAAI,KAAK,IAAI,CAAC,QAAQ,EAAE;YAC1C,MAAM,YAAY,IAAI,CAAC,GAAG,CAAC,IAAI,GAAG,IAAI,GAAG,KAAK;YAC9C,IAAI,WAAW;gBACb,MAAM,cAAc,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;gBACjC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC;gBAChB,IAAI,IAAI,CAAC,OAAO,EAAE;oBAChB,IAAI,CAAC,OAAO,CAAC,WAAW;gBAC1B;YACF;QACF;QACA,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK;IACpB;IAEA,IAAI,GAAM,EAAW;QACnB,OAAO,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;IACtB;IAEA,OAAO,GAAM,EAAW;QACtB,IAAI,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM;YACrB,MAAM,QAAQ,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;YAC3B,MAAM,UAAU,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC;YAChC,IAAI,WAAW,IAAI,CAAC,OAAO,EAAE;gBAC3B,IAAI,CAAC,OAAO,CAAC,KAAK;YACpB;YACA,OAAO;QACT;QACA,OAAO;IACT;IAEA,QAAc;QACZ,IAAI,IAAI,CAAC,OAAO,EAAE;YAChB,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,IAAI,CAAC,GAAG,CAAE;gBACnC,IAAI,CAAC,OAAO,CAAC,KAAK;YACpB;QACF;QACA,IAAI,CAAC,GAAG,CAAC,KAAK;IAChB;IAEA,OAAe;QACb,OAAO,IAAI,CAAC,GAAG,CAAC,IAAI;IACtB;IAEA,UAAyB;QACvB,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,OAAO;IACrC;AACF"}},
    {"offset": {"line": 4966, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/sel.ts"],"sourcesContent":["export interface Frame {\n  top: number;\n  left: number;\n}\n\nexport interface Rect {\n  top: number;\n  right: number;\n  bottom: number;\n  left: number;\n}\n\nexport interface Point {\n  x: number;\n  y: number;\n}\n\nexport type PositionDir = 'up' | 'down' | 'left' | 'right';\n\nexport interface Position {\n  point: Point;\n  dir?: PositionDir;\n}\n\nexport interface TextSelection {\n  key: string;\n  text: string;\n  range: Range;\n  index: number;\n  cfi?: string;\n  href?: string;\n  annotated?: boolean;\n  rect?: Rect;\n}\n\nconst frameRect = (frame: Frame, rect?: Rect, sx = 1, sy = 1) => {\n  if (!rect) return { left: 0, right: 0, top: 0, bottom: 0 };\n  const left = sx * rect.left + frame.left;\n  const right = sx * rect.right + frame.left;\n  const top = sy * rect.top + frame.top;\n  const bottom = sy * rect.bottom + frame.top;\n  return { left, right, top, bottom };\n};\n\nconst pointIsInView = ({ x, y }: Point) =>\n  x > 0 && y > 0 && x < window.innerWidth && y < window.innerHeight;\n\nconst getIframeElement = (nodeElement: Range | Element): HTMLIFrameElement | null => {\n  let node: Node | null;\n  if (nodeElement && typeof nodeElement === 'object' && 'tagName' in nodeElement) {\n    node = nodeElement as Element;\n  } else if (nodeElement && typeof nodeElement === 'object' && 'collapse' in nodeElement) {\n    node = nodeElement.commonAncestorContainer;\n  } else {\n    node = nodeElement;\n  }\n  while (node) {\n    if (node.nodeType === Node.DOCUMENT_NODE) {\n      const doc = node as Document;\n      if (doc.defaultView && doc.defaultView.frameElement) {\n        return doc.defaultView.frameElement as HTMLIFrameElement;\n      }\n    }\n    node = node.parentNode;\n  }\n\n  return null;\n};\n\nconst constrainPointWithinRect = (point: Point, rect: Rect, padding: number) => {\n  return {\n    x: Math.max(padding, Math.min(point.x, rect.right - rect.left - padding)),\n    y: Math.max(padding, Math.min(point.y, rect.bottom - rect.top - padding)),\n  };\n};\n\nexport const isPointerInsideSelection = (selection: Selection, ev: PointerEvent) => {\n  if (selection.rangeCount === 0) return false;\n  const range = selection.getRangeAt(0);\n  const rects = range.getClientRects();\n  const padding = 80;\n  for (let i = 0; i < rects.length; i++) {\n    const rect = rects[i]!;\n    if (\n      ev.clientX >= rect.left - padding &&\n      ev.clientX <= rect.right + padding &&\n      ev.clientY >= rect.top - padding &&\n      ev.clientY <= rect.bottom + padding\n    ) {\n      return true;\n    }\n  }\n  return false;\n};\n\nexport const getPosition = (\n  targetElement: Range | Element | TextSelection,\n  rect: Rect,\n  paddingPx: number,\n  isVertical: boolean = false,\n) => {\n  const { range: target, rect: targetRect } =\n    targetElement && 'range' in targetElement\n      ? targetElement\n      : { range: targetElement, rect: undefined };\n  const frameElement = getIframeElement(target);\n  const transform = frameElement ? getComputedStyle(frameElement).transform : '';\n  const match = transform.match(/matrix\\((.+)\\)/);\n  const [sx, , , sy] = match?.[1]?.split(/\\s*,\\s*/)?.map((x) => parseFloat(x)) ?? [];\n\n  const frame = frameElement?.getBoundingClientRect() ?? { top: 0, left: 0 };\n  let padding = { top: 0, right: 0, bottom: 0, left: 0 };\n  if ('nodeType' in target && target.nodeType === 1) {\n    const computedStyle = window.getComputedStyle(target);\n    padding = {\n      top: parseInt(computedStyle.paddingTop, 10) || 0,\n      right: parseInt(computedStyle.paddingRight, 10) || 0,\n      bottom: parseInt(computedStyle.paddingBottom, 10) || 0,\n      left: parseInt(computedStyle.paddingLeft, 10) || 0,\n    };\n  }\n  const rects = Array.from(target.getClientRects()).map((rect) => {\n    return {\n      top: rect.top + padding.top,\n      right: rect.right - padding.right,\n      bottom: rect.bottom - padding.bottom,\n      left: rect.left + padding.left,\n    };\n  });\n  const first = targetRect\n    ? frameRect(frame, targetRect, sx, sy)\n    : frameRect(frame, rects[0], sx, sy);\n  const last = targetRect\n    ? frameRect(frame, targetRect, sx, sy)\n    : frameRect(frame, rects.at(-1), sx, sy);\n\n  if (isVertical) {\n    const leftSpace = first.left - rect.left;\n    const rightSpace = rect.right - first.right;\n    const dir = leftSpace > rightSpace ? 'left' : 'right';\n    const position = {\n      point: constrainPointWithinRect(\n        {\n          x: dir === 'left' ? first.left - rect.left - 6 : first.right - rect.left + 6,\n          y: (first.top + first.bottom) / 2 - rect.top,\n        },\n        rect,\n        paddingPx,\n      ),\n      dir,\n    } as Position;\n    const inView = pointIsInView(position.point);\n    return inView ? position : ({ point: { x: 0, y: 0 }, dir } as Position);\n  }\n\n  const start = {\n    point: constrainPointWithinRect(\n      { x: (first.left + first.right) / 2 - rect.left, y: first.top - rect.top - 12 },\n      rect,\n      paddingPx,\n    ),\n    dir: 'up',\n  } as Position;\n  const end = {\n    point: constrainPointWithinRect(\n      { x: (last.left + last.right) / 2 - rect.left, y: last.bottom - rect.top + 6 },\n      rect,\n      paddingPx,\n    ),\n    dir: 'down',\n  } as Position;\n  const startInView = pointIsInView(start.point);\n  const endInView = pointIsInView(end.point);\n  if (!startInView && !endInView) return { point: { x: 0, y: 0 } };\n  if (!startInView) return end;\n  if (!endInView) return start;\n  return start.point.y > window.innerHeight - end.point.y ? start : end;\n};\n\n// The popup will be positioned based on the triangle position and the direction\n// up: above the triangle\n// down: below the triangle\n// left: to the left of the triangle\n// right: to the right of the triangle\nexport const getPopupPosition = (\n  position: Position,\n  boundingReact: Rect,\n  popupWidthPx: number,\n  popupHeightPx: number,\n  popupPaddingPx: number,\n) => {\n  const popupPoint = { x: 0, y: 0 };\n  if (position.dir === 'up') {\n    popupPoint.x = position.point.x - popupWidthPx / 2;\n    popupPoint.y = position.point.y - popupHeightPx;\n  } else if (position.dir === 'down') {\n    popupPoint.x = position.point.x - popupWidthPx / 2;\n    popupPoint.y = position.point.y + 6;\n  } else if (position.dir === 'left') {\n    popupPoint.x = position.point.x - popupWidthPx;\n    popupPoint.y = position.point.y - popupHeightPx / 2;\n  } else if (position.dir === 'right') {\n    popupPoint.x = position.point.x + 6;\n    popupPoint.y = position.point.y - popupHeightPx / 2;\n  }\n\n  if (popupPoint.x < popupPaddingPx) {\n    popupPoint.x = popupPaddingPx;\n  }\n  if (popupPoint.y < popupPaddingPx) {\n    popupPoint.y = popupPaddingPx;\n  }\n  if (popupPoint.x + popupWidthPx > boundingReact.right - boundingReact.left - popupPaddingPx) {\n    popupPoint.x = boundingReact.right - boundingReact.left - popupPaddingPx - popupWidthPx;\n  }\n  if (popupPoint.y + popupHeightPx > boundingReact.bottom - boundingReact.top - popupPaddingPx) {\n    popupPoint.y = boundingReact.bottom - boundingReact.top - popupPaddingPx - popupHeightPx;\n  }\n\n  return { point: popupPoint, dir: position.dir } as Position;\n};\n\nexport const getTextFromRange = (range: Range, rejectTags: string[] = []): string => {\n  const clonedRange = range.cloneRange();\n  const fragment = clonedRange.cloneContents();\n  const walker = document.createTreeWalker(fragment, NodeFilter.SHOW_TEXT, {\n    acceptNode: (node) => {\n      const parent = node.parentElement;\n      if (rejectTags.includes(parent?.tagName.toLowerCase() || '')) {\n        return NodeFilter.FILTER_REJECT;\n      }\n      return NodeFilter.FILTER_ACCEPT;\n    },\n  });\n\n  let text = '';\n  let node: Text | null;\n\n  while ((node = walker.nextNode() as Text | null)) {\n    text += node.nodeValue ?? '';\n  }\n\n  return text;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5179, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/word.ts"],"sourcesContent":["// Helper to check if selected text is a whole word (has word boundaries on both sides)\n// Note: Word boundary checks only apply to space-separated languages (English, etc.)\n// CJK languages (Chinese, Japanese, Korean) don't require boundary checks\nexport const isWholeWord = (range: Range, selectedText: string): boolean => {\n  try {\n    const trimmed = selectedText.trim();\n    if (!trimmed) return false;\n\n    // Unicode-aware patterns\n    const wordCharPattern = /[\\p{L}\\p{N}\\p{M}_]/u;\n    const cjkPattern = /[\\p{Script=Han}\\p{Script=Hiragana}\\p{Script=Katakana}\\p{Script=Hangul}]/u;\n\n    // Must contain at least one word character\n    if (!wordCharPattern.test(trimmed)) return false;\n\n    // CJK text doesn't need boundary checks (no spaces between words)\n    if (cjkPattern.test(trimmed)) return true;\n\n    // Phrases (with spaces/punctuation) are always valid\n    if (/[\\s\\p{P}\\p{S}]/u.test(trimmed)) return true;\n\n    // For single words in space-separated languages, check boundaries\n    const { charBefore, charAfter } = getBoundaryChars(range);\n    const isWordChar = (char: string) => wordCharPattern.test(char);\n\n    return (!charBefore || !isWordChar(charBefore)) && (!charAfter || !isWordChar(charAfter));\n  } catch (e) {\n    console.warn('Failed to check whole word:', e);\n    return /[\\p{L}\\p{N}\\p{M}_]/u.test(selectedText);\n  }\n};\n\nexport const isPunctuationOnly = (text: string): boolean => {\n  const punctuationPattern = /^[\\p{P}\\p{S}\\s]+$/u;\n  return punctuationPattern.test(text);\n};\n\n// Helper to get characters before and after the selection\nconst getBoundaryChars = (range: Range): { charBefore: string; charAfter: string } => {\n  let charBefore = '';\n  let charAfter = '';\n\n  try {\n    // Get character before\n    const startNode = range.startContainer;\n    if (startNode.nodeType === Node.TEXT_NODE) {\n      const textNode = startNode as Text;\n      if (range.startOffset > 0) {\n        charBefore = textNode.textContent?.charAt(range.startOffset - 1) || '';\n      } else {\n        // Check previous sibling\n        let prev = startNode.previousSibling;\n        while (prev && prev.nodeType !== Node.TEXT_NODE) {\n          prev = prev.previousSibling;\n        }\n        if (prev?.nodeType === Node.TEXT_NODE) {\n          const prevText = (prev as Text).textContent || '';\n          charBefore = prevText.charAt(prevText.length - 1);\n        }\n      }\n    }\n\n    // Get character after\n    const endNode = range.endContainer;\n    if (endNode.nodeType === Node.TEXT_NODE) {\n      const textNode = endNode as Text;\n      const textContent = textNode.textContent || '';\n      if (range.endOffset < textContent.length) {\n        charAfter = textContent.charAt(range.endOffset);\n      } else {\n        // Check next sibling\n        let next = textNode.nextSibling;\n        while (next && next.nodeType !== Node.TEXT_NODE) {\n          next = next.nextSibling;\n        }\n        if (next?.nodeType === Node.TEXT_NODE) {\n          charAfter = ((next as Text).textContent || '').charAt(0);\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('[getBoundaryChars] Error:', e);\n  }\n\n  return { charBefore, charAfter };\n};\n\nexport const getWordCount = (text: string): number => {\n  if (!text) return 0;\n  return text.trim().split(/\\s+/).filter(Boolean).length;\n};\n"],"names":[],"mappings":"AAAA,uFAAuF;AACvF,qFAAqF;AACrF,0EAA0E;;;;;;;;;AACnE,MAAM,cAAc,CAAC,OAAc;IACxC,IAAI;QACF,MAAM,UAAU,aAAa,IAAI;QACjC,IAAI,CAAC,SAAS,OAAO;QAErB,yBAAyB;QACzB,MAAM,kBAAkB;QACxB,MAAM,aAAa;QAEnB,2CAA2C;QAC3C,IAAI,CAAC,gBAAgB,IAAI,CAAC,UAAU,OAAO;QAE3C,kEAAkE;QAClE,IAAI,WAAW,IAAI,CAAC,UAAU,OAAO;QAErC,qDAAqD;QACrD,IAAI,kBAAkB,IAAI,CAAC,UAAU,OAAO;QAE5C,kEAAkE;QAClE,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE,GAAG,iBAAiB;QACnD,MAAM,aAAa,CAAC,OAAiB,gBAAgB,IAAI,CAAC;QAE1D,OAAO,CAAC,CAAC,cAAc,CAAC,WAAW,WAAW,KAAK,CAAC,CAAC,aAAa,CAAC,WAAW,UAAU;IAC1F,EAAE,OAAO,GAAG;QACV,QAAQ,IAAI,CAAC,+BAA+B;QAC5C,OAAO,sBAAsB,IAAI,CAAC;IACpC;AACF;AAEO,MAAM,oBAAoB,CAAC;IAChC,MAAM,qBAAqB;IAC3B,OAAO,mBAAmB,IAAI,CAAC;AACjC;AAEA,0DAA0D;AAC1D,MAAM,mBAAmB,CAAC;IACxB,IAAI,aAAa;IACjB,IAAI,YAAY;IAEhB,IAAI;QACF,uBAAuB;QACvB,MAAM,YAAY,MAAM,cAAc;QACtC,IAAI,UAAU,QAAQ,KAAK,KAAK,SAAS,EAAE;YACzC,MAAM,WAAW;YACjB,IAAI,MAAM,WAAW,GAAG,GAAG;gBACzB,aAAa,SAAS,WAAW,EAAE,OAAO,MAAM,WAAW,GAAG,MAAM;YACtE,OAAO;gBACL,yBAAyB;gBACzB,IAAI,OAAO,UAAU,eAAe;gBACpC,MAAO,QAAQ,KAAK,QAAQ,KAAK,KAAK,SAAS,CAAE;oBAC/C,OAAO,KAAK,eAAe;gBAC7B;gBACA,IAAI,MAAM,aAAa,KAAK,SAAS,EAAE;oBACrC,MAAM,WAAW,AAAC,KAAc,WAAW,IAAI;oBAC/C,aAAa,SAAS,MAAM,CAAC,SAAS,MAAM,GAAG;gBACjD;YACF;QACF;QAEA,sBAAsB;QACtB,MAAM,UAAU,MAAM,YAAY;QAClC,IAAI,QAAQ,QAAQ,KAAK,KAAK,SAAS,EAAE;YACvC,MAAM,WAAW;YACjB,MAAM,cAAc,SAAS,WAAW,IAAI;YAC5C,IAAI,MAAM,SAAS,GAAG,YAAY,MAAM,EAAE;gBACxC,YAAY,YAAY,MAAM,CAAC,MAAM,SAAS;YAChD,OAAO;gBACL,qBAAqB;gBACrB,IAAI,OAAO,SAAS,WAAW;gBAC/B,MAAO,QAAQ,KAAK,QAAQ,KAAK,KAAK,SAAS,CAAE;oBAC/C,OAAO,KAAK,WAAW;gBACzB;gBACA,IAAI,MAAM,aAAa,KAAK,SAAS,EAAE;oBACrC,YAAY,CAAC,AAAC,KAAc,WAAW,IAAI,EAAE,EAAE,MAAM,CAAC;gBACxD;YACF;QACF;IACF,EAAE,OAAO,GAAG;QACV,QAAQ,IAAI,CAAC,6BAA6B;IAC5C;IAEA,OAAO;QAAE;QAAY;IAAU;AACjC;AAEO,MAAM,eAAe,CAAC;IAC3B,IAAI,CAAC,MAAM,OAAO;IAClB,OAAO,KAAK,IAAI,GAAG,KAAK,CAAC,OAAO,MAAM,CAAC,SAAS,MAAM;AACxD"}},
    {"offset": {"line": 5276, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/css.ts"],"sourcesContent":["export const validateCSS = (css: string): { isValid: boolean; error: string | null } => {\n  // Remove comments and normalize whitespace\n  css = css.replace(/\\/\\*[\\s\\S]*?\\*\\//g, '').trim();\n\n  // CSS property pattern (validate both property name and value)\n  const propertyPattern = /^[\\s\\n]*[-\\w]+\\s*:\\s*[^;]+;?$/;\n\n  // Check if empty\n  if (!css) return { isValid: false, error: 'Empty CSS' };\n\n  // Ensure balanced curly braces\n  const openBraces = (css.match(/{/g) || []).length;\n  const closeBraces = (css.match(/}/g) || []).length;\n  if (openBraces !== closeBraces) {\n    return { isValid: false, error: 'Unbalanced curly braces' };\n  }\n\n  const atRulePattern = /@[\\w-]+[^{]*\\{/g;\n  let result: RegExpExecArray | null;\n  let processedCss = '';\n  let lastIndex = 0;\n\n  while ((result = atRulePattern.exec(css)) !== null) {\n    const start = result.index;\n    const head = css.slice(lastIndex, start).trim();\n    if (head) processedCss += head + '\\n';\n\n    let i = atRulePattern.lastIndex;\n    let depth = 1;\n    while (i < css.length && depth > 0) {\n      if (css[i] === '{') depth++;\n      else if (css[i] === '}') depth--;\n      i++;\n    }\n    if (depth !== 0) return { isValid: false, error: 'Unbalanced curly braces in at-rule' };\n    const inner = css.slice(atRulePattern.lastIndex, i - 1).trim();\n    const innerResult = validateCSS(inner);\n    if (!innerResult.isValid) return innerResult;\n    lastIndex = i;\n  }\n\n  processedCss += css.slice(lastIndex).trim();\n  css = processedCss;\n\n  // Split into rule blocks\n  const blocks = css\n    .split('}')\n    .map((block) => block.trim())\n    .filter(Boolean);\n\n  for (const block of blocks) {\n    // Ensure the block has a selector and declarations\n    const parts = block.split('{').map((part) => part.trim());\n    if (parts.length !== 2) {\n      return { isValid: false, error: 'Invalid CSS structure' };\n    }\n\n    const [selector, decls] = parts;\n\n    // Ensure selector is not empty\n    if (!selector) {\n      return { isValid: false, error: 'Missing selector' };\n    }\n\n    // Ensure declarations are not empty\n    if (!decls) {\n      return { isValid: false, error: `Missing declarations for selector: ${selector}` };\n    }\n\n    // Validate declarations\n    const props = decls\n      .split(';')\n      .map((prop) => prop.trim())\n      .filter(Boolean);\n\n    if (props.length === 0) {\n      return { isValid: false, error: `No valid properties for selector: ${selector}` };\n    }\n\n    for (const prop of props) {\n      // Check if property is missing a name or value\n      if (!prop.includes(':')) {\n        return { isValid: false, error: `Missing property or value: ${prop}` };\n      }\n\n      const [name, value] = prop.split(':').map((part) => part.trim());\n      if (!name) {\n        return { isValid: false, error: `Missing property name: ${prop}` };\n      }\n      if (!value) {\n        return { isValid: false, error: `Missing property value: ${prop}` };\n      }\n\n      // Validate full property format\n      if (!propertyPattern.test(prop.endsWith(';') ? prop : prop + ';')) {\n        return { isValid: false, error: `Invalid property: ${prop}` };\n      }\n    }\n  }\n\n  return { isValid: true, error: null };\n};\n\nexport const formatCSS = (css: string): string => {\n  // Simple formatter: adds indentation and line breaks\n  const indent = '\\t';\n  let formatted = '';\n  let depth = 0;\n  let inComment = false;\n\n  css = css.replace(/\\s*\\n\\s*/g, '');\n  css = css.replace(/\\s{2,}/g, ' ').trim();\n  css = css.replace(/([^\\s{};][^{};]*:[^{};]+)\\s*}/g, '$1;}');\n\n  for (let i = 0; i < css.length; i++) {\n    const char = css[i];\n    const nextTwoChars = css.slice(i, i + 2);\n\n    if (nextTwoChars === '/*') {\n      inComment = true;\n      formatted += '\\n' + indent.repeat(depth) + '/*';\n      i++;\n      continue;\n    } else if (nextTwoChars === '*/' && inComment) {\n      inComment = false;\n      formatted += '*/\\n' + indent.repeat(depth);\n      i++;\n      continue;\n    }\n\n    if (inComment) {\n      formatted += char;\n      continue;\n    }\n\n    if (char === '{') {\n      depth++;\n      formatted += ' {\\n' + indent.repeat(depth);\n    } else if (char === '}') {\n      depth--;\n      formatted += '\\n' + indent.repeat(depth) + '}\\n' + indent.repeat(depth);\n    } else if (char === ';') {\n      formatted += ';\\n' + indent.repeat(depth);\n      while (css[i + 1] === ' ' || css[i + 1] === ';') i++;\n    } else {\n      formatted += char;\n    }\n  }\n\n  return formatted\n    .replace(/\\n([ \\t]*\\n)+/g, '\\n')\n    .replace(/[ ]{2,}/g, ' ')\n    .trim();\n};\n"],"names":[],"mappings":"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"}}]
}