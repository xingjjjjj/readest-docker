{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/nav.ts"],"sourcesContent":["'use client';\n\nimport { useRouter, redirect } from 'next/navigation';\nimport { getCurrentWindow } from '@tauri-apps/api/window';\nimport { WebviewWindow } from '@tauri-apps/api/webviewWindow';\nimport { isPWA, isWebAppPlatform } from '@/services/environment';\nimport { BOOK_IDS_SEPARATOR } from '@/services/constants';\nimport { AppService } from '@/types/system';\n\nlet readerWindowsCount = 0;\nconst createReaderWindow = (appService: AppService, url: string) => {\n  const currentWindow = getCurrentWindow();\n  const label = currentWindow.label;\n  const newLabelPrefix = label === 'main' ? 'reader' : label;\n  const win = new WebviewWindow(`${newLabelPrefix}-${readerWindowsCount}`, {\n    url,\n    width: 800,\n    height: 600,\n    center: true,\n    resizable: true,\n    title: appService.isMacOSApp ? '' : 'Readest',\n    decorations: appService.isMacOSApp ? true : false,\n    transparent: appService.isMacOSApp ? false : true,\n    shadow: appService.isMacOSApp ? undefined : true,\n    titleBarStyle: appService.isMacOSApp ? 'overlay' : undefined,\n  });\n  win.once('tauri://created', () => {\n    console.log('new window created');\n    readerWindowsCount += 1;\n  });\n  win.once('tauri://error', (e) => {\n    console.error('error creating window', e);\n  });\n  win.once('tauri://destroyed', () => {\n    readerWindowsCount -= 1;\n  });\n};\n\nexport const showReaderWindow = (appService: AppService, bookIds: string[]) => {\n  const ids = bookIds.join(BOOK_IDS_SEPARATOR);\n  const params = new URLSearchParams('');\n  params.set('ids', ids);\n  const url = `/reader?${params.toString()}`;\n  createReaderWindow(appService, url);\n};\n\nexport const showLibraryWindow = (appService: AppService, filenames: string[]) => {\n  const params = new URLSearchParams();\n  filenames.forEach((filename) => params.append('file', filename));\n  const url = `/library?${params.toString()}`;\n  createReaderWindow(appService, url);\n};\n\nexport const navigateToReader = (\n  router: ReturnType<typeof useRouter>,\n  bookIds: string[],\n  queryParams?: string,\n  navOptions?: { scroll?: boolean },\n) => {\n  const ids = bookIds.join(BOOK_IDS_SEPARATOR);\n  if (isWebAppPlatform() && !isPWA()) {\n    router.push(`/reader/${ids}${queryParams ? `?${queryParams}` : ''}`, navOptions);\n  } else {\n    const params = new URLSearchParams(queryParams || '');\n    params.set('ids', ids);\n    router.push(`/reader?${params.toString()}`, navOptions);\n  }\n};\n\nexport const navigateToLogin = (router: ReturnType<typeof useRouter>) => {\n  const pathname = window.location.pathname;\n  const search = window.location.search;\n  const currentPath = pathname !== '/auth' ? pathname + search : '/';\n  router.push(`/auth?redirect=${encodeURIComponent(currentPath)}`);\n};\n\nexport const navigateToProfile = (router: ReturnType<typeof useRouter>) => {\n  router.push('/user');\n};\n\nexport const navigateToLibrary = (\n  router: ReturnType<typeof useRouter>,\n  queryParams?: string,\n  navOptions?: { scroll?: boolean },\n  navBack?: boolean,\n) => {\n  const lastLibraryParams =\n    typeof window !== 'undefined' ? sessionStorage.getItem('lastLibraryParams') : null;\n  if (navBack && lastLibraryParams) {\n    queryParams = lastLibraryParams;\n  }\n\n  router.replace(`/library${queryParams ? `?${queryParams}` : ''}`, navOptions);\n};\n\nexport const redirectToLibrary = () => {\n  redirect('/library');\n};\n\nexport const navigateToResetPassword = (router: ReturnType<typeof useRouter>) => {\n  const pathname = window.location.pathname;\n  const search = window.location.search;\n  const currentPath = pathname !== '/auth' ? pathname + search : '/';\n  router.push(`/auth/recovery?redirect=${encodeURIComponent(currentPath)}`);\n};\n\nexport const navigateToUpdatePassword = (router: ReturnType<typeof useRouter>) => {\n  const pathname = window.location.pathname;\n  const search = window.location.search;\n  const currentPath = pathname !== '/auth' ? pathname + search : '/';\n  router.push(`/auth/update?redirect=${encodeURIComponent(currentPath)}`);\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/lang.ts"],"sourcesContent":["import { LocaleWithTextInfo } from '@/types/misc';\nimport { franc } from 'franc-min';\nimport { iso6392 } from 'iso-639-2';\nimport { iso6393To1 } from 'iso-639-3';\n\nexport const isCJKStr = (str: string) => {\n  return /[\\p{Script=Han}\\p{Script=Hiragana}\\p{Script=Katakana}\\p{Script=Hangul}]/u.test(str ?? '');\n};\n\nexport const isCJKLang = (lang: string | null | undefined): boolean => {\n  if (!lang) return false;\n  const normalizedLang = normalizedLangCode(lang);\n  return ['zh', 'ja', 'ko', 'zho', 'jpn', 'kor'].includes(normalizedLang);\n};\n\nconst ZH_SCRIPTS_MAPPING: Record<string, string> = {\n  zh: 'zh-Hans',\n  'zh-cn': 'zh-Hans',\n  'zh-hk': 'zh-Hant',\n  'zh-tw': 'zh-Hant',\n  'zh-mo': 'zh-Hant',\n  'zh-hans': 'zh-Hans',\n  'zh-hant': 'zh-Hant',\n};\n\nexport const normalizeToFullLang = (langCode: string): string => {\n  try {\n    const locale = new Intl.Locale(langCode.toLowerCase());\n    const maximized = locale.maximize();\n\n    if (maximized.language === 'zh') {\n      return maximized.script === 'Hant' ? 'zh-Hant' : 'zh-Hans';\n    }\n\n    return maximized.region ? `${maximized.language}-${maximized.region}` : langCode;\n  } catch {\n    return ZH_SCRIPTS_MAPPING[langCode.toLowerCase()] || langCode;\n  }\n};\n\nexport const normalizeToShortLang = (langCode: string): string => {\n  const lang = langCode.toLowerCase();\n  if (lang.startsWith('zh')) {\n    return ZH_SCRIPTS_MAPPING[lang] || 'zh-Hans';\n  }\n  return lang.split('-')[0]!;\n};\n\nexport const normalizedLangCode = (lang: string | null | undefined): string => {\n  if (!lang) return '';\n  return lang.split('-')[0]!.toLowerCase();\n};\n\nexport const isSameLang = (lang1?: string | null, lang2?: string | null): boolean => {\n  if (!lang1 || !lang2) return false;\n  const normalizedLang1 = normalizedLangCode(lang1);\n  const normalizedLang2 = normalizedLangCode(lang2);\n  return normalizedLang1 === normalizedLang2;\n};\n\nexport const isValidLang = (lang?: string) => {\n  if (!lang) return false;\n  if (typeof lang !== 'string') return false;\n  if (['und', 'mul', 'mis', 'zxx'].includes(lang)) return false;\n  const code = normalizedLangCode(lang);\n  return iso6392.some((l) => l.iso6391 === code || l.iso6392B === code);\n};\n\nexport const code6392to6391 = (code: string): string => {\n  const lang = iso6392.find((l) => l.iso6392B === code);\n  return lang?.iso6391 || '';\n};\n\nconst commonIndivToMacro: Record<string, string> = {\n  cmn: 'zho',\n  arb: 'ara',\n  arz: 'ara',\n  ind: 'msa',\n  zsm: 'msa',\n  nob: 'nor',\n  nno: 'nor',\n  pes: 'fas',\n  quy: 'que',\n};\n\nexport const code6393to6391 = (code: string): string => {\n  const macro = commonIndivToMacro[code] || code;\n  return iso6393To1[macro] || '';\n};\n\nexport const getLanguageName = (code: string): string => {\n  const lang = normalizedLangCode(code);\n  const language = iso6392.find((l) => l.iso6391 === lang || l.iso6392B === lang);\n  return language ? language.name : lang;\n};\n\nexport const inferLangFromScript = (text: string, lang: string): string => {\n  if (!lang || lang === 'en') {\n    if (/[\\p{Script=Hangul}]/u.test(text)) {\n      return 'ko';\n    } else if (/[\\p{Script=Hiragana}\\p{Script=Katakana}]/u.test(text)) {\n      return 'ja';\n    } else if (/[\\p{Script=Han}]/u.test(text)) {\n      return 'zh';\n    }\n  }\n  return lang;\n};\n\nexport const detectLanguage = (content: string): string => {\n  try {\n    const iso6393Lang = franc(content.substring(0, 1000));\n    const iso6391Lang = code6393to6391(iso6393Lang) || 'en';\n    return iso6391Lang;\n  } catch {\n    console.warn('Language detection failed, defaulting to en.');\n    return 'en';\n  }\n};\n\nexport const getLanguageInfo = (lang: string) => {\n  if (!lang) return {};\n  try {\n    const canonical = Intl.getCanonicalLocales(lang)[0]!;\n    const locale = new Intl.Locale(canonical) as LocaleWithTextInfo;\n    const isCJK = ['zh', 'ja', 'kr'].includes(locale.language);\n    const direction = (locale.getTextInfo?.() ?? locale.textInfo)?.direction;\n    return { canonical, locale, isCJK, direction };\n  } catch (e) {\n    console.warn(e);\n    return {};\n  }\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 298, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/book.ts"],"sourcesContent":["import { BookMetadata, EXTS } from '@/libs/document';\nimport { Book, BookConfig, BookProgress, WritingMode } from '@/types/book';\nimport { SUPPORTED_LANGS } from '@/services/constants';\nimport { getUserLang } from './misc';\nimport { getDirFromLanguage } from './rtl';\nimport { code6392to6391, isValidLang, normalizedLangCode } from './lang';\nimport { md5 } from './md5';\n\nexport const getDir = (book: Book) => {\n  // In local storage mode, return the folder name (same as book name without extension)\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  return book.relativePath.replace(/\\.[^.]+$/, '');\n};\nexport const getLibraryFilename = () => {\n  return 'library.json';\n};\nexport const getLibraryBackupFilename = () => {\n  return 'library_backup.json';\n};\nexport const getLocalBookFilename = (book: Book) => {\n  // In local storage mode, books are stored in their original relative paths\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  return book.relativePath;\n};\nexport const getCoverFilename = (book: Book) => {\n  // In local storage mode, covers are stored in a folder next to the book with the same name\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  // Remove extension from book path to get folder name\n  const pathWithoutExt = book.relativePath.replace(/\\.[^.]+$/, '');\n  const result = `${pathWithoutExt}/cover.png`;\n  console.log('[getCoverFilename] ✓ Using relativePath:', book.relativePath);\n  console.log('[getCoverFilename] ✓ Cover path result:', result);\n  return result;\n};\nexport const getConfigFilename = (book: Book) => {\n  // In local storage mode, configs are stored in a folder next to the book with the same name\n  if (!book.relativePath) {\n    throw new Error(`Book ${book.title} (${book.hash}) is missing relativePath. Please re-import the book.`);\n  }\n  // Remove extension from book path to get folder name\n  const pathWithoutExt = book.relativePath.replace(/\\.[^.]+$/, '');\n  return `${pathWithoutExt}/config.json`;\n};\nexport const isBookFile = (filename: string) => {\n  return Object.values(EXTS).includes(filename.split('.').pop()!);\n};\n\nexport const INIT_BOOK_CONFIG: BookConfig = {\n  updatedAt: 0,\n};\n\nexport interface LanguageMap {\n  [key: string]: string;\n}\n\nexport interface Identifier {\n  scheme: string;\n  value: string;\n}\n\nexport interface Contributor {\n  name: LanguageMap;\n}\n\nconst formatLanguageMap = (x: string | LanguageMap, defaultLang = false): string => {\n  const userLang = getUserLang();\n  if (!x) return '';\n  if (typeof x === 'string') return x;\n  const keys = Object.keys(x);\n  return defaultLang ? x[keys[0]!]! : x[userLang] || x[keys[0]!]!;\n};\n\nexport const listFormater = (narrow = false, lang = '') => {\n  lang = lang ? lang : getUserLang();\n  if (narrow) {\n    return new Intl.ListFormat('en', { style: 'narrow', type: 'unit' });\n  } else {\n    return new Intl.ListFormat(lang, { style: 'long', type: 'conjunction' });\n  }\n};\n\nexport const getBookLangCode = (lang: string | string[] | undefined) => {\n  try {\n    const bookLang = typeof lang === 'string' ? lang : lang?.[0];\n    return bookLang ? bookLang.split('-')[0]! : '';\n  } catch {\n    return '';\n  }\n};\n\nexport const flattenContributors = (\n  contributors: string | string[] | Contributor | Contributor[],\n) => {\n  if (!contributors) return '';\n  return Array.isArray(contributors)\n    ? contributors\n      .map((contributor) =>\n        typeof contributor === 'string' ? contributor : formatLanguageMap(contributor?.name),\n      )\n      .join(', ')\n    : typeof contributors === 'string'\n      ? contributors\n      : formatLanguageMap(contributors?.name);\n};\n\n// prettier-ignore\nconst LASTNAME_AUTHOR_SORT_LANGS = ['ar', 'bo', 'de', 'en', 'es', 'fr', 'hi', 'it', 'nl', 'pl', 'pt', 'ru', 'th', 'tr', 'uk'];\n\nconst formatAuthorName = (name: string, lastNameFirst: boolean) => {\n  if (!name) return '';\n  const parts = name.split(' ');\n  if (lastNameFirst && parts.length > 1) {\n    return `${parts[parts.length - 1]}, ${parts.slice(0, -1).join(' ')}`;\n  }\n  return name;\n};\n\nexport const formatAuthors = (\n  contributors: string | string[] | Contributor | Contributor[],\n  bookLang?: string | string[],\n  sortAs?: boolean,\n) => {\n  const langCode = getBookLangCode(bookLang) || 'en';\n  const lastNameFirst = !!sortAs && LASTNAME_AUTHOR_SORT_LANGS.includes(langCode);\n  return Array.isArray(contributors)\n    ? listFormater(langCode === 'zh', langCode).format(\n      contributors.map((contributor) =>\n        typeof contributor === 'string'\n          ? formatAuthorName(contributor, lastNameFirst)\n          : formatAuthorName(formatLanguageMap(contributor?.name), lastNameFirst),\n      ),\n    )\n    : typeof contributors === 'string'\n      ? formatAuthorName(contributors, lastNameFirst)\n      : formatAuthorName(formatLanguageMap(contributors?.name), lastNameFirst);\n};\n\nexport const formatTitle = (title: string | LanguageMap) => {\n  return typeof title === 'string' ? title : formatLanguageMap(title);\n};\n\nexport const formatDescription = (description?: string | LanguageMap) => {\n  if (!description) return '';\n  const text = typeof description === 'string' ? description : formatLanguageMap(description);\n  return text\n    .replace(/<\\/?[^>]+(>|$)/g, '')\n    .replace(/&#\\d+;/g, '')\n    .trim();\n};\n\nexport const formatPublisher = (publisher: string | LanguageMap) => {\n  return typeof publisher === 'string' ? publisher : formatLanguageMap(publisher);\n};\n\nconst langCodeToLangName = (langCode: string) => {\n  return SUPPORTED_LANGS[langCode] || langCode.toUpperCase();\n};\n\nexport const formatLanguage = (lang: string | string[] | undefined): string => {\n  return Array.isArray(lang)\n    ? lang.map(langCodeToLangName).join(', ')\n    : langCodeToLangName(lang || '');\n};\n\n// Should return valid ISO-639-1 language code, fallback to 'en' if not valid\nexport const getPrimaryLanguage = (lang: string | string[] | undefined) => {\n  const primaryLang = Array.isArray(lang) ? lang[0] : lang;\n  if (isValidLang(primaryLang)) {\n    const normalizedLang = normalizedLangCode(primaryLang);\n    return code6392to6391(normalizedLang) || normalizedLang;\n  }\n  return 'en';\n};\n\nexport const formatDate = (date: string | number | Date | null | undefined, isUTC = false) => {\n  if (!date) return;\n  const userLang = getUserLang();\n  try {\n    return new Date(date).toLocaleDateString(userLang, {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n      timeZone: isUTC ? 'UTC' : undefined,\n    });\n  } catch {\n    return;\n  }\n};\n\nexport const formatBytes = (bytes?: number | null, locale = 'en-US') => {\n  if (!bytes) return '';\n  const units = ['byte', 'kilobyte', 'megabyte', 'gigabyte', 'terabyte'];\n  const i = Math.floor(Math.log(bytes) / Math.log(1024));\n  const value = bytes / Math.pow(1024, i);\n  const formatter = new Intl.NumberFormat(locale, {\n    style: 'unit',\n    unit: units[i],\n    unitDisplay: 'short',\n    maximumFractionDigits: 2,\n  });\n  return formatter.format(value);\n};\n\nexport const getCurrentPage = (book: Book, progress: BookProgress) => {\n  const bookFormat = book.format;\n  const { section, pageinfo } = progress;\n  return bookFormat === 'PDF'\n    ? section\n      ? section.current + 1\n      : 0\n    : pageinfo\n      ? pageinfo.current + 1\n      : 0;\n};\n\nexport const getBookDirFromWritingMode = (writingMode: WritingMode) => {\n  switch (writingMode) {\n    case 'horizontal-tb':\n      return 'ltr';\n    case 'horizontal-rl':\n    case 'vertical-rl':\n      return 'rtl';\n    default:\n      return 'auto';\n  }\n};\n\nexport const getBookDirFromLanguage = (language: string | string[] | undefined) => {\n  const lang = getPrimaryLanguage(language) || '';\n  return getDirFromLanguage(lang);\n};\n\nconst getTitleForHash = (title: string | LanguageMap) => {\n  return typeof title === 'string' ? title : formatLanguageMap(title, true);\n};\n\nconst getAuthorsList = (contributors: string | string[] | Contributor | Contributor[]) => {\n  if (!contributors) return [];\n  return Array.isArray(contributors)\n    ? contributors\n      .map((contributor) =>\n        typeof contributor === 'string'\n          ? contributor\n          : formatLanguageMap(contributor?.name, true),\n      )\n      .filter(Boolean)\n    : [\n      typeof contributors === 'string'\n        ? contributors\n        : formatLanguageMap(contributors?.name, true),\n    ];\n};\n\nconst normalizeIdentifier = (identifier: string) => {\n  try {\n    if (identifier.includes('urn:')) {\n      // Slice after the last ':'\n      return identifier.match(/[^:]+$/)?.[0] || '';\n    } else if (identifier.includes(':')) {\n      // Slice after the first ':'\n      return identifier.match(/^[^:]+:(.+)$/)?.[1] || '';\n    }\n  } catch {\n    return identifier;\n  }\n  return identifier;\n};\n\nconst getPreferredIdentifier = (identifiers: string[] | Identifier[]) => {\n  for (const scheme of ['uuid', 'calibre', 'isbn']) {\n    const found = identifiers.find((identifier) =>\n      typeof identifier === 'string'\n        ? identifier.toLowerCase().includes(scheme)\n        : identifier.scheme.toLowerCase() === scheme,\n    );\n    if (found) {\n      return typeof found === 'string' ? normalizeIdentifier(found) : found.value;\n    }\n  }\n  return;\n};\n\nconst getIdentifiersList = (\n  identifiers: undefined | string | string[] | Identifier | Identifier[],\n) => {\n  if (!identifiers) return [];\n  if (Array.isArray(identifiers)) {\n    const preferred = getPreferredIdentifier(identifiers);\n    if (preferred) {\n      return [preferred];\n    }\n  }\n  return Array.isArray(identifiers)\n    ? identifiers\n      .map((identifier) =>\n        typeof identifier === 'string' ? normalizeIdentifier(identifier) : identifier.value,\n      )\n      .filter(Boolean)\n    : typeof identifiers === 'string'\n      ? [normalizeIdentifier(identifiers)]\n      : [identifiers.value];\n};\n\nexport const getMetadataHash = (metadata: BookMetadata) => {\n  try {\n    const title = getTitleForHash(metadata.title);\n    const authors = getAuthorsList(metadata.author).join(',');\n    const identifiers = getIdentifiersList(metadata.altIdentifier || metadata.identifier).join(',');\n    const hashSource = `${title}|${authors}|${identifiers}`;\n    const metaHash = md5(hashSource.normalize('NFC'));\n    return metaHash;\n  } catch (error) {\n    console.error('Error generating metadata hash:', error);\n  }\n  return;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 620, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/event.ts"],"sourcesContent":["class EventDispatcher {\n  private syncListeners: Map<string, Array<(event: CustomEvent) => boolean>>;\n  private asyncListeners: Map<string, Set<(event: CustomEvent) => Promise<void> | void>>;\n\n  constructor() {\n    this.syncListeners = new Map();\n    this.asyncListeners = new Map();\n  }\n\n  on(event: string, callback: (event: CustomEvent) => Promise<void> | void): void {\n    if (!this.asyncListeners.has(event)) {\n      this.asyncListeners.set(event, new Set());\n    }\n    this.asyncListeners.get(event)!.add(callback);\n  }\n\n  off(event: string, callback: (event: CustomEvent) => Promise<void> | void): void {\n    this.asyncListeners.get(event)?.delete(callback);\n  }\n\n  async dispatch(event: string, detail?: unknown): Promise<void> {\n    const listeners = this.asyncListeners.get(event);\n    if (listeners) {\n      const customEvent = new CustomEvent(event, { detail });\n      for (const listener of listeners) {\n        await listener(customEvent);\n      }\n    }\n  }\n\n  onSync(event: string, callback: (event: CustomEvent) => boolean): void {\n    if (!this.syncListeners.has(event)) {\n      this.syncListeners.set(event, []);\n    }\n    this.syncListeners.get(event)!.push(callback);\n  }\n\n  offSync(event: string, callback: (event: CustomEvent) => boolean): void {\n    const listeners = this.syncListeners.get(event);\n    if (listeners) {\n      this.syncListeners.set(\n        event,\n        listeners.filter((listener) => listener !== callback),\n      );\n    }\n  }\n\n  dispatchSync(event: string, detail?: unknown): boolean {\n    const listeners = this.syncListeners.get(event);\n    if (listeners) {\n      const customEvent = new CustomEvent(event, { detail });\n      for (const listener of [...listeners].reverse()) {\n        const consumed = listener(customEvent);\n        if (consumed) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n}\n\nexport const eventDispatcher = new EventDispatcher();\n"],"names":[],"mappings":";;;;AAAA,MAAM;IACI,cAAmE;IACnE,eAA+E;IAEvF,aAAc;QACZ,IAAI,CAAC,aAAa,GAAG,IAAI;QACzB,IAAI,CAAC,cAAc,GAAG,IAAI;IAC5B;IAEA,GAAG,KAAa,EAAE,QAAsD,EAAQ;QAC9E,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,QAAQ;YACnC,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,OAAO,IAAI;QACrC;QACA,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,OAAQ,GAAG,CAAC;IACtC;IAEA,IAAI,KAAa,EAAE,QAAsD,EAAQ;QAC/E,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,QAAQ,OAAO;IACzC;IAEA,MAAM,SAAS,KAAa,EAAE,MAAgB,EAAiB;QAC7D,MAAM,YAAY,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC;QAC1C,IAAI,WAAW;YACb,MAAM,cAAc,IAAI,YAAY,OAAO;gBAAE;YAAO;YACpD,KAAK,MAAM,YAAY,UAAW;gBAChC,MAAM,SAAS;YACjB;QACF;IACF;IAEA,OAAO,KAAa,EAAE,QAAyC,EAAQ;QACrE,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ;YAClC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,OAAO,EAAE;QAClC;QACA,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,OAAQ,IAAI,CAAC;IACtC;IAEA,QAAQ,KAAa,EAAE,QAAyC,EAAQ;QACtE,MAAM,YAAY,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC;QACzC,IAAI,WAAW;YACb,IAAI,CAAC,aAAa,CAAC,GAAG,CACpB,OACA,UAAU,MAAM,CAAC,CAAC,WAAa,aAAa;QAEhD;IACF;IAEA,aAAa,KAAa,EAAE,MAAgB,EAAW;QACrD,MAAM,YAAY,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC;QACzC,IAAI,WAAW;YACb,MAAM,cAAc,IAAI,YAAY,OAAO;gBAAE;YAAO;YACpD,KAAK,MAAM,YAAY;mBAAI;aAAU,CAAC,OAAO,GAAI;gBAC/C,MAAM,WAAW,SAAS;gBAC1B,IAAI,UAAU;oBACZ,OAAO;gBACT;YACF;QACF;QACA,OAAO;IACT;AACF;AAEO,MAAM,kBAAkB,IAAI"}},
    {"offset": {"line": 689, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/throttle.ts"],"sourcesContent":["interface ThrottleOptions {\n  emitLast?: boolean;\n}\n\nexport const throttle = <T extends (...args: Parameters<T>) => void | Promise<void>>(\n  func: T,\n  delay: number,\n  options: ThrottleOptions = { emitLast: true },\n): ((...args: Parameters<T>) => void) => {\n  let lastCall = 0;\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  let lastArgs: Parameters<T> | null = null;\n\n  return (...args: Parameters<T>): void => {\n    const now = Date.now();\n    const remaining = delay - (now - lastCall);\n\n    const callFunc = () => {\n      lastCall = Date.now();\n      timeout = null;\n      func(...args);\n    };\n\n    if (remaining <= 0) {\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = null;\n      }\n      callFunc();\n    } else {\n      lastArgs = args;\n      if (!timeout) {\n        timeout = setTimeout(() => {\n          timeout = null;\n          if (lastArgs && options.emitLast) {\n            func(...(lastArgs as Parameters<T>));\n            lastArgs = null;\n          }\n        }, remaining);\n      }\n    }\n  };\n};\n"],"names":[],"mappings":";;;;AAIO,MAAM,WAAW,CACtB,MACA,OACA,UAA2B;IAAE,UAAU;AAAK,CAAC;IAE7C,IAAI,WAAW;IACf,IAAI,UAAgD;IACpD,IAAI,WAAiC;IAErC,OAAO,CAAC,GAAG;QACT,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,YAAY,QAAQ,CAAC,MAAM,QAAQ;QAEzC,MAAM,WAAW;YACf,WAAW,KAAK,GAAG;YACnB,UAAU;YACV,QAAQ;QACV;QAEA,IAAI,aAAa,GAAG;YAClB,IAAI,SAAS;gBACX,aAAa;gBACb,UAAU;YACZ;YACA;QACF,OAAO;YACL,WAAW;YACX,IAAI,CAAC,SAAS;gBACZ,UAAU,WAAW;oBACnB,UAAU;oBACV,IAAI,YAAY,QAAQ,QAAQ,EAAE;wBAChC,QAAS;wBACT,WAAW;oBACb;gBACF,GAAG;YACL;QACF;IACF;AACF"}},
    {"offset": {"line": 734, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/jwt.ts"],"sourcesContent":["import { jwtVerify, SignJWT } from 'jose';\n\n// 单用户认证配置\n// 为确保中间件与API一致，开发环境使用固定默认密钥\nconst SECRET_KEY = process.env['AUTH_SECRET'] || 'dev-secret';\nconst USER_PASSWORD = process.env['AUTH_PASSWORD'] || 'changeme-' + Math.random().toString(36).substring(2, 15);\nconst USERNAME = 'xingjjjjj';\n\n// 在服务器端启动时打印认证信息\nif (typeof window === 'undefined' && process.env['NODE_ENV'] !== 'production') {\n    console.log('\\n========== READEST AUTHENTICATION (Development) ==========');\n    console.log(`Username: ${USERNAME}`);\n    console.log(`Password: ${USER_PASSWORD}`);\n    console.log(`Secret Key: ${SECRET_KEY}`);\n    console.log('==========================================================\\n');\n}\n\nconst key = new TextEncoder().encode(SECRET_KEY);\n\nexport interface AuthPayload {\n    username: string;\n    iat?: number;\n    exp?: number;\n}\n\n/**\n * 创建 JWT 令牌\n */\nexport async function createJWT(username: string): Promise<string> {\n    const token = await new SignJWT({ username })\n        .setProtectedHeader({ alg: 'HS256' })\n        .setIssuedAt()\n        .setExpirationTime('30d')\n        .sign(key);\n\n    return token;\n}\n\n/**\n * 验证 JWT 令牌\n */\nexport async function verifyJWT(token: string): Promise<AuthPayload | null> {\n    try {\n        const verified = await jwtVerify(token, key);\n        return verified.payload as unknown as AuthPayload;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * 验证用户名和密码\n */\nexport function validateCredentials(username: string, password: string): boolean {\n    return username === USERNAME && password === USER_PASSWORD;\n}\n\n/**\n * 从 Authorization header 中提取令牌\n */\nexport function extractToken(authHeader: string | null): string | null {\n    if (!authHeader) return null;\n\n    const parts = authHeader.split(' ');\n    if (parts.length !== 2 || parts[0] !== 'Bearer') {\n        return null;\n    }\n\n    return parts[1] ?? null;\n}\n\n/**\n * 生成凭证字符串（用于调试）\n */\nexport function getCredentials(): { username: string; password: string; secret: string } {\n    return {\n        username: USERNAME,\n        password: USER_PASSWORD,\n        secret: SECRET_KEY,\n    };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAImB;AAJnB;AAAA;;AAEA,UAAU;AACV,4BAA4B;AAC5B,MAAM,aAAa,6UAAO,CAAC,GAAG,CAAC,cAAc,IAAI;AACjD,MAAM,gBAAgB,6UAAO,CAAC,GAAG,CAAC,gBAAgB,IAAI,cAAc,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG;AAC5G,MAAM,WAAW;AAEjB,iBAAiB;AACjB;;AAQA,MAAM,MAAM,IAAI,cAAc,MAAM,CAAC;AAW9B,eAAe,UAAU,QAAgB;IAC5C,MAAM,QAAQ,MAAM,IAAI,sNAAO,CAAC;QAAE;IAAS,GACtC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,OAClB,IAAI,CAAC;IAEV,OAAO;AACX;AAKO,eAAe,UAAU,KAAa;IACzC,IAAI;QACA,MAAM,WAAW,MAAM,IAAA,0NAAS,EAAC,OAAO;QACxC,OAAO,SAAS,OAAO;IAC3B,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAKO,SAAS,oBAAoB,QAAgB,EAAE,QAAgB;IAClE,OAAO,aAAa,YAAY,aAAa;AACjD;AAKO,SAAS,aAAa,UAAyB;IAClD,IAAI,CAAC,YAAY,OAAO;IAExB,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,IAAI,MAAM,MAAM,KAAK,KAAK,KAAK,CAAC,EAAE,KAAK,UAAU;QAC7C,OAAO;IACX;IAEA,OAAO,KAAK,CAAC,EAAE,IAAI;AACvB;AAKO,SAAS;IACZ,OAAO;QACH,UAAU;QACV,UAAU;QACV,QAAQ;IACZ;AACJ"}},
    {"offset": {"line": 800, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/access.ts"],"sourcesContent":["import { jwtDecode } from 'jwt-decode';\nimport { verifyJWT } from '@/utils/jwt';\nimport { UserPlan } from '@/types/quota';\nimport { DEFAULT_DAILY_TRANSLATION_QUOTA, DEFAULT_STORAGE_QUOTA } from '@/services/constants';\nimport { isWebAppPlatform } from '@/services/environment';\nimport { getDailyUsage } from '@/services/translators/utils';\n\ninterface Token {\n  plan: UserPlan;\n  storage_usage_bytes: number;\n  storage_purchased_bytes: number;\n  [key: string]: string | number;\n}\n\nexport const getSubscriptionPlan = (token: string): UserPlan => {\n  const data = jwtDecode<Token>(token) || {};\n  return data['plan'] || 'free';\n};\n\nexport const getUserProfilePlan = (token: string): UserPlan => {\n  const data = jwtDecode<Token>(token) || {};\n  let plan = data['plan'] || 'free';\n  if (plan === 'free') {\n    const purchasedQuota = data['storage_purchased_bytes'] || 0;\n    if (purchasedQuota > 0) {\n      plan = 'purchase';\n    }\n  }\n  return plan;\n};\n\nexport const STORAGE_QUOTA_GRACE_BYTES = 10 * 1024 * 1024; // 10 MB grace\n\nexport const getStoragePlanData = (token: string) => {\n  const data = jwtDecode<Token>(token) || {};\n  const plan = data['plan'] || 'free';\n  const usage = data['storage_usage_bytes'] || 0;\n  const purchasedQuota = data['storage_purchased_bytes'] || 0;\n  const fixedQuota = parseInt(process.env['NEXT_PUBLIC_STORAGE_FIXED_QUOTA'] || '0');\n  const planQuota = fixedQuota || DEFAULT_STORAGE_QUOTA[plan] || DEFAULT_STORAGE_QUOTA['free'];\n  const quota = planQuota + purchasedQuota;\n\n  return {\n    plan,\n    usage,\n    quota,\n  };\n};\n\nexport const getTranslationPlanData = (token: string) => {\n  const data = jwtDecode<Token>(token) || {};\n  const plan: UserPlan = data['plan'] || 'free';\n  const usage = getDailyUsage() || 0;\n  const quota = DEFAULT_DAILY_TRANSLATION_QUOTA[plan];\n\n  return {\n    plan,\n    usage,\n    quota,\n  };\n};\n\nexport const getDailyTranslationPlanData = (token: string) => {\n  const data = jwtDecode<Token>(token) || {};\n  const plan = data['plan'] || 'free';\n  const fixedQuota = parseInt(process.env['NEXT_PUBLIC_TRANSLATION_FIXED_QUOTA'] || '0');\n  const quota =\n    fixedQuota || DEFAULT_DAILY_TRANSLATION_QUOTA[plan] || DEFAULT_DAILY_TRANSLATION_QUOTA['free'];\n\n  return {\n    plan,\n    quota,\n  };\n};\n\nexport const getAccessToken = async (): Promise<string | null> => {\n  // Get token from localStorage (client-side) or from request (server-side)\n  if (isWebAppPlatform()) {\n    return localStorage.getItem('token') ?? null;\n  }\n  return null;\n};\n\nexport const getUserID = async (): Promise<string | null> => {\n  if (isWebAppPlatform()) {\n    const user = localStorage.getItem('user') ?? '{}';\n    return JSON.parse(user).id ?? null;\n  }\n  return null;\n};\n\nexport const validateUserAndToken = async (authHeader: string | null | undefined) => {\n  if (!authHeader) return {};\n\n  const token = authHeader.replace('Bearer ', '');\n  try {\n    const payload = await verifyJWT(token);\n    if (!payload) return {};\n    return { user: { id: 'xingjjjjj', email: 'admin@local' }, token };\n  } catch (error) {\n    return {};\n  }\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AAsC8B;AAtC9B;AACA;AAEA;AACA;AACA;;;;;;AASO,MAAM,sBAAsB,CAAC;IAClC,MAAM,OAAO,IAAA,gOAAS,EAAQ,UAAU,CAAC;IACzC,OAAO,IAAI,CAAC,OAAO,IAAI;AACzB;AAEO,MAAM,qBAAqB,CAAC;IACjC,MAAM,OAAO,IAAA,gOAAS,EAAQ,UAAU,CAAC;IACzC,IAAI,OAAO,IAAI,CAAC,OAAO,IAAI;IAC3B,IAAI,SAAS,QAAQ;QACnB,MAAM,iBAAiB,IAAI,CAAC,0BAA0B,IAAI;QAC1D,IAAI,iBAAiB,GAAG;YACtB,OAAO;QACT;IACF;IACA,OAAO;AACT;AAEO,MAAM,4BAA4B,KAAK,OAAO,MAAM,cAAc;AAElE,MAAM,qBAAqB,CAAC;IACjC,MAAM,OAAO,IAAA,gOAAS,EAAQ,UAAU,CAAC;IACzC,MAAM,OAAO,IAAI,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,IAAI,CAAC,sBAAsB,IAAI;IAC7C,MAAM,iBAAiB,IAAI,CAAC,0BAA0B,IAAI;IAC1D,MAAM,aAAa,SAAS,6UAAO,CAAC,GAAG,CAAC,kCAAkC,IAAI;IAC9E,MAAM,YAAY,cAAc,kLAAqB,CAAC,KAAK,IAAI,kLAAqB,CAAC,OAAO;IAC5F,MAAM,QAAQ,YAAY;IAE1B,OAAO;QACL;QACA;QACA;IACF;AACF;AAEO,MAAM,yBAAyB,CAAC;IACrC,MAAM,OAAO,IAAA,gOAAS,EAAQ,UAAU,CAAC;IACzC,MAAM,OAAiB,IAAI,CAAC,OAAO,IAAI;IACvC,MAAM,QAAQ,IAAA,qLAAa,OAAM;IACjC,MAAM,QAAQ,4LAA+B,CAAC,KAAK;IAEnD,OAAO;QACL;QACA;QACA;IACF;AACF;AAEO,MAAM,8BAA8B,CAAC;IAC1C,MAAM,OAAO,IAAA,gOAAS,EAAQ,UAAU,CAAC;IACzC,MAAM,OAAO,IAAI,CAAC,OAAO,IAAI;IAC7B,MAAM,aAAa,SAAS,6UAAO,CAAC,GAAG,CAAC,sCAAsC,IAAI;IAClF,MAAM,QACJ,cAAc,4LAA+B,CAAC,KAAK,IAAI,4LAA+B,CAAC,OAAO;IAEhG,OAAO;QACL;QACA;IACF;AACF;AAEO,MAAM,iBAAiB;IAC5B,0EAA0E;IAC1E,IAAI,IAAA,+KAAgB,KAAI;QACtB,OAAO,aAAa,OAAO,CAAC,YAAY;IAC1C;IACA,OAAO;AACT;AAEO,MAAM,YAAY;IACvB,IAAI,IAAA,+KAAgB,KAAI;QACtB,MAAM,OAAO,aAAa,OAAO,CAAC,WAAW;QAC7C,OAAO,KAAK,KAAK,CAAC,MAAM,EAAE,IAAI;IAChC;IACA,OAAO;AACT;AAEO,MAAM,uBAAuB,OAAO;IACzC,IAAI,CAAC,YAAY,OAAO,CAAC;IAEzB,MAAM,QAAQ,WAAW,OAAO,CAAC,WAAW;IAC5C,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,6JAAS,EAAC;QAChC,IAAI,CAAC,SAAS,OAAO,CAAC;QACtB,OAAO;YAAE,MAAM;gBAAE,IAAI;gBAAa,OAAO;YAAc;YAAG;QAAM;IAClE,EAAE,OAAO,OAAO;QACd,OAAO,CAAC;IACV;AACF"}},
    {"offset": {"line": 920, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/transfer.ts"],"sourcesContent":["import { invoke, Channel } from '@tauri-apps/api/core';\n\nexport type UploadMethod = 'POST' | 'PUT';\n\nexport const enum UploadFileError {\n  Unauthorized = 'Unauthorized access',\n  DownloadFailed = 'File download failed',\n}\n\nexport interface ProgressPayload {\n  progress: number;\n  total: number;\n  transferSpeed: number;\n}\n\nexport type ProgressHandler = (progress: ProgressPayload) => void;\n\nexport const webUpload = (file: File, uploadUrl: string, onProgress?: ProgressHandler) => {\n  return new Promise<void>((resolve, reject) => {\n    const startTime = Date.now();\n    const xhr = new XMLHttpRequest();\n    xhr.open('PUT', uploadUrl, true);\n\n    xhr.upload.onprogress = (event) => {\n      if (onProgress && event.lengthComputable) {\n        onProgress({\n          progress: event.loaded,\n          total: event.total,\n          transferSpeed: event.loaded / ((Date.now() - startTime) / 1000),\n        });\n      }\n    };\n\n    xhr.onload = () => {\n      if (xhr.status >= 200 && xhr.status < 300) {\n        resolve();\n      } else {\n        reject(new Error(`Upload failed with status ${xhr.status}`));\n      }\n    };\n\n    xhr.onerror = () => reject(new Error('Upload failed'));\n\n    xhr.send(file);\n  });\n};\n\nexport const webDownload = async (\n  downloadUrl: string,\n  onProgress?: ProgressHandler,\n  headers?: Record<string, string>,\n) => {\n  const response = await fetch(downloadUrl, {\n    method: 'GET',\n    headers: headers ? headers : undefined,\n  });\n  if (!response.ok) {\n    if (response.status === 401 || response.status === 403) {\n      throw new Error(UploadFileError.Unauthorized);\n    }\n    throw new Error(UploadFileError.DownloadFailed);\n  }\n\n  const responseHeaders = Object.fromEntries(response.headers.entries());\n  const contentLength =\n    response.headers.get('Content-Length') || response.headers.get('X-Content-Length');\n  if (!contentLength) throw new Error('Cannot track progress: Content-Length missing');\n\n  const totalSize = parseInt(contentLength, 10);\n  let receivedSize = 0;\n  const reader = response.body!.getReader();\n  const chunks: Uint8Array[] = [];\n\n  const startTime = Date.now();\n  while (true) {\n    const { done, value } = await reader.read();\n    if (done) break;\n\n    chunks.push(value);\n    receivedSize += value.length;\n\n    if (onProgress) {\n      onProgress({\n        progress: receivedSize,\n        total: totalSize,\n        transferSpeed: receivedSize / ((Date.now() - startTime) / 1000),\n      });\n    }\n  }\n\n  return { headers: responseHeaders, blob: new Blob(chunks as BlobPart[]) };\n};\n\nexport const tauriUpload = async (\n  url: string,\n  filePath: string,\n  method: UploadMethod,\n  progressHandler?: ProgressHandler,\n  headers?: Map<string, string>,\n): Promise<string> => {\n  const ids = new Uint32Array(1);\n  window.crypto.getRandomValues(ids);\n  const id = ids[0];\n\n  const onProgress = new Channel<ProgressPayload>();\n  if (progressHandler) {\n    onProgress.onmessage = progressHandler;\n  }\n\n  return await invoke('upload_file', {\n    id,\n    url,\n    filePath,\n    method,\n    headers: headers ?? {},\n    onProgress,\n  });\n};\n\nexport const tauriDownload = async (\n  url: string,\n  filePath: string,\n  progressHandler?: ProgressHandler,\n  headers?: Record<string, string>,\n  body?: string,\n  singleThreaded?: boolean,\n  skipSslVerification?: boolean,\n): Promise<Record<string, string>> => {\n  const ids = new Uint32Array(1);\n  window.crypto.getRandomValues(ids);\n  const id = ids[0];\n\n  const onProgress = new Channel<ProgressPayload>();\n  if (progressHandler) {\n    onProgress.onmessage = progressHandler;\n  }\n\n  const responseHeaders = await invoke<Record<string, string>>('download_file', {\n    id,\n    url,\n    filePath,\n    headers: headers ?? {},\n    onProgress,\n    body,\n    singleThreaded,\n    skipSslVerification,\n  });\n  return responseHeaders;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1045, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/ua.ts"],"sourcesContent":["import { AppService } from '@/types/system';\n\nexport const parseWebViewInfo = (appService: AppService | null): string => {\n  const ua = navigator.userAgent;\n\n  if (appService?.isAndroidApp) {\n    // Android WebView\n    const chromeMatch = ua.match(/Chrome\\/([0-9.]+)/);\n    return chromeMatch ? `WebView ${chromeMatch[1]}` : 'Android WebView';\n  } else if (appService?.isIOSApp) {\n    // iOS WebView\n    const webkitMatch = ua.match(/AppleWebKit\\/([0-9.]+)/);\n    return webkitMatch ? `WebView ${webkitMatch[1]}` : 'iOS WebView';\n  } else if (appService?.isMacOSApp) {\n    // macOS WebView\n    const webkitMatch = ua.match(/AppleWebKit\\/([0-9.]+)/);\n    return webkitMatch ? `WebView ${webkitMatch[1]}` : 'macOS WebView';\n  } else if (appService?.appPlatform === 'tauri' && appService?.osPlatform === 'windows') {\n    // Windows WebView2\n    const match = ua.match(/Edg\\/([0-9.]+)/);\n    return match ? `Edge ${match[1]}` : 'Edge WebView2';\n  } else if (appService?.appPlatform === 'tauri' && appService?.osPlatform === 'linux') {\n    // Linux WebView\n    const match = ua.match(/AppleWebKit\\/([0-9.]+)/);\n    return match ? `WebView ${match[1]}` : 'Linux WebView';\n  } else if (ua.includes('CriOS') && ua.includes('Mobile/') && ua.includes('Safari')) {\n    // iOS Chrome WebView\n    const match = ua.match(/CriOS\\/([0-9.]+)/);\n    return match ? `Chrome ${match[1]}` : 'iOS Chrome';\n  } else if (ua.includes('FxiOS') && ua.includes('Mobile/') && ua.includes('Safari')) {\n    // iOS Firefox WebView\n    const match = ua.match(/FxiOS\\/([0-9.]+)/);\n    return match ? `Firefox ${match[1]}` : 'iOS Firefox';\n  } else if (ua.includes('Chrome') && ua.includes('AppleWebKit') && ua.includes('Macintosh')) {\n    // macOS Chrome\n    const match = ua.match(/Chrome\\/([0-9.]+)/);\n    return match ? `Chrome ${match[1]}` : 'macOS Chrome';\n  } else if (ua.includes('Safari') && ua.includes('AppleWebKit') && ua.includes('Macintosh')) {\n    // macOS Safari\n    const match = ua.match(/Safari\\/([0-9.]+)/);\n    return match ? `Safari ${match[1]}` : 'macOS Safari';\n  } else if (ua.includes('Edg/')) {\n    // Microsoft Edge\n    const match = ua.match(/Edg\\/([0-9.]+)/);\n    return match ? `Edge ${match[1]}` : 'Edge WebView';\n  } else if (ua.includes('Firefox/')) {\n    // Firefox\n    const match = ua.match(/Firefox\\/([0-9.]+)/);\n    return match ? `Firefox ${match[1]}` : 'Firefox Gecko';\n  } else if (ua.includes('Chrome/') && !ua.includes('Chromium')) {\n    // Chrome\n    const match = ua.match(/Chrome\\/([0-9.]+)/);\n    return match ? `Chrome ${match[1]}` : 'Chrome';\n  } else if (ua.includes('Chromium/')) {\n    // Chromium\n    const match = ua.match(/Chromium\\/([0-9.]+)/);\n    return match ? `Chromium ${match[1]}` : 'Chromium';\n  } else if (ua.includes('MSIE ')) {\n    // Internet Explorer\n    const match = ua.match(/MSIE ([0-9.]+)/);\n    return match ? `IE ${match[1]}` : 'Internet Explorer';\n  } else {\n    return 'Unknown';\n  }\n};\n\nexport const parseWebViewVersion = (appService: AppService | null): number => {\n  const webViewInfo = parseWebViewInfo(appService);\n  const versionMatch = webViewInfo.match(/([0-9]+)\\./);\n  return versionMatch ? parseFloat(versionMatch[1]!) : 0;\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1125, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/simplecc.ts"],"sourcesContent":["import init, { simplecc } from '@simplecc/simplecc_wasm';\nimport { ConvertChineseVariant } from '@/types/book';\n\nlet initialized = false;\n\nconst initSimpleCC = async () => {\n  if (initialized) return;\n\n  await init('/vendor/simplecc/simplecc_wasm_bg.wasm');\n  initialized = true;\n};\n\nconst convertReverseMap: Record<ConvertChineseVariant, ConvertChineseVariant> = {\n  none: 'none',\n  s2t: 't2s',\n  t2s: 's2t',\n  s2tw: 'tw2s',\n  s2hk: 'hk2s',\n  s2twp: 'tw2sp',\n  tw2s: 's2tw',\n  hk2s: 's2hk',\n  tw2sp: 's2twp',\n};\n\nconst runSimpleCC = (text: string, variant: ConvertChineseVariant, reverse = false): string => {\n  return reverse ? simplecc(text, convertReverseMap[variant]) : simplecc(text, variant);\n};\n\nexport { initSimpleCC, runSimpleCC };\n"],"names":[],"mappings":";;;;;;AAAA;;AAGA,IAAI,cAAc;AAElB,MAAM,eAAe;IACnB,IAAI,aAAa;IAEjB,MAAM,IAAA,qLAAI,EAAC;IACX,cAAc;AAChB;AAEA,MAAM,oBAA0E;IAC9E,MAAM;IACN,KAAK;IACL,KAAK;IACL,MAAM;IACN,MAAM;IACN,OAAO;IACP,MAAM;IACN,MAAM;IACN,OAAO;AACT;AAEA,MAAM,cAAc,CAAC,MAAc,SAAgC,UAAU,KAAK;IAChF,OAAO,UAAU,IAAA,sLAAQ,EAAC,MAAM,iBAAiB,CAAC,QAAQ,IAAI,IAAA,sLAAQ,EAAC,MAAM;AAC/E"}},
    {"offset": {"line": 1161, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/toc.ts"],"sourcesContent":["import { ConvertChineseVariant } from '@/types/book';\nimport { SectionItem, TOCItem, CFI, BookDoc } from '@/libs/document';\nimport { initSimpleCC, runSimpleCC } from '@/utils/simplecc';\n\nexport const findParentPath = (toc: TOCItem[], href: string): TOCItem[] => {\n  for (const item of toc) {\n    if (item.href === href) {\n      return [item];\n    }\n    if (item.subitems) {\n      const path = findParentPath(item.subitems, href);\n      if (path.length) {\n        return [item, ...path];\n      }\n    }\n  }\n  return [];\n};\n\nexport const findTocItemBS = (toc: TOCItem[], cfi: string): TOCItem | null => {\n  let left = 0;\n  let right = toc.length - 1;\n  let result: TOCItem | null = null;\n\n  while (left <= right) {\n    const mid = Math.floor((left + right) / 2);\n    const item = toc[mid]!;\n    const currentCfi = toc[mid]!.cfi || '';\n    const comparison = CFI.compare(currentCfi, cfi);\n    if (comparison === 0) {\n      return findInSubitems(item, cfi) ?? item;\n    } else if (comparison < 0) {\n      result = findInSubitems(item, cfi) ?? item;\n      left = mid + 1;\n    } else {\n      right = mid - 1;\n    }\n  }\n\n  return result;\n};\n\nconst findInSubitems = (item: TOCItem, cfi: string): TOCItem | null => {\n  if (!item.subitems?.length) return null;\n  return findTocItemBS(item.subitems, cfi);\n};\n\nexport const updateToc = async (\n  bookDoc: BookDoc,\n  sortedTOC: boolean,\n  convertChineseVariant: ConvertChineseVariant,\n) => {\n  const items = bookDoc?.toc || [];\n  if (!items.length) return;\n\n  if (convertChineseVariant && convertChineseVariant !== 'none') {\n    await initSimpleCC();\n    convertTocLabels(items, convertChineseVariant);\n  }\n\n  const sections = bookDoc?.sections || [];\n  if (!sections.length) return;\n\n  const sizes = sections.map((s) => (s.linear != 'no' && s.size > 0 ? s.size : 0));\n  let cumulativeSize = 0;\n  const cumulativeSizes = sizes.reduce((acc: number[], size) => {\n    acc.push(cumulativeSize);\n    cumulativeSize += size;\n    return acc;\n  }, []);\n  const totalSize = cumulativeSizes[cumulativeSizes.length - 1] || 0;\n  const sizePerLoc = 1500;\n  sections.forEach((section, index) => {\n    section.location = {\n      current: Math.floor(cumulativeSizes[index]! / sizePerLoc),\n      next: Math.floor((cumulativeSizes[index]! + sizes[index]!) / sizePerLoc),\n      total: Math.floor(totalSize / sizePerLoc),\n    };\n  });\n\n  const sectionsMap = sections.reduce((map: Record<string, SectionItem>, section) => {\n    map[section.id] = section;\n    return map;\n  }, {});\n\n  updateTocData(bookDoc, items, sections, sectionsMap);\n\n  if (sortedTOC) {\n    sortTocItems(items);\n  }\n};\n\nconst convertTocLabels = (items: TOCItem[], convertChineseVariant: ConvertChineseVariant) => {\n  items.forEach((item) => {\n    if (item.label) {\n      item.label = runSimpleCC(item.label, convertChineseVariant);\n    }\n    if (item.subitems) {\n      convertTocLabels(item.subitems, convertChineseVariant);\n    }\n  });\n};\n\nconst updateTocData = (\n  bookDoc: BookDoc,\n  items: TOCItem[],\n  sections: SectionItem[],\n  sectionsMap: { [id: string]: SectionItem },\n  index = 0,\n): number => {\n  items.forEach((item) => {\n    item.id ??= index++;\n    if (item.href) {\n      const id = bookDoc.splitTOCHref(item.href)[0]!;\n      const section = sectionsMap[id];\n      if (section) {\n        item.cfi = section.cfi;\n        // Add location only when toc item is at the same level as the section\n        // otherwise the location will not be accurate\n        if (id === item.href || items.length <= sections.length) {\n          item.location = section.location;\n        }\n      }\n    }\n    if (item.subitems) {\n      index = updateTocData(bookDoc, item.subitems, sections, sectionsMap, index);\n    }\n  });\n  return index;\n};\n\nconst sortTocItems = (items: TOCItem[]): void => {\n  items.sort((a, b) => {\n    if (a.location && b.location) {\n      return a.location.current - b.location.current;\n    }\n    return 0;\n  });\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1296, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/sanitize.ts"],"sourcesContent":["export const sanitizeString = (str?: string) => {\n  if (!str) return str;\n  return str.replace(/\\u0000/g, '');\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,iBAAiB,CAAC;IAC7B,IAAI,CAAC,KAAK,OAAO;IACjB,OAAO,IAAI,OAAO,CAAC,WAAW;AAChC"}},
    {"offset": {"line": 1311, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/transform.ts"],"sourcesContent":["import {\n  Book,\n  BookConfig,\n  BookFormat,\n  BookNote,\n  BookNoteType,\n  HighlightColor,\n  HighlightStyle,\n} from '@/types/book';\nimport { DBBookConfig, DBBook, DBBookNote } from '@/types/records';\nimport { sanitizeString } from './sanitize';\n\nexport const transformBookConfigToDB = (bookConfig: unknown, userId: string): DBBookConfig => {\n  const {\n    bookHash,\n    metaHash,\n    progress,\n    location,\n    xpointer,\n    searchConfig,\n    viewSettings,\n    updatedAt,\n  } = bookConfig as BookConfig;\n\n  return {\n    user_id: userId,\n    book_hash: bookHash!,\n    meta_hash: metaHash,\n    location: location,\n    xpointer: xpointer,\n    progress: progress && JSON.stringify(progress),\n    search_config: searchConfig && JSON.stringify(searchConfig),\n    view_settings: viewSettings && JSON.stringify(viewSettings),\n    updated_at: new Date(updatedAt ?? Date.now()).toISOString(),\n  };\n};\n\nexport const transformBookConfigFromDB = (dbBookConfig: DBBookConfig): BookConfig => {\n  const {\n    book_hash,\n    meta_hash,\n    progress,\n    location,\n    xpointer,\n    search_config,\n    view_settings,\n    updated_at,\n  } = dbBookConfig;\n  return {\n    bookHash: book_hash,\n    metaHash: meta_hash,\n    location,\n    xpointer,\n    progress: progress && JSON.parse(progress),\n    searchConfig: search_config && JSON.parse(search_config),\n    viewSettings: view_settings && JSON.parse(view_settings),\n    updatedAt: new Date(updated_at!).getTime(),\n  } as BookConfig;\n};\n\nexport const transformBookToDB = (book: unknown, userId: string): DBBook => {\n  const {\n    hash,\n    metaHash,\n    format,\n    title,\n    sourceTitle,\n    author,\n    groupId,\n    groupName,\n    tags,\n    progress,\n    metadata,\n    createdAt,\n    updatedAt,\n    deletedAt,\n    uploadedAt,\n  } = book as Book;\n\n  return {\n    user_id: userId,\n    book_hash: hash,\n    meta_hash: metaHash,\n    format,\n    title: sanitizeString(title)!,\n    author: sanitizeString(author)!,\n    group_id: groupId,\n    group_name: sanitizeString(groupName),\n    tags: tags,\n    progress: progress,\n    source_title: sanitizeString(sourceTitle),\n    metadata: metadata ? sanitizeString(JSON.stringify(metadata)) : null,\n    created_at: new Date(createdAt ?? Date.now()).toISOString(),\n    updated_at: new Date(updatedAt ?? Date.now()).toISOString(),\n    deleted_at: deletedAt ? new Date(deletedAt).toISOString() : null,\n    uploaded_at: uploadedAt ? new Date(uploadedAt).toISOString() : null,\n  };\n};\n\nexport const transformBookFromDB = (dbBook: DBBook): Book => {\n  const {\n    book_hash,\n    meta_hash,\n    format,\n    title,\n    author,\n    group_id,\n    group_name,\n    tags,\n    progress,\n    source_title,\n    metadata,\n    created_at,\n    updated_at,\n    deleted_at,\n    uploaded_at,\n  } = dbBook;\n\n  return {\n    hash: book_hash,\n    metaHash: meta_hash,\n    format: format as BookFormat,\n    title,\n    author,\n    groupId: group_id,\n    groupName: group_name,\n    tags: tags,\n    progress: progress,\n    sourceTitle: source_title,\n    metadata: metadata ? JSON.parse(metadata) : null,\n    createdAt: new Date(created_at!).getTime(),\n    updatedAt: new Date(updated_at!).getTime(),\n    deletedAt: deleted_at ? new Date(deleted_at).getTime() : null,\n    uploadedAt: uploaded_at ? new Date(uploaded_at).getTime() : null,\n  };\n};\n\nexport const transformBookNoteToDB = (bookNote: unknown, userId: string): DBBookNote => {\n  const {\n    bookHash,\n    metaHash,\n    id,\n    type,\n    cfi,\n    text,\n    style,\n    color,\n    note,\n    createdAt,\n    updatedAt,\n    deletedAt,\n  } = bookNote as BookNote;\n\n  return {\n    user_id: userId,\n    book_hash: bookHash!,\n    meta_hash: metaHash,\n    id,\n    type,\n    cfi,\n    text: sanitizeString(text),\n    style,\n    color,\n    note,\n    created_at: new Date(createdAt ?? Date.now()).toISOString(),\n    updated_at: new Date(updatedAt ?? Date.now()).toISOString(),\n    // note that only null deleted_at is updated to the database, undefined is not\n    deleted_at: deletedAt ? new Date(deletedAt).toISOString() : null,\n  };\n};\n\nexport const transformBookNoteFromDB = (dbBookNote: DBBookNote): BookNote => {\n  const {\n    book_hash,\n    meta_hash,\n    id,\n    type,\n    cfi,\n    text,\n    style,\n    color,\n    note,\n    created_at,\n    updated_at,\n    deleted_at,\n  } = dbBookNote;\n\n  return {\n    bookHash: book_hash,\n    metaHash: meta_hash,\n    id,\n    type: type as BookNoteType,\n    cfi,\n    text,\n    style: style as HighlightStyle,\n    color: color as HighlightColor,\n    note,\n    createdAt: new Date(created_at!).getTime(),\n    updatedAt: new Date(updated_at!).getTime(),\n    deletedAt: deleted_at ? new Date(deleted_at).getTime() : null,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1438, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/permission.ts"],"sourcesContent":["import { invoke, PermissionState } from '@tauri-apps/api/core';\n\ninterface Permissions {\n  manageStorage: PermissionState;\n}\n\nexport const requestStoragePermission = async (): Promise<boolean> => {\n  let permission = await invoke<Permissions>('plugin:native-bridge|checkPermissions');\n  if (permission.manageStorage !== 'granted') {\n    permission = await invoke<Permissions>(\n      'plugin:native-bridge|request_manage_storage_permission',\n    );\n  }\n  return permission.manageStorage === 'granted';\n};\n"],"names":[],"mappings":";;;;AAAA;;AAMO,MAAM,2BAA2B;IACtC,IAAI,aAAa,MAAM,IAAA,8NAAM,EAAc;IAC3C,IAAI,WAAW,aAAa,KAAK,WAAW;QAC1C,aAAa,MAAM,IAAA,8NAAM,EACvB;IAEJ;IACA,OAAO,WAAW,aAAa,KAAK;AACtC"}},
    {"offset": {"line": 1458, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/window.ts"],"sourcesContent":["import { getCurrentWindow } from '@tauri-apps/api/window';\nimport { emitTo, TauriEvent } from '@tauri-apps/api/event';\nimport { exit } from '@tauri-apps/plugin-process';\nimport { type as osType } from '@tauri-apps/plugin-os';\nimport { eventDispatcher } from './event';\n\nexport const tauriGetWindowLogicalPosition = async () => {\n  const currentWindow = getCurrentWindow();\n  const factor = await currentWindow.scaleFactor();\n  const physicalPos = await currentWindow.outerPosition();\n  return { x: physicalPos.x / factor, y: physicalPos.y / factor };\n};\n\nexport const tauriHandleMinimize = async () => {\n  getCurrentWindow().minimize();\n};\n\n// workaround to reset transparent background when toggling fullscreen/maximize\nconst linuxWindowRestoreTransparentBg = async () => {\n  const currentSize = await getCurrentWindow().innerSize();\n  currentSize.width -= 1;\n  currentSize.height -= 1;\n  await getCurrentWindow().setSize(currentSize);\n  setTimeout(async () => {\n    const currentSize = await getCurrentWindow().innerSize();\n    currentSize.width += 1;\n    currentSize.height += 1;\n    await getCurrentWindow().setSize(currentSize);\n  }, 100);\n};\n\nexport const tauriHandleToggleMaximize = async () => {\n  const currentWindow = getCurrentWindow();\n  const isFullscreen = await currentWindow.isFullscreen();\n  if (isFullscreen) {\n    await currentWindow.setFullscreen(false);\n    await currentWindow.unmaximize();\n  } else {\n    await currentWindow.toggleMaximize();\n  }\n  if ((await osType()) === 'linux') {\n    linuxWindowRestoreTransparentBg();\n  }\n};\n\nexport const tauriHandleClose = async () => {\n  getCurrentWindow().close();\n};\n\nexport const tauriHandleOnCloseWindow = async (callback: () => void) => {\n  const currentWindow = getCurrentWindow();\n  return await currentWindow.onCloseRequested(async (event) => {\n    event.preventDefault();\n    await callback();\n    if (currentWindow.label.startsWith('reader')) {\n      await emitTo('main', 'close-reader-window', { label: currentWindow.label });\n      setTimeout(() => currentWindow.destroy(), 300);\n    } else if (currentWindow.label === 'main') {\n      await currentWindow.destroy();\n    }\n  });\n};\n\nexport const tauriHandleToggleFullScreen = async () => {\n  const currentWindow = getCurrentWindow();\n  const isFullscreen = await currentWindow.isFullscreen();\n  const isMaximized = await currentWindow.isMaximized();\n  if (isMaximized) {\n    await currentWindow.unmaximize();\n  } else {\n    await currentWindow.setFullscreen(!isFullscreen);\n  }\n  if ((await osType()) === 'linux') {\n    linuxWindowRestoreTransparentBg();\n  }\n};\n\nexport const tauriHandleSetAlwaysOnTop = async (isAlwaysOnTop: boolean) => {\n  const currentWindow = getCurrentWindow();\n  await currentWindow.setAlwaysOnTop(isAlwaysOnTop);\n};\n\nexport const tauriGetAlwaysOnTop = async () => {\n  const currentWindow = getCurrentWindow();\n  return await currentWindow.isAlwaysOnTop();\n};\n\nexport const tauriHandleOnWindowFocus = async (callback: () => void) => {\n  const currentWindow = getCurrentWindow();\n  return currentWindow.listen(TauriEvent.WINDOW_FOCUS, async () => {\n    await callback();\n  });\n};\n\nexport const tauriQuitApp = async () => {\n  await eventDispatcher.dispatch('quit-app');\n  await exit(0);\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,MAAM,gCAAgC;IAC3C,MAAM,gBAAgB,IAAA,0PAAgB;IACtC,MAAM,SAAS,MAAM,cAAc,WAAW;IAC9C,MAAM,cAAc,MAAM,cAAc,aAAa;IACrD,OAAO;QAAE,GAAG,YAAY,CAAC,GAAG;QAAQ,GAAG,YAAY,CAAC,GAAG;IAAO;AAChE;AAEO,MAAM,sBAAsB;IACjC,IAAA,0PAAgB,IAAG,QAAQ;AAC7B;AAEA,+EAA+E;AAC/E,MAAM,kCAAkC;IACtC,MAAM,cAAc,MAAM,IAAA,0PAAgB,IAAG,SAAS;IACtD,YAAY,KAAK,IAAI;IACrB,YAAY,MAAM,IAAI;IACtB,MAAM,IAAA,0PAAgB,IAAG,OAAO,CAAC;IACjC,WAAW;QACT,MAAM,cAAc,MAAM,IAAA,0PAAgB,IAAG,SAAS;QACtD,YAAY,KAAK,IAAI;QACrB,YAAY,MAAM,IAAI;QACtB,MAAM,IAAA,0PAAgB,IAAG,OAAO,CAAC;IACnC,GAAG;AACL;AAEO,MAAM,4BAA4B;IACvC,MAAM,gBAAgB,IAAA,0PAAgB;IACtC,MAAM,eAAe,MAAM,cAAc,YAAY;IACrD,IAAI,cAAc;QAChB,MAAM,cAAc,aAAa,CAAC;QAClC,MAAM,cAAc,UAAU;IAChC,OAAO;QACL,MAAM,cAAc,cAAc;IACpC;IACA,IAAI,AAAC,MAAM,IAAA,6PAAM,QAAQ,SAAS;QAChC;IACF;AACF;AAEO,MAAM,mBAAmB;IAC9B,IAAA,0PAAgB,IAAG,KAAK;AAC1B;AAEO,MAAM,2BAA2B,OAAO;IAC7C,MAAM,gBAAgB,IAAA,0PAAgB;IACtC,OAAO,MAAM,cAAc,gBAAgB,CAAC,OAAO;QACjD,MAAM,cAAc;QACpB,MAAM;QACN,IAAI,cAAc,KAAK,CAAC,UAAU,CAAC,WAAW;YAC5C,MAAM,IAAA,+NAAM,EAAC,QAAQ,uBAAuB;gBAAE,OAAO,cAAc,KAAK;YAAC;YACzE,WAAW,IAAM,cAAc,OAAO,IAAI;QAC5C,OAAO,IAAI,cAAc,KAAK,KAAK,QAAQ;YACzC,MAAM,cAAc,OAAO;QAC7B;IACF;AACF;AAEO,MAAM,8BAA8B;IACzC,MAAM,gBAAgB,IAAA,0PAAgB;IACtC,MAAM,eAAe,MAAM,cAAc,YAAY;IACrD,MAAM,cAAc,MAAM,cAAc,WAAW;IACnD,IAAI,aAAa;QACf,MAAM,cAAc,UAAU;IAChC,OAAO;QACL,MAAM,cAAc,aAAa,CAAC,CAAC;IACrC;IACA,IAAI,AAAC,MAAM,IAAA,6PAAM,QAAQ,SAAS;QAChC;IACF;AACF;AAEO,MAAM,4BAA4B,OAAO;IAC9C,MAAM,gBAAgB,IAAA,0PAAgB;IACtC,MAAM,cAAc,cAAc,CAAC;AACrC;AAEO,MAAM,sBAAsB;IACjC,MAAM,gBAAgB,IAAA,0PAAgB;IACtC,OAAO,MAAM,cAAc,aAAa;AAC1C;AAEO,MAAM,2BAA2B,OAAO;IAC7C,MAAM,gBAAgB,IAAA,0PAAgB;IACtC,OAAO,cAAc,MAAM,CAAC,mOAAU,CAAC,YAAY,EAAE;QACnD,MAAM;IACR;AACF;AAEO,MAAM,eAAe;IAC1B,MAAM,qKAAe,CAAC,QAAQ,CAAC;IAC/B,MAAM,IAAA,uQAAI,EAAC;AACb"}},
    {"offset": {"line": 1584, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/validation.ts"],"sourcesContent":["/**\n * Validation utilities for metadata fields\n */\n\n// ISO 639-1 language codes (2-letter codes)\n// prettier-ignore\nconst ISO_639_1_CODES = new Set([\n  'aa', 'ab', 'ae', 'af', 'ak', 'am', 'an', 'ar', 'as', 'av', 'ay', 'az',\n  'ba', 'be', 'bg', 'bh', 'bi', 'bm', 'bn', 'bo', 'br', 'bs',\n  'ca', 'ce', 'ch', 'co', 'cr', 'cs', 'cu', 'cv', 'cy',\n  'da', 'de', 'dv', 'dz',\n  'ee', 'el', 'en', 'eo', 'es', 'et', 'eu',\n  'fa', 'ff', 'fi', 'fj', 'fo', 'fr', 'fy',\n  'ga', 'gd', 'gl', 'gn', 'gu', 'gv',\n  'ha', 'he', 'hi', 'ho', 'hr', 'ht', 'hu', 'hy', 'hz',\n  'ia', 'id', 'ie', 'ig', 'ii', 'ik', 'io', 'is', 'it', 'iu',\n  'ja', 'jv',\n  'ka', 'kg', 'ki', 'kj', 'kk', 'kl', 'km', 'kn', 'ko', 'kr', 'ks', 'ku', 'kv', 'kw', 'ky',\n  'la', 'lb', 'lg', 'li', 'ln', 'lo', 'lt', 'lu', 'lv',\n  'mg', 'mh', 'mi', 'mk', 'ml', 'mn', 'mr', 'ms', 'mt', 'my',\n  'na', 'nb', 'nd', 'ne', 'ng', 'nl', 'nn', 'no', 'nr', 'nv', 'ny',\n  'oc', 'oj', 'om', 'or', 'os',\n  'pa', 'pi', 'pl', 'ps', 'pt',\n  'qu',\n  'rm', 'rn', 'ro', 'ru', 'rw',\n  'sa', 'sc', 'sd', 'se', 'sg', 'si', 'sk', 'sl', 'sm', 'sn', 'so', 'sq', 'sr', 'ss', 'st', 'su', 'sv', 'sw',\n  'ta', 'te', 'tg', 'th', 'ti', 'tk', 'tl', 'tn', 'to', 'tr', 'ts', 'tt', 'tw', 'ty',\n  'ug', 'uk', 'ur', 'uz',\n  've', 'vi', 'vo',\n  'wa', 'wo',\n  'xh',\n  'yi', 'yo',\n  'za', 'zh', 'zu'\n]);\n\nexport interface ValidationResult<T> {\n  isValid: boolean;\n  value: T | null;\n  error?: string;\n}\n\n/**\n * Validates and normalizes date input\n * Accepts YYYY, YYYY-MM, or YYYY-MM-DD formats\n * Returns ISO string if valid, null if invalid\n */\nexport const validateAndNormalizeDate = (dateInput: string): ValidationResult<string> => {\n  if (!dateInput) {\n    return { isValid: true, value: '' };\n  }\n\n  const cleaned = dateInput.trim();\n  // Pattern for YYYY, YYYY-MM, or YYYY-MM-DD\n  const datePatterns = [\n    { pattern: /^\\d{4}$/, format: 'YYYY' },\n    { pattern: /^\\d{4}-\\d{2}$/, format: 'YYYY-MM' },\n    { pattern: /^\\d{4}-\\d{2}-\\d{2}$/, format: 'YYYY-MM-DD' },\n  ];\n\n  const matchingPattern = datePatterns.find(({ pattern }) => pattern.test(cleaned));\n  if (!matchingPattern) {\n    return {\n      isValid: false,\n      value: null,\n      error: 'Invalid date format. Use YYYY, YYYY-MM, or YYYY-MM-DD',\n    };\n  }\n\n  try {\n    let date: Date;\n\n    if (cleaned.length === 4) {\n      // YYYY format - set to January 1st\n      date = new Date(`${cleaned}-01-01`);\n    } else if (cleaned.length === 7) {\n      // YYYY-MM format - set to 1st day of month\n      date = new Date(`${cleaned}-01`);\n    } else {\n      // YYYY-MM-DD format\n      date = new Date(cleaned);\n    }\n\n    // Check if date is valid\n    if (isNaN(date.getTime())) {\n      return {\n        isValid: false,\n        value: null,\n        error: 'Invalid date',\n      };\n    }\n\n    // Check if year is reasonable (between 1000 and current year + 10)\n    const year = date.getFullYear();\n    const currentYear = new Date().getFullYear();\n    if (year < 1000 || year > currentYear + 10) {\n      return {\n        isValid: false,\n        value: null,\n        error: `Year must be between 1000 and ${currentYear + 10}`,\n      };\n    }\n\n    // Validate month and day if provided\n    if (cleaned.length >= 7) {\n      const month = parseInt(cleaned.substring(5, 7));\n      if (month < 1 || month > 12) {\n        return {\n          isValid: false,\n          value: null,\n          error: 'Month must be between 01 and 12',\n        };\n      }\n    }\n\n    if (cleaned.length === 10) {\n      const day = parseInt(cleaned.substring(8, 10));\n      if (day < 1 || day > 31) {\n        return {\n          isValid: false,\n          value: null,\n          error: 'Day must be between 01 and 31',\n        };\n      }\n    }\n\n    return {\n      isValid: true,\n      value: date.toISOString(),\n    };\n  } catch {\n    return {\n      isValid: false,\n      value: null,\n      error: 'Failed to parse date',\n    };\n  }\n};\n\n/**\n * Validates and normalizes language code input\n * Accepts ISO 639-1 codes with optional country codes (e.g., en, en-US, zh-CN)\n * Returns normalized language code if valid, null if invalid\n */\nexport const validateAndNormalizeLanguage = (languageInput: string): ValidationResult<string> => {\n  if (!languageInput) {\n    return { isValid: true, value: 'unknown' };\n  }\n\n  const cleaned = languageInput.trim().toLowerCase();\n  // Pattern for language codes with optional country codes (e.g., en-US, zh-CN)\n  const languagePattern = /^[a-z]{2}(-[a-z]{2,4})?$/i;\n  if (!languagePattern.test(cleaned)) {\n    return {\n      isValid: false,\n      value: null,\n      error: 'Invalid language format. Use ISO 639-1 codes (e.g., en, zh-CN)',\n    };\n  }\n\n  const languageCode = cleaned.substring(0, 2);\n  if (!ISO_639_1_CODES.has(languageCode)) {\n    return {\n      isValid: false,\n      value: null,\n      error: `Invalid language code: ${languageCode}. Must be a valid ISO 639-1 code`,\n    };\n  }\n\n  return {\n    isValid: true,\n    value: cleaned,\n  };\n};\n\nexport const validateISBN = (isbn: string): ValidationResult<string> => {\n  if (!isbn) {\n    return { isValid: true, value: '' };\n  }\n\n  const cleaned = isbn.replace(/[-\\s]/g, '');\n  if (cleaned.length !== 10 && cleaned.length !== 13) {\n    return {\n      isValid: false,\n      value: null,\n      error: 'ISBN must be 10 or 13 digits',\n    };\n  }\n\n  // Validate ISBN-10\n  if (cleaned.length === 10) {\n    const isValid = validateISBN10(cleaned);\n    return {\n      isValid,\n      value: isValid ? cleaned : null,\n      error: isValid ? undefined : 'Invalid ISBN-10 checksum',\n    };\n  }\n\n  // Validate ISBN-13\n  if (cleaned.length === 13) {\n    const isValid = validateISBN13(cleaned);\n    return {\n      isValid,\n      value: isValid ? cleaned : null,\n      error: isValid ? undefined : 'Invalid ISBN-13 checksum',\n    };\n  }\n\n  return { isValid: false, value: null, error: 'Invalid ISBN format' };\n};\n\nconst validateISBN10 = (isbn: string): boolean => {\n  let sum = 0;\n  for (let i = 0; i < 9; i++) {\n    const digit = parseInt(isbn[i]!);\n    if (isNaN(digit)) return false;\n    sum += digit * (10 - i);\n  }\n\n  const lastChar = isbn[9]!;\n  const checkDigit = lastChar === 'X' ? 10 : parseInt(lastChar);\n  if (isNaN(checkDigit)) return false;\n\n  sum += checkDigit;\n  return sum % 11 === 0;\n};\n\nconst validateISBN13 = (isbn: string): boolean => {\n  let sum = 0;\n  for (let i = 0; i < 12; i++) {\n    const digit = parseInt(isbn[i]!);\n    if (isNaN(digit)) return false;\n    sum += digit * (i % 2 === 0 ? 1 : 3);\n  }\n\n  const checkDigit = parseInt(isbn[12]!);\n  if (isNaN(checkDigit)) return false;\n\n  const calculatedCheck = (10 - (sum % 10)) % 10;\n  return checkDigit === calculatedCheck;\n};\n\n/**\n * Validates subjects/genres input\n * Accepts comma-separated values and returns cleaned array\n */\nexport const validateAndNormalizeSubjects = (subjectsInput: string): ValidationResult<string[]> => {\n  if (!subjectsInput) {\n    return { isValid: true, value: [] };\n  }\n\n  const subjects = subjectsInput.split(',').map((s) => s.trim());\n\n  const maxSubjects = 20;\n  const maxSubjectLength = 100;\n\n  if (subjects.length > maxSubjects) {\n    return {\n      isValid: false,\n      value: null,\n      error: `Too many subjects (max ${maxSubjects})`,\n    };\n  }\n\n  const tooLongSubject = subjects.find((s) => s.length > maxSubjectLength);\n  if (tooLongSubject) {\n    return {\n      isValid: false,\n      value: null,\n      error: `Subject too long (max ${maxSubjectLength} characters): ${tooLongSubject}`,\n    };\n  }\n\n  return {\n    isValid: true,\n    value: subjects,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2009, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/fetch.ts"],"sourcesContent":["import { getAccessToken } from './access';\n\nexport const fetchWithTimeout = (url: string, options: RequestInit = {}, timeout = 10000) => {\n  const controller = new AbortController();\n  const id = setTimeout(() => controller.abort('Request timed out'), timeout);\n\n  return fetch(url, {\n    ...options,\n    signal: controller.signal,\n  }).finally(() => clearTimeout(id));\n};\n\nexport const fetchWithAuth = async (url: string, options: RequestInit) => {\n  const token = await getAccessToken();\n  if (!token) {\n    throw new Error('Not authenticated');\n  }\n  const headers = {\n    ...options.headers,\n    Authorization: `Bearer ${token}`,\n  };\n\n  const response = await fetch(url, { ...options, headers });\n\n  if (!response.ok) {\n    const errorData = await response.json();\n    console.error('Error:', errorData.error || response.statusText);\n    throw new Error(errorData.error || 'Request failed');\n  }\n\n  return response;\n};\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,mBAAmB,CAAC,KAAa,UAAuB,CAAC,CAAC,EAAE,UAAU,KAAK;IACtF,MAAM,aAAa,IAAI;IACvB,MAAM,KAAK,WAAW,IAAM,WAAW,KAAK,CAAC,sBAAsB;IAEnE,OAAO,MAAM,KAAK;QAChB,GAAG,OAAO;QACV,QAAQ,WAAW,MAAM;IAC3B,GAAG,OAAO,CAAC,IAAM,aAAa;AAChC;AAEO,MAAM,gBAAgB,OAAO,KAAa;IAC/C,MAAM,QAAQ,MAAM,IAAA,qKAAc;IAClC,IAAI,CAAC,OAAO;QACV,MAAM,IAAI,MAAM;IAClB;IACA,MAAM,UAAU;QACd,GAAG,QAAQ,OAAO;QAClB,eAAe,CAAC,OAAO,EAAE,OAAO;IAClC;IAEA,MAAM,WAAW,MAAM,MAAM,KAAK;QAAE,GAAG,OAAO;QAAE;IAAQ;IAExD,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,YAAY,MAAM,SAAS,IAAI;QACrC,QAAQ,KAAK,CAAC,UAAU,UAAU,KAAK,IAAI,SAAS,UAAU;QAC9D,MAAM,IAAI,MAAM,UAAU,KAAK,IAAI;IACrC;IAEA,OAAO;AACT"}},
    {"offset": {"line": 2052, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/network.ts"],"sourcesContent":["export const isLanAddress = (url: string) => {\n  try {\n    const urlObj = new URL(url);\n    const hostname = urlObj.hostname;\n\n    if (hostname === 'localhost' || hostname === '127.0.0.1') {\n      return true;\n    }\n\n    // Check for IPv4 private ranges\n    const ipv4Regex = /^(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})$/;\n    const match = hostname.match(ipv4Regex);\n\n    if (match) {\n      const [, a, b, c, d] = match.map(Number);\n      if (a === undefined || b === undefined || c === undefined || d === undefined) {\n        return false;\n      }\n\n      // Validate IP format\n      if (a > 255 || b > 255 || c > 255 || d > 255) {\n        return false;\n      }\n\n      // Check private IP ranges:\n      // 10.0.0.0/8 (10.0.0.0 to 10.255.255.255)\n      if (a === 10) return true;\n\n      // 172.16.0.0/12 (172.16.0.0 to 172.31.255.255)\n      if (a === 172 && b >= 16 && b <= 31) return true;\n\n      // 192.168.0.0/16 (192.168.0.0 to 192.168.255.255)\n      if (a === 192 && b === 168) return true;\n\n      // 169.254.0.0/16 (link-local addresses)\n      if (a === 169 && b === 254) return true;\n\n      // Tailscale IPv4 range: 100.64.0.0/10 (100.64.0.0 to 100.127.255.255)\n      if (a === 100 && b >= 64 && b <= 127) return true;\n    }\n\n    // Check for IPv6 private addresses (simplified check)\n    if (hostname.includes(':')) {\n      if (\n        hostname.startsWith('::1') ||\n        hostname.startsWith('fe80:') ||\n        hostname.startsWith('fc00:') ||\n        hostname.startsWith('fd00:')\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  } catch {\n    return false;\n  }\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,eAAe,CAAC;IAC3B,IAAI;QACF,MAAM,SAAS,IAAI,IAAI;QACvB,MAAM,WAAW,OAAO,QAAQ;QAEhC,IAAI,aAAa,eAAe,aAAa,aAAa;YACxD,OAAO;QACT;QAEA,gCAAgC;QAChC,MAAM,YAAY;QAClB,MAAM,QAAQ,SAAS,KAAK,CAAC;QAE7B,IAAI,OAAO;YACT,MAAM,GAAG,GAAG,GAAG,GAAG,EAAE,GAAG,MAAM,GAAG,CAAC;YACjC,IAAI,MAAM,aAAa,MAAM,aAAa,MAAM,aAAa,MAAM,WAAW;gBAC5E,OAAO;YACT;YAEA,qBAAqB;YACrB,IAAI,IAAI,OAAO,IAAI,OAAO,IAAI,OAAO,IAAI,KAAK;gBAC5C,OAAO;YACT;YAEA,2BAA2B;YAC3B,0CAA0C;YAC1C,IAAI,MAAM,IAAI,OAAO;YAErB,+CAA+C;YAC/C,IAAI,MAAM,OAAO,KAAK,MAAM,KAAK,IAAI,OAAO;YAE5C,kDAAkD;YAClD,IAAI,MAAM,OAAO,MAAM,KAAK,OAAO;YAEnC,wCAAwC;YACxC,IAAI,MAAM,OAAO,MAAM,KAAK,OAAO;YAEnC,sEAAsE;YACtE,IAAI,MAAM,OAAO,KAAK,MAAM,KAAK,KAAK,OAAO;QAC/C;QAEA,sDAAsD;QACtD,IAAI,SAAS,QAAQ,CAAC,MAAM;YAC1B,IACE,SAAS,UAAU,CAAC,UACpB,SAAS,UAAU,CAAC,YACpB,SAAS,UAAU,CAAC,YACpB,SAAS,UAAU,CAAC,UACpB;gBACA,OAAO;YACT;QACF;QAEA,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 2105, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/os.ts"],"sourcesContent":["import { stubTranslation as _ } from '@/utils/misc';\n\nexport const FILE_REVEAL_LABELS = {\n  macos: _('Reveal in Finder'),\n  windows: _('Reveal in File Explorer'),\n  linux: _('Reveal in Folder'),\n  default: _('Reveal in Folder'),\n};\n\nexport type FILE_REVEAL_PLATFORMS = keyof typeof FILE_REVEAL_LABELS;\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,qBAAqB;IAChC,OAAO,IAAA,oKAAC,EAAC;IACT,SAAS,IAAA,oKAAC,EAAC;IACX,OAAO,IAAA,oKAAC,EAAC;IACT,SAAS,IAAA,oKAAC,EAAC;AACb"}},
    {"offset": {"line": 2124, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/debounce.ts"],"sourcesContent":["interface DebounceOptions {\n  emitLast?: boolean;\n}\n\n/**\n * Debounces a function by waiting `delay` ms after the last call before executing it.\n * If `emitLast` is false, it cancels the call instead of delaying it.\n *\n * @returns A debounced function with additional `flush` and `cancel` methods.\n */\nexport const debounce = <T extends (...args: Parameters<T>) => void | Promise<void>>(\n  func: T,\n  delay: number,\n  options: DebounceOptions = { emitLast: true },\n): ((...args: Parameters<T>) => void) & { flush: () => void; cancel: () => void } => {\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  let lastArgs: Parameters<T> | null = null;\n\n  const debounced = (...args: Parameters<T>): void => {\n    lastArgs = args;\n    if (timeout) {\n      clearTimeout(timeout);\n    }\n\n    if (options.emitLast) {\n      timeout = setTimeout(() => {\n        if (lastArgs) {\n          func(...(lastArgs as Parameters<T>));\n          lastArgs = null;\n        }\n        timeout = null;\n      }, delay);\n    } else {\n      timeout = setTimeout(() => {\n        func(...args);\n        timeout = null;\n      }, delay);\n    }\n  };\n\n  /**\n   * Immediately executes the last pending debounced function call.\n   */\n  debounced.flush = () => {\n    if (timeout) {\n      clearTimeout(timeout);\n      timeout = null;\n      if (lastArgs) {\n        func(...(lastArgs as Parameters<T>));\n        lastArgs = null;\n      }\n    }\n  };\n\n  /**\n   * Cancels the pending debounced function call.\n   */\n  debounced.cancel = () => {\n    if (timeout) {\n      clearTimeout(timeout);\n      timeout = null;\n      lastArgs = null;\n    }\n  };\n\n  return debounced;\n};\n"],"names":[],"mappings":";;;;AAUO,MAAM,WAAW,CACtB,MACA,OACA,UAA2B;IAAE,UAAU;AAAK,CAAC;IAE7C,IAAI,UAAgD;IACpD,IAAI,WAAiC;IAErC,MAAM,YAAY,CAAC,GAAG;QACpB,WAAW;QACX,IAAI,SAAS;YACX,aAAa;QACf;QAEA,IAAI,QAAQ,QAAQ,EAAE;YACpB,UAAU,WAAW;gBACnB,IAAI,UAAU;oBACZ,QAAS;oBACT,WAAW;gBACb;gBACA,UAAU;YACZ,GAAG;QACL,OAAO;YACL,UAAU,WAAW;gBACnB,QAAQ;gBACR,UAAU;YACZ,GAAG;QACL;IACF;IAEA;;GAEC,GACD,UAAU,KAAK,GAAG;QAChB,IAAI,SAAS;YACX,aAAa;YACb,UAAU;YACV,IAAI,UAAU;gBACZ,QAAS;gBACT,WAAW;YACb;QACF;IACF;IAEA;;GAEC,GACD,UAAU,MAAM,GAAG;QACjB,IAAI,SAAS;YACX,aAAa;YACb,UAAU;YACV,WAAW;QACb;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 2183, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/highlightjs.ts"],"sourcesContent":["import { ViewSettings } from '@/types/book';\nimport hljs from 'highlight.js/lib/common';\n\nexport const CODE_LANGUAGES = [\n  'auto-detect',\n  'bash',\n  'c',\n  'cpp',\n  'csharp',\n  'css',\n  'diff',\n  'go',\n  'graphql',\n  'ini',\n  'java',\n  'javascript',\n  'json',\n  'kotlin',\n  'less',\n  'lua',\n  'makefile',\n  'markdown',\n  'objectivec',\n  'perl',\n  'php',\n  'php-t',\n  'python',\n  'python-r',\n  'r',\n  'ruby',\n  'rust',\n  'scss',\n  'shell',\n  'sql',\n  'swift',\n  'typescript',\n  'vbnet',\n  'wasm',\n  'xml',\n  'yaml',\n] as const;\n\nexport type CodeLanguage = (typeof CODE_LANGUAGES)[number];\n\n/** Toggle on or off the highlightjs stylesheet from the DOM and add relevant language styles */\nexport const manageSyntaxHighlighting = (doc: Document, viewSettings: ViewSettings) => {\n  const styleId = 'highlight-js-theme-style'; // arbitrary css id\n  const { codeHighlighting, codeLanguage } = viewSettings;\n\n  const existingStyleElement = doc.getElementById(styleId);\n  if (existingStyleElement) {\n    existingStyleElement.remove();\n  }\n\n  if (!codeHighlighting) {\n    // If disabling, remove the stylesheet and applied classes\n    const styleElement = doc.getElementById(styleId);\n    if (styleElement) styleElement.remove();\n    doc.querySelectorAll('pre').forEach((block) => {\n      if ((block as HTMLElement).dataset['highlighted']) {\n        block.innerHTML = block.textContent || '';\n      }\n    });\n    return;\n  }\n\n  const style = doc.createElement('style');\n  style.id = styleId;\n  style.textContent = getHighlightJsStyles();\n  doc.head.appendChild(style);\n\n  // Find all <pre> elements in available content\n  const codeBlocks = doc.querySelectorAll('pre');\n\n  // https://github.com/highlightjs/highlight.js/wiki/security\n  // I believe this is valid in this use case to ignore this warning.\n  hljs.configure({ ignoreUnescapedHTML: true });\n\n  codeBlocks.forEach((block) => {\n    // remove any previously applied classes by hljs\n    block.innerHTML = block.textContent || '';\n    block.className = block.className.replace(/language-\\S+/g, '');\n    block.classList.remove('hljs');\n    block.removeAttribute('data-highlighted');\n    if (codeLanguage && codeLanguage !== 'auto-detect') {\n      block.classList.add(`language-${codeLanguage}`);\n    }\n    hljs.highlightElement(block as HTMLElement);\n  });\n};\n\n/** Return either github light or dark theme */\nconst getHighlightJsStyles = () => {\n  // Potential improvement: add more themes following this pattern.\n  const githubLightTheme = `\n  pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!\n  Theme: GitHub\n  Description: Light theme as seen on github.com\n  Author: github.com\n  Maintainer: @Hirse\n  Updated: 2021-05-15\n\n  Outdated base version: https://github.com/primer/github-syntax-light\n  Current colors taken from GitHub's CSS\n  */.hljs{color:#24292e;background:#fff}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#d73a49}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#6f42c1}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-variable{color:#005cc5}.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#032f62}.hljs-built_in,.hljs-symbol{color:#e36209}.hljs-code,.hljs-comment,.hljs-formula{color:#6a737d}.hljs-name,.hljs-quote,.hljs-selector-pseudo,.hljs-selector-tag{color:#22863a}.hljs-subst{color:#24292e}.hljs-section{color:#005cc5;font-weight:700}.hljs-bullet{color:#735c0f}.hljs-emphasis{color:#24292e;font-style:italic}.hljs-strong{color:#24292e;font-weight:700}.hljs-addition{color:#22863a;background-color:#f0fff4}.hljs-deletion{color:#b31d28;background-color:#ffeef0}\n  `;\n  const githubDarkTheme = `\n  @media (prefers-color-scheme: dark) {\n    pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!\n    Theme: GitHub Dark\n    Description: Dark theme as seen on github.com\n    Author: github.com\n    Maintainer: @Hirse\n    Updated: 2021-05-15\n    \n    Outdated base version: https://github.com/primer/github-syntax-dark\n    Current colors taken from GitHub's CSS\n    */.hljs{color:#c9d1d9;background:#0d1117}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#ff7b72}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#d2a8ff}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-variable{color:#79c0ff}.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#a5d6ff}.hljs-built_in,.hljs-symbol{color:#ffa657}.hljs-code,.hljs-comment,.hljs-formula{color:#8b949e}.hljs-name,.hljs-quote,.hljs-selector-pseudo,.hljs-selector-tag{color:#7ee787}.hljs-subst{color:#c9d1d9}.hljs-section{color:#1f6feb;font-weight:700}.hljs-bullet{color:#f2cc60}.hljs-emphasis{color:#c9d1d9;font-style:italic}.hljs-strong{color:#c9d1d9;font-weight:700}.hljs-addition{color:#aff5b4;background-color:#033a16}.hljs-deletion{color:#ffdcd7;background-color:#67060c}\n  }`;\n  const githubTheme = `${githubLightTheme}\\n${githubDarkTheme}`;\n  return githubTheme;\n};\n"],"names":[],"mappings":";;;;;;AACA;;AAEO,MAAM,iBAAiB;IAC5B;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAKM,MAAM,2BAA2B,CAAC,KAAe;IACtD,MAAM,UAAU,4BAA4B,mBAAmB;IAC/D,MAAM,EAAE,gBAAgB,EAAE,YAAY,EAAE,GAAG;IAE3C,MAAM,uBAAuB,IAAI,cAAc,CAAC;IAChD,IAAI,sBAAsB;QACxB,qBAAqB,MAAM;IAC7B;IAEA,IAAI,CAAC,kBAAkB;QACrB,0DAA0D;QAC1D,MAAM,eAAe,IAAI,cAAc,CAAC;QACxC,IAAI,cAAc,aAAa,MAAM;QACrC,IAAI,gBAAgB,CAAC,OAAO,OAAO,CAAC,CAAC;YACnC,IAAI,AAAC,MAAsB,OAAO,CAAC,cAAc,EAAE;gBACjD,MAAM,SAAS,GAAG,MAAM,WAAW,IAAI;YACzC;QACF;QACA;IACF;IAEA,MAAM,QAAQ,IAAI,aAAa,CAAC;IAChC,MAAM,EAAE,GAAG;IACX,MAAM,WAAW,GAAG;IACpB,IAAI,IAAI,CAAC,WAAW,CAAC;IAErB,+CAA+C;IAC/C,MAAM,aAAa,IAAI,gBAAgB,CAAC;IAExC,4DAA4D;IAC5D,mEAAmE;IACnE,2OAAI,CAAC,SAAS,CAAC;QAAE,qBAAqB;IAAK;IAE3C,WAAW,OAAO,CAAC,CAAC;QAClB,gDAAgD;QAChD,MAAM,SAAS,GAAG,MAAM,WAAW,IAAI;QACvC,MAAM,SAAS,GAAG,MAAM,SAAS,CAAC,OAAO,CAAC,iBAAiB;QAC3D,MAAM,SAAS,CAAC,MAAM,CAAC;QACvB,MAAM,eAAe,CAAC;QACtB,IAAI,gBAAgB,iBAAiB,eAAe;YAClD,MAAM,SAAS,CAAC,GAAG,CAAC,CAAC,SAAS,EAAE,cAAc;QAChD;QACA,2OAAI,CAAC,gBAAgB,CAAC;IACxB;AACF;AAEA,6CAA6C,GAC7C,MAAM,uBAAuB;IAC3B,iEAAiE;IACjE,MAAM,mBAAmB,CAAC;;;;;;;;;;;EAW1B,CAAC;IACD,MAAM,kBAAkB,CAAC;;;;;;;;;;;;GAYxB,CAAC;IACF,MAAM,cAAc,GAAG,iBAAiB,EAAE,EAAE,iBAAiB;IAC7D,OAAO;AACT"}},
    {"offset": {"line": 2307, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/css.ts"],"sourcesContent":["export const validateCSS = (css: string): { isValid: boolean; error: string | null } => {\n  // Remove comments and normalize whitespace\n  css = css.replace(/\\/\\*[\\s\\S]*?\\*\\//g, '').trim();\n\n  // CSS property pattern (validate both property name and value)\n  const propertyPattern = /^[\\s\\n]*[-\\w]+\\s*:\\s*[^;]+;?$/;\n\n  // Check if empty\n  if (!css) return { isValid: false, error: 'Empty CSS' };\n\n  // Ensure balanced curly braces\n  const openBraces = (css.match(/{/g) || []).length;\n  const closeBraces = (css.match(/}/g) || []).length;\n  if (openBraces !== closeBraces) {\n    return { isValid: false, error: 'Unbalanced curly braces' };\n  }\n\n  const atRulePattern = /@[\\w-]+[^{]*\\{/g;\n  let result: RegExpExecArray | null;\n  let processedCss = '';\n  let lastIndex = 0;\n\n  while ((result = atRulePattern.exec(css)) !== null) {\n    const start = result.index;\n    const head = css.slice(lastIndex, start).trim();\n    if (head) processedCss += head + '\\n';\n\n    let i = atRulePattern.lastIndex;\n    let depth = 1;\n    while (i < css.length && depth > 0) {\n      if (css[i] === '{') depth++;\n      else if (css[i] === '}') depth--;\n      i++;\n    }\n    if (depth !== 0) return { isValid: false, error: 'Unbalanced curly braces in at-rule' };\n    const inner = css.slice(atRulePattern.lastIndex, i - 1).trim();\n    const innerResult = validateCSS(inner);\n    if (!innerResult.isValid) return innerResult;\n    lastIndex = i;\n  }\n\n  processedCss += css.slice(lastIndex).trim();\n  css = processedCss;\n\n  // Split into rule blocks\n  const blocks = css\n    .split('}')\n    .map((block) => block.trim())\n    .filter(Boolean);\n\n  for (const block of blocks) {\n    // Ensure the block has a selector and declarations\n    const parts = block.split('{').map((part) => part.trim());\n    if (parts.length !== 2) {\n      return { isValid: false, error: 'Invalid CSS structure' };\n    }\n\n    const [selector, decls] = parts;\n\n    // Ensure selector is not empty\n    if (!selector) {\n      return { isValid: false, error: 'Missing selector' };\n    }\n\n    // Ensure declarations are not empty\n    if (!decls) {\n      return { isValid: false, error: `Missing declarations for selector: ${selector}` };\n    }\n\n    // Validate declarations\n    const props = decls\n      .split(';')\n      .map((prop) => prop.trim())\n      .filter(Boolean);\n\n    if (props.length === 0) {\n      return { isValid: false, error: `No valid properties for selector: ${selector}` };\n    }\n\n    for (const prop of props) {\n      // Check if property is missing a name or value\n      if (!prop.includes(':')) {\n        return { isValid: false, error: `Missing property or value: ${prop}` };\n      }\n\n      const [name, value] = prop.split(':').map((part) => part.trim());\n      if (!name) {\n        return { isValid: false, error: `Missing property name: ${prop}` };\n      }\n      if (!value) {\n        return { isValid: false, error: `Missing property value: ${prop}` };\n      }\n\n      // Validate full property format\n      if (!propertyPattern.test(prop.endsWith(';') ? prop : prop + ';')) {\n        return { isValid: false, error: `Invalid property: ${prop}` };\n      }\n    }\n  }\n\n  return { isValid: true, error: null };\n};\n\nexport const formatCSS = (css: string): string => {\n  // Simple formatter: adds indentation and line breaks\n  const indent = '\\t';\n  let formatted = '';\n  let depth = 0;\n  let inComment = false;\n\n  css = css.replace(/\\s*\\n\\s*/g, '');\n  css = css.replace(/\\s{2,}/g, ' ').trim();\n  css = css.replace(/([^\\s{};][^{};]*:[^{};]+)\\s*}/g, '$1;}');\n\n  for (let i = 0; i < css.length; i++) {\n    const char = css[i];\n    const nextTwoChars = css.slice(i, i + 2);\n\n    if (nextTwoChars === '/*') {\n      inComment = true;\n      formatted += '\\n' + indent.repeat(depth) + '/*';\n      i++;\n      continue;\n    } else if (nextTwoChars === '*/' && inComment) {\n      inComment = false;\n      formatted += '*/\\n' + indent.repeat(depth);\n      i++;\n      continue;\n    }\n\n    if (inComment) {\n      formatted += char;\n      continue;\n    }\n\n    if (char === '{') {\n      depth++;\n      formatted += ' {\\n' + indent.repeat(depth);\n    } else if (char === '}') {\n      depth--;\n      formatted += '\\n' + indent.repeat(depth) + '}\\n' + indent.repeat(depth);\n    } else if (char === ';') {\n      formatted += ';\\n' + indent.repeat(depth);\n      while (css[i + 1] === ' ' || css[i + 1] === ';') i++;\n    } else {\n      formatted += char;\n    }\n  }\n\n  return formatted\n    .replace(/\\n([ \\t]*\\n)+/g, '\\n')\n    .replace(/[ ]{2,}/g, ' ')\n    .trim();\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2476, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/libs/document.ts"],"sourcesContent":["import { BookFormat } from '@/types/book';\nimport { Contributor, Identifier, LanguageMap } from '@/utils/book';\nimport * as epubcfi from 'foliate-js/epubcfi.js';\n\nexport const CFI = epubcfi;\n\nexport type DocumentFile = File;\n\nexport type Location = {\n  current: number;\n  next: number;\n  total: number;\n};\n\nexport interface TOCItem {\n  id: number;\n  label: string;\n  href: string;\n  cfi?: string;\n  location?: Location;\n  subitems?: TOCItem[];\n}\n\nexport interface SectionItem {\n  id: string;\n  cfi: string;\n  size: number;\n  linear: string;\n  location?: Location;\n  pageSpread?: 'left' | 'right' | 'center' | '';\n\n  createDocument: () => Promise<Document>;\n}\n\nexport type BookMetadata = {\n  // NOTE: the title and author fields should be formatted\n  title: string | LanguageMap;\n  author: string | Contributor;\n  language: string | string[];\n  editor?: string;\n  publisher?: string;\n  published?: string;\n  description?: string;\n  subject?: string | string[] | Contributor;\n  identifier?: string;\n  altIdentifier?: string | string[] | Identifier;\n\n  subtitle?: string;\n  series?: string;\n  seriesIndex?: number;\n  seriesTotal?: number;\n\n  coverImageFile?: string;\n  coverImageUrl?: string;\n  coverImageBlobUrl?: string;\n};\n\nexport interface BookDoc {\n  metadata: BookMetadata;\n  rendition?: {\n    layout?: 'pre-paginated' | 'reflowable';\n    spread?: 'auto' | 'none';\n    viewport?: { width: number; height: number };\n  };\n  dir: string;\n  toc?: Array<TOCItem>;\n  sections?: Array<SectionItem>;\n  transformTarget?: EventTarget;\n  splitTOCHref(href: string): Array<string | number>;\n  getCover(): Promise<Blob | null>;\n}\n\nexport const EXTS: Record<BookFormat, string> = {\n  EPUB: 'epub',\n  PDF: 'pdf',\n  MOBI: 'mobi',\n  AZW: 'azw',\n  AZW3: 'azw3',\n  CBZ: 'cbz',\n  FB2: 'fb2',\n  FBZ: 'fbz',\n  TXT: 'txt',\n  MD: 'md',\n};\n\nexport const MIMETYPES: Record<BookFormat, string[]> = {\n  EPUB: ['application/epub+zip'],\n  PDF: ['application/pdf'],\n  MOBI: ['application/x-mobipocket-ebook'],\n  AZW: ['application/vnd.amazon.ebook'],\n  AZW3: ['application/vnd.amazon.mobi8-ebook', 'application/x-mobi8-ebook'],\n  CBZ: ['application/vnd.comicbook+zip', 'application/zip', 'application/x-cbz'],\n  FB2: ['application/x-fictionbook+xml', 'text/xml', 'application/xml'],\n  FBZ: ['application/x-zip-compressed-fb2', 'application/zip'],\n  TXT: ['text/plain'],\n  MD: ['text/markdown', 'text/x-markdown'],\n};\n\nexport class DocumentLoader {\n  private file: File;\n\n  constructor(file: File) {\n    this.file = file;\n  }\n\n  private async isZip(): Promise<boolean> {\n    const arr = new Uint8Array(await this.file.slice(0, 4).arrayBuffer());\n    return arr[0] === 0x50 && arr[1] === 0x4b && arr[2] === 0x03 && arr[3] === 0x04;\n  }\n\n  private async isPDF(): Promise<boolean> {\n    const arr = new Uint8Array(await this.file.slice(0, 5).arrayBuffer());\n    return (\n      arr[0] === 0x25 && arr[1] === 0x50 && arr[2] === 0x44 && arr[3] === 0x46 && arr[4] === 0x2d\n    );\n  }\n\n  private async makeZipLoader() {\n    const getComment = async (): Promise<string | null> => {\n      const EOCD_SIGNATURE = [0x50, 0x4b, 0x05, 0x06];\n      const maxEOCDSearch = 1024 * 64;\n\n      const sliceSize = Math.min(maxEOCDSearch, this.file.size);\n      const tail = await this.file.slice(this.file.size - sliceSize, this.file.size).arrayBuffer();\n      const bytes = new Uint8Array(tail);\n\n      for (let i = bytes.length - 22; i >= 0; i--) {\n        if (\n          bytes[i] === EOCD_SIGNATURE[0] &&\n          bytes[i + 1] === EOCD_SIGNATURE[1] &&\n          bytes[i + 2] === EOCD_SIGNATURE[2] &&\n          bytes[i + 3] === EOCD_SIGNATURE[3]\n        ) {\n          const commentLength = bytes[i + 20]! + (bytes[i + 21]! << 8);\n          const commentStart = i + 22;\n          const commentBytes = bytes.slice(commentStart, commentStart + commentLength);\n          return new TextDecoder().decode(commentBytes);\n        }\n      }\n\n      return null;\n    };\n\n    const { configure, ZipReader, BlobReader, TextWriter, BlobWriter } = await import(\n      '@zip.js/zip.js'\n    );\n    type Entry = import('@zip.js/zip.js').Entry;\n    configure({ useWebWorkers: false });\n    const reader = new ZipReader(new BlobReader(this.file));\n    const entries = await reader.getEntries();\n    const map = new Map(entries.map((entry) => [entry.filename, entry]));\n    const load =\n      (f: (entry: Entry, type?: string) => Promise<string | Blob> | null) =>\n      (name: string, ...args: [string?]) =>\n        map.has(name) ? f(map.get(name)!, ...args) : null;\n\n    const loadText = load((entry: Entry) =>\n      entry.getData ? entry.getData(new TextWriter()) : null,\n    );\n    const loadBlob = load((entry: Entry, type?: string) =>\n      entry.getData ? entry.getData(new BlobWriter(type!)) : null,\n    );\n    const getSize = (name: string) => map.get(name)?.uncompressedSize ?? 0;\n\n    return { entries, loadText, loadBlob, getSize, getComment, sha1: undefined };\n  }\n\n  private isCBZ(): boolean {\n    return (\n      this.file.type === 'application/vnd.comicbook+zip' || this.file.name.endsWith(`.${EXTS.CBZ}`)\n    );\n  }\n\n  private isFB2(): boolean {\n    return (\n      this.file.type === 'application/x-fictionbook+xml' || this.file.name.endsWith(`.${EXTS.FB2}`)\n    );\n  }\n\n  private isFBZ(): boolean {\n    return (\n      this.file.type === 'application/x-zip-compressed-fb2' ||\n      this.file.name.endsWith('.fb.zip') ||\n      this.file.name.endsWith('.fb2.zip') ||\n      this.file.name.endsWith(`.${EXTS.FBZ}`)\n    );\n  }\n\n  public async open(): Promise<{ book: BookDoc; format: BookFormat }> {\n    let book = null;\n    let format: BookFormat = 'EPUB';\n    if (!this.file.size) {\n      throw new Error('File is empty');\n    }\n    try {\n      if (await this.isZip()) {\n        const loader = await this.makeZipLoader();\n        const { entries } = loader;\n\n        if (this.isCBZ()) {\n          const { makeComicBook } = await import('foliate-js/comic-book.js');\n          book = await makeComicBook(loader, this.file);\n          format = 'CBZ';\n        } else if (this.isFBZ()) {\n          const entry = entries.find((entry) => entry.filename.endsWith(`.${EXTS.FB2}`));\n          const blob = await loader.loadBlob((entry ?? entries[0]!).filename);\n          const { makeFB2 } = await import('foliate-js/fb2.js');\n          book = await makeFB2(blob);\n          format = 'FBZ';\n        } else {\n          const { EPUB } = await import('foliate-js/epub.js');\n          book = await new EPUB(loader).init();\n          format = 'EPUB';\n        }\n      } else if (await this.isPDF()) {\n        const { makePDF } = await import('foliate-js/pdf.js');\n        book = await makePDF(this.file);\n        format = 'PDF';\n      } else if (await (await import('foliate-js/mobi.js')).isMOBI(this.file)) {\n        const fflate = await import('foliate-js/vendor/fflate.js');\n        const { MOBI } = await import('foliate-js/mobi.js');\n        book = await new MOBI({ unzlib: fflate.unzlibSync }).open(this.file);\n        const ext = this.file.name.split('.').pop()?.toLowerCase();\n        switch (ext) {\n          case 'azw':\n            format = 'AZW';\n            break;\n          case 'azw3':\n            format = 'AZW3';\n            break;\n          default:\n            format = 'MOBI';\n        }\n      } else if (this.isFB2()) {\n        const { makeFB2 } = await import('foliate-js/fb2.js');\n        book = await makeFB2(this.file);\n        format = 'FB2';\n      }\n    } catch (e: unknown) {\n      console.error('Failed to open document:', e);\n      if (e instanceof Error && e.message?.includes('not a valid zip')) {\n        throw new Error('Unsupported or corrupted book file');\n      }\n      throw e;\n    }\n    return { book, format } as { book: BookDoc; format: BookFormat };\n  }\n}\n\nexport const getDirection = (doc: Document) => {\n  const { defaultView } = doc;\n  const { writingMode, direction } = defaultView!.getComputedStyle(doc.body);\n  const vertical = writingMode === 'vertical-rl' || writingMode === 'vertical-lr';\n  const rtl = doc.body.dir === 'rtl' || direction === 'rtl' || doc.documentElement.dir === 'rtl';\n  return { vertical, rtl };\n};\n\nexport const getFileExtFromMimeType = (mimeType?: string): string => {\n  if (!mimeType) return '';\n\n  for (const format in MIMETYPES) {\n    const list = MIMETYPES[format as BookFormat];\n    if (list.includes(mimeType)) {\n      return EXTS[format as BookFormat];\n    }\n  }\n  return '';\n};\n\nexport const getMimeTypeFromFileExt = (ext: string): string => {\n  ext = ext.toLowerCase();\n  for (const format in EXTS) {\n    if (EXTS[format as BookFormat] === ext) {\n      const mimeTypes = MIMETYPES[format as BookFormat];\n      return mimeTypes[0] || 'application/octet-stream';\n    }\n  }\n  return 'application/octet-stream';\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2714, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/libs/metadata.ts"],"sourcesContent":["import { MetadataResult, SearchRequest } from '@/services/metadata/types';\nimport { getAPIBaseUrl } from '@/services/environment';\nimport { fetchWithAuth } from '@/utils/fetch';\n\ninterface ApiResponse<T> {\n  success: boolean;\n  data?: T;\n  error?: string;\n  timestamp: string;\n  responseTime?: number;\n}\n\nconst API_ENDPOINT = getAPIBaseUrl() + '/metadata/search';\n\nexport const searchMetadata = async (request: SearchRequest): Promise<MetadataResult[]> => {\n  const response = await fetchWithAuth(API_ENDPOINT, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(request),\n  });\n\n  const result: ApiResponse<MetadataResult[]> = await response.json();\n\n  if (!result.success) {\n    throw new Error(result.error || 'Search failed');\n  }\n\n  return result.data || [];\n};\n"],"names":[],"mappings":";;;;AACA;AACA;;;AAUA,MAAM,eAAe,IAAA,4KAAa,MAAK;AAEhC,MAAM,iBAAiB,OAAO;IACnC,MAAM,WAAW,MAAM,IAAA,mKAAa,EAAC,cAAc;QACjD,QAAQ;QACR,SAAS;YACP,gBAAgB;QAClB;QACA,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,MAAM,SAAwC,MAAM,SAAS,IAAI;IAEjE,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,IAAI,MAAM,OAAO,KAAK,IAAI;IAClC;IAEA,OAAO,OAAO,IAAI,IAAI,EAAE;AAC1B"}},
    {"offset": {"line": 2744, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/libs/storage.ts"],"sourcesContent":["import { getAPIBaseUrl, isWebAppPlatform } from '@/services/environment';\nimport { AppService } from '@/types/system';\nimport { getUserID } from '@/utils/access';\nimport { fetchWithAuth } from '@/utils/fetch';\nimport {\n  tauriUpload,\n  tauriDownload,\n  webUpload,\n  webDownload,\n  ProgressHandler,\n  ProgressPayload,\n} from '@/utils/transfer';\n\nconst STORAGE_MODE = process.env['NEXT_PUBLIC_STORAGE_MODE'] || 'remote';\nconst isLocalStorageMode = STORAGE_MODE === 'local';\n\nconst API_ENDPOINTS = {\n  upload: getAPIBaseUrl() + '/storage/upload',\n  download: getAPIBaseUrl() + '/storage/download',\n  delete: getAPIBaseUrl() + '/storage/delete',\n  stats: getAPIBaseUrl() + '/storage/stats',\n  list: getAPIBaseUrl() + '/storage/list',\n  purge: getAPIBaseUrl() + '/storage/purge',\n  scan: getAPIBaseUrl() + '/storage/scan',\n  import: getAPIBaseUrl() + '/storage/import',\n};\n\nexport const createProgressHandler = (\n  totalFiles: number,\n  completedFilesRef: { count: number },\n  onProgress?: ProgressHandler,\n) => {\n  return (progress: ProgressPayload) => {\n    const fileProgress = progress.progress / progress.total;\n    const overallProgress = ((completedFilesRef.count + fileProgress) / totalFiles) * 100;\n\n    if (onProgress) {\n      onProgress({\n        progress: overallProgress,\n        total: 100,\n        transferSpeed: progress.transferSpeed,\n      });\n    }\n  };\n};\n\nconst request = async (url: string, options: RequestInit) => {\n  if (!isLocalStorageMode) {\n    return fetchWithAuth(url, options);\n  }\n\n  const res = await fetch(url, options);\n  if (!res.ok) {\n    let message = res.statusText;\n    try {\n      const data = await res.json();\n      message = data.error || message;\n    } catch { }\n    throw new Error(message || 'Request failed');\n  }\n  return res;\n};\n\nconst buildFileKey = async (cfp: string) => {\n  if (isLocalStorageMode) return cfp;\n  const userId = await getUserID();\n  if (!userId) {\n    throw new Error('Not authenticated');\n  }\n  return `${userId}/${cfp}`;\n};\n\nexport const uploadFile = async (\n  file: File,\n  fileFullPath: string,\n  onProgress?: ProgressHandler,\n  bookHash?: string,\n  temp = false,\n  cloudFilePath?: string,\n) => {\n  try {\n    const response = await request(API_ENDPOINTS.upload, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        fileName: file.name,\n        fileSize: file.size,\n        bookHash,\n        temp,\n        cloudPath: cloudFilePath,\n      }),\n    });\n\n    const { uploadUrl, downloadUrl }: { uploadUrl: string; downloadUrl?: string } =\n      await response.json();\n    if (isWebAppPlatform()) {\n      await webUpload(file, uploadUrl, onProgress);\n    } else {\n      await tauriUpload(uploadUrl, fileFullPath, 'PUT', onProgress);\n    }\n    return temp ? downloadUrl : undefined;\n  } catch (error) {\n    console.error('File upload failed:', error);\n    if (error instanceof Error) {\n      throw error;\n    }\n    throw new Error('File upload failed');\n  }\n};\n\nexport const batchGetDownloadUrls = async (files: { lfp: string; cfp: string }[]) => {\n  try {\n    const userId = isLocalStorageMode ? null : await getUserID();\n    if (!isLocalStorageMode && !userId) {\n      throw new Error('Not authenticated');\n    }\n    const filePaths = files.map((file) => file.cfp);\n    const fileKeys = filePaths.map((path) => (isLocalStorageMode ? path : `${userId}/${path}`));\n    const response = await request(`${API_ENDPOINTS.download}`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ fileKeys }),\n    });\n\n    const { downloadUrls } = await response.json();\n    return files.map((file) => {\n      const fileKey = isLocalStorageMode ? file.cfp : `${userId}/${file.cfp}`;\n      return {\n        lfp: file.lfp,\n        cfp: file.cfp,\n        downloadUrl: downloadUrls[fileKey],\n      };\n    });\n  } catch (error) {\n    console.error('Batch get download URLs failed:', error);\n    throw new Error('Batch get download URLs failed');\n  }\n};\n\ntype DownloadFileParams = {\n  appService: AppService;\n  dst: string;\n  cfp: string;\n  url?: string;\n  headers?: Record<string, string>;\n  singleThreaded?: boolean;\n  skipSslVerification?: boolean;\n  onProgress?: ProgressHandler;\n};\n\nexport const downloadFile = async ({\n  appService,\n  dst,\n  cfp,\n  url,\n  headers,\n  singleThreaded,\n  skipSslVerification,\n  onProgress,\n}: DownloadFileParams) => {\n  try {\n    let downloadUrl = url;\n    if (!downloadUrl) {\n      const fileKey = await buildFileKey(cfp);\n      const response = await request(\n        `${API_ENDPOINTS.download}?fileKey=${encodeURIComponent(fileKey)}`,\n        {\n          method: 'GET',\n        },\n      );\n\n      const { downloadUrl: url } = await response.json();\n      downloadUrl = url;\n    }\n\n    if (!downloadUrl) {\n      throw new Error('No download URL available');\n    }\n\n    if (isWebAppPlatform()) {\n      const { headers: responseHeaders, blob } = await webDownload(\n        downloadUrl,\n        onProgress,\n        headers,\n      );\n      await appService.writeFile(dst, 'None', await blob.arrayBuffer());\n      return responseHeaders;\n    } else {\n      return await tauriDownload(\n        downloadUrl,\n        dst,\n        onProgress,\n        headers,\n        undefined,\n        singleThreaded,\n        skipSslVerification,\n      );\n    }\n  } catch (error) {\n    console.error(`File '${dst}' download failed:`, error);\n    throw error;\n  }\n};\n\nexport const deleteFile = async (filePath: string) => {\n  try {\n    const fileKey = await buildFileKey(filePath);\n    await request(`${API_ENDPOINTS.delete}?fileKey=${encodeURIComponent(fileKey)}`, {\n      method: 'DELETE',\n    });\n  } catch (error) {\n    console.error('File deletion failed:', error);\n    throw new Error('File deletion failed');\n  }\n};\n\nexport interface StorageStats {\n  totalFiles: number;\n  totalSize: number;\n  usage: number;\n  quota: number;\n  usagePercentage: number;\n  byBookHash: Array<{\n    bookHash: string | null;\n    fileCount: number;\n    totalSize: number;\n  }>;\n}\n\nexport const getStorageStats = async (): Promise<StorageStats> => {\n  try {\n    const response = await request(API_ENDPOINTS.stats, {\n      method: 'GET',\n    });\n\n    return await response.json();\n  } catch (error) {\n    console.error('Get storage stats failed:', error);\n    throw new Error('Get storage stats failed');\n  }\n};\n\nexport interface FileRecord {\n  file_key: string;\n  file_size: number;\n  book_hash: string | null;\n  created_at: string;\n  updated_at: string | null;\n}\n\nexport interface ListFilesParams {\n  page?: number;\n  pageSize?: number;\n  sortBy?: 'created_at' | 'updated_at' | 'file_size' | 'file_key';\n  sortOrder?: 'asc' | 'desc';\n  bookHash?: string;\n  search?: string;\n}\n\ninterface ListFilesResponse {\n  files: FileRecord[];\n  total: number;\n  page: number;\n  pageSize: number;\n  totalPages: number;\n}\n\nexport const listFiles = async (params?: ListFilesParams): Promise<ListFilesResponse> => {\n  try {\n    const queryParams = new URLSearchParams();\n\n    if (params?.page) queryParams.set('page', params.page.toString());\n    if (params?.pageSize) queryParams.set('pageSize', params.pageSize.toString());\n    if (params?.sortBy) queryParams.set('sortBy', params.sortBy);\n    if (params?.sortOrder) queryParams.set('sortOrder', params.sortOrder);\n    if (params?.bookHash) queryParams.set('bookHash', params.bookHash);\n    if (params?.search) queryParams.set('search', params.search);\n\n    const url = queryParams.toString()\n      ? `${API_ENDPOINTS.list}?${queryParams.toString()}`\n      : API_ENDPOINTS.list;\n\n    const response = await request(url, {\n      method: 'GET',\n    });\n\n    return await response.json();\n  } catch (error) {\n    console.error('List files failed:', error);\n    throw new Error('List files failed');\n  }\n};\n\ninterface PurgeFilesResult {\n  success: string[];\n  failed: Array<{ fileKey: string; error: string }>;\n  deletedCount: number;\n  failedCount: number;\n}\n\nexport const purgeFiles = async (\n  filePathsOrKeys: string[],\n  isFileKeys = false,\n): Promise<PurgeFilesResult> => {\n  try {\n    let fileKeys: string[];\n\n    if (isFileKeys) {\n      fileKeys = filePathsOrKeys;\n    } else {\n      fileKeys = await Promise.all(filePathsOrKeys.map((path) => buildFileKey(path)));\n    }\n\n    const response = await request(API_ENDPOINTS.purge, {\n      method: 'DELETE',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({ fileKeys }),\n    });\n\n    return await response.json();\n  } catch (error) {\n    console.error('Purge files failed:', error);\n    throw new Error('Purge files failed');\n  }\n};\n\nexport interface ScannedBook {\n  filePath: string;\n  relativePath: string;\n  fileName: string;\n  directory: string;\n  size: number;\n  mtime: number;\n  ext: string;\n}\n\nexport const scanBooks = async (): Promise<{ count: number; books: ScannedBook[] }> => {\n  try {\n    const response = await request(API_ENDPOINTS.scan, {\n      method: 'POST',\n    });\n    return await response.json();\n  } catch (error) {\n    console.error('Scan books failed:', error);\n    throw new Error('Scan books failed');\n  }\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2986, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/transferStore.ts"],"sourcesContent":["import { create } from 'zustand';\n\nexport type TransferType = 'upload' | 'download' | 'delete';\nexport type TransferStatus = 'pending' | 'in_progress' | 'completed' | 'failed' | 'cancelled';\n\nexport interface TransferItem {\n  id: string;\n  bookHash: string;\n  bookTitle: string;\n  type: TransferType;\n  status: TransferStatus;\n  progress: number; // 0-100 percentage\n  totalBytes: number;\n  transferredBytes: number;\n  transferSpeed: number; // bytes per second\n  error?: string;\n  retryCount: number;\n  maxRetries: number;\n  createdAt: number;\n  startedAt?: number;\n  completedAt?: number;\n  priority: number; // Lower = higher priority\n  isBackground: boolean;\n}\n\ninterface TransferState {\n  transfers: Record<string, TransferItem>;\n  isQueuePaused: boolean;\n  isTransferQueueOpen: boolean;\n  maxConcurrent: number;\n  activeCount: number;\n\n  // UI Actions\n  setIsTransferQueueOpen: (isOpen: boolean) => void;\n\n  // Actions\n  addTransfer: (\n    bookHash: string,\n    bookTitle: string,\n    type: TransferType,\n    priority?: number,\n    isBackground?: boolean,\n  ) => string;\n  removeTransfer: (transferId: string) => void;\n  updateTransferProgress: (\n    transferId: string,\n    progress: number,\n    transferred: number,\n    total: number,\n    speed: number,\n  ) => void;\n  setTransferStatus: (transferId: string, status: TransferStatus, error?: string) => void;\n  retryTransfer: (transferId: string) => void;\n  incrementRetryCount: (transferId: string) => void;\n\n  // Queue control\n  pauseQueue: () => void;\n  resumeQueue: () => void;\n  clearCompleted: () => void;\n  clearFailed: () => void;\n  clearAll: () => void;\n\n  // Getters\n  getPendingTransfers: () => TransferItem[];\n  getActiveTransfers: () => TransferItem[];\n  getFailedTransfers: () => TransferItem[];\n  getCompletedTransfers: () => TransferItem[];\n  getTransferByBookHash: (bookHash: string, type: TransferType) => TransferItem | undefined;\n  getQueueStats: () => {\n    pending: number;\n    active: number;\n    completed: number;\n    failed: number;\n    total: number;\n  };\n\n  // Internal\n  setActiveCount: (count: number) => void;\n\n  // Persistence\n  restoreTransfers: (transfers: Record<string, TransferItem>, isQueuePaused: boolean) => void;\n}\n\nconst generateTransferId = (): string => {\n  return `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\n};\n\nexport const useTransferStore = create<TransferState>((set, get) => ({\n  transfers: {},\n  isQueuePaused: false,\n  isTransferQueueOpen: false,\n  maxConcurrent: 2,\n  activeCount: 0,\n\n  setIsTransferQueueOpen: (isOpen) => set({ isTransferQueueOpen: isOpen }),\n\n  addTransfer: (bookHash, bookTitle, type, priority = 10, isBackground = false) => {\n    const id = generateTransferId();\n    const transfer: TransferItem = {\n      id,\n      bookHash,\n      bookTitle,\n      type,\n      status: 'pending',\n      progress: 0,\n      totalBytes: 0,\n      transferredBytes: 0,\n      transferSpeed: 0,\n      retryCount: 0,\n      maxRetries: 3,\n      createdAt: Date.now(),\n      priority,\n      isBackground,\n    };\n\n    set((state) => ({\n      transfers: { ...state.transfers, [id]: transfer },\n    }));\n\n    return id;\n  },\n\n  removeTransfer: (transferId) => {\n    set((state) => {\n      const { [transferId]: _, ...remaining } = state.transfers;\n      return { transfers: remaining };\n    });\n  },\n\n  updateTransferProgress: (transferId, progress, transferred, total, speed) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: {\n            ...transfer,\n            progress,\n            transferredBytes: transferred,\n            totalBytes: total,\n            transferSpeed: speed,\n          },\n        },\n      };\n    });\n  },\n\n  setTransferStatus: (transferId, status, error) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      const updates: Partial<TransferItem> = { status, error };\n\n      if (status === 'in_progress' && !transfer.startedAt) {\n        updates.startedAt = Date.now();\n      }\n\n      if (status === 'completed' || status === 'failed' || status === 'cancelled') {\n        updates.completedAt = Date.now();\n      }\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: { ...transfer, ...updates },\n        },\n      };\n    });\n  },\n\n  retryTransfer: (transferId) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: {\n            ...transfer,\n            status: 'pending',\n            progress: 0,\n            transferredBytes: 0,\n            transferSpeed: 0,\n            error: undefined,\n            startedAt: undefined,\n            completedAt: undefined,\n          },\n        },\n      };\n    });\n  },\n\n  incrementRetryCount: (transferId) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: {\n            ...transfer,\n            retryCount: transfer.retryCount + 1,\n          },\n        },\n      };\n    });\n  },\n\n  pauseQueue: () => set({ isQueuePaused: true }),\n  resumeQueue: () => set({ isQueuePaused: false }),\n\n  clearCompleted: () => {\n    set((state) => {\n      const remaining: Record<string, TransferItem> = {};\n      Object.entries(state.transfers).forEach(([id, transfer]) => {\n        if (transfer.status !== 'completed') {\n          remaining[id] = transfer;\n        }\n      });\n      return { transfers: remaining };\n    });\n  },\n\n  clearFailed: () => {\n    set((state) => {\n      const remaining: Record<string, TransferItem> = {};\n      Object.entries(state.transfers).forEach(([id, transfer]) => {\n        if (transfer.status !== 'failed' && transfer.status !== 'cancelled') {\n          remaining[id] = transfer;\n        }\n      });\n      return { transfers: remaining };\n    });\n  },\n\n  clearAll: () => set({ transfers: {} }),\n\n  getPendingTransfers: () => {\n    return Object.values(get().transfers).filter((t) => t.status === 'pending');\n  },\n\n  getActiveTransfers: () => {\n    return Object.values(get().transfers).filter((t) => t.status === 'in_progress');\n  },\n\n  getFailedTransfers: () => {\n    return Object.values(get().transfers).filter(\n      (t) => t.status === 'failed' || t.status === 'cancelled',\n    );\n  },\n\n  getCompletedTransfers: () => {\n    return Object.values(get().transfers).filter((t) => t.status === 'completed');\n  },\n\n  getTransferByBookHash: (bookHash, type) => {\n    return Object.values(get().transfers).find(\n      (t) =>\n        t.bookHash === bookHash && t.type === type && ['pending', 'in_progress'].includes(t.status),\n    );\n  },\n\n  getQueueStats: () => {\n    const transfers = Object.values(get().transfers);\n    return {\n      pending: transfers.filter((t) => t.status === 'pending').length,\n      active: transfers.filter((t) => t.status === 'in_progress').length,\n      completed: transfers.filter((t) => t.status === 'completed').length,\n      failed: transfers.filter((t) => t.status === 'failed' || t.status === 'cancelled').length,\n      total: transfers.length,\n    };\n  },\n\n  setActiveCount: (count) => set({ activeCount: count }),\n\n  restoreTransfers: (transfers, isQueuePaused) => {\n    // Reset in_progress transfers to pending when restoring\n    const restoredTransfers: Record<string, TransferItem> = {};\n    Object.entries(transfers).forEach(([id, transfer]) => {\n      if (transfer.status === 'in_progress') {\n        restoredTransfers[id] = {\n          ...transfer,\n          status: 'pending',\n          progress: 0,\n          transferredBytes: 0,\n          transferSpeed: 0,\n        };\n      } else {\n        restoredTransfers[id] = transfer;\n      }\n    });\n    set({ transfers: restoredTransfers, isQueuePaused });\n  },\n}));\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3212, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/deviceStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { interceptKeys, getScreenBrightness, setScreenBrightness } from '@/utils/bridge';\nimport { eventDispatcher } from '@/utils/event';\nimport { NativeTouchEventType } from '@/types/system';\n\ndeclare global {\n  interface Window {\n    onNativeKeyDown?: (keyName: string) => void;\n    onNativeTouch?: (event: NativeTouchEventType) => void;\n  }\n}\n\nconst handleNativeKeyDown = (keyName: string) => {\n  if (keyName === 'VolumeUp' || keyName === 'VolumeDown') {\n    return eventDispatcher.dispatch('native-key-down', { keyName });\n  }\n  if (keyName === 'Back') {\n    return eventDispatcher.dispatchSync('native-key-down', { keyName });\n  }\n  return false;\n};\n\ntype DeviceControlState = {\n  volumeKeysIntercepted: boolean;\n  backKeyIntercepted: boolean;\n  volumeKeysInterceptionCount: number;\n  backKeyInterceptionCount: number;\n  getScreenBrightness: () => Promise<number>; // 0.0 to 1.0\n  setScreenBrightness: (brightness: number) => Promise<void>; // brightness: 0.0 to 1.0\n  acquireVolumeKeyInterception: () => void;\n  releaseVolumeKeyInterception: () => void;\n  acquireBackKeyInterception: () => void;\n  releaseBackKeyInterception: () => void;\n  listenToNativeTouchEvents: () => void;\n};\n\nexport const useDeviceControlStore = create<DeviceControlState>((set, get) => ({\n  volumeKeysIntercepted: false,\n  backKeyIntercepted: false,\n  volumeKeysInterceptionCount: 0,\n  backKeyInterceptionCount: 0,\n\n  acquireVolumeKeyInterception: () => {\n    const { volumeKeysInterceptionCount } = get();\n    if (volumeKeysInterceptionCount == 0) {\n      window.onNativeKeyDown = handleNativeKeyDown;\n      interceptKeys({ volumeKeys: true });\n      set({ volumeKeysIntercepted: true });\n    }\n    set({ volumeKeysInterceptionCount: volumeKeysInterceptionCount + 1 });\n  },\n\n  releaseVolumeKeyInterception: () => {\n    const { volumeKeysInterceptionCount } = get();\n    if (volumeKeysInterceptionCount <= 1) {\n      interceptKeys({ volumeKeys: false });\n      set({ volumeKeysIntercepted: false, volumeKeysInterceptionCount: 0 });\n    } else {\n      set({ volumeKeysInterceptionCount: volumeKeysInterceptionCount - 1 });\n    }\n  },\n\n  acquireBackKeyInterception: () => {\n    const { backKeyInterceptionCount } = get();\n    if (backKeyInterceptionCount == 0) {\n      window.onNativeKeyDown = handleNativeKeyDown;\n      interceptKeys({ backKey: true });\n      set({ backKeyIntercepted: true });\n    }\n    set({ backKeyInterceptionCount: backKeyInterceptionCount + 1 });\n  },\n\n  releaseBackKeyInterception: () => {\n    const { backKeyInterceptionCount } = get();\n    if (backKeyInterceptionCount <= 1) {\n      interceptKeys({ backKey: false });\n      set({ backKeyIntercepted: false, backKeyInterceptionCount: 0 });\n    } else {\n      set({ backKeyInterceptionCount: backKeyInterceptionCount - 1 });\n    }\n  },\n\n  listenToNativeTouchEvents: () => {\n    window.onNativeTouch = (event: NativeTouchEventType) => {\n      return eventDispatcher.dispatch('native-touch', event);\n    };\n  },\n\n  getScreenBrightness: async () => {\n    const res = await getScreenBrightness();\n    return res.brightness;\n  },\n\n  setScreenBrightness: async (brightness: number) => {\n    await setScreenBrightness({ brightness });\n  },\n}));\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAUA,MAAM,sBAAsB,CAAC;IAC3B,IAAI,YAAY,cAAc,YAAY,cAAc;QACtD,OAAO,qKAAe,CAAC,QAAQ,CAAC,mBAAmB;YAAE;QAAQ;IAC/D;IACA,IAAI,YAAY,QAAQ;QACtB,OAAO,qKAAe,CAAC,YAAY,CAAC,mBAAmB;YAAE;QAAQ;IACnE;IACA,OAAO;AACT;AAgBO,MAAM,wBAAwB,IAAA,mQAAM,EAAqB,CAAC,KAAK,MAAQ,CAAC;QAC7E,uBAAuB;QACvB,oBAAoB;QACpB,6BAA6B;QAC7B,0BAA0B;QAE1B,8BAA8B;YAC5B,MAAM,EAAE,2BAA2B,EAAE,GAAG;YACxC,IAAI,+BAA+B,GAAG;gBACpC,OAAO,eAAe,GAAG;gBACzB,IAAA,oKAAa,EAAC;oBAAE,YAAY;gBAAK;gBACjC,IAAI;oBAAE,uBAAuB;gBAAK;YACpC;YACA,IAAI;gBAAE,6BAA6B,8BAA8B;YAAE;QACrE;QAEA,8BAA8B;YAC5B,MAAM,EAAE,2BAA2B,EAAE,GAAG;YACxC,IAAI,+BAA+B,GAAG;gBACpC,IAAA,oKAAa,EAAC;oBAAE,YAAY;gBAAM;gBAClC,IAAI;oBAAE,uBAAuB;oBAAO,6BAA6B;gBAAE;YACrE,OAAO;gBACL,IAAI;oBAAE,6BAA6B,8BAA8B;gBAAE;YACrE;QACF;QAEA,4BAA4B;YAC1B,MAAM,EAAE,wBAAwB,EAAE,GAAG;YACrC,IAAI,4BAA4B,GAAG;gBACjC,OAAO,eAAe,GAAG;gBACzB,IAAA,oKAAa,EAAC;oBAAE,SAAS;gBAAK;gBAC9B,IAAI;oBAAE,oBAAoB;gBAAK;YACjC;YACA,IAAI;gBAAE,0BAA0B,2BAA2B;YAAE;QAC/D;QAEA,4BAA4B;YAC1B,MAAM,EAAE,wBAAwB,EAAE,GAAG;YACrC,IAAI,4BAA4B,GAAG;gBACjC,IAAA,oKAAa,EAAC;oBAAE,SAAS;gBAAM;gBAC/B,IAAI;oBAAE,oBAAoB;oBAAO,0BAA0B;gBAAE;YAC/D,OAAO;gBACL,IAAI;oBAAE,0BAA0B,2BAA2B;gBAAE;YAC/D;QACF;QAEA,2BAA2B;YACzB,OAAO,aAAa,GAAG,CAAC;gBACtB,OAAO,qKAAe,CAAC,QAAQ,CAAC,gBAAgB;YAClD;QACF;QAEA,qBAAqB;YACnB,MAAM,MAAM,MAAM,IAAA,0KAAmB;YACrC,OAAO,IAAI,UAAU;QACvB;QAEA,qBAAqB,OAAO;YAC1B,MAAM,IAAA,0KAAmB,EAAC;gBAAE;YAAW;QACzC;IACF,CAAC"}},
    {"offset": {"line": 3324, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/libraryStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { Book, BookGroupType, BooksGroup } from '@/types/book';\nimport { EnvConfigType, isTauriAppPlatform } from '@/services/environment';\nimport { BOOK_UNGROUPED_NAME } from '@/services/constants';\nimport { md5Fingerprint } from '@/utils/md5';\n\ninterface LibraryState {\n  library: Book[]; // might contain deleted books\n  isSyncing: boolean;\n  syncProgress: number;\n  checkOpenWithBooks: boolean;\n  checkLastOpenBooks: boolean;\n  currentBookshelf: (Book | BooksGroup)[];\n  selectedBooks: Set<string>; // hashes for books, ids for groups\n  groups: Record<string, string>;\n  setIsSyncing: (syncing: boolean) => void;\n  setSyncProgress: (progress: number) => void;\n  setSelectedBooks: (ids: string[]) => void;\n  getSelectedBooks: () => string[];\n  toggleSelectedBook: (id: string) => void;\n  getVisibleLibrary: () => Book[];\n  setCheckOpenWithBooks: (check: boolean) => void;\n  setCheckLastOpenBooks: (check: boolean) => void;\n  setLibrary: (books: Book[]) => void;\n  updateBook: (envConfig: EnvConfigType, book: Book) => void;\n  updateBooks: (envConfig: EnvConfigType, books: Book[]) => void;\n  setCurrentBookshelf: (bookshelf: (Book | BooksGroup)[]) => void;\n  refreshGroups: () => void;\n  addGroup: (name: string) => BookGroupType;\n  getGroups: () => BookGroupType[];\n  getGroupId: (path: string) => string | undefined;\n  getGroupName: (id: string) => string | undefined;\n  getParentPath: (path: string) => string | undefined;\n  getGroupsByParent: (parentPath?: string) => BookGroupType[];\n}\n\nexport const useLibraryStore = create<LibraryState>((set, get) => ({\n  library: [],\n  isSyncing: false,\n  syncProgress: 0,\n  currentBookshelf: [],\n  selectedBooks: new Set(),\n  groups: {},\n  checkOpenWithBooks: isTauriAppPlatform(),\n  checkLastOpenBooks: isTauriAppPlatform(),\n\n  setIsSyncing: (syncing: boolean) => set({ isSyncing: syncing }),\n  setSyncProgress: (progress: number) => set({ syncProgress: progress }),\n  getVisibleLibrary: () => get().library.filter((book) => !book.deletedAt),\n\n  setCurrentBookshelf: (bookshelf: (Book | BooksGroup)[]) => {\n    set({ currentBookshelf: bookshelf });\n  },\n\n  setCheckOpenWithBooks: (check) => set({ checkOpenWithBooks: check }),\n  setCheckLastOpenBooks: (check) => set({ checkLastOpenBooks: check }),\n  setLibrary: (books) => {\n    const { refreshGroups } = get();\n    set({ library: books });\n    refreshGroups();\n  },\n  updateBook: async (envConfig: EnvConfigType, book: Book) => {\n    const appService = await envConfig.getAppService();\n    const { library } = get();\n    const bookIndex = library.findIndex((b) => b.hash === book.hash);\n    if (bookIndex !== -1) {\n      library[bookIndex] = book;\n    }\n    set({ library: [...library] });\n    await appService.saveLibraryBooks(library);\n  },\n  updateBooks: async (envConfig: EnvConfigType, books: Book[]) => {\n    if (!books?.length) return;\n\n    const appService = await envConfig.getAppService();\n    const { library, refreshGroups } = get();\n\n    const newLibrary = Array.from(new Map([...library, ...books].map((b) => [b.hash, b])).values());\n    set({ library: newLibrary });\n    refreshGroups();\n    await appService.saveLibraryBooks(newLibrary);\n  },\n\n  setSelectedBooks: (ids: string[]) => {\n    set({ selectedBooks: new Set(ids) });\n  },\n\n  getSelectedBooks: () => {\n    return Array.from(get().selectedBooks);\n  },\n\n  toggleSelectedBook: (id: string) => {\n    set((state) => {\n      const newSelection = new Set(state.selectedBooks);\n      if (newSelection.has(id)) {\n        newSelection.delete(id);\n      } else {\n        newSelection.add(id);\n      }\n      return { selectedBooks: newSelection };\n    });\n  },\n\n  refreshGroups: () => {\n    const { library } = get();\n    const groups: Record<string, string> = {};\n\n    library.forEach((book) => {\n      if (book.groupName && book.groupName !== BOOK_UNGROUPED_NAME && !book.deletedAt) {\n        groups[md5Fingerprint(book.groupName)] = book.groupName;\n        let nextSlashIndex = book.groupName.indexOf('/', 0);\n        while (nextSlashIndex > 0) {\n          const groupName = book.groupName.substring(0, nextSlashIndex);\n          groups[md5Fingerprint(groupName)] = groupName;\n          nextSlashIndex = book.groupName.indexOf('/', nextSlashIndex + 1);\n        }\n      }\n    });\n\n    set({ groups });\n  },\n\n  addGroup: (name: string) => {\n    const trimmedName = name.trim();\n    if (!trimmedName) {\n      throw new Error('Group name cannot be empty');\n    }\n\n    const id = md5Fingerprint(trimmedName);\n    const { groups } = get();\n\n    set({ groups: { ...groups, [id]: trimmedName } });\n\n    return { id, name: trimmedName };\n  },\n\n  getGroups: () => {\n    const { groups } = get();\n    return Object.entries(groups)\n      .map(([id, name]) => ({ id, name }))\n      .sort((a, b) => a.name.localeCompare(b.name));\n  },\n\n  getGroupId: (path: string) => {\n    const { groups } = get();\n\n    const directId = Object.entries(groups).find(([_, name]) => name === path)?.[0];\n    if (directId) {\n      return directId;\n    }\n\n    return md5Fingerprint(path);\n  },\n\n  getGroupName: (id: string) => {\n    return get().groups[id];\n  },\n\n  getParentPath: (path: string) => {\n    const lastSlashIndex = path.lastIndexOf('/');\n    if (lastSlashIndex === -1) return '';\n    return path.slice(0, lastSlashIndex);\n  },\n\n  getGroupsByParent: (parentPath?: string) => {\n    const { groups } = get();\n    const result: BookGroupType[] = [];\n    Object.entries(groups).forEach(([id, name]) => {\n      const groupParentPath = get().getParentPath(name);\n      if (groupParentPath === (parentPath || '')) {\n        result.push({ id, name });\n      }\n    });\n    return result;\n  },\n}));\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3503, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/bookDataStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { SystemSettings } from '@/types/settings';\nimport { Book, BookConfig, BookNote } from '@/types/book';\nimport { EnvConfigType } from '@/services/environment';\nimport { BookDoc } from '@/libs/document';\nimport { useLibraryStore } from './libraryStore';\n\ninterface BookData {\n  /* Persistent data shared with different views of the same book */\n  id: string;\n  book: Book | null;\n  file: File | null;\n  config: BookConfig | null;\n  bookDoc: BookDoc | null;\n  isFixedLayout: boolean;\n}\n\ninterface BookDataState {\n  booksData: { [id: string]: BookData };\n  getConfig: (key: string | null) => BookConfig | null;\n  setConfig: (key: string, partialConfig: Partial<BookConfig>) => void;\n  saveConfig: (\n    envConfig: EnvConfigType,\n    bookKey: string,\n    config: BookConfig,\n    settings: SystemSettings,\n  ) => void;\n  updateBooknotes: (key: string, booknotes: BookNote[]) => BookConfig | undefined;\n  getBookData: (keyOrId: string) => BookData | null;\n  clearBookData: (keyOrId: string) => void;\n}\n\nexport const useBookDataStore = create<BookDataState>((set, get) => ({\n  booksData: {},\n  getBookData: (keyOrId: string) => {\n    const id = keyOrId.split('-')[0]!;\n    return get().booksData[id] || null;\n  },\n  clearBookData: (keyOrId: string) => {\n    const id = keyOrId.split('-')[0]!;\n    set((state) => {\n      const newBooksData = { ...state.booksData };\n      delete newBooksData[id];\n      return {\n        booksData: newBooksData,\n      };\n    });\n  },\n  getConfig: (key: string | null) => {\n    if (!key) return null;\n    const id = key.split('-')[0]!;\n    return get().booksData[id]?.config || null;\n  },\n  setConfig: (key: string, partialConfig: Partial<BookConfig>) => {\n    set((state: BookDataState) => {\n      const id = key.split('-')[0]!;\n      const config = (state.booksData[id]?.config || null) as BookConfig;\n      if (!config) {\n        console.warn('No config found for book', id);\n        return state;\n      }\n      Object.assign(config, partialConfig);\n      return {\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...state.booksData[id]!,\n            config,\n          },\n        },\n      };\n    });\n  },\n  saveConfig: async (\n    envConfig: EnvConfigType,\n    bookKey: string,\n    config: BookConfig,\n    settings: SystemSettings,\n  ) => {\n    const appService = await envConfig.getAppService();\n    const { library, setLibrary } = useLibraryStore.getState();\n    const bookIndex = library.findIndex((b) => b.hash === bookKey.split('-')[0]);\n    if (bookIndex == -1) return;\n    const book = library.splice(bookIndex, 1)[0]!;\n    book.progress = config.progress;\n    book.updatedAt = Date.now();\n    book.downloadedAt = book.downloadedAt || Date.now();\n    library.unshift(book);\n    setLibrary([...library]);\n    config.updatedAt = Date.now();\n    await appService.saveBookConfig(book, config, settings);\n    await appService.saveLibraryBooks(library);\n  },\n  updateBooknotes: (key: string, booknotes: BookNote[]) => {\n    let updatedConfig: BookConfig | undefined;\n    set((state) => {\n      const id = key.split('-')[0]!;\n      const book = state.booksData[id];\n      if (!book) return state;\n      const dedupedBooknotes = Array.from(\n        new Map(booknotes.map((item) => [`${item.id}-${item.type}-${item.cfi}`, item])).values(),\n      );\n      updatedConfig = {\n        ...book.config,\n        updatedAt: Date.now(),\n        booknotes: dedupedBooknotes,\n      };\n      return {\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...book,\n            config: {\n              ...book.config,\n              updatedAt: Date.now(),\n              booknotes: dedupedBooknotes,\n            },\n          },\n        },\n      };\n    });\n    return updatedConfig;\n  },\n}));\n"],"names":[],"mappings":";;;;AAAA;AAKA;;;AA2BO,MAAM,mBAAmB,IAAA,mQAAM,EAAgB,CAAC,KAAK,MAAQ,CAAC;QACnE,WAAW,CAAC;QACZ,aAAa,CAAC;YACZ,MAAM,KAAK,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE;YAChC,OAAO,MAAM,SAAS,CAAC,GAAG,IAAI;QAChC;QACA,eAAe,CAAC;YACd,MAAM,KAAK,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE;YAChC,IAAI,CAAC;gBACH,MAAM,eAAe;oBAAE,GAAG,MAAM,SAAS;gBAAC;gBAC1C,OAAO,YAAY,CAAC,GAAG;gBACvB,OAAO;oBACL,WAAW;gBACb;YACF;QACF;QACA,WAAW,CAAC;YACV,IAAI,CAAC,KAAK,OAAO;YACjB,MAAM,KAAK,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE;YAC5B,OAAO,MAAM,SAAS,CAAC,GAAG,EAAE,UAAU;QACxC;QACA,WAAW,CAAC,KAAa;YACvB,IAAI,CAAC;gBACH,MAAM,KAAK,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE;gBAC5B,MAAM,SAAU,MAAM,SAAS,CAAC,GAAG,EAAE,UAAU;gBAC/C,IAAI,CAAC,QAAQ;oBACX,QAAQ,IAAI,CAAC,4BAA4B;oBACzC,OAAO;gBACT;gBACA,OAAO,MAAM,CAAC,QAAQ;gBACtB,OAAO;oBACL,WAAW;wBACT,GAAG,MAAM,SAAS;wBAClB,CAAC,GAAG,EAAE;4BACJ,GAAG,MAAM,SAAS,CAAC,GAAG;4BACtB;wBACF;oBACF;gBACF;YACF;QACF;QACA,YAAY,OACV,WACA,SACA,QACA;YAEA,MAAM,aAAa,MAAM,UAAU,aAAa;YAChD,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,4KAAe,CAAC,QAAQ;YACxD,MAAM,YAAY,QAAQ,SAAS,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE;YAC3E,IAAI,aAAa,CAAC,GAAG;YACrB,MAAM,OAAO,QAAQ,MAAM,CAAC,WAAW,EAAE,CAAC,EAAE;YAC5C,KAAK,QAAQ,GAAG,OAAO,QAAQ;YAC/B,KAAK,SAAS,GAAG,KAAK,GAAG;YACzB,KAAK,YAAY,GAAG,KAAK,YAAY,IAAI,KAAK,GAAG;YACjD,QAAQ,OAAO,CAAC;YAChB,WAAW;mBAAI;aAAQ;YACvB,OAAO,SAAS,GAAG,KAAK,GAAG;YAC3B,MAAM,WAAW,cAAc,CAAC,MAAM,QAAQ;YAC9C,MAAM,WAAW,gBAAgB,CAAC;QACpC;QACA,iBAAiB,CAAC,KAAa;YAC7B,IAAI;YACJ,IAAI,CAAC;gBACH,MAAM,KAAK,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE;gBAC5B,MAAM,OAAO,MAAM,SAAS,CAAC,GAAG;gBAChC,IAAI,CAAC,MAAM,OAAO;gBAClB,MAAM,mBAAmB,MAAM,IAAI,CACjC,IAAI,IAAI,UAAU,GAAG,CAAC,CAAC,OAAS;wBAAC,GAAG,KAAK,EAAE,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,CAAC,EAAE,KAAK,GAAG,EAAE;wBAAE;qBAAK,GAAG,MAAM;gBAExF,gBAAgB;oBACd,GAAG,KAAK,MAAM;oBACd,WAAW,KAAK,GAAG;oBACnB,WAAW;gBACb;gBACA,OAAO;oBACL,WAAW;wBACT,GAAG,MAAM,SAAS;wBAClB,CAAC,GAAG,EAAE;4BACJ,GAAG,IAAI;4BACP,QAAQ;gCACN,GAAG,KAAK,MAAM;gCACd,WAAW,KAAK,GAAG;gCACnB,WAAW;4BACb;wBACF;oBACF;gBACF;YACF;YACA,OAAO;QACT;IACF,CAAC"}},
    {"offset": {"line": 3610, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/readerStore.ts"],"sourcesContent":["import { create } from 'zustand';\n\nimport {\n  BookContent,\n  BookConfig,\n  PageInfo,\n  BookProgress,\n  ViewSettings,\n  TimeInfo,\n  FIXED_LAYOUT_FORMATS,\n} from '@/types/book';\nimport { Insets } from '@/types/misc';\nimport { EnvConfigType } from '@/services/environment';\nimport { FoliateView } from '@/types/view';\nimport { DocumentLoader, TOCItem } from '@/libs/document';\nimport { updateToc } from '@/utils/toc';\nimport { formatTitle, getMetadataHash, getPrimaryLanguage } from '@/utils/book';\nimport { getBaseFilename } from '@/utils/path';\nimport { SUPPORTED_LANGNAMES } from '@/services/constants';\nimport { useSettingsStore } from './settingsStore';\nimport { useBookDataStore } from './bookDataStore';\nimport { useLibraryStore } from './libraryStore';\nimport { uniqueId } from '@/utils/misc';\n\ninterface ViewState {\n  /* Unique key for each book view */\n  key: string;\n  view: FoliateView | null;\n  viewerKey: string;\n  isPrimary: boolean;\n  loading: boolean;\n  inited: boolean;\n  error: string | null;\n  progress: BookProgress | null;\n  ribbonVisible: boolean;\n  ttsEnabled: boolean;\n  syncing: boolean;\n  gridInsets: Insets | null;\n  /* View settings for the view: \n    generally view settings have a hierarchy of global settings < book settings < view settings\n    view settings for primary view are saved to book config which is persisted to config file\n    omitting settings that are not changed from global settings */\n  viewSettings: ViewSettings | null;\n}\n\ninterface ReaderStore {\n  viewStates: { [key: string]: ViewState };\n  bookKeys: string[];\n  hoveredBookKey: string | null;\n  setBookKeys: (keys: string[]) => void;\n  setHoveredBookKey: (key: string | null) => void;\n  setBookmarkRibbonVisibility: (key: string, visible: boolean) => void;\n  setTTSEnabled: (key: string, enabled: boolean) => void;\n  setIsSyncing: (key: string, syncing: boolean) => void;\n  setProgress: (\n    key: string,\n    location: string,\n    tocItem: TOCItem,\n    section: PageInfo,\n    pageinfo: PageInfo,\n    timeinfo: TimeInfo,\n    range: Range,\n  ) => void;\n  getProgress: (key: string) => BookProgress | null;\n  setView: (key: string, view: FoliateView) => void;\n  getView: (key: string | null) => FoliateView | null;\n  getViews: () => FoliateView[];\n  getViewsById: (id: string) => FoliateView[];\n  setViewSettings: (key: string, viewSettings: ViewSettings) => void;\n  getViewSettings: (key: string) => ViewSettings | null;\n\n  initViewState: (\n    envConfig: EnvConfigType,\n    id: string,\n    key: string,\n    isPrimary?: boolean,\n    reload?: boolean,\n  ) => Promise<void>;\n  clearViewState: (key: string) => void;\n  getViewState: (key: string) => ViewState | null;\n  getGridInsets: (key: string) => Insets | null;\n  setGridInsets: (key: string, insets: Insets | null) => void;\n  setViewInited: (key: string, inited: boolean) => void;\n  recreateViewer: (envConfig: EnvConfigType, key: string) => void;\n}\n\nexport const useReaderStore = create<ReaderStore>((set, get) => ({\n  viewStates: {},\n  bookKeys: [],\n  hoveredBookKey: null,\n  setBookKeys: (keys: string[]) => set({ bookKeys: keys }),\n  setHoveredBookKey: (key: string | null) => set({ hoveredBookKey: key }),\n  getView: (key: string | null) => (key && get().viewStates[key]?.view) || null,\n  setView: (key: string, view) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: { ...state.viewStates[key]!, view },\n      },\n    })),\n  getViews: () => Object.values(get().viewStates).map((state) => state.view!),\n  getViewsById: (id: string) => {\n    const { viewStates } = get();\n    return Object.values(viewStates)\n      .filter((state) => state.key && state.key.startsWith(id))\n      .map((state) => state.view!);\n  },\n\n  clearViewState: (key: string) => {\n    set((state) => {\n      const viewStates = { ...state.viewStates };\n      delete viewStates[key];\n      return { viewStates };\n    });\n  },\n  getViewState: (key: string) => get().viewStates[key] || null,\n  initViewState: async (\n    envConfig: EnvConfigType,\n    id: string,\n    key: string,\n    isPrimary = true,\n    reload = false,\n  ) => {\n    const booksData = useBookDataStore.getState().booksData;\n    const bookData = booksData[id];\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          key: '',\n          view: null,\n          viewerKey: '',\n          isPrimary: false,\n          loading: true,\n          inited: false,\n          error: null,\n          progress: null,\n          ribbonVisible: false,\n          ttsEnabled: false,\n          syncing: false,\n          gridInsets: null,\n          viewSettings: null,\n        },\n      },\n    }));\n    try {\n      const appService = await envConfig.getAppService();\n      const { settings } = useSettingsStore.getState();\n      const { library } = useLibraryStore.getState();\n      const book = library.find((b) => b.hash === id);\n      if (!book) {\n        throw new Error('Book not found');\n      }\n      let bookDoc = bookData?.bookDoc;\n      let file = bookData?.file;\n      if (!bookDoc || !file || reload) {\n        const content = (await appService.loadBookContent(book)) as BookContent;\n        file = content.file;\n        console.log('Loading book', key);\n        const doc = await new DocumentLoader(file).open();\n        bookDoc = doc.book;\n      }\n      const config = await appService.loadBookConfig(book, settings);\n      await updateToc(\n        bookDoc,\n        config.viewSettings?.sortedTOC ?? false,\n        config.viewSettings?.convertChineseVariant ?? 'none',\n      );\n      if (!bookDoc.metadata.title) {\n        bookDoc.metadata.title = getBaseFilename(file.name);\n      }\n      book.sourceTitle = formatTitle(bookDoc.metadata.title);\n      // Correct language codes mistakenly set with language names\n      if (typeof bookDoc.metadata?.language === 'string') {\n        if (bookDoc.metadata.language in SUPPORTED_LANGNAMES) {\n          bookDoc.metadata.language = SUPPORTED_LANGNAMES[bookDoc.metadata.language]!;\n        }\n      }\n      // Set the book's language for formerly imported books, newly imported books have this field set\n      const primaryLanguage = getPrimaryLanguage(bookDoc.metadata.language);\n      book.primaryLanguage = book.primaryLanguage ?? primaryLanguage;\n      book.metadata = book.metadata ?? bookDoc.metadata;\n      // TODO: uncomment this when we can ensure metaHash is correctly generated for all books\n      // book.metaHash = book.metaHash ?? getMetadataHash(bookDoc.metadata);\n      book.metaHash = getMetadataHash(bookDoc.metadata);\n\n      const isFixedLayout = FIXED_LAYOUT_FORMATS.has(book.format);\n      useBookDataStore.setState((state) => ({\n        booksData: {\n          ...state.booksData,\n          [id]: { id, book, file, config, bookDoc, isFixedLayout },\n        },\n      }));\n      const configViewSettings = config.viewSettings!;\n      const globalViewSettings = settings.globalViewSettings;\n      set((state) => ({\n        viewStates: {\n          ...state.viewStates,\n          [key]: {\n            ...state.viewStates[key],\n            key,\n            view: null,\n            viewerKey: `${key}-${uniqueId()}`,\n            isPrimary,\n            loading: false,\n            inited: false,\n            error: null,\n            progress: null,\n            ribbonVisible: false,\n            ttsEnabled: false,\n            syncing: false,\n            gridInsets: null,\n            viewSettings: { ...globalViewSettings, ...configViewSettings },\n          },\n        },\n      }));\n    } catch (error) {\n      console.error(error);\n      set((state) => ({\n        viewStates: {\n          ...state.viewStates,\n          [key]: {\n            ...state.viewStates[key],\n            key: '',\n            view: null,\n            viewerKey: '',\n            isPrimary: false,\n            loading: false,\n            inited: false,\n            error: 'Failed to load book.',\n            progress: null,\n            ribbonVisible: false,\n            ttsEnabled: false,\n            syncing: false,\n            gridInsets: null,\n            viewSettings: null,\n          },\n        },\n      }));\n      throw error;\n    }\n  },\n  getViewSettings: (key: string) => get().viewStates[key]?.viewSettings || null,\n  setViewSettings: (key: string, viewSettings: ViewSettings) => {\n    if (!key) return;\n    const id = key.split('-')[0]!;\n    const bookData = useBookDataStore.getState().booksData[id];\n    const viewState = get().viewStates[key];\n    if (!viewState || !bookData) return;\n    if (viewState.isPrimary) {\n      useBookDataStore.setState((state) => ({\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...bookData,\n            config: {\n              ...bookData.config,\n              updatedAt: Date.now(),\n              viewSettings,\n            },\n          },\n        },\n      }));\n    }\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          viewSettings,\n        },\n      },\n    }));\n  },\n  getProgress: (key: string) => get().viewStates[key]?.progress || null,\n  setProgress: (\n    key: string,\n    location: string,\n    tocItem: TOCItem,\n    section: PageInfo,\n    pageinfo: PageInfo,\n    timeinfo: TimeInfo,\n    range: Range,\n  ) =>\n    set((state) => {\n      const id = key.split('-')[0]!;\n      const bookData = useBookDataStore.getState().booksData[id];\n      const viewState = state.viewStates[key];\n      if (!viewState || !bookData) return state;\n\n      const pagePressInfo = bookData.isFixedLayout ? section : pageinfo;\n      const progress: [number, number] = [pagePressInfo.current + 1, pagePressInfo.total];\n\n      // Update library book progress\n      const { library, setLibrary } = useLibraryStore.getState();\n      const bookIndex = library.findIndex((b) => b.hash === id);\n      if (bookIndex !== -1) {\n        const updatedLibrary = [...library];\n        const existingBook = updatedLibrary[bookIndex]!;\n        updatedLibrary[bookIndex] = {\n          ...existingBook,\n          progress,\n          updatedAt: Date.now(),\n        };\n        setLibrary(updatedLibrary);\n      }\n\n      const oldConfig = bookData.config;\n      const newConfig = {\n        ...bookData.config,\n        progress,\n        location,\n      } as BookConfig;\n\n      useBookDataStore.setState((state) => ({\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...bookData,\n            config: viewState.isPrimary ? newConfig : oldConfig,\n          },\n        },\n      }));\n\n      return {\n        viewStates: {\n          ...state.viewStates,\n          [key]: {\n            ...viewState,\n            progress: {\n              ...viewState.progress,\n              location,\n              sectionHref: tocItem?.href,\n              sectionLabel: tocItem?.label,\n              sectionId: tocItem?.id,\n              section,\n              pageinfo,\n              timeinfo,\n              range,\n            },\n          },\n        },\n      };\n    }),\n  setBookmarkRibbonVisibility: (key: string, visible: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          ribbonVisible: visible,\n        },\n      },\n    })),\n\n  setTTSEnabled: (key: string, enabled: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          ttsEnabled: enabled,\n        },\n      },\n    })),\n\n  setIsSyncing: (key: string, syncing: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          syncing,\n        },\n      },\n    })),\n\n  getGridInsets: (key: string) =>\n    get().viewStates[key]?.gridInsets || { top: 0, right: 0, bottom: 0, left: 0 },\n  setGridInsets: (key: string, insets: Insets | null) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          gridInsets: insets,\n        },\n      },\n    })),\n\n  setViewInited: (key: string, inited: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          inited,\n        },\n      },\n    })),\n\n  recreateViewer: (envConfig: EnvConfigType, key: string) => {\n    const id = key.split('-')[0]!;\n    get()\n      .initViewState(envConfig, id, key, true, true)\n      .then(() => {\n        set((state) => ({\n          viewStates: {\n            ...state.viewStates,\n            [key]: {\n              ...state.viewStates[key]!,\n              viewerKey: `${key}-${uniqueId()}`,\n            },\n          },\n        }));\n      });\n  },\n}));\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3964, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/trafficLightStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { invoke } from '@tauri-apps/api/core';\nimport { AppService } from '@/types/system';\n\nconst WINDOW_CONTROL_PAD_X = 10.0;\nconst WINDOW_CONTROL_PAD_Y = 22.0;\n\ninterface TrafficLightState {\n  appService?: AppService;\n  isTrafficLightVisible: boolean;\n  shouldShowTrafficLight: boolean;\n  trafficLightInFullscreen: boolean;\n  initializeTrafficLightStore: (appService: AppService) => void;\n  setTrafficLightVisibility: (visible: boolean, position?: { x: number; y: number }) => void;\n  initializeTrafficLightListeners: () => Promise<void>;\n  cleanupTrafficLightListeners: () => void;\n  unlistenEnterFullScreen?: () => void;\n  unlistenExitFullScreen?: () => void;\n}\n\nexport const useTrafficLightStore = create<TrafficLightState>((set, get) => {\n  return {\n    appService: undefined,\n    isTrafficLightVisible: false,\n    shouldShowTrafficLight: false,\n    trafficLightInFullscreen: false,\n\n    initializeTrafficLightStore: (appService: AppService) => {\n      set({\n        appService,\n        isTrafficLightVisible: appService.hasTrafficLight,\n        shouldShowTrafficLight: appService.hasTrafficLight,\n      });\n    },\n\n    setTrafficLightVisibility: async (visible: boolean, position?: { x: number; y: number }) => {\n      const { getCurrentWindow } = await import('@tauri-apps/api/window');\n      const currentWindow = getCurrentWindow();\n      const isFullscreen = await currentWindow.isFullscreen();\n      set({\n        isTrafficLightVisible: !isFullscreen && visible,\n        shouldShowTrafficLight: visible,\n        trafficLightInFullscreen: isFullscreen,\n      });\n      invoke('set_traffic_lights', {\n        visible: visible,\n        x: position?.x ?? WINDOW_CONTROL_PAD_X,\n        y: position?.y ?? WINDOW_CONTROL_PAD_Y,\n      });\n    },\n\n    initializeTrafficLightListeners: async () => {\n      const { getCurrentWindow } = await import('@tauri-apps/api/window');\n      const currentWindow = getCurrentWindow();\n\n      const unlistenEnterFullScreen = await currentWindow.listen('will-enter-fullscreen', () => {\n        set({ isTrafficLightVisible: false, trafficLightInFullscreen: true });\n      });\n\n      const unlistenExitFullScreen = await currentWindow.listen('will-exit-fullscreen', () => {\n        const { shouldShowTrafficLight } = get();\n        set({ isTrafficLightVisible: shouldShowTrafficLight, trafficLightInFullscreen: false });\n      });\n\n      set({ unlistenEnterFullScreen, unlistenExitFullScreen });\n    },\n\n    cleanupTrafficLightListeners: () => {\n      const { unlistenEnterFullScreen, unlistenExitFullScreen } = get();\n      if (unlistenEnterFullScreen) unlistenEnterFullScreen();\n      if (unlistenExitFullScreen) unlistenExitFullScreen();\n      set({ unlistenEnterFullScreen: undefined, unlistenExitFullScreen: undefined });\n    },\n  };\n});\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGA,MAAM,uBAAuB;AAC7B,MAAM,uBAAuB;AAetB,MAAM,uBAAuB,IAAA,mQAAM,EAAoB,CAAC,KAAK;IAClE,OAAO;QACL,YAAY;QACZ,uBAAuB;QACvB,wBAAwB;QACxB,0BAA0B;QAE1B,6BAA6B,CAAC;YAC5B,IAAI;gBACF;gBACA,uBAAuB,WAAW,eAAe;gBACjD,wBAAwB,WAAW,eAAe;YACpD;QACF;QAEA,2BAA2B,OAAO,SAAkB;YAClD,MAAM,EAAE,gBAAgB,EAAE,GAAG;YAC7B,MAAM,gBAAgB;YACtB,MAAM,eAAe,MAAM,cAAc,YAAY;YACrD,IAAI;gBACF,uBAAuB,CAAC,gBAAgB;gBACxC,wBAAwB;gBACxB,0BAA0B;YAC5B;YACA,IAAA,8NAAM,EAAC,sBAAsB;gBAC3B,SAAS;gBACT,GAAG,UAAU,KAAK;gBAClB,GAAG,UAAU,KAAK;YACpB;QACF;QAEA,iCAAiC;YAC/B,MAAM,EAAE,gBAAgB,EAAE,GAAG;YAC7B,MAAM,gBAAgB;YAEtB,MAAM,0BAA0B,MAAM,cAAc,MAAM,CAAC,yBAAyB;gBAClF,IAAI;oBAAE,uBAAuB;oBAAO,0BAA0B;gBAAK;YACrE;YAEA,MAAM,yBAAyB,MAAM,cAAc,MAAM,CAAC,wBAAwB;gBAChF,MAAM,EAAE,sBAAsB,EAAE,GAAG;gBACnC,IAAI;oBAAE,uBAAuB;oBAAwB,0BAA0B;gBAAM;YACvF;YAEA,IAAI;gBAAE;gBAAyB;YAAuB;QACxD;QAEA,8BAA8B;YAC5B,MAAM,EAAE,uBAAuB,EAAE,sBAAsB,EAAE,GAAG;YAC5D,IAAI,yBAAyB;YAC7B,IAAI,wBAAwB;YAC5B,IAAI;gBAAE,yBAAyB;gBAAW,wBAAwB;YAAU;QAC9E;IACF;AACF"}},
    {"offset": {"line": 4041, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/customFontStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { EnvConfigType } from '@/services/environment';\nimport { CustomFont, createCustomFont, getFontFormat, getMimeType } from '@/styles/fonts';\nimport { useSettingsStore } from './settingsStore';\n\ninterface FontStoreState {\n  fonts: CustomFont[];\n  loading: boolean;\n\n  setFonts: (fonts: CustomFont[]) => void;\n  addFont: (path: string, options?: Partial<Omit<CustomFont, 'id' | 'path'>>) => CustomFont;\n  removeFont: (id: string) => boolean;\n  updateFont: (id: string, updates: Partial<CustomFont>) => boolean;\n  getFont: (id: string) => CustomFont | undefined;\n  getAllFonts: () => CustomFont[];\n  getAvailableFonts: () => CustomFont[];\n  clearAllFonts: () => void;\n\n  loadFont: (envConfig: EnvConfigType, fontId: string) => Promise<CustomFont>;\n  loadFonts: (envConfig: EnvConfigType, fontIds: string[]) => Promise<CustomFont[]>;\n  loadAllFonts: (envConfig: EnvConfigType) => Promise<CustomFont[]>;\n  unloadFont: (fontId: string) => boolean;\n  unloadAllFonts: () => void;\n\n  getFontFamilies: () => string[];\n  getLoadedFonts: () => CustomFont[];\n  isFontLoaded: (fontId: string) => boolean;\n\n  loadCustomFonts: (envConfig: EnvConfigType) => Promise<void>;\n  saveCustomFonts: (envConfig: EnvConfigType) => Promise<void>;\n}\n\nfunction toSettingsFont(font: CustomFont): CustomFont {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  const { blobUrl, loaded, error, ...settingsFont } = font;\n  return settingsFont;\n}\n\nexport const useCustomFontStore = create<FontStoreState>((set, get) => ({\n  fonts: [],\n  loading: false,\n\n  setFonts: (fonts) => set({ fonts }),\n  addFont: (path, options) => {\n    const font = createCustomFont(path, options);\n    const existingFont = get().fonts.find((f) => f.id === font.id);\n    if (existingFont) {\n      get().updateFont(font.id, {\n        ...font,\n        path: font.path,\n        downloadedAt: Date.now(),\n        deletedAt: undefined,\n        loaded: false,\n        blobUrl: undefined,\n        error: undefined,\n      });\n      set((state) => ({\n        fonts: [...state.fonts],\n      }));\n      return existingFont;\n    }\n\n    const newFont = {\n      ...font,\n      downloadedAt: Date.now(),\n    };\n\n    set((state) => ({\n      fonts: [...state.fonts, newFont],\n    }));\n\n    return newFont;\n  },\n\n  removeFont: (id) => {\n    const font = get().getFont(id);\n    if (!font) return false;\n\n    if (font.blobUrl) {\n      URL.revokeObjectURL(font.blobUrl);\n    }\n\n    const result = get().updateFont(id, {\n      deletedAt: Date.now(),\n      blobUrl: undefined,\n      loaded: false,\n      error: undefined,\n    });\n    set((state) => ({\n      fonts: [...state.fonts],\n    }));\n    return result;\n  },\n\n  updateFont: (id, updates) => {\n    const state = get();\n    const fontIndex = state.fonts.findIndex((font) => font.id === id);\n\n    if (fontIndex === -1) return false;\n\n    set((state) => ({\n      fonts: state.fonts.map((font, index) =>\n        index === fontIndex ? { ...font, ...updates } : font,\n      ),\n    }));\n\n    return true;\n  },\n\n  getFont: (id) => {\n    return get().fonts.find((font) => font.id === id);\n  },\n\n  getAllFonts: () => {\n    return get().fonts;\n  },\n\n  getAvailableFonts: () => {\n    return get().fonts.filter((font) => !font.deletedAt);\n  },\n\n  clearAllFonts: () => {\n    const { fonts } = get();\n    fonts.forEach((font) => {\n      if (font.blobUrl) {\n        URL.revokeObjectURL(font.blobUrl);\n      }\n    });\n\n    set({ fonts: [] });\n  },\n\n  loadFont: async (envConfig, fontId) => {\n    const font = get().getFont(fontId);\n\n    if (!font) {\n      throw new Error(`Font with id \"${fontId}\" not found`);\n    }\n\n    if (font.deletedAt) {\n      throw new Error(`Font \"${font.name}\" has been deleted`);\n    }\n\n    if (font.loaded && font.blobUrl && !font.error) {\n      return font;\n    }\n\n    try {\n      get().updateFont(fontId, {\n        loaded: false,\n        error: undefined,\n      });\n\n      const appService = await envConfig.getAppService();\n      const fontFile = await appService.openFile(font.path, 'Fonts');\n\n      const format = getFontFormat(font.path);\n      const mimeType = getMimeType(format);\n      const blob = new Blob([await fontFile.arrayBuffer()], { type: mimeType });\n      const blobUrl = URL.createObjectURL(blob);\n\n      get().updateFont(fontId, {\n        blobUrl,\n        loaded: true,\n        error: undefined,\n      });\n\n      const updatedFont = get().getFont(fontId)!;\n      return updatedFont;\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      get().updateFont(fontId, {\n        loaded: false,\n        error: errorMessage,\n        blobUrl: undefined,\n      });\n\n      throw error;\n    }\n  },\n\n  loadFonts: async (envConfig, fontIds) => {\n    set({ loading: true });\n    try {\n      const results = await Promise.allSettled(fontIds.map((id) => get().loadFont(envConfig, id)));\n\n      return results\n        .filter(\n          (result): result is PromiseFulfilledResult<CustomFont> => result.status === 'fulfilled',\n        )\n        .map((result) => result.value);\n    } finally {\n      set({ loading: false });\n    }\n  },\n\n  loadAllFonts: async (envConfig) => {\n    const fontIds = get()\n      .getAvailableFonts()\n      .map((font) => font.id);\n    return await get().loadFonts(envConfig, fontIds);\n  },\n\n  unloadFont: (fontId) => {\n    const font = get().getFont(fontId);\n\n    if (font?.blobUrl) {\n      URL.revokeObjectURL(font.blobUrl);\n    }\n\n    return get().updateFont(fontId, {\n      blobUrl: undefined,\n      loaded: false,\n      error: undefined,\n    });\n  },\n\n  unloadAllFonts: () => {\n    const fonts = get().getAllFonts();\n\n    fonts.forEach((font) => {\n      if (font.blobUrl) {\n        URL.revokeObjectURL(font.blobUrl);\n      }\n    });\n\n    fonts.forEach((font) => {\n      get().updateFont(font.id, {\n        blobUrl: undefined,\n        loaded: false,\n        error: undefined,\n      });\n    });\n  },\n\n  getFontFamilies: () => {\n    return get()\n      .getAvailableFonts()\n      .filter((font) => font.loaded && !font.error)\n      .map((font) => font.family || font.name)\n      .filter((value, index, self) => self.indexOf(value) === index)\n      .sort((a, b) => a.localeCompare(b));\n  },\n\n  getLoadedFonts: () => {\n    return get()\n      .getAvailableFonts()\n      .filter((font) => font.loaded && !font.error);\n  },\n\n  isFontLoaded: (fontId) => {\n    const font = get().getFont(fontId);\n    return font?.loaded === true && !font.error && !font.deletedAt;\n  },\n\n  loadCustomFonts: async (envConfig) => {\n    try {\n      const { settings } = useSettingsStore.getState();\n      const currentFonts = get().fonts;\n      if (settings?.customFonts) {\n        const fonts = settings.customFonts.map((font) => {\n          const existingFont = currentFonts.find((f) => f.id === font.id);\n          return {\n            ...font,\n            loaded: existingFont?.loaded || false,\n            error: existingFont?.error,\n            blobUrl: existingFont?.blobUrl,\n          };\n        });\n        set({ fonts });\n        await get().loadAllFonts(envConfig);\n      }\n    } catch (error) {\n      console.error('Failed to load custom fonts settings:', error);\n    }\n  },\n\n  saveCustomFonts: async (envConfig) => {\n    try {\n      const { settings, setSettings, saveSettings } = useSettingsStore.getState();\n      const { fonts } = get();\n      settings.customFonts = fonts.map(toSettingsFont);\n      setSettings(settings);\n      saveSettings(envConfig, settings);\n    } catch (error) {\n      console.error('Failed to save custom fonts settings:', error);\n      throw error;\n    }\n  },\n}));\n\nif (typeof window !== 'undefined') {\n  window.addEventListener('beforeunload', () => {\n    const store = useCustomFontStore.getState();\n    const fonts = store.getAllFonts();\n    fonts.forEach((font) => {\n      if (font.blobUrl) {\n        URL.revokeObjectURL(font.blobUrl);\n      }\n    });\n  });\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4295, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transferManager.ts"],"sourcesContent":["import { Book } from '@/types/book';\nimport { AppService } from '@/types/system';\nimport { useTransferStore, TransferItem } from '@/store/transferStore';\nimport { TranslationFunc } from '@/hooks/useTranslation';\nimport { ProgressPayload } from '@/utils/transfer';\nimport { eventDispatcher } from '@/utils/event';\n\nconst TRANSFER_QUEUE_KEY = 'readest_transfer_queue';\nconst RETRY_DELAY_BASE_MS = 2000;\n\ninterface PersistedQueueData {\n  transfers: Record<string, TransferItem>;\n  isQueuePaused: boolean;\n}\n\nclass TransferManager {\n  private static instance: TransferManager;\n  private appService: AppService | null = null;\n  private isProcessing = false;\n  private abortControllers: Map<string, AbortController> = new Map();\n  private isInitialized = false;\n  private getLibrary: (() => Book[]) | null = null;\n  private updateBook: ((book: Book) => Promise<void>) | null = null;\n  private _: TranslationFunc | null = null;\n\n  private constructor() { }\n\n  static getInstance(): TransferManager {\n    if (!TransferManager.instance) {\n      TransferManager.instance = new TransferManager();\n    }\n    return TransferManager.instance;\n  }\n\n  async initialize(\n    appService: AppService,\n    getLibrary: () => Book[],\n    updateBook: (book: Book) => Promise<void>,\n    translationFn: TranslationFunc,\n  ): Promise<void> {\n    if (this.isInitialized) return;\n\n    this.appService = appService;\n    this.getLibrary = getLibrary;\n    this.updateBook = updateBook;\n    this._ = translationFn;\n    await this.loadPersistedQueue();\n    this.isInitialized = true;\n\n    // Start processing queue\n    this.processQueue();\n  }\n\n  isReady(): boolean {\n    return this.isInitialized && this.appService !== null;\n  }\n\n  queueUpload(book: Book, priority: number = 10): string | null {\n    if (!this.isReady()) {\n      console.warn('TransferManager not initialized');\n      return null;\n    }\n\n    const store = useTransferStore.getState();\n\n    // Check if already queued or in progress\n    const existing = store.getTransferByBookHash(book.hash, 'upload');\n    if (existing) {\n      return existing.id;\n    }\n\n    const transferId = store.addTransfer(book.hash, book.title, 'upload', priority);\n    this.persistQueue();\n    this.processQueue();\n    return transferId;\n  }\n\n  queueDownload(book: Book, priority: number = 10): string | null {\n    if (!this.isReady()) {\n      console.warn('TransferManager not initialized');\n      return null;\n    }\n\n    const store = useTransferStore.getState();\n\n    const existing = store.getTransferByBookHash(book.hash, 'download');\n    if (existing) {\n      return existing.id;\n    }\n\n    const transferId = store.addTransfer(book.hash, book.title, 'download', priority);\n    this.persistQueue();\n    this.processQueue();\n    return transferId;\n  }\n\n  queueDelete(book: Book, priority: number = 10, isBackground: boolean = false): string | null {\n    if (!this.isReady()) {\n      console.warn('TransferManager not initialized');\n      return null;\n    }\n\n    const store = useTransferStore.getState();\n\n    const existing = store.getTransferByBookHash(book.hash, 'delete');\n    if (existing) {\n      return existing.id;\n    }\n\n    const transferId = store.addTransfer(book.hash, book.title, 'delete', priority, isBackground);\n    this.persistQueue();\n    this.processQueue();\n    return transferId;\n  }\n\n  queueBatchUploads(books: Book[], priority: number = 10): string[] {\n    return books\n      .map((book) => this.queueUpload(book, priority))\n      .filter((id): id is string => id !== null);\n  }\n\n  cancelTransfer(transferId: string): void {\n    const controller = this.abortControllers.get(transferId);\n    if (controller) {\n      controller.abort();\n      this.abortControllers.delete(transferId);\n    }\n\n    useTransferStore.getState().setTransferStatus(transferId, 'cancelled');\n    this.persistQueue();\n  }\n\n  retryTransfer(transferId: string): void {\n    const store = useTransferStore.getState();\n    store.retryTransfer(transferId);\n    this.persistQueue();\n    this.processQueue();\n  }\n\n  retryAllFailed(): void {\n    const store = useTransferStore.getState();\n    const failed = store.getFailedTransfers();\n    failed.forEach((transfer) => {\n      store.retryTransfer(transfer.id);\n    });\n    this.persistQueue();\n    this.processQueue();\n  }\n\n  pauseQueue(): void {\n    useTransferStore.getState().pauseQueue();\n    this.persistQueue();\n  }\n\n  resumeQueue(): void {\n    useTransferStore.getState().resumeQueue();\n    this.processQueue();\n    this.persistQueue();\n  }\n\n  private async processQueue(): Promise<void> {\n    if (this.isProcessing) return;\n\n    this.isProcessing = true;\n\n    try {\n      await this._processQueueInternal();\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  private async _processQueueInternal(): Promise<void> {\n    const store = useTransferStore.getState();\n\n    if (store.isQueuePaused) return;\n\n    const pending = store.getPendingTransfers();\n    const activeCount = store.getActiveTransfers().length;\n    const maxConcurrent = store.maxConcurrent;\n\n    const availableSlots = maxConcurrent - activeCount;\n    if (availableSlots <= 0 || pending.length === 0) return;\n\n    // Sort by priority (lower = higher priority) then by createdAt\n    const sortedPending = [...pending].sort((a, b) => {\n      if (a.priority !== b.priority) return a.priority - b.priority;\n      return a.createdAt - b.createdAt;\n    });\n\n    const toProcess = sortedPending.slice(0, availableSlots);\n\n    await Promise.all(toProcess.map((transfer) => this.executeTransfer(transfer)));\n\n    // Check if more items to process\n    const newStore = useTransferStore.getState();\n    if (newStore.getPendingTransfers().length > 0 && !newStore.isQueuePaused) {\n      setTimeout(() => this.processQueue(), 100);\n    }\n  }\n\n  private async executeTransfer(transfer: TransferItem): Promise<void> {\n    if (!this.appService || !this.getLibrary || !this.updateBook) {\n      console.error('TransferManager not properly initialized');\n      return;\n    }\n\n    const _ = this._!;\n    const store = useTransferStore.getState();\n    const abortController = new AbortController();\n    this.abortControllers.set(transfer.id, abortController);\n\n    store.setTransferStatus(transfer.id, 'in_progress');\n    store.setActiveCount(store.getActiveTransfers().length + 1);\n\n    const progressHandler = (progress: ProgressPayload) => {\n      if (abortController.signal.aborted) return;\n\n      const percentage = progress.total > 0 ? (progress.progress / progress.total) * 100 : 0;\n\n      useTransferStore\n        .getState()\n        .updateTransferProgress(\n          transfer.id,\n          percentage,\n          progress.progress,\n          progress.total,\n          progress.transferSpeed,\n        );\n    };\n\n    try {\n      const library = this.getLibrary();\n      const book = library.find((b) => b.hash === transfer.bookHash);\n\n      if (!book) {\n        throw new Error(_('Book not found in library') as string);\n      }\n\n      if (transfer.type === 'upload') {\n        // Cloud upload functionality removed - using local server storage only\n        throw new Error(_('Upload functionality has been removed') as string);\n      } else if (transfer.type === 'download') {\n        // Cloud download functionality removed - using local server storage only\n        throw new Error(_('Download functionality has been removed') as string);\n      } else if (transfer.type === 'delete') {\n        await this.appService.deleteBook(book, 'cloud');\n        await this.updateBook(book);\n      }\n\n      useTransferStore.getState().setTransferStatus(transfer.id, 'completed');\n\n      const successMessages = {\n        upload: _('Book uploaded: {{title}}', { title: transfer.bookTitle }),\n        download: _('Book downloaded: {{title}}', { title: transfer.bookTitle }),\n        delete: _('Deleted cloud backup of the book: {{title}}', { title: transfer.bookTitle }),\n      };\n\n      if (!transfer.isBackground) {\n        eventDispatcher.dispatch('toast', {\n          type: 'info',\n          timeout: 2000,\n          message: successMessages[transfer.type],\n        });\n      }\n    } catch (error) {\n      if (abortController.signal.aborted) {\n        // Already cancelled, don't update status\n        return;\n      }\n\n      const errorMessage = error instanceof Error ? error.message : _('Unknown error');\n      const currentStore = useTransferStore.getState();\n      const currentTransfer = currentStore.transfers[transfer.id];\n\n      if (currentTransfer && currentTransfer.retryCount < currentTransfer.maxRetries) {\n        // Schedule retry with exponential backoff\n        const delay = RETRY_DELAY_BASE_MS * Math.pow(2, currentTransfer.retryCount);\n        currentStore.incrementRetryCount(transfer.id);\n        currentStore.setTransferStatus(\n          transfer.id,\n          'pending',\n          `Retry ${currentTransfer.retryCount + 1}/${currentTransfer.maxRetries}`,\n        );\n\n        setTimeout(() => {\n          this.processQueue();\n        }, delay);\n      } else {\n        if (errorMessage.includes('Not authenticated')) {\n          eventDispatcher.dispatch('toast', {\n            type: 'error',\n            message: _('Please log in to continue'),\n          });\n        } else if (errorMessage.includes('Insufficient storage quota')) {\n          eventDispatcher.dispatch('toast', {\n            type: 'error',\n            message: _('Insufficient storage quota'),\n          });\n        } else {\n          const errorMessages = {\n            upload: _('Failed to upload book: {{title}}', { title: transfer.bookTitle }),\n            download: _('Failed to download book: {{title}}', { title: transfer.bookTitle }),\n            delete: _('Failed to delete cloud backup of the book: {{title}}', {\n              title: transfer.bookTitle,\n            }),\n          };\n\n          eventDispatcher.dispatch('toast', {\n            type: 'error',\n            message: errorMessages[transfer.type],\n          });\n        }\n\n        useTransferStore.getState().setTransferStatus(transfer.id, 'failed', errorMessage);\n      }\n    } finally {\n      this.abortControllers.delete(transfer.id);\n\n      const currentStore = useTransferStore.getState();\n      currentStore.setActiveCount(Math.max(0, currentStore.getActiveTransfers().length));\n      this.persistQueue();\n\n      // Continue processing\n      setTimeout(() => this.processQueue(), 100);\n    }\n  }\n\n  private async loadPersistedQueue(): Promise<void> {\n    try {\n      if (typeof localStorage === 'undefined') return;\n\n      const stored = localStorage.getItem(TRANSFER_QUEUE_KEY);\n      if (!stored) return;\n\n      const data: PersistedQueueData = JSON.parse(stored);\n      const store = useTransferStore.getState();\n\n      // Restore all transfers using the store's restore method\n      // This preserves the original IDs and handles in_progress -> pending conversion\n      store.restoreTransfers(data.transfers, data.isQueuePaused);\n    } catch (error) {\n      console.error('Failed to load transfer queue:', error);\n    }\n  }\n\n  private persistQueue(): void {\n    try {\n      if (typeof localStorage === 'undefined') return;\n\n      const store = useTransferStore.getState();\n\n      // Persist all transfers including completed (for history)\n      const data: PersistedQueueData = {\n        transfers: store.transfers,\n        isQueuePaused: store.isQueuePaused,\n      };\n\n      localStorage.setItem(TRANSFER_QUEUE_KEY, JSON.stringify(data));\n    } catch (error) {\n      console.error('Failed to persist transfer queue:', error);\n    }\n  }\n}\n\nexport const transferManager = TransferManager.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4592, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/types.ts"],"sourcesContent":["import { TranslatorName } from './providers';\n\nexport interface TranslationProvider {\n  name: string;\n  label: string;\n  authRequired?: boolean;\n  quotaExceeded?: boolean;\n  translate: (\n    texts: string[],\n    sourceLang: string,\n    targetLang: string,\n    token?: string | null,\n    useCache?: boolean,\n  ) => Promise<string[]>;\n}\n\nexport interface TranslationCache {\n  [key: string]: string;\n}\n\nexport interface UseTranslatorOptions {\n  provider?: TranslatorName;\n  sourceLang?: string;\n  targetLang?: string;\n  enablePolishing?: boolean;\n  enablePreprocessing?: boolean;\n}\n\nexport const ErrorCodes = {\n  UNAUTHORIZED: 'Unauthorized',\n  DEEPL_API_ERROR: 'DeepL API Error',\n  DAILY_QUOTA_EXCEEDED: 'Daily Quota Exceeded',\n  INTERNAL_SERVER_ERROR: 'Internal Server Error',\n};\n"],"names":[],"mappings":";;;;AA4BO,MAAM,aAAa;IACxB,cAAc;IACd,iBAAiB;IACjB,sBAAsB;IACtB,uBAAuB;AACzB"}},
    {"offset": {"line": 4609, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/cache.ts"],"sourcesContent":["import { TranslationCache } from './types';\n\nconst DB_NAME = 'TranslationCache';\nconst DB_VERSION = 1;\nconst STORE_NAME = 'translations';\n\ninterface CacheEntry {\n  key: string;\n  translation: string;\n  timestamp: number;\n  provider: string;\n  sourceLang: string;\n  targetLang: string;\n  originalText: string;\n}\n\nconst memoryCache: TranslationCache = {};\nconst memoryTimestamps: Record<string, number> = {};\n\nconst openDatabase = (): Promise<IDBDatabase> => {\n  return new Promise((resolve, reject) => {\n    if (!window.indexedDB) {\n      console.warn('IndexedDB not supported. Using in-memory cache only.');\n      reject(new Error('IndexedDB not supported'));\n      return;\n    }\n\n    const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n    request.onerror = (event) => {\n      console.error('IndexedDB error:', event);\n      reject(new Error('Could not open IndexedDB'));\n    };\n\n    request.onsuccess = (event) => {\n      const db = (event.target as IDBOpenDBRequest).result;\n      resolve(db);\n    };\n\n    request.onupgradeneeded = (event) => {\n      const db = (event.target as IDBOpenDBRequest).result;\n\n      if (!db.objectStoreNames.contains(STORE_NAME)) {\n        const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });\n        store.createIndex('provider', 'provider', { unique: false });\n        store.createIndex('timestamp', 'timestamp', { unique: false });\n      }\n    };\n  });\n};\n\nexport const loadCacheFromDB = async (\n  options: {\n    maxAge?: number;\n    maxEntries?: number;\n    onlyLoadProviders?: string[];\n    onlyLoadLanguages?: { source?: string[]; target?: string[] };\n  } = {},\n): Promise<void> => {\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n\n    let request: IDBRequest;\n    if (options.onlyLoadProviders && options.onlyLoadProviders.length > 0) {\n      const providerPromises = options.onlyLoadProviders.map((provider) => {\n        return new Promise<CacheEntry[]>((resolve) => {\n          const providerIndex = store.index('provider');\n          const request = providerIndex.getAll(provider);\n\n          request.onsuccess = () => {\n            resolve(request.result);\n          };\n\n          request.onerror = () => {\n            resolve([]);\n          };\n        });\n      });\n\n      const allEntries = (await Promise.all(providerPromises)).flat();\n      processLoadedEntries(allEntries, options);\n    } else {\n      request = store.getAll();\n\n      request.onsuccess = () => {\n        const entries = request.result as CacheEntry[];\n        processLoadedEntries(entries, options);\n      };\n\n      request.onerror = (event) => {\n        console.error('Error loading cache from IndexedDB:', event);\n      };\n    }\n\n    transaction.oncomplete = () => {\n      db.close();\n    };\n  } catch (error) {\n    console.error('Failed to load cache from IndexedDB:', error);\n  }\n};\n\nconst processLoadedEntries = (\n  entries: CacheEntry[],\n  options: {\n    maxAge?: number;\n    maxEntries?: number;\n    onlyLoadLanguages?: { source?: string[]; target?: string[] };\n  },\n): void => {\n  let filteredEntries = entries;\n\n  if (options.maxAge) {\n    const cutoff = Date.now() - options.maxAge;\n    filteredEntries = filteredEntries.filter((entry) => entry.timestamp >= cutoff);\n  }\n\n  if (options.onlyLoadLanguages) {\n    if (options.onlyLoadLanguages.source && options.onlyLoadLanguages.source.length > 0) {\n      filteredEntries = filteredEntries.filter((entry) =>\n        options.onlyLoadLanguages!.source!.includes(entry.sourceLang),\n      );\n    }\n\n    if (options.onlyLoadLanguages.target && options.onlyLoadLanguages.target.length > 0) {\n      filteredEntries = filteredEntries.filter((entry) =>\n        options.onlyLoadLanguages!.target!.includes(entry.targetLang),\n      );\n    }\n  }\n\n  if (options.maxEntries && filteredEntries.length > options.maxEntries) {\n    filteredEntries.sort((a, b) => b.timestamp - a.timestamp);\n    filteredEntries = filteredEntries.slice(0, options.maxEntries);\n  }\n\n  filteredEntries.forEach((entry) => {\n    memoryCache[entry.key] = entry.translation;\n    memoryTimestamps[entry.key] = entry.timestamp;\n  });\n\n  // console.log(`Loaded ${filteredEntries.length} translations into memory cache`);\n};\n\nexport const getCacheKey = (\n  text: string,\n  sourceLang: string,\n  targetLang: string,\n  provider: string,\n): string => {\n  return `${provider}:${sourceLang}:${targetLang}:${text}`;\n};\n\nexport const getFromCache = async (\n  text: string,\n  sourceLang: string,\n  targetLang: string,\n  provider: string,\n): Promise<string | null> => {\n  if (!text?.trim()) return null;\n\n  const key = getCacheKey(text, sourceLang, targetLang, provider);\n\n  if (memoryCache[key]) {\n    return memoryCache[key];\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n    const request = store.get(key);\n\n    return new Promise((resolve) => {\n      request.onsuccess = () => {\n        const entry = request.result as CacheEntry;\n        if (entry) {\n          memoryCache[key] = entry.translation;\n          memoryTimestamps[key] = entry.timestamp;\n          resolve(entry.translation);\n        } else {\n          resolve(null);\n        }\n      };\n\n      request.onerror = () => {\n        resolve(null);\n      };\n\n      transaction.oncomplete = () => {\n        db.close();\n      };\n    });\n  } catch (error) {\n    console.error('Error accessing IndexedDB:', error);\n    return null;\n  }\n};\n\nexport const storeInCache = async (\n  text: string,\n  translation: string,\n  sourceLang: string,\n  targetLang: string,\n  provider: string,\n): Promise<void> => {\n  if (!text?.trim() || !translation) return;\n\n  const key = getCacheKey(text, sourceLang, targetLang, provider);\n  const timestamp = Date.now();\n\n  memoryCache[key] = translation;\n  memoryTimestamps[key] = timestamp;\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n\n    const entry: CacheEntry = {\n      key,\n      translation,\n      timestamp,\n      provider,\n      sourceLang,\n      targetLang,\n      originalText: text,\n    };\n\n    store.put(entry);\n\n    return new Promise((resolve, reject) => {\n      transaction.oncomplete = () => {\n        db.close();\n        resolve();\n      };\n\n      transaction.onerror = (event) => {\n        console.error('Error storing in IndexedDB:', event);\n        reject(new Error('Failed to store in IndexedDB'));\n      };\n    });\n  } catch (error) {\n    console.error('Error accessing IndexedDB:', error);\n  }\n};\n\nexport interface CacheFilterOptions {\n  provider?: string;\n  maxAge?: number;\n}\n\nexport const clearCache = async (filter?: CacheFilterOptions): Promise<number> => {\n  let deletedCount = 0;\n\n  if (!filter) {\n    const count = Object.keys(memoryCache).length;\n    Object.keys(memoryCache).forEach((key) => {\n      delete memoryCache[key];\n      delete memoryTimestamps[key];\n    });\n    deletedCount = count;\n  } else {\n    const keysToDelete: string[] = [];\n\n    Object.keys(memoryCache).forEach((key) => {\n      let shouldDelete = true;\n\n      if (filter.provider) {\n        const parts = key.split(':');\n        const provider = parts[0];\n\n        if (filter.provider && provider !== filter.provider) {\n          shouldDelete = false;\n        }\n      }\n\n      if (shouldDelete && filter.maxAge && memoryTimestamps[key]) {\n        const timestamp = memoryTimestamps[key];\n        if (Date.now() - timestamp < filter.maxAge) {\n          shouldDelete = false;\n        }\n      }\n\n      if (shouldDelete) {\n        keysToDelete.push(key);\n      }\n    });\n\n    keysToDelete.forEach((key) => {\n      delete memoryCache[key];\n      delete memoryTimestamps[key];\n    });\n\n    deletedCount = keysToDelete.length;\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n\n    if (!filter) {\n      store.clear();\n    } else {\n      const request = store.getAll();\n\n      request.onsuccess = () => {\n        const entries = request.result as CacheEntry[];\n        const filteredEntries = entries.filter((entry) => {\n          if (filter.provider && entry.provider !== filter.provider) {\n            return false;\n          }\n\n          if (filter.maxAge && Date.now() - entry.timestamp >= filter.maxAge) {\n            return true;\n          }\n\n          return true;\n        });\n\n        filteredEntries.forEach((entry) => {\n          store.delete(entry.key);\n        });\n      };\n    }\n\n    return new Promise((resolve) => {\n      transaction.oncomplete = () => {\n        db.close();\n        resolve(deletedCount);\n      };\n\n      transaction.onerror = () => {\n        db.close();\n        resolve(deletedCount);\n      };\n    });\n  } catch (error) {\n    console.error('Error clearing IndexedDB cache:', error);\n    return deletedCount;\n  }\n};\n\nexport const getCacheStats = async (\n  includeDB: boolean = false,\n): Promise<{\n  memoryCacheEntries: number;\n  memoryCacheSizeInBytes: number;\n  dbCacheEntries?: number;\n  dbCacheSizeInBytes?: number;\n  totalEntries?: number;\n  totalSizeInBytes?: number;\n}> => {\n  const memoryCacheEntries = Object.keys(memoryCache).length;\n\n  let memoryCacheSizeInBytes = 0;\n  for (const key in memoryCache) {\n    memoryCacheSizeInBytes += key.length;\n\n    const value = memoryCache[key] || '';\n    memoryCacheSizeInBytes += value.length;\n  }\n\n  if (!includeDB) {\n    return { memoryCacheEntries, memoryCacheSizeInBytes };\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n    const countRequest = store.count();\n\n    return new Promise((resolve) => {\n      countRequest.onsuccess = () => {\n        const dbCacheEntries = countRequest.result;\n\n        const getAllRequest = store.getAll();\n\n        getAllRequest.onsuccess = () => {\n          const entries = getAllRequest.result as CacheEntry[];\n\n          let dbCacheSizeInBytes = 0;\n          entries.forEach((entry) => {\n            const entryString = JSON.stringify(entry);\n            dbCacheSizeInBytes += entryString.length;\n          });\n\n          const totalEntries =\n            memoryCacheEntries + dbCacheEntries - Math.min(memoryCacheEntries, dbCacheEntries);\n\n          const totalSizeInBytes = memoryCacheSizeInBytes + dbCacheSizeInBytes;\n\n          resolve({\n            memoryCacheEntries,\n            memoryCacheSizeInBytes,\n            dbCacheEntries,\n            dbCacheSizeInBytes,\n            totalEntries,\n            totalSizeInBytes,\n          });\n        };\n      };\n\n      transaction.oncomplete = () => {\n        db.close();\n      };\n\n      transaction.onerror = () => {\n        db.close();\n        resolve({\n          memoryCacheEntries,\n          memoryCacheSizeInBytes,\n        });\n      };\n    });\n  } catch (error) {\n    console.error('Error getting IndexedDB stats:', error);\n    return { memoryCacheEntries, memoryCacheSizeInBytes };\n  }\n};\n\nexport const pruneCache = async (\n  options: {\n    maxAge?: number;\n    maxEntries?: number;\n    maxSizeInBytes?: number;\n    dryRun?: boolean;\n  } = {},\n): Promise<number> => {\n  const { maxAge, maxEntries, maxSizeInBytes, dryRun = false } = options;\n\n  if (!maxAge && !maxEntries && !maxSizeInBytes) {\n    return 0;\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, dryRun ? 'readonly' : 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n    const getAllRequest = store.getAll();\n\n    return new Promise((resolve) => {\n      getAllRequest.onsuccess = () => {\n        const entries = getAllRequest.result as CacheEntry[];\n        const entriesToPrune: CacheEntry[] = [];\n\n        if (maxAge) {\n          const cutoffTime = Date.now() - maxAge;\n          const agedEntries = entries.filter((entry) => entry.timestamp < cutoffTime);\n          entriesToPrune.push(...agedEntries);\n        }\n\n        if (maxEntries && entries.length > maxEntries) {\n          const sortedEntries = [...entries].sort((a, b) => a.timestamp - b.timestamp);\n          const excessEntries = sortedEntries.slice(0, entries.length - maxEntries);\n\n          const prunedKeys = new Set(entriesToPrune.map((e) => e.key));\n          excessEntries.forEach((entry) => {\n            if (!prunedKeys.has(entry.key)) {\n              entriesToPrune.push(entry);\n            }\n          });\n        }\n\n        if (maxSizeInBytes) {\n          let currentSize = 0;\n          entries.forEach((entry) => {\n            const entryString = JSON.stringify(entry);\n            currentSize += entryString.length;\n          });\n\n          if (currentSize > maxSizeInBytes) {\n            const remainingEntries = entries\n              .filter((entry) => !entriesToPrune.some((e) => e.key === entry.key))\n              .sort((a, b) => a.timestamp - b.timestamp);\n\n            let sizeToRemove = currentSize - maxSizeInBytes;\n            const prunedKeys = new Set(entriesToPrune.map((e) => e.key));\n\n            for (const entry of remainingEntries) {\n              if (sizeToRemove <= 0) break;\n\n              if (!prunedKeys.has(entry.key)) {\n                const entryString = JSON.stringify(entry);\n                const entrySize = entryString.length * 2;\n\n                entriesToPrune.push(entry);\n                prunedKeys.add(entry.key);\n                sizeToRemove -= entrySize;\n              }\n            }\n          }\n        }\n\n        const pruneCount = entriesToPrune.length;\n\n        if (!dryRun && pruneCount > 0) {\n          entriesToPrune.forEach((entry) => {\n            store.delete(entry.key);\n\n            delete memoryCache[entry.key];\n            delete memoryTimestamps[entry.key];\n          });\n        }\n\n        resolve(pruneCount);\n      };\n\n      getAllRequest.onerror = () => {\n        resolve(0);\n      };\n\n      transaction.oncomplete = () => {\n        db.close();\n      };\n    });\n  } catch (error) {\n    console.error('Error pruning cache:', error);\n    return 0;\n  }\n};\n\nexport const initCache = async (\n  options: {\n    preload?: boolean;\n    preloadOptions?: {\n      maxAge?: number;\n      maxEntries?: number;\n      onlyLoadProviders?: string[];\n      onlyLoadLanguages?: { source?: string[]; target?: string[] };\n    };\n    autoPrune?: boolean;\n    pruneInterval?: number;\n    pruneOptions?: {\n      maxAge?: number;\n      maxEntries?: number;\n      maxSizeInBytes?: number;\n    };\n  } = {},\n): Promise<() => void> => {\n  const {\n    preload = true,\n    preloadOptions = {\n      maxAge: 30 * 24 * 60 * 60 * 1000,\n      maxEntries: 10000,\n    },\n    autoPrune = true,\n    pruneInterval = 60 * 60 * 1000,\n    pruneOptions = {\n      maxAge: 90 * 24 * 60 * 60 * 1000,\n      maxEntries: 100000,\n      maxSizeInBytes: 10 * 1024 * 1024,\n    },\n  } = options;\n\n  if (preload) {\n    await loadCacheFromDB(preloadOptions);\n  }\n\n  let intervalId: number | null = null;\n\n  if (autoPrune) {\n    await pruneCache(pruneOptions);\n\n    intervalId = window.setInterval(async () => {\n      await pruneCache(pruneOptions);\n    }, pruneInterval);\n  }\n\n  return () => {\n    if (intervalId !== null) {\n      clearInterval(intervalId);\n    }\n  };\n};\n\nlet cleanupFunction: (() => void) | null = null;\n\nif (typeof window !== 'undefined') {\n  initCache().then((cleanup) => {\n    cleanupFunction = cleanup;\n  });\n\n  window.addEventListener('beforeunload', () => {\n    if (cleanupFunction) {\n      cleanupFunction();\n    }\n  });\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5051, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/polish.ts"],"sourcesContent":["export type Polisher = (text: string) => string;\n\nconst languagePolishers: Record<string, Polisher> = {\n  // Chinese - fix punctuation spacing\n  zh: (text: string) =>\n    text\n      .replace(/--/g, '⸺')\n      .replace(/\\s+([。、！？])/g, '$1')\n      .replace(/([。、！？])\\s+/g, '$1'),\n\n  // Spanish - fix punctuation spacing\n  es: (text: string) =>\n    text.replace(/\\?([A-ZÁÉÍÓÚÑÜ])/g, '? $1').replace(/\\!([A-ZÁÉÍÓÚÑÜ])/g, '! $1'),\n\n  // French - fix punctuation spacing\n  fr: (text: string) => text.replace(/\\s+([!?:;])/g, ' $1').replace(/([!?:;])\\s+/g, '$1 '),\n\n  // Japanese - fix punctuation spacing\n  ja: (text: string) => text.replace(/\\s+([。、！？])/g, '$1').replace(/([。、！？])\\s+/g, '$1'),\n};\n\nexport const basicPolish: Polisher = (text: string) => {\n  return text\n    .replace(/\\s+/g, ' ') // Multiple spaces to single space\n    .replace(/\\s+([.,!?;:])/g, '$1') // Remove space before punctuation\n    .trim();\n};\n\nexport function getPolisher(targetLang: string): Polisher {\n  const langCode = targetLang.split('-')[0]!.toLowerCase();\n  const languagePolisher = languagePolishers[langCode];\n\n  if (languagePolisher) {\n    return (text: string) => {\n      const basicPolished = basicPolish(text);\n      const polished = languagePolisher(basicPolished);\n      return polished;\n    };\n  }\n\n  return basicPolish;\n}\n\nexport function polish(texts: string[], targetLang: string): string[] {\n  const polisher = getPolisher(targetLang);\n  return texts.map(polisher);\n}\n"],"names":[],"mappings":";;;;;;;;AAEA,MAAM,oBAA8C;IAClD,oCAAoC;IACpC,IAAI,CAAC,OACH,KACG,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,gBAAgB,MACxB,OAAO,CAAC,gBAAgB;IAE7B,oCAAoC;IACpC,IAAI,CAAC,OACH,KAAK,OAAO,CAAC,qBAAqB,QAAQ,OAAO,CAAC,qBAAqB;IAEzE,mCAAmC;IACnC,IAAI,CAAC,OAAiB,KAAK,OAAO,CAAC,gBAAgB,OAAO,OAAO,CAAC,gBAAgB;IAElF,qCAAqC;IACrC,IAAI,CAAC,OAAiB,KAAK,OAAO,CAAC,gBAAgB,MAAM,OAAO,CAAC,gBAAgB;AACnF;AAEO,MAAM,cAAwB,CAAC;IACpC,OAAO,KACJ,OAAO,CAAC,QAAQ,KAAK,kCAAkC;KACvD,OAAO,CAAC,kBAAkB,MAAM,kCAAkC;KAClE,IAAI;AACT;AAEO,SAAS,YAAY,UAAkB;IAC5C,MAAM,WAAW,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE,CAAE,WAAW;IACtD,MAAM,mBAAmB,iBAAiB,CAAC,SAAS;IAEpD,IAAI,kBAAkB;QACpB,OAAO,CAAC;YACN,MAAM,gBAAgB,YAAY;YAClC,MAAM,WAAW,iBAAiB;YAClC,OAAO;QACT;IACF;IAEA,OAAO;AACT;AAEO,SAAS,OAAO,KAAe,EAAE,UAAkB;IACxD,MAAM,WAAW,YAAY;IAC7B,OAAO,MAAM,GAAG,CAAC;AACnB"}},
    {"offset": {"line": 5097, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/preprocess.ts"],"sourcesContent":["export type Preprocessor = (text: string) => string;\nexport type TextSubstitutions = Record<string, string>;\n\nconst defaultSubstitutions: TextSubstitutions = {\n  Cover: 'The Cover',\n  Dedication: 'Dedication Page',\n  Acknowledgements: 'The Acknowledgements',\n};\n\nexport const basicSubstitute = (text: string, substitutions: TextSubstitutions): string => {\n  const allSubstitutions = { ...defaultSubstitutions, ...substitutions };\n\n  if (Object.keys(allSubstitutions).length === 0) {\n    return text;\n  }\n\n  if (allSubstitutions[text]) {\n    return allSubstitutions[text];\n  }\n\n  return text;\n};\n\nexport function createPreprocessor(substitutions: TextSubstitutions = {}): Preprocessor {\n  return (text: string) => basicSubstitute(text, substitutions);\n}\n\nexport function preprocess(texts: string[], substitutions: TextSubstitutions = {}): string[] {\n  const preprocessor = createPreprocessor(substitutions);\n  return texts.map(preprocessor);\n}\n"],"names":[],"mappings":";;;;;;;;AAGA,MAAM,uBAA0C;IAC9C,OAAO;IACP,YAAY;IACZ,kBAAkB;AACpB;AAEO,MAAM,kBAAkB,CAAC,MAAc;IAC5C,MAAM,mBAAmB;QAAE,GAAG,oBAAoB;QAAE,GAAG,aAAa;IAAC;IAErE,IAAI,OAAO,IAAI,CAAC,kBAAkB,MAAM,KAAK,GAAG;QAC9C,OAAO;IACT;IAEA,IAAI,gBAAgB,CAAC,KAAK,EAAE;QAC1B,OAAO,gBAAgB,CAAC,KAAK;IAC/B;IAEA,OAAO;AACT;AAEO,SAAS,mBAAmB,gBAAmC,CAAC,CAAC;IACtE,OAAO,CAAC,OAAiB,gBAAgB,MAAM;AACjD;AAEO,SAAS,WAAW,KAAe,EAAE,gBAAmC,CAAC,CAAC;IAC/E,MAAM,eAAe,mBAAmB;IACxC,OAAO,MAAM,GAAG,CAAC;AACnB"}},
    {"offset": {"line": 5137, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/utils.ts"],"sourcesContent":["import { Book } from '@/types/book';\nimport { isSameLang } from '@/utils/lang';\nimport { getLocale } from '@/utils/misc';\n\nconst DAILY_USAGE_KEY = 'translationDailyUsage';\n\nexport const saveDailyUsage = (usage: number, date?: string) => {\n  if (typeof window !== 'undefined') {\n    const isoDate = date || new Date().toISOString().split('T')[0]!;\n    const dailyUsage = { [isoDate]: usage };\n    localStorage.setItem(DAILY_USAGE_KEY, JSON.stringify(dailyUsage));\n  }\n};\n\nexport const getDailyUsage = (date?: string): number | null => {\n  if (typeof window !== 'undefined') {\n    const isoDate = date || new Date().toISOString().split('T')[0]!;\n    const usage = localStorage.getItem(DAILY_USAGE_KEY);\n    if (usage) {\n      const dailyUsage = JSON.parse(usage);\n      if (dailyUsage[isoDate]) {\n        return dailyUsage[isoDate];\n      }\n    }\n  }\n  return null;\n};\n\nexport const isTranslationAvailable = (book?: Book | null, targetLanguage?: string | null) => {\n  if (!book || book.format === 'PDF') {\n    return false;\n  }\n\n  const primaryLanguage = book.primaryLanguage || '';\n  if (!primaryLanguage || primaryLanguage.toLowerCase() === 'und') {\n    return false;\n  }\n\n  if (targetLanguage && isSameLang(primaryLanguage, targetLanguage)) {\n    return false;\n  }\n\n  if (!targetLanguage && isSameLang(primaryLanguage, getLocale())) {\n    return false;\n  }\n\n  return true;\n};\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,iBAAiB,CAAC,OAAe;IAC5C,wCAAmC;QACjC,MAAM,UAAU,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAC9D,MAAM,aAAa;YAAE,CAAC,QAAQ,EAAE;QAAM;QACtC,aAAa,OAAO,CAAC,iBAAiB,KAAK,SAAS,CAAC;IACvD;AACF;AAEO,MAAM,gBAAgB,CAAC;IAC5B,wCAAmC;QACjC,MAAM,UAAU,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAC9D,MAAM,QAAQ,aAAa,OAAO,CAAC;QACnC,IAAI,OAAO;YACT,MAAM,aAAa,KAAK,KAAK,CAAC;YAC9B,IAAI,UAAU,CAAC,QAAQ,EAAE;gBACvB,OAAO,UAAU,CAAC,QAAQ;YAC5B;QACF;IACF;IACA,OAAO;AACT;AAEO,MAAM,yBAAyB,CAAC,MAAoB;IACzD,IAAI,CAAC,QAAQ,KAAK,MAAM,KAAK,OAAO;QAClC,OAAO;IACT;IAEA,MAAM,kBAAkB,KAAK,eAAe,IAAI;IAChD,IAAI,CAAC,mBAAmB,gBAAgB,WAAW,OAAO,OAAO;QAC/D,OAAO;IACT;IAEA,IAAI,kBAAkB,IAAA,+JAAU,EAAC,iBAAiB,iBAAiB;QACjE,OAAO;IACT;IAEA,IAAI,CAAC,kBAAkB,IAAA,+JAAU,EAAC,iBAAiB,IAAA,8JAAS,MAAK;QAC/D,OAAO;IACT;IAEA,OAAO;AACT"}},
    {"offset": {"line": 5195, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/deepl.ts"],"sourcesContent":["import { getAPIBaseUrl } from '@/services/environment';\nimport { stubTranslation as _ } from '@/utils/misc';\nimport { ErrorCodes, TranslationProvider } from '../types';\nimport { UserPlan } from '@/types/quota';\nimport { getSubscriptionPlan } from '@/utils/access';\nimport { normalizeToShortLang } from '@/utils/lang';\nimport { DEFAULT_DAILY_TRANSLATION_QUOTA } from '@/services/constants';\nimport { saveDailyUsage } from '../utils';\n\nconst DEEPL_API_ENDPOINT = getAPIBaseUrl() + '/deepl/translate';\n\nexport const deeplProvider: TranslationProvider = {\n  name: 'deepl',\n  label: _('DeepL'),\n  authRequired: true,\n  quotaExceeded: false,\n  translate: async (\n    text: string[],\n    sourceLang: string,\n    targetLang: string,\n    token?: string | null,\n    useCache: boolean = false,\n  ): Promise<string[]> => {\n    const authRequired = deeplProvider.authRequired;\n\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n    };\n\n    let userPlan: UserPlan = 'free';\n    if (token) {\n      userPlan = getSubscriptionPlan(token);\n      headers['Authorization'] = `Bearer ${token}`;\n    }\n\n    if (authRequired && !token) {\n      throw new Error('Authentication token is required for DeepL translation');\n    }\n\n    const body = JSON.stringify({\n      text: text,\n      source_lang: normalizeToShortLang(sourceLang).toUpperCase(),\n      target_lang: normalizeToShortLang(targetLang).toUpperCase(),\n      use_cache: useCache,\n    });\n\n    const quota = DEFAULT_DAILY_TRANSLATION_QUOTA[userPlan];\n    try {\n      const response = await fetch(DEEPL_API_ENDPOINT, { method: 'POST', headers, body });\n\n      if (!response.ok) {\n        const data = await response.json();\n        if (data && data.error && data.error === ErrorCodes.DAILY_QUOTA_EXCEEDED) {\n          saveDailyUsage(quota);\n          deeplProvider.quotaExceeded = true;\n          throw new Error(ErrorCodes.DAILY_QUOTA_EXCEEDED);\n        }\n        throw new Error(`Translation failed with status ${response.status}`);\n      }\n\n      const data = await response.json();\n      if (!data || !data.translations) {\n        throw new Error('Invalid response from translation service');\n      }\n\n      return text.map((line, i) => {\n        if (!line?.trim().length) {\n          return line;\n        }\n        const translation = data.translations?.[i];\n        if (translation?.daily_usage) {\n          saveDailyUsage(translation.daily_usage);\n          deeplProvider.quotaExceeded = data.daily_usage >= quota;\n        }\n        return translation?.text || line;\n      });\n    } catch (error) {\n      throw error;\n    }\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;;;;;;;;AAEA,MAAM,qBAAqB,IAAA,4KAAa,MAAK;AAEtC,MAAM,gBAAqC;IAChD,MAAM;IACN,OAAO,IAAA,oKAAC,EAAC;IACT,cAAc;IACd,eAAe;IACf,WAAW,OACT,MACA,YACA,YACA,OACA,WAAoB,KAAK;QAEzB,MAAM,eAAe,cAAc,YAAY;QAE/C,MAAM,UAAkC;YACtC,gBAAgB;QAClB;QAEA,IAAI,WAAqB;QACzB,IAAI,OAAO;YACT,WAAW,IAAA,0KAAmB,EAAC;YAC/B,OAAO,CAAC,gBAAgB,GAAG,CAAC,OAAO,EAAE,OAAO;QAC9C;QAEA,IAAI,gBAAgB,CAAC,OAAO;YAC1B,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,OAAO,KAAK,SAAS,CAAC;YAC1B,MAAM;YACN,aAAa,IAAA,yKAAoB,EAAC,YAAY,WAAW;YACzD,aAAa,IAAA,yKAAoB,EAAC,YAAY,WAAW;YACzD,WAAW;QACb;QAEA,MAAM,QAAQ,4LAA+B,CAAC,SAAS;QACvD,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,oBAAoB;gBAAE,QAAQ;gBAAQ;gBAAS;YAAK;YAEjF,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,IAAI,QAAQ,KAAK,KAAK,IAAI,KAAK,KAAK,KAAK,kLAAU,CAAC,oBAAoB,EAAE;oBACxE,IAAA,sLAAc,EAAC;oBACf,cAAc,aAAa,GAAG;oBAC9B,MAAM,IAAI,MAAM,kLAAU,CAAC,oBAAoB;gBACjD;gBACA,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;YACrE;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,IAAI,CAAC,QAAQ,CAAC,KAAK,YAAY,EAAE;gBAC/B,MAAM,IAAI,MAAM;YAClB;YAEA,OAAO,KAAK,GAAG,CAAC,CAAC,MAAM;gBACrB,IAAI,CAAC,MAAM,OAAO,QAAQ;oBACxB,OAAO;gBACT;gBACA,MAAM,cAAc,KAAK,YAAY,EAAE,CAAC,EAAE;gBAC1C,IAAI,aAAa,aAAa;oBAC5B,IAAA,sLAAc,EAAC,YAAY,WAAW;oBACtC,cAAc,aAAa,GAAG,KAAK,WAAW,IAAI;gBACpD;gBACA,OAAO,aAAa,QAAQ;YAC9B;QACF,EAAE,OAAO,OAAO;YACd,MAAM;QACR;IACF;AACF"}},
    {"offset": {"line": 5281, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/azure.ts"],"sourcesContent":["import { stubTranslation as _ } from '@/utils/misc';\nimport { fetch as tauriFetch } from '@tauri-apps/plugin-http';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { TranslationProvider } from '../types';\nimport { normalizeToFullLang } from '@/utils/lang';\n\ninterface TokenCache {\n  token: string;\n  expiresAt: number;\n}\n\nlet tokenCache: TokenCache | null = null;\n\nconst getAuthToken = async (): Promise<string> => {\n  const now = Date.now();\n\n  if (tokenCache && tokenCache.expiresAt > now) {\n    return tokenCache.token;\n  }\n\n  try {\n    const fetch = isTauriAppPlatform() ? tauriFetch : window.fetch;\n    const tokenResponse = await fetch('https://edge.microsoft.com/translate/auth', {\n      method: 'GET',\n      headers: {\n        'User-Agent': 'Mozilla/5.0',\n      },\n    });\n\n    if (!tokenResponse.ok) {\n      throw new Error(`Failed to get auth token: ${tokenResponse.status}`);\n    }\n\n    const token = await tokenResponse.text();\n    const expiresAt = now + 8 * 60 * 1000;\n\n    tokenCache = {\n      token,\n      expiresAt,\n    };\n\n    return token;\n  } catch (error) {\n    console.error('Error getting Microsoft translation auth token:', error);\n    throw error;\n  }\n};\n\nexport const azureProvider: TranslationProvider = {\n  name: 'azure',\n  label: _('Azure Translator'),\n  translate: async (text: string[], sourceLang: string, targetLang: string): Promise<string[]> => {\n    if (!text.length) return [];\n\n    const results: string[] = [];\n    const msSourceLang = sourceLang ? normalizeToFullLang(sourceLang) : '';\n    const msTargetLang = normalizeToFullLang(targetLang);\n\n    const translationPromises = text.map(async (line, index) => {\n      if (!line?.trim().length) {\n        results[index] = line;\n        return;\n      }\n\n      const url = 'https://api-edge.cognitive.microsofttranslator.com/translate';\n      const params = new URLSearchParams({\n        to: msTargetLang,\n        'api-version': '3.0',\n      });\n      if (msSourceLang && msSourceLang.toLowerCase() !== 'auto') {\n        params.append('from', msSourceLang);\n      }\n\n      const token = await getAuthToken();\n      const fetch = isTauriAppPlatform() ? tauriFetch : window.fetch;\n      const response = await fetch(`${url}?${params.toString()}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify([{ Text: line }]),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Translation failed with status ${response.status}`);\n      }\n\n      const data = await response.json();\n\n      if (Array.isArray(data) && data.length > 0 && data[0].translations) {\n        results[index] = data[0].translations[0].text || line;\n      } else {\n        results[index] = line;\n      }\n    });\n\n    await Promise.all(translationPromises);\n\n    return results;\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAEA;;;;;AAOA,IAAI,aAAgC;AAEpC,MAAM,eAAe;IACnB,MAAM,MAAM,KAAK,GAAG;IAEpB,IAAI,cAAc,WAAW,SAAS,GAAG,KAAK;QAC5C,OAAO,WAAW,KAAK;IACzB;IAEA,IAAI;QACF,MAAM,QAAQ,IAAA,iLAAkB,MAAK,kQAAU,GAAG,OAAO,KAAK;QAC9D,MAAM,gBAAgB,MAAM,MAAM,6CAA6C;YAC7E,QAAQ;YACR,SAAS;gBACP,cAAc;YAChB;QACF;QAEA,IAAI,CAAC,cAAc,EAAE,EAAE;YACrB,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,cAAc,MAAM,EAAE;QACrE;QAEA,MAAM,QAAQ,MAAM,cAAc,IAAI;QACtC,MAAM,YAAY,MAAM,IAAI,KAAK;QAEjC,aAAa;YACX;YACA;QACF;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mDAAmD;QACjE,MAAM;IACR;AACF;AAEO,MAAM,gBAAqC;IAChD,MAAM;IACN,OAAO,IAAA,oKAAC,EAAC;IACT,WAAW,OAAO,MAAgB,YAAoB;QACpD,IAAI,CAAC,KAAK,MAAM,EAAE,OAAO,EAAE;QAE3B,MAAM,UAAoB,EAAE;QAC5B,MAAM,eAAe,aAAa,IAAA,wKAAmB,EAAC,cAAc;QACpE,MAAM,eAAe,IAAA,wKAAmB,EAAC;QAEzC,MAAM,sBAAsB,KAAK,GAAG,CAAC,OAAO,MAAM;YAChD,IAAI,CAAC,MAAM,OAAO,QAAQ;gBACxB,OAAO,CAAC,MAAM,GAAG;gBACjB;YACF;YAEA,MAAM,MAAM;YACZ,MAAM,SAAS,IAAI,gBAAgB;gBACjC,IAAI;gBACJ,eAAe;YACjB;YACA,IAAI,gBAAgB,aAAa,WAAW,OAAO,QAAQ;gBACzD,OAAO,MAAM,CAAC,QAAQ;YACxB;YAEA,MAAM,QAAQ,MAAM;YACpB,MAAM,QAAQ,IAAA,iLAAkB,MAAK,kQAAU,GAAG,OAAO,KAAK;YAC9D,MAAM,WAAW,MAAM,MAAM,GAAG,IAAI,CAAC,EAAE,OAAO,QAAQ,IAAI,EAAE;gBAC1D,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe,CAAC,OAAO,EAAE,OAAO;gBAClC;gBACA,MAAM,KAAK,SAAS,CAAC;oBAAC;wBAAE,MAAM;oBAAK;iBAAE;YACvC;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;YACrE;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAEhC,IAAI,MAAM,OAAO,CAAC,SAAS,KAAK,MAAM,GAAG,KAAK,IAAI,CAAC,EAAE,CAAC,YAAY,EAAE;gBAClE,OAAO,CAAC,MAAM,GAAG,IAAI,CAAC,EAAE,CAAC,YAAY,CAAC,EAAE,CAAC,IAAI,IAAI;YACnD,OAAO;gBACL,OAAO,CAAC,MAAM,GAAG;YACnB;QACF;QAEA,MAAM,QAAQ,GAAG,CAAC;QAElB,OAAO;IACT;AACF"}},
    {"offset": {"line": 5378, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/google.ts"],"sourcesContent":["import { stubTranslation as _ } from '@/utils/misc';\nimport { fetch as tauriFetch } from '@tauri-apps/plugin-http';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { normalizeToShortLang } from '@/utils/lang';\nimport { TranslationProvider } from '../types';\n\nexport const googleProvider: TranslationProvider = {\n  name: 'google',\n  label: _('Google Translate'),\n  translate: async (text: string[], sourceLang: string, targetLang: string): Promise<string[]> => {\n    if (!text.length) return [];\n\n    const results: string[] = [];\n\n    const translationPromises = text.map(async (line, index) => {\n      if (!line?.trim().length) {\n        results[index] = line;\n        return;\n      }\n\n      const url = new URL('https://translate.googleapis.com/translate_a/single');\n      url.searchParams.append('client', 'gtx');\n      url.searchParams.append('dt', 't');\n      url.searchParams.append('sl', normalizeToShortLang(sourceLang).toLowerCase() || 'auto');\n      url.searchParams.append('tl', normalizeToShortLang(targetLang).toLowerCase());\n      url.searchParams.append('q', line);\n\n      const fetch = isTauriAppPlatform() ? tauriFetch : window.fetch;\n      const response = await fetch(url.toString());\n\n      if (!response.ok) {\n        throw new Error(`Translation failed with status ${response.status}`);\n      }\n\n      const data = await response.json();\n      if (Array.isArray(data) && Array.isArray(data[0])) {\n        const translatedText = data[0]\n          .filter((segment) => Array.isArray(segment) && segment[0])\n          .map((segment) => segment[0])\n          .join('');\n\n        results[index] = translatedText || line;\n      } else {\n        results[index] = line;\n      }\n    });\n\n    await Promise.all(translationPromises);\n\n    return results;\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAGO,MAAM,iBAAsC;IACjD,MAAM;IACN,OAAO,IAAA,oKAAC,EAAC;IACT,WAAW,OAAO,MAAgB,YAAoB;QACpD,IAAI,CAAC,KAAK,MAAM,EAAE,OAAO,EAAE;QAE3B,MAAM,UAAoB,EAAE;QAE5B,MAAM,sBAAsB,KAAK,GAAG,CAAC,OAAO,MAAM;YAChD,IAAI,CAAC,MAAM,OAAO,QAAQ;gBACxB,OAAO,CAAC,MAAM,GAAG;gBACjB;YACF;YAEA,MAAM,MAAM,IAAI,IAAI;YACpB,IAAI,YAAY,CAAC,MAAM,CAAC,UAAU;YAClC,IAAI,YAAY,CAAC,MAAM,CAAC,MAAM;YAC9B,IAAI,YAAY,CAAC,MAAM,CAAC,MAAM,IAAA,yKAAoB,EAAC,YAAY,WAAW,MAAM;YAChF,IAAI,YAAY,CAAC,MAAM,CAAC,MAAM,IAAA,yKAAoB,EAAC,YAAY,WAAW;YAC1E,IAAI,YAAY,CAAC,MAAM,CAAC,KAAK;YAE7B,MAAM,QAAQ,IAAA,iLAAkB,MAAK,kQAAU,GAAG,OAAO,KAAK;YAC9D,MAAM,WAAW,MAAM,MAAM,IAAI,QAAQ;YAEzC,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;YACrE;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,IAAI,MAAM,OAAO,CAAC,SAAS,MAAM,OAAO,CAAC,IAAI,CAAC,EAAE,GAAG;gBACjD,MAAM,iBAAiB,IAAI,CAAC,EAAE,CAC3B,MAAM,CAAC,CAAC,UAAY,MAAM,OAAO,CAAC,YAAY,OAAO,CAAC,EAAE,EACxD,GAAG,CAAC,CAAC,UAAY,OAAO,CAAC,EAAE,EAC3B,IAAI,CAAC;gBAER,OAAO,CAAC,MAAM,GAAG,kBAAkB;YACrC,OAAO;gBACL,OAAO,CAAC,MAAM,GAAG;YACnB;QACF;QAEA,MAAM,QAAQ,GAAG,CAAC;QAElB,OAAO;IACT;AACF"}},
    {"offset": {"line": 5431, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/yandex.ts"],"sourcesContent":["import { stubTranslation as _ } from '@/utils/misc';\nimport { fetch as tauriFetch } from '@tauri-apps/plugin-http';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { normalizeToShortLang } from '@/utils/lang';\nimport { TranslationProvider } from '../types';\n\n/**\n * Based on https://translate.toil.cc/v2/docs API specification\n */\nasync function translateSingleTextForService(\n  text: string,\n  lang: string,\n  service: string,\n): Promise<string[]> {\n  const fetchImpl = isTauriAppPlatform() ? tauriFetch : window.fetch;\n  const url = 'https://translate.toil.cc/v2/translate/';\n\n  const request = {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      lang: lang,\n      service: service,\n      text: text,\n    })\n  };\n\n  const response = await fetchImpl(url, request);\n\n  if (!response.ok) {\n    const response_json = JSON.stringify(await response.json());\n    throw new Error(`${service} failed with status ${response.status}\\n${text.length}\\n${JSON.stringify(request)}\\n${response_json}`);\n  }\n\n  const data = await response.json();\n  if (\n    data &&\n    Array.isArray(data.translations)\n  ) {\n    return data.translations;\n  } else {\n    // fallback: return original texts if translation failed\n    return [text];\n  }\n};\n\nexport const yandexProvider: TranslationProvider = {\n  name: 'yandex',\n  label: _('Yandex Translate'),\n  authRequired: false,\n  translate: async (texts: string[], sourceLang: string, targetLang: string): Promise<string[]> => {\n    if (!texts.length) return [];\n\n    /**\n      Possible options:\n      - yandexcloud: often returns 500: {\"error\":\"The text couldn't be translated, because Forbidden\"}\n      - yandexgpt: often better than others\n      - yandextranslate\n      - yandexbrowser\n    */\n    const service = \"yandexgpt\";\n\n    // Yandex does not accept \"auto\" language\n    const source_lang = sourceLang == \"AUTO\" ? \"en\" : normalizeToShortLang(sourceLang).toLowerCase();\n    const target_lang = normalizeToShortLang(targetLang).toLowerCase();\n    const lang = `${source_lang}-${target_lang}`;\n\n    const responses = await Promise.all(texts.map(async text => {\n      return await translateSingleTextForService(text, lang, service)\n    }));\n\n    const translatedTexts = responses.flat();\n    return translatedTexts;\n  }\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAGA;;CAEC,GACD,eAAe,8BACb,IAAY,EACZ,IAAY,EACZ,OAAe;IAEf,MAAM,YAAY,IAAA,iLAAkB,MAAK,kQAAU,GAAG,OAAO,KAAK;IAClE,MAAM,MAAM;IAEZ,MAAM,UAAU;QACd,QAAQ;QACR,SAAS;YACP,gBAAgB;QAClB;QACA,MAAM,KAAK,SAAS,CAAC;YACnB,MAAM;YACN,SAAS;YACT,MAAM;QACR;IACF;IAEA,MAAM,WAAW,MAAM,UAAU,KAAK;IAEtC,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,gBAAgB,KAAK,SAAS,CAAC,MAAM,SAAS,IAAI;QACxD,MAAM,IAAI,MAAM,GAAG,QAAQ,oBAAoB,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,KAAK,MAAM,CAAC,EAAE,EAAE,KAAK,SAAS,CAAC,SAAS,EAAE,EAAE,eAAe;IAClI;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAChC,IACE,QACA,MAAM,OAAO,CAAC,KAAK,YAAY,GAC/B;QACA,OAAO,KAAK,YAAY;IAC1B,OAAO;QACL,wDAAwD;QACxD,OAAO;YAAC;SAAK;IACf;AACF;AAEO,MAAM,iBAAsC;IACjD,MAAM;IACN,OAAO,IAAA,oKAAC,EAAC;IACT,cAAc;IACd,WAAW,OAAO,OAAiB,YAAoB;QACrD,IAAI,CAAC,MAAM,MAAM,EAAE,OAAO,EAAE;QAE5B;;;;;;IAMA,GACA,MAAM,UAAU;QAEhB,yCAAyC;QACzC,MAAM,cAAc,cAAc,SAAS,OAAO,IAAA,yKAAoB,EAAC,YAAY,WAAW;QAC9F,MAAM,cAAc,IAAA,yKAAoB,EAAC,YAAY,WAAW;QAChE,MAAM,OAAO,GAAG,YAAY,CAAC,EAAE,aAAa;QAE5C,MAAM,YAAY,MAAM,QAAQ,GAAG,CAAC,MAAM,GAAG,CAAC,OAAM;YAClD,OAAO,MAAM,8BAA8B,MAAM,MAAM;QACzD;QAEA,MAAM,kBAAkB,UAAU,IAAI;QACtC,OAAO;IACT;AACF"}},
    {"offset": {"line": 5505, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/index.ts"],"sourcesContent":["import { TranslationProvider } from '../types';\nimport { deeplProvider } from './deepl';\nimport { azureProvider } from './azure';\nimport { googleProvider } from './google';\nimport { yandexProvider } from './yandex';\n\nfunction createTranslator<T extends string>(\n  name: T,\n  implementation: TranslationProvider,\n): TranslationProvider & { name: T } {\n  if (name !== implementation.name) {\n    throw Error(\n      `Translator name \"${name}\" does not match implementation name \"${implementation.name}\"`,\n    );\n  }\n  return implementation as TranslationProvider & { name: T };\n}\n\nconst deeplTranslator = createTranslator('deepl', deeplProvider);\nconst azureTranslator = createTranslator('azure', azureProvider);\nconst googleTranslator = createTranslator('google', googleProvider);\nconst yandexTranslator = createTranslator('yandex', yandexProvider);\n\nconst availableTranslators = [\n  deeplTranslator,\n  azureTranslator,\n  googleTranslator,\n  yandexTranslator,\n  // Add more translators here\n];\n\nexport type TranslatorName = (typeof availableTranslators)[number]['name'];\n\nexport const getTranslator = (name: TranslatorName): TranslationProvider | undefined => {\n  return availableTranslators.find((translator) => translator.name === name);\n};\n\nexport const getTranslators = (): TranslationProvider[] => {\n  return availableTranslators;\n};\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;AACA;;;;;AAEA,SAAS,iBACP,IAAO,EACP,cAAmC;IAEnC,IAAI,SAAS,eAAe,IAAI,EAAE;QAChC,MAAM,MACJ,CAAC,iBAAiB,EAAE,KAAK,sCAAsC,EAAE,eAAe,IAAI,CAAC,CAAC,CAAC;IAE3F;IACA,OAAO;AACT;AAEA,MAAM,kBAAkB,iBAAiB,SAAS,kMAAa;AAC/D,MAAM,kBAAkB,iBAAiB,SAAS,kMAAa;AAC/D,MAAM,mBAAmB,iBAAiB,UAAU,oMAAc;AAClE,MAAM,mBAAmB,iBAAiB,UAAU,oMAAc;AAElE,MAAM,uBAAuB;IAC3B;IACA;IACA;IACA;CAED;AAIM,MAAM,gBAAgB,CAAC;IAC5B,OAAO,qBAAqB,IAAI,CAAC,CAAC,aAAe,WAAW,IAAI,KAAK;AACvE;AAEO,MAAM,iBAAiB;IAC5B,OAAO;AACT"}},
    {"offset": {"line": 5548, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/index.ts"],"sourcesContent":["export * from './types';\nexport * from './cache';\nexport * from './polish';\nexport * from './preprocess';\nexport * from './providers';\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 5566, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/openWith.ts"],"sourcesContent":["import { isWebAppPlatform, hasCli } from '@/services/environment';\nimport { AppService } from '@/types/system';\nimport { getCurrent } from '@tauri-apps/plugin-deep-link';\n\ndeclare global {\n  interface Window {\n    OPEN_WITH_FILES?: string[] | null;\n  }\n}\n\ninterface CliArgument {\n  value: string;\n  occurrences: number;\n}\n\nconst parseWindowOpenWithFiles = () => {\n  const params = new URLSearchParams(window.location.search);\n  const files = params.getAll('file');\n  return files.length > 0 ? files : window.OPEN_WITH_FILES;\n};\n\nconst parseCLIOpenWithFiles = async () => {\n  const { getMatches } = await import('@tauri-apps/plugin-cli');\n  const matches = await getMatches();\n  const args = matches?.args;\n  const files: string[] = [];\n  if (args) {\n    for (const name of ['file1', 'file2', 'file3', 'file4']) {\n      const arg = args[name] as CliArgument;\n      if (arg && arg.occurrences > 0) {\n        files.push(arg.value);\n      }\n    }\n  }\n\n  return files;\n};\n\nconst parseIntentOpenWithFiles = async (appService: AppService | null) => {\n  const urls = await getCurrent();\n  if (urls && urls.length > 0) {\n    console.log('Intent Open with URL:', urls);\n    return urls\n      .map((url) => {\n        if (url.startsWith('file://')) {\n          if (appService?.isIOSApp) {\n            return decodeURI(url);\n          } else {\n            return decodeURI(url.replace('file://', ''));\n          }\n        } else if (url.startsWith('content://')) {\n          return url;\n        } else {\n          console.info('Skip non-file URL:', url);\n          return null;\n        }\n      })\n      .filter((url) => url !== null) as string[];\n  }\n  return null;\n};\n\nexport const parseOpenWithFiles = async (appService: AppService | null) => {\n  if (isWebAppPlatform()) return [];\n\n  let files = parseWindowOpenWithFiles();\n  if ((!files || files.length === 0) && hasCli()) {\n    files = await parseCLIOpenWithFiles();\n  }\n  if (!files || files.length === 0) {\n    files = await parseIntentOpenWithFiles(appService);\n  }\n  return files;\n};\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAaA,MAAM,2BAA2B;IAC/B,MAAM,SAAS,IAAI,gBAAgB,OAAO,QAAQ,CAAC,MAAM;IACzD,MAAM,QAAQ,OAAO,MAAM,CAAC;IAC5B,OAAO,MAAM,MAAM,GAAG,IAAI,QAAQ,OAAO,eAAe;AAC1D;AAEA,MAAM,wBAAwB;IAC5B,MAAM,EAAE,UAAU,EAAE,GAAG;IACvB,MAAM,UAAU,MAAM;IACtB,MAAM,OAAO,SAAS;IACtB,MAAM,QAAkB,EAAE;IAC1B,IAAI,MAAM;QACR,KAAK,MAAM,QAAQ;YAAC;YAAS;YAAS;YAAS;SAAQ,CAAE;YACvD,MAAM,MAAM,IAAI,CAAC,KAAK;YACtB,IAAI,OAAO,IAAI,WAAW,GAAG,GAAG;gBAC9B,MAAM,IAAI,CAAC,IAAI,KAAK;YACtB;QACF;IACF;IAEA,OAAO;AACT;AAEA,MAAM,2BAA2B,OAAO;IACtC,MAAM,OAAO,MAAM,IAAA,uRAAU;IAC7B,IAAI,QAAQ,KAAK,MAAM,GAAG,GAAG;QAC3B,QAAQ,GAAG,CAAC,yBAAyB;QACrC,OAAO,KACJ,GAAG,CAAC,CAAC;YACJ,IAAI,IAAI,UAAU,CAAC,YAAY;gBAC7B,IAAI,YAAY,UAAU;oBACxB,OAAO,UAAU;gBACnB,OAAO;oBACL,OAAO,UAAU,IAAI,OAAO,CAAC,WAAW;gBAC1C;YACF,OAAO,IAAI,IAAI,UAAU,CAAC,eAAe;gBACvC,OAAO;YACT,OAAO;gBACL,QAAQ,IAAI,CAAC,sBAAsB;gBACnC,OAAO;YACT;QACF,GACC,MAAM,CAAC,CAAC,MAAQ,QAAQ;IAC7B;IACA,OAAO;AACT;AAEO,MAAM,qBAAqB,OAAO;IACvC,IAAI,IAAA,+KAAgB,KAAI,OAAO,EAAE;IAEjC,IAAI,QAAQ;IACZ,IAAI,CAAC,CAAC,SAAS,MAAM,MAAM,KAAK,CAAC,KAAK,IAAA,qKAAM,KAAI;QAC9C,QAAQ,MAAM;IAChB;IACA,IAAI,CAAC,SAAS,MAAM,MAAM,KAAK,GAAG;QAChC,QAAQ,MAAM,yBAAyB;IACzC;IACA,OAAO;AACT"}},
    {"offset": {"line": 5638, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/updater.ts"],"sourcesContent":["import semver from 'semver';\nimport { check } from '@tauri-apps/plugin-updater';\nimport { type as osType } from '@tauri-apps/plugin-os';\nimport { fetch } from '@tauri-apps/plugin-http';\nimport { WebviewWindow } from '@tauri-apps/api/webviewWindow';\nimport { TranslationFunc } from '@/hooks/useTranslation';\nimport { setUpdaterWindowVisible } from '@/components/UpdaterWindow';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { getAppVersion } from '@/utils/version';\nimport {\n  CHECK_UPDATE_INTERVAL_SEC,\n  READEST_CHANGELOG_FILE,\n  READEST_UPDATER_FILE,\n} from '@/services/constants';\n\nconst LAST_CHECK_KEY = 'lastAppUpdateCheck';\n\nconst showUpdateWindow = (latestVersion: string) => {\n  const win = new WebviewWindow('updater', {\n    url: `/updater?latestVersion=${latestVersion}`,\n    title: 'Software Update',\n    width: 626,\n    height: 406,\n    center: true,\n    resizable: true,\n  });\n  win.once('tauri://created', () => {\n    console.log('new window created');\n  });\n  win.once('tauri://error', (e) => {\n    console.error('error creating window', e);\n  });\n};\n\nexport const checkForAppUpdates = async (\n  _: TranslationFunc,\n  isAutoCheck = true,\n): Promise<boolean> => {\n  const lastCheck = localStorage.getItem(LAST_CHECK_KEY);\n  const now = Date.now();\n  if (isAutoCheck && lastCheck && now - parseInt(lastCheck, 10) < CHECK_UPDATE_INTERVAL_SEC * 1000)\n    return false;\n  localStorage.setItem(LAST_CHECK_KEY, now.toString());\n\n  console.log('Checking for updates');\n  const OS_TYPE = osType();\n  if (['macos', 'windows', 'linux'].includes(OS_TYPE)) {\n    const update = await check();\n    if (update) {\n      showUpdateWindow(update.version);\n    }\n    return !!update;\n  } else if (OS_TYPE === 'android') {\n    try {\n      const response = await fetch(READEST_UPDATER_FILE, { connectTimeout: 5000 });\n      const data = await response.json();\n      const isNewer = semver.gt(data.version, getAppVersion());\n      if (isNewer && ('android-arm64' in data.platforms || 'android-universal' in data.platforms)) {\n        setUpdaterWindowVisible(true, data.version!, getAppVersion());\n      }\n      return isNewer;\n    } catch (err) {\n      console.warn('Failed to fetch Android update info', err);\n      throw new Error('Failed to fetch Android update info');\n    }\n  }\n\n  return false;\n};\n\nconst LAST_SHOWN_RELEASE_NOTES_KEY = 'lastShownReleaseNotesVersion';\n\nexport const setLastShownReleaseNotesVersion = (version: string) => {\n  localStorage.setItem(LAST_SHOWN_RELEASE_NOTES_KEY, version);\n};\n\nexport const getLastShownReleaseNotesVersion = () => {\n  return localStorage.getItem(LAST_SHOWN_RELEASE_NOTES_KEY) || '';\n};\n\nexport const checkAppReleaseNotes = async (isAutoCheck = true) => {\n  const currentVersion = getAppVersion();\n  const lastShownVersion = getLastShownReleaseNotesVersion();\n  if ((lastShownVersion && semver.gt(currentVersion, lastShownVersion)) || !isAutoCheck) {\n    try {\n      const fetchFunc = isTauriAppPlatform() ? fetch : window.fetch;\n      const res = await fetchFunc(READEST_CHANGELOG_FILE);\n      if (res.ok) {\n        setUpdaterWindowVisible(true, currentVersion, lastShownVersion, false);\n        return true;\n      }\n    } catch (err) {\n      console.warn('Failed to fetch release notes', err);\n    }\n  } else if (!lastShownVersion) {\n    setLastShownReleaseNotesVersion(currentVersion);\n  }\n  return false;\n};\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;;;;;;;;;AAMA,MAAM,iBAAiB;AAEvB,MAAM,mBAAmB,CAAC;IACxB,MAAM,MAAM,IAAI,8OAAa,CAAC,WAAW;QACvC,KAAK,CAAC,uBAAuB,EAAE,eAAe;QAC9C,OAAO;QACP,OAAO;QACP,QAAQ;QACR,QAAQ;QACR,WAAW;IACb;IACA,IAAI,IAAI,CAAC,mBAAmB;QAC1B,QAAQ,GAAG,CAAC;IACd;IACA,IAAI,IAAI,CAAC,iBAAiB,CAAC;QACzB,QAAQ,KAAK,CAAC,yBAAyB;IACzC;AACF;AAEO,MAAM,qBAAqB,OAChC,GACA,cAAc,IAAI;IAElB,MAAM,YAAY,aAAa,OAAO,CAAC;IACvC,MAAM,MAAM,KAAK,GAAG;IACpB,IAAI,eAAe,aAAa,MAAM,SAAS,WAAW,MAAM,sLAAyB,GAAG,MAC1F,OAAO;IACT,aAAa,OAAO,CAAC,gBAAgB,IAAI,QAAQ;IAEjD,QAAQ,GAAG,CAAC;IACZ,MAAM,UAAU,IAAA,6PAAM;IACtB,IAAI;QAAC;QAAS;QAAW;KAAQ,CAAC,QAAQ,CAAC,UAAU;QACnD,MAAM,SAAS,MAAM,IAAA,wQAAK;QAC1B,IAAI,QAAQ;YACV,iBAAiB,OAAO,OAAO;QACjC;QACA,OAAO,CAAC,CAAC;IACX,OAAO,IAAI,YAAY,WAAW;QAChC,IAAI;YACF,MAAM,WAAW,MAAM,IAAA,kQAAK,EAAC,iLAAoB,EAAE;gBAAE,gBAAgB;YAAK;YAC1E,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,MAAM,UAAU,gMAAM,CAAC,EAAE,CAAC,KAAK,OAAO,EAAE,IAAA,qKAAa;YACrD,IAAI,WAAW,CAAC,mBAAmB,KAAK,SAAS,IAAI,uBAAuB,KAAK,SAAS,GAAG;gBAC3F,IAAA,2LAAuB,EAAC,MAAM,KAAK,OAAO,EAAG,IAAA,qKAAa;YAC5D;YACA,OAAO;QACT,EAAE,OAAO,KAAK;YACZ,QAAQ,IAAI,CAAC,uCAAuC;YACpD,MAAM,IAAI,MAAM;QAClB;IACF;IAEA,OAAO;AACT;AAEA,MAAM,+BAA+B;AAE9B,MAAM,kCAAkC,CAAC;IAC9C,aAAa,OAAO,CAAC,8BAA8B;AACrD;AAEO,MAAM,kCAAkC;IAC7C,OAAO,aAAa,OAAO,CAAC,iCAAiC;AAC/D;AAEO,MAAM,uBAAuB,OAAO,cAAc,IAAI;IAC3D,MAAM,iBAAiB,IAAA,qKAAa;IACpC,MAAM,mBAAmB;IACzB,IAAI,AAAC,oBAAoB,gMAAM,CAAC,EAAE,CAAC,gBAAgB,qBAAsB,CAAC,aAAa;QACrF,IAAI;YACF,MAAM,YAAY,IAAA,iLAAkB,MAAK,kQAAK,GAAG,OAAO,KAAK;YAC7D,MAAM,MAAM,MAAM,UAAU,mLAAsB;YAClD,IAAI,IAAI,EAAE,EAAE;gBACV,IAAA,2LAAuB,EAAC,MAAM,gBAAgB,kBAAkB;gBAChE,OAAO;YACT;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,IAAI,CAAC,iCAAiC;QAChD;IACF,OAAO,IAAI,CAAC,kBAAkB;QAC5B,gCAAgC;IAClC;IACA,OAAO;AACT"}},
    {"offset": {"line": 5751, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/settings.ts"],"sourcesContent":["import { ViewSettings } from '@/types/book';\nimport { SystemSettings } from '@/types/settings';\nimport { EnvConfigType } from '@/services/environment';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { getStyles } from '@/utils/style';\n\nexport const saveViewSettings = async <K extends keyof ViewSettings>(\n  envConfig: EnvConfigType,\n  bookKey: string,\n  key: K,\n  value: ViewSettings[K],\n  skipGlobal = false,\n  applyStyles = true,\n) => {\n  const { settings, isSettingsGlobal, setSettings, saveSettings } = useSettingsStore.getState();\n  const { bookKeys, getView, getViewState, getViewSettings, setViewSettings } =\n    useReaderStore.getState();\n  const { getConfig, saveConfig } = useBookDataStore.getState();\n\n  const applyViewSettings = async (bookKey: string) => {\n    const viewSettings = getViewSettings(bookKey);\n    const viewState = getViewState(bookKey);\n    if (bookKey && viewSettings && viewSettings[key] !== value) {\n      viewSettings[key] = value;\n      setViewSettings(bookKey, viewSettings);\n      if (applyStyles) {\n        const view = getView(bookKey);\n        view?.renderer.setStyles?.(getStyles(viewSettings));\n      }\n      const config = getConfig(bookKey);\n      if (viewState?.isPrimary && config) {\n        await saveConfig(envConfig, bookKey, config, settings);\n      }\n    }\n  };\n\n  if (isSettingsGlobal && !skipGlobal) {\n    settings.globalViewSettings[key] = value;\n    setSettings(settings);\n\n    for (const bookKey of bookKeys) {\n      await applyViewSettings(bookKey);\n    }\n    await saveSettings(envConfig, settings);\n  } else if (bookKey) {\n    await applyViewSettings(bookKey);\n  }\n};\n\nexport const saveSysSettings = async <K extends keyof SystemSettings>(\n  envConfig: EnvConfigType,\n  key: K,\n  value: SystemSettings[K],\n) => {\n  const { settings, setSettings, saveSettings } = useSettingsStore.getState();\n  if (settings[key] !== value) {\n    settings[key] = value;\n    setSettings(settings);\n    await saveSettings(envConfig, settings);\n  }\n};\n"],"names":[],"mappings":";;;;;;AAGA;AACA;AACA;AACA;;;;;AAEO,MAAM,mBAAmB,OAC9B,WACA,SACA,KACA,OACA,aAAa,KAAK,EAClB,cAAc,IAAI;IAElB,MAAM,EAAE,QAAQ,EAAE,gBAAgB,EAAE,WAAW,EAAE,YAAY,EAAE,GAAG,8KAAgB,CAAC,QAAQ;IAC3F,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,YAAY,EAAE,eAAe,EAAE,eAAe,EAAE,GACzE,0KAAc,CAAC,QAAQ;IACzB,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,8KAAgB,CAAC,QAAQ;IAE3D,MAAM,oBAAoB,OAAO;QAC/B,MAAM,eAAe,gBAAgB;QACrC,MAAM,YAAY,aAAa;QAC/B,IAAI,WAAW,gBAAgB,YAAY,CAAC,IAAI,KAAK,OAAO;YAC1D,YAAY,CAAC,IAAI,GAAG;YACpB,gBAAgB,SAAS;YACzB,IAAI,aAAa;gBACf,MAAM,OAAO,QAAQ;gBACrB,MAAM,SAAS,YAAY,IAAA,+JAAS,EAAC;YACvC;YACA,MAAM,SAAS,UAAU;YACzB,IAAI,WAAW,aAAa,QAAQ;gBAClC,MAAM,WAAW,WAAW,SAAS,QAAQ;YAC/C;QACF;IACF;IAEA,IAAI,oBAAoB,CAAC,YAAY;QACnC,SAAS,kBAAkB,CAAC,IAAI,GAAG;QACnC,YAAY;QAEZ,KAAK,MAAM,WAAW,SAAU;YAC9B,MAAM,kBAAkB;QAC1B;QACA,MAAM,aAAa,WAAW;IAChC,OAAO,IAAI,SAAS;QAClB,MAAM,kBAAkB;IAC1B;AACF;AAEO,MAAM,kBAAkB,OAC7B,WACA,KACA;IAEA,MAAM,EAAE,QAAQ,EAAE,WAAW,EAAE,YAAY,EAAE,GAAG,8KAAgB,CAAC,QAAQ;IACzE,IAAI,QAAQ,CAAC,IAAI,KAAK,OAAO;QAC3B,QAAQ,CAAC,IAAI,GAAG;QAChB,YAAY;QACZ,MAAM,aAAa,WAAW;IAChC;AACF"}},
    {"offset": {"line": 5811, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/shortcuts.ts"],"sourcesContent":["const DEFAULT_SHORTCUTS = {\n  onSwitchSideBar: ['ctrl+Tab', 'opt+Tab', 'alt+Tab'],\n  onToggleSideBar: ['s'],\n  onToggleNotebook: ['n'],\n  onShowSearchBar: ['ctrl+f', 'cmd+f'],\n  onToggleScrollMode: ['shift+j'],\n  onToggleSelectMode: ['shift+s'],\n  onToggleBookmark: ['ctrl+d', 'cmd+d'],\n  onToggleTTS: ['t'],\n  onHighlightSelection: ['ctrl+h', 'cmd+h'],\n  onUnderlineSelection: ['ctrl+u', 'cmd+u'],\n  onAnnotateSelection: ['ctrl+n', 'cmd+n'],\n  onSearchSelection: ['ctrl+f', 'cmd+f'],\n  onCopySelection: ['ctrl+c', 'cmd+c'],\n  onTranslateSelection: ['ctrl+t', 'cmd+t'],\n  onDictionarySelection: ['ctrl+d', 'cmd+d'],\n  onWikipediaSelection: ['ctrl+w', 'cmd+w'],\n  onReadAloudSelection: ['ctrl+r', 'cmd+r'],\n  onProofreadSelection: ['ctrl+p', 'cmd+p'],\n  onOpenFontLayoutSettings: ['shift+f', 'ctrl+,', 'cmd+,'],\n  onOpenBooks: ['ctrl+o'],\n  onReloadPage: ['shift+r'],\n  onToggleFullscreen: ['F11'],\n  onCloseWindow: ['ctrl+w', 'cmd+w'],\n  onQuitApp: ['ctrl+q', 'cmd+q'],\n  onGoLeft: ['ArrowLeft', 'h', 'shift+ '],\n  onGoRight: ['ArrowRight', 'l', ' '],\n  onGoUp: ['ArrowUp', 'k'],\n  onGoDown: ['ArrowDown', 'j'],\n  onGoNext: ['shift+j', 'shift+ArrowRight', 'shift+ArrowDown', 'PageDown'],\n  onGoPrev: ['shift+k', 'shift+ArrowLeft', 'shift+ArrowUp', 'PageUp'],\n  onGoLeftSection: ['opt+ArrowLeft', 'alt+ArrowLeft'],\n  onGoRightSection: ['opt+ArrowRight', 'alt+ArrowRight'],\n  onGoPrevSection: ['opt+ArrowUp', 'alt+ArrowUp'],\n  onGoNextSection: ['opt+ArrowDown', 'alt+ArrowDown'],\n  onGoHalfPageDown: ['shift+ArrowDown', 'd'],\n  onGoHalfPageUp: ['shift+ArrowUp', 'u'],\n  onGoBack: ['shift+ArrowLeft', 'shift+h', 'alt+ArrowLeft'],\n  onGoForward: ['shift+ArrowRight', 'shift+l', 'alt+ArrowRight'],\n  onZoomIn: ['ctrl+=', 'cmd+=', 'shift+='],\n  onZoomOut: ['ctrl+-', 'cmd+-', 'shift+-'],\n  onResetZoom: ['ctrl+0', 'cmd+0'],\n  onSaveNote: ['ctrl+Enter'],\n  onEscape: ['Escape'],\n};\n\nexport type ShortcutConfig = {\n  [K in keyof typeof DEFAULT_SHORTCUTS]: string[];\n};\n\n// Load shortcuts from localStorage or fallback to defaults\nexport const loadShortcuts = (): ShortcutConfig => {\n  if (typeof localStorage === 'undefined') return DEFAULT_SHORTCUTS;\n  const customShortcuts = JSON.parse(localStorage.getItem('customShortcuts') || '{}');\n  return {\n    ...DEFAULT_SHORTCUTS,\n    ...customShortcuts,\n  };\n};\n\n// Save custom shortcuts to localStorage\nexport const saveShortcuts = (shortcuts: ShortcutConfig) => {\n  localStorage.setItem('customShortcuts', JSON.stringify(shortcuts));\n};\n"],"names":[],"mappings":";;;;;;AAAA,MAAM,oBAAoB;IACxB,iBAAiB;QAAC;QAAY;QAAW;KAAU;IACnD,iBAAiB;QAAC;KAAI;IACtB,kBAAkB;QAAC;KAAI;IACvB,iBAAiB;QAAC;QAAU;KAAQ;IACpC,oBAAoB;QAAC;KAAU;IAC/B,oBAAoB;QAAC;KAAU;IAC/B,kBAAkB;QAAC;QAAU;KAAQ;IACrC,aAAa;QAAC;KAAI;IAClB,sBAAsB;QAAC;QAAU;KAAQ;IACzC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,qBAAqB;QAAC;QAAU;KAAQ;IACxC,mBAAmB;QAAC;QAAU;KAAQ;IACtC,iBAAiB;QAAC;QAAU;KAAQ;IACpC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,uBAAuB;QAAC;QAAU;KAAQ;IAC1C,sBAAsB;QAAC;QAAU;KAAQ;IACzC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,0BAA0B;QAAC;QAAW;QAAU;KAAQ;IACxD,aAAa;QAAC;KAAS;IACvB,cAAc;QAAC;KAAU;IACzB,oBAAoB;QAAC;KAAM;IAC3B,eAAe;QAAC;QAAU;KAAQ;IAClC,WAAW;QAAC;QAAU;KAAQ;IAC9B,UAAU;QAAC;QAAa;QAAK;KAAU;IACvC,WAAW;QAAC;QAAc;QAAK;KAAI;IACnC,QAAQ;QAAC;QAAW;KAAI;IACxB,UAAU;QAAC;QAAa;KAAI;IAC5B,UAAU;QAAC;QAAW;QAAoB;QAAmB;KAAW;IACxE,UAAU;QAAC;QAAW;QAAmB;QAAiB;KAAS;IACnE,iBAAiB;QAAC;QAAiB;KAAgB;IACnD,kBAAkB;QAAC;QAAkB;KAAiB;IACtD,iBAAiB;QAAC;QAAe;KAAc;IAC/C,iBAAiB;QAAC;QAAiB;KAAgB;IACnD,kBAAkB;QAAC;QAAmB;KAAI;IAC1C,gBAAgB;QAAC;QAAiB;KAAI;IACtC,UAAU;QAAC;QAAmB;QAAW;KAAgB;IACzD,aAAa;QAAC;QAAoB;QAAW;KAAiB;IAC9D,UAAU;QAAC;QAAU;QAAS;KAAU;IACxC,WAAW;QAAC;QAAU;QAAS;KAAU;IACzC,aAAa;QAAC;QAAU;KAAQ;IAChC,YAAY;QAAC;KAAa;IAC1B,UAAU;QAAC;KAAS;AACtB;AAOO,MAAM,gBAAgB;IAC3B,IAAI,OAAO,iBAAiB,aAAa,OAAO;IAChD,MAAM,kBAAkB,KAAK,KAAK,CAAC,aAAa,OAAO,CAAC,sBAAsB;IAC9E,OAAO;QACL,GAAG,iBAAiB;QACpB,GAAG,eAAe;IACpB;AACF;AAGO,MAAM,gBAAgB,CAAC;IAC5B,aAAa,OAAO,CAAC,mBAAmB,KAAK,SAAS,CAAC;AACzD"}},
    {"offset": {"line": 6011, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/types/book.ts"],"sourcesContent":["import { BookMetadata } from '@/libs/document';\nimport { TTSHighlightOptions } from '@/services/tts/types';\nimport { AnnotationToolType } from './annotator';\n\nexport type BookFormat =\n  | 'EPUB'\n  | 'PDF'\n  | 'MOBI'\n  | 'AZW'\n  | 'AZW3'\n  | 'CBZ'\n  | 'FB2'\n  | 'FBZ'\n  | 'TXT'\n  | 'MD';\nexport type BookNoteType = 'bookmark' | 'annotation' | 'excerpt';\nexport type HighlightStyle = 'highlight' | 'underline' | 'squiggly';\nexport type HighlightColor = 'red' | 'yellow' | 'green' | 'blue' | 'violet';\n\nexport const FIXED_LAYOUT_FORMATS: Set<BookFormat> = new Set(['PDF', 'CBZ']);\n\nexport interface Book {\n  // if Book is a remote book we just lazy load the book content via url\n  url?: string;\n  // if Book is a transient local book we can load the book content via filePath\n  filePath?: string;\n  // For local storage mode: relative path from storage root (e.g., \"fiction/book.epub\")\n  relativePath?: string;\n  // Absolute file path in the file system (for path reconciliation)\n  absolutePath?: string;\n  // Partial md5 hash of the book file, used as the unique identifier\n  hash: string;\n  // Metadata md5 hash, used to aggregate different versions of the same book\n  metaHash?: string;\n  format: BookFormat;\n  title: string; // editable title from metadata\n  sourceTitle?: string; // parsed when the book is imported and used to locate the file\n  author: string;\n  group?: string; // deprecated in favor of groupId and groupName\n  groupId?: string;\n  groupName?: string;\n  tags?: string[];\n  coverImageUrl?: string | null;\n\n  createdAt: number;\n  updatedAt: number;\n  deletedAt?: number | null;\n\n  uploadedAt?: number | null;\n  downloadedAt?: number | null;\n  coverDownloadedAt?: number | null;\n  syncedAt?: number | null;\n\n  lastUpdated?: number; // deprecated in favor of updatedAt\n  progress?: [number, number]; // Add progress field: [current, total], 1-based page number\n  primaryLanguage?: string;\n\n  metadata?: BookMetadata;\n}\n\nexport interface BookGroupType {\n  id: string;\n  name: string;\n}\n\nexport interface PageInfo {\n  current: number;\n  next?: number;\n  total: number;\n}\n\n// Remaining time of the book in minutes\nexport interface TimeInfo {\n  section: number;\n  total: number;\n}\n\nexport interface BookNote {\n  bookHash?: string;\n  metaHash?: string;\n  id: string;\n  type: BookNoteType;\n  cfi: string;\n  text?: string;\n  style?: HighlightStyle;\n  color?: HighlightColor;\n  note: string;\n\n  createdAt: number;\n  updatedAt: number;\n  deletedAt?: number | null;\n}\n\nexport interface BooknoteGroup {\n  id: number;\n  href: string;\n  label: string;\n  booknotes: BookNote[];\n}\n\nexport type WritingMode = 'auto' | 'horizontal-tb' | 'horizontal-rl' | 'vertical-rl';\n\nexport interface BookLayout {\n  marginTopPx: number;\n  marginBottomPx: number;\n  marginLeftPx: number;\n  marginRightPx: number;\n  marginPx?: number; // deprecated\n  compactMarginTopPx: number;\n  compactMarginBottomPx: number;\n  compactMarginLeftPx: number;\n  compactMarginRightPx: number;\n  compactMarginPx?: number; // deprecated\n  gapPercent: number;\n  scrolled: boolean;\n  disableClick: boolean;\n  fullscreenClickArea: boolean;\n  swapClickArea: boolean;\n  disableDoubleClick: boolean;\n  volumeKeysToFlip: boolean;\n  continuousScroll: boolean;\n  maxColumnCount: number;\n  maxInlineSize: number;\n  maxBlockSize: number;\n  animated: boolean;\n  isEink: boolean;\n  writingMode: WritingMode;\n  vertical: boolean;\n  rtl: boolean;\n  scrollingOverlap: number;\n  allowScript: boolean;\n}\n\nexport interface BookStyle {\n  zoomLevel: number;\n  paragraphMargin: number;\n  lineHeight: number;\n  wordSpacing: number;\n  letterSpacing: number;\n  textIndent: number;\n  fullJustification: boolean;\n  hyphenation: boolean;\n  invertImgColorInDark: boolean;\n  theme: string;\n  overrideFont: boolean;\n  overrideLayout: boolean;\n  overrideColor: boolean;\n  backgroundTextureId: string;\n  backgroundOpacity: number;\n  backgroundSize: string;\n  codeHighlighting: boolean;\n  codeLanguage: string;\n  userStylesheet: string;\n  userUIStylesheet: string;\n\n  // fixed-layout specific\n  zoomMode: 'fit-page' | 'fit-width' | 'original-size' | 'custom';\n  spreadMode: 'auto' | 'none';\n  keepCoverSpread: boolean;\n}\n\nexport interface BookFont {\n  serifFont: string;\n  sansSerifFont: string;\n  monospaceFont: string;\n  defaultFont: string;\n  defaultCJKFont: string;\n  defaultFontSize: number;\n  minimumFontSize: number;\n  fontWeight: number;\n}\n\nexport type ConvertChineseVariant =\n  | 'none'\n  | 's2t'\n  | 't2s'\n  | 's2tw'\n  | 's2hk'\n  | 's2twp'\n  | 'tw2s'\n  | 'hk2s'\n  | 'tw2sp';\n\nexport interface BookLanguage {\n  replaceQuotationMarks: boolean;\n  convertChineseVariant: ConvertChineseVariant;\n}\n\nexport interface ViewConfig {\n  sideBarTab: string;\n  uiLanguage: string;\n  sortedTOC: boolean;\n\n  doubleBorder: boolean;\n  borderColor: string;\n\n  showHeader: boolean;\n  showFooter: boolean;\n  showRemainingTime: boolean;\n  showRemainingPages: boolean;\n  showProgressInfo: boolean;\n  tapToToggleFooter: boolean;\n  showBarsOnScroll: boolean;\n  showMarginsOnScroll: boolean;\n  progressStyle: 'percentage' | 'fraction';\n  progressInfoMode: 'remaining' | 'progress' | 'all' | 'none';\n}\n\nexport interface TTSConfig {\n  ttsRate: number;\n  ttsVoice: string;\n  ttsLocation: string;\n  showTTSBar: boolean;\n  ttsHighlightOptions: TTSHighlightOptions;\n}\n\nexport interface TranslatorConfig {\n  translationEnabled: boolean;\n  translationProvider: string;\n  translateTargetLang: string;\n  showTranslateSource: boolean;\n  ttsReadAloudText: string;\n}\n\nexport interface NoteExportConfig {\n  includeTitle: boolean;\n  includeAuthor: boolean;\n  includeDate: boolean;\n  includeChapterTitles: boolean;\n  includeQuotes: boolean;\n  includeNotes: boolean;\n  includeTimestamp: boolean;\n  includeChapterSeparator: boolean;\n  noteSeparator: string;\n  useCustomTemplate: boolean;\n  customTemplate: string;\n}\n\nexport interface AnnotatorConfig {\n  enableAnnotationQuickActions: boolean;\n  annotationQuickAction: AnnotationToolType | null;\n  copyToNotebook: boolean;\n  noteExportConfig: NoteExportConfig;\n}\n\nexport interface ScreenConfig {\n  screenOrientation: 'auto' | 'portrait' | 'landscape';\n}\n\nexport type ProofreadScope = 'selection' | 'book' | 'library';\n\nexport interface ProofreadRule {\n  id: string;\n  scope: ProofreadScope;\n  pattern: string;\n  replacement: string;\n  cfi?: string;\n  sectionHref?: string;\n  enabled: boolean;\n  isRegex: boolean;\n  order: number; // Lower numbers apply first\n  wholeWord?: boolean; // Match whole words only (uses \\b word boundaries)\n  caseSensitive?: boolean; // Case-sensitive matching (default true)\n  onlyForTTS?: boolean; // Only replace text for TTS, not in the book display (only for book/library scope)\n}\n\nexport interface ProofreadRulesConfig {\n  proofreadRules?: ProofreadRule[];\n}\n\nexport interface ViewSettings\n  extends BookLayout,\n  BookStyle,\n  BookFont,\n  BookLanguage,\n  ViewConfig,\n  TTSConfig,\n  TranslatorConfig,\n  ScreenConfig,\n  ProofreadRulesConfig,\n  AnnotatorConfig { }\n\nexport interface BookProgress {\n  location: string;\n  sectionId: number;\n  sectionHref: string;\n  sectionLabel: string;\n  section: PageInfo;\n  pageinfo: PageInfo;\n  timeinfo: TimeInfo;\n  range: Range;\n}\n\nexport interface BookSearchConfig {\n  scope: 'book' | 'section';\n  matchCase: boolean;\n  matchWholeWords: boolean;\n  matchDiacritics: boolean;\n  index?: number;\n  query?: string;\n  acceptNode?: (node: Node) => number;\n\n  // pre-cached search results\n  results?: BookSearchResult[] | BookSearchMatch[] | null;\n}\n\nexport interface SearchExcerpt {\n  pre: string;\n  match: string;\n  post: string;\n}\n\nexport interface BookSearchMatch {\n  cfi: string;\n  excerpt: SearchExcerpt;\n}\n\nexport interface BookSearchResult {\n  index?: number;\n  label: string;\n  subitems: BookSearchMatch[];\n  progress?: number;\n}\n\nexport interface BookConfig {\n  bookHash?: string;\n  metaHash?: string;\n  progress?: [number, number]; // [current pagenum, total pagenum], 1-based page number\n  location?: string; // CFI of the current location\n  xpointer?: string; // XPointer of the current location (for Koreader interoperability)\n  booknotes?: BookNote[];\n  searchConfig?: Partial<BookSearchConfig>;\n  viewSettings?: Partial<ViewSettings>;\n\n  lastSyncedAtConfig?: number;\n  lastSyncedAtNotes?: number;\n\n  updatedAt: number;\n}\n\nexport interface BookDataRecord {\n  id: string;\n  book_hash: string;\n  meta_hash?: string;\n  user_id: string;\n  updated_at: number | null;\n  deleted_at: number | null;\n}\n\nexport interface BooksGroup {\n  id: string;\n  name: string;\n  displayName: string;\n  books: Book[];\n\n  updatedAt: number;\n}\nexport interface BookContent {\n  book: Book;\n  file: File;\n}\n"],"names":[],"mappings":";;;;AAmBO,MAAM,uBAAwC,IAAI,IAAI;IAAC;IAAO;CAAM"}},
    {"offset": {"line": 6025, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/apps/readest-app/src/data/demo/library.en.json"],"sourcesContent":["{\"library\":[\"https://cdn.readest.com/books/a-room-of-one-s-own.epub\",\"https://cdn.readest.com/books/hamlet.epub\",\"https://cdn.readest.com/books/meditations.epub\",\"https://cdn.readest.com/books/the-great-gatsby.epub\",\"https://cdn.readest.com/books/the-scarlet-letter.epub\",\"https://cdn.readest.com/books/this-side-of-paradise.epub\"]}"],"names":[],"mappings":"AAAA"}},
    {"offset": {"line": 6025, "column": 358}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 6028, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/apps/readest-app/src/data/demo/library.zh.json"],"sourcesContent":["{\"library\":[]}"],"names":[],"mappings":"AAAA"}},
    {"offset": {"line": 6028, "column": 40}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 6032, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/styles/fonts.ts"],"sourcesContent":["import { isCJKEnv } from '@/utils/misc';\nimport { getFilename } from '@/utils/path';\nimport { md5Fingerprint } from '@/utils/md5';\n\nexport type FontFormat = 'ttf' | 'otf' | 'woff' | 'woff2';\n\nconst basicGoogleFonts = [\n  { family: 'Bitter', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Fira Code', weights: 'wght@300..700' },\n  { family: 'Literata', weights: 'ital,opsz,wght@0,7..72,200..900;1,7..72,200..900' },\n  { family: 'Merriweather', weights: 'ital,opsz,wght@0,18..144,300..900;1,18..144,300..900' },\n  { family: 'Noto Sans', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Open Sans', weights: 'ital,wght@0,300..800;1,300..800' },\n  { family: 'Roboto', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Roboto Slab', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Vollkorn', weights: 'ital,wght@0,400..900;1,400..900' },\n  { family: 'PT Sans', weights: 'ital,wght@0,400;0,700;1,400;1,700' },\n  { family: 'PT Serif', weights: 'ital,wght@0,400;0,700;1,400;1,700' },\n  { family: 'PT Mono', weights: '' },\n];\n\nconst cjkGoogleFonts = [\n  { family: 'LXGW WenKai TC', weights: '' },\n  { family: 'Noto Sans SC', weights: '' },\n  { family: 'Noto Sans TC', weights: '' },\n  { family: 'Noto Serif JP', weights: '' },\n];\n\n// Resource hints for faster font loading\nconst getResourceHints = (includeCJK = false) => {\n  const basicHints = `\n  <!-- Preconnect to Google Fonts for faster DNS resolution and connection -->\n  <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n  <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n  <link rel=\"dns-prefetch\" href=\"https://fonts.googleapis.com\">\n  <link rel=\"dns-prefetch\" href=\"https://fonts.gstatic.com\">\n`;\n\n  const cjkHints = `\n  <!-- Preconnect to CJK font CDNs -->\n  <link rel=\"preconnect\" href=\"https://cdn.jsdelivr.net\">\n  <link rel=\"preconnect\" href=\"https://cdnjs.cloudflare.com\">\n  <link rel=\"preconnect\" href=\"https://ik.imagekit.io\">\n  <link rel=\"preconnect\" href=\"https://db.onlinewebfonts.com\">\n  <link rel=\"dns-prefetch\" href=\"https://cdn.jsdelivr.net\">\n  <link rel=\"dns-prefetch\" href=\"https://cdnjs.cloudflare.com\">\n  <link rel=\"dns-prefetch\" href=\"https://ik.imagekit.io\">\n  <link rel=\"dns-prefetch\" href=\"https://db.onlinewebfonts.com\">\n`;\n\n  return includeCJK ? basicHints + cjkHints : basicHints;\n};\n\nconst getAdditionalBasicFontLinks = () => `\n  <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css2?${basicGoogleFonts\n    .map(\n      ({ family, weights }) =>\n        `family=${encodeURIComponent(family)}${weights ? `:${weights}` : ''}`,\n    )\n    .join('&')}&display=swap\" crossorigin=\"anonymous\">\n`;\n\nconst getAdditionalCJKFontLinks = () => `\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/misans-webfont@1.0.4/misans-l3/misans-l3/result.min.css\" crossorigin=\"anonymous\" />\n  <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-web/1.520.0/lxgwwenkaigbscreen/result.css\" crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/hwmct/dist/%E6%B1%87%E6%96%87%E6%98%8E%E6%9C%9D%E4%BD%93/result.css' crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/jhlst/dist/%E4%BA%AC%E8%8F%AF%E8%80%81%E5%AE%8B%E4%BD%93v2_002/result.css' crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/syst/dist/SourceHanSerifCN/result.css' crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/GuanKiapTsingKhai/dist/GuanKiapTsingKhai-T/result.css' crossorigin=\"anonymous\" />\n  <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css2?${cjkGoogleFonts\n    .map(\n      ({ family, weights }) =>\n        `family=${encodeURIComponent(family)}${weights ? `:${weights}` : ''}`,\n    )\n    .join('&')}&display=swap\" crossorigin=\"anonymous\" />\n`;\n\nconst getAdditionalCJKFontFaces = () => `\n  @font-face {\n    font-family: \"FangSong\";\n    font-display: swap;\n    src: local(\"Fang Song\"), local(\"FangSong\"), local(\"Noto Serif CJK\"), local(\"Source Han Serif SC VF\"), url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.eot?#iefix\") format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.woff2\") format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.woff\") format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.ttf\") format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.svg#FangSong\") format(\"svg\");\n  }\n  @font-face {\n    font-family: \"Kaiti\";\n    font-display: swap;\n    src: local(\"Kai\"), local(\"KaiTi\"), local(\"AR PL UKai\"), local(\"LXGW WenKai GB Screen\"), url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.eot?#iefix\")format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.woff2\")format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.woff\")format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.ttf\")format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.svg#STKaiti\")format(\"svg\");\n  }\n  @font-face {\n    font-family: \"Heiti\";\n    font-display: swap;\n    src: local(\"Hei\"), local(\"SimHei\"), local(\"WenQuanYi Zen Hei\"), local(\"Source Han Sans SC VF\"), url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.eot?#iefix\")format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.woff2\")format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.woff\")format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.ttf\")format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.svg#WenQuanYi Micro Hei\")format(\"svg\");\n  }\n  @font-face {\n    font-family: \"XiHeiti\";\n    font-display: swap;\n    src: local(\"PingFang SC\"), local(\"Microsoft YaHei\"), local(\"WenQuanYi Micro Hei\"), local(\"FZHei-B01\"), url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.eot?#iefix\")format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.woff2\")format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.woff\")format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.ttf\")format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.svg#STHeiti J Light\")format(\"svg\");\n}\n`;\n\nexport const mountAdditionalFonts = async (document: Document, isCJK = false) => {\n  const mountCJKFonts = isCJK || isCJKEnv();\n\n  const hints = getResourceHints(mountCJKFonts);\n  const hintsParser = new DOMParser();\n  const hintsDocument = hintsParser.parseFromString(hints, 'text/html');\n\n  // Mount resource hints at the beginning of head for priority\n  Array.from(hintsDocument.head.children).forEach((child) => {\n    if (child.tagName === 'LINK') {\n      const link = document.createElement('link');\n      link.rel = child.getAttribute('rel') || '';\n      link.href = child.getAttribute('href') || '';\n      const crossorigin = child.getAttribute('crossorigin');\n      if (crossorigin) {\n        link.crossOrigin = crossorigin;\n      }\n\n      // Insert at the beginning of head for maximum priority\n      if (document.head.firstChild) {\n        document.head.insertBefore(link, document.head.firstChild);\n      } else {\n        document.head.appendChild(link);\n      }\n    }\n  });\n\n  // Mount font stylesheets and @font-face rules\n  let links = getAdditionalBasicFontLinks();\n  let fontFaces = '';\n\n  if (mountCJKFonts) {\n    fontFaces = getAdditionalCJKFontFaces();\n    links = `${links}\\n${getAdditionalCJKFontLinks()}`;\n  }\n\n  if (fontFaces) {\n    const style = document.createElement('style');\n    style.textContent = fontFaces;\n    document.head.appendChild(style);\n  }\n\n  const parser = new DOMParser();\n  const linksDocument = parser.parseFromString(links, 'text/html');\n\n  Array.from(linksDocument.head.children).forEach((child) => {\n    if (child.tagName === 'LINK') {\n      const link = document.createElement('link');\n      link.rel = child.getAttribute('rel') || '';\n      link.href = child.getAttribute('href') || '';\n      link.crossOrigin = child.getAttribute('crossorigin') || '';\n\n      document.head.appendChild(link);\n    }\n  });\n};\n\nexport type FontStyle = 'normal' | 'italic' | 'oblique';\n\nexport interface CustomFont {\n  id: string;\n  name: string;\n  path: string;\n  family?: string;\n  style?: string;\n  weight?: number;\n  variable?: boolean;\n\n  downloadedAt?: number;\n  deletedAt?: number;\n\n  blobUrl?: string;\n  loaded?: boolean;\n  error?: string;\n}\n\nexport type CustomFontInfo = Partial<CustomFont> &\n  Required<Pick<CustomFont, 'path' | 'name' | 'family' | 'style' | 'weight' | 'variable'>>;\n\nexport function getFontName(path: string): string {\n  const fileName = getFilename(path);\n  return fileName.replace(/\\.(ttf|otf|woff|woff2)$/i, '');\n}\n\nexport function getFontId(name: string): string {\n  return md5Fingerprint(name);\n}\n\nexport function getFontFormat(path: string): FontFormat {\n  const extension = path.toLowerCase().split('.').pop();\n  switch (extension) {\n    case 'ttf':\n      return 'ttf';\n    case 'otf':\n      return 'otf';\n    case 'woff':\n      return 'woff';\n    case 'woff2':\n      return 'woff2';\n    default:\n      return 'ttf';\n  }\n}\n\nexport function getMimeType(format: FontFormat): string {\n  const types = { ttf: 'font/ttf', otf: 'font/otf', woff: 'font/woff', woff2: 'font/woff2' };\n  return types[format] || 'font/ttf';\n}\n\nexport function getCSSFormatString(format: FontFormat): string {\n  const formats = { ttf: 'truetype', otf: 'opentype', woff: 'woff', woff2: 'woff2' };\n  return formats[format] || 'truetype';\n}\n\nexport function createFontFamily(name: string): string {\n  return name.replace(/\\s+/g, ' ').trim();\n}\n\nexport function createFontCSS(font: CustomFont): string {\n  const format = getFontFormat(font.path);\n  const cssFormat = getCSSFormatString(format);\n  const fontFamily = createFontFamily(font.family || font.name);\n  const fontStyle = font.style || 'normal';\n  const fontWeight = font.weight || 400;\n  const variable = font.variable || false;\n  if (!font.blobUrl) {\n    throw new Error(`Blob URL not available for font: ${font.name}`);\n  }\n\n  const css = `\n    @font-face {\n      font-family: \"${fontFamily}\";\n      ${variable ? '' : `font-style: ${fontStyle};`}\n      ${variable ? '' : `font-weight: ${fontWeight};`}\n      src: url(\"${font.blobUrl}\") format(\"${cssFormat}\");\n      font-display: swap;\n    }\n  `;\n\n  return css;\n}\n\nexport function createCustomFont(\n  path: string,\n  options?: Partial<Omit<CustomFont, 'id' | 'path'>>,\n): CustomFont {\n  const name = options?.name || getFontName(path);\n  return {\n    id: getFontId(name),\n    name,\n    family: options?.family,\n    style: options?.style,\n    weight: options?.weight,\n    variable: options?.variable,\n    path,\n  };\n}\n\nexport const mountCustomFont = (document: Document, font: CustomFont) => {\n  const fontStyleId = `custom-font-${font.id}`;\n  const styleElement = document.getElementById(fontStyleId) || document.createElement('style');\n  styleElement.id = fontStyleId;\n  styleElement.textContent = createFontCSS(font);\n\n  if (!styleElement.parentNode) {\n    document.head.appendChild(styleElement);\n  }\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;;;;AAIA,MAAM,mBAAmB;IACvB;QAAE,QAAQ;QAAU,SAAS;IAAkC;IAC/D;QAAE,QAAQ;QAAa,SAAS;IAAgB;IAChD;QAAE,QAAQ;QAAY,SAAS;IAAmD;IAClF;QAAE,QAAQ;QAAgB,SAAS;IAAuD;IAC1F;QAAE,QAAQ;QAAa,SAAS;IAAkC;IAClE;QAAE,QAAQ;QAAa,SAAS;IAAkC;IAClE;QAAE,QAAQ;QAAU,SAAS;IAAkC;IAC/D;QAAE,QAAQ;QAAe,SAAS;IAAkC;IACpE;QAAE,QAAQ;QAAY,SAAS;IAAkC;IACjE;QAAE,QAAQ;QAAW,SAAS;IAAoC;IAClE;QAAE,QAAQ;QAAY,SAAS;IAAoC;IACnE;QAAE,QAAQ;QAAW,SAAS;IAAG;CAClC;AAED,MAAM,iBAAiB;IACrB;QAAE,QAAQ;QAAkB,SAAS;IAAG;IACxC;QAAE,QAAQ;QAAgB,SAAS;IAAG;IACtC;QAAE,QAAQ;QAAgB,SAAS;IAAG;IACtC;QAAE,QAAQ;QAAiB,SAAS;IAAG;CACxC;AAED,yCAAyC;AACzC,MAAM,mBAAmB,CAAC,aAAa,KAAK;IAC1C,MAAM,aAAa,CAAC;;;;;;AAMtB,CAAC;IAEC,MAAM,WAAW,CAAC;;;;;;;;;;AAUpB,CAAC;IAEC,OAAO,aAAa,aAAa,WAAW;AAC9C;AAEA,MAAM,8BAA8B,IAAM,CAAC;iEACsB,EAAE,iBAC9D,GAAG,CACF,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,GAClB,CAAC,OAAO,EAAE,mBAAmB,UAAU,UAAU,CAAC,CAAC,EAAE,SAAS,GAAG,IAAI,EAExE,IAAI,CAAC,KAAK;AACf,CAAC;AAED,MAAM,4BAA4B,IAAM,CAAC;;;;;;;iEAOwB,EAAE,eAC9D,GAAG,CACF,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,GAClB,CAAC,OAAO,EAAE,mBAAmB,UAAU,UAAU,CAAC,CAAC,EAAE,SAAS,GAAG,IAAI,EAExE,IAAI,CAAC,KAAK;AACf,CAAC;AAED,MAAM,4BAA4B,IAAM,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyCzC,CAAC;AAEM,MAAM,uBAAuB,OAAO,UAAoB,QAAQ,KAAK;IAC1E,MAAM,gBAAgB,SAAS,IAAA,6JAAQ;IAEvC,MAAM,QAAQ,iBAAiB;IAC/B,MAAM,cAAc,IAAI;IACxB,MAAM,gBAAgB,YAAY,eAAe,CAAC,OAAO;IAEzD,6DAA6D;IAC7D,MAAM,IAAI,CAAC,cAAc,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;QAC/C,IAAI,MAAM,OAAO,KAAK,QAAQ;YAC5B,MAAM,OAAO,SAAS,aAAa,CAAC;YACpC,KAAK,GAAG,GAAG,MAAM,YAAY,CAAC,UAAU;YACxC,KAAK,IAAI,GAAG,MAAM,YAAY,CAAC,WAAW;YAC1C,MAAM,cAAc,MAAM,YAAY,CAAC;YACvC,IAAI,aAAa;gBACf,KAAK,WAAW,GAAG;YACrB;YAEA,uDAAuD;YACvD,IAAI,SAAS,IAAI,CAAC,UAAU,EAAE;gBAC5B,SAAS,IAAI,CAAC,YAAY,CAAC,MAAM,SAAS,IAAI,CAAC,UAAU;YAC3D,OAAO;gBACL,SAAS,IAAI,CAAC,WAAW,CAAC;YAC5B;QACF;IACF;IAEA,8CAA8C;IAC9C,IAAI,QAAQ;IACZ,IAAI,YAAY;IAEhB,IAAI,eAAe;QACjB,YAAY;QACZ,QAAQ,GAAG,MAAM,EAAE,EAAE,6BAA6B;IACpD;IAEA,IAAI,WAAW;QACb,MAAM,QAAQ,SAAS,aAAa,CAAC;QACrC,MAAM,WAAW,GAAG;QACpB,SAAS,IAAI,CAAC,WAAW,CAAC;IAC5B;IAEA,MAAM,SAAS,IAAI;IACnB,MAAM,gBAAgB,OAAO,eAAe,CAAC,OAAO;IAEpD,MAAM,IAAI,CAAC,cAAc,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;QAC/C,IAAI,MAAM,OAAO,KAAK,QAAQ;YAC5B,MAAM,OAAO,SAAS,aAAa,CAAC;YACpC,KAAK,GAAG,GAAG,MAAM,YAAY,CAAC,UAAU;YACxC,KAAK,IAAI,GAAG,MAAM,YAAY,CAAC,WAAW;YAC1C,KAAK,WAAW,GAAG,MAAM,YAAY,CAAC,kBAAkB;YAExD,SAAS,IAAI,CAAC,WAAW,CAAC;QAC5B;IACF;AACF;AAwBO,SAAS,YAAY,IAAY;IACtC,MAAM,WAAW,IAAA,gKAAW,EAAC;IAC7B,OAAO,SAAS,OAAO,CAAC,4BAA4B;AACtD;AAEO,SAAS,UAAU,IAAY;IACpC,OAAO,IAAA,kLAAc,EAAC;AACxB;AAEO,SAAS,cAAc,IAAY;IACxC,MAAM,YAAY,KAAK,WAAW,GAAG,KAAK,CAAC,KAAK,GAAG;IACnD,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAEO,SAAS,YAAY,MAAkB;IAC5C,MAAM,QAAQ;QAAE,KAAK;QAAY,KAAK;QAAY,MAAM;QAAa,OAAO;IAAa;IACzF,OAAO,KAAK,CAAC,OAAO,IAAI;AAC1B;AAEO,SAAS,mBAAmB,MAAkB;IACnD,MAAM,UAAU;QAAE,KAAK;QAAY,KAAK;QAAY,MAAM;QAAQ,OAAO;IAAQ;IACjF,OAAO,OAAO,CAAC,OAAO,IAAI;AAC5B;AAEO,SAAS,iBAAiB,IAAY;IAC3C,OAAO,KAAK,OAAO,CAAC,QAAQ,KAAK,IAAI;AACvC;AAEO,SAAS,cAAc,IAAgB;IAC5C,MAAM,SAAS,cAAc,KAAK,IAAI;IACtC,MAAM,YAAY,mBAAmB;IACrC,MAAM,aAAa,iBAAiB,KAAK,MAAM,IAAI,KAAK,IAAI;IAC5D,MAAM,YAAY,KAAK,KAAK,IAAI;IAChC,MAAM,aAAa,KAAK,MAAM,IAAI;IAClC,MAAM,WAAW,KAAK,QAAQ,IAAI;IAClC,IAAI,CAAC,KAAK,OAAO,EAAE;QACjB,MAAM,IAAI,MAAM,CAAC,iCAAiC,EAAE,KAAK,IAAI,EAAE;IACjE;IAEA,MAAM,MAAM,CAAC;;oBAEK,EAAE,WAAW;MAC3B,EAAE,WAAW,KAAK,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC,CAAC;MAC9C,EAAE,WAAW,KAAK,CAAC,aAAa,EAAE,WAAW,CAAC,CAAC,CAAC;gBACtC,EAAE,KAAK,OAAO,CAAC,WAAW,EAAE,UAAU;;;EAGpD,CAAC;IAED,OAAO;AACT;AAEO,SAAS,iBACd,IAAY,EACZ,OAAkD;IAElD,MAAM,OAAO,SAAS,QAAQ,YAAY;IAC1C,OAAO;QACL,IAAI,UAAU;QACd;QACA,QAAQ,SAAS;QACjB,OAAO,SAAS;QAChB,QAAQ,SAAS;QACjB,UAAU,SAAS;QACnB;IACF;AACF;AAEO,MAAM,kBAAkB,CAAC,UAAoB;IAClD,MAAM,cAAc,CAAC,YAAY,EAAE,KAAK,EAAE,EAAE;IAC5C,MAAM,eAAe,SAAS,cAAc,CAAC,gBAAgB,SAAS,aAAa,CAAC;IACpF,aAAa,EAAE,GAAG;IAClB,aAAa,WAAW,GAAG,cAAc;IAEzC,IAAI,CAAC,aAAa,UAAU,EAAE;QAC5B,SAAS,IAAI,CAAC,WAAW,CAAC;IAC5B;AACF"}}]
}