{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/components/metadata/useMetadataEdit.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useState } from 'react';\nimport { BookMetadata } from '@/libs/document';\nimport {\n  validateAndNormalizeDate,\n  validateAndNormalizeLanguage,\n  validateAndNormalizeSubjects,\n  validateISBN,\n  ValidationResult,\n} from '@/utils/validation';\nimport { MetadataSource } from './SourceSelector';\nimport { searchMetadata } from '@/libs/metadata';\nimport { formatAuthors, formatTitle, getPrimaryLanguage } from '@/utils/book';\n\nexport const useMetadataEdit = (metadata: BookMetadata | null) => {\n  const [editedMeta, setEditedMeta] = useState<BookMetadata>({} as BookMetadata);\n  const [fieldSources, setFieldSources] = useState<Record<string, string>>({});\n  const [lockedFields, setLockedFields] = useState<Record<string, boolean>>({});\n  const [fieldErrors, setFieldErrors] = useState<Record<string, string>>({});\n\n  const [searchLoading, setSearchLoading] = useState(false);\n  const [showSourceSelection, setShowSourceSelection] = useState(false);\n  const [availableSources, setAvailableSources] = useState<MetadataSource[]>([]);\n\n  const lockableFields = [\n    'title',\n    'author',\n    'publisher',\n    'published',\n    'language',\n    'identifier',\n    'subject',\n    'description',\n    'subtitle',\n    'series',\n    'seriesIndex',\n    'seriesTotal',\n    'coverImageUrl',\n  ];\n\n  useEffect(() => {\n    if (metadata) {\n      setEditedMeta({ ...metadata });\n    }\n  }, [metadata]);\n\n  useEffect(() => {\n    const initialLockedFields: Record<string, boolean> = {};\n    lockableFields.forEach((field) => {\n      initialLockedFields[field] = false;\n    });\n    setLockedFields(initialLockedFields);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const handleFieldChange = (field: string, value: string | undefined) => {\n    if (lockedFields[field]) {\n      return;\n    }\n\n    setEditedMeta((prevMeta) => {\n      const newMeta = { ...prevMeta } as { [key: string]: unknown };\n      switch (field) {\n        case 'subject':\n          newMeta['subject'] = value ? value.split(/,|;|，|、/).map((s) => s.trim()) : [];\n          break;\n        default:\n          newMeta[field] = value;\n      }\n      return newMeta as BookMetadata;\n    });\n\n    if (value !== undefined) {\n      handleFieldValidation(field, value);\n    }\n\n    if (fieldSources[field]) {\n      setFieldSources((prevSources) => {\n        const newSources = { ...prevSources };\n        delete newSources[field];\n        return newSources;\n      });\n    }\n  };\n\n  const handleFieldValidation = (field: string, value: string) => {\n    if (lockedFields[field]) {\n      return true;\n    }\n\n    let validationResult: ValidationResult<unknown>;\n    switch (field) {\n      case 'title':\n      case 'author':\n        if (!value.trim()) {\n          console.warn(`Field ${field} cannot be empty`);\n          setFieldErrors((prev) => ({ ...prev, [field]: 'This field is required' }));\n          return false;\n        }\n        break;\n\n      case 'published':\n        if (value.trim()) {\n          validationResult = validateAndNormalizeDate(value);\n          if (!validationResult.isValid) {\n            console.warn(`Invalid date for field ${field}:`, validationResult.error);\n            setFieldErrors((prev) => ({ ...prev, [field]: validationResult.error || '' }));\n            return false;\n          }\n        }\n        break;\n\n      case 'language':\n        if (value.trim()) {\n          validationResult = validateAndNormalizeLanguage(value);\n          if (!validationResult.isValid) {\n            console.warn(`Invalid language for field ${field}:`, validationResult.error);\n            setFieldErrors((prev) => ({ ...prev, [field]: validationResult.error || '' }));\n            return false;\n          }\n        }\n        break;\n\n      case 'subject':\n        if (value.trim()) {\n          validationResult = validateAndNormalizeSubjects(value);\n          if (!validationResult.isValid) {\n            console.warn(`Invalid subjects for field ${field}:`, validationResult.error);\n            setFieldErrors((prev) => ({ ...prev, [field]: validationResult.error || '' }));\n            return false;\n          }\n        }\n        break;\n    }\n\n    setFieldErrors((prev) => {\n      const newErrors = { ...prev };\n      delete newErrors[field];\n      return newErrors;\n    });\n\n    return true;\n  };\n\n  const handleToggleFieldLock = (field: string) => {\n    setLockedFields((prev) => ({\n      ...prev,\n      [field]: !prev[field],\n    }));\n  };\n\n  const handleLockAll = () => {\n    const allLocked: Record<string, boolean> = {};\n    lockableFields.forEach((field) => {\n      allLocked[field] = true;\n    });\n    setLockedFields(allLocked);\n  };\n\n  const handleUnlockAll = () => {\n    const allUnlocked: Record<string, boolean> = {};\n    lockableFields.forEach((field) => {\n      allUnlocked[field] = false;\n    });\n    setLockedFields(allUnlocked);\n  };\n\n  const handleAutoRetrieve = async () => {\n    setSearchLoading(true);\n    try {\n      const isbnValidation = validateISBN(editedMeta.identifier || '');\n      const results = await searchMetadata({\n        title: formatTitle(editedMeta.title),\n        author: formatAuthors(editedMeta.author),\n        isbn: isbnValidation.isValid ? editedMeta.identifier : undefined,\n        language: getPrimaryLanguage(editedMeta.language),\n      });\n      const metadataSources = results.map((result) => ({\n        sourceName: result.providerName,\n        sourceLabel: result.providerLabel,\n        confidence: result.confidence,\n        data: result.metadata as BookMetadata,\n      }));\n      setAvailableSources(metadataSources);\n      setShowSourceSelection(true);\n    } catch (error) {\n      console.error('Failed to retrieve metadata:', error);\n    } finally {\n      setSearchLoading(false);\n    }\n  };\n\n  const handleSourceSelection = (selectedSource: MetadataSource) => {\n    const newMeta = { ...editedMeta } as { [key: string]: unknown };\n    const newSources = { ...fieldSources };\n\n    Object.entries(selectedSource.data).forEach(([key, value]) => {\n      if (lockedFields[key] || !value) {\n        return;\n      }\n      switch (key) {\n        default:\n          newMeta[key] = value;\n      }\n      newSources[key] = `${selectedSource.sourceName}-${selectedSource.confidence}`;\n    });\n\n    setEditedMeta(newMeta as BookMetadata);\n    setFieldSources(newSources);\n    setShowSourceSelection(false);\n  };\n\n  const handleCloseSourceSelection = () => {\n    setShowSourceSelection(false);\n  };\n\n  const resetToOriginal = () => {\n    if (metadata) {\n      setEditedMeta({ ...metadata });\n    }\n    setFieldSources({});\n    setShowSourceSelection(false);\n    handleUnlockAll();\n  };\n\n  return {\n    editedMeta,\n    fieldSources,\n    lockedFields,\n    fieldErrors,\n    searchLoading,\n    showSourceSelection,\n    availableSources,\n    handleFieldChange,\n    handleFieldValidation,\n    handleToggleFieldLock,\n    handleLockAll,\n    handleUnlockAll,\n    handleAutoRetrieve,\n    handleSourceSelection,\n    handleCloseSourceSelection,\n    resetToOriginal,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 266, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/components/metadata/BookDetailView.tsx"],"sourcesContent":["import clsx from 'clsx';\nimport React from 'react';\nimport {\n  MdOutlineCloudDownload,\n  MdOutlineCloudUpload,\n  MdOutlineDelete,\n  MdOutlineEdit,\n  MdSaveAlt,\n} from 'react-icons/md';\n\nimport { Book } from '@/types/book';\nimport { BookMetadata } from '@/libs/document';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport {\n  formatAuthors,\n  formatDate,\n  formatBytes,\n  formatLanguage,\n  formatPublisher,\n  formatTitle,\n} from '@/utils/book';\nimport BookCover from '@/components/BookCover';\nimport Dropdown from '../Dropdown';\nimport MenuItem from '../MenuItem';\n\ninterface BookDetailViewProps {\n  book: Book;\n  metadata: BookMetadata | null;\n  fileSize: number | null;\n  onEdit?: () => void;\n  onDelete?: () => void;\n  onDeleteCloudBackup?: () => void;\n  onDeleteLocalCopy?: () => void;\n  onDownload?: () => void;\n  onUpload?: () => void;\n  onExport?: () => void;\n}\n\nconst BookDetailView: React.FC<BookDetailViewProps> = ({\n  book,\n  metadata,\n  fileSize,\n  onEdit,\n  onDelete,\n  onDeleteCloudBackup,\n  onDeleteLocalCopy,\n  onDownload,\n  onUpload,\n  onExport,\n}) => {\n  const _ = useTranslation();\n\n  return (\n    <div className='relative w-full rounded-lg'>\n      <div className='mb-6 me-4 flex h-32 items-start'>\n        <div className='me-6 aspect-[28/41] h-32 shadow-lg sm:me-10'>\n          <BookCover mode='list' book={book} />\n        </div>\n        <div className='title-author flex h-32 flex-col justify-between'>\n          <div>\n            <p className='text-base-content mb-2 line-clamp-2 break-words text-lg font-bold'>\n              {formatTitle(book.title).replace(/\\u00A0/g, ' ') || _('Untitled')}\n            </p>\n            <p className='text-neutral-content line-clamp-1'>\n              {formatAuthors(book.author, book.primaryLanguage) || _('Unknown')}\n            </p>\n          </div>\n          <div className='flex flex-nowrap items-center gap-3 sm:gap-x-4'>\n            {onEdit && (\n              <button\n                onClick={onEdit}\n                className={!metadata ? 'btn-disabled opacity-50' : ''}\n                title={_('Edit Metadata')}\n              >\n                <MdOutlineEdit className='hover:fill-blue-500' />\n              </button>\n            )}\n            {onDelete && (\n              <Dropdown\n                label={_('Delete Book Options')}\n                className='dropdown-bottom flex justify-center'\n                buttonClassName='btn btn-ghost h-8 min-h-8 w-8 p-0'\n                toggleButton={<MdOutlineDelete className='fill-red-500' />}\n              >\n                <div\n                  className={clsx(\n                    'delete-menu dropdown-content dropdown-center no-triangle',\n                    'border-base-300 !bg-base-200 z-20 mt-1 max-w-[90vw] shadow-2xl',\n                  )}\n                >\n                  <MenuItem\n                    noIcon\n                    transient\n                    label={_('Remove from Cloud & Device')}\n                    onClick={onDelete}\n                  />\n                  <MenuItem\n                    noIcon\n                    transient\n                    label={_('Remove from Cloud Only')}\n                    onClick={onDeleteCloudBackup}\n                    disabled={!book.uploadedAt}\n                  />\n                  <MenuItem\n                    noIcon\n                    transient\n                    label={_('Remove from Device Only')}\n                    onClick={onDeleteLocalCopy}\n                    disabled={!book.downloadedAt}\n                  />\n                </div>\n              </Dropdown>\n            )}\n            {book.uploadedAt && onDownload && (\n              <button onClick={onDownload} title={_('Download from Cloud')}>\n                <MdOutlineCloudDownload className='fill-base-content' />\n              </button>\n            )}\n            {book.downloadedAt && onUpload && (\n              <button onClick={onUpload} title={_('Upload to Cloud')}>\n                <MdOutlineCloudUpload className='fill-base-content' />\n              </button>\n            )}\n            {book.downloadedAt && onExport && (\n              <button onClick={onExport} title={_('Export Book')}>\n                <MdSaveAlt className='fill-base-content' />\n              </button>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <div className='text-base-content my-4'>\n        <div className='mb-4 grid grid-cols-2 gap-4 sm:grid-cols-3'>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('Publisher')}</span>\n            <p className='text-neutral-content text-sm'>\n              {formatPublisher(metadata?.publisher || '') || _('Unknown')}\n            </p>\n          </div>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('Published')}</span>\n            <p className='text-neutral-content text-sm'>\n              {formatDate(metadata?.published, true) || _('Unknown')}\n            </p>\n          </div>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('Updated')}</span>\n            <p className='text-neutral-content text-sm'>{formatDate(book.updatedAt) || ''}</p>\n          </div>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('Added')}</span>\n            <p className='text-neutral-content text-sm'>{formatDate(book.createdAt) || ''}</p>\n          </div>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('Language')}</span>\n            <p className='text-neutral-content text-sm'>\n              {formatLanguage(metadata?.language) || _('Unknown')}\n            </p>\n          </div>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('Subjects')}</span>\n            <p className='text-neutral-content line-clamp-3 text-sm'>\n              {formatAuthors(metadata?.subject || '') || _('Unknown')}\n            </p>\n          </div>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('Format')}</span>\n            <p className='text-neutral-content text-sm'>{book.format || _('Unknown')}</p>\n          </div>\n          <div className='overflow-hidden'>\n            <span className='font-bold'>{_('File Size')}</span>\n            <p className='text-neutral-content text-sm'>{formatBytes(fileSize) || _('Unknown')}</p>\n          </div>\n        </div>\n        <div>\n          <span className='font-bold'>{_('Description')}</span>\n          <p\n            className='text-neutral-content prose prose-sm max-w-full whitespace-pre-line text-sm'\n            dangerouslySetInnerHTML={{\n              __html: metadata?.description || _('No description available'),\n            }}\n          ></p>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default BookDetailView;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 744, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/components/metadata/FormField.tsx"],"sourcesContent":["import React from 'react';\nimport clsx from 'clsx';\nimport { MdOutlineInfo, MdLock, MdLockOpen, MdError } from 'react-icons/md';\nimport { useTranslation } from '@/hooks/useTranslation';\n\nconst inputBaseStyles =\n  'w-full rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500';\nconst inputBackgroundStyles = 'bg-base-200/50';\nconst labelStyles = 'text-base-content block text-sm font-medium';\n\ninterface SourceIndicatorProps {\n  source?: string;\n}\n\nconst SourceIndicator: React.FC<SourceIndicatorProps> = ({ source }) => {\n  if (!source) return null;\n\n  const [sourceName, confidence] = source.split('-');\n  const confidenceNum = parseInt(confidence!);\n\n  let color = 'text-green-500';\n  if (confidenceNum < 90) color = 'text-yellow-500';\n  if (confidenceNum < 70) color = 'text-red-500';\n\n  return (\n    <div className='flex items-center justify-end gap-1 text-xs'>\n      <MdOutlineInfo className={clsx('h-3 w-3', color)} />\n      <span className={clsx('capitalize', color)}>\n        {sourceName} ({confidence}%)\n      </span>\n    </div>\n  );\n};\n\ninterface LockButtonProps {\n  isLocked: boolean;\n  onToggle: () => void;\n  disabled?: boolean;\n}\n\nconst LockButton: React.FC<LockButtonProps> = ({ isLocked, onToggle, disabled = false }) => {\n  return (\n    <button\n      type='button'\n      onClick={onToggle}\n      disabled={disabled}\n      className={clsx(\n        'focus:outline-non absolute right-2 top-1/2 -translate-y-1/2 rounded p-1 transition-colors',\n        disabled && 'cursor-not-allowed opacity-50',\n        isLocked ? 'bg-green-100 text-green-500 hover:bg-green-200' : 'text-base-content',\n      )}\n      title={isLocked ? 'Unlock field' : 'Lock field'}\n    >\n      {isLocked ? <MdLock className='h-4 w-4' /> : <MdLockOpen className='h-4 w-4' />}\n    </button>\n  );\n};\n\ninterface FormFieldProps {\n  type?: 'input' | 'textarea';\n  field: string;\n  label: string;\n  isNumber?: boolean;\n  required?: boolean;\n  disabled?: boolean;\n  lockable?: boolean;\n  fieldSources: Record<string, string>;\n  lockedFields: Record<string, boolean>;\n  fieldErrors: Record<string, string>;\n  onToggleFieldLock: (field: string) => void;\n\n  value: string;\n  onFieldChange: (field: string, value: string) => void;\n  placeholder?: string;\n  rows?: number;\n  className?: string;\n}\n\nconst FormField: React.FC<FormFieldProps> = ({\n  type = 'input',\n  field,\n  label,\n  fieldSources,\n  lockedFields,\n  fieldErrors,\n  isNumber = false,\n  required = false,\n  lockable = true,\n  disabled = false,\n  onToggleFieldLock,\n\n  value,\n  onFieldChange,\n  placeholder,\n  rows,\n  className,\n}) => {\n  const _ = useTranslation();\n  const isLocked = lockedFields[field]!;\n  const source = fieldSources[field]!;\n  const error = fieldErrors[field]!;\n\n  return (\n    <div className='flex flex-col gap-1'>\n      <div className={clsx(labelStyles, 'flex items-center justify-between')}>\n        <span>\n          {label} {required && '*'}\n        </span>\n        {isLocked && (\n          <span className='flex items-center gap-1 text-xs text-green-500'>\n            <MdLock className='h-3 w-3' />\n            {_('Locked')}\n          </span>\n        )}\n      </div>\n      <div className='relative'>\n        {type === 'input' ? (\n          <input\n            type={isNumber ? 'number' : 'text'}\n            min={1}\n            value={value}\n            onChange={(e) => onFieldChange(field, e.target.value)}\n            placeholder={isLocked ? '' : placeholder}\n            disabled={disabled || isLocked}\n            className={clsx(\n              inputBaseStyles,\n              inputBackgroundStyles,\n              lockable && 'pe-10',\n              isLocked ? 'cursor-not-allowed' : 'bg-gray-100 text-gray-500',\n              error && 'border-red-500 focus:ring-red-500',\n              className,\n            )}\n          />\n        ) : (\n          <textarea\n            value={value}\n            onChange={(e) => onFieldChange(field, e.target.value)}\n            placeholder={isLocked ? '' : placeholder}\n            rows={rows || 4}\n            disabled={disabled || isLocked}\n            className={clsx(\n              inputBaseStyles,\n              inputBackgroundStyles,\n              lockable && 'pe-10',\n              isLocked ? 'cursor-not-allowed' : 'bg-gray-100 text-gray-500',\n              error && 'border-red-500 focus:ring-red-500',\n              className,\n            )}\n          />\n        )}\n        {lockable && <LockButton isLocked={isLocked} onToggle={() => onToggleFieldLock(field)} />}\n      </div>\n      {error && (\n        <div className='flex items-center gap-1 text-xs text-red-600'>\n          <MdError className='h-3 w-3' />\n          <span>{error}</span>\n        </div>\n      )}\n      {!error && <SourceIndicator source={source} />}\n    </div>\n  );\n};\n\nexport { FormField, SourceIndicator };\n"],"names":[],"mappings":";;;;;;;AACA;AACA;AACA;;;;;;AAEA,MAAM,kBACJ;AACF,MAAM,wBAAwB;AAC9B,MAAM,cAAc;AAMpB,MAAM,kBAAkD,CAAC,EAAE,MAAM,EAAE;IACjE,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,CAAC,YAAY,WAAW,GAAG,OAAO,KAAK,CAAC;IAC9C,MAAM,gBAAgB,SAAS;IAE/B,IAAI,QAAQ;IACZ,IAAI,gBAAgB,IAAI,QAAQ;IAChC,IAAI,gBAAgB,IAAI,QAAQ;IAEhC,qBACE,+VAAC;QAAI,WAAU;;0BACb,+VAAC,mPAAa;gBAAC,WAAW,IAAA,oMAAI,EAAC,WAAW;;;;;;0BAC1C,+VAAC;gBAAK,WAAW,IAAA,oMAAI,EAAC,cAAc;;oBACjC;oBAAW;oBAAG;oBAAW;;;;;;;;;;;;;AAIlC;KAlBM;AA0BN,MAAM,aAAwC,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,WAAW,KAAK,EAAE;IACrF,qBACE,+VAAC;QACC,MAAK;QACL,SAAS;QACT,UAAU;QACV,WAAW,IAAA,oMAAI,EACb,6FACA,YAAY,iCACZ,WAAW,mDAAmD;QAEhE,OAAO,WAAW,iBAAiB;kBAElC,yBAAW,+VAAC,4OAAM;YAAC,WAAU;;;;;qEAAe,+VAAC,gPAAU;YAAC,WAAU;;;;;;;;;;;AAGzE;MAhBM;AAsCN,MAAM,YAAsC,CAAC,EAC3C,OAAO,OAAO,EACd,KAAK,EACL,KAAK,EACL,YAAY,EACZ,YAAY,EACZ,WAAW,EACX,WAAW,KAAK,EAChB,WAAW,KAAK,EAChB,WAAW,IAAI,EACf,WAAW,KAAK,EAChB,iBAAiB,EAEjB,KAAK,EACL,aAAa,EACb,WAAW,EACX,IAAI,EACJ,SAAS,EACV;;IACC,MAAM,IAAI,IAAA,6KAAc;IACxB,MAAM,WAAW,YAAY,CAAC,MAAM;IACpC,MAAM,SAAS,YAAY,CAAC,MAAM;IAClC,MAAM,QAAQ,WAAW,CAAC,MAAM;IAEhC,qBACE,+VAAC;QAAI,WAAU;;0BACb,+VAAC;gBAAI,WAAW,IAAA,oMAAI,EAAC,aAAa;;kCAChC,+VAAC;;4BACE;4BAAM;4BAAE,YAAY;;;;;;;oBAEtB,0BACC,+VAAC;wBAAK,WAAU;;0CACd,+VAAC,4OAAM;gCAAC,WAAU;;;;;;4BACjB,EAAE;;;;;;;;;;;;;0BAIT,+VAAC;gBAAI,WAAU;;oBACZ,SAAS,wBACR,+VAAC;wBACC,MAAM,WAAW,WAAW;wBAC5B,KAAK;wBACL,OAAO;wBACP,UAAU,CAAC,IAAM,cAAc,OAAO,EAAE,MAAM,CAAC,KAAK;wBACpD,aAAa,WAAW,KAAK;wBAC7B,UAAU,YAAY;wBACtB,WAAW,IAAA,oMAAI,EACb,iBACA,uBACA,YAAY,SACZ,WAAW,uBAAuB,6BAClC,SAAS,qCACT;;;;;iFAIJ,+VAAC;wBACC,OAAO;wBACP,UAAU,CAAC,IAAM,cAAc,OAAO,EAAE,MAAM,CAAC,KAAK;wBACpD,aAAa,WAAW,KAAK;wBAC7B,MAAM,QAAQ;wBACd,UAAU,YAAY;wBACtB,WAAW,IAAA,oMAAI,EACb,iBACA,uBACA,YAAY,SACZ,WAAW,uBAAuB,6BAClC,SAAS,qCACT;;;;;;oBAIL,0BAAY,+VAAC;wBAAW,UAAU;wBAAU,UAAU,IAAM,kBAAkB;;;;;;;;;;;;YAEhF,uBACC,+VAAC;gBAAI,WAAU;;kCACb,+VAAC,6OAAO;wBAAC,WAAU;;;;;;kCACnB,+VAAC;kCAAM;;;;;;;;;;;;YAGV,CAAC,uBAAS,+VAAC;gBAAgB,QAAQ;;;;;;;;;;;;AAG1C;GAnFM;;QAmBM,6KAAc;;;MAnBpB"}},
    {"offset": {"line": 969, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/components/metadata/BookDetailEdit.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useState } from 'react';\nimport { MdEdit, MdDelete, MdLock, MdLockOpen, MdOutlineSearch } from 'react-icons/md';\n\nimport { Book } from '@/types/book';\nimport { BookMetadata } from '@/libs/document';\nimport { useEnv } from '@/context/EnvContext';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { flattenContributors, formatAuthors, formatPublisher, formatTitle } from '@/utils/book';\nimport { useFileSelector } from '@/hooks/useFileSelector';\nimport { FormField } from './FormField';\nimport BookCover from '@/components/BookCover';\n\ninterface BookDetailEditProps {\n  book: Book;\n  metadata: BookMetadata;\n  fieldSources: Record<string, string>;\n  lockedFields: Record<string, boolean>;\n  fieldErrors: Record<string, string>;\n  searchLoading: boolean;\n  onFieldChange: (field: string, value: string | undefined) => void;\n  onToggleFieldLock: (field: string) => void;\n  onAutoRetrieve: () => void;\n  onLockAll: () => void;\n  onUnlockAll: () => void;\n  onCancel: () => void;\n  onReset: () => void;\n  onSave: () => void;\n}\n\nconst emptyCoverImageUrl = '_blank';\n\nconst BookDetailEdit: React.FC<BookDetailEditProps> = ({\n  book,\n  metadata,\n  fieldSources,\n  lockedFields,\n  fieldErrors,\n  searchLoading,\n  onFieldChange,\n  onToggleFieldLock,\n  onAutoRetrieve,\n  onLockAll,\n  onUnlockAll,\n  onCancel,\n  onReset,\n  onSave,\n}) => {\n  const _ = useTranslation();\n  const { appService } = useEnv();\n  const { selectFiles } = useFileSelector(appService, _);\n\n  const hasLockedFields = Object.values(lockedFields).some((locked) => locked);\n  const allFieldsLocked = Object.values(lockedFields).every((locked) => locked);\n  const isCoverLocked = lockedFields['coverImageUrl'] || false;\n  const coverImageUrl = metadata.coverImageUrl || null;\n  const [newCoverImageUrl, setNewCoverImageUrl] = useState<string | null>(coverImageUrl);\n\n  const titleAuthorFields = [\n    {\n      field: 'title',\n      label: _('Title'),\n      required: true,\n      value: formatTitle(metadata.title),\n      placeholder: _('Enter book title'),\n    },\n    {\n      field: 'subtitle',\n      label: _('Subtitle'),\n      required: false,\n      value: formatTitle(metadata.subtitle || ''),\n      placeholder: _('Enter book subtitle'),\n    },\n    {\n      field: 'author',\n      label: _('Author'),\n      required: true,\n      value: formatAuthors(metadata.author),\n      placeholder: _('Enter author name'),\n    },\n  ];\n\n  const metadataGridFields = [\n    {\n      field: 'series',\n      label: _('Series'),\n      value: metadata.series || '',\n      placeholder: _('Enter series name'),\n    },\n    {\n      field: 'seriesIndex',\n      label: _('Series Index'),\n      isNumber: true,\n      value: String(metadata.seriesIndex || ''),\n      placeholder: _('Enter series index'),\n    },\n    {\n      field: 'seriesTotal',\n      label: _('Total in Series'),\n      isNumber: true,\n      value: String(metadata.seriesTotal || ''),\n      placeholder: _('Enter total books in series'),\n    },\n    {\n      field: 'publisher',\n      label: _('Publisher'),\n      value: formatPublisher(metadata.publisher || ''),\n      placeholder: _('Enter publisher'),\n    },\n    {\n      field: 'published',\n      label: _('Publication Date'),\n      value: metadata.published || '',\n      placeholder: _('YYYY or YYYY-MM-DD'),\n    },\n    {\n      field: 'language',\n      label: _('Language'),\n      value: Array.isArray(metadata.language)\n        ? metadata.language.join(', ')\n        : metadata.language || '',\n      placeholder: 'en, zh, fr',\n    },\n    {\n      field: 'identifier',\n      label: _('Identifier'),\n      value: metadata.identifier || '',\n      placeholder: '978-0123456789',\n    },\n  ];\n  const metadataFullwidthFields = [\n    {\n      field: 'subject',\n      label: _('Subjects'),\n      value: flattenContributors(metadata.subject || []),\n      placeholder: _('Fiction, Science, History'),\n    },\n    {\n      field: 'description',\n      label: _('Description'),\n      type: 'textarea',\n      rows: 4,\n      value: metadata.description || '',\n      placeholder: _('Enter book description'),\n    },\n  ];\n\n  const handleSelectLocalImage = async () => {\n    selectFiles({ type: 'covers', multiple: false }).then(async (result) => {\n      if (result.error || result.files.length === 0) return;\n      const selectedFile = result.files[0]!;\n      if (selectedFile.path && appService) {\n        const filePath = selectedFile.path;\n        const imageUrl = await appService.getCachedImageUrl(filePath);\n        onFieldChange('coverImageFile', filePath);\n        onFieldChange('coverImageUrl', imageUrl);\n        setNewCoverImageUrl(imageUrl);\n      } else if (selectedFile.file) {\n        const coverImageBlobUrl = URL.createObjectURL(selectedFile.file);\n        onFieldChange('coverImageBlobUrl', coverImageBlobUrl);\n        setNewCoverImageUrl(coverImageBlobUrl);\n      }\n    });\n  };\n\n  return (\n    <div className='bg-base-100 relative w-full rounded-lg'>\n      <div className='mb-6 flex items-stretch gap-4'>\n        <div className='cover-field flex w-[30%] max-w-32 flex-col gap-2'>\n          <button\n            className='aspect-[28/41] h-full shadow-md'\n            onClick={!isCoverLocked ? handleSelectLocalImage : undefined}\n          >\n            <BookCover\n              mode='list'\n              book={{\n                ...book,\n                metadata: {\n                  ...metadata,\n                  coverImageUrl: newCoverImageUrl || metadata.coverImageUrl,\n                },\n                ...(newCoverImageUrl ? { coverImageUrl: newCoverImageUrl } : {}),\n              }}\n            />\n          </button>\n          <div className='flex w-full justify-between gap-1'>\n            <button\n              onClick={handleSelectLocalImage}\n              disabled={isCoverLocked}\n              className={clsx(\n                'flex w-1/2 min-w-0 items-center justify-center gap-1 rounded p-1 sm:w-3/5',\n                'text-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50 sm:text-xs',\n                isCoverLocked ? '!text-base-content bg-base-200' : 'bg-gray-100 !text-gray-500',\n              )}\n              title={_('Change cover image')}\n            >\n              <MdEdit\n                className={clsx(\n                  'h-5 w-5 flex-shrink-0 sm:h-4 sm:w-4',\n                  isCoverLocked ? 'fill-base-content' : 'fill-gray-600',\n                )}\n              />\n              <span className='hidden truncate sm:inline'>{_('Replace')}</span>\n            </button>\n\n            <button\n              onClick={() => {\n                setNewCoverImageUrl(emptyCoverImageUrl);\n                onFieldChange('coverImageUrl', emptyCoverImageUrl);\n                onFieldChange('coverImageFile', undefined);\n                onFieldChange('coverImageBlobUrl', undefined);\n              }}\n              disabled={isCoverLocked}\n              className={clsx(\n                'flex w-1/4 items-center justify-center rounded p-1 sm:w-1/5',\n                'disabled:cursor-not-allowed disabled:opacity-50',\n                'text-red-500 hover:bg-red-50 hover:text-red-600',\n                isCoverLocked ? '!text-base-content bg-base-200' : 'bg-gray-100',\n              )}\n              title={_('Remove cover image')}\n            >\n              <MdDelete className='h-5 w-5 sm:h-4 sm:w-4' />\n            </button>\n\n            <button\n              onClick={() => onToggleFieldLock('coverImageUrl')}\n              className={clsx(\n                'flex w-1/4 items-center justify-center rounded p-1 hover:bg-gray-50 sm:w-1/5',\n                isCoverLocked\n                  ? 'bg-green-100 text-green-500 hover:bg-green-200'\n                  : 'bg-gray-100 text-gray-500',\n              )}\n              title={isCoverLocked ? _('Unlock cover') : _('Lock cover')}\n            >\n              {isCoverLocked ? (\n                <MdLock className='h-5 w-5 sm:h-4 sm:w-4' />\n              ) : (\n                <MdLockOpen className='h-5 w-5 sm:h-4 sm:w-4' />\n              )}\n            </button>\n          </div>\n        </div>\n        <div className='title-fields flex flex-1 flex-col justify-between'>\n          {titleAuthorFields.map(({ field, label, required, value, placeholder }) => (\n            <FormField\n              key={field}\n              field={field}\n              label={label}\n              required={required}\n              value={value}\n              onFieldChange={onFieldChange}\n              fieldSources={fieldSources}\n              lockedFields={lockedFields}\n              fieldErrors={fieldErrors}\n              onToggleFieldLock={onToggleFieldLock}\n              placeholder={placeholder}\n            />\n          ))}\n        </div>\n      </div>\n\n      {/* Metadata Fields Grid */}\n      <div className='mb-6 space-y-4'>\n        <div className='grid grid-cols-1 gap-4 sm:grid-cols-2'>\n          {metadataGridFields.map(({ field, label, value, isNumber, placeholder }) => (\n            <FormField\n              key={field}\n              field={field}\n              label={label}\n              value={value}\n              isNumber={isNumber}\n              onFieldChange={onFieldChange}\n              fieldSources={fieldSources}\n              lockedFields={lockedFields}\n              fieldErrors={fieldErrors}\n              onToggleFieldLock={onToggleFieldLock}\n              placeholder={placeholder}\n            />\n          ))}\n        </div>\n\n        {metadataFullwidthFields.map(\n          ({ field, label, type = 'input', rows, value, placeholder }) => (\n            <FormField\n              key={field}\n              field={field}\n              label={label}\n              type={type as 'input' | 'textarea'}\n              rows={rows}\n              value={value}\n              onFieldChange={onFieldChange}\n              fieldSources={fieldSources}\n              lockedFields={lockedFields}\n              fieldErrors={fieldErrors}\n              onToggleFieldLock={onToggleFieldLock}\n              placeholder={placeholder}\n            />\n          ),\n        )}\n      </div>\n\n      {/* Action Buttons */}\n      <div className='flex flex-col items-center justify-between gap-4'>\n        <div className='flex w-full items-center gap-2'>\n          <button\n            onClick={onAutoRetrieve}\n            disabled={searchLoading}\n            className='flex items-center gap-2 rounded-md bg-blue-500 px-4 py-2 text-sm text-white hover:bg-blue-600 disabled:opacity-50'\n            title={_('Auto-Retrieve Metadata')}\n          >\n            {searchLoading ? (\n              <span className='loading loading-spinner h-4 w-4'></span>\n            ) : (\n              <MdOutlineSearch className='mt-[1px] h-4 w-4' />\n            )}\n            <span className='sm:hidden'>{_('Auto')}</span>\n            <span className='hidden sm:inline'>{_('Auto-Retrieve')}</span>\n          </button>\n\n          {/* Lock/Unlock All Buttons */}\n          <div className='flex items-center gap-1 border-l border-gray-300 pl-2'>\n            <button\n              onClick={onUnlockAll}\n              disabled={!hasLockedFields}\n              className={clsx(\n                'hover:bg-base-200 flex items-center gap-1 rounded px-2 py-1 text-sm',\n                'disabled:cursor-not-allowed disabled:opacity-80',\n                'text-yellow-600 hover:text-yellow-700',\n              )}\n              title={_('Unlock all fields')}\n            >\n              <MdLockOpen className='h-3 w-3' />\n              {_('Unlock All')}\n            </button>\n            <button\n              onClick={onLockAll}\n              disabled={allFieldsLocked}\n              className={clsx(\n                'hover:bg-base-200 flex items-center gap-1 rounded px-2 py-1 text-sm',\n                'disabled:cursor-not-allowed disabled:opacity-80',\n                'text-green-600 hover:text-green-700',\n              )}\n              title={_('Lock all fields')}\n            >\n              <MdLock className='h-3 w-3' />\n              {_('Lock All')}\n            </button>\n          </div>\n        </div>\n\n        <div className='flex w-full justify-end gap-4'>\n          <button\n            onClick={onCancel}\n            className='hover:bg-base-200 rounded-md border-neutral-300 px-4 py-2'\n          >\n            {_('Cancel')}\n          </button>\n          <button\n            onClick={onReset}\n            className='hover:bg-base-200 rounded-md border-neutral-300 px-4 py-2'\n          >\n            {_('Reset')}\n          </button>\n          <button\n            onClick={onSave}\n            disabled={fieldErrors && Object.keys(fieldErrors).length > 0}\n            className='rounded-md bg-green-500 px-4 py-2 text-white hover:bg-green-600 disabled:opacity-50'\n          >\n            {_('Save')}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default BookDetailEdit;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1479, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/components/metadata/SourceSelector.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef } from 'react';\nimport { MdOutlineCheck, MdOutlineEdit } from 'react-icons/md';\n\nimport { BookMetadata } from '@/libs/document';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { formatAuthors, formatTitle, getPrimaryLanguage } from '@/utils/book';\nimport BookCover from '../BookCover';\nimport { Metadata } from '@/services/metadata/types';\nimport { Book } from '@/types/book';\n\nexport interface MetadataSource {\n  sourceName: string;\n  sourceLabel: string;\n  confidence: number;\n  data: BookMetadata;\n}\n\ninterface SourceSelectorProps {\n  sources: MetadataSource[];\n  isOpen: boolean;\n  onSelect: (source: MetadataSource) => void;\n  onClose: () => void;\n}\n\nconst SourceSelector: React.FC<SourceSelectorProps> = ({ sources, isOpen, onSelect, onClose }) => {\n  const _ = useTranslation();\n  const modalRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    if (isOpen && modalRef.current) {\n      modalRef.current.focus();\n    }\n  }, [isOpen]);\n\n  const getConfidenceIcon = (confidence: number) => {\n    if (confidence >= 90) return <MdOutlineCheck className='text-green-500' />;\n    if (confidence >= 70) return <span className='text-yellow-500'>⚠</span>;\n    return <span className='text-red-500'>❓</span>;\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className='source-selector fixed inset-0 z-[60] flex items-center justify-center bg-black/50'>\n      <div\n        ref={modalRef}\n        tabIndex={-1}\n        role='dialog'\n        aria-modal='true'\n        className='bg-base-100 mx-4 max-h-[80vh] w-full max-w-md overflow-y-auto rounded-lg p-6'\n      >\n        <h3 className='mb-4 text-lg font-semibold'>{_('Select Metadata Source')}</h3>\n\n        <div className='space-y-3'>\n          {sources.map((source, index) => (\n            <button\n              tabIndex={0}\n              key={index}\n              onClick={() => onSelect(source)}\n              className='hover:bg-base-300/75 bg-base-200 border-base-200 w-full cursor-pointer rounded-md border p-3 transition-colors'\n            >\n              <div className='flex items-start gap-4'>\n                <div className='aspect-[28/41] h-full w-[40%] max-w-32 shadow-md'>\n                  <BookCover\n                    mode='list'\n                    book={\n                      {\n                        title: formatTitle(source.data.title),\n                        author: formatAuthors(source.data.author),\n                        coverImageUrl: (source.data as Metadata)['coverImageUrl'] || '_blank',\n                      } as Book\n                    }\n                  />\n                </div>\n                <div className='flex-1'>\n                  <div className='mb-2 flex items-center justify-between'>\n                    <div className='flex items-center gap-2'>\n                      <span className='font-medium capitalize'>{source.sourceLabel}</span>\n                      {getConfidenceIcon(source.confidence)}\n                    </div>\n                    <span className='text-sm text-gray-500'>{source.confidence}%</span>\n                  </div>\n\n                  <div className='space-y-1 text-sm'>\n                    <div className='font-medium'>{formatTitle(source.data.title)}</div>\n                    <div className='text-gray-600'>{formatAuthors(source.data.author)}</div>\n                    <div className='text-gray-500'>\n                      {source.data.language ? `${getPrimaryLanguage(source.data.language)} • ` : ''}\n                      {source.data.publisher ? `${source.data.publisher} • ` : ''}\n                      {source.data.published}\n                    </div>\n                    {source.data.identifier && (\n                      <div className='text-gray-500'>Identifier: {source.data.identifier}</div>\n                    )}\n                    {source.data.description && (\n                      <div className='line-clamp-3 text-xs text-gray-500'>\n                        {source.data.description}\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </button>\n          ))}\n\n          <button\n            tabIndex={0}\n            onClick={onClose}\n            className='hover:bg-base-300/75 border-base-200 bg-base-200 cursor-pointer rounded-md border p-3 transition-colors'\n          >\n            <div className='flex items-center gap-2'>\n              <MdOutlineEdit className='h-4 w-4' />\n              <span className='font-medium'>{_('Keep manual input')}</span>\n            </div>\n          </button>\n        </div>\n\n        <div className='mt-6 flex justify-end gap-2'>\n          <button onClick={onClose} className='hover:bg-base-200 rounded-md px-4 py-2'>\n            {_('Cancel')}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default SourceSelector;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1779, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/components/metadata/BookDetailModal.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useEffect, useState } from 'react';\n\nimport { Book } from '@/types/book';\nimport { BookMetadata } from '@/libs/document';\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useMetadataEdit } from './useMetadataEdit';\nimport { DeleteAction } from '@/types/system';\nimport { eventDispatcher } from '@/utils/event';\nimport { isWebAppPlatform } from '@/services/environment';\nimport Alert from '@/components/Alert';\nimport Dialog from '@/components/Dialog';\nimport BookDetailView from './BookDetailView';\nimport BookDetailEdit from './BookDetailEdit';\nimport SourceSelector from './SourceSelector';\nimport Spinner from '../Spinner';\n\ninterface BookDetailModalProps {\n  book: Book;\n  isOpen: boolean;\n  onClose: () => void;\n  handleBookDownload?: (book: Book, options?: { redownload?: boolean; queued?: boolean }) => void;\n  handleBookUpload?: (book: Book) => void;\n  handleBookDelete?: (book: Book) => void;\n  handleBookDeleteCloudBackup?: (book: Book) => void;\n  handleBookDeleteLocalCopy?: (book: Book) => void;\n  handleBookMetadataUpdate?: (book: Book, updatedMetadata: BookMetadata) => void;\n}\n\ninterface DeleteConfig {\n  title: string;\n  message: string;\n  handler?: (book: Book) => void;\n}\n\nconst BookDetailModal: React.FC<BookDetailModalProps> = ({\n  book,\n  isOpen,\n  onClose,\n  handleBookDownload,\n  handleBookUpload,\n  handleBookDelete,\n  handleBookDeleteCloudBackup,\n  handleBookDeleteLocalCopy,\n  handleBookMetadataUpdate,\n}) => {\n  const _ = useTranslation();\n  const { envConfig, appService } = useEnv();\n  const { safeAreaInsets } = useThemeStore();\n  const [activeDeleteAction, setActiveDeleteAction] = useState<DeleteAction | null>(null);\n  const [isLoading, setIsLoading] = useState(false);\n  const [editMode, setEditMode] = useState(false);\n  const [bookMeta, setBookMeta] = useState<BookMetadata | null>(null);\n  const [fileSize, setFileSize] = useState<number | null>(null);\n\n  // Initialize metadata edit hook\n  const {\n    editedMeta,\n    fieldSources,\n    lockedFields,\n    fieldErrors,\n    searchLoading,\n    showSourceSelection,\n    availableSources,\n    handleFieldChange,\n    handleToggleFieldLock,\n    handleLockAll,\n    handleUnlockAll,\n    handleAutoRetrieve,\n    handleSourceSelection,\n    handleCloseSourceSelection,\n    resetToOriginal,\n  } = useMetadataEdit(bookMeta);\n\n  const deleteConfigs: Record<DeleteAction, DeleteConfig> = {\n    both: {\n      title: _('Confirm Deletion'),\n      message: _('Are you sure to delete the selected book?'),\n      handler: handleBookDelete,\n    },\n    cloud: {\n      title: _('Confirm Deletion'),\n      message: _('Are you sure to delete the cloud backup of the selected book?'),\n      handler: handleBookDeleteCloudBackup,\n    },\n    local: {\n      title: _('Confirm Deletion'),\n      message: _('Are you sure to delete the local copy of the selected book?'),\n      handler: handleBookDeleteLocalCopy,\n    },\n  };\n\n  useEffect(() => {\n    const fetchBookDetails = async () => {\n      const appService = await envConfig.getAppService();\n      try {\n        let details = book.metadata || null;\n        if (!details && book.downloadedAt) {\n          details = await appService.fetchBookDetails(book);\n        }\n        setBookMeta(details);\n        const size = await appService.getBookFileSize(book);\n        setFileSize(size);\n      } finally {\n      }\n    };\n    fetchBookDetails();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [book]);\n\n  const handleClose = () => {\n    setBookMeta(null);\n    setEditMode(false);\n    setActiveDeleteAction(null);\n    onClose();\n  };\n\n  const handleEditMetadata = () => {\n    setEditMode(true);\n  };\n\n  const handleCancelEdit = () => {\n    resetToOriginal();\n    setEditMode(false);\n  };\n\n  const handleSaveMetadata = () => {\n    if (editedMeta && handleBookMetadataUpdate) {\n      setBookMeta({ ...editedMeta });\n      handleBookMetadataUpdate(book, editedMeta);\n      setEditMode(false);\n    }\n  };\n\n  const handleDeleteAction = (action: DeleteAction) => {\n    setActiveDeleteAction(action);\n  };\n\n  const confirmDeleteAction = async () => {\n    if (!activeDeleteAction) return;\n\n    const config = deleteConfigs[activeDeleteAction];\n    handleClose();\n\n    if (config.handler) {\n      config.handler(book);\n    }\n  };\n\n  const cancelDeleteAction = () => {\n    setActiveDeleteAction(null);\n  };\n\n  const handleDelete = () => handleDeleteAction('both');\n  const handleDeleteCloudBackup = () => handleDeleteAction('cloud');\n  const handleDeleteLocalCopy = () => handleDeleteAction('local');\n\n  const handleRedownload = async () => {\n    handleClose();\n    if (handleBookDownload) {\n      handleBookDownload(book, { redownload: true, queued: false });\n    }\n  };\n\n  const handleReupload = async () => {\n    handleClose();\n    if (handleBookUpload) {\n      handleBookUpload(book);\n    }\n  };\n\n  const handleBookExport = async () => {\n    setIsLoading(true);\n    setTimeout(async () => {\n      const success = await appService?.exportBook(book);\n      setIsLoading(false);\n      if (!isWebAppPlatform()) {\n        eventDispatcher.dispatch('toast', {\n          type: success ? 'info' : 'error',\n          message: success ? _('Book exported successfully.') : _('Failed to export the book.'),\n        });\n      }\n    }, 0);\n  };\n\n  const currentDeleteConfig = activeDeleteAction ? deleteConfigs[activeDeleteAction] : null;\n\n  return (\n    <>\n      <div className='fixed inset-0 z-50 flex items-center justify-center'>\n        <Dialog\n          title={editMode ? _('Edit Metadata') : _('Book Details')}\n          isOpen={isOpen}\n          onClose={handleClose}\n          boxClassName={clsx(\n            editMode ? 'sm:min-w-[600px] sm:max-w-[600px]' : 'sm:min-w-[480px] sm:max-w-[480px]',\n            'sm:h-auto sm:max-h-[90%]',\n          )}\n          contentClassName='!px-6 !py-4'\n        >\n          <div className='flex w-full select-text items-start justify-center'>\n            {editMode && bookMeta ? (\n              <BookDetailEdit\n                book={book}\n                metadata={editedMeta}\n                fieldSources={fieldSources}\n                lockedFields={lockedFields}\n                fieldErrors={fieldErrors}\n                searchLoading={searchLoading}\n                onFieldChange={handleFieldChange}\n                onToggleFieldLock={handleToggleFieldLock}\n                onAutoRetrieve={handleAutoRetrieve}\n                onLockAll={handleLockAll}\n                onUnlockAll={handleUnlockAll}\n                onCancel={handleCancelEdit}\n                onReset={resetToOriginal}\n                onSave={handleSaveMetadata}\n              />\n            ) : (\n              <BookDetailView\n                book={book}\n                metadata={bookMeta}\n                fileSize={fileSize}\n                onEdit={handleBookMetadataUpdate ? handleEditMetadata : undefined}\n                onDelete={handleBookDelete ? handleDelete : undefined}\n                onDeleteCloudBackup={\n                  handleBookDeleteCloudBackup ? handleDeleteCloudBackup : undefined\n                }\n                onDeleteLocalCopy={handleBookDeleteLocalCopy ? handleDeleteLocalCopy : undefined}\n                onDownload={handleBookDownload ? handleRedownload : undefined}\n                onUpload={handleBookUpload ? handleReupload : undefined}\n                onExport={handleBookExport}\n              />\n            )}\n          </div>\n        </Dialog>\n\n        {/* Source Selection Modal */}\n        {showSourceSelection && (\n          <SourceSelector\n            sources={availableSources}\n            isOpen={showSourceSelection}\n            onSelect={handleSourceSelection}\n            onClose={handleCloseSourceSelection}\n          />\n        )}\n\n        {isLoading && (\n          <div className='fixed inset-0 z-50 flex items-center justify-center'>\n            <Spinner loading />\n          </div>\n        )}\n\n        {activeDeleteAction && currentDeleteConfig && (\n          <div\n            className={clsx('fixed bottom-0 left-0 right-0 z-50 flex justify-center')}\n            style={{\n              paddingBottom: `${(safeAreaInsets?.bottom || 0) + 16}px`,\n            }}\n          >\n            <Alert\n              title={currentDeleteConfig.title}\n              message={currentDeleteConfig.message}\n              onCancel={cancelDeleteAction}\n              onConfirm={confirmDeleteAction}\n            />\n          </div>\n        )}\n      </div>\n    </>\n  );\n};\n\nexport default BookDetailModal;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2062, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/components/metadata/index.ts"],"sourcesContent":["export { default as BookDetailModal } from './BookDetailModal';\nexport { default as BookDetailView } from './BookDetailView';\nexport { default as BookDetailEdit } from './BookDetailEdit';\nexport { default as SourceSelector } from './SourceSelector';\n\nexport { useMetadataEdit } from './useMetadataEdit';\n\nexport type { MetadataSource } from './SourceSelector';\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AAEA"}}]
}