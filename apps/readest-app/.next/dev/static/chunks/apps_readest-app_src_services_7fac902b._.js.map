{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/constants.ts"],"sourcesContent":["import {\n  AnnotatorConfig,\n  BookFont,\n  BookLanguage,\n  BookLayout,\n  BookSearchConfig,\n  BookStyle,\n  HighlightColor,\n  NoteExportConfig,\n  ScreenConfig,\n  TranslatorConfig,\n  TTSConfig,\n  ViewConfig,\n  ViewSettings,\n} from '@/types/book';\nimport { KOSyncSettings, ReadSettings, SystemSettings } from '@/types/settings';\nimport { UserStorageQuota, UserDailyTranslationQuota } from '@/types/quota';\nimport { getDefaultMaxBlockSize, getDefaultMaxInlineSize } from '@/utils/config';\nimport { stubTranslation as _ } from '@/utils/misc';\n\nexport const DATA_SUBDIR = 'Readest';\nexport const LOCAL_BOOKS_SUBDIR = `${DATA_SUBDIR}/Books`;\nexport const LOCAL_FONTS_SUBDIR = `${DATA_SUBDIR}/Fonts`;\nexport const LOCAL_IMAGES_SUBDIR = `${DATA_SUBDIR}/Images`;\n\nexport const SETTINGS_FILENAME = 'settings.json';\n\nexport const SUPPORTED_BOOK_EXTS = [\n  'epub',\n  'mobi',\n  'azw',\n  'azw3',\n  'fb2',\n  'zip',\n  'cbz',\n  'pdf',\n  'txt',\n];\nexport const BOOK_ACCEPT_FORMATS = SUPPORTED_BOOK_EXTS.map((ext) => `.${ext}`).join(', ');\nexport const BOOK_UNGROUPED_NAME = '';\nexport const BOOK_UNGROUPED_ID = '';\n\nexport const SUPPORTED_IMAGE_EXTS = ['png', 'jpg', 'jpeg'];\nexport const IMAGE_ACCEPT_FORMATS = SUPPORTED_IMAGE_EXTS.map((ext) => `.${ext}`).join(', ');\n\nexport const DEFAULT_KOSYNC_SETTINGS = {\n  serverUrl: 'https://sync.koreader.rocks/', // https://kosync.ak-team.com:3042/\n  username: '',\n  userkey: '',\n  deviceId: '',\n  deviceName: '',\n  checksumMethod: 'binary',\n  strategy: 'prompt',\n  enabled: false,\n} as KOSyncSettings;\n\nexport const DEFAULT_SYSTEM_SETTINGS: Partial<SystemSettings> = {\n  keepLogin: false,\n  autoUpload: true,\n  alwaysOnTop: false,\n  openBookInNewWindow: true,\n  alwaysShowStatusBar: false,\n  alwaysInForeground: false,\n  autoCheckUpdates: true,\n  screenWakeLock: false,\n  screenBrightness: -1, // -1~100, -1 for system default\n  autoScreenBrightness: true,\n  openLastBooks: false,\n  lastOpenBooks: [],\n  autoImportBooksOnOpen: false,\n  telemetryEnabled: true,\n  discordRichPresenceEnabled: false,\n  libraryViewMode: 'grid',\n  librarySortBy: 'updated',\n  librarySortAscending: false,\n  libraryCoverFit: 'crop',\n  libraryAutoColumns: true,\n  libraryColumns: 6,\n\n  kosync: DEFAULT_KOSYNC_SETTINGS,\n\n  lastSyncedAtBooks: 0,\n  lastSyncedAtConfigs: 0,\n  lastSyncedAtNotes: 0,\n};\n\nexport const DEFAULT_MOBILE_SYSTEM_SETTINGS: Partial<SystemSettings> = {\n  libraryColumns: 3,\n};\n\nexport const HIGHLIGHT_COLOR_HEX: Record<HighlightColor, string> = {\n  red: '#f87171', // red-400\n  yellow: '#facc15', // yellow-400\n  green: '#4ade80', // green-400\n  blue: '#60a5fa', // blue-400\n  violet: '#a78bfa', // violet-400\n};\n\nexport const DEFAULT_READSETTINGS: ReadSettings = {\n  sideBarWidth: '15%',\n  isSideBarPinned: true,\n  notebookWidth: '25%',\n  isNotebookPinned: false,\n  autohideCursor: true,\n  translationProvider: 'deepl',\n  translateTargetLang: 'EN',\n\n  customThemes: [],\n  highlightStyle: 'highlight',\n  highlightStyles: {\n    highlight: 'yellow',\n    underline: 'green',\n    squiggly: 'blue',\n  },\n  customHighlightColors: HIGHLIGHT_COLOR_HEX,\n  customTtsHighlightColors: [],\n};\n\nexport const DEFAULT_MOBILE_READSETTINGS: Partial<ReadSettings> = {\n  sideBarWidth: '25%',\n  isSideBarPinned: false,\n};\n\nexport const DEFAULT_BOOK_FONT: BookFont = {\n  serifFont: 'Bitter',\n  sansSerifFont: 'Roboto',\n  monospaceFont: 'Consolas',\n  defaultFont: 'Serif',\n  defaultCJKFont: 'LXGW WenKai GB Screen',\n  defaultFontSize: 16,\n  minimumFontSize: 8,\n  fontWeight: 400,\n};\n\nexport const DEFAULT_BOOK_LAYOUT: BookLayout = {\n  marginTopPx: 44,\n  marginBottomPx: 44,\n  marginLeftPx: 16,\n  marginRightPx: 16,\n  compactMarginTopPx: 16,\n  compactMarginBottomPx: 16,\n  compactMarginLeftPx: 16,\n  compactMarginRightPx: 16,\n  gapPercent: 5,\n  scrolled: false,\n  disableClick: false,\n  fullscreenClickArea: false,\n  swapClickArea: false,\n  disableDoubleClick: false,\n  volumeKeysToFlip: false,\n  continuousScroll: false,\n  maxColumnCount: 2,\n  maxInlineSize: getDefaultMaxInlineSize(),\n  maxBlockSize: getDefaultMaxBlockSize(),\n  animated: false,\n  isEink: false,\n  writingMode: 'auto',\n  vertical: false,\n  rtl: false,\n  scrollingOverlap: 0,\n  allowScript: false,\n};\n\nexport const DEFAULT_BOOK_LANGUAGE: BookLanguage = {\n  replaceQuotationMarks: true,\n  convertChineseVariant: 'none',\n};\n\nexport const DEFAULT_BOOK_STYLE: BookStyle = {\n  zoomLevel: 100,\n  paragraphMargin: 0.6,\n  lineHeight: 1.4,\n  wordSpacing: 0,\n  letterSpacing: 0,\n  textIndent: 0,\n  fullJustification: true,\n  hyphenation: true,\n  invertImgColorInDark: false,\n  theme: 'light',\n  overrideFont: false,\n  overrideLayout: false,\n  overrideColor: false,\n  backgroundTextureId: 'none',\n  backgroundOpacity: 0.6,\n  backgroundSize: 'cover',\n  codeHighlighting: false,\n  codeLanguage: 'auto-detect',\n  userStylesheet: '',\n  userUIStylesheet: '',\n\n  zoomMode: 'fit-page',\n  spreadMode: 'auto',\n  keepCoverSpread: true,\n};\n\nexport const DEFAULT_MOBILE_VIEW_SETTINGS: Partial<ViewSettings> = {\n  fullJustification: false,\n  animated: true,\n  defaultFont: 'Sans-serif',\n  marginBottomPx: 16,\n  disableDoubleClick: true,\n  spreadMode: 'none',\n};\n\nexport const DEFAULT_CJK_VIEW_SETTINGS: Partial<ViewSettings> = {\n  fullJustification: true,\n  textIndent: 2,\n  paragraphMargin: 1,\n  lineHeight: 1.6,\n};\n\nexport const DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS: Partial<ViewSettings> = {\n  overrideColor: false,\n};\n\nexport const DEFAULT_EINK_VIEW_SETTINGS: Partial<ViewSettings> = {\n  isEink: true,\n  animated: false,\n  volumeKeysToFlip: true,\n};\n\nexport const DEFAULT_VIEW_CONFIG: ViewConfig = {\n  sideBarTab: 'toc',\n  uiLanguage: '',\n  sortedTOC: false,\n\n  doubleBorder: false,\n  borderColor: 'red',\n\n  showHeader: true,\n  showFooter: true,\n  showBarsOnScroll: false,\n  showRemainingTime: false,\n  showRemainingPages: false,\n  showProgressInfo: true,\n  tapToToggleFooter: false,\n  showMarginsOnScroll: false,\n  progressStyle: 'fraction',\n  progressInfoMode: 'all',\n};\n\nexport const DEFAULT_TTS_CONFIG: TTSConfig = {\n  ttsRate: 1.3,\n  ttsVoice: '',\n  ttsLocation: '',\n  showTTSBar: false,\n  ttsHighlightOptions: { style: 'highlight', color: '#808080' },\n};\n\nexport const DEFAULT_TRANSLATOR_CONFIG: TranslatorConfig = {\n  translationEnabled: false,\n  translationProvider: 'deepl',\n  translateTargetLang: '',\n  showTranslateSource: true,\n  ttsReadAloudText: 'both',\n};\n\nexport const DEFAULT_NOTE_EXPORT_CONFIG: NoteExportConfig = {\n  includeTitle: true,\n  includeAuthor: true,\n  includeDate: true,\n  includeChapterTitles: true,\n  includeQuotes: true,\n  includeNotes: true,\n  includeTimestamp: false,\n  includeChapterSeparator: false,\n  noteSeparator: '\\n\\n',\n  useCustomTemplate: false,\n  customTemplate: '',\n};\n\nexport const DEFAULT_ANNOTATOR_CONFIG: AnnotatorConfig = {\n  enableAnnotationQuickActions: true,\n  annotationQuickAction: null,\n  copyToNotebook: false,\n  noteExportConfig: DEFAULT_NOTE_EXPORT_CONFIG,\n};\n\nexport const DEFAULT_SCREEN_CONFIG: ScreenConfig = {\n  screenOrientation: 'auto',\n};\n\nexport const DEFAULT_BOOK_SEARCH_CONFIG: BookSearchConfig = {\n  scope: 'book',\n  matchCase: false,\n  matchWholeWords: false,\n  matchDiacritics: false,\n};\n\nexport const SYSTEM_SETTINGS_VERSION = 1;\n\nexport const SERIF_FONTS = [\n  'Bitter',\n  'Literata',\n  'Merriweather',\n  'Roboto Slab',\n  'Vollkorn',\n  'PT Serif',\n  'Georgia',\n  'Times New Roman',\n];\n\nexport const NON_FREE_FONTS = ['Georgia', 'Times New Roman'];\n\nexport const CJK_SERIF_FONTS = [\n  _('LXGW WenKai GB Screen'),\n  _('LXGW WenKai TC'),\n  _('GuanKiapTsingKhai-T'),\n  _('Source Han Serif CN VF'),\n  _('Huiwen-mincho'),\n  _('KingHwa_OldSong'),\n];\n\nexport const CJK_SANS_SERIF_FONTS = ['Noto Sans SC', 'Noto Sans TC'];\n\nexport const SANS_SERIF_FONTS = ['Roboto', 'Noto Sans', 'Open Sans', 'PT Sans', 'Helvetica'];\n\nexport const MONOSPACE_FONTS = [\n  'Fira Code',\n  'Consolas',\n  'Courier New',\n  'Lucida Console',\n  'PT Mono',\n];\n\nexport const FALLBACK_FONTS = ['MiSans L3'];\n\nexport const WINDOWS_FONTS = [\n  'Arial',\n  'Arial Black',\n  'Bahnschrift',\n  'Calibri',\n  'Cambria',\n  'Cambria Math',\n  'Candara',\n  'Comic Sans MS',\n  'Consolas',\n  'Constantia',\n  'Corbel',\n  'Courier New',\n  'Ebrima',\n  'FangSong',\n  'Franklin Gothic Medium',\n  'Gabriola',\n  'Gadugi',\n  'Georgia',\n  'Heiti',\n  'HoloLens MDL2 Assets',\n  'Impact',\n  'Ink Free',\n  'Javanese Text',\n  'KaiTi',\n  'Leelawadee UI',\n  'Lucida Console',\n  'Lucida Sans Unicode',\n  'LXGW WenKai GB Screen',\n  'LXGW WenKai TC',\n  'Malgun Gothic',\n  'Marlett',\n  'Microsoft Himalaya',\n  'Microsoft JhengHei',\n  'Microsoft New Tai Lue',\n  'Microsoft PhagsPa',\n  'Microsoft Sans Serif',\n  'Microsoft Tai Le',\n  'Microsoft YaHei',\n  'Microsoft Yi Baiti',\n  'MingLiU',\n  'MingLiU-ExtB',\n  'Mongolian Baiti',\n  'MS Gothic',\n  'MS Mincho',\n  'MV Boli',\n  'Myanmar Text',\n  'Nirmala UI',\n  'Noto Serif JP',\n  'NSimSun',\n  'Palatino Linotype',\n  'PMingLiU',\n  'Segoe MDL2 Assets',\n  'Segoe Print',\n  'Segoe Script',\n  'Segoe UI',\n  'Segoe UI Historic',\n  'Segoe UI Emoji',\n  'Segoe UI Symbol',\n  'SimHei',\n  'SimSun',\n  'SimSun-ExtB',\n  'Sitka',\n  'Sylfaen',\n  'Tahoma',\n  'Times New Roman',\n  'Trebuchet MS',\n  'Verdana',\n  'XiHeiti',\n  'Yu Gothic',\n  'Yu Mincho',\n];\n\nexport const MACOS_FONTS = [\n  'American Typewriter',\n  'Andale Mono',\n  'Arial',\n  'Arial Black',\n  'Arial Narrow',\n  'Arial Rounded MT Bold',\n  'Arial Unicode MS',\n  'Avenir',\n  'Avenir Next',\n  'Avenir Next Condensed',\n  'Baskerville',\n  'BiauKai',\n  'Big Caslon',\n  'Bodoni 72',\n  'Bodoni 72 Oldstyle',\n  'Bodoni 72 Smallcaps',\n  'Bradley Hand',\n  'Brush Script MT',\n  'Chalkboard',\n  'Chalkboard SE',\n  'Chalkduster',\n  'Charter',\n  'Cochin',\n  'Comic Sans MS',\n  'Copperplate',\n  'Courier',\n  'Courier New',\n  'Didot',\n  'DIN Alternate',\n  'DIN Condensed',\n  'FangSong',\n  'Futura',\n  'Geneva',\n  'Georgia',\n  'Gill Sans',\n  'Heiti SC',\n  'Heiti TC',\n  'Helvetica',\n  'Helvetica Neue',\n  'Herculanum',\n  'Hiragino Sans',\n  'Hiragino Mincho',\n  'Hoefler Text',\n  'Impact',\n  'Kaiti SC',\n  'Kaiti TC',\n  'Kozuka Gothic Pro',\n  'Kozuka Mincho Pro',\n  'Lucida Grande',\n  'Luminari',\n  'LXGW WenKai GB Screen',\n  'LXGW WenKai TC',\n  'Marker Felt',\n  'Menlo',\n  'Microsoft Sans Serif',\n  'Monaco',\n  'Noteworthy',\n  'Noto Serif JP',\n  'Optima',\n  'Palatino',\n  'Papyrus',\n  'PingFang HK',\n  'PingFang SC',\n  'PingFang TC',\n  'Phosphate',\n  'Rockwell',\n  'Savoye LET',\n  'SignPainter',\n  'Skia',\n  'Snell Roundhand',\n  'Songti SC',\n  'Songti TC',\n  'STFangsong',\n  'STKaiti',\n  'STSong',\n  'STXihei',\n  'Tahoma',\n  'Times',\n  'Times New Roman',\n  'Trattatello',\n  'Trebuchet MS',\n  'Verdana',\n  'XiHeiti',\n  'Yu Mincho',\n  'Zapfino',\n];\n\nexport const LINUX_FONTS = [\n  'Arial',\n  'Cantarell',\n  'Comic Sans MS',\n  'Courier New',\n  'DejaVu Sans',\n  'DejaVu Sans Mono',\n  'DejaVu Serif',\n  'Droid Sans',\n  'Droid Sans Mono',\n  'FangSong',\n  'FreeMono',\n  'FreeSans',\n  'FreeSerif',\n  'Georgia',\n  'Heiti',\n  'Impact',\n  'Kaiti',\n  'Liberation Mono',\n  'Liberation Sans',\n  'Liberation Serif',\n  'LXGW WenKai GB Screen',\n  'LXGW WenKai TC',\n  'Noto Mono',\n  'Noto Sans',\n  'Noto Sans JP',\n  'Noto Sans CJK SC',\n  'Noto Sans CJK TC',\n  'Noto Serif',\n  'Noto Serif JP',\n  'Noto Serif CJK SC',\n  'Noto Serif CJK TC',\n  'Open Sans',\n  'Poppins',\n  'Sazanami Gothic',\n  'Sazanami Mincho',\n  'Source Han Sans',\n  'Source Han Serif',\n  'Times New Roman',\n  'Ubuntu',\n  'Ubuntu Mono',\n  'WenQuanYi Micro Hei',\n  'WenQuanYi Zen Hei',\n  'XiHeiti',\n];\n\nexport const IOS_FONTS = [\n  'Avenir',\n  'Avenir Next',\n  'Courier',\n  'Courier New',\n  'FangSong',\n  'Georgia',\n  'Heiti',\n  'Helvetica',\n  'Helvetica Neue',\n  'Hiragino Mincho',\n  'Hiragino Sans',\n  'Kaiti',\n  'LXGW WenKai GB Screen',\n  'LXGW WenKai TC',\n  'Palatino',\n  'PingFang SC',\n  'PingFang TC',\n  'San Francisco',\n  'SF Pro Display',\n  'SF Pro Rounded',\n  'SF Pro Text',\n  'Songti',\n  'Times New Roman',\n  'Verdana',\n  'XiHeiti',\n];\n\nexport const ANDROID_FONTS = [\n  'Arial',\n  'Droid Sans',\n  'Droid Serif',\n  'FangSong',\n  'FZLanTingHei',\n  'Georgia',\n  'Heiti',\n  'Kaiti',\n  'LXGW WenKai GB Screen',\n  'LXGW WenKai TC',\n  'Noto Sans',\n  'Noto Sans CJK',\n  'Noto Sans JP',\n  'Noto Serif',\n  'Noto Serif CJK',\n  'Noto Serif JP',\n  'PingFang SC',\n  'Roboto',\n  'Source Han Sans',\n  'Source Han Serif',\n  'STHeiti',\n  'STSong',\n  'Tahoma',\n  'Verdana',\n  'XiHeiti',\n];\n\nexport const CJK_EXCLUDE_PATTENS = new RegExp(\n  ['AlBayan', 'STIX', 'Kailasa', 'ITCTT', 'Luminari', 'Myanmar'].join('|'),\n  'i',\n);\nexport const CJK_FONTS_PATTENS = new RegExp(\n  [\n    'CJK',\n    'TC$',\n    'SC$',\n    'HK',\n    'JP',\n    'TW',\n    'Sim',\n    'Kai',\n    'Hei',\n    'Yan',\n    'Min',\n    'Khai',\n    'Yuan',\n    'Song',\n    'Ming',\n    'FZ',\n    'Huiwen',\n    'KingHwa',\n    'FangZheng',\n    'WenQuanYi',\n    'PingFang',\n    'Hiragino',\n    'Meiryo',\n    'Source\\\\s?Han',\n    'Yu\\\\s?Gothic',\n    'Yu\\\\s?Mincho',\n    'Mincho',\n    'Nanum',\n    'Malgun',\n    'Gulim',\n    'Dotum',\n    'Batang',\n    'Gungsuh',\n    'OPPO sans',\n    'MiSans',\n    'Fallback',\n  ].join('|'),\n  'i',\n);\n\nexport const BOOK_IDS_SEPARATOR = '+';\n\nexport const DOWNLOAD_READEST_URL = 'https://readest.com?utm_source=readest_web';\n\n// 支持通过环境变量自定义 API 地址（用于本地部署或自托管）\nexport const READEST_WEB_BASE_URL = process.env['NEXT_PUBLIC_WEB_BASE_URL'] || 'https://web.readest.com';\nexport const READEST_NODE_BASE_URL = process.env['NEXT_PUBLIC_NODE_BASE_URL'] || 'https://node.readest.com';\n\nconst LATEST_DOWNLOAD_BASE_URL = 'https://download.readest.com/releases';\n\nexport const READEST_UPDATER_FILE = `${LATEST_DOWNLOAD_BASE_URL}/latest.json`;\n\nexport const READEST_CHANGELOG_FILE = `${LATEST_DOWNLOAD_BASE_URL}/release-notes.json`;\n\n// 支持通过环境变量自定义存储 URL\nexport const READEST_PUBLIC_STORAGE_BASE_URL = process.env['NEXT_PUBLIC_STORAGE_BASE_URL'] || 'https://storage.readest.com';\n\nexport const READEST_OPDS_USER_AGENT = 'Readest/1.0 (OPDS Browser)';\n\nexport const SYNC_PROGRESS_INTERVAL_SEC = 3;\nexport const SYNC_NOTES_INTERVAL_SEC = 5;\nexport const SYNC_BOOKS_INTERVAL_SEC = 5;\nexport const CHECK_UPDATE_INTERVAL_SEC = 24 * 60 * 60;\n\nexport const MAX_ZOOM_LEVEL = 500;\nexport const MIN_ZOOM_LEVEL = 50;\nexport const ZOOM_STEP = 10;\n\nexport const DEFAULT_STORAGE_QUOTA: UserStorageQuota = {\n  free: 500 * 1024 * 1024,\n  plus: 5 * 1024 * 1024 * 1024,\n  pro: 20 * 1024 * 1024 * 1024,\n  purchase: 0,\n};\n\nexport const DEFAULT_DAILY_TRANSLATION_QUOTA: UserDailyTranslationQuota = {\n  free: 10 * 1024,\n  plus: 100 * 1024,\n  pro: 500 * 1024,\n  purchase: 0,\n};\n\nexport const DOUBLE_CLICK_INTERVAL_THRESHOLD_MS = 250;\nexport const DISABLE_DOUBLE_CLICK_ON_MOBILE = true;\nexport const LONG_HOLD_THRESHOLD = 500;\n\nexport const CUSTOM_THEME_TEMPLATES = [\n  {\n    light: {\n      fg: '#2b2b2b',\n      bg: '#f3f3f3',\n      primary: '#3c5a72',\n    },\n    dark: {\n      fg: '#d0d0d0',\n      bg: '#1a1c1f',\n      primary: '#486e8a',\n    },\n  },\n  {\n    light: {\n      fg: '#3f2f3c',\n      bg: '#f5ecf8',\n      primary: '#7b5291',\n    },\n    dark: {\n      fg: '#d6cadd',\n      bg: '#3a2c3d',\n      primary: '#bda0cc',\n    },\n  },\n  {\n    light: {\n      fg: '#2b2b2b',\n      bg: '#defcd9',\n      primary: '#00796b',\n    },\n    dark: {\n      fg: '#c8e6c9',\n      bg: '#273c33',\n      primary: '#26a69a',\n    },\n  },\n];\n\nexport const MIGHT_BE_RTL_LANGS = [\n  'zh',\n  'ja',\n  'ko',\n  'ar',\n  'he',\n  'fa',\n  'ur',\n  'dv',\n  'ps',\n  'sd',\n  'yi',\n  '',\n];\n\nexport const TRANSLATED_LANGS = {\n  en: 'English',\n  fr: 'Français',\n  de: 'Deutsch',\n  nl: 'Nederlands',\n  it: 'Italiano',\n  ja: '日本語',\n  ko: '한국어',\n  es: 'Español',\n  pt: 'Português',\n  ru: 'Русский',\n  ar: 'العربية',\n  fa: 'فارسی',\n  el: 'Ελληνικά',\n  uk: 'Українська',\n  pl: 'Polski',\n  tr: 'Türkçe',\n  hi: 'हिन्दी',\n  id: 'Indonesia',\n  vi: 'Tiếng Việt',\n  th: 'ภาษาไทย',\n  ms: 'Melayu',\n  bo: 'བོད་སྐད་',\n  bn: 'বাংলা',\n  ta: 'தமிழ்',\n  si: 'සිංහල',\n  'zh-CN': '简体中文',\n  'zh-TW': '正體中文',\n};\n\nexport const TRANSLATOR_LANGS: Record<string, string> = {\n  ...TRANSLATED_LANGS,\n  nb: 'Bokmål',\n  sv: 'Svenska',\n  fi: 'Suomi',\n  da: 'Dansk',\n  cs: 'Čeština',\n  hu: 'Magyar',\n  ro: 'Română',\n  bg: 'Български',\n  hr: 'Hrvatski',\n  lt: 'Lietuvių',\n  sl: 'Slovenščina',\n  sk: 'Slovenčina',\n  fa: 'فارسی',\n};\n\nexport const SUPPORTED_LANGS: Record<string, string> = { ...TRANSLATED_LANGS, zh: '中文' };\n\nexport const SUPPORTED_LANGNAMES: Record<string, string> = Object.fromEntries(\n  Object.entries(SUPPORTED_LANGS).map(([code, name]) => [name, code]),\n);\n"],"names":[],"mappings":"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CAAY;AAEpC,MAAM,gBAAgB;IAC3B;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAEM,MAAM,cAAc;IACzB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAEM,MAAM,cAAc;IACzB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAEM,MAAM,YAAY;IACvB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IAC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"}},
    {"offset": {"line": 898, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/environment.ts"],"sourcesContent":["import { AppService } from '@/types/system';\nimport { READEST_NODE_BASE_URL, READEST_WEB_BASE_URL } from './constants';\n\ndeclare global {\n  interface Window {\n    __READEST_CLI_ACCESS?: boolean;\n  }\n}\n\nconst appPlatform = process.env['NEXT_PUBLIC_APP_PLATFORM'] || 'web';\nexport const isTauriAppPlatform = () => appPlatform === 'tauri';\nexport const isWebAppPlatform = () => appPlatform === 'web';\nexport const hasCli = () => window.__READEST_CLI_ACCESS === true;\nexport const isPWA = () => window.matchMedia('(display-mode: standalone)').matches;\nexport const getBaseUrl = () => process.env['NEXT_PUBLIC_API_BASE_URL'] ?? READEST_WEB_BASE_URL;\nexport const getNodeBaseUrl = () =>\n  process.env['NEXT_PUBLIC_NODE_BASE_URL'] ?? READEST_NODE_BASE_URL;\n\nconst isWebDevMode = () => process.env['NODE_ENV'] === 'development' && isWebAppPlatform();\n\n// Dev API only in development mode and web platform\n// with command `pnpm dev-web`\n// for production build or tauri app use the production Web API\nexport const getAPIBaseUrl = () => (isWebDevMode() ? '/api' : `${getBaseUrl()}/api`);\n\n// For Node.js API that currently not supported in some edge runtimes\nexport const getNodeAPIBaseUrl = () => (isWebDevMode() ? '/api' : `${getNodeBaseUrl()}/api`);\n\nexport interface EnvConfigType {\n  getAppService: () => Promise<AppService>;\n}\n\nlet nativeAppService: AppService | null = null;\nconst getNativeAppService = async () => {\n  if (!nativeAppService) {\n    const { NativeAppService } = await import('@/services/nativeAppService');\n    nativeAppService = new NativeAppService();\n    await nativeAppService.init();\n  }\n  return nativeAppService;\n};\n\nlet webAppService: AppService | null = null;\nconst getWebAppService = async () => {\n  if (!webAppService) {\n    const { WebAppService } = await import('@/services/webAppService');\n    webAppService = new WebAppService();\n    await webAppService.init();\n  }\n  return webAppService;\n};\n\nconst environmentConfig: EnvConfigType = {\n  getAppService: async () => {\n    // Check if actually running in Tauri environment (runtime check)\n    const isTauriRuntime = typeof window !== 'undefined' && (window as any).__TAURI__;\n\n    if (isTauriAppPlatform() && isTauriRuntime) {\n      return getNativeAppService();\n    } else {\n      return getWebAppService();\n    }\n  },\n};\n\nexport default environmentConfig;\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AASoB;AARpB;;AAQA,MAAM,cAAc,2CAA2C;AACxD,MAAM,qBAAqB,IAAM,gBAAgB;AACjD,MAAM,mBAAmB,IAAM,gBAAgB;AAC/C,MAAM,SAAS,IAAM,OAAO,oBAAoB,KAAK;AACrD,MAAM,QAAQ,IAAM,OAAO,UAAU,CAAC,8BAA8B,OAAO;AAC3E,MAAM,aAAa,IAAM,6DAA2C,0KAAoB;AACxF,MAAM,iBAAiB,IAC5B,6DAA4C,2KAAqB;AAEnE,MAAM,eAAe,IAAM,oDAA4B,iBAAiB;AAKjE,MAAM,gBAAgB,IAAO,iBAAiB,SAAS;AAGvD,MAAM,oBAAoB,IAAO,iBAAiB,SAAS;AAMlE,IAAI,mBAAsC;AAC1C,MAAM,sBAAsB;IAC1B,IAAI,CAAC,kBAAkB;QACrB,MAAM,EAAE,gBAAgB,EAAE,GAAG;QAC7B,mBAAmB,IAAI;QACvB,MAAM,iBAAiB,IAAI;IAC7B;IACA,OAAO;AACT;AAEA,IAAI,gBAAmC;AACvC,MAAM,mBAAmB;IACvB,IAAI,CAAC,eAAe;QAClB,MAAM,EAAE,aAAa,EAAE,GAAG;QAC1B,gBAAgB,IAAI;QACpB,MAAM,cAAc,IAAI;IAC1B;IACA,OAAO;AACT;AAEA,MAAM,oBAAmC;IACvC,eAAe;QACb,iEAAiE;QACjE,MAAM,iBAAiB,+CAAkB,eAAe,AAAC,OAAe,SAAS;QAEjF,IAAI,wBAAwB;;aAErB;YACL,OAAO;QACT;IACF;AACF;uCAEe"}},
    {"offset": {"line": 968, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transferManager.ts"],"sourcesContent":["import { Book } from '@/types/book';\nimport { AppService } from '@/types/system';\nimport { useTransferStore, TransferItem } from '@/store/transferStore';\nimport { TranslationFunc } from '@/hooks/useTranslation';\nimport { ProgressPayload } from '@/utils/transfer';\nimport { eventDispatcher } from '@/utils/event';\n\nconst TRANSFER_QUEUE_KEY = 'readest_transfer_queue';\nconst RETRY_DELAY_BASE_MS = 2000;\n\ninterface PersistedQueueData {\n  transfers: Record<string, TransferItem>;\n  isQueuePaused: boolean;\n}\n\nclass TransferManager {\n  private static instance: TransferManager;\n  private appService: AppService | null = null;\n  private isProcessing = false;\n  private abortControllers: Map<string, AbortController> = new Map();\n  private isInitialized = false;\n  private getLibrary: (() => Book[]) | null = null;\n  private updateBook: ((book: Book) => Promise<void>) | null = null;\n  private _: TranslationFunc | null = null;\n\n  private constructor() { }\n\n  static getInstance(): TransferManager {\n    if (!TransferManager.instance) {\n      TransferManager.instance = new TransferManager();\n    }\n    return TransferManager.instance;\n  }\n\n  async initialize(\n    appService: AppService,\n    getLibrary: () => Book[],\n    updateBook: (book: Book) => Promise<void>,\n    translationFn: TranslationFunc,\n  ): Promise<void> {\n    if (this.isInitialized) return;\n\n    this.appService = appService;\n    this.getLibrary = getLibrary;\n    this.updateBook = updateBook;\n    this._ = translationFn;\n    await this.loadPersistedQueue();\n    this.isInitialized = true;\n\n    // Start processing queue\n    this.processQueue();\n  }\n\n  isReady(): boolean {\n    return this.isInitialized && this.appService !== null;\n  }\n\n  queueUpload(book: Book, priority: number = 10): string | null {\n    if (!this.isReady()) {\n      console.warn('TransferManager not initialized');\n      return null;\n    }\n\n    const store = useTransferStore.getState();\n\n    // Check if already queued or in progress\n    const existing = store.getTransferByBookHash(book.hash, 'upload');\n    if (existing) {\n      return existing.id;\n    }\n\n    const transferId = store.addTransfer(book.hash, book.title, 'upload', priority);\n    this.persistQueue();\n    this.processQueue();\n    return transferId;\n  }\n\n  queueDownload(book: Book, priority: number = 10): string | null {\n    if (!this.isReady()) {\n      console.warn('TransferManager not initialized');\n      return null;\n    }\n\n    const store = useTransferStore.getState();\n\n    const existing = store.getTransferByBookHash(book.hash, 'download');\n    if (existing) {\n      return existing.id;\n    }\n\n    const transferId = store.addTransfer(book.hash, book.title, 'download', priority);\n    this.persistQueue();\n    this.processQueue();\n    return transferId;\n  }\n\n  queueDelete(book: Book, priority: number = 10, isBackground: boolean = false): string | null {\n    if (!this.isReady()) {\n      console.warn('TransferManager not initialized');\n      return null;\n    }\n\n    const store = useTransferStore.getState();\n\n    const existing = store.getTransferByBookHash(book.hash, 'delete');\n    if (existing) {\n      return existing.id;\n    }\n\n    const transferId = store.addTransfer(book.hash, book.title, 'delete', priority, isBackground);\n    this.persistQueue();\n    this.processQueue();\n    return transferId;\n  }\n\n  queueBatchUploads(books: Book[], priority: number = 10): string[] {\n    return books\n      .map((book) => this.queueUpload(book, priority))\n      .filter((id): id is string => id !== null);\n  }\n\n  cancelTransfer(transferId: string): void {\n    const controller = this.abortControllers.get(transferId);\n    if (controller) {\n      controller.abort();\n      this.abortControllers.delete(transferId);\n    }\n\n    useTransferStore.getState().setTransferStatus(transferId, 'cancelled');\n    this.persistQueue();\n  }\n\n  retryTransfer(transferId: string): void {\n    const store = useTransferStore.getState();\n    store.retryTransfer(transferId);\n    this.persistQueue();\n    this.processQueue();\n  }\n\n  retryAllFailed(): void {\n    const store = useTransferStore.getState();\n    const failed = store.getFailedTransfers();\n    failed.forEach((transfer) => {\n      store.retryTransfer(transfer.id);\n    });\n    this.persistQueue();\n    this.processQueue();\n  }\n\n  pauseQueue(): void {\n    useTransferStore.getState().pauseQueue();\n    this.persistQueue();\n  }\n\n  resumeQueue(): void {\n    useTransferStore.getState().resumeQueue();\n    this.processQueue();\n    this.persistQueue();\n  }\n\n  private async processQueue(): Promise<void> {\n    if (this.isProcessing) return;\n\n    this.isProcessing = true;\n\n    try {\n      await this._processQueueInternal();\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  private async _processQueueInternal(): Promise<void> {\n    const store = useTransferStore.getState();\n\n    if (store.isQueuePaused) return;\n\n    const pending = store.getPendingTransfers();\n    const activeCount = store.getActiveTransfers().length;\n    const maxConcurrent = store.maxConcurrent;\n\n    const availableSlots = maxConcurrent - activeCount;\n    if (availableSlots <= 0 || pending.length === 0) return;\n\n    // Sort by priority (lower = higher priority) then by createdAt\n    const sortedPending = [...pending].sort((a, b) => {\n      if (a.priority !== b.priority) return a.priority - b.priority;\n      return a.createdAt - b.createdAt;\n    });\n\n    const toProcess = sortedPending.slice(0, availableSlots);\n\n    await Promise.all(toProcess.map((transfer) => this.executeTransfer(transfer)));\n\n    // Check if more items to process\n    const newStore = useTransferStore.getState();\n    if (newStore.getPendingTransfers().length > 0 && !newStore.isQueuePaused) {\n      setTimeout(() => this.processQueue(), 100);\n    }\n  }\n\n  private async executeTransfer(transfer: TransferItem): Promise<void> {\n    if (!this.appService || !this.getLibrary || !this.updateBook) {\n      console.error('TransferManager not properly initialized');\n      return;\n    }\n\n    const _ = this._!;\n    const store = useTransferStore.getState();\n    const abortController = new AbortController();\n    this.abortControllers.set(transfer.id, abortController);\n\n    store.setTransferStatus(transfer.id, 'in_progress');\n    store.setActiveCount(store.getActiveTransfers().length + 1);\n\n    const progressHandler = (progress: ProgressPayload) => {\n      if (abortController.signal.aborted) return;\n\n      const percentage = progress.total > 0 ? (progress.progress / progress.total) * 100 : 0;\n\n      useTransferStore\n        .getState()\n        .updateTransferProgress(\n          transfer.id,\n          percentage,\n          progress.progress,\n          progress.total,\n          progress.transferSpeed,\n        );\n    };\n\n    try {\n      const library = this.getLibrary();\n      const book = library.find((b) => b.hash === transfer.bookHash);\n\n      if (!book) {\n        throw new Error(_('Book not found in library') as string);\n      }\n\n      if (transfer.type === 'upload') {\n        // Cloud upload functionality removed - using local server storage only\n        throw new Error(_('Upload functionality has been removed') as string);\n      } else if (transfer.type === 'download') {\n        // Cloud download functionality removed - using local server storage only\n        throw new Error(_('Download functionality has been removed') as string);\n      } else if (transfer.type === 'delete') {\n        await this.appService.deleteBook(book, 'cloud');\n        await this.updateBook(book);\n      }\n\n      useTransferStore.getState().setTransferStatus(transfer.id, 'completed');\n\n      const successMessages = {\n        upload: _('Book uploaded: {{title}}', { title: transfer.bookTitle }),\n        download: _('Book downloaded: {{title}}', { title: transfer.bookTitle }),\n        delete: _('Deleted cloud backup of the book: {{title}}', { title: transfer.bookTitle }),\n      };\n\n      if (!transfer.isBackground) {\n        eventDispatcher.dispatch('toast', {\n          type: 'info',\n          timeout: 2000,\n          message: successMessages[transfer.type],\n        });\n      }\n    } catch (error) {\n      if (abortController.signal.aborted) {\n        // Already cancelled, don't update status\n        return;\n      }\n\n      const errorMessage = error instanceof Error ? error.message : _('Unknown error');\n      const currentStore = useTransferStore.getState();\n      const currentTransfer = currentStore.transfers[transfer.id];\n\n      if (currentTransfer && currentTransfer.retryCount < currentTransfer.maxRetries) {\n        // Schedule retry with exponential backoff\n        const delay = RETRY_DELAY_BASE_MS * Math.pow(2, currentTransfer.retryCount);\n        currentStore.incrementRetryCount(transfer.id);\n        currentStore.setTransferStatus(\n          transfer.id,\n          'pending',\n          `Retry ${currentTransfer.retryCount + 1}/${currentTransfer.maxRetries}`,\n        );\n\n        setTimeout(() => {\n          this.processQueue();\n        }, delay);\n      } else {\n        if (errorMessage.includes('Not authenticated')) {\n          eventDispatcher.dispatch('toast', {\n            type: 'error',\n            message: _('Please log in to continue'),\n          });\n        } else if (errorMessage.includes('Insufficient storage quota')) {\n          eventDispatcher.dispatch('toast', {\n            type: 'error',\n            message: _('Insufficient storage quota'),\n          });\n        } else {\n          const errorMessages = {\n            upload: _('Failed to upload book: {{title}}', { title: transfer.bookTitle }),\n            download: _('Failed to download book: {{title}}', { title: transfer.bookTitle }),\n            delete: _('Failed to delete cloud backup of the book: {{title}}', {\n              title: transfer.bookTitle,\n            }),\n          };\n\n          eventDispatcher.dispatch('toast', {\n            type: 'error',\n            message: errorMessages[transfer.type],\n          });\n        }\n\n        useTransferStore.getState().setTransferStatus(transfer.id, 'failed', errorMessage);\n      }\n    } finally {\n      this.abortControllers.delete(transfer.id);\n\n      const currentStore = useTransferStore.getState();\n      currentStore.setActiveCount(Math.max(0, currentStore.getActiveTransfers().length));\n      this.persistQueue();\n\n      // Continue processing\n      setTimeout(() => this.processQueue(), 100);\n    }\n  }\n\n  private async loadPersistedQueue(): Promise<void> {\n    try {\n      if (typeof localStorage === 'undefined') return;\n\n      const stored = localStorage.getItem(TRANSFER_QUEUE_KEY);\n      if (!stored) return;\n\n      const data: PersistedQueueData = JSON.parse(stored);\n      const store = useTransferStore.getState();\n\n      // Restore all transfers using the store's restore method\n      // This preserves the original IDs and handles in_progress -> pending conversion\n      store.restoreTransfers(data.transfers, data.isQueuePaused);\n    } catch (error) {\n      console.error('Failed to load transfer queue:', error);\n    }\n  }\n\n  private persistQueue(): void {\n    try {\n      if (typeof localStorage === 'undefined') return;\n\n      const store = useTransferStore.getState();\n\n      // Persist all transfers including completed (for history)\n      const data: PersistedQueueData = {\n        transfers: store.transfers,\n        isQueuePaused: store.isQueuePaused,\n      };\n\n      localStorage.setItem(TRANSFER_QUEUE_KEY, JSON.stringify(data));\n    } catch (error) {\n      console.error('Failed to persist transfer queue:', error);\n    }\n  }\n}\n\nexport const transferManager = TransferManager.getInstance();\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1265, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/types.ts"],"sourcesContent":["import { TranslatorName } from './providers';\n\nexport interface TranslationProvider {\n  name: string;\n  label: string;\n  authRequired?: boolean;\n  quotaExceeded?: boolean;\n  translate: (\n    texts: string[],\n    sourceLang: string,\n    targetLang: string,\n    token?: string | null,\n    useCache?: boolean,\n  ) => Promise<string[]>;\n}\n\nexport interface TranslationCache {\n  [key: string]: string;\n}\n\nexport interface UseTranslatorOptions {\n  provider?: TranslatorName;\n  sourceLang?: string;\n  targetLang?: string;\n  enablePolishing?: boolean;\n  enablePreprocessing?: boolean;\n}\n\nexport const ErrorCodes = {\n  UNAUTHORIZED: 'Unauthorized',\n  DEEPL_API_ERROR: 'DeepL API Error',\n  DAILY_QUOTA_EXCEEDED: 'Daily Quota Exceeded',\n  INTERNAL_SERVER_ERROR: 'Internal Server Error',\n};\n"],"names":[],"mappings":";;;;AA4BO,MAAM,aAAa;IACxB,cAAc;IACd,iBAAiB;IACjB,sBAAsB;IACtB,uBAAuB;AACzB"}},
    {"offset": {"line": 1282, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/cache.ts"],"sourcesContent":["import { TranslationCache } from './types';\n\nconst DB_NAME = 'TranslationCache';\nconst DB_VERSION = 1;\nconst STORE_NAME = 'translations';\n\ninterface CacheEntry {\n  key: string;\n  translation: string;\n  timestamp: number;\n  provider: string;\n  sourceLang: string;\n  targetLang: string;\n  originalText: string;\n}\n\nconst memoryCache: TranslationCache = {};\nconst memoryTimestamps: Record<string, number> = {};\n\nconst openDatabase = (): Promise<IDBDatabase> => {\n  return new Promise((resolve, reject) => {\n    if (!window.indexedDB) {\n      console.warn('IndexedDB not supported. Using in-memory cache only.');\n      reject(new Error('IndexedDB not supported'));\n      return;\n    }\n\n    const request = indexedDB.open(DB_NAME, DB_VERSION);\n\n    request.onerror = (event) => {\n      console.error('IndexedDB error:', event);\n      reject(new Error('Could not open IndexedDB'));\n    };\n\n    request.onsuccess = (event) => {\n      const db = (event.target as IDBOpenDBRequest).result;\n      resolve(db);\n    };\n\n    request.onupgradeneeded = (event) => {\n      const db = (event.target as IDBOpenDBRequest).result;\n\n      if (!db.objectStoreNames.contains(STORE_NAME)) {\n        const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });\n        store.createIndex('provider', 'provider', { unique: false });\n        store.createIndex('timestamp', 'timestamp', { unique: false });\n      }\n    };\n  });\n};\n\nexport const loadCacheFromDB = async (\n  options: {\n    maxAge?: number;\n    maxEntries?: number;\n    onlyLoadProviders?: string[];\n    onlyLoadLanguages?: { source?: string[]; target?: string[] };\n  } = {},\n): Promise<void> => {\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n\n    let request: IDBRequest;\n    if (options.onlyLoadProviders && options.onlyLoadProviders.length > 0) {\n      const providerPromises = options.onlyLoadProviders.map((provider) => {\n        return new Promise<CacheEntry[]>((resolve) => {\n          const providerIndex = store.index('provider');\n          const request = providerIndex.getAll(provider);\n\n          request.onsuccess = () => {\n            resolve(request.result);\n          };\n\n          request.onerror = () => {\n            resolve([]);\n          };\n        });\n      });\n\n      const allEntries = (await Promise.all(providerPromises)).flat();\n      processLoadedEntries(allEntries, options);\n    } else {\n      request = store.getAll();\n\n      request.onsuccess = () => {\n        const entries = request.result as CacheEntry[];\n        processLoadedEntries(entries, options);\n      };\n\n      request.onerror = (event) => {\n        console.error('Error loading cache from IndexedDB:', event);\n      };\n    }\n\n    transaction.oncomplete = () => {\n      db.close();\n    };\n  } catch (error) {\n    console.error('Failed to load cache from IndexedDB:', error);\n  }\n};\n\nconst processLoadedEntries = (\n  entries: CacheEntry[],\n  options: {\n    maxAge?: number;\n    maxEntries?: number;\n    onlyLoadLanguages?: { source?: string[]; target?: string[] };\n  },\n): void => {\n  let filteredEntries = entries;\n\n  if (options.maxAge) {\n    const cutoff = Date.now() - options.maxAge;\n    filteredEntries = filteredEntries.filter((entry) => entry.timestamp >= cutoff);\n  }\n\n  if (options.onlyLoadLanguages) {\n    if (options.onlyLoadLanguages.source && options.onlyLoadLanguages.source.length > 0) {\n      filteredEntries = filteredEntries.filter((entry) =>\n        options.onlyLoadLanguages!.source!.includes(entry.sourceLang),\n      );\n    }\n\n    if (options.onlyLoadLanguages.target && options.onlyLoadLanguages.target.length > 0) {\n      filteredEntries = filteredEntries.filter((entry) =>\n        options.onlyLoadLanguages!.target!.includes(entry.targetLang),\n      );\n    }\n  }\n\n  if (options.maxEntries && filteredEntries.length > options.maxEntries) {\n    filteredEntries.sort((a, b) => b.timestamp - a.timestamp);\n    filteredEntries = filteredEntries.slice(0, options.maxEntries);\n  }\n\n  filteredEntries.forEach((entry) => {\n    memoryCache[entry.key] = entry.translation;\n    memoryTimestamps[entry.key] = entry.timestamp;\n  });\n\n  // console.log(`Loaded ${filteredEntries.length} translations into memory cache`);\n};\n\nexport const getCacheKey = (\n  text: string,\n  sourceLang: string,\n  targetLang: string,\n  provider: string,\n): string => {\n  return `${provider}:${sourceLang}:${targetLang}:${text}`;\n};\n\nexport const getFromCache = async (\n  text: string,\n  sourceLang: string,\n  targetLang: string,\n  provider: string,\n): Promise<string | null> => {\n  if (!text?.trim()) return null;\n\n  const key = getCacheKey(text, sourceLang, targetLang, provider);\n\n  if (memoryCache[key]) {\n    return memoryCache[key];\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n    const request = store.get(key);\n\n    return new Promise((resolve) => {\n      request.onsuccess = () => {\n        const entry = request.result as CacheEntry;\n        if (entry) {\n          memoryCache[key] = entry.translation;\n          memoryTimestamps[key] = entry.timestamp;\n          resolve(entry.translation);\n        } else {\n          resolve(null);\n        }\n      };\n\n      request.onerror = () => {\n        resolve(null);\n      };\n\n      transaction.oncomplete = () => {\n        db.close();\n      };\n    });\n  } catch (error) {\n    console.error('Error accessing IndexedDB:', error);\n    return null;\n  }\n};\n\nexport const storeInCache = async (\n  text: string,\n  translation: string,\n  sourceLang: string,\n  targetLang: string,\n  provider: string,\n): Promise<void> => {\n  if (!text?.trim() || !translation) return;\n\n  const key = getCacheKey(text, sourceLang, targetLang, provider);\n  const timestamp = Date.now();\n\n  memoryCache[key] = translation;\n  memoryTimestamps[key] = timestamp;\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n\n    const entry: CacheEntry = {\n      key,\n      translation,\n      timestamp,\n      provider,\n      sourceLang,\n      targetLang,\n      originalText: text,\n    };\n\n    store.put(entry);\n\n    return new Promise((resolve, reject) => {\n      transaction.oncomplete = () => {\n        db.close();\n        resolve();\n      };\n\n      transaction.onerror = (event) => {\n        console.error('Error storing in IndexedDB:', event);\n        reject(new Error('Failed to store in IndexedDB'));\n      };\n    });\n  } catch (error) {\n    console.error('Error accessing IndexedDB:', error);\n  }\n};\n\nexport interface CacheFilterOptions {\n  provider?: string;\n  maxAge?: number;\n}\n\nexport const clearCache = async (filter?: CacheFilterOptions): Promise<number> => {\n  let deletedCount = 0;\n\n  if (!filter) {\n    const count = Object.keys(memoryCache).length;\n    Object.keys(memoryCache).forEach((key) => {\n      delete memoryCache[key];\n      delete memoryTimestamps[key];\n    });\n    deletedCount = count;\n  } else {\n    const keysToDelete: string[] = [];\n\n    Object.keys(memoryCache).forEach((key) => {\n      let shouldDelete = true;\n\n      if (filter.provider) {\n        const parts = key.split(':');\n        const provider = parts[0];\n\n        if (filter.provider && provider !== filter.provider) {\n          shouldDelete = false;\n        }\n      }\n\n      if (shouldDelete && filter.maxAge && memoryTimestamps[key]) {\n        const timestamp = memoryTimestamps[key];\n        if (Date.now() - timestamp < filter.maxAge) {\n          shouldDelete = false;\n        }\n      }\n\n      if (shouldDelete) {\n        keysToDelete.push(key);\n      }\n    });\n\n    keysToDelete.forEach((key) => {\n      delete memoryCache[key];\n      delete memoryTimestamps[key];\n    });\n\n    deletedCount = keysToDelete.length;\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n\n    if (!filter) {\n      store.clear();\n    } else {\n      const request = store.getAll();\n\n      request.onsuccess = () => {\n        const entries = request.result as CacheEntry[];\n        const filteredEntries = entries.filter((entry) => {\n          if (filter.provider && entry.provider !== filter.provider) {\n            return false;\n          }\n\n          if (filter.maxAge && Date.now() - entry.timestamp >= filter.maxAge) {\n            return true;\n          }\n\n          return true;\n        });\n\n        filteredEntries.forEach((entry) => {\n          store.delete(entry.key);\n        });\n      };\n    }\n\n    return new Promise((resolve) => {\n      transaction.oncomplete = () => {\n        db.close();\n        resolve(deletedCount);\n      };\n\n      transaction.onerror = () => {\n        db.close();\n        resolve(deletedCount);\n      };\n    });\n  } catch (error) {\n    console.error('Error clearing IndexedDB cache:', error);\n    return deletedCount;\n  }\n};\n\nexport const getCacheStats = async (\n  includeDB: boolean = false,\n): Promise<{\n  memoryCacheEntries: number;\n  memoryCacheSizeInBytes: number;\n  dbCacheEntries?: number;\n  dbCacheSizeInBytes?: number;\n  totalEntries?: number;\n  totalSizeInBytes?: number;\n}> => {\n  const memoryCacheEntries = Object.keys(memoryCache).length;\n\n  let memoryCacheSizeInBytes = 0;\n  for (const key in memoryCache) {\n    memoryCacheSizeInBytes += key.length;\n\n    const value = memoryCache[key] || '';\n    memoryCacheSizeInBytes += value.length;\n  }\n\n  if (!includeDB) {\n    return { memoryCacheEntries, memoryCacheSizeInBytes };\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, 'readonly');\n    const store = transaction.objectStore(STORE_NAME);\n    const countRequest = store.count();\n\n    return new Promise((resolve) => {\n      countRequest.onsuccess = () => {\n        const dbCacheEntries = countRequest.result;\n\n        const getAllRequest = store.getAll();\n\n        getAllRequest.onsuccess = () => {\n          const entries = getAllRequest.result as CacheEntry[];\n\n          let dbCacheSizeInBytes = 0;\n          entries.forEach((entry) => {\n            const entryString = JSON.stringify(entry);\n            dbCacheSizeInBytes += entryString.length;\n          });\n\n          const totalEntries =\n            memoryCacheEntries + dbCacheEntries - Math.min(memoryCacheEntries, dbCacheEntries);\n\n          const totalSizeInBytes = memoryCacheSizeInBytes + dbCacheSizeInBytes;\n\n          resolve({\n            memoryCacheEntries,\n            memoryCacheSizeInBytes,\n            dbCacheEntries,\n            dbCacheSizeInBytes,\n            totalEntries,\n            totalSizeInBytes,\n          });\n        };\n      };\n\n      transaction.oncomplete = () => {\n        db.close();\n      };\n\n      transaction.onerror = () => {\n        db.close();\n        resolve({\n          memoryCacheEntries,\n          memoryCacheSizeInBytes,\n        });\n      };\n    });\n  } catch (error) {\n    console.error('Error getting IndexedDB stats:', error);\n    return { memoryCacheEntries, memoryCacheSizeInBytes };\n  }\n};\n\nexport const pruneCache = async (\n  options: {\n    maxAge?: number;\n    maxEntries?: number;\n    maxSizeInBytes?: number;\n    dryRun?: boolean;\n  } = {},\n): Promise<number> => {\n  const { maxAge, maxEntries, maxSizeInBytes, dryRun = false } = options;\n\n  if (!maxAge && !maxEntries && !maxSizeInBytes) {\n    return 0;\n  }\n\n  try {\n    const db = await openDatabase();\n    const transaction = db.transaction(STORE_NAME, dryRun ? 'readonly' : 'readwrite');\n    const store = transaction.objectStore(STORE_NAME);\n    const getAllRequest = store.getAll();\n\n    return new Promise((resolve) => {\n      getAllRequest.onsuccess = () => {\n        const entries = getAllRequest.result as CacheEntry[];\n        const entriesToPrune: CacheEntry[] = [];\n\n        if (maxAge) {\n          const cutoffTime = Date.now() - maxAge;\n          const agedEntries = entries.filter((entry) => entry.timestamp < cutoffTime);\n          entriesToPrune.push(...agedEntries);\n        }\n\n        if (maxEntries && entries.length > maxEntries) {\n          const sortedEntries = [...entries].sort((a, b) => a.timestamp - b.timestamp);\n          const excessEntries = sortedEntries.slice(0, entries.length - maxEntries);\n\n          const prunedKeys = new Set(entriesToPrune.map((e) => e.key));\n          excessEntries.forEach((entry) => {\n            if (!prunedKeys.has(entry.key)) {\n              entriesToPrune.push(entry);\n            }\n          });\n        }\n\n        if (maxSizeInBytes) {\n          let currentSize = 0;\n          entries.forEach((entry) => {\n            const entryString = JSON.stringify(entry);\n            currentSize += entryString.length;\n          });\n\n          if (currentSize > maxSizeInBytes) {\n            const remainingEntries = entries\n              .filter((entry) => !entriesToPrune.some((e) => e.key === entry.key))\n              .sort((a, b) => a.timestamp - b.timestamp);\n\n            let sizeToRemove = currentSize - maxSizeInBytes;\n            const prunedKeys = new Set(entriesToPrune.map((e) => e.key));\n\n            for (const entry of remainingEntries) {\n              if (sizeToRemove <= 0) break;\n\n              if (!prunedKeys.has(entry.key)) {\n                const entryString = JSON.stringify(entry);\n                const entrySize = entryString.length * 2;\n\n                entriesToPrune.push(entry);\n                prunedKeys.add(entry.key);\n                sizeToRemove -= entrySize;\n              }\n            }\n          }\n        }\n\n        const pruneCount = entriesToPrune.length;\n\n        if (!dryRun && pruneCount > 0) {\n          entriesToPrune.forEach((entry) => {\n            store.delete(entry.key);\n\n            delete memoryCache[entry.key];\n            delete memoryTimestamps[entry.key];\n          });\n        }\n\n        resolve(pruneCount);\n      };\n\n      getAllRequest.onerror = () => {\n        resolve(0);\n      };\n\n      transaction.oncomplete = () => {\n        db.close();\n      };\n    });\n  } catch (error) {\n    console.error('Error pruning cache:', error);\n    return 0;\n  }\n};\n\nexport const initCache = async (\n  options: {\n    preload?: boolean;\n    preloadOptions?: {\n      maxAge?: number;\n      maxEntries?: number;\n      onlyLoadProviders?: string[];\n      onlyLoadLanguages?: { source?: string[]; target?: string[] };\n    };\n    autoPrune?: boolean;\n    pruneInterval?: number;\n    pruneOptions?: {\n      maxAge?: number;\n      maxEntries?: number;\n      maxSizeInBytes?: number;\n    };\n  } = {},\n): Promise<() => void> => {\n  const {\n    preload = true,\n    preloadOptions = {\n      maxAge: 30 * 24 * 60 * 60 * 1000,\n      maxEntries: 10000,\n    },\n    autoPrune = true,\n    pruneInterval = 60 * 60 * 1000,\n    pruneOptions = {\n      maxAge: 90 * 24 * 60 * 60 * 1000,\n      maxEntries: 100000,\n      maxSizeInBytes: 10 * 1024 * 1024,\n    },\n  } = options;\n\n  if (preload) {\n    await loadCacheFromDB(preloadOptions);\n  }\n\n  let intervalId: number | null = null;\n\n  if (autoPrune) {\n    await pruneCache(pruneOptions);\n\n    intervalId = window.setInterval(async () => {\n      await pruneCache(pruneOptions);\n    }, pruneInterval);\n  }\n\n  return () => {\n    if (intervalId !== null) {\n      clearInterval(intervalId);\n    }\n  };\n};\n\nlet cleanupFunction: (() => void) | null = null;\n\nif (typeof window !== 'undefined') {\n  initCache().then((cleanup) => {\n    cleanupFunction = cleanup;\n  });\n\n  window.addEventListener('beforeunload', () => {\n    if (cleanupFunction) {\n      cleanupFunction();\n    }\n  });\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1724, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/polish.ts"],"sourcesContent":["export type Polisher = (text: string) => string;\n\nconst languagePolishers: Record<string, Polisher> = {\n  // Chinese - fix punctuation spacing\n  zh: (text: string) =>\n    text\n      .replace(/--/g, '⸺')\n      .replace(/\\s+([。、！？])/g, '$1')\n      .replace(/([。、！？])\\s+/g, '$1'),\n\n  // Spanish - fix punctuation spacing\n  es: (text: string) =>\n    text.replace(/\\?([A-ZÁÉÍÓÚÑÜ])/g, '? $1').replace(/\\!([A-ZÁÉÍÓÚÑÜ])/g, '! $1'),\n\n  // French - fix punctuation spacing\n  fr: (text: string) => text.replace(/\\s+([!?:;])/g, ' $1').replace(/([!?:;])\\s+/g, '$1 '),\n\n  // Japanese - fix punctuation spacing\n  ja: (text: string) => text.replace(/\\s+([。、！？])/g, '$1').replace(/([。、！？])\\s+/g, '$1'),\n};\n\nexport const basicPolish: Polisher = (text: string) => {\n  return text\n    .replace(/\\s+/g, ' ') // Multiple spaces to single space\n    .replace(/\\s+([.,!?;:])/g, '$1') // Remove space before punctuation\n    .trim();\n};\n\nexport function getPolisher(targetLang: string): Polisher {\n  const langCode = targetLang.split('-')[0]!.toLowerCase();\n  const languagePolisher = languagePolishers[langCode];\n\n  if (languagePolisher) {\n    return (text: string) => {\n      const basicPolished = basicPolish(text);\n      const polished = languagePolisher(basicPolished);\n      return polished;\n    };\n  }\n\n  return basicPolish;\n}\n\nexport function polish(texts: string[], targetLang: string): string[] {\n  const polisher = getPolisher(targetLang);\n  return texts.map(polisher);\n}\n"],"names":[],"mappings":";;;;;;;;AAEA,MAAM,oBAA8C;IAClD,oCAAoC;IACpC,IAAI,CAAC,OACH,KACG,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,gBAAgB,MACxB,OAAO,CAAC,gBAAgB;IAE7B,oCAAoC;IACpC,IAAI,CAAC,OACH,KAAK,OAAO,CAAC,qBAAqB,QAAQ,OAAO,CAAC,qBAAqB;IAEzE,mCAAmC;IACnC,IAAI,CAAC,OAAiB,KAAK,OAAO,CAAC,gBAAgB,OAAO,OAAO,CAAC,gBAAgB;IAElF,qCAAqC;IACrC,IAAI,CAAC,OAAiB,KAAK,OAAO,CAAC,gBAAgB,MAAM,OAAO,CAAC,gBAAgB;AACnF;AAEO,MAAM,cAAwB,CAAC;IACpC,OAAO,KACJ,OAAO,CAAC,QAAQ,KAAK,kCAAkC;KACvD,OAAO,CAAC,kBAAkB,MAAM,kCAAkC;KAClE,IAAI;AACT;AAEO,SAAS,YAAY,UAAkB;IAC5C,MAAM,WAAW,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE,CAAE,WAAW;IACtD,MAAM,mBAAmB,iBAAiB,CAAC,SAAS;IAEpD,IAAI,kBAAkB;QACpB,OAAO,CAAC;YACN,MAAM,gBAAgB,YAAY;YAClC,MAAM,WAAW,iBAAiB;YAClC,OAAO;QACT;IACF;IAEA,OAAO;AACT;AAEO,SAAS,OAAO,KAAe,EAAE,UAAkB;IACxD,MAAM,WAAW,YAAY;IAC7B,OAAO,MAAM,GAAG,CAAC;AACnB"}},
    {"offset": {"line": 1770, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/preprocess.ts"],"sourcesContent":["export type Preprocessor = (text: string) => string;\nexport type TextSubstitutions = Record<string, string>;\n\nconst defaultSubstitutions: TextSubstitutions = {\n  Cover: 'The Cover',\n  Dedication: 'Dedication Page',\n  Acknowledgements: 'The Acknowledgements',\n};\n\nexport const basicSubstitute = (text: string, substitutions: TextSubstitutions): string => {\n  const allSubstitutions = { ...defaultSubstitutions, ...substitutions };\n\n  if (Object.keys(allSubstitutions).length === 0) {\n    return text;\n  }\n\n  if (allSubstitutions[text]) {\n    return allSubstitutions[text];\n  }\n\n  return text;\n};\n\nexport function createPreprocessor(substitutions: TextSubstitutions = {}): Preprocessor {\n  return (text: string) => basicSubstitute(text, substitutions);\n}\n\nexport function preprocess(texts: string[], substitutions: TextSubstitutions = {}): string[] {\n  const preprocessor = createPreprocessor(substitutions);\n  return texts.map(preprocessor);\n}\n"],"names":[],"mappings":";;;;;;;;AAGA,MAAM,uBAA0C;IAC9C,OAAO;IACP,YAAY;IACZ,kBAAkB;AACpB;AAEO,MAAM,kBAAkB,CAAC,MAAc;IAC5C,MAAM,mBAAmB;QAAE,GAAG,oBAAoB;QAAE,GAAG,aAAa;IAAC;IAErE,IAAI,OAAO,IAAI,CAAC,kBAAkB,MAAM,KAAK,GAAG;QAC9C,OAAO;IACT;IAEA,IAAI,gBAAgB,CAAC,KAAK,EAAE;QAC1B,OAAO,gBAAgB,CAAC,KAAK;IAC/B;IAEA,OAAO;AACT;AAEO,SAAS,mBAAmB,gBAAmC,CAAC,CAAC;IACtE,OAAO,CAAC,OAAiB,gBAAgB,MAAM;AACjD;AAEO,SAAS,WAAW,KAAe,EAAE,gBAAmC,CAAC,CAAC;IAC/E,MAAM,eAAe,mBAAmB;IACxC,OAAO,MAAM,GAAG,CAAC;AACnB"}},
    {"offset": {"line": 1810, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/utils.ts"],"sourcesContent":["import { Book } from '@/types/book';\nimport { isSameLang } from '@/utils/lang';\nimport { getLocale } from '@/utils/misc';\n\nconst DAILY_USAGE_KEY = 'translationDailyUsage';\n\nexport const saveDailyUsage = (usage: number, date?: string) => {\n  if (typeof window !== 'undefined') {\n    const isoDate = date || new Date().toISOString().split('T')[0]!;\n    const dailyUsage = { [isoDate]: usage };\n    localStorage.setItem(DAILY_USAGE_KEY, JSON.stringify(dailyUsage));\n  }\n};\n\nexport const getDailyUsage = (date?: string): number | null => {\n  if (typeof window !== 'undefined') {\n    const isoDate = date || new Date().toISOString().split('T')[0]!;\n    const usage = localStorage.getItem(DAILY_USAGE_KEY);\n    if (usage) {\n      const dailyUsage = JSON.parse(usage);\n      if (dailyUsage[isoDate]) {\n        return dailyUsage[isoDate];\n      }\n    }\n  }\n  return null;\n};\n\nexport const isTranslationAvailable = (book?: Book | null, targetLanguage?: string | null) => {\n  if (!book || book.format === 'PDF') {\n    return false;\n  }\n\n  const primaryLanguage = book.primaryLanguage || '';\n  if (!primaryLanguage || primaryLanguage.toLowerCase() === 'und') {\n    return false;\n  }\n\n  if (targetLanguage && isSameLang(primaryLanguage, targetLanguage)) {\n    return false;\n  }\n\n  if (!targetLanguage && isSameLang(primaryLanguage, getLocale())) {\n    return false;\n  }\n\n  return true;\n};\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,iBAAiB,CAAC,OAAe;IAC5C,wCAAmC;QACjC,MAAM,UAAU,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAC9D,MAAM,aAAa;YAAE,CAAC,QAAQ,EAAE;QAAM;QACtC,aAAa,OAAO,CAAC,iBAAiB,KAAK,SAAS,CAAC;IACvD;AACF;AAEO,MAAM,gBAAgB,CAAC;IAC5B,wCAAmC;QACjC,MAAM,UAAU,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAC9D,MAAM,QAAQ,aAAa,OAAO,CAAC;QACnC,IAAI,OAAO;YACT,MAAM,aAAa,KAAK,KAAK,CAAC;YAC9B,IAAI,UAAU,CAAC,QAAQ,EAAE;gBACvB,OAAO,UAAU,CAAC,QAAQ;YAC5B;QACF;IACF;IACA,OAAO;AACT;AAEO,MAAM,yBAAyB,CAAC,MAAoB;IACzD,IAAI,CAAC,QAAQ,KAAK,MAAM,KAAK,OAAO;QAClC,OAAO;IACT;IAEA,MAAM,kBAAkB,KAAK,eAAe,IAAI;IAChD,IAAI,CAAC,mBAAmB,gBAAgB,WAAW,OAAO,OAAO;QAC/D,OAAO;IACT;IAEA,IAAI,kBAAkB,IAAA,wJAAU,EAAC,iBAAiB,iBAAiB;QACjE,OAAO;IACT;IAEA,IAAI,CAAC,kBAAkB,IAAA,wJAAU,EAAC,iBAAiB,IAAA,uJAAS,MAAK;QAC/D,OAAO;IACT;IAEA,OAAO;AACT"}},
    {"offset": {"line": 1868, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/deepl.ts"],"sourcesContent":["import { getAPIBaseUrl } from '@/services/environment';\nimport { stubTranslation as _ } from '@/utils/misc';\nimport { ErrorCodes, TranslationProvider } from '../types';\nimport { UserPlan } from '@/types/quota';\nimport { getSubscriptionPlan } from '@/utils/access';\nimport { normalizeToShortLang } from '@/utils/lang';\nimport { DEFAULT_DAILY_TRANSLATION_QUOTA } from '@/services/constants';\nimport { saveDailyUsage } from '../utils';\n\nconst DEEPL_API_ENDPOINT = getAPIBaseUrl() + '/deepl/translate';\n\nexport const deeplProvider: TranslationProvider = {\n  name: 'deepl',\n  label: _('DeepL'),\n  authRequired: true,\n  quotaExceeded: false,\n  translate: async (\n    text: string[],\n    sourceLang: string,\n    targetLang: string,\n    token?: string | null,\n    useCache: boolean = false,\n  ): Promise<string[]> => {\n    const authRequired = deeplProvider.authRequired;\n\n    const headers: Record<string, string> = {\n      'Content-Type': 'application/json',\n    };\n\n    let userPlan: UserPlan = 'free';\n    if (token) {\n      userPlan = getSubscriptionPlan(token);\n      headers['Authorization'] = `Bearer ${token}`;\n    }\n\n    if (authRequired && !token) {\n      throw new Error('Authentication token is required for DeepL translation');\n    }\n\n    const body = JSON.stringify({\n      text: text,\n      source_lang: normalizeToShortLang(sourceLang).toUpperCase(),\n      target_lang: normalizeToShortLang(targetLang).toUpperCase(),\n      use_cache: useCache,\n    });\n\n    const quota = DEFAULT_DAILY_TRANSLATION_QUOTA[userPlan];\n    try {\n      const response = await fetch(DEEPL_API_ENDPOINT, { method: 'POST', headers, body });\n\n      if (!response.ok) {\n        const data = await response.json();\n        if (data && data.error && data.error === ErrorCodes.DAILY_QUOTA_EXCEEDED) {\n          saveDailyUsage(quota);\n          deeplProvider.quotaExceeded = true;\n          throw new Error(ErrorCodes.DAILY_QUOTA_EXCEEDED);\n        }\n        throw new Error(`Translation failed with status ${response.status}`);\n      }\n\n      const data = await response.json();\n      if (!data || !data.translations) {\n        throw new Error('Invalid response from translation service');\n      }\n\n      return text.map((line, i) => {\n        if (!line?.trim().length) {\n          return line;\n        }\n        const translation = data.translations?.[i];\n        if (translation?.daily_usage) {\n          saveDailyUsage(translation.daily_usage);\n          deeplProvider.quotaExceeded = data.daily_usage >= quota;\n        }\n        return translation?.text || line;\n      });\n    } catch (error) {\n      throw error;\n    }\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;;;;;;;;AAEA,MAAM,qBAAqB,IAAA,qKAAa,MAAK;AAEtC,MAAM,gBAAqC;IAChD,MAAM;IACN,OAAO,IAAA,6JAAC,EAAC;IACT,cAAc;IACd,eAAe;IACf,WAAW,OACT,MACA,YACA,YACA,OACA,WAAoB,KAAK;QAEzB,MAAM,eAAe,cAAc,YAAY;QAE/C,MAAM,UAAkC;YACtC,gBAAgB;QAClB;QAEA,IAAI,WAAqB;QACzB,IAAI,OAAO;YACT,WAAW,IAAA,mKAAmB,EAAC;YAC/B,OAAO,CAAC,gBAAgB,GAAG,CAAC,OAAO,EAAE,OAAO;QAC9C;QAEA,IAAI,gBAAgB,CAAC,OAAO;YAC1B,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,OAAO,KAAK,SAAS,CAAC;YAC1B,MAAM;YACN,aAAa,IAAA,kKAAoB,EAAC,YAAY,WAAW;YACzD,aAAa,IAAA,kKAAoB,EAAC,YAAY,WAAW;YACzD,WAAW;QACb;QAEA,MAAM,QAAQ,qLAA+B,CAAC,SAAS;QACvD,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,oBAAoB;gBAAE,QAAQ;gBAAQ;gBAAS;YAAK;YAEjF,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,IAAI,QAAQ,KAAK,KAAK,IAAI,KAAK,KAAK,KAAK,2KAAU,CAAC,oBAAoB,EAAE;oBACxE,IAAA,+KAAc,EAAC;oBACf,cAAc,aAAa,GAAG;oBAC9B,MAAM,IAAI,MAAM,2KAAU,CAAC,oBAAoB;gBACjD;gBACA,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;YACrE;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,IAAI,CAAC,QAAQ,CAAC,KAAK,YAAY,EAAE;gBAC/B,MAAM,IAAI,MAAM;YAClB;YAEA,OAAO,KAAK,GAAG,CAAC,CAAC,MAAM;gBACrB,IAAI,CAAC,MAAM,OAAO,QAAQ;oBACxB,OAAO;gBACT;gBACA,MAAM,cAAc,KAAK,YAAY,EAAE,CAAC,EAAE;gBAC1C,IAAI,aAAa,aAAa;oBAC5B,IAAA,+KAAc,EAAC,YAAY,WAAW;oBACtC,cAAc,aAAa,GAAG,KAAK,WAAW,IAAI;gBACpD;gBACA,OAAO,aAAa,QAAQ;YAC9B;QACF,EAAE,OAAO,OAAO;YACd,MAAM;QACR;IACF;AACF"}},
    {"offset": {"line": 1954, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/azure.ts"],"sourcesContent":["import { stubTranslation as _ } from '@/utils/misc';\nimport { fetch as tauriFetch } from '@tauri-apps/plugin-http';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { TranslationProvider } from '../types';\nimport { normalizeToFullLang } from '@/utils/lang';\n\ninterface TokenCache {\n  token: string;\n  expiresAt: number;\n}\n\nlet tokenCache: TokenCache | null = null;\n\nconst getAuthToken = async (): Promise<string> => {\n  const now = Date.now();\n\n  if (tokenCache && tokenCache.expiresAt > now) {\n    return tokenCache.token;\n  }\n\n  try {\n    const fetch = isTauriAppPlatform() ? tauriFetch : window.fetch;\n    const tokenResponse = await fetch('https://edge.microsoft.com/translate/auth', {\n      method: 'GET',\n      headers: {\n        'User-Agent': 'Mozilla/5.0',\n      },\n    });\n\n    if (!tokenResponse.ok) {\n      throw new Error(`Failed to get auth token: ${tokenResponse.status}`);\n    }\n\n    const token = await tokenResponse.text();\n    const expiresAt = now + 8 * 60 * 1000;\n\n    tokenCache = {\n      token,\n      expiresAt,\n    };\n\n    return token;\n  } catch (error) {\n    console.error('Error getting Microsoft translation auth token:', error);\n    throw error;\n  }\n};\n\nexport const azureProvider: TranslationProvider = {\n  name: 'azure',\n  label: _('Azure Translator'),\n  translate: async (text: string[], sourceLang: string, targetLang: string): Promise<string[]> => {\n    if (!text.length) return [];\n\n    const results: string[] = [];\n    const msSourceLang = sourceLang ? normalizeToFullLang(sourceLang) : '';\n    const msTargetLang = normalizeToFullLang(targetLang);\n\n    const translationPromises = text.map(async (line, index) => {\n      if (!line?.trim().length) {\n        results[index] = line;\n        return;\n      }\n\n      const url = 'https://api-edge.cognitive.microsofttranslator.com/translate';\n      const params = new URLSearchParams({\n        to: msTargetLang,\n        'api-version': '3.0',\n      });\n      if (msSourceLang && msSourceLang.toLowerCase() !== 'auto') {\n        params.append('from', msSourceLang);\n      }\n\n      const token = await getAuthToken();\n      const fetch = isTauriAppPlatform() ? tauriFetch : window.fetch;\n      const response = await fetch(`${url}?${params.toString()}`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify([{ Text: line }]),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Translation failed with status ${response.status}`);\n      }\n\n      const data = await response.json();\n\n      if (Array.isArray(data) && data.length > 0 && data[0].translations) {\n        results[index] = data[0].translations[0].text || line;\n      } else {\n        results[index] = line;\n      }\n    });\n\n    await Promise.all(translationPromises);\n\n    return results;\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAEA;;;;;AAOA,IAAI,aAAgC;AAEpC,MAAM,eAAe;IACnB,MAAM,MAAM,KAAK,GAAG;IAEpB,IAAI,cAAc,WAAW,SAAS,GAAG,KAAK;QAC5C,OAAO,WAAW,KAAK;IACzB;IAEA,IAAI;QACF,MAAM,QAAQ,IAAA,0KAAkB,MAAK,2PAAU,GAAG,OAAO,KAAK;QAC9D,MAAM,gBAAgB,MAAM,MAAM,6CAA6C;YAC7E,QAAQ;YACR,SAAS;gBACP,cAAc;YAChB;QACF;QAEA,IAAI,CAAC,cAAc,EAAE,EAAE;YACrB,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,cAAc,MAAM,EAAE;QACrE;QAEA,MAAM,QAAQ,MAAM,cAAc,IAAI;QACtC,MAAM,YAAY,MAAM,IAAI,KAAK;QAEjC,aAAa;YACX;YACA;QACF;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mDAAmD;QACjE,MAAM;IACR;AACF;AAEO,MAAM,gBAAqC;IAChD,MAAM;IACN,OAAO,IAAA,6JAAC,EAAC;IACT,WAAW,OAAO,MAAgB,YAAoB;QACpD,IAAI,CAAC,KAAK,MAAM,EAAE,OAAO,EAAE;QAE3B,MAAM,UAAoB,EAAE;QAC5B,MAAM,eAAe,aAAa,IAAA,iKAAmB,EAAC,cAAc;QACpE,MAAM,eAAe,IAAA,iKAAmB,EAAC;QAEzC,MAAM,sBAAsB,KAAK,GAAG,CAAC,OAAO,MAAM;YAChD,IAAI,CAAC,MAAM,OAAO,QAAQ;gBACxB,OAAO,CAAC,MAAM,GAAG;gBACjB;YACF;YAEA,MAAM,MAAM;YACZ,MAAM,SAAS,IAAI,gBAAgB;gBACjC,IAAI;gBACJ,eAAe;YACjB;YACA,IAAI,gBAAgB,aAAa,WAAW,OAAO,QAAQ;gBACzD,OAAO,MAAM,CAAC,QAAQ;YACxB;YAEA,MAAM,QAAQ,MAAM;YACpB,MAAM,QAAQ,IAAA,0KAAkB,MAAK,2PAAU,GAAG,OAAO,KAAK;YAC9D,MAAM,WAAW,MAAM,MAAM,GAAG,IAAI,CAAC,EAAE,OAAO,QAAQ,IAAI,EAAE;gBAC1D,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe,CAAC,OAAO,EAAE,OAAO;gBAClC;gBACA,MAAM,KAAK,SAAS,CAAC;oBAAC;wBAAE,MAAM;oBAAK;iBAAE;YACvC;YAEA,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;YACrE;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAEhC,IAAI,MAAM,OAAO,CAAC,SAAS,KAAK,MAAM,GAAG,KAAK,IAAI,CAAC,EAAE,CAAC,YAAY,EAAE;gBAClE,OAAO,CAAC,MAAM,GAAG,IAAI,CAAC,EAAE,CAAC,YAAY,CAAC,EAAE,CAAC,IAAI,IAAI;YACnD,OAAO;gBACL,OAAO,CAAC,MAAM,GAAG;YACnB;QACF;QAEA,MAAM,QAAQ,GAAG,CAAC;QAElB,OAAO;IACT;AACF"}},
    {"offset": {"line": 2051, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/google.ts"],"sourcesContent":["import { stubTranslation as _ } from '@/utils/misc';\nimport { fetch as tauriFetch } from '@tauri-apps/plugin-http';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { normalizeToShortLang } from '@/utils/lang';\nimport { TranslationProvider } from '../types';\n\nexport const googleProvider: TranslationProvider = {\n  name: 'google',\n  label: _('Google Translate'),\n  translate: async (text: string[], sourceLang: string, targetLang: string): Promise<string[]> => {\n    if (!text.length) return [];\n\n    const results: string[] = [];\n\n    const translationPromises = text.map(async (line, index) => {\n      if (!line?.trim().length) {\n        results[index] = line;\n        return;\n      }\n\n      const url = new URL('https://translate.googleapis.com/translate_a/single');\n      url.searchParams.append('client', 'gtx');\n      url.searchParams.append('dt', 't');\n      url.searchParams.append('sl', normalizeToShortLang(sourceLang).toLowerCase() || 'auto');\n      url.searchParams.append('tl', normalizeToShortLang(targetLang).toLowerCase());\n      url.searchParams.append('q', line);\n\n      const fetch = isTauriAppPlatform() ? tauriFetch : window.fetch;\n      const response = await fetch(url.toString());\n\n      if (!response.ok) {\n        throw new Error(`Translation failed with status ${response.status}`);\n      }\n\n      const data = await response.json();\n      if (Array.isArray(data) && Array.isArray(data[0])) {\n        const translatedText = data[0]\n          .filter((segment) => Array.isArray(segment) && segment[0])\n          .map((segment) => segment[0])\n          .join('');\n\n        results[index] = translatedText || line;\n      } else {\n        results[index] = line;\n      }\n    });\n\n    await Promise.all(translationPromises);\n\n    return results;\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAGO,MAAM,iBAAsC;IACjD,MAAM;IACN,OAAO,IAAA,6JAAC,EAAC;IACT,WAAW,OAAO,MAAgB,YAAoB;QACpD,IAAI,CAAC,KAAK,MAAM,EAAE,OAAO,EAAE;QAE3B,MAAM,UAAoB,EAAE;QAE5B,MAAM,sBAAsB,KAAK,GAAG,CAAC,OAAO,MAAM;YAChD,IAAI,CAAC,MAAM,OAAO,QAAQ;gBACxB,OAAO,CAAC,MAAM,GAAG;gBACjB;YACF;YAEA,MAAM,MAAM,IAAI,IAAI;YACpB,IAAI,YAAY,CAAC,MAAM,CAAC,UAAU;YAClC,IAAI,YAAY,CAAC,MAAM,CAAC,MAAM;YAC9B,IAAI,YAAY,CAAC,MAAM,CAAC,MAAM,IAAA,kKAAoB,EAAC,YAAY,WAAW,MAAM;YAChF,IAAI,YAAY,CAAC,MAAM,CAAC,MAAM,IAAA,kKAAoB,EAAC,YAAY,WAAW;YAC1E,IAAI,YAAY,CAAC,MAAM,CAAC,KAAK;YAE7B,MAAM,QAAQ,IAAA,0KAAkB,MAAK,2PAAU,GAAG,OAAO,KAAK;YAC9D,MAAM,WAAW,MAAM,MAAM,IAAI,QAAQ;YAEzC,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;YACrE;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,IAAI,MAAM,OAAO,CAAC,SAAS,MAAM,OAAO,CAAC,IAAI,CAAC,EAAE,GAAG;gBACjD,MAAM,iBAAiB,IAAI,CAAC,EAAE,CAC3B,MAAM,CAAC,CAAC,UAAY,MAAM,OAAO,CAAC,YAAY,OAAO,CAAC,EAAE,EACxD,GAAG,CAAC,CAAC,UAAY,OAAO,CAAC,EAAE,EAC3B,IAAI,CAAC;gBAER,OAAO,CAAC,MAAM,GAAG,kBAAkB;YACrC,OAAO;gBACL,OAAO,CAAC,MAAM,GAAG;YACnB;QACF;QAEA,MAAM,QAAQ,GAAG,CAAC;QAElB,OAAO;IACT;AACF"}},
    {"offset": {"line": 2104, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/yandex.ts"],"sourcesContent":["import { stubTranslation as _ } from '@/utils/misc';\nimport { fetch as tauriFetch } from '@tauri-apps/plugin-http';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { normalizeToShortLang } from '@/utils/lang';\nimport { TranslationProvider } from '../types';\n\n/**\n * Based on https://translate.toil.cc/v2/docs API specification\n */\nasync function translateSingleTextForService(\n  text: string,\n  lang: string,\n  service: string,\n): Promise<string[]> {\n  const fetchImpl = isTauriAppPlatform() ? tauriFetch : window.fetch;\n  const url = 'https://translate.toil.cc/v2/translate/';\n\n  const request = {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      lang: lang,\n      service: service,\n      text: text,\n    })\n  };\n\n  const response = await fetchImpl(url, request);\n\n  if (!response.ok) {\n    const response_json = JSON.stringify(await response.json());\n    throw new Error(`${service} failed with status ${response.status}\\n${text.length}\\n${JSON.stringify(request)}\\n${response_json}`);\n  }\n\n  const data = await response.json();\n  if (\n    data &&\n    Array.isArray(data.translations)\n  ) {\n    return data.translations;\n  } else {\n    // fallback: return original texts if translation failed\n    return [text];\n  }\n};\n\nexport const yandexProvider: TranslationProvider = {\n  name: 'yandex',\n  label: _('Yandex Translate'),\n  authRequired: false,\n  translate: async (texts: string[], sourceLang: string, targetLang: string): Promise<string[]> => {\n    if (!texts.length) return [];\n\n    /**\n      Possible options:\n      - yandexcloud: often returns 500: {\"error\":\"The text couldn't be translated, because Forbidden\"}\n      - yandexgpt: often better than others\n      - yandextranslate\n      - yandexbrowser\n    */\n    const service = \"yandexgpt\";\n\n    // Yandex does not accept \"auto\" language\n    const source_lang = sourceLang == \"AUTO\" ? \"en\" : normalizeToShortLang(sourceLang).toLowerCase();\n    const target_lang = normalizeToShortLang(targetLang).toLowerCase();\n    const lang = `${source_lang}-${target_lang}`;\n\n    const responses = await Promise.all(texts.map(async text => {\n      return await translateSingleTextForService(text, lang, service)\n    }));\n\n    const translatedTexts = responses.flat();\n    return translatedTexts;\n  }\n};\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAGA;;CAEC,GACD,eAAe,8BACb,IAAY,EACZ,IAAY,EACZ,OAAe;IAEf,MAAM,YAAY,IAAA,0KAAkB,MAAK,2PAAU,GAAG,OAAO,KAAK;IAClE,MAAM,MAAM;IAEZ,MAAM,UAAU;QACd,QAAQ;QACR,SAAS;YACP,gBAAgB;QAClB;QACA,MAAM,KAAK,SAAS,CAAC;YACnB,MAAM;YACN,SAAS;YACT,MAAM;QACR;IACF;IAEA,MAAM,WAAW,MAAM,UAAU,KAAK;IAEtC,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,gBAAgB,KAAK,SAAS,CAAC,MAAM,SAAS,IAAI;QACxD,MAAM,IAAI,MAAM,GAAG,QAAQ,oBAAoB,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,KAAK,MAAM,CAAC,EAAE,EAAE,KAAK,SAAS,CAAC,SAAS,EAAE,EAAE,eAAe;IAClI;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAChC,IACE,QACA,MAAM,OAAO,CAAC,KAAK,YAAY,GAC/B;QACA,OAAO,KAAK,YAAY;IAC1B,OAAO;QACL,wDAAwD;QACxD,OAAO;YAAC;SAAK;IACf;AACF;AAEO,MAAM,iBAAsC;IACjD,MAAM;IACN,OAAO,IAAA,6JAAC,EAAC;IACT,cAAc;IACd,WAAW,OAAO,OAAiB,YAAoB;QACrD,IAAI,CAAC,MAAM,MAAM,EAAE,OAAO,EAAE;QAE5B;;;;;;IAMA,GACA,MAAM,UAAU;QAEhB,yCAAyC;QACzC,MAAM,cAAc,cAAc,SAAS,OAAO,IAAA,kKAAoB,EAAC,YAAY,WAAW;QAC9F,MAAM,cAAc,IAAA,kKAAoB,EAAC,YAAY,WAAW;QAChE,MAAM,OAAO,GAAG,YAAY,CAAC,EAAE,aAAa;QAE5C,MAAM,YAAY,MAAM,QAAQ,GAAG,CAAC,MAAM,GAAG,CAAC,OAAM;YAClD,OAAO,MAAM,8BAA8B,MAAM,MAAM;QACzD;QAEA,MAAM,kBAAkB,UAAU,IAAI;QACtC,OAAO;IACT;AACF"}},
    {"offset": {"line": 2178, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/providers/index.ts"],"sourcesContent":["import { TranslationProvider } from '../types';\nimport { deeplProvider } from './deepl';\nimport { azureProvider } from './azure';\nimport { googleProvider } from './google';\nimport { yandexProvider } from './yandex';\n\nfunction createTranslator<T extends string>(\n  name: T,\n  implementation: TranslationProvider,\n): TranslationProvider & { name: T } {\n  if (name !== implementation.name) {\n    throw Error(\n      `Translator name \"${name}\" does not match implementation name \"${implementation.name}\"`,\n    );\n  }\n  return implementation as TranslationProvider & { name: T };\n}\n\nconst deeplTranslator = createTranslator('deepl', deeplProvider);\nconst azureTranslator = createTranslator('azure', azureProvider);\nconst googleTranslator = createTranslator('google', googleProvider);\nconst yandexTranslator = createTranslator('yandex', yandexProvider);\n\nconst availableTranslators = [\n  deeplTranslator,\n  azureTranslator,\n  googleTranslator,\n  yandexTranslator,\n  // Add more translators here\n];\n\nexport type TranslatorName = (typeof availableTranslators)[number]['name'];\n\nexport const getTranslator = (name: TranslatorName): TranslationProvider | undefined => {\n  return availableTranslators.find((translator) => translator.name === name);\n};\n\nexport const getTranslators = (): TranslationProvider[] => {\n  return availableTranslators;\n};\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;AACA;;;;;AAEA,SAAS,iBACP,IAAO,EACP,cAAmC;IAEnC,IAAI,SAAS,eAAe,IAAI,EAAE;QAChC,MAAM,MACJ,CAAC,iBAAiB,EAAE,KAAK,sCAAsC,EAAE,eAAe,IAAI,CAAC,CAAC,CAAC;IAE3F;IACA,OAAO;AACT;AAEA,MAAM,kBAAkB,iBAAiB,SAAS,2LAAa;AAC/D,MAAM,kBAAkB,iBAAiB,SAAS,2LAAa;AAC/D,MAAM,mBAAmB,iBAAiB,UAAU,6LAAc;AAClE,MAAM,mBAAmB,iBAAiB,UAAU,6LAAc;AAElE,MAAM,uBAAuB;IAC3B;IACA;IACA;IACA;CAED;AAIM,MAAM,gBAAgB,CAAC;IAC5B,OAAO,qBAAqB,IAAI,CAAC,CAAC,aAAe,WAAW,IAAI,KAAK;AACvE;AAEO,MAAM,iBAAiB;IAC5B,OAAO;AACT"}},
    {"offset": {"line": 2221, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/translators/index.ts"],"sourcesContent":["export * from './types';\nexport * from './cache';\nexport * from './polish';\nexport * from './preprocess';\nexport * from './providers';\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 2239, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/sync/KOSyncClient.ts"],"sourcesContent":["import { md5 } from 'js-md5';\nimport { Book } from '@/types/book';\nimport { KOSyncSettings } from '@/types/settings';\nimport { fetch as tauriFetch } from '@tauri-apps/plugin-http';\nimport { KoSyncProxyPayload } from '@/types/kosync';\nimport { isLanAddress } from '@/utils/network';\nimport { getAPIBaseUrl, isTauriAppPlatform } from '../environment';\n\n/**\n * Interface for KOSync progress response from the server\n */\nexport interface KoSyncProgress {\n  document?: string;\n  progress?: string;\n  percentage?: number;\n  timestamp?: number;\n  device?: string;\n  device_id?: string;\n}\n\nexport class KOSyncClient {\n  private config: KOSyncSettings;\n  private isLanServer: boolean;\n\n  constructor(config: KOSyncSettings) {\n    this.config = config;\n    this.config.serverUrl = config.serverUrl.replace(/\\/$/, '');\n    this.isLanServer = isLanAddress(this.config.serverUrl);\n  }\n\n  private async request(\n    endpoint: string,\n    options: {\n      method?: 'GET' | 'POST' | 'PUT';\n      body?: BodyInit | null;\n      headers?: HeadersInit;\n      useAuth?: boolean;\n    } = {},\n  ): Promise<Response> {\n    const { method = 'GET', body, headers: additionalHeaders, useAuth = true } = options;\n\n    const headers = new Headers(additionalHeaders || {});\n    if (useAuth) {\n      headers.set('X-Auth-User', this.config.username);\n      headers.set('X-Auth-Key', this.config.userkey);\n    }\n\n    if (this.isLanServer || isTauriAppPlatform()) {\n      const fetch = isTauriAppPlatform() ? tauriFetch : window.fetch;\n      const directUrl = `${this.config.serverUrl}${endpoint}`;\n\n      return fetch(directUrl, {\n        method,\n        headers: {\n          accept: 'application/vnd.koreader.v1+json',\n          ...(method === 'GET' ? {} : { 'Content-Type': 'application/json' }),\n          ...Object.fromEntries(headers.entries()),\n        },\n        body,\n        danger: {\n          acceptInvalidCerts: true,\n          acceptInvalidHostnames: true,\n        },\n      });\n    }\n\n    const proxyUrl = `${getAPIBaseUrl()}/kosync`;\n\n    const proxyBody: KoSyncProxyPayload = {\n      serverUrl: this.config.serverUrl,\n      endpoint,\n      method,\n      headers: Object.fromEntries(headers.entries()),\n      body: body ? JSON.parse(body as string) : undefined,\n    };\n\n    return fetch(proxyUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(proxyBody),\n    });\n  }\n\n  /**\n   * Connects to the KOSync server with authentication\n   * @param username - The username for authentication\n   * @param password - The password for authentication\n   * @returns Promise with success status and optional message\n   */\n  async connect(\n    username: string,\n    password: string,\n  ): Promise<{ success: boolean; message?: string }> {\n    const userkey = md5(password);\n\n    try {\n      const authResponse = await this.request('/users/auth', {\n        method: 'GET',\n        headers: {\n          'X-Auth-User': username,\n          'X-Auth-Key': userkey,\n        },\n      });\n\n      if (authResponse.ok) {\n        return { success: true, message: 'Login successful.' };\n      }\n\n      if (authResponse.status === 401) {\n        const registerResponse = await this.request('/users/create', {\n          method: 'POST',\n          useAuth: false,\n          body: JSON.stringify({ username, password: userkey }),\n        });\n\n        if (registerResponse.ok) {\n          return { success: true, message: 'Registration successful.' };\n        }\n\n        const regError = await registerResponse.json().catch(() => ({}));\n        if (registerResponse.status === 402) {\n          return { success: false, message: 'Invalid credentials.' };\n        }\n        return { success: false, message: regError.message || 'Registration failed.' };\n      }\n\n      const errorBody = await authResponse.json().catch(() => ({}));\n      return {\n        success: false,\n        message: errorBody.message || `Authorization failed with status: ${authResponse.status}`,\n      };\n    } catch (e) {\n      console.error('KOSync connection failed', e);\n      return { success: false, message: (e as Error).message || 'Connection error.' };\n    }\n  }\n\n  /**\n   * Retrieves the reading progress for a specific book from the server\n   * @param book - The book to get progress for\n   * @returns Promise with the progress data or null if not found\n   */\n  async getProgress(book: Book): Promise<KoSyncProgress | null> {\n    if (!this.config.userkey) return null;\n\n    const documentHash = this.getDocumentDigest(book);\n    if (!documentHash) return null;\n\n    try {\n      const response = await this.request(`/syncs/progress/${documentHash}`);\n\n      if (!response.ok) {\n        console.error(\n          `KOSync: Failed to get progress for ${book.title}. Status: ${response.status}`,\n        );\n        return null;\n      }\n\n      const data = await response.json();\n      return data.document ? data : null;\n    } catch (e) {\n      console.error('KOSync getProgress failed', e);\n      return null;\n    }\n  }\n\n  /**\n   * Updates the reading progress for a specific book on the server\n   * @param book - The book to update progress for\n   * @param progress - The current reading progress position\n   * @param percentage - The reading completion percentage\n   * @returns Promise with boolean indicating success\n   */\n  async updateProgress(book: Book, progress: string, percentage: number): Promise<boolean> {\n    if (!this.config.userkey) return false;\n\n    const documentHash = this.getDocumentDigest(book);\n    if (!documentHash) return false;\n\n    const payload = {\n      document: documentHash,\n      progress,\n      percentage,\n      device: this.config.deviceName,\n      device_id: this.config.deviceId,\n    };\n\n    try {\n      const response = await this.request('/syncs/progress', {\n        method: 'PUT',\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        console.error(\n          `KOSync: Failed to update progress for ${book.title}. Status: ${response.status}`,\n        );\n        return false;\n      }\n      return true;\n    } catch (e) {\n      console.error('KOSync updateProgress failed', e);\n      return false;\n    }\n  }\n\n  getDocumentDigest(book: Book): string {\n    if (this.config.checksumMethod === 'filename') {\n      console.warn('This is not possible anymore, using md5 instead.');\n    }\n    return book.hash;\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2429, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/footnote.ts"],"sourcesContent":["import type { Transformer } from './types';\n\nexport const footnoteTransformer: Transformer = {\n  name: 'footnote',\n\n  transform: async (ctx) => {\n    let result = ctx.content;\n    result = result.replace(\n      /<aside\\s+epub:type\\s*=\\s*[\"'](footnote|endnote|note|rearnote)[\"']([^>]*)>/gi,\n      '<aside class=\"epubtype-footnote\" epub:type=\"$1\"$2>',\n    );\n    return result;\n  },\n};\n"],"names":[],"mappings":";;;;AAEO,MAAM,sBAAmC;IAC9C,MAAM;IAEN,WAAW,OAAO;QAChB,IAAI,SAAS,IAAI,OAAO;QACxB,SAAS,OAAO,OAAO,CACrB,+EACA;QAEF,OAAO;IACT;AACF"}},
    {"offset": {"line": 2448, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/language.ts"],"sourcesContent":["import { detectLanguage, getLanguageInfo, isSameLang, isValidLang } from '@/utils/lang';\nimport type { Transformer } from './types';\n\nexport const languageTransformer: Transformer = {\n  name: 'language',\n\n  transform: async (ctx) => {\n    const primaryLanguage = ctx.primaryLanguage;\n    let result = ctx.content;\n    const attrsMatch = result.match(/<html\\b([^>]*)>/i);\n    if (attrsMatch) {\n      let attrs = attrsMatch[1] || '';\n      const langRegex = / lang=\"([^\"]*)\"/i;\n      const xmlLangRegex = / xml:lang=\"([^\"]*)\"/i;\n      const xmlLangMatch = attrs.match(xmlLangRegex);\n      const langMatch = attrs.match(langRegex);\n      const docLang = langMatch?.[1] || xmlLangMatch?.[1];\n      if (!isValidLang(docLang) || !isSameLang(docLang, primaryLanguage)) {\n        const mainContent = result.replace(/<[^>]+>/g, ' ');\n        const lang =\n          isValidLang(primaryLanguage) && primaryLanguage !== 'en'\n            ? primaryLanguage\n            : detectLanguage(mainContent);\n        const languageInfo = getLanguageInfo(lang || '');\n        const newLangAttr = ` lang=\"${lang}\"`;\n        const newXmlLangAttr = ` xml:lang=\"${lang}\"`;\n        const dirAttr = languageInfo?.direction === 'rtl' ? ' dir=\"rtl\"' : '';\n        attrs = langMatch ? attrs.replace(langRegex, newLangAttr) : attrs + newLangAttr + dirAttr;\n        attrs = xmlLangMatch\n          ? attrs.replace(xmlLangRegex, newXmlLangAttr)\n          : attrs + newXmlLangAttr + dirAttr;\n        result = result.replace(attrsMatch[0], `<html${attrs}>`);\n      }\n    } else {\n      const lang =\n        isValidLang(primaryLanguage) && primaryLanguage !== 'en'\n          ? primaryLanguage\n          : detectLanguage(result.replace(/<[^>]+>/g, ' '));\n      const languageInfo = getLanguageInfo(lang || '');\n      const dirAttr = languageInfo?.direction === 'rtl' ? ' dir=\"rtl\"' : '';\n      const newAttrs = ` lang=\"${lang}\" xml:lang=\"${lang}\" ${dirAttr}`;\n      result = result.replace(/<html>/i, `<html${newAttrs}>`);\n    }\n    return result;\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,sBAAmC;IAC9C,MAAM;IAEN,WAAW,OAAO;QAChB,MAAM,kBAAkB,IAAI,eAAe;QAC3C,IAAI,SAAS,IAAI,OAAO;QACxB,MAAM,aAAa,OAAO,KAAK,CAAC;QAChC,IAAI,YAAY;YACd,IAAI,QAAQ,UAAU,CAAC,EAAE,IAAI;YAC7B,MAAM,YAAY;YAClB,MAAM,eAAe;YACrB,MAAM,eAAe,MAAM,KAAK,CAAC;YACjC,MAAM,YAAY,MAAM,KAAK,CAAC;YAC9B,MAAM,UAAU,WAAW,CAAC,EAAE,IAAI,cAAc,CAAC,EAAE;YACnD,IAAI,CAAC,IAAA,yJAAW,EAAC,YAAY,CAAC,IAAA,wJAAU,EAAC,SAAS,kBAAkB;gBAClE,MAAM,cAAc,OAAO,OAAO,CAAC,YAAY;gBAC/C,MAAM,OACJ,IAAA,yJAAW,EAAC,oBAAoB,oBAAoB,OAChD,kBACA,IAAA,4JAAc,EAAC;gBACrB,MAAM,eAAe,IAAA,6JAAe,EAAC,QAAQ;gBAC7C,MAAM,cAAc,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;gBACrC,MAAM,iBAAiB,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;gBAC5C,MAAM,UAAU,cAAc,cAAc,QAAQ,eAAe;gBACnE,QAAQ,YAAY,MAAM,OAAO,CAAC,WAAW,eAAe,QAAQ,cAAc;gBAClF,QAAQ,eACJ,MAAM,OAAO,CAAC,cAAc,kBAC5B,QAAQ,iBAAiB;gBAC7B,SAAS,OAAO,OAAO,CAAC,UAAU,CAAC,EAAE,EAAE,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;YACzD;QACF,OAAO;YACL,MAAM,OACJ,IAAA,yJAAW,EAAC,oBAAoB,oBAAoB,OAChD,kBACA,IAAA,4JAAc,EAAC,OAAO,OAAO,CAAC,YAAY;YAChD,MAAM,eAAe,IAAA,6JAAe,EAAC,QAAQ;YAC7C,MAAM,UAAU,cAAc,cAAc,QAAQ,eAAe;YACnE,MAAM,WAAW,CAAC,OAAO,EAAE,KAAK,YAAY,EAAE,KAAK,EAAE,EAAE,SAAS;YAChE,SAAS,OAAO,OAAO,CAAC,WAAW,CAAC,KAAK,EAAE,SAAS,CAAC,CAAC;QACxD;QACA,OAAO;IACT;AACF"}},
    {"offset": {"line": 2495, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/punctuation.ts"],"sourcesContent":["import type { Transformer } from './types';\n\nconst verticalQuotationsMapHans: Record<string, string> = {\n  '“': '﹃',\n  '”': '﹄',\n  '‘': '﹁',\n  '’': '﹂',\n  '「': '﹁',\n  '」': '﹂',\n  '『': '﹃',\n  '』': '﹄',\n};\n\nconst verticalQuotationsMapHant: Record<string, string> = {\n  '“': '﹁',\n  '”': '﹂',\n  '‘': '﹃',\n  '’': '﹄',\n  '「': '﹁',\n  '」': '﹂',\n  '『': '﹃',\n  '』': '﹄',\n};\n\nconst quotationsMapHans2Hant = {\n  '“': '「',\n  '”': '」',\n  '‘': '『',\n  '’': '』',\n  '﹃': '﹁',\n  '﹄': '﹂',\n  '﹁': '﹃',\n  '﹂': '﹄',\n};\n\nexport const punctuationTransformer: Transformer = {\n  name: 'punctuation',\n\n  transform: async (ctx) => {\n    if (!ctx.viewSettings.replaceQuotationMarks) return ctx.content;\n\n    let result = ctx.content;\n\n    const convertChineseVariant = ctx.viewSettings.convertChineseVariant;\n    const reversePunctuationTransform = ctx.reversePunctuationTransform || false;\n    const shouldConvertChineseVariants = convertChineseVariant && convertChineseVariant !== 'none';\n    if (shouldConvertChineseVariants) {\n      for (const [s, t] of Object.entries(quotationsMapHans2Hant)) {\n        const shouldReverse = reversePunctuationTransform !== convertChineseVariant.includes('2s');\n        const [from, to] = shouldReverse ? [t, s] : [s, t];\n        result = result.replace(new RegExp(from, 'g'), to);\n      }\n    }\n\n    const shouldTransformVertical = ctx.viewSettings.vertical;\n    if (shouldTransformVertical) {\n      const traditionalChineseLocales = ['zh-Hant', 'zh-TW', 'zh_TW'];\n      let punctuationMap: Record<string, string> = verticalQuotationsMapHans;\n      if (\n        traditionalChineseLocales.includes(ctx.primaryLanguage || '') ||\n        traditionalChineseLocales.includes(ctx.userLocale)\n      ) {\n        punctuationMap = verticalQuotationsMapHant;\n      }\n      for (const [original, vertical] of Object.entries(punctuationMap)) {\n        if (ctx.reversePunctuationTransform) {\n          result = result.replace(new RegExp(vertical, 'g'), original);\n        } else {\n          result = result.replace(new RegExp(original, 'g'), vertical);\n        }\n      }\n    }\n\n    return result;\n  },\n};\n"],"names":[],"mappings":";;;;AAEA,MAAM,4BAAoD;IACxD,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;AACP;AAEA,MAAM,4BAAoD;IACxD,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;AACP;AAEA,MAAM,yBAAyB;IAC7B,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;IACL,KAAK;AACP;AAEO,MAAM,yBAAsC;IACjD,MAAM;IAEN,WAAW,OAAO;QAChB,IAAI,CAAC,IAAI,YAAY,CAAC,qBAAqB,EAAE,OAAO,IAAI,OAAO;QAE/D,IAAI,SAAS,IAAI,OAAO;QAExB,MAAM,wBAAwB,IAAI,YAAY,CAAC,qBAAqB;QACpE,MAAM,8BAA8B,IAAI,2BAA2B,IAAI;QACvE,MAAM,+BAA+B,yBAAyB,0BAA0B;QACxF,IAAI,8BAA8B;YAChC,KAAK,MAAM,CAAC,GAAG,EAAE,IAAI,OAAO,OAAO,CAAC,wBAAyB;gBAC3D,MAAM,gBAAgB,gCAAgC,sBAAsB,QAAQ,CAAC;gBACrF,MAAM,CAAC,MAAM,GAAG,GAAG,gBAAgB;oBAAC;oBAAG;iBAAE,GAAG;oBAAC;oBAAG;iBAAE;gBAClD,SAAS,OAAO,OAAO,CAAC,IAAI,OAAO,MAAM,MAAM;YACjD;QACF;QAEA,MAAM,0BAA0B,IAAI,YAAY,CAAC,QAAQ;QACzD,IAAI,yBAAyB;YAC3B,MAAM,4BAA4B;gBAAC;gBAAW;gBAAS;aAAQ;YAC/D,IAAI,iBAAyC;YAC7C,IACE,0BAA0B,QAAQ,CAAC,IAAI,eAAe,IAAI,OAC1D,0BAA0B,QAAQ,CAAC,IAAI,UAAU,GACjD;gBACA,iBAAiB;YACnB;YACA,KAAK,MAAM,CAAC,UAAU,SAAS,IAAI,OAAO,OAAO,CAAC,gBAAiB;gBACjE,IAAI,IAAI,2BAA2B,EAAE;oBACnC,SAAS,OAAO,OAAO,CAAC,IAAI,OAAO,UAAU,MAAM;gBACrD,OAAO;oBACL,SAAS,OAAO,OAAO,CAAC,IAAI,OAAO,UAAU,MAAM;gBACrD;YACF;QACF;QAEA,OAAO;IACT;AACF"}},
    {"offset": {"line": 2579, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/whitespace.ts"],"sourcesContent":["import type { Transformer } from './types';\n\nexport const whitespaceTransformer: Transformer = {\n  name: 'whitespace',\n\n  transform: async (ctx) => {\n    const viewSettings = ctx.viewSettings;\n    if (viewSettings.overrideLayout) {\n      const cleaned = ctx.content\n        // Replace &nbsp; but skip literal \"&amp;nbsp;\"\n        .replace(/(&amp;)?&nbsp;/g, (match, amp) => (amp ? match : ' '))\n        // Replace literal non-breaking space characters (U+00A0) with normal spaces\n        .replace(/\\u00A0/g, ' ')\n        // Collapse consecutive spaces into one\n        .replace(/ {2,}/g, ' ');\n      return cleaned;\n    } else {\n      return ctx.content;\n    }\n  },\n};\n"],"names":[],"mappings":";;;;AAEO,MAAM,wBAAqC;IAChD,MAAM;IAEN,WAAW,OAAO;QAChB,MAAM,eAAe,IAAI,YAAY;QACrC,IAAI,aAAa,cAAc,EAAE;YAC/B,MAAM,UAAU,IAAI,OAAO,AACzB,+CAA+C;aAC9C,OAAO,CAAC,mBAAmB,CAAC,OAAO,MAAS,MAAM,QAAQ,IAC3D,4EAA4E;aAC3E,OAAO,CAAC,WAAW,IACpB,uCAAuC;aACtC,OAAO,CAAC,UAAU;YACrB,OAAO;QACT,OAAO;YACL,OAAO,IAAI,OAAO;QACpB;IACF;AACF"}},
    {"offset": {"line": 2605, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/sanitizer.ts"],"sourcesContent":["import DOMPurify from 'dompurify';\nimport type { Transformer } from './types';\n\nexport const sanitizerTransformer: Transformer = {\n  name: 'sanitizer',\n\n  transform: async (ctx) => {\n    const allowScript = ctx.viewSettings.allowScript;\n    if (allowScript) return ctx.content;\n\n    const result = ctx.content.replaceAll('&nbsp;', '&#160;');\n\n    const sanitized = DOMPurify.sanitize(result, {\n      WHOLE_DOCUMENT: true,\n      FORBID_TAGS: ['script'],\n      ALLOWED_URI_REGEXP:\n        /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|blob|data):|[^a-z]|[a-z+.\\-]+(?:[^a-z+.\\-:]|$))/i,\n      ADD_TAGS: ['link', 'meta'],\n      ADD_ATTR: (attributeName: string) => {\n        const attrWhitelist = [\n          'xmlns',\n          'http-equiv',\n          'content',\n          'charset',\n          'link',\n          'vlink',\n          'imt-state', // custom attribute generated by some translators\n          'data-wr-footernote', // custom attribute for weread footnotes\n          'zy-footnote', // custom attribute for zhangyue footnotes\n        ];\n        return (\n          attrWhitelist.includes(attributeName) ||\n          attributeName.startsWith('xml:') ||\n          attributeName.startsWith('xmlns:') ||\n          attributeName.startsWith('epub:')\n        );\n      },\n      RETURN_DOM: true,\n    });\n\n    const serializer = new XMLSerializer();\n    let serialized = serializer.serializeToString(sanitized);\n    serialized = serialized.replaceAll('&#160;', '&nbsp;').replaceAll('\\u00A0', '&nbsp;');\n    serialized = '<?xml version=\"1.0\" encoding=\"utf-8\"?>' + serialized;\n    serialized = serialized.replace(/(<head[^>]*>)/i, '\\n$1');\n    serialized = serialized.replace(/(<\\/body>)(<\\/html>)/i, '$1\\n$2');\n\n    // console.log(`Sanitizer diff:\\n${diff(result, serialized)}`);\n\n    return serialized;\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,uBAAoC;IAC/C,MAAM;IAEN,WAAW,OAAO;QAChB,MAAM,cAAc,IAAI,YAAY,CAAC,WAAW;QAChD,IAAI,aAAa,OAAO,IAAI,OAAO;QAEnC,MAAM,SAAS,IAAI,OAAO,CAAC,UAAU,CAAC,UAAU;QAEhD,MAAM,YAAY,+MAAS,CAAC,QAAQ,CAAC,QAAQ;YAC3C,gBAAgB;YAChB,aAAa;gBAAC;aAAS;YACvB,oBACE;YACF,UAAU;gBAAC;gBAAQ;aAAO;YAC1B,UAAU,CAAC;gBACT,MAAM,gBAAgB;oBACpB;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;oBACA;iBACD;gBACD,OACE,cAAc,QAAQ,CAAC,kBACvB,cAAc,UAAU,CAAC,WACzB,cAAc,UAAU,CAAC,aACzB,cAAc,UAAU,CAAC;YAE7B;YACA,YAAY;QACd;QAEA,MAAM,aAAa,IAAI;QACvB,IAAI,aAAa,WAAW,iBAAiB,CAAC;QAC9C,aAAa,WAAW,UAAU,CAAC,UAAU,UAAU,UAAU,CAAC,UAAU;QAC5E,aAAa,2CAA2C;QACxD,aAAa,WAAW,OAAO,CAAC,kBAAkB;QAClD,aAAa,WAAW,OAAO,CAAC,yBAAyB;QAEzD,+DAA+D;QAE/D,OAAO;IACT;AACF"}},
    {"offset": {"line": 2660, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/simplecc.ts"],"sourcesContent":["import type { Transformer } from './types';\nimport { initSimpleCC, runSimpleCC } from '@/utils/simplecc';\n\nexport const simpleccTransformer: Transformer = {\n  name: 'simplecc',\n\n  transform: async (ctx) => {\n    const convertChineseVariant = ctx.viewSettings.convertChineseVariant;\n    if (!convertChineseVariant || convertChineseVariant === 'none') {\n      return ctx.content;\n    }\n\n    await initSimpleCC();\n    const parser = new DOMParser();\n    const doc = parser.parseFromString(ctx.content, 'text/html');\n\n    const walker = document.createTreeWalker(\n      doc.body || doc.documentElement,\n      NodeFilter.SHOW_TEXT,\n      {\n        acceptNode: (node) => {\n          const parent = node.parentElement;\n          if (parent && (parent.tagName === 'SCRIPT' || parent.tagName === 'STYLE')) {\n            return NodeFilter.FILTER_REJECT;\n          }\n          return node.textContent?.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;\n        },\n      },\n    );\n\n    const textNodes: Text[] = [];\n    let currentNode: Node | null;\n    while ((currentNode = walker.nextNode())) {\n      textNodes.push(currentNode as Text);\n    }\n\n    for (const textNode of textNodes) {\n      if (textNode.textContent) {\n        textNode.textContent = runSimpleCC(textNode.textContent, convertChineseVariant);\n      }\n    }\n\n    const serializer = new XMLSerializer();\n    return serializer.serializeToString(doc);\n  },\n};\n"],"names":[],"mappings":";;;;AACA;;AAEO,MAAM,sBAAmC;IAC9C,MAAM;IAEN,WAAW,OAAO;QAChB,MAAM,wBAAwB,IAAI,YAAY,CAAC,qBAAqB;QACpE,IAAI,CAAC,yBAAyB,0BAA0B,QAAQ;YAC9D,OAAO,IAAI,OAAO;QACpB;QAEA,MAAM,IAAA,8JAAY;QAClB,MAAM,SAAS,IAAI;QACnB,MAAM,MAAM,OAAO,eAAe,CAAC,IAAI,OAAO,EAAE;QAEhD,MAAM,SAAS,SAAS,gBAAgB,CACtC,IAAI,IAAI,IAAI,IAAI,eAAe,EAC/B,WAAW,SAAS,EACpB;YACE,YAAY,CAAC;gBACX,MAAM,SAAS,KAAK,aAAa;gBACjC,IAAI,UAAU,CAAC,OAAO,OAAO,KAAK,YAAY,OAAO,OAAO,KAAK,OAAO,GAAG;oBACzE,OAAO,WAAW,aAAa;gBACjC;gBACA,OAAO,KAAK,WAAW,EAAE,SAAS,WAAW,aAAa,GAAG,WAAW,aAAa;YACvF;QACF;QAGF,MAAM,YAAoB,EAAE;QAC5B,IAAI;QACJ,MAAQ,cAAc,OAAO,QAAQ,GAAK;YACxC,UAAU,IAAI,CAAC;QACjB;QAEA,KAAK,MAAM,YAAY,UAAW;YAChC,IAAI,SAAS,WAAW,EAAE;gBACxB,SAAS,WAAW,GAAG,IAAA,6JAAW,EAAC,SAAS,WAAW,EAAE;YAC3D;QACF;QAEA,MAAM,aAAa,IAAI;QACvB,OAAO,WAAW,iBAAiB,CAAC;IACtC;AACF"}},
    {"offset": {"line": 2706, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/style.ts"],"sourcesContent":["import { transformStylesheet } from '@/utils/style';\nimport type { Transformer } from './types';\n\nexport const styleTransformer: Transformer = {\n  name: 'style',\n\n  transform: async (ctx) => {\n    let result = ctx.content;\n    const styleMatches = [...result.matchAll(/<style[^>]*>([\\s\\S]*?)<\\/style>/gi)];\n\n    for (const match of styleMatches) {\n      const [full, css] = match;\n      const transformed = await transformStylesheet(\n        css!,\n        ctx.width || window.innerWidth,\n        ctx.height || window.innerHeight,\n        ctx.viewSettings.vertical,\n      );\n      result = result.replace(full, `<style>${transformed}</style>`);\n    }\n\n    return result;\n  },\n};\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,mBAAgC;IAC3C,MAAM;IAEN,WAAW,OAAO;QAChB,IAAI,SAAS,IAAI,OAAO;QACxB,MAAM,eAAe;eAAI,OAAO,QAAQ,CAAC;SAAqC;QAE9E,KAAK,MAAM,SAAS,aAAc;YAChC,MAAM,CAAC,MAAM,IAAI,GAAG;YACpB,MAAM,cAAc,MAAM,IAAA,kKAAmB,EAC3C,KACA,IAAI,KAAK,IAAI,OAAO,UAAU,EAC9B,IAAI,MAAM,IAAI,OAAO,WAAW,EAChC,IAAI,YAAY,CAAC,QAAQ;YAE3B,SAAS,OAAO,OAAO,CAAC,MAAM,CAAC,OAAO,EAAE,YAAY,QAAQ,CAAC;QAC/D;QAEA,OAAO;IACT;AACF"}},
    {"offset": {"line": 2734, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/proofread.ts"],"sourcesContent":["import * as CFI from 'foliate-js/epubcfi.js';\nimport type { Transformer } from './types';\nimport { ProofreadRule } from '@/types/book';\nimport { useSettingsStore } from '@/store/settingsStore';\n\ninterface NormalizedPattern {\n  source: string;\n  flags: string;\n}\n\nconst isUnicodeWordChar = (char: string): boolean => /[\\p{L}\\p{N}_]/u.test(char || '');\nconst hasUnicodeChars = (text: string): boolean => /[^\\x00-\\x7F]/.test(text);\n\n// Scripts that don't use spaces between words (no word boundaries)\n// CJK: Chinese, Japanese, Korean\n// Thai, Lao, Khmer, Myanmar, Tibetan\nconst NO_WORD_BOUNDARY_RANGES = [\n  '\\u4E00-\\u9FFF', // CJK Unified Ideographs\n  '\\u3400-\\u4DBF', // CJK Unified Ideographs Extension A\n  '\\u3000-\\u303F', // CJK Symbols and Punctuation\n  '\\uFF00-\\uFFEF', // Halfwidth and Fullwidth Forms\n  '\\u3040-\\u309F', // Hiragana\n  '\\u30A0-\\u30FF', // Katakana\n  '\\uAC00-\\uD7AF', // Korean Hangul Syllables\n  '\\u0E00-\\u0E7F', // Thai\n  '\\u0E80-\\u0EFF', // Lao\n  '\\u1780-\\u17FF', // Khmer\n  '\\u1000-\\u109F', // Myanmar\n  '\\u0F00-\\u0FFF', // Tibetan\n].join('');\n\nconst isNoWordBoundaryChar = (char: string): boolean =>\n  new RegExp(`[${NO_WORD_BOUNDARY_RANGES}]`).test(char || '');\nconst isPureNoWordBoundaryScript = (text: string): boolean =>\n  new RegExp(`^[${NO_WORD_BOUNDARY_RANGES}]+$`).test(text);\n\nfunction normalizePattern(\n  pattern: string,\n  isRegex: boolean,\n  caseSensitive = true,\n): NormalizedPattern {\n  const hasUnicode = hasUnicodeChars(pattern);\n\n  let flags = hasUnicode ? 'ug' : 'g';\n  if (!caseSensitive) flags += 'i';\n\n  if (isRegex) {\n    const source = pattern.includes('\\\\b') || hasUnicode ? pattern : `\\\\b${pattern}\\\\b`;\n    return { source, flags };\n  }\n\n  const escaped = pattern.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n\n  if (hasUnicode) {\n    return { source: escaped, flags };\n  }\n\n  const startsWithPunctuation = /^[^\\w\\s]/.test(pattern);\n  const endsWithPunctuation = /[^\\w\\s]$/.test(pattern);\n\n  if (startsWithPunctuation || endsWithPunctuation) {\n    const wordMatch = pattern.match(/[\\w]+/);\n    if (!wordMatch) return { source: escaped, flags };\n\n    const wordPart = wordMatch[0];\n    const wordStart = pattern.indexOf(wordPart);\n    const wordEnd = wordStart + wordPart.length;\n    const wordEscaped = wordPart.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n\n    const beforeWord = escaped.substring(0, wordStart);\n    const afterWord = escaped.substring(wordEnd);\n    return { source: `${beforeWord}\\\\b${wordEscaped}\\\\b${afterWord}`, flags };\n  }\n\n  return { source: `\\\\b${escaped}\\\\b`, flags };\n}\n\nfunction isValidMatch(text: string, match: RegExpExecArray, rule: ProofreadRule): boolean {\n  if (!rule.isRegex) {\n    const isCaseSensitive = rule.caseSensitive !== false;\n    const isExactMatch = isCaseSensitive\n      ? match[0] === rule.pattern\n      : match[0].toLowerCase() === rule.pattern.toLowerCase();\n    if (!isExactMatch) return false;\n  }\n\n  // Skip word boundary check for scripts without word boundaries (CJK, Thai, Lao, Khmer, Myanmar, Tibetan)\n  if (hasUnicodeChars(rule.pattern) && !isPureNoWordBoundaryScript(rule.pattern)) {\n    const charBefore = text[match.index - 1] ?? '';\n    const charAfter = text[match.index + match[0].length] ?? '';\n    // Only check word boundaries if adjacent chars are from scripts that use word boundaries\n    if (!isNoWordBoundaryChar(charBefore) && !isNoWordBoundaryChar(charAfter)) {\n      if (isUnicodeWordChar(charBefore) || isUnicodeWordChar(charAfter)) {\n        return false;\n      }\n    }\n  }\n\n  return true;\n}\n\nfunction applyReplacementMulti(\n  textNodes: Text[],\n  rule: ProofreadRule & { normalizedPattern: NormalizedPattern },\n): void {\n  let regex: RegExp;\n  try {\n    regex = new RegExp(rule.normalizedPattern.source, rule.normalizedPattern.flags);\n  } catch {\n    return;\n  }\n\n  for (const textNode of textNodes) {\n    if (!textNode.textContent) continue;\n\n    let text = textNode.textContent;\n    const matches: Array<{ index: number; length: number }> = [];\n    let match: RegExpExecArray | null;\n\n    while ((match = regex.exec(text)) !== null) {\n      if (!isValidMatch(text, match, rule)) continue;\n      matches.push({ index: match.index, length: match[0].length });\n    }\n\n    if (matches.length === 0) continue;\n\n    for (let i = matches.length - 1; i >= 0; i--) {\n      const m = matches[i]!;\n      text = text.slice(0, m.index) + rule.replacement + text.slice(m.index + m.length);\n    }\n\n    textNode.textContent = text;\n  }\n}\n\nfunction applyReplacementSingle(\n  doc: Document,\n  rule: ProofreadRule & { normalizedPattern: NormalizedPattern },\n): void {\n  let regex: RegExp;\n  try {\n    regex = new RegExp(rule.normalizedPattern.source, rule.normalizedPattern.flags);\n  } catch {\n    return;\n  }\n\n  const parts = CFI.parse(rule.cfi);\n  if (parts.parent) {\n    parts.parent.shift();\n    const range = CFI.toRange(doc, parts) as Range;\n    if (range) {\n      const startContainer = range.startContainer;\n      const endContainer = range.endContainer;\n      if (startContainer === endContainer && startContainer.nodeType === Node.TEXT_NODE) {\n        const textNode = startContainer as Text;\n        const text = textNode.textContent || '';\n        const startOffset = range.startOffset;\n        const endOffset = range.endOffset;\n\n        // Add 32-char tolerance buffer around the selection\n        const bufferSize = 32;\n        const bufferStart = Math.max(0, startOffset - bufferSize);\n        const bufferEnd = Math.min(text.length, endOffset + bufferSize);\n\n        const bufferedText = text.slice(bufferStart, bufferEnd);\n        const selectedText = text.slice(startOffset, endOffset);\n\n        const match = regex.exec(bufferedText);\n        if (match && isValidMatch(selectedText, match, rule)) {\n          const matchStartInBuffer = match.index;\n          const matchStartInText = bufferStart + matchStartInBuffer;\n          const matchEnd = matchStartInText + match[0].length;\n\n          if (matchEnd >= startOffset - bufferSize && matchStartInText <= endOffset + bufferSize) {\n            const newText =\n              text.slice(0, matchStartInText) + rule.replacement + text.slice(matchEnd);\n            textNode.textContent = newText;\n            return;\n          }\n        }\n      }\n    }\n  }\n}\n\nfunction getTextNodes(doc: Document): Text[] {\n  const walker = document.createTreeWalker(doc.body || doc.documentElement, NodeFilter.SHOW_TEXT, {\n    acceptNode: (node) => {\n      const parent = node.parentElement;\n      if (parent?.tagName === 'SCRIPT' || parent?.tagName === 'STYLE') {\n        return NodeFilter.FILTER_REJECT;\n      }\n      return node.textContent?.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;\n    },\n  });\n\n  const textNodes: Text[] = [];\n  let node: Node | null;\n  while ((node = walker.nextNode())) {\n    textNodes.push(node as Text);\n  }\n  return textNodes;\n}\n\nexport const proofreadTransformer: Transformer = {\n  name: 'proofread',\n\n  transform: async (ctx, options) => {\n    const { docType = 'text/html', onlyForTTS = false } =\n      (options as {\n        docType?: DOMParserSupportedType;\n        onlyForTTS?: boolean;\n      }) || {};\n    const globalRules = useSettingsStore.getState().settings?.globalViewSettings?.proofreadRules;\n    const bookRules = ctx.viewSettings.proofreadRules;\n    const merged = [...(globalRules ?? []), ...(bookRules ?? [])].sort(\n      (a, b) => (a.order ?? 0) - (b.order ?? 0),\n    );\n    if (!merged.length) return ctx.content;\n\n    const processed = merged\n      .filter((r) => r.enabled && r.pattern.trim())\n      .filter((r) => (onlyForTTS ? r.onlyForTTS : !r.onlyForTTS))\n      .map((r) => ({\n        ...r,\n        normalizedPattern: normalizePattern(r.pattern, r.isRegex, r.caseSensitive !== false),\n      }));\n\n    if (!processed.length) return ctx.content;\n\n    const parser = new DOMParser();\n    const doc = parser.parseFromString(ctx.content, docType);\n    const textNodes = getTextNodes(doc);\n\n    const byScope = {\n      selection: processed.filter((r) => r.scope === 'selection'),\n      book: processed.filter((r) => r.scope === 'book'),\n      library: processed.filter((r) => r.scope === 'library'),\n    };\n\n    const ordered = [...byScope.selection, ...byScope.book, ...byScope.library];\n\n    for (const rule of ordered) {\n      if (rule.scope === 'selection') {\n        const ruleBase = rule.sectionHref?.split('#')[0];\n        const ctxBase = ctx.sectionHref?.split('#')[0];\n        if (ctxBase !== ruleBase) continue;\n      }\n      if (rule.scope === 'selection') {\n        applyReplacementSingle(doc, rule);\n      } else {\n        applyReplacementMulti(textNodes, rule);\n      }\n    }\n\n    return new XMLSerializer().serializeToString(doc);\n  },\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2959, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformers/index.ts"],"sourcesContent":["import type { Transformer } from './types';\nimport { footnoteTransformer } from './footnote';\nimport { languageTransformer } from './language';\nimport { punctuationTransformer } from './punctuation';\nimport { whitespaceTransformer } from './whitespace';\nimport { sanitizerTransformer } from './sanitizer';\nimport { simpleccTransformer } from './simplecc';\nimport { styleTransformer } from './style';\nimport { proofreadTransformer } from './proofread';\n\nexport const availableTransformers: Transformer[] = [\n  punctuationTransformer,\n  footnoteTransformer,\n  languageTransformer,\n  styleTransformer,\n  whitespaceTransformer,\n  sanitizerTransformer,\n  simpleccTransformer,\n  proofreadTransformer,\n  // Add more transformers here\n];\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;AAEO,MAAM,wBAAuC;IAClD,8LAAsB;IACtB,wLAAmB;IACnB,wLAAmB;IACnB,kLAAgB;IAChB,4LAAqB;IACrB,0LAAoB;IACpB,wLAAmB;IACnB,0LAAoB;CAErB"}},
    {"offset": {"line": 2996, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/transformService.ts"],"sourcesContent":["import { availableTransformers } from './transformers';\nimport { TransformContext } from './transformers/types';\n\nexport const transformContent = async (ctx: TransformContext): Promise<string> => {\n  let transformed = ctx.content;\n\n  const activeTransformers = ctx.transformers\n    .map((name) => availableTransformers.find((transformer) => transformer.name === name))\n    .filter((transformer) => !!transformer);\n  for (const transformer of activeTransformers) {\n    try {\n      transformed = await transformer.transform({ ...ctx, content: transformed });\n    } catch (error) {\n      console.warn(`Error in transformer ${transformer.name}:`, error);\n    }\n  }\n\n  return transformed;\n};\n"],"names":[],"mappings":";;;;AAAA;;AAGO,MAAM,mBAAmB,OAAO;IACrC,IAAI,cAAc,IAAI,OAAO;IAE7B,MAAM,qBAAqB,IAAI,YAAY,CACxC,GAAG,CAAC,CAAC,OAAS,uLAAqB,CAAC,IAAI,CAAC,CAAC,cAAgB,YAAY,IAAI,KAAK,OAC/E,MAAM,CAAC,CAAC,cAAgB,CAAC,CAAC;IAC7B,KAAK,MAAM,eAAe,mBAAoB;QAC5C,IAAI;YACF,cAAc,MAAM,YAAY,SAAS,CAAC;gBAAE,GAAG,GAAG;gBAAE,SAAS;YAAY;QAC3E,EAAE,OAAO,OAAO;YACd,QAAQ,IAAI,CAAC,CAAC,qBAAqB,EAAE,YAAY,IAAI,CAAC,CAAC,CAAC,EAAE;QAC5D;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 3024, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 3033, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 3042, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/tts/TTSData.ts"],"sourcesContent":["export const SILENCE_DATA =\n  'data:audio/mp3;base64,//MkxAAHiAICWABElBeKPL/RANb2w+yiT1g/gTok//lP/W/l3h8QO/OCdCqCW2Cw//MkxAQHkAIWUAhEmAQXWUOFW2dxPu//9mr60ElY5sseQ+xxesmHKtZr7bsqqX2L//MkxAgFwAYiQAhEAC2hq22d3///9FTV6tA36JdgBJoOGgc+7qvqej5Zu7/7uI9l//MkxBQHAAYi8AhEAO193vt9KGOq+6qcT7hhfN5FTInmwk8RkqKImTM55pRQHQSq//MkxBsGkgoIAABHhTACIJLf99nVI///yuW1uBqWfEu7CgNPWGpUadBmZ////4sL//MkxCMHMAH9iABEmAsKioqKigsLCwtVTEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVV//MkxCkECAUYCAAAAFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';\n\nexport const WEB_SPEECH_BLACKLISTED_VOICES = [\n  'Albert',\n  'Bad News',\n  'Bahh',\n  'Bells',\n  'Boing',\n  'Bubbles',\n  'Cellos',\n  'Eddy',\n  'Flo',\n  'Fred',\n  'Good News',\n  'Grandma',\n  'Grandpa',\n  'Jester',\n  'Junior',\n  'Kathy',\n  'Organ',\n  'Ralph',\n  'Reed',\n  'Rocko',\n  'Sandy',\n  'Shelley',\n  'Superstar',\n  'Trinoids',\n  'Whisper',\n  'Wobble',\n  'Zarvox',\n];\n"],"names":[],"mappings":";;;;;;AAAO,MAAM,eACX;AAEK,MAAM,gCAAgC;IAC3C;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD"}},
    {"offset": {"line": 3085, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/tts/TTSUtils.ts"],"sourcesContent":["import { TTSVoice } from './types';\n\nexport class TTSUtils {\n  private static readonly LOCAL_STORAGE_KEY = 'ttsPreferredVoices';\n  private static readonly PREFERRED_CLIENT_KEY = 'preferredClient';\n\n  private static normalizeLanguage(language: string): string {\n    if (!language) return 'n/a';\n    return language.toLowerCase().slice(0, 2);\n  }\n\n  static setPreferredClient(engine: string): void {\n    if (!engine) return;\n    const preferences = this.getPreferences();\n    preferences[this.PREFERRED_CLIENT_KEY] = engine;\n    localStorage.setItem(this.LOCAL_STORAGE_KEY, JSON.stringify(preferences));\n  }\n\n  static setPreferredVoice(engine: string, language: string, voiceId: string): void {\n    if (!engine || !language || !voiceId) return;\n    const preferences = this.getPreferences();\n    const lang = this.normalizeLanguage(language);\n    preferences[`${engine}-${lang}`] = voiceId;\n    localStorage.setItem(this.LOCAL_STORAGE_KEY, JSON.stringify(preferences));\n  }\n\n  static getPreferredClient(): string | null {\n    const preferences = this.getPreferences();\n    return preferences[this.PREFERRED_CLIENT_KEY] || null;\n  }\n\n  static getPreferredVoice(engine: string, language: string): string | null {\n    const preferences = this.getPreferences();\n    const lang = this.normalizeLanguage(language);\n    return preferences[`${engine}-${lang}`] || null;\n  }\n\n  private static getPreferences(): Record<string, string> {\n    const storedPreferences = localStorage.getItem(this.LOCAL_STORAGE_KEY);\n    return storedPreferences ? JSON.parse(storedPreferences) : {};\n  }\n\n  static sortVoicesFunc(a: TTSVoice, b: TTSVoice): number {\n    const aRegion = a.lang.split('-')[1] || '';\n    const bRegion = b.lang.split('-')[1] || '';\n    if (aRegion === bRegion) {\n      return a.name < b.name ? -1 : a.name > b.name ? 1 : 0;\n    }\n    if (aRegion === 'CN') return -1;\n    if (bRegion === 'CN') return 1;\n    if (aRegion === 'TW') return -1;\n    if (bRegion === 'TW') return 1;\n    if (aRegion === 'HK') return -1;\n    if (bRegion === 'HK') return 1;\n    if (aRegion === 'US') return -1;\n    if (bRegion === 'US') return 1;\n    if (aRegion === 'GB') return -1;\n    if (bRegion === 'GB') return 1;\n    return a.name < b.name ? -1 : a.name > b.name ? 1 : 0;\n  }\n}\n"],"names":[],"mappings":";;;;AAEO,MAAM;IACX,OAAwB,oBAAoB,qBAAqB;IACjE,OAAwB,uBAAuB,kBAAkB;IAEjE,OAAe,kBAAkB,QAAgB,EAAU;QACzD,IAAI,CAAC,UAAU,OAAO;QACtB,OAAO,SAAS,WAAW,GAAG,KAAK,CAAC,GAAG;IACzC;IAEA,OAAO,mBAAmB,MAAc,EAAQ;QAC9C,IAAI,CAAC,QAAQ;QACb,MAAM,cAAc,IAAI,CAAC,cAAc;QACvC,WAAW,CAAC,IAAI,CAAC,oBAAoB,CAAC,GAAG;QACzC,aAAa,OAAO,CAAC,IAAI,CAAC,iBAAiB,EAAE,KAAK,SAAS,CAAC;IAC9D;IAEA,OAAO,kBAAkB,MAAc,EAAE,QAAgB,EAAE,OAAe,EAAQ;QAChF,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,SAAS;QACtC,MAAM,cAAc,IAAI,CAAC,cAAc;QACvC,MAAM,OAAO,IAAI,CAAC,iBAAiB,CAAC;QACpC,WAAW,CAAC,GAAG,OAAO,CAAC,EAAE,MAAM,CAAC,GAAG;QACnC,aAAa,OAAO,CAAC,IAAI,CAAC,iBAAiB,EAAE,KAAK,SAAS,CAAC;IAC9D;IAEA,OAAO,qBAAoC;QACzC,MAAM,cAAc,IAAI,CAAC,cAAc;QACvC,OAAO,WAAW,CAAC,IAAI,CAAC,oBAAoB,CAAC,IAAI;IACnD;IAEA,OAAO,kBAAkB,MAAc,EAAE,QAAgB,EAAiB;QACxE,MAAM,cAAc,IAAI,CAAC,cAAc;QACvC,MAAM,OAAO,IAAI,CAAC,iBAAiB,CAAC;QACpC,OAAO,WAAW,CAAC,GAAG,OAAO,CAAC,EAAE,MAAM,CAAC,IAAI;IAC7C;IAEA,OAAe,iBAAyC;QACtD,MAAM,oBAAoB,aAAa,OAAO,CAAC,IAAI,CAAC,iBAAiB;QACrE,OAAO,oBAAoB,KAAK,KAAK,CAAC,qBAAqB,CAAC;IAC9D;IAEA,OAAO,eAAe,CAAW,EAAE,CAAW,EAAU;QACtD,MAAM,UAAU,EAAE,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,IAAI;QACxC,MAAM,UAAU,EAAE,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,IAAI;QACxC,IAAI,YAAY,SAAS;YACvB,OAAO,EAAE,IAAI,GAAG,EAAE,IAAI,GAAG,CAAC,IAAI,EAAE,IAAI,GAAG,EAAE,IAAI,GAAG,IAAI;QACtD;QACA,IAAI,YAAY,MAAM,OAAO,CAAC;QAC9B,IAAI,YAAY,MAAM,OAAO;QAC7B,IAAI,YAAY,MAAM,OAAO,CAAC;QAC9B,IAAI,YAAY,MAAM,OAAO;QAC7B,IAAI,YAAY,MAAM,OAAO,CAAC;QAC9B,IAAI,YAAY,MAAM,OAAO;QAC7B,IAAI,YAAY,MAAM,OAAO,CAAC;QAC9B,IAAI,YAAY,MAAM,OAAO;QAC7B,IAAI,YAAY,MAAM,OAAO,CAAC;QAC9B,IAAI,YAAY,MAAM,OAAO;QAC7B,OAAO,EAAE,IAAI,GAAG,EAAE,IAAI,GAAG,CAAC,IAAI,EAAE,IAAI,GAAG,EAAE,IAAI,GAAG,IAAI;IACtD;AACF"}},
    {"offset": {"line": 3148, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/tts/WebSpeechClient.ts"],"sourcesContent":["import { getUserLocale } from '@/utils/misc';\nimport { TTSClient, TTSMessageEvent } from './TTSClient';\nimport { parseSSMLMarks } from '@/utils/ssml';\nimport { TTSGranularity, TTSMark, TTSVoice, TTSVoicesGroup } from './types';\nimport { WEB_SPEECH_BLACKLISTED_VOICES } from './TTSData';\nimport { TTSController } from './TTSController';\nimport { TTSUtils } from './TTSUtils';\n\ninterface TTSBoundaryEvent {\n  type: 'boundary' | 'end' | 'error';\n  speaking: boolean;\n  name?: string;\n  mark?: string;\n  charIndex?: number;\n  charLength?: number;\n  error?: string;\n}\n\nasync function* speakWithMarks(\n  ssml: string,\n  primaryLang: string,\n  getRate: () => number,\n  getPitch: () => number,\n  getVoice: (lang: string) => Promise<SpeechSynthesisVoice | null>,\n  setCurrentVoice: (voiceId: string) => void,\n  setSpeakingLang: (lang: string) => void,\n  dispatchSpeakMark: (mark: TTSMark) => void,\n) {\n  const { marks } = parseSSMLMarks(ssml, primaryLang);\n  const synth = window.speechSynthesis;\n  const utterance = new SpeechSynthesisUtterance();\n  for (const mark of marks) {\n    const { language: voiceLang } = mark;\n    dispatchSpeakMark(mark);\n    utterance.text = mark.text;\n    utterance.rate = getRate();\n    utterance.pitch = getPitch();\n    const voice = await getVoice(voiceLang);\n    if (voice) {\n      utterance.voice = voice;\n      setCurrentVoice(voice.voiceURI);\n    }\n    if (voiceLang) {\n      utterance.lang = voiceLang;\n      setSpeakingLang(voiceLang);\n    }\n\n    yield {\n      type: 'boundary',\n      speaking: true,\n      name: 'sentence',\n      mark: mark.name,\n    } as TTSBoundaryEvent;\n\n    const result = await new Promise<TTSBoundaryEvent>((resolve) => {\n      utterance.onend = () => resolve({ type: 'end', speaking: false });\n      utterance.onerror = (event) =>\n        resolve({\n          type: 'error',\n          speaking: false,\n          error: event.error,\n        });\n\n      synth.speak(utterance);\n    });\n\n    yield result;\n    if (result.type === 'error') {\n      break;\n    }\n  }\n}\n\ntype WebSpeechVoice = SpeechSynthesisVoice & {\n  id: string;\n};\n\nexport class WebSpeechClient implements TTSClient {\n  name = 'web-speech';\n  initialized = false;\n  controller?: TTSController;\n\n  #voices: WebSpeechVoice[] = [];\n  #primaryLang = 'en';\n  #speakingLang = '';\n  #currentVoiceId = '';\n  #rate = 1.0;\n  #pitch = 1.0;\n\n  #synth = window.speechSynthesis;\n\n  constructor(controller?: TTSController) {\n    this.controller = controller;\n  }\n\n  async init() {\n    if (!this.#synth) {\n      this.initialized = false;\n      return this.initialized;\n    }\n    await new Promise<void>((resolve) => {\n      const populateVoices = () => {\n        this.#voices = this.#synth.getVoices().map((voice) => {\n          const webSpeechVoice = voice as WebSpeechVoice;\n          webSpeechVoice.id = voice.voiceURI || voice.name;\n          return webSpeechVoice;\n        });\n        // console.log('Voices', this.#voices);\n        resolve();\n      };\n\n      if (this.#synth.getVoices().length > 0) {\n        populateVoices();\n      } else if (this.#synth.onvoiceschanged !== undefined) {\n        this.#synth.onvoiceschanged = populateVoices;\n      } else {\n        console.warn('Voiceschanged event not supported.');\n        resolve();\n      }\n    });\n    this.initialized = true;\n    return this.initialized;\n  }\n\n  getVoiceIdFromLang = async (lang: string) => {\n    const preferredVoiceId = TTSUtils.getPreferredVoice(this.name, lang);\n    const preferredVoice = this.#voices.find((v) => v.id === preferredVoiceId);\n    const defaultVoice = preferredVoice\n      ? preferredVoice\n      : (await this.getVoices(lang))[0]?.voices[0] || null;\n    return defaultVoice?.id || this.#currentVoiceId || '';\n  };\n\n  getWebSpeechVoiceFromLang = async (lang: string) => {\n    const voiceId = await this.getVoiceIdFromLang(lang);\n    return this.#voices.find((v) => v.id === voiceId) || null;\n  };\n\n  async *speak(\n    ssml: string,\n    signal: AbortSignal,\n    preload = false,\n  ): AsyncGenerator<TTSMessageEvent> {\n    // no need to preload for web speech\n    if (preload) return;\n\n    for await (const ev of speakWithMarks(\n      ssml,\n      this.#primaryLang,\n      () => this.#rate,\n      () => this.#pitch,\n      this.getWebSpeechVoiceFromLang,\n      (voiceId) => (this.#currentVoiceId = voiceId),\n      (lang) => (this.#speakingLang = lang),\n      (mark) => this.controller?.dispatchSpeakMark(mark),\n    )) {\n      if (signal.aborted) {\n        console.log('TTS aborted');\n        yield { code: 'error', message: 'Aborted' } as TTSMessageEvent;\n        return;\n      }\n      if (ev.type === 'boundary') {\n        yield {\n          code: 'boundary',\n          mark: ev.mark ?? '',\n          message: `${ev.name ?? 'Unknown'} ${ev.charIndex ?? 0}/${ev.charLength ?? 0}`,\n        } as TTSMessageEvent;\n      } else if (ev.type === 'error') {\n        yield { code: 'error', message: ev.error ?? 'Unknown error' } as TTSMessageEvent;\n      } else if (ev.type === 'end') {\n        yield { code: 'end', message: 'Speech finished' } as TTSMessageEvent;\n      }\n    }\n  }\n\n  async pause() {\n    this.#synth.pause();\n    return true;\n  }\n\n  async resume() {\n    this.#synth.resume();\n    return true;\n  }\n\n  async stop() {\n    this.#synth.cancel();\n  }\n\n  setPrimaryLang(lang: string) {\n    this.#primaryLang = lang;\n  }\n\n  async setRate(rate: number) {\n    // The Web Speech API uses utterance.rate in [0.1 .. 10],\n    this.#rate = rate;\n  }\n\n  async setPitch(pitch: number) {\n    // The Web Speech API uses pitch in [0 .. 2].\n    this.#pitch = pitch;\n  }\n\n  async setVoice(voiceId: string) {\n    const selectedVoice = this.#voices.find((v) => v.id === voiceId);\n    if (selectedVoice) {\n      this.#currentVoiceId = selectedVoice.id;\n    }\n  }\n\n  async getAllVoices(): Promise<TTSVoice[]> {\n    const voices = this.#voices.map((voice) => {\n      return {\n        id: voice.id,\n        name: voice.name,\n        lang: voice.lang,\n        disabled: !this.initialized,\n      } as TTSVoice;\n    });\n    return voices;\n  }\n\n  async getVoices(lang: string) {\n    const locale = lang === 'en' ? getUserLocale(lang) || lang : lang;\n    const isValidVoice = (id: string) => {\n      return !id.includes('com.apple') || id.includes('com.apple.voice.compact');\n    };\n    const isNotBlacklisted = (voice: SpeechSynthesisVoice) => {\n      return WEB_SPEECH_BLACKLISTED_VOICES.some((name) => voice.name.includes(name)) === false;\n    };\n    const filteredVoices = this.#voices\n      .filter(\n        (voice) =>\n          voice.lang.startsWith(locale) ||\n          (lang === 'en' && ['en-US', 'en-GB'].includes(voice.lang)),\n      )\n      .filter((voice) => isValidVoice(voice.voiceURI || ''))\n      .filter(isNotBlacklisted);\n    const seenIds = new Set<string>();\n    const voices = filteredVoices\n      .map(\n        (voice) =>\n          ({\n            id: voice.voiceURI,\n            name: voice.name,\n            lang: voice.lang,\n          }) as TTSVoice,\n      )\n      .filter((voice) => {\n        if (seenIds.has(voice.id)) {\n          return false;\n        }\n        seenIds.add(voice.id);\n        return true;\n      });\n    voices.forEach((voice) => {\n      voice.disabled = !this.initialized;\n    });\n\n    const voicesGroup: TTSVoicesGroup = {\n      id: 'web-speech-api',\n      name: 'Web TTS',\n      voices: voices.sort(TTSUtils.sortVoicesFunc),\n      disabled: !this.initialized || voices.length === 0,\n    };\n    return [voicesGroup];\n  }\n\n  getGranularities(): TTSGranularity[] {\n    // currently only support sentence boundary and disable word boundary as changing voice\n    // in the middle of speech is not possible for different granularities\n    return ['sentence'];\n  }\n\n  getVoiceId(): string {\n    return this.#currentVoiceId;\n  }\n\n  getSpeakingLang(): string {\n    return this.#speakingLang;\n  }\n\n  async shutdown(): Promise<void> {\n    this.initialized = false;\n    this.#voices = [];\n    await this.stop();\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3387, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/tts/EdgeTTSClient.ts"],"sourcesContent":["import { getUserLocale } from '@/utils/misc';\nimport { TTSClient, TTSMessageEvent } from './TTSClient';\nimport { EdgeSpeechTTS, EdgeTTSPayload, EDGE_TTS_PROTOCOL } from '@/libs/edgeTTS';\nimport { parseSSMLMarks } from '@/utils/ssml';\nimport { TTSController } from './TTSController';\nimport { TTSUtils } from './TTSUtils';\nimport { TTSGranularity, TTSVoice, TTSVoicesGroup } from './types';\n\nexport class EdgeTTSClient implements TTSClient {\n  name = 'edge-tts';\n  initialized = false;\n  controller?: TTSController;\n\n  #voices: TTSVoice[] = [];\n  #primaryLang = 'en';\n  #speakingLang = '';\n  #currentVoiceId = '';\n  #rate = 1.0;\n  #pitch = 1.0;\n\n  #edgeTTS: EdgeSpeechTTS | null = null;\n  #audioElement: HTMLAudioElement | null = null;\n  #isPlaying = false;\n  #pausedAt = 0;\n  #startedAt = 0;\n  #fadeCompensation: number | null = null;\n\n  constructor(controller?: TTSController) {\n    this.controller = controller;\n  }\n\n  async init(protocol: EDGE_TTS_PROTOCOL = 'wss') {\n    this.#edgeTTS = new EdgeSpeechTTS(protocol);\n    this.#voices = EdgeSpeechTTS.voices;\n    try {\n      await this.#edgeTTS.create({\n        lang: 'en',\n        text: 'test',\n        voice: 'en-US-AriaNeural',\n        rate: 1.0,\n        pitch: 1.0,\n      });\n      this.initialized = true;\n    } catch {\n      if (protocol === 'wss') {\n        if (this.controller?.isAuthenticated) {\n          await this.init('https');\n        } else {\n          this.controller?.dispatchEvent(new CustomEvent('tts-need-auth'));\n        }\n      } else {\n        this.initialized = false;\n      }\n    }\n    return this.initialized;\n  }\n\n  getPayload = (lang: string, text: string, voiceId: string) => {\n    return { lang, text, voice: voiceId, rate: 1.0, pitch: this.#pitch } as EdgeTTSPayload;\n  };\n\n  getVoiceIdFromLang = async (lang: string) => {\n    const preferredVoiceId = TTSUtils.getPreferredVoice(this.name, lang);\n    const preferredVoice = this.#voices.find((v) => v.id === preferredVoiceId);\n    if (preferredVoice) return preferredVoice.id;\n\n    const availableVoices = (await this.getVoices(lang))[0]?.voices || [];\n    const defaultVoice: TTSVoice | null = availableVoices[0] || null;\n    if (defaultVoice?.id === 'en-US-AnaNeural') return 'en-US-AriaNeural'; // avoid using AnaNeural as default\n    return defaultVoice?.id || this.#currentVoiceId || 'en-US-AriaNeural';\n  };\n\n  async *speak(ssml: string, signal: AbortSignal, preload = false) {\n    const { marks } = parseSSMLMarks(ssml, this.#primaryLang);\n\n    if (preload) {\n      // preload the first 2 marks immediately and the rest in the background\n      const maxImmediate = 2;\n      for (let i = 0; i < Math.min(maxImmediate, marks.length); i++) {\n        if (signal.aborted) break;\n        const mark = marks[i]!;\n        const { language: voiceLang } = mark;\n        const voiceId = await this.getVoiceIdFromLang(voiceLang);\n        this.#currentVoiceId = voiceId;\n        await this.#edgeTTS\n          ?.createAudioUrl(this.getPayload(voiceLang, mark.text, voiceId))\n          .catch((err) => {\n            console.warn('Error preloading mark', i, err);\n          });\n      }\n      if (marks.length > maxImmediate) {\n        (async () => {\n          for (let i = maxImmediate; i < marks.length; i++) {\n            const mark = marks[i]!;\n            try {\n              if (signal.aborted) break;\n              const { language: voiceLang } = mark;\n              const voiceId = await this.getVoiceIdFromLang(voiceLang);\n              await this.#edgeTTS?.createAudioUrl(this.getPayload(voiceLang, mark.text, voiceId));\n            } catch (err) {\n              console.warn('Error preloading mark (bg)', i, err);\n            }\n          }\n        })();\n      }\n\n      yield {\n        code: 'end',\n        message: 'Preload finished',\n      } as TTSMessageEvent;\n\n      return;\n    }\n\n    await this.stopInternal();\n    // Reuse the same Audio element inside the ssml session\n    if (!this.#audioElement) {\n      this.#audioElement = new Audio();\n    }\n    const audio = this.#audioElement;\n    audio.setAttribute('x-webkit-airplay', 'deny');\n    audio.preload = 'auto';\n\n    for (const mark of marks) {\n      this.controller?.dispatchSpeakMark(mark);\n      let abortHandler: null | (() => void) = null;\n      try {\n        const { language: voiceLang } = mark;\n        const voiceId = await this.getVoiceIdFromLang(voiceLang);\n        this.#speakingLang = voiceLang;\n        const audioUrl = await this.#edgeTTS?.createAudioUrl(\n          this.getPayload(voiceLang, mark.text, voiceId),\n        );\n        if (signal.aborted) {\n          yield { code: 'error', message: 'Aborted' } as TTSMessageEvent;\n          break;\n        }\n\n        yield {\n          code: 'boundary',\n          message: `Start chunk: ${mark.name}`,\n          mark: mark.name,\n        } as TTSMessageEvent;\n\n        const result = await new Promise<TTSMessageEvent>((resolve) => {\n          const cleanUp = () => {\n            audio.onended = null;\n            audio.onerror = null;\n            audio.src = '';\n          };\n          abortHandler = () => {\n            cleanUp();\n            resolve({ code: 'error', message: 'Aborted' });\n          };\n          if (signal.aborted) {\n            abortHandler();\n            return;\n          } else {\n            signal.addEventListener('abort', abortHandler);\n          }\n          audio.onended = () => {\n            cleanUp();\n            resolve({ code: 'end', message: `Chunk finished: ${mark.name}` });\n          };\n          audio.onerror = (e) => {\n            cleanUp();\n            console.warn('Audio playback error:', e);\n            resolve({ code: 'error', message: 'Audio playback error' });\n          };\n          this.#isPlaying = true;\n          audio.src = audioUrl || '';\n          audio\n            .play()\n            .then(() => (audio.playbackRate = this.#rate))\n            .catch((err) => {\n              cleanUp();\n              console.error('Failed to play audio:', err);\n              resolve({ code: 'error', message: 'Playback failed: ' + err.message });\n            });\n        });\n        yield result;\n      } catch (error) {\n        if (error instanceof Error && error.message === 'No audio data received.') {\n          console.warn('No audio data received for:', mark.text);\n          yield { code: 'end', message: `Chunk finished: ${mark.name}` } as TTSMessageEvent;\n          continue;\n        }\n        const message = error instanceof Error ? error.message : String(error);\n        console.warn('TTS error for mark:', mark.text, message);\n        yield { code: 'error', message } as TTSMessageEvent;\n        break;\n      } finally {\n        if (abortHandler) {\n          signal.removeEventListener('abort', abortHandler);\n        }\n      }\n    }\n    await this.stopInternal();\n  }\n\n  async pause() {\n    if (!this.#isPlaying || !this.#audioElement) return true;\n    this.#pausedAt = this.#audioElement.currentTime - this.#startedAt;\n    await this.#audioElement.pause();\n    this.#isPlaying = false;\n    return true;\n  }\n\n  #getFadeCompensation() {\n    if (this.#fadeCompensation !== null) return this.#fadeCompensation;\n\n    const userAgent = navigator.userAgent;\n    const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);\n    const isIOS = /iPad|iPhone|iPod/.test(userAgent);\n    if (isSafari || isIOS) {\n      this.#fadeCompensation = 0.2;\n    } else {\n      this.#fadeCompensation = 0.0;\n    }\n\n    return this.#fadeCompensation;\n  }\n\n  async resume() {\n    if (this.#isPlaying || !this.#audioElement) return true;\n    const fadeCompensation = this.#getFadeCompensation();\n    this.#audioElement.currentTime = Math.max(0, this.#audioElement.currentTime - fadeCompensation);\n    await this.#audioElement.play();\n    this.#isPlaying = true;\n    this.#startedAt = this.#audioElement.currentTime - this.#pausedAt;\n    return true;\n  }\n\n  async stop() {\n    await this.stopInternal();\n  }\n\n  private async stopInternal() {\n    this.#isPlaying = false;\n    this.#pausedAt = 0;\n    this.#startedAt = 0;\n    if (this.#audioElement) {\n      this.#audioElement.pause();\n      this.#audioElement.currentTime = 0;\n      if (this.#audioElement?.onended) {\n        this.#audioElement.onended(new Event('stopped'));\n      }\n      this.#audioElement.src = '';\n    }\n  }\n\n  async setRate(rate: number) {\n    // The Edge TTS API uses rate in [0.5 .. 2.0].\n    this.#rate = rate;\n  }\n\n  async setPitch(pitch: number) {\n    // The Edge TTS API uses pitch in [0.5 .. 1.5].\n    this.#pitch = pitch;\n  }\n\n  async setVoice(voice: string) {\n    const selectedVoice = this.#voices.find((v) => v.id === voice);\n    if (selectedVoice) {\n      this.#currentVoiceId = selectedVoice.id;\n    }\n  }\n\n  async getAllVoices(): Promise<TTSVoice[]> {\n    this.#voices.forEach((voice) => {\n      voice.disabled = !this.initialized;\n    });\n    return this.#voices;\n  }\n\n  async getVoices(lang: string) {\n    const locale = lang === 'en' ? getUserLocale(lang) || lang : lang;\n    const voices = await this.getAllVoices();\n    const filteredVoices = voices.filter(\n      (v) => v.lang.startsWith(locale) || (lang === 'en' && ['en-US', 'en-GB'].includes(v.lang)),\n    );\n\n    const voicesGroup: TTSVoicesGroup = {\n      id: 'edge-tts',\n      name: 'Edge TTS',\n      voices: filteredVoices.sort(TTSUtils.sortVoicesFunc),\n      disabled: !this.initialized || filteredVoices.length === 0,\n    };\n\n    return [voicesGroup];\n  }\n\n  setPrimaryLang(lang: string) {\n    this.#primaryLang = lang;\n  }\n\n  getGranularities(): TTSGranularity[] {\n    return ['sentence'];\n  }\n\n  getVoiceId(): string {\n    return this.#currentVoiceId;\n  }\n\n  getSpeakingLang(): string {\n    return this.#speakingLang;\n  }\n\n  async shutdown(): Promise<void> {\n    this.initialized = false;\n    this.#audioElement = null;\n    this.#voices = [];\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3703, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/tts/NativeTTSClient.ts"],"sourcesContent":["import { invoke } from '@tauri-apps/api/core';\nimport { addPluginListener, PluginListener } from '@tauri-apps/api/core';\nimport { getUserLocale } from '@/utils/misc';\nimport { parseSSMLMarks } from '@/utils/ssml';\nimport { stubTranslation as _ } from '@/utils/misc';\nimport { TTSClient, TTSMessageEvent } from './TTSClient';\nimport { TTSGranularity, TTSMark, TTSVoice, TTSVoicesGroup } from './types';\nimport { TTSUtils } from './TTSUtils';\nimport { TTSController } from './TTSController';\n\ntype TTSEventPayload = {\n  utteranceId: string;\n} & TTSMessageEvent;\n\nconst TTSEngines = {\n  default: 'System TTS',\n  msctts: 'Msc TTS',\n  mstrans: 'MSTrans TTS',\n  microsoft: 'Microsoft TTS',\n  bytedance: 'ByteDance TTS',\n  peiyinya: 'PeiYinYa TTS',\n  huoshan: 'HuoShan TTS',\n  sougou: 'Sougou TTS',\n  xiaomi: 'XiaoMi TTS',\n  bdetts: 'BDeTTS',\n  bdotts: 'BDoTTS',\n  vcstts: 'VcsTTS',\n  isstts: 'IssTTS',\n  xfpeiyin: 'XFPeiYin',\n  azure: 'Azure TTS',\n  edgetts: 'Edge TTS',\n  google: 'Google TTS',\n  gemini: 'Gemini TTS',\n  weread: 'WeRead TTS',\n  aispeech: 'Aispeech',\n} as Record<string, string>;\n\nexport class NativeTTSClient implements TTSClient {\n  name = 'native-tts';\n  initialized = false;\n  controller?: TTSController;\n\n  #voices: TTSVoice[] = [];\n  #primaryLang = 'en';\n  #speakingLang = '';\n  #currentVoiceId = '';\n  #rate = 1.0;\n  #pitch = 1.0;\n\n  #eventListener: PluginListener | null = null;\n  #activeUtterances = new Map<\n    string,\n    {\n      eventQueue: TTSMessageEvent[];\n      resolver: ((value: IteratorResult<TTSMessageEvent>) => void) | null;\n      finished: boolean;\n    }\n  >();\n\n  constructor(controller?: TTSController) {\n    this.controller = controller;\n  }\n\n  private async setupEventListener(): Promise<void> {\n    try {\n      if (this.#eventListener) return;\n      this.#eventListener = await addPluginListener<TTSEventPayload>(\n        'native-tts',\n        'tts_events',\n        (event) => {\n          const { utteranceId, code, message, mark } = event;\n\n          const utteranceData = this.#activeUtterances.get(utteranceId);\n          if (!utteranceData) return;\n\n          const ttsEvent: TTSMessageEvent = { code, message, mark };\n          utteranceData.eventQueue.push(ttsEvent);\n          if (code === 'end' || code === 'error') {\n            utteranceData.finished = true;\n            if (utteranceData.resolver) {\n              utteranceData.resolver({ value: undefined, done: true });\n            }\n          } else if (utteranceData.resolver) {\n            utteranceData.resolver({ value: ttsEvent, done: false });\n            utteranceData.resolver = null;\n          }\n        },\n      );\n    } catch (error) {\n      console.error('Failed to setup TTS event listener:', error);\n    }\n  }\n\n  async init(): Promise<boolean> {\n    const result = await invoke<{ success: boolean }>('plugin:native-tts|init');\n    this.initialized = result.success;\n    if (this.initialized) {\n      this.setupEventListener();\n    }\n    return this.initialized;\n  }\n\n  async *speakMark(mark: TTSMark, preload: boolean, signal: AbortSignal) {\n    if (preload) {\n      yield { code: 'end', message: 'Dummy preload finished' } as TTSMessageEvent;\n      return;\n    }\n    const { language: voiceLang } = mark;\n    const voiceId = await this.getVoiceIdFromLang(voiceLang);\n    this.#currentVoiceId = voiceId;\n    this.#speakingLang = voiceLang;\n    await this.setVoice(voiceId);\n    try {\n      const result = await invoke<{ utteranceId: string }>('plugin:native-tts|speak', {\n        payload: { text: mark.text, preload },\n      });\n\n      const utteranceId = result.utteranceId;\n      this.#activeUtterances.set(utteranceId, {\n        eventQueue: [],\n        resolver: null,\n        finished: false,\n      });\n\n      const abortHandler = () => {\n        const utteranceData = this.#activeUtterances.get(utteranceId);\n        if (utteranceData && utteranceData.resolver) {\n          const error = { code: 'error', message: 'Aborted' } as TTSMessageEvent;\n          utteranceData.resolver({ value: error, done: true });\n          utteranceData.resolver = null;\n        }\n        this.stop();\n      };\n\n      signal.addEventListener('abort', abortHandler);\n\n      try {\n        while (true) {\n          const utteranceData = this.#activeUtterances.get(utteranceId);\n          if (!utteranceData) break;\n\n          if (utteranceData.eventQueue.length > 0) {\n            const event = utteranceData.eventQueue.shift()!;\n            event.mark = mark.name;\n            yield event;\n\n            if (event.code === 'end' || event.code === 'error') {\n              break;\n            }\n          } else if (utteranceData.finished) {\n            break;\n          } else {\n            const eventPromise = new Promise<TTSMessageEvent | void>((resolve) => {\n              const utteranceData = this.#activeUtterances.get(utteranceId);\n              if (!utteranceData) return resolve();\n              utteranceData.resolver = (res) =>\n                resolve(res.value?.code === 'error' ? res.value : undefined);\n            });\n            const timeoutPromise = new Promise<null>((resolve) =>\n              setTimeout(() => resolve(null), 100),\n            );\n            const result = await Promise.race([eventPromise, timeoutPromise]);\n            if (result) yield result;\n          }\n\n          if (signal.aborted) {\n            break;\n          }\n        }\n      } finally {\n        signal.removeEventListener('abort', abortHandler);\n        this.#activeUtterances.delete(utteranceId);\n      }\n    } catch (error) {\n      console.error('Failed to speak:', error);\n      throw error;\n    }\n  }\n\n  async *speak(ssml: string, signal: AbortSignal, preload: boolean = false) {\n    const { marks } = parseSSMLMarks(ssml, this.#primaryLang);\n\n    for (const mark of marks) {\n      this.controller?.dispatchSpeakMark(mark);\n      for await (const ev of this.speakMark(mark, preload, signal)) {\n        if (signal.aborted) {\n          yield { code: 'error', message: 'Aborted' } as TTSMessageEvent;\n          return;\n        }\n        yield ev;\n      }\n    }\n  }\n\n  async getVoiceIdFromLang(lang: string) {\n    const preferredVoiceId = TTSUtils.getPreferredVoice(this.name, lang);\n    const preferredVoice = this.#voices.find((v) => v.id === preferredVoiceId);\n    const defaultVoice = preferredVoice\n      ? preferredVoice\n      : (await this.getVoices(lang))[0]?.voices[0] || null;\n    return defaultVoice?.id || '';\n  }\n\n  async pause() {\n    await invoke('plugin:native-tts|pause');\n    return false;\n  }\n\n  async resume() {\n    // No-op for Android TextToSpeech\n    await invoke('plugin:native-tts|resume');\n    return false;\n  }\n\n  async stop() {\n    await invoke('plugin:native-tts|stop');\n    this.#activeUtterances.clear();\n  }\n\n  async setRate(rate: number) {\n    // Power the rate to match the EdgeTTS behavior\n    this.#rate = parseFloat(Math.pow(rate, 2.5).toFixed(2));\n    await invoke('plugin:native-tts|set_rate', { payload: { rate: this.#rate } });\n  }\n\n  async setPitch(pitch: number) {\n    this.#pitch = pitch;\n    await invoke('plugin:native-tts|set_pitch', { payload: { pitch: this.#pitch } });\n  }\n\n  async setVoice(voice: string) {\n    this.#currentVoiceId = voice;\n    await invoke('plugin:native-tts|set_voice', { payload: { voice } });\n  }\n\n  async getAllVoices() {\n    if (this.#voices.length > 0) {\n      return this.#voices;\n    }\n    try {\n      const result = await invoke<{ voices: TTSVoice[] }>('plugin:native-tts|get_all_voices');\n      this.#voices = result.voices;\n      return this.#voices;\n    } catch (error) {\n      console.error('Failed to get all voices:', error);\n      return [];\n    }\n  }\n\n  async getVoices(lang: string) {\n    const locale = lang === 'en' ? getUserLocale(lang) || lang : lang;\n    const voices = await this.getAllVoices();\n    const filteredVoices = voices.filter(\n      (v) => v.lang.startsWith(locale) || (lang === 'en' && ['en-US', 'en-GB'].includes(v.lang)),\n    );\n    const voiceGroups = new Map<string, TTSVoice[]>();\n    filteredVoices.forEach((voice) => {\n      const { name, lang } = voice;\n      let groupId = voice.id.split('_')[0]!;\n      if (groupId in TTSEngines) {\n        voice.name = name\n          .replace(`${groupId}_`, '')\n          .replace(`${lang}-`, '')\n          .replace('Neural', '')\n          .trim();\n      } else {\n        groupId = 'default';\n      }\n      voice.name = voice.name.replace('NOT_SET', _('Default'));\n      if (!voiceGroups.has(groupId)) {\n        voiceGroups.set(groupId, []);\n      }\n      voiceGroups.get(groupId)!.push(voice);\n    });\n\n    return Array.from(voiceGroups.entries())\n      .map(\n        ([groupId, voices]) =>\n          ({\n            id: groupId,\n            name: TTSEngines[groupId] || groupId,\n            voices: voices.sort(TTSUtils.sortVoicesFunc),\n            disabled: !this.initialized || voices.length === 0,\n          }) as TTSVoicesGroup,\n      )\n      .sort((a, b) => {\n        if (a.id === 'default') return -1;\n        if (b.id === 'default') return 1;\n        return a.id.localeCompare(b.id);\n      });\n  }\n\n  setPrimaryLang(lang: string) {\n    this.#primaryLang = lang;\n  }\n\n  getGranularities(): TTSGranularity[] {\n    return ['sentence'];\n  }\n\n  getVoiceId() {\n    return this.#currentVoiceId;\n  }\n\n  getSpeakingLang() {\n    return this.#speakingLang;\n  }\n\n  async shutdown() {\n    if (this.#eventListener) {\n      this.#eventListener.unregister();\n      this.#eventListener = null;\n    }\n    await this.stop();\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4011, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/tts/TTSController.ts"],"sourcesContent":["import { FoliateView } from '@/types/view';\nimport { AppService } from '@/types/system';\nimport { filterSSMLWithLang, parseSSMLMarks } from '@/utils/ssml';\nimport { Overlayer } from 'foliate-js/overlayer.js';\nimport { TTSGranularity, TTSHighlightOptions, TTSMark, TTSVoice } from './types';\nimport { createRejectFilter } from '@/utils/node';\nimport { WebSpeechClient } from './WebSpeechClient';\nimport { NativeTTSClient } from './NativeTTSClient';\nimport { EdgeTTSClient } from './EdgeTTSClient';\nimport { TTSUtils } from './TTSUtils';\nimport { TTSClient } from './TTSClient';\n\ntype TTSState =\n  | 'stopped'\n  | 'playing'\n  | 'paused'\n  | 'stop-paused'\n  | 'backward-paused'\n  | 'forward-paused'\n  | 'setrate-paused'\n  | 'setvoice-paused';\n\nconst HIGHLIGHT_KEY = 'tts-highlight';\n\nexport class TTSController extends EventTarget {\n  appService: AppService | null = null;\n  view: FoliateView;\n  isAuthenticated: boolean = false;\n  preprocessCallback?: (ssml: string) => Promise<string>;\n  #nossmlCnt: number = 0;\n  #currentSpeakAbortController: AbortController | null = null;\n  #currentSpeakPromise: Promise<void> | null = null;\n\n  state: TTSState = 'stopped';\n  ttsLang: string = '';\n  ttsRate: number = 1.0;\n  ttsClient: TTSClient;\n  ttsWebClient: TTSClient;\n  ttsEdgeClient: TTSClient;\n  ttsNativeClient: TTSClient | null = null;\n  ttsWebVoices: TTSVoice[] = [];\n  ttsEdgeVoices: TTSVoice[] = [];\n  ttsNativeVoices: TTSVoice[] = [];\n  ttsTargetLang: string = '';\n\n  options: TTSHighlightOptions = { style: 'highlight', color: 'gray' };\n\n  constructor(\n    appService: AppService | null,\n    view: FoliateView,\n    isAuthenticated: boolean = false,\n    preprocessCallback?: (ssml: string) => Promise<string>,\n  ) {\n    super();\n    this.ttsWebClient = new WebSpeechClient(this);\n    this.ttsEdgeClient = new EdgeTTSClient(this);\n    // TODO: implement native TTS client for iOS and PC\n    if (appService?.isAndroidApp) {\n      this.ttsNativeClient = new NativeTTSClient(this);\n    }\n    this.ttsClient = this.ttsWebClient;\n    this.appService = appService;\n    this.view = view;\n    this.isAuthenticated = isAuthenticated;\n    this.preprocessCallback = preprocessCallback;\n  }\n\n  async init() {\n    const availableClients = [];\n    if (await this.ttsEdgeClient.init()) {\n      availableClients.push(this.ttsEdgeClient);\n    }\n    if (this.ttsNativeClient && (await this.ttsNativeClient.init())) {\n      availableClients.push(this.ttsNativeClient);\n      this.ttsNativeVoices = await this.ttsNativeClient.getAllVoices();\n    }\n    if (await this.ttsWebClient.init()) {\n      availableClients.push(this.ttsWebClient);\n    }\n    this.ttsClient = availableClients[0] || this.ttsWebClient;\n    const preferredClientName = TTSUtils.getPreferredClient();\n    if (preferredClientName) {\n      const preferredClient = availableClients.find(\n        (client) => client.name === preferredClientName,\n      );\n      if (preferredClient) {\n        this.ttsClient = preferredClient;\n      }\n    }\n    this.ttsWebVoices = await this.ttsWebClient.getAllVoices();\n    this.ttsEdgeVoices = await this.ttsEdgeClient.getAllVoices();\n  }\n\n  #getHighlighter() {\n    return (range: Range) => {\n      const { overlayer } = this.view.renderer.getContents()[0] as { overlayer: Overlayer };\n      const { style, color } = this.options;\n      overlayer?.remove(HIGHLIGHT_KEY);\n      overlayer?.add(HIGHLIGHT_KEY, range, Overlayer[style], { color });\n    };\n  }\n\n  #clearHighlighter() {\n    const { overlayer } = (this.view.renderer.getContents()?.[0] || {}) as { overlayer: Overlayer };\n    overlayer?.remove(HIGHLIGHT_KEY);\n  }\n\n  async initViewTTS(options?: TTSHighlightOptions) {\n    if (options) {\n      this.options.style = options.style;\n      this.options.color = options.color;\n    }\n    let granularity: TTSGranularity = this.view.language.isCJK ? 'sentence' : 'word';\n    const supportedGranularities = this.ttsClient.getGranularities();\n    if (!supportedGranularities.includes(granularity)) {\n      granularity = supportedGranularities[0]!;\n    }\n    await this.view.initTTS(\n      granularity,\n      createRejectFilter({\n        tags: ['rt'],\n        contents: [{ tag: 'a', content: /^[\\[\\(]?[\\*\\d]+[\\)\\]]?$/ }],\n      }),\n      this.#getHighlighter(),\n    );\n  }\n\n  async preloadSSML(ssml: string | undefined, signal: AbortSignal) {\n    if (!ssml) return;\n    const iter = await this.ttsClient.speak(ssml, signal, true);\n    for await (const _ of iter);\n  }\n\n  async preloadNextSSML(count: number = 4) {\n    const tts = this.view.tts;\n    if (!tts) return;\n    let preloaded = 0;\n    for (let i = 0; i < count; i++) {\n      const ssml = await this.#preprocessSSML(tts.next());\n      this.preloadSSML(ssml, new AbortController().signal);\n      if (ssml) preloaded++;\n    }\n    for (let i = 0; i < preloaded; i++) {\n      tts.prev();\n    }\n  }\n\n  async #preprocessSSML(ssml?: string) {\n    if (!ssml) return;\n    ssml = ssml\n      .replace(/<emphasis[^>]*>([^<]+)<\\/emphasis>/g, '$1')\n      .replace(/[–—]/g, ',')\n      .replace('<break/>', ' ')\n      .replace(/\\.{3,}/g, '   ')\n      .replace(/……/g, '  ')\n      .replace(/\\*/g, ' ')\n      .replace(/·/g, ' ');\n\n    if (this.ttsTargetLang) {\n      ssml = filterSSMLWithLang(ssml, this.ttsTargetLang);\n    }\n\n    if (this.preprocessCallback) {\n      ssml = await this.preprocessCallback(ssml);\n    }\n\n    return ssml;\n  }\n\n  async #speak(ssml: string | undefined | Promise<string>, oneTime = false) {\n    await this.stop();\n    this.#currentSpeakAbortController = new AbortController();\n    const { signal } = this.#currentSpeakAbortController;\n\n    this.#currentSpeakPromise = new Promise(async (resolve, reject) => {\n      try {\n        console.log('TTS speak');\n        this.state = 'playing';\n\n        signal.addEventListener('abort', () => {\n          resolve();\n        });\n\n        ssml = await this.#preprocessSSML(await ssml);\n        if (!ssml) {\n          this.#nossmlCnt++;\n          // FIXME: in case we are at the end of the book, need a better way to handle this\n          if (this.#nossmlCnt < 10 && this.state === 'playing' && !oneTime) {\n            resolve();\n            await this.view.next();\n            await this.forward();\n          }\n          console.log('no SSML, skipping for', this.#nossmlCnt);\n          return;\n        } else {\n          this.#nossmlCnt = 0;\n        }\n\n        const { plainText, marks } = parseSSMLMarks(ssml);\n        if ((!plainText || marks.length === 0) && !oneTime) {\n          resolve();\n          return await this.forward();\n        } else {\n          this.dispatchSpeakMark(marks[0]);\n        }\n        await this.preloadSSML(ssml, signal);\n        const iter = await this.ttsClient.speak(ssml, signal);\n        let lastCode;\n        for await (const { code } of iter) {\n          if (signal.aborted) {\n            resolve();\n            return;\n          }\n          lastCode = code;\n        }\n\n        if (lastCode === 'end' && this.state === 'playing' && !oneTime) {\n          resolve();\n          await this.forward();\n        }\n        resolve();\n      } catch (e) {\n        if (signal.aborted) {\n          resolve();\n        } else {\n          reject(e);\n        }\n      } finally {\n        if (this.#currentSpeakAbortController) {\n          this.#currentSpeakAbortController.abort();\n          this.#currentSpeakAbortController = null;\n        }\n      }\n    });\n\n    await this.#currentSpeakPromise.catch((e) => this.error(e));\n  }\n\n  async speak(ssml: string | Promise<string>, oneTime = false) {\n    await this.initViewTTS();\n    this.#speak(ssml, oneTime).catch((e) => this.error(e));\n    this.preloadNextSSML();\n    this.dispatchSpeakMark();\n  }\n\n  play() {\n    if (this.state !== 'playing') {\n      this.start();\n    } else {\n      this.pause();\n    }\n  }\n\n  async start() {\n    await this.initViewTTS();\n    const ssml = this.state.includes('paused') ? this.view.tts?.resume() : this.view.tts?.start();\n    if (this.state.includes('paused')) {\n      this.resume();\n    }\n    this.#speak(ssml);\n    this.preloadNextSSML();\n  }\n\n  async pause() {\n    this.state = 'paused';\n    if (!(await this.ttsClient.pause().catch((e) => this.error(e)))) {\n      await this.stop();\n      this.state = 'stop-paused';\n    }\n  }\n\n  async resume() {\n    this.state = 'playing';\n    await this.ttsClient.resume().catch((e) => this.error(e));\n  }\n\n  async stop() {\n    if (this.#currentSpeakAbortController) {\n      this.#currentSpeakAbortController.abort();\n    }\n    await this.ttsClient.stop().catch((e) => this.error(e));\n\n    if (this.#currentSpeakPromise) {\n      const timeout = new Promise((_, reject) =>\n        setTimeout(() => reject(new Error('Stop operation timed out')), 3000),\n      );\n      await Promise.race([this.#currentSpeakPromise.catch((e) => this.error(e)), timeout]).catch(\n        (e) => this.error(e),\n      );\n      this.#currentSpeakPromise = null;\n    }\n    this.state = 'stopped';\n  }\n\n  // goto previous mark/paragraph\n  async backward(byMark = false) {\n    await this.initViewTTS();\n    if (this.state === 'playing') {\n      await this.stop();\n      if (byMark) this.#speak(this.view.tts?.prevMark());\n      else this.#speak(this.view.tts?.prev());\n    } else {\n      await this.stop();\n      this.state = 'backward-paused';\n      if (byMark) this.view.tts?.prevMark(true);\n      else this.view.tts?.prev(true);\n    }\n  }\n\n  // goto next mark/paragraph\n  async forward(byMark = false) {\n    await this.initViewTTS();\n    if (this.state === 'playing') {\n      await this.stop();\n      if (byMark) this.#speak(this.view.tts?.nextMark());\n      else {\n        this.#speak(this.view.tts?.next());\n        this.preloadNextSSML();\n      }\n    } else {\n      await this.stop();\n      this.state = 'forward-paused';\n      if (byMark) this.view.tts?.nextMark(true);\n      else this.view.tts?.next(true);\n    }\n  }\n\n  async setLang(lang: string) {\n    this.ttsLang = lang;\n    this.setPrimaryLang(lang);\n  }\n\n  async setPrimaryLang(lang: string) {\n    if (this.ttsEdgeClient.initialized) this.ttsEdgeClient.setPrimaryLang(lang);\n    if (this.ttsWebClient.initialized) this.ttsWebClient.setPrimaryLang(lang);\n    if (this.ttsNativeClient?.initialized) this.ttsNativeClient?.setPrimaryLang(lang);\n  }\n\n  async setRate(rate: number) {\n    this.state = 'setrate-paused';\n    this.ttsRate = rate;\n    await this.ttsClient.setRate(this.ttsRate);\n  }\n\n  async getVoices(lang: string) {\n    const ttsWebVoices = await this.ttsWebClient.getVoices(lang);\n    const ttsEdgeVoices = await this.ttsEdgeClient.getVoices(lang);\n    const ttsNativeVoices = (await this.ttsNativeClient?.getVoices(lang)) ?? [];\n\n    const voicesGroups = [...ttsNativeVoices, ...ttsEdgeVoices, ...ttsWebVoices];\n    return voicesGroups;\n  }\n\n  async setVoice(voiceId: string, lang: string) {\n    this.state = 'setvoice-paused';\n    const useEdgeTTS = !!this.ttsEdgeVoices.find(\n      (voice) => (voiceId === '' || voice.id === voiceId) && !voice.disabled,\n    );\n    const useNativeTTS = !!this.ttsNativeVoices.find(\n      (voice) => (voiceId === '' || voice.id === voiceId) && !voice.disabled,\n    );\n    if (useEdgeTTS) {\n      this.ttsClient = this.ttsEdgeClient;\n      await this.ttsClient.setRate(this.ttsRate);\n    } else if (useNativeTTS) {\n      if (!this.ttsNativeClient) {\n        throw new Error('Native TTS client is not available');\n      }\n      this.ttsClient = this.ttsNativeClient;\n      await this.ttsClient.setRate(this.ttsRate);\n    } else {\n      this.ttsClient = this.ttsWebClient;\n      await this.ttsClient.setRate(this.ttsRate);\n    }\n    TTSUtils.setPreferredClient(this.ttsClient.name);\n    TTSUtils.setPreferredVoice(this.ttsClient.name, lang, voiceId);\n    await this.ttsClient.setVoice(voiceId);\n  }\n\n  getVoiceId() {\n    return this.ttsClient.getVoiceId();\n  }\n\n  getSpeakingLang() {\n    return this.ttsClient.getSpeakingLang();\n  }\n\n  setTargetLang(lang: string) {\n    this.ttsTargetLang = lang;\n  }\n\n  dispatchSpeakMark(mark?: TTSMark) {\n    this.dispatchEvent(new CustomEvent('tts-speak-mark', { detail: mark || { text: '' } }));\n    if (mark) {\n      const range = this.view.tts?.setMark(mark.name);\n      this.dispatchEvent(new CustomEvent('tts-highlight-mark', { detail: range }));\n    }\n  }\n\n  error(e: unknown) {\n    console.error(e);\n    this.state = 'stopped';\n  }\n\n  async shutdown() {\n    await this.stop();\n    this.#clearHighlighter();\n    if (this.ttsWebClient.initialized) {\n      await this.ttsWebClient.shutdown();\n    }\n    if (this.ttsEdgeClient.initialized) {\n      await this.ttsEdgeClient.shutdown();\n    }\n    if (this.ttsNativeClient?.initialized) {\n      await this.ttsNativeClient.shutdown();\n    }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4389, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/services/tts/index.ts"],"sourcesContent":["export * from './types';\nexport * from './TTSClient';\nexport * from './WebSpeechClient';\nexport * from './EdgeTTSClient';\nexport * from './NativeTTSClient';\nexport * from './TTSController';\nexport * from './TTSData';\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA"}}]
}