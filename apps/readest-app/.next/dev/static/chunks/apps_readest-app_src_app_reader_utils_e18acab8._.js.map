{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/utils/iframeEventHandlers.ts"],"sourcesContent":["import { DOUBLE_CLICK_INTERVAL_THRESHOLD_MS, LONG_HOLD_THRESHOLD } from '@/services/constants';\nimport { eventDispatcher } from '@/utils/event';\n\nlet lastClickTime = 0;\nlet longHoldTimeout: ReturnType<typeof setTimeout> | null = null;\n\nlet keyboardState = {\n  key: '',\n  code: '',\n  ctrlKey: false,\n  shiftKey: false,\n  altKey: false,\n  metaKey: false,\n};\n\nconst getKeyStatus = (event?: MouseEvent | WheelEvent | TouchEvent) => {\n  if (event && 'ctrlKey' in event) {\n    return {\n      key: keyboardState.key,\n      code: keyboardState.code,\n      ctrlKey: event.ctrlKey,\n      shiftKey: event.shiftKey,\n      altKey: event.altKey,\n      metaKey: event.metaKey,\n    };\n  }\n  return {\n    ...keyboardState,\n  };\n};\n\nexport const handleKeydown = (bookKey: string, event: KeyboardEvent) => {\n  keyboardState = {\n    key: event.key,\n    code: event.code,\n    ctrlKey: event.ctrlKey,\n    shiftKey: event.shiftKey,\n    altKey: event.altKey,\n    metaKey: event.metaKey,\n  };\n\n  if (['Backspace'].includes(event.key)) {\n    event.preventDefault();\n  }\n  window.postMessage(\n    {\n      type: 'iframe-keydown',\n      bookKey,\n      key: event.key,\n      code: event.code,\n      ctrlKey: event.ctrlKey,\n      shiftKey: event.shiftKey,\n      altKey: event.altKey,\n      metaKey: event.metaKey,\n    },\n    '*',\n  );\n};\n\nexport const handleKeyup = (bookKey: string, event: KeyboardEvent) => {\n  keyboardState = {\n    key: '',\n    code: '',\n    ctrlKey: event.ctrlKey,\n    shiftKey: event.shiftKey,\n    altKey: event.altKey,\n    metaKey: event.metaKey,\n  };\n\n  window.postMessage(\n    {\n      type: 'iframe-keyup',\n      bookKey,\n      key: event.key,\n      code: event.code,\n      ctrlKey: event.ctrlKey,\n      shiftKey: event.shiftKey,\n      altKey: event.altKey,\n      metaKey: event.metaKey,\n    },\n    '*',\n  );\n};\n\nexport const handleMousedown = (bookKey: string, event: MouseEvent) => {\n  longHoldTimeout = setTimeout(() => {\n    longHoldTimeout = null;\n  }, LONG_HOLD_THRESHOLD);\n\n  window.postMessage(\n    {\n      type: 'iframe-mousedown',\n      bookKey,\n      button: event.button,\n      screenX: event.screenX,\n      screenY: event.screenY,\n      clientX: event.clientX,\n      clientY: event.clientY,\n      offsetX: event.offsetX,\n      offsetY: event.offsetY,\n      ...getKeyStatus(event),\n    },\n    '*',\n  );\n};\n\nexport const handleMouseup = (bookKey: string, event: MouseEvent) => {\n  // we will handle mouse back and forward buttons ourselves\n  if ([3, 4].includes(event.button)) {\n    event.preventDefault();\n  }\n  window.postMessage(\n    {\n      type: 'iframe-mouseup',\n      bookKey,\n      button: event.button,\n      screenX: event.screenX,\n      screenY: event.screenY,\n      clientX: event.clientX,\n      clientY: event.clientY,\n      offsetX: event.offsetX,\n      offsetY: event.offsetY,\n      ...getKeyStatus(event),\n    },\n    '*',\n  );\n};\n\nexport const handleWheel = (bookKey: string, event: WheelEvent) => {\n  window.postMessage(\n    {\n      type: 'iframe-wheel',\n      bookKey,\n      deltaMode: event.deltaMode,\n      deltaX: event.deltaX,\n      deltaY: event.deltaY,\n      deltaZ: event.deltaZ,\n      screenX: event.screenX,\n      screenY: event.screenY,\n      clientX: event.clientX,\n      clientY: event.clientY,\n      offsetX: event.offsetX,\n      offsetY: event.offsetY,\n      ...getKeyStatus(event),\n    },\n    '*',\n  );\n};\n\nexport const handleClick = (\n  bookKey: string,\n  doubleClickDisabled: React.MutableRefObject<boolean>,\n  event: MouseEvent,\n) => {\n  const now = Date.now();\n\n  if (!doubleClickDisabled.current && now - lastClickTime < DOUBLE_CLICK_INTERVAL_THRESHOLD_MS) {\n    lastClickTime = now;\n    window.postMessage(\n      {\n        type: 'iframe-double-click',\n        bookKey,\n        screenX: event.screenX,\n        screenY: event.screenY,\n        clientX: event.clientX,\n        clientY: event.clientY,\n        offsetX: event.offsetX,\n        offsetY: event.offsetY,\n        ...getKeyStatus(event),\n      },\n      '*',\n    );\n    return;\n  }\n\n  lastClickTime = now;\n\n  const postSingleClick = () => {\n    const element = event.target as HTMLElement | null;\n    if (\n      element?.closest('sup, a, audio, video') &&\n      !element?.closest('a.duokan-footnote:not([href])')\n    ) {\n      return;\n    }\n    const footnote = element?.closest('.js_readerFooterNote, .zhangyue-footnote, .duokan-footnote');\n    if (footnote) {\n      eventDispatcher.dispatch('footnote-popup', {\n        bookKey,\n        element: footnote,\n        footnote:\n          footnote.getAttribute('data-wr-footernote') ||\n          footnote.getAttribute('zy-footnote') ||\n          footnote.getAttribute('alt') ||\n          element?.getAttribute('alt') ||\n          '',\n      });\n      return;\n    }\n\n    // if long hold is detected, we don't want to send single click event\n    if (!longHoldTimeout) {\n      return;\n    }\n\n    window.postMessage(\n      {\n        type: 'iframe-single-click',\n        bookKey,\n        screenX: event.screenX,\n        screenY: event.screenY,\n        clientX: event.clientX,\n        clientY: event.clientY,\n        offsetX: event.offsetX,\n        offsetY: event.offsetY,\n        ...getKeyStatus(event),\n      },\n      '*',\n    );\n  };\n  if (!doubleClickDisabled.current) {\n    setTimeout(() => {\n      if (Date.now() - lastClickTime >= DOUBLE_CLICK_INTERVAL_THRESHOLD_MS) {\n        postSingleClick();\n      }\n    }, DOUBLE_CLICK_INTERVAL_THRESHOLD_MS);\n  } else {\n    postSingleClick();\n  }\n};\n\nconst handleTouchEv = (bookKey: string, event: TouchEvent, type: string) => {\n  const touch = event.targetTouches[0];\n  const touches = [];\n  if (touch) {\n    touches.push({\n      clientX: touch.clientX,\n      clientY: touch.clientY,\n      screenX: touch.screenX,\n      screenY: touch.screenY,\n    });\n  }\n  window.postMessage(\n    {\n      type: type,\n      bookKey,\n      timeStamp: Date.now(),\n      targetTouches: touches,\n      ...getKeyStatus(event),\n    },\n    '*',\n  );\n};\n\nexport const handleTouchStart = (bookKey: string, event: TouchEvent) => {\n  handleTouchEv(bookKey, event, 'iframe-touchstart');\n};\n\nexport const handleTouchMove = (bookKey: string, event: TouchEvent) => {\n  handleTouchEv(bookKey, event, 'iframe-touchmove');\n};\n\nexport const handleTouchEnd = (bookKey: string, event: TouchEvent) => {\n  handleTouchEv(bookKey, event, 'iframe-touchend');\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 246, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/utils/annotatorUtil.ts"],"sourcesContent":["import { HIGHLIGHT_COLOR_HEX } from '@/services/constants';\nimport { HighlightColor } from '@/types/book';\nimport { SystemSettings } from '@/types/settings';\n\nexport const getHighlightColorHex = (settings: SystemSettings, color?: HighlightColor) => {\n  if (!color) return color;\n\n  const customColors = settings.globalReadSettings.customHighlightColors;\n  return customColors?.[color] ?? HIGHLIGHT_COLOR_HEX[color];\n};\n"],"names":[],"mappings":";;;;AAAA;;AAIO,MAAM,uBAAuB,CAAC,UAA0B;IAC7D,IAAI,CAAC,OAAO,OAAO;IAEnB,MAAM,eAAe,SAAS,kBAAkB,CAAC,qBAAqB;IACtE,OAAO,cAAc,CAAC,MAAM,IAAI,yKAAmB,CAAC,MAAM;AAC5D"}}]
}