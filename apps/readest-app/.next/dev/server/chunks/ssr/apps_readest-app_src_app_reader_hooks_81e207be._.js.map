{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useBooksManager.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useState } from 'react';\nimport { useRouter, useSearchParams } from 'next/navigation';\nimport { useEnv } from '@/context/EnvContext';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { uniqueId } from '@/utils/misc';\nimport { useParallelViewStore } from '@/store/parallelViewStore';\nimport { navigateToReader } from '@/utils/nav';\n\nconst useBooksManager = () => {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const { envConfig } = useEnv();\n  const { bookKeys } = useReaderStore();\n  const { setBookKeys, initViewState } = useReaderStore();\n  const { sideBarBookKey, setSideBarBookKey } = useSidebarStore();\n  const [shouldUpdateSearchParams, setShouldUpdateSearchParams] = useState(false);\n  const { setParallel } = useParallelViewStore();\n\n  useEffect(() => {\n    if (shouldUpdateSearchParams) {\n      const ids = bookKeys.map((key) => key.split('-')[0]!);\n      if (ids) {\n        navigateToReader(router, ids, searchParams?.toString() || '', { scroll: false });\n      }\n      setShouldUpdateSearchParams(false);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKeys, shouldUpdateSearchParams]);\n\n  // Append a new book and sync with bookKeys and URL\n  const appendBook = (id: string, isPrimary: boolean, isParallel: boolean) => {\n    const newKey = `${id}-${uniqueId()}`;\n    initViewState(envConfig, id, newKey, isPrimary);\n    if (!bookKeys.includes(newKey)) {\n      const updatedKeys = [...bookKeys, newKey];\n      setBookKeys(updatedKeys);\n    }\n    if (isParallel) setParallel([sideBarBookKey!, newKey]);\n    setSideBarBookKey(newKey);\n    setShouldUpdateSearchParams(true);\n  };\n\n  // Close a book and sync with bookKeys and URL\n  const dismissBook = (bookKey: string) => {\n    const updatedKeys = bookKeys.filter((key) => key !== bookKey);\n    setBookKeys(updatedKeys);\n    setShouldUpdateSearchParams(true);\n  };\n\n  const getNextBookKey = (bookKey: string) => {\n    const index = bookKeys.findIndex((key) => key === bookKey);\n    const nextIndex = (index + 1) % bookKeys.length;\n    return bookKeys[nextIndex]!;\n  };\n\n  const openParallelView = (id: string) => {\n    const sideBarBookId = sideBarBookKey?.split('-')[0];\n    appendBook(id, sideBarBookId != id, true);\n  };\n\n  return {\n    bookKeys,\n    appendBook,\n    dismissBook,\n    getNextBookKey,\n    openParallelView,\n  };\n};\n\nexport default useBooksManager;\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AATA;;;;;;;;;AAWA,MAAM,kBAAkB;IACtB,MAAM,SAAS,IAAA,0SAAS;IACxB,MAAM,eAAe,IAAA,gTAAe;IACpC,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,0JAAM;IAC5B,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,gKAAc;IACnC,MAAM,EAAE,WAAW,EAAE,aAAa,EAAE,GAAG,IAAA,gKAAc;IACrD,MAAM,EAAE,cAAc,EAAE,iBAAiB,EAAE,GAAG,IAAA,kKAAe;IAC7D,MAAM,CAAC,0BAA0B,4BAA4B,GAAG,IAAA,+GAAQ,EAAC;IACzE,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,4KAAoB;IAE5C,IAAA,gHAAS,EAAC;QACR,IAAI,0BAA0B;YAC5B,MAAM,MAAM,SAAS,GAAG,CAAC,CAAC,MAAQ,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE;YACnD,IAAI,KAAK;gBACP,IAAA,0JAAgB,EAAC,QAAQ,KAAK,cAAc,cAAc,IAAI;oBAAE,QAAQ;gBAAM;YAChF;YACA,4BAA4B;QAC9B;IACA,uDAAuD;IACzD,GAAG;QAAC;QAAU;KAAyB;IAEvC,mDAAmD;IACnD,MAAM,aAAa,CAAC,IAAY,WAAoB;QAClD,MAAM,SAAS,GAAG,GAAG,CAAC,EAAE,IAAA,mJAAQ,KAAI;QACpC,cAAc,WAAW,IAAI,QAAQ;QACrC,IAAI,CAAC,SAAS,QAAQ,CAAC,SAAS;YAC9B,MAAM,cAAc;mBAAI;gBAAU;aAAO;YACzC,YAAY;QACd;QACA,IAAI,YAAY,YAAY;YAAC;YAAiB;SAAO;QACrD,kBAAkB;QAClB,4BAA4B;IAC9B;IAEA,8CAA8C;IAC9C,MAAM,cAAc,CAAC;QACnB,MAAM,cAAc,SAAS,MAAM,CAAC,CAAC,MAAQ,QAAQ;QACrD,YAAY;QACZ,4BAA4B;IAC9B;IAEA,MAAM,iBAAiB,CAAC;QACtB,MAAM,QAAQ,SAAS,SAAS,CAAC,CAAC,MAAQ,QAAQ;QAClD,MAAM,YAAY,CAAC,QAAQ,CAAC,IAAI,SAAS,MAAM;QAC/C,OAAO,QAAQ,CAAC,UAAU;IAC5B;IAEA,MAAM,mBAAmB,CAAC;QACxB,MAAM,gBAAgB,gBAAgB,MAAM,IAAI,CAAC,EAAE;QACnD,WAAW,IAAI,iBAAiB,IAAI;IACtC;IAEA,OAAO;QACL;QACA;QACA;QACA;QACA;IACF;AACF;uCAEe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/usePagination.ts"],"sourcesContent":["'use client';\n\nimport { useEffect } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { FoliateView } from '@/types/view';\nimport { ViewSettings } from '@/types/book';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useDeviceControlStore } from '@/store/deviceStore';\nimport { eventDispatcher } from '@/utils/event';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { tauriGetWindowLogicalPosition } from '@/utils/window';\n\nexport type ScrollSource = 'touch' | 'mouse';\n\ntype PaginationSide = 'left' | 'right' | 'up' | 'down';\ntype PaginationMode = 'pan' | 'page' | 'section';\n\nconst swapLeftRight = (side: PaginationSide) => {\n  if (side === 'left') return 'right';\n  if (side === 'right') return 'left';\n  return side;\n};\n\nconst isPanningView = (view: FoliateView | null, viewSettings: ViewSettings | null | undefined) => {\n  if (!view || !viewSettings) return false;\n  return (\n    view.book.rendition?.layout === 'pre-paginated' &&\n    (viewSettings.zoomLevel > 100 || viewSettings.zoomMode !== 'fit-page')\n  );\n};\n\nconst hasHorizontalPanning = (\n  view: FoliateView | null,\n  viewSettings: ViewSettings | null | undefined,\n) => {\n  if (!view || !viewSettings) return false;\n  return isPanningView(view, viewSettings) && view.isOverflowX();\n};\n\nconst hasVerticalPanning = (\n  view: FoliateView | null,\n  viewSettings: ViewSettings | null | undefined,\n) => {\n  if (!view || !viewSettings) return false;\n  return isPanningView(view, viewSettings) && view.isOverflowY();\n};\n\nexport const viewPagination = (\n  view: FoliateView | null,\n  viewSettings: ViewSettings | null | undefined,\n  side: PaginationSide,\n  mode: PaginationMode = 'page',\n  panDistance: number = 50,\n) => {\n  if (!view || !viewSettings) return;\n  const renderer = view.renderer;\n  if (view.book.dir === 'rtl') {\n    side = swapLeftRight(side);\n  }\n  if (renderer.scrolled) {\n    const { size } = renderer;\n    const showHeader = viewSettings.showHeader && viewSettings.showBarsOnScroll;\n    const showFooter = viewSettings.showFooter && viewSettings.showBarsOnScroll;\n    const scrollingOverlap = viewSettings.scrollingOverlap;\n    const distance = size - scrollingOverlap - (showHeader ? 44 : 0) - (showFooter ? 44 : 0);\n    switch (mode) {\n      case 'section':\n        if (side === 'left' || side === 'up') {\n          return view.renderer.prevSection?.();\n        } else {\n          return view.renderer.nextSection?.();\n        }\n      case 'pan':\n      case 'page':\n      default:\n        return side === 'left' || side === 'up' ? view.prev(distance) : view.next(distance);\n    }\n  } else if (mode === 'pan' && isPanningView(view, viewSettings)) {\n    if (hasHorizontalPanning(view, viewSettings) && (side === 'left' || side === 'right')) {\n      return view.pan(side === 'left' ? -panDistance : panDistance, 0);\n    } else if (hasVerticalPanning(view, viewSettings) && (side === 'up' || side === 'down')) {\n      return view.pan(0, side === 'up' ? -panDistance : panDistance);\n    } else {\n      return side === 'left' || side === 'up' ? view.prev() : view.next();\n    }\n  } else {\n    switch (mode) {\n      case 'section':\n        if (side === 'left' || side === 'up') {\n          return view.renderer.prevSection?.();\n        } else {\n          return view.renderer.nextSection?.();\n        }\n      case 'pan':\n      case 'page':\n      default:\n        return side === 'left' || side === 'up' ? view.prev() : view.next();\n    }\n  }\n};\n\nexport const usePagination = (\n  bookKey: string,\n  viewRef: React.MutableRefObject<FoliateView | null>,\n  containerRef: React.RefObject<HTMLDivElement>,\n) => {\n  const { appService } = useEnv();\n  const { getBookData } = useBookDataStore();\n  const { getViewSettings, getViewState } = useReaderStore();\n  const { hoveredBookKey, setHoveredBookKey } = useReaderStore();\n  const { acquireVolumeKeyInterception, releaseVolumeKeyInterception } = useDeviceControlStore();\n\n  const handlePageFlip = async (\n    msg: MessageEvent | CustomEvent | React.MouseEvent<HTMLDivElement, MouseEvent>,\n  ) => {\n    const viewState = getViewState(bookKey);\n    const bookData = getBookData(bookKey);\n    if (!viewState?.inited || !bookData) return;\n\n    if (msg instanceof MessageEvent) {\n      if (msg.data && msg.data.bookKey === bookKey) {\n        const viewSettings = getViewSettings(bookKey)!;\n        if (msg.data.type === 'iframe-single-click') {\n          const viewElement = containerRef.current;\n          if (viewElement) {\n            const { screenX } = msg.data;\n            const viewRect = viewElement.getBoundingClientRect();\n            let windowStartX;\n            // Currently for tauri APP the window.screenX is always 0\n            if (isTauriAppPlatform()) {\n              if (appService?.isMobile) {\n                windowStartX = 0;\n              } else {\n                const windowPosition = (await tauriGetWindowLogicalPosition()) as {\n                  x: number;\n                  y: number;\n                };\n                windowStartX = windowPosition.x;\n              }\n            } else {\n              windowStartX = window.screenX;\n            }\n            const viewStartX = windowStartX + viewRect.left;\n            const viewCenterX = viewStartX + viewRect.width / 2;\n            const consumed = eventDispatcher.dispatchSync('iframe-single-click');\n            if (!consumed) {\n              const centerStartX = viewStartX + viewRect.width * 0.375;\n              const centerEndX = viewStartX + viewRect.width * 0.625;\n              if (\n                viewSettings.disableClick! ||\n                (screenX >= centerStartX && screenX <= centerEndX)\n              ) {\n                // toggle visibility of the header bar and the footer bar\n                setHoveredBookKey(hoveredBookKey ? null : bookKey);\n              } else {\n                if (hoveredBookKey) {\n                  setHoveredBookKey(null);\n                  return;\n                }\n                if (!viewSettings.disableClick! && screenX >= viewCenterX) {\n                  if (viewSettings.fullscreenClickArea) {\n                    viewPagination(viewRef.current, viewSettings, 'down');\n                  } else if (viewSettings.swapClickArea) {\n                    viewPagination(viewRef.current, viewSettings, 'left');\n                  } else {\n                    viewPagination(viewRef.current, viewSettings, 'right');\n                  }\n                } else if (!viewSettings.disableClick! && screenX < viewCenterX) {\n                  if (viewSettings.fullscreenClickArea) {\n                    viewPagination(viewRef.current, viewSettings, 'down');\n                  } else if (viewSettings.swapClickArea) {\n                    viewPagination(viewRef.current, viewSettings, 'right');\n                  } else {\n                    viewPagination(viewRef.current, viewSettings, 'left');\n                  }\n                }\n              }\n            }\n          }\n        } else if (\n          msg.data.type === 'iframe-wheel' &&\n          !viewSettings.scrolled &&\n          !isPanningView(viewRef.current, viewSettings)\n        ) {\n          // The wheel event is handled by the iframe itself in scrolled mode.\n          const { deltaY } = msg.data;\n          if (deltaY > 0) {\n            viewRef.current?.next(1);\n          } else if (deltaY < 0) {\n            viewRef.current?.prev(1);\n          }\n        } else if (msg.data.type === 'iframe-mouseup') {\n          if (msg.data.button === 3) {\n            viewRef.current?.history.back();\n          } else if (msg.data.button === 4) {\n            viewRef.current?.history.forward();\n          }\n        }\n      }\n    } else if (msg instanceof CustomEvent) {\n      const viewSettings = getViewSettings(bookKey);\n      if (msg.type === 'native-key-down' && viewSettings?.volumeKeysToFlip) {\n        const { keyName } = msg.detail;\n        setHoveredBookKey('');\n        if (keyName === 'VolumeUp') {\n          viewPagination(viewRef.current, viewSettings, 'up');\n        } else if (keyName === 'VolumeDown') {\n          viewPagination(viewRef.current, viewSettings, 'down');\n        }\n      } else if (\n        msg.type === 'touch-swipe' &&\n        bookData.isFixedLayout &&\n        !isPanningView(viewRef.current, viewSettings)\n      ) {\n        const { deltaX, deltaY, deltaT } = msg.detail;\n        const vx = Math.abs(deltaX / deltaT);\n        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30 && vx > 0.2) {\n          if (deltaX > 0) {\n            viewPagination(viewRef.current, viewSettings, 'left');\n          } else {\n            viewPagination(viewRef.current, viewSettings, 'right');\n          }\n        }\n      }\n    } else {\n      if (msg.type === 'click') {\n        const { clientX } = msg;\n        const width = window.innerWidth;\n        const leftThreshold = width * 0.5;\n        const rightThreshold = width * 0.5;\n        const viewSettings = getViewSettings(bookKey);\n        if (clientX < leftThreshold) {\n          viewPagination(viewRef.current, viewSettings, 'left');\n        } else if (clientX > rightThreshold) {\n          viewPagination(viewRef.current, viewSettings, 'right');\n        }\n      }\n    }\n  };\n\n  const handleContinuousScroll = (mode: ScrollSource, scrollDelta: number, threshold: number) => {\n    const renderer = viewRef.current?.renderer;\n    const viewSettings = getViewSettings(bookKey)!;\n    const bookData = getBookData(bookKey)!;\n    // Currently continuous scroll is not supported in pre-paginated layout\n    if (bookData.bookDoc?.rendition?.layout === 'pre-paginated') return;\n\n    if (renderer && viewSettings.scrolled && viewSettings.continuousScroll) {\n      const doScroll = () => {\n        // may have overscroll where the start is greater than 0\n        if (renderer.start <= scrollDelta && scrollDelta > threshold) {\n          setTimeout(() => {\n            viewRef.current?.prev(renderer.start + 1);\n          }, 100);\n          // sometimes viewSize has subpixel value that the end never reaches\n        } else if (\n          Math.ceil(renderer.end) - scrollDelta >= renderer.viewSize &&\n          scrollDelta < -threshold\n        ) {\n          setTimeout(() => {\n            viewRef.current?.next(renderer.viewSize - Math.floor(renderer.end) + 1);\n          }, 100);\n        }\n      };\n      if (mode === 'mouse') {\n        // we can always get mouse wheel events\n        doScroll();\n      } else if (mode === 'touch') {\n        // when the document height is less than the viewport height, we can't get the relocate event\n        if (renderer.size >= renderer.viewSize) {\n          doScroll();\n        } else {\n          // scroll after the relocate event\n          renderer.addEventListener('relocate', () => doScroll(), { once: true });\n        }\n      }\n    }\n  };\n\n  useEffect(() => {\n    if (!appService?.isMobileApp) return;\n\n    const viewSettings = getViewSettings(bookKey);\n    if (viewSettings?.volumeKeysToFlip) {\n      acquireVolumeKeyInterception();\n    } else {\n      releaseVolumeKeyInterception();\n    }\n\n    eventDispatcher.on('native-key-down', handlePageFlip);\n    return () => {\n      releaseVolumeKeyInterception();\n      eventDispatcher.off('native-key-down', handlePageFlip);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  return {\n    handlePageFlip,\n    handleContinuousScroll,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 380, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useBookShortcuts.ts"],"sourcesContent":["'use client';\n\nimport { useEffect } from 'react';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useNotebookStore } from '@/store/notebookStore';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { getStyles } from '@/utils/style';\nimport { tauriHandleClose, tauriHandleToggleFullScreen, tauriQuitApp } from '@/utils/window';\nimport { eventDispatcher } from '@/utils/event';\nimport { MAX_ZOOM_LEVEL, MIN_ZOOM_LEVEL, ZOOM_STEP } from '@/services/constants';\nimport { viewPagination } from './usePagination';\nimport useShortcuts from '@/hooks/useShortcuts';\nimport useBooksManager from './useBooksManager';\n\ninterface UseBookShortcutsProps {\n  sideBarBookKey: string | null;\n  bookKeys: string[];\n}\n\nconst useBookShortcuts = ({ sideBarBookKey, bookKeys }: UseBookShortcutsProps) => {\n  const { getView, getViewState, getViewSettings, setViewSettings } = useReaderStore();\n  const { toggleSideBar, setSideBarBookKey } = useSidebarStore();\n  const { setSettingsDialogOpen } = useSettingsStore();\n  const { getBookData } = useBookDataStore();\n  const { toggleNotebook } = useNotebookStore();\n  const { getNextBookKey } = useBooksManager();\n  const viewSettings = getViewSettings(sideBarBookKey ?? '');\n  const fontSize = viewSettings?.defaultFontSize ?? 16;\n  const lineHeight = viewSettings?.lineHeight ?? 1.6;\n  const distance = fontSize * lineHeight * 3;\n\n  const toggleScrollMode = () => {\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    if (viewSettings && sideBarBookKey) {\n      viewSettings.scrolled = !viewSettings.scrolled;\n      setViewSettings(sideBarBookKey, viewSettings!);\n      const flowMode = viewSettings.scrolled ? 'scrolled' : 'paginated';\n      getView(sideBarBookKey)?.renderer.setAttribute('flow', flowMode);\n    }\n  };\n\n  const switchSideBar = () => {\n    if (sideBarBookKey) setSideBarBookKey(getNextBookKey(sideBarBookKey));\n  };\n\n  const goLeft = () => {\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    viewPagination(getView(sideBarBookKey), viewSettings, 'left', 'pan', distance);\n  };\n\n  const goRight = () => {\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    viewPagination(getView(sideBarBookKey), viewSettings, 'right', 'pan', distance);\n  };\n\n  const goUp = (event?: KeyboardEvent | MessageEvent) => {\n    const view = getView(sideBarBookKey);\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    if (view?.renderer.scrolled && event instanceof MessageEvent) return;\n    viewPagination(view, viewSettings, 'up', 'pan', distance);\n  };\n\n  const goDown = (event?: KeyboardEvent | MessageEvent) => {\n    const view = getView(sideBarBookKey);\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    if (view?.renderer.scrolled && event instanceof MessageEvent) return;\n    viewPagination(view, viewSettings, 'down', 'pan', distance);\n  };\n\n  const goPrevSection = () => {\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    viewPagination(getView(sideBarBookKey), viewSettings, 'up', 'section');\n  };\n\n  const goNextSection = () => {\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    viewPagination(getView(sideBarBookKey), viewSettings, 'down', 'section');\n  };\n\n  const goLeftSection = () => {\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    viewPagination(getView(sideBarBookKey), viewSettings, 'left', 'section');\n  };\n\n  const goRightSection = () => {\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    viewPagination(getView(sideBarBookKey), viewSettings, 'right', 'section');\n  };\n\n  const goPrev = () => {\n    getView(sideBarBookKey)?.prev(distance);\n  };\n\n  const goNext = () => {\n    getView(sideBarBookKey)?.next(distance);\n  };\n\n  const goBack = () => {\n    getView(sideBarBookKey)?.history.back();\n  };\n\n  const goHalfPageDown = () => {\n    const view = getView(sideBarBookKey);\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    if (view && viewSettings && viewSettings.scrolled) {\n      view.next(view.renderer.size / 2);\n    }\n  };\n\n  const goHalfPageUp = () => {\n    const view = getView(sideBarBookKey);\n    const viewSettings = getViewSettings(sideBarBookKey ?? '');\n    if (view && viewSettings && viewSettings.scrolled) {\n      view.prev(view.renderer.size / 2);\n    }\n  };\n\n  const goForward = () => {\n    getView(sideBarBookKey)?.history.forward();\n  };\n\n  const reloadPage = () => {\n    window.location.reload();\n  };\n\n  const toggleFullscreen = async () => {\n    if (isTauriAppPlatform()) {\n      await tauriHandleToggleFullScreen();\n    }\n  };\n\n  const closeWindow = async () => {\n    if (isTauriAppPlatform()) {\n      await tauriHandleClose();\n    }\n  };\n\n  const quitApp = async () => {\n    // on web platform use browser's default shortcut to close the tab\n    if (isTauriAppPlatform()) {\n      await tauriQuitApp();\n    }\n  };\n\n  const showSearchBar = () => {\n    setTimeout(() => {\n      eventDispatcher.dispatch('search-term', { term: null, bookKey: sideBarBookKey });\n    }, 100);\n  };\n\n  const applyZoomLevel = (zoomLevel: number) => {\n    if (!sideBarBookKey) return;\n    const view = getView(sideBarBookKey);\n    const bookData = getBookData(sideBarBookKey);\n    const viewSettings = getViewSettings(sideBarBookKey)!;\n    viewSettings!.zoomLevel = zoomLevel;\n    setViewSettings(sideBarBookKey, viewSettings!);\n    view?.renderer.setStyles?.(getStyles(viewSettings!));\n    if (bookData?.bookDoc?.rendition?.layout === 'pre-paginated') {\n      view?.renderer.setAttribute('scale-factor', zoomLevel);\n    }\n  };\n\n  const zoomInFactor = (factor = 1.0) => {\n    if (!sideBarBookKey) return;\n    const viewSettings = getViewSettings(sideBarBookKey)!;\n    const zoomLevel = viewSettings!.zoomLevel + ZOOM_STEP * factor;\n    applyZoomLevel(Math.min(zoomLevel, MAX_ZOOM_LEVEL));\n  };\n\n  const zoomOutFactor = (factor = 1.0) => {\n    if (!sideBarBookKey) return;\n    const viewSettings = getViewSettings(sideBarBookKey)!;\n    const zoomLevel = viewSettings!.zoomLevel - ZOOM_STEP * factor;\n    applyZoomLevel(Math.max(zoomLevel, MIN_ZOOM_LEVEL));\n  };\n\n  const zoomIn = () => {\n    zoomInFactor();\n  };\n\n  const zoomOut = () => {\n    zoomOutFactor();\n  };\n\n  const handleZoomIn = (event: CustomEvent) => {\n    const factor = event.detail?.factor || 1.0;\n    zoomInFactor(factor);\n  };\n\n  const handleZoomOut = (event: CustomEvent) => {\n    const factor = event.detail?.factor || 1.0;\n    zoomOutFactor(factor);\n  };\n\n  const resetZoom = () => {\n    if (!sideBarBookKey) return;\n    applyZoomLevel(100);\n  };\n\n  const toggleTTS = () => {\n    if (!sideBarBookKey) return;\n    const bookKey = sideBarBookKey;\n    const viewState = getViewState(bookKey);\n    eventDispatcher.dispatch(viewState?.ttsEnabled ? 'tts-stop' : 'tts-speak', { bookKey });\n  };\n\n  const toggleBookmark = () => {\n    if (!sideBarBookKey) return;\n    eventDispatcher.dispatch('toggle-bookmark', { bookKey: sideBarBookKey });\n  };\n\n  useEffect(() => {\n    eventDispatcher.on('zoom-in', handleZoomIn);\n    eventDispatcher.on('zoom-out', handleZoomOut);\n    eventDispatcher.on('reset-zoom', resetZoom);\n    return () => {\n      eventDispatcher.off('zoom-in', handleZoomIn);\n      eventDispatcher.off('zoom-out', handleZoomOut);\n      eventDispatcher.off('reset-zoom', resetZoom);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [sideBarBookKey]);\n\n  useShortcuts(\n    {\n      onSwitchSideBar: switchSideBar,\n      onToggleSideBar: toggleSideBar,\n      onToggleNotebook: toggleNotebook,\n      onToggleScrollMode: toggleScrollMode,\n      onToggleBookmark: toggleBookmark,\n      onOpenFontLayoutSettings: () => setSettingsDialogOpen(true),\n      onShowSearchBar: showSearchBar,\n      onToggleFullscreen: toggleFullscreen,\n      onToggleTTS: toggleTTS,\n      onReloadPage: reloadPage,\n      onCloseWindow: closeWindow,\n      onQuitApp: quitApp,\n      onGoLeft: goLeft,\n      onGoRight: goRight,\n      onGoUp: goUp,\n      onGoDown: goDown,\n      onGoPrev: goPrev,\n      onGoNext: goNext,\n      onGoHalfPageDown: goHalfPageDown,\n      onGoHalfPageUp: goHalfPageUp,\n      onGoPrevSection: goPrevSection,\n      onGoNextSection: goNextSection,\n      onGoLeftSection: goLeftSection,\n      onGoRightSection: goRightSection,\n      onGoBack: goBack,\n      onGoForward: goForward,\n      onZoomIn: zoomIn,\n      onZoomOut: zoomOut,\n      onResetZoom: resetZoom,\n    },\n    [sideBarBookKey, bookKeys],\n  );\n};\n\nexport default useBookShortcuts;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 649, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useTextTranslation.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport { FoliateView } from '@/types/view';\nimport { UseTranslatorOptions } from '@/services/translators';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useTranslator } from '@/hooks/useTranslator';\nimport { walkTextNodes } from '@/utils/walk';\nimport { debounce } from '@/utils/debounce';\nimport { getLocale } from '@/utils/misc';\n\nexport function useTextTranslation(\n  bookKey: string,\n  view: FoliateView | HTMLElement | null,\n  widthLineBreak = false,\n  targetBlockClassName = 'translation-target-block',\n) {\n  const { getViewSettings, getProgress } = useReaderStore();\n  const viewSettings = getViewSettings(bookKey);\n  const progress = getProgress(bookKey);\n\n  const enabled = useRef(viewSettings?.translationEnabled);\n  const [provider, setProvider] = useState(viewSettings?.translationProvider);\n  const [targetLang, setTargetLang] = useState(viewSettings?.translateTargetLang);\n  const showTranslateSourceRef = useRef(viewSettings?.showTranslateSource);\n\n  const { translate } = useTranslator({\n    provider,\n    targetLang: targetLang || getLocale(),\n  } as UseTranslatorOptions);\n\n  const translateRef = useRef(translate);\n  const observerRef = useRef<IntersectionObserver | null>(null);\n  const translatedElements = useRef<HTMLElement[]>([]);\n  const allTextNodes = useRef<HTMLElement[]>([]);\n\n  const toggleTranslationVisibility = (visible: boolean) => {\n    translatedElements.current.forEach((element) => {\n      const translationTargets = element.querySelectorAll('.translation-target');\n      translationTargets.forEach((target) => {\n        if (visible) {\n          target.classList.remove('hidden');\n        } else {\n          target.classList.add('hidden');\n        }\n      });\n    });\n  };\n\n  useEffect(() => {\n    translateRef.current = translate;\n  }, [translate]);\n\n  const observeTextNodes = () => {\n    if (!view || !enabled.current) return;\n    const observer = createTranslationObserver();\n    observerRef.current = observer;\n    const nodes = walkTextNodes(view, ['pre', 'code', 'math']);\n    console.log(\n      'Observing text nodes for translation:',\n      nodes.length,\n      // nodes.map((n) => n.textContent),\n    );\n    allTextNodes.current = nodes;\n    nodes.forEach((el) => observer.observe(el));\n  };\n\n  const updateTranslation = () => {\n    translatedElements.current.forEach((element) => {\n      const translationTargets = element.querySelectorAll('.translation-target');\n      translationTargets.forEach((target) => target.remove());\n    });\n\n    translatedElements.current = [];\n    if (viewSettings?.translationEnabled && view) {\n      recreateTranslationObserver();\n    }\n  };\n\n  const createTranslationObserver = () => {\n    return new IntersectionObserver(\n      (entries) => {\n        let beforeIntersectedElement: HTMLElement | null = null;\n        let lastIntersectedElement: HTMLElement | null = null;\n        for (const entry of entries) {\n          if (!entry.isIntersecting) {\n            if (!lastIntersectedElement) {\n              beforeIntersectedElement = entry.target as HTMLElement;\n            }\n            continue;\n          }\n          const currentElement = entry.target as HTMLElement;\n          translateElement(currentElement);\n          lastIntersectedElement = currentElement;\n        }\n        if (beforeIntersectedElement) {\n          translateElement(beforeIntersectedElement);\n        }\n        if (lastIntersectedElement) {\n          preTranslateNextElements(lastIntersectedElement, 2);\n        }\n      },\n      {\n        rootMargin: '1280px',\n        threshold: 0,\n      },\n    );\n  };\n\n  const preTranslateNextElements = (currentElement: HTMLElement, count: number) => {\n    if (!allTextNodes.current || count <= 0) return;\n    const currentIndex = allTextNodes.current.indexOf(currentElement);\n    if (currentIndex === -1) {\n      return;\n    }\n\n    const nextElements = allTextNodes.current.slice(currentIndex + 1, currentIndex + 1 + count);\n    nextElements.forEach((element, index) => {\n      setTimeout(() => {\n        translateElement(element);\n      }, index * 500);\n    });\n  };\n\n  const recreateTranslationObserver = () => {\n    const observer = createTranslationObserver();\n    observerRef.current?.disconnect();\n    observerRef.current = observer;\n    allTextNodes.current.forEach((el) => observer.observe(el));\n  };\n\n  const translateElement = async (el: HTMLElement) => {\n    if (!enabled.current) return;\n    const text = el.textContent?.replaceAll('\\n', '').trim();\n    if (!text) return;\n\n    if (el.classList.contains('translation-target')) {\n      return;\n    }\n\n    const updateSourceNodes = (element: HTMLElement) => {\n      const hasDirectText = Array.from(element.childNodes).some(\n        (node) => node.nodeType === Node.TEXT_NODE && node.textContent?.trim() !== '',\n      );\n      if (hasDirectText) {\n        element.classList.add('translation-source');\n\n        const textNodes = Array.from(element.childNodes).filter(\n          (node) => node.nodeType === Node.TEXT_NODE && node.textContent?.trim() !== '',\n        );\n\n        if (!element.hasAttribute('original-text-stored')) {\n          element.setAttribute(\n            'original-text-nodes',\n            JSON.stringify(textNodes.map((node) => node.textContent)),\n          );\n          element.setAttribute('original-text-stored', 'true');\n        }\n      }\n      const isSource = element.classList.contains('translation-source');\n      if (isSource) {\n        const textNodes = Array.from(element.childNodes).filter(\n          (node) => node.nodeType === Node.TEXT_NODE,\n        ) as Text[];\n\n        if (showTranslateSourceRef.current) {\n          const originalTexts = JSON.parse(element.getAttribute('original-text-nodes') || '[]');\n          textNodes.forEach((textNode, index) => {\n            if (originalTexts[index] !== undefined) {\n              textNode.textContent = originalTexts[index];\n            }\n          });\n        } else {\n          textNodes.forEach((textNode) => {\n            textNode.textContent = '';\n          });\n        }\n      }\n      for (const child of Array.from(element.childNodes)) {\n        if (child.nodeType !== Node.ELEMENT_NODE) continue;\n        const node = child as HTMLElement;\n        if (!node.classList.contains('translation-target')) {\n          updateSourceNodes(node);\n        }\n      }\n    };\n\n    updateSourceNodes(el);\n\n    try {\n      const translated = await translateRef.current([text]);\n      const translatedText = translated[0];\n      if (!translatedText || text === translatedText) return;\n\n      const wrapper = document.createElement('font');\n      wrapper.className = `translation-target ${!enabled.current ? 'hidden' : ''}`;\n      wrapper.setAttribute('translation-element-mark', '1');\n      wrapper.setAttribute('lang', targetLang || getLocale());\n      if (widthLineBreak) {\n        wrapper.appendChild(document.createElement('br'));\n      }\n\n      const blockWrapper = document.createElement('font');\n      blockWrapper.className = `translation-target ${targetBlockClassName}`;\n\n      const inner = document.createElement('font');\n      inner.className = 'translation-target target-inner target-inner-theme-none';\n      inner.textContent = translatedText;\n\n      blockWrapper.appendChild(inner);\n      wrapper.appendChild(blockWrapper);\n\n      if (el.querySelector('.translation-target')) {\n        return;\n      }\n      el.appendChild(wrapper);\n      translatedElements.current.push(el);\n    } catch (err) {\n      console.warn('Translation failed:', err);\n    }\n  };\n\n  const findNodeIndicesInRange = (range: Range, nodes: HTMLElement[]) => {\n    const startContainer = range.startContainer;\n    const endContainer = range.endContainer;\n\n    let startIndex = -1;\n    let endIndex = -1;\n    for (let i = 0; i < nodes.length; i++) {\n      const node = nodes[i]!;\n      if (node === startContainer || node.contains(startContainer)) {\n        if (startIndex === -1) startIndex = i;\n      }\n      if (node === endContainer || node.contains(endContainer)) {\n        endIndex = i;\n      }\n    }\n    if (startIndex !== -1 && endIndex === -1) {\n      endIndex = startIndex;\n    }\n\n    return { startIndex, endIndex };\n  };\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const translateInRange = useCallback(\n    debounce((range: Range) => {\n      const nodes = allTextNodes.current;\n      if (nodes.length === 0) {\n        console.warn('No text nodes available for translation.');\n        return;\n      }\n      const { startIndex, endIndex } = findNodeIndicesInRange(range, nodes);\n      if (startIndex === -1) {\n        console.log('Range not found in text nodes');\n        return;\n      }\n      const beforeContext = 2;\n      const afterContext = 5;\n      const beforeStart = Math.max(0, startIndex - beforeContext);\n      const afterEnd = Math.min(nodes.length - 1, endIndex + afterContext);\n      for (let i = beforeStart; i <= afterEnd; i++) {\n        const node = nodes[i];\n        if (node) {\n          translateElement(node);\n        }\n      }\n    }, 500),\n    [translateElement],\n  );\n\n  useEffect(() => {\n    if (enabled.current && progress) {\n      const { range } = progress;\n      translateInRange(range);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [progress]);\n\n  useEffect(() => {\n    if (!viewSettings) return;\n\n    const enabledChanged = enabled.current !== viewSettings.translationEnabled;\n    const providerChanged = provider !== viewSettings.translationProvider;\n    const targetLangChanged = targetLang !== viewSettings.translateTargetLang;\n    const showTranslateSourceChanged =\n      showTranslateSourceRef.current !== viewSettings.showTranslateSource;\n\n    if (enabledChanged) {\n      enabled.current = viewSettings.translationEnabled;\n    }\n\n    if (providerChanged) {\n      setProvider(viewSettings.translationProvider);\n    }\n\n    if (targetLangChanged) {\n      setTargetLang(viewSettings.translateTargetLang);\n    }\n\n    if (showTranslateSourceChanged) {\n      showTranslateSourceRef.current = viewSettings.showTranslateSource;\n    }\n\n    if (enabledChanged) {\n      toggleTranslationVisibility(viewSettings.translationEnabled);\n      if (enabled.current) {\n        observeTextNodes();\n      }\n    } else if (providerChanged || targetLangChanged || showTranslateSourceChanged) {\n      updateTranslation();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey, viewSettings, provider, targetLang]);\n\n  useEffect(() => {\n    if (!view || !enabled.current) return;\n\n    if ('renderer' in view) {\n      view.addEventListener('load', observeTextNodes);\n    } else {\n      observeTextNodes();\n    }\n    return () => {\n      if ('renderer' in view) {\n        view.removeEventListener('load', observeTextNodes);\n      }\n      observerRef.current?.disconnect();\n      translatedElements.current = [];\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [view]);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 956, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useScrollToItem.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useMemo, useRef } from 'react';\nimport { BookProgress } from '@/types/book';\nimport { isCfiInLocation } from '@/utils/cfi';\n\nconst useScrollToItem = (cfi: string, progress: BookProgress | null) => {\n  const viewRef = useRef<HTMLLIElement | null>(null);\n\n  const isCurrent = useMemo(() => isCfiInLocation(cfi, progress?.location), [cfi, progress]);\n\n  useEffect(() => {\n    if (!viewRef.current || !isCurrent) return;\n\n    // Scroll to the item if it's the current one and not visible\n    const element = viewRef.current;\n    const rect = element.getBoundingClientRect();\n    const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;\n\n    if (!isVisible) {\n      element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    }\n\n    element.setAttribute('aria-current', 'page');\n  }, [isCurrent]);\n\n  return { isCurrent, viewRef };\n};\n\nexport default useScrollToItem;\n"],"names":[],"mappings":";;;;AAEA;AAEA;AAJA;;;AAMA,MAAM,kBAAkB,CAAC,KAAa;IACpC,MAAM,UAAU,IAAA,6GAAM,EAAuB;IAE7C,MAAM,YAAY,IAAA,8GAAO,EAAC,IAAM,IAAA,yJAAe,EAAC,KAAK,UAAU,WAAW;QAAC;QAAK;KAAS;IAEzF,IAAA,gHAAS,EAAC;QACR,IAAI,CAAC,QAAQ,OAAO,IAAI,CAAC,WAAW;QAEpC,6DAA6D;QAC7D,MAAM,UAAU,QAAQ,OAAO;QAC/B,MAAM,OAAO,QAAQ,qBAAqB;QAC1C,MAAM,YAAY,KAAK,GAAG,IAAI,KAAK,KAAK,MAAM,IAAI,OAAO,WAAW;QAEpE,IAAI,CAAC,WAAW;YACd,QAAQ,cAAc,CAAC;gBAAE,UAAU;gBAAU,OAAO;YAAS;QAC/D;QAEA,QAAQ,YAAY,CAAC,gBAAgB;IACvC,GAAG;QAAC;KAAU;IAEd,OAAO;QAAE;QAAW;IAAQ;AAC9B;uCAEe"}},
    {"offset": {"line": 999, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useSidebar.ts"],"sourcesContent":["'use client';\n\nimport { useEffect } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { saveSysSettings } from '@/helpers/settings';\n\nconst useSidebar = (initialWidth: string, isPinned: boolean) => {\n  const { envConfig } = useEnv();\n  const { settings } = useSettingsStore();\n  const {\n    sideBarWidth,\n    isSideBarVisible,\n    isSideBarPinned,\n    getSideBarWidth,\n    setSideBarWidth,\n    setSideBarVisible,\n    setSideBarPin,\n    toggleSideBar,\n    toggleSideBarPin,\n  } = useSidebarStore();\n\n  useEffect(() => {\n    setSideBarWidth(initialWidth);\n    setSideBarPin(isPinned);\n    setSideBarVisible(isPinned);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const handleSideBarResize = (newWidth: string) => {\n    setSideBarWidth(newWidth);\n    settings.globalReadSettings.sideBarWidth = newWidth;\n  };\n\n  const handleSideBarTogglePin = () => {\n    toggleSideBarPin();\n    if (isSideBarPinned && isSideBarVisible) setSideBarVisible(false);\n    const globalReadSettings = settings.globalReadSettings;\n    const newGlobalReadSettings = { ...globalReadSettings, isSideBarPinned: !isSideBarPinned };\n    saveSysSettings(envConfig, 'globalReadSettings', newGlobalReadSettings);\n  };\n\n  return {\n    sideBarWidth,\n    isSideBarPinned,\n    isSideBarVisible,\n    getSideBarWidth,\n    handleSideBarResize,\n    handleSideBarTogglePin,\n    setSideBarVisible,\n    toggleSideBar,\n  };\n};\n\nexport default useSidebar;\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;;;;;;;AANA;;;;;;AAQA,MAAM,aAAa,CAAC,cAAsB;IACxC,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,0JAAM;IAC5B,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,oKAAgB;IACrC,MAAM,EACJ,YAAY,EACZ,gBAAgB,EAChB,eAAe,EACf,eAAe,EACf,eAAe,EACf,iBAAiB,EACjB,aAAa,EACb,aAAa,EACb,gBAAgB,EACjB,GAAG,IAAA,kKAAe;IAEnB,IAAA,gHAAS,EAAC;QACR,gBAAgB;QAChB,cAAc;QACd,kBAAkB;IAClB,uDAAuD;IACzD,GAAG,EAAE;IAEL,MAAM,sBAAsB,CAAC;QAC3B,gBAAgB;QAChB,SAAS,kBAAkB,CAAC,YAAY,GAAG;IAC7C;IAEA,MAAM,yBAAyB;QAC7B;QACA,IAAI,mBAAmB,kBAAkB,kBAAkB;QAC3D,MAAM,qBAAqB,SAAS,kBAAkB;QACtD,MAAM,wBAAwB;YAAE,GAAG,kBAAkB;YAAE,iBAAiB,CAAC;QAAgB;QACzF,IAAA,gKAAe,EAAC,WAAW,sBAAsB;IACnD;IAEA,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACF;AACF;uCAEe"}},
    {"offset": {"line": 1063, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useSearchNav.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useMemo } from 'react';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { isCfiInLocation } from '@/utils/cfi';\nimport { flattenSearchResults } from '../components/sidebar/SearchResultsNav';\n\nexport function useSearchNav(bookKey: string) {\n  const { getView, getProgress } = useReaderStore();\n  const { setSideBarVisible } = useSidebarStore();\n  const { getSearchNavState, setSearchResultIndex, clearSearch } = useSidebarStore();\n\n  const searchNavState = getSearchNavState(bookKey);\n  const { searchTerm, searchResults, searchResultIndex, searchProgress } = searchNavState;\n\n  const progress = getProgress(bookKey);\n\n  const currentLocation = useMemo(() => {\n    return progress?.location;\n  }, [progress]);\n\n  // Flatten search results for navigation\n  const flattenedResults = useMemo(() => {\n    if (!searchResults) return [];\n    return flattenSearchResults(searchResults);\n  }, [searchResults]);\n\n  const totalResults = flattenedResults.length;\n  const hasSearchResults = searchResults && totalResults > 0;\n  const showSearchNav = hasSearchResults;\n\n  // Get current section label\n  const currentSection = useMemo(() => {\n    if (!flattenedResults.length || searchResultIndex >= flattenedResults.length) return '';\n    return flattenedResults[searchResultIndex]?.sectionLabel || '';\n  }, [flattenedResults, searchResultIndex]);\n\n  // Find results on the current page\n  const currentPageResults = useMemo(() => {\n    if (!flattenedResults.length || !currentLocation) return { firstIndex: -1, lastIndex: -1 };\n\n    let firstIndex = -1;\n    let lastIndex = -1;\n\n    for (let i = 0; i < flattenedResults.length; i++) {\n      const result = flattenedResults[i];\n      if (result && isCfiInLocation(result.cfi, currentLocation)) {\n        if (firstIndex === -1) firstIndex = i;\n        lastIndex = i;\n      }\n    }\n    if (firstIndex !== -1) {\n      setTimeout(() => setSearchResultIndex(bookKey, firstIndex), 0);\n    }\n\n    return { firstIndex, lastIndex };\n  }, [flattenedResults, currentLocation, bookKey, setSearchResultIndex]);\n\n  // Navigate to a specific search result\n  const navigateToResult = useCallback(\n    (index: number) => {\n      if (!flattenedResults.length) return;\n      if (index < 0 || index >= flattenedResults.length) return;\n\n      const result = flattenedResults[index];\n      if (result) {\n        setSearchResultIndex(bookKey, index);\n        getView(bookKey)?.goTo(result.cfi);\n      }\n    },\n    [bookKey, flattenedResults, setSearchResultIndex, getView],\n  );\n\n  const handleShowResults = useCallback(() => {\n    setSideBarVisible(true);\n  }, [setSideBarVisible]);\n\n  const handleCloseSearch = useCallback(() => {\n    clearSearch(bookKey);\n    getView(bookKey)?.clearSearch();\n  }, [clearSearch, bookKey, getView]);\n\n  // Navigate to the previous page with results (last result before current page)\n  const handlePreviousResult = useCallback(() => {\n    const { firstIndex } = currentPageResults;\n\n    if (firstIndex > 0) {\n      // Navigate to the result just before the first result on current page\n      navigateToResult(firstIndex - 1);\n    } else if (firstIndex === -1 && searchResultIndex > 0) {\n      // No results on current page, just go to previous result\n      navigateToResult(searchResultIndex - 1);\n    }\n  }, [currentPageResults, searchResultIndex, navigateToResult]);\n\n  // Navigate to the next page with results (first result after current page)\n  const handleNextResult = useCallback(() => {\n    const { lastIndex } = currentPageResults;\n\n    if (lastIndex >= 0 && lastIndex < totalResults - 1) {\n      // Navigate to the result just after the last result on current page\n      navigateToResult(lastIndex + 1);\n    } else if (lastIndex === -1 && searchResultIndex < totalResults - 1) {\n      // No results on current page, just go to next result\n      navigateToResult(searchResultIndex + 1);\n    }\n  }, [currentPageResults, totalResults, searchResultIndex, navigateToResult]);\n\n  // Check if there are results before/after the current page\n  const hasPreviousPage =\n    currentPageResults.firstIndex > 0 ||\n    (currentPageResults.firstIndex === -1 && searchResultIndex > 0);\n  const hasNextPage =\n    (currentPageResults.lastIndex >= 0 && currentPageResults.lastIndex < totalResults - 1) ||\n    (currentPageResults.lastIndex === -1 && searchResultIndex < totalResults - 1);\n\n  return {\n    searchTerm,\n    searchProgress,\n    currentSection,\n    searchResultIndex,\n    totalResults,\n    showSearchNav,\n    hasPreviousPage,\n    hasNextPage,\n    handleShowResults,\n    handleCloseSearch,\n    handlePreviousResult,\n    handleNextResult,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1226, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useBooknotesNav.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useMemo } from 'react';\nimport * as CFI from 'foliate-js/epubcfi.js';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { isCfiInLocation } from '@/utils/cfi';\nimport { findTocItemBS } from '@/utils/toc';\nimport { BookNoteType } from '@/types/book';\nimport { TOCItem } from '@/libs/document';\n\nexport function useBooknotesNav(bookKey: string, toc: TOCItem[]) {\n  const { getView, getProgress } = useReaderStore();\n  const { getConfig } = useBookDataStore();\n  const {\n    setSideBarVisible,\n    getBooknotesNavState,\n    setActiveBooknoteType,\n    setBooknoteResults,\n    setBooknoteIndex,\n    clearBooknotesNav,\n  } = useSidebarStore();\n\n  const booknotesNavState = getBooknotesNavState(bookKey);\n  const { activeBooknoteType, booknoteResults, booknoteIndex } = booknotesNavState;\n\n  const progress = getProgress(bookKey);\n  const currentLocation = progress?.location;\n\n  // Get booknotes from config and filter by type\n  const allBooknotes = useMemo(() => {\n    const config = getConfig(bookKey);\n    return config?.booknotes?.filter((note) => !note.deletedAt) || [];\n  }, [bookKey, getConfig]);\n\n  // Sort booknotes by CFI order\n  const sortedBooknotes = useMemo(() => {\n    if (!booknoteResults) return [];\n    return [...booknoteResults].sort((a, b) => CFI.compare(a.cfi, b.cfi));\n  }, [booknoteResults]);\n\n  const totalResults = sortedBooknotes.length;\n  const hasBooknotes = booknoteResults && totalResults > 0;\n  const showBooknotesNav = hasBooknotes && activeBooknoteType !== null;\n\n  // Get current section label\n  const currentSection = useMemo(() => {\n    if (!sortedBooknotes.length || booknoteIndex >= sortedBooknotes.length) return '';\n    const currentNote = sortedBooknotes[booknoteIndex];\n    if (!currentNote) return '';\n    const tocItem = findTocItemBS(toc, currentNote.cfi);\n    return tocItem?.label || '';\n  }, [sortedBooknotes, booknoteIndex, toc]);\n\n  // Find booknotes on the current page\n  const currentPageResults = useMemo(() => {\n    if (!sortedBooknotes.length || !currentLocation) return { firstIndex: -1, lastIndex: -1 };\n\n    let firstIndex = -1;\n    let lastIndex = -1;\n\n    for (let i = 0; i < sortedBooknotes.length; i++) {\n      const note = sortedBooknotes[i];\n      if (note && isCfiInLocation(note.cfi, currentLocation)) {\n        if (firstIndex === -1) firstIndex = i;\n        lastIndex = i;\n      }\n    }\n    if (firstIndex !== -1) {\n      setTimeout(() => setBooknoteIndex(bookKey, firstIndex), 0);\n    }\n\n    return { firstIndex, lastIndex };\n  }, [sortedBooknotes, currentLocation, bookKey, setBooknoteIndex]);\n\n  // Navigate to a specific booknote\n  const navigateToBooknote = useCallback(\n    (index: number) => {\n      if (!sortedBooknotes.length) return;\n      if (index < 0 || index >= sortedBooknotes.length) return;\n\n      const note = sortedBooknotes[index];\n      if (note) {\n        setBooknoteIndex(bookKey, index);\n        getView(bookKey)?.goTo(note.cfi);\n      }\n    },\n    [bookKey, sortedBooknotes, setBooknoteIndex, getView],\n  );\n\n  // Start navigation for a specific booknote type\n  const startNavigation = useCallback(\n    (type: BookNoteType) => {\n      const filtered = allBooknotes.filter((note) => note.type === type);\n      if (filtered.length === 0) return;\n\n      const sorted = [...filtered].sort((a, b) => CFI.compare(a.cfi, b.cfi));\n      setActiveBooknoteType(bookKey, type);\n      setBooknoteResults(bookKey, sorted);\n      setBooknoteIndex(bookKey, 0);\n\n      // Navigate to first booknote\n      if (sorted.length > 0) {\n        getView(bookKey)?.goTo(sorted[0]!.cfi);\n      }\n    },\n    [\n      allBooknotes,\n      bookKey,\n      setActiveBooknoteType,\n      setBooknoteResults,\n      setBooknoteIndex,\n      getView,\n    ],\n  );\n\n  const handleShowResults = useCallback(() => {\n    setSideBarVisible(true);\n  }, [setSideBarVisible]);\n\n  const handleClose = useCallback(() => {\n    clearBooknotesNav(bookKey);\n  }, [clearBooknotesNav, bookKey]);\n\n  // Navigate to the previous page with booknotes\n  const handlePrevious = useCallback(() => {\n    const { firstIndex } = currentPageResults;\n\n    if (firstIndex > 0) {\n      navigateToBooknote(firstIndex - 1);\n    } else if (firstIndex === -1 && booknoteIndex > 0) {\n      navigateToBooknote(booknoteIndex - 1);\n    }\n  }, [currentPageResults, booknoteIndex, navigateToBooknote]);\n\n  // Navigate to the next page with booknotes\n  const handleNext = useCallback(() => {\n    const { lastIndex } = currentPageResults;\n\n    if (lastIndex >= 0 && lastIndex < totalResults - 1) {\n      navigateToBooknote(lastIndex + 1);\n    } else if (lastIndex === -1 && booknoteIndex < totalResults - 1) {\n      navigateToBooknote(booknoteIndex + 1);\n    }\n  }, [currentPageResults, totalResults, booknoteIndex, navigateToBooknote]);\n\n  // Check if there are booknotes before/after the current page\n  const hasPreviousPage =\n    currentPageResults.firstIndex > 0 ||\n    (currentPageResults.firstIndex === -1 && booknoteIndex > 0);\n  const hasNextPage =\n    (currentPageResults.lastIndex >= 0 && currentPageResults.lastIndex < totalResults - 1) ||\n    (currentPageResults.lastIndex === -1 && booknoteIndex < totalResults - 1);\n\n  // Get counts for each booknote type\n  const bookmarkCount = useMemo(\n    () => allBooknotes.filter((n) => n.type === 'bookmark').length,\n    [allBooknotes],\n  );\n  const annotationCount = useMemo(\n    () => allBooknotes.filter((n) => n.type === 'annotation').length,\n    [allBooknotes],\n  );\n  const excerptCount = useMemo(\n    () => allBooknotes.filter((n) => n.type === 'excerpt').length,\n    [allBooknotes],\n  );\n\n  return {\n    activeBooknoteType,\n    currentSection,\n    booknoteIndex,\n    totalResults,\n    showBooknotesNav,\n    hasPreviousPage,\n    hasNextPage,\n    bookmarkCount,\n    annotationCount,\n    excerptCount,\n    startNavigation,\n    handleShowResults,\n    handleClose,\n    handlePrevious,\n    handleNext,\n  };\n}\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;AARA;;;;;;;;AAYO,SAAS,gBAAgB,OAAe,EAAE,GAAc;IAC7D,MAAM,EAAE,OAAO,EAAE,WAAW,EAAE,GAAG,IAAA,gKAAc;IAC/C,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,oKAAgB;IACtC,MAAM,EACJ,iBAAiB,EACjB,oBAAoB,EACpB,qBAAqB,EACrB,kBAAkB,EAClB,gBAAgB,EAChB,iBAAiB,EAClB,GAAG,IAAA,kKAAe;IAEnB,MAAM,oBAAoB,qBAAqB;IAC/C,MAAM,EAAE,kBAAkB,EAAE,eAAe,EAAE,aAAa,EAAE,GAAG;IAE/D,MAAM,WAAW,YAAY;IAC7B,MAAM,kBAAkB,UAAU;IAElC,+CAA+C;IAC/C,MAAM,eAAe,IAAA,8GAAO,EAAC;QAC3B,MAAM,SAAS,UAAU;QACzB,OAAO,QAAQ,WAAW,OAAO,CAAC,OAAS,CAAC,KAAK,SAAS,KAAK,EAAE;IACnE,GAAG;QAAC;QAAS;KAAU;IAEvB,8BAA8B;IAC9B,MAAM,kBAAkB,IAAA,8GAAO,EAAC;QAC9B,IAAI,CAAC,iBAAiB,OAAO,EAAE;QAC/B,OAAO;eAAI;SAAgB,CAAC,IAAI,CAAC,CAAC,GAAG,IAAM,wIAAW,CAAC,EAAE,GAAG,EAAE,EAAE,GAAG;IACrE,GAAG;QAAC;KAAgB;IAEpB,MAAM,eAAe,gBAAgB,MAAM;IAC3C,MAAM,eAAe,mBAAmB,eAAe;IACvD,MAAM,mBAAmB,gBAAgB,uBAAuB;IAEhE,4BAA4B;IAC5B,MAAM,iBAAiB,IAAA,8GAAO,EAAC;QAC7B,IAAI,CAAC,gBAAgB,MAAM,IAAI,iBAAiB,gBAAgB,MAAM,EAAE,OAAO;QAC/E,MAAM,cAAc,eAAe,CAAC,cAAc;QAClD,IAAI,CAAC,aAAa,OAAO;QACzB,MAAM,UAAU,IAAA,uJAAa,EAAC,KAAK,YAAY,GAAG;QAClD,OAAO,SAAS,SAAS;IAC3B,GAAG;QAAC;QAAiB;QAAe;KAAI;IAExC,qCAAqC;IACrC,MAAM,qBAAqB,IAAA,8GAAO,EAAC;QACjC,IAAI,CAAC,gBAAgB,MAAM,IAAI,CAAC,iBAAiB,OAAO;YAAE,YAAY,CAAC;YAAG,WAAW,CAAC;QAAE;QAExF,IAAI,aAAa,CAAC;QAClB,IAAI,YAAY,CAAC;QAEjB,IAAK,IAAI,IAAI,GAAG,IAAI,gBAAgB,MAAM,EAAE,IAAK;YAC/C,MAAM,OAAO,eAAe,CAAC,EAAE;YAC/B,IAAI,QAAQ,IAAA,yJAAe,EAAC,KAAK,GAAG,EAAE,kBAAkB;gBACtD,IAAI,eAAe,CAAC,GAAG,aAAa;gBACpC,YAAY;YACd;QACF;QACA,IAAI,eAAe,CAAC,GAAG;YACrB,WAAW,IAAM,iBAAiB,SAAS,aAAa;QAC1D;QAEA,OAAO;YAAE;YAAY;QAAU;IACjC,GAAG;QAAC;QAAiB;QAAiB;QAAS;KAAiB;IAEhE,kCAAkC;IAClC,MAAM,qBAAqB,IAAA,kHAAW,EACpC,CAAC;QACC,IAAI,CAAC,gBAAgB,MAAM,EAAE;QAC7B,IAAI,QAAQ,KAAK,SAAS,gBAAgB,MAAM,EAAE;QAElD,MAAM,OAAO,eAAe,CAAC,MAAM;QACnC,IAAI,MAAM;YACR,iBAAiB,SAAS;YAC1B,QAAQ,UAAU,KAAK,KAAK,GAAG;QACjC;IACF,GACA;QAAC;QAAS;QAAiB;QAAkB;KAAQ;IAGvD,gDAAgD;IAChD,MAAM,kBAAkB,IAAA,kHAAW,EACjC,CAAC;QACC,MAAM,WAAW,aAAa,MAAM,CAAC,CAAC,OAAS,KAAK,IAAI,KAAK;QAC7D,IAAI,SAAS,MAAM,KAAK,GAAG;QAE3B,MAAM,SAAS;eAAI;SAAS,CAAC,IAAI,CAAC,CAAC,GAAG,IAAM,wIAAW,CAAC,EAAE,GAAG,EAAE,EAAE,GAAG;QACpE,sBAAsB,SAAS;QAC/B,mBAAmB,SAAS;QAC5B,iBAAiB,SAAS;QAE1B,6BAA6B;QAC7B,IAAI,OAAO,MAAM,GAAG,GAAG;YACrB,QAAQ,UAAU,KAAK,MAAM,CAAC,EAAE,CAAE,GAAG;QACvC;IACF,GACA;QACE;QACA;QACA;QACA;QACA;QACA;KACD;IAGH,MAAM,oBAAoB,IAAA,kHAAW,EAAC;QACpC,kBAAkB;IACpB,GAAG;QAAC;KAAkB;IAEtB,MAAM,cAAc,IAAA,kHAAW,EAAC;QAC9B,kBAAkB;IACpB,GAAG;QAAC;QAAmB;KAAQ;IAE/B,+CAA+C;IAC/C,MAAM,iBAAiB,IAAA,kHAAW,EAAC;QACjC,MAAM,EAAE,UAAU,EAAE,GAAG;QAEvB,IAAI,aAAa,GAAG;YAClB,mBAAmB,aAAa;QAClC,OAAO,IAAI,eAAe,CAAC,KAAK,gBAAgB,GAAG;YACjD,mBAAmB,gBAAgB;QACrC;IACF,GAAG;QAAC;QAAoB;QAAe;KAAmB;IAE1D,2CAA2C;IAC3C,MAAM,aAAa,IAAA,kHAAW,EAAC;QAC7B,MAAM,EAAE,SAAS,EAAE,GAAG;QAEtB,IAAI,aAAa,KAAK,YAAY,eAAe,GAAG;YAClD,mBAAmB,YAAY;QACjC,OAAO,IAAI,cAAc,CAAC,KAAK,gBAAgB,eAAe,GAAG;YAC/D,mBAAmB,gBAAgB;QACrC;IACF,GAAG;QAAC;QAAoB;QAAc;QAAe;KAAmB;IAExE,6DAA6D;IAC7D,MAAM,kBACJ,mBAAmB,UAAU,GAAG,KAC/B,mBAAmB,UAAU,KAAK,CAAC,KAAK,gBAAgB;IAC3D,MAAM,cACJ,AAAC,mBAAmB,SAAS,IAAI,KAAK,mBAAmB,SAAS,GAAG,eAAe,KACnF,mBAAmB,SAAS,KAAK,CAAC,KAAK,gBAAgB,eAAe;IAEzE,oCAAoC;IACpC,MAAM,gBAAgB,IAAA,8GAAO,EAC3B,IAAM,aAAa,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,YAAY,MAAM,EAC9D;QAAC;KAAa;IAEhB,MAAM,kBAAkB,IAAA,8GAAO,EAC7B,IAAM,aAAa,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,cAAc,MAAM,EAChE;QAAC;KAAa;IAEhB,MAAM,eAAe,IAAA,8GAAO,EAC1B,IAAM,aAAa,MAAM,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,WAAW,MAAM,EAC7D;QAAC;KAAa;IAGhB,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 1432, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useIframeEvents.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef } from 'react';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { debounce } from '@/utils/debounce';\nimport { ScrollSource } from './usePagination';\nimport { eventDispatcher } from '@/utils/event';\n\nexport const useMouseEvent = (\n  bookKey: string,\n  handlePageFlip: (msg: MessageEvent | React.MouseEvent<HTMLDivElement, MouseEvent>) => void,\n  handleContinuousScroll: (source: ScrollSource, delta: number, threshold: number) => void,\n) => {\n  const { hoveredBookKey } = useReaderStore();\n  const debounceScroll = debounce(handleContinuousScroll, 500);\n  const debounceFlip = debounce(handlePageFlip, 100);\n  const handleMouseEvent = (msg: MessageEvent | React.MouseEvent<HTMLDivElement, MouseEvent>) => {\n    if (msg instanceof MessageEvent) {\n      if (msg.data && msg.data.bookKey === bookKey) {\n        if (msg.data.type === 'iframe-wheel') {\n          debounceScroll('mouse', -msg.data.deltaY, 0);\n        }\n        if (msg.data.type === 'iframe-wheel') {\n          if (msg.data.ctrlKey) {\n            if (msg.data.deltaY > 0) {\n              eventDispatcher.dispatch('zoom-out', { factor: Math.abs(msg.data.deltaY) / 100 });\n            } else if (msg.data.deltaY < 0) {\n              eventDispatcher.dispatch('zoom-in', { factor: Math.abs(msg.data.deltaY) / 100 });\n            }\n          } else {\n            debounceFlip(msg);\n          }\n        } else {\n          handlePageFlip(msg);\n        }\n      }\n    } else if (msg.type === 'wheel') {\n      const event = msg as React.WheelEvent<HTMLDivElement>;\n      debounceScroll('mouse', -event.deltaY, 0);\n    } else {\n      handlePageFlip(msg);\n    }\n  };\n\n  useEffect(() => {\n    window.addEventListener('message', handleMouseEvent);\n    return () => {\n      window.removeEventListener('message', handleMouseEvent);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey, hoveredBookKey]);\n\n  return {\n    onClick: handlePageFlip,\n    onWheel: handleMouseEvent,\n  };\n};\n\ninterface IframeTouch {\n  clientX: number;\n  clientY: number;\n  screenX: number;\n  screenY: number;\n}\n\ninterface IframeTouchEvent {\n  timeStamp: number;\n  targetTouches: IframeTouch[];\n}\n\nexport const useTouchEvent = (\n  bookKey: string,\n  handlePageFlip: (msg: CustomEvent) => void,\n  handleContinuousScroll: (source: ScrollSource, delta: number, threshold: number) => void,\n) => {\n  const { getBookData } = useBookDataStore();\n  const { hoveredBookKey, setHoveredBookKey, getViewSettings } = useReaderStore();\n\n  const touchStartRef = useRef<IframeTouch | null>(null);\n  const touchEndRef = useRef<IframeTouch | null>(null);\n  const touchStartTimeRef = useRef<number | null>(null);\n  const touchEndTimeRef = useRef<number | null>(null);\n\n  const onTouchStart = (e: IframeTouchEvent | React.TouchEvent<HTMLDivElement>) => {\n    const touch = e.targetTouches[0];\n    if (!touch) return;\n    touchStartRef.current = touch;\n    touchStartTimeRef.current = 'timeStamp' in e ? e.timeStamp : Date.now();\n  };\n\n  const onTouchMove = (e: IframeTouchEvent | React.TouchEvent<HTMLDivElement>) => {\n    if (!touchStartRef.current) return;\n    const touch = e.targetTouches[0];\n    if (touch) {\n      touchEndRef.current = touch;\n      touchEndTimeRef.current = 'timeStamp' in e ? e.timeStamp : Date.now();\n    }\n    const { current: touchStart } = touchStartRef;\n    const { current: touchEnd } = touchEndRef;\n    if (hoveredBookKey && touchEnd) {\n      const viewSettings = getViewSettings(bookKey)!;\n      const deltaY = touchEnd.screenY - touchStart.screenY;\n      const deltaX = touchEnd.screenX - touchStart.screenX;\n      if (!viewSettings!.scrolled && !viewSettings!.vertical) {\n        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {\n          setHoveredBookKey(null);\n        }\n      } else {\n        setHoveredBookKey(null);\n      }\n    }\n  };\n\n  const onTouchEnd = (e: IframeTouchEvent | React.TouchEvent<HTMLDivElement>) => {\n    if (!touchStartRef.current) return;\n\n    const touch = e.targetTouches[0];\n    if (touch) {\n      touchEndRef.current = touch;\n      touchEndTimeRef.current = 'timeStamp' in e ? e.timeStamp : Date.now();\n    }\n\n    const windowWidth = window.innerWidth;\n    const { current: touchStart } = touchStartRef;\n    const { current: touchEnd } = touchEndRef;\n    const { current: touchStartTime } = touchStartTimeRef;\n    const { current: touchEndTime } = touchEndTimeRef;\n    if (touchEnd) {\n      const viewSettings = getViewSettings(bookKey)!;\n      const bookData = getBookData(bookKey)!;\n      const deltaY = touchEnd.screenY - touchStart.screenY;\n      const deltaX = touchEnd.screenX - touchStart.screenX;\n      const deltaT = touchEndTime && touchStartTime ? touchEndTime - touchStartTime : 0;\n      // also check for deltaX to prevent swipe page turn from triggering the toggle\n      if (\n        deltaY < -10 &&\n        Math.abs(deltaY) > Math.abs(deltaX) * 2 &&\n        Math.abs(deltaX) < windowWidth * 0.3\n      ) {\n        // swipe up to toggle the header bar and the footer bar, only for horizontal page mode\n        if (\n          !viewSettings!.scrolled && // not scrolled\n          !viewSettings!.vertical && // not vertical\n          (!bookData.isFixedLayout || viewSettings.zoomLevel <= 100) // for fixed layout, not when zoomed in\n        ) {\n          setHoveredBookKey(hoveredBookKey ? null : bookKey);\n        }\n      } else {\n        if (hoveredBookKey) {\n          setHoveredBookKey(null);\n        }\n      }\n      handlePageFlip(\n        new CustomEvent('touch-swipe', {\n          detail: {\n            deltaX,\n            deltaY,\n            deltaT,\n            startX: touchStart.screenX,\n            startY: touchStart.screenY,\n            endX: touchEnd.screenX,\n            endY: touchEnd.screenY,\n          },\n        }),\n      );\n      handleContinuousScroll('touch', deltaY, 30);\n    }\n\n    touchStartRef.current = null;\n    touchEndRef.current = null;\n  };\n\n  const handleTouch = (msg: MessageEvent) => {\n    if (msg.data && msg.data.bookKey === bookKey) {\n      if (msg.data.type === 'iframe-touchstart') {\n        onTouchStart(msg.data);\n      } else if (msg.data.type === 'iframe-touchmove') {\n        onTouchMove(msg.data);\n      } else if (msg.data.type === 'iframe-touchend') {\n        onTouchEnd(msg.data);\n      }\n    }\n  };\n\n  useEffect(() => {\n    window.addEventListener('message', handleTouch);\n    return () => {\n      window.removeEventListener('message', handleTouch);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [hoveredBookKey]);\n\n  return {\n    onTouchStart,\n    onTouchMove,\n    onTouchEnd,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1618, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useFoliateEvents.ts"],"sourcesContent":["'use client';\n\nimport { useEffect } from 'react';\nimport { FoliateView } from '@/types/view';\n\ntype FoliateEventHandler = {\n  onLoad?: (event: Event) => void;\n  onRelocate?: (event: Event) => void;\n  onLinkClick?: (event: Event) => void;\n  onRendererRelocate?: (event: Event) => void;\n  onDrawAnnotation?: (event: Event) => void;\n  onShowAnnotation?: (event: Event) => void;\n};\n\nexport const useFoliateEvents = (view: FoliateView | null, handlers?: FoliateEventHandler) => {\n  const onLoad = handlers?.onLoad;\n  const onRelocate = handlers?.onRelocate;\n  const onLinkClick = handlers?.onLinkClick;\n  const onRendererRelocate = handlers?.onRendererRelocate;\n  const onDrawAnnotation = handlers?.onDrawAnnotation;\n  const onShowAnnotation = handlers?.onShowAnnotation;\n\n  useEffect(() => {\n    if (!view) return;\n    if (onLoad) view.addEventListener('load', onLoad);\n    if (onRelocate) view.addEventListener('relocate', onRelocate);\n    if (onLinkClick) view.addEventListener('link', onLinkClick);\n    if (onRendererRelocate) view.renderer.addEventListener('relocate', onRendererRelocate);\n    if (onDrawAnnotation) view.addEventListener('draw-annotation', onDrawAnnotation);\n    if (onShowAnnotation) view.addEventListener('show-annotation', onShowAnnotation);\n\n    return () => {\n      if (onLoad) view.removeEventListener('load', onLoad);\n      if (onRelocate) view.removeEventListener('relocate', onRelocate);\n      if (onLinkClick) view.removeEventListener('link', onLinkClick);\n      if (onRendererRelocate) view.renderer.removeEventListener('relocate', onRendererRelocate);\n      if (onDrawAnnotation) view.removeEventListener('draw-annotation', onDrawAnnotation);\n      if (onShowAnnotation) view.removeEventListener('show-annotation', onShowAnnotation);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [view]);\n};\n"],"names":[],"mappings":";;;;AAEA;AAFA;;AAcO,MAAM,mBAAmB,CAAC,MAA0B;IACzD,MAAM,SAAS,UAAU;IACzB,MAAM,aAAa,UAAU;IAC7B,MAAM,cAAc,UAAU;IAC9B,MAAM,qBAAqB,UAAU;IACrC,MAAM,mBAAmB,UAAU;IACnC,MAAM,mBAAmB,UAAU;IAEnC,IAAA,gHAAS,EAAC;QACR,IAAI,CAAC,MAAM;QACX,IAAI,QAAQ,KAAK,gBAAgB,CAAC,QAAQ;QAC1C,IAAI,YAAY,KAAK,gBAAgB,CAAC,YAAY;QAClD,IAAI,aAAa,KAAK,gBAAgB,CAAC,QAAQ;QAC/C,IAAI,oBAAoB,KAAK,QAAQ,CAAC,gBAAgB,CAAC,YAAY;QACnE,IAAI,kBAAkB,KAAK,gBAAgB,CAAC,mBAAmB;QAC/D,IAAI,kBAAkB,KAAK,gBAAgB,CAAC,mBAAmB;QAE/D,OAAO;YACL,IAAI,QAAQ,KAAK,mBAAmB,CAAC,QAAQ;YAC7C,IAAI,YAAY,KAAK,mBAAmB,CAAC,YAAY;YACrD,IAAI,aAAa,KAAK,mBAAmB,CAAC,QAAQ;YAClD,IAAI,oBAAoB,KAAK,QAAQ,CAAC,mBAAmB,CAAC,YAAY;YACtE,IAAI,kBAAkB,KAAK,mBAAmB,CAAC,mBAAmB;YAClE,IAAI,kBAAkB,KAAK,mBAAmB,CAAC,mBAAmB;QACpE;IACA,uDAAuD;IACzD,GAAG;QAAC;KAAK;AACX"}},
    {"offset": {"line": 1659, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useProgressSync.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useEffect, useRef } from 'react';\nimport { useAuth } from '@/context/AuthContext';\nimport { useSync } from '@/hooks/useSync';\nimport { BookConfig, FIXED_LAYOUT_FORMATS } from '@/types/book';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { serializeConfig } from '@/utils/serializer';\nimport { CFI } from '@/libs/document';\nimport { debounce } from '@/utils/debounce';\nimport { eventDispatcher } from '@/utils/event';\nimport { DEFAULT_BOOK_SEARCH_CONFIG, SYNC_PROGRESS_INTERVAL_SEC } from '@/services/constants';\nimport { getCFIFromXPointer, getXPointerFromCFI, normalizeProgressXPointer } from '@/utils/xcfi';\n\nexport const useProgressSync = (bookKey: string) => {\n  const _ = useTranslation();\n  const { getConfig, setConfig, getBookData } = useBookDataStore();\n  const { getView, getProgress, setHoveredBookKey } = useReaderStore();\n  const { settings } = useSettingsStore();\n  const { syncedConfigs, syncConfigs } = useSync(bookKey);\n  const { user } = useAuth();\n  const progress = getProgress(bookKey);\n\n  const configPulled = useRef(false);\n  const hasPulledConfigOnce = useRef(false);\n\n  const pushConfig = async (bookKey: string, config: BookConfig | null) => {\n    const book = getBookData(bookKey)?.book;\n    if (!config || !book || !user) return;\n    const bookHash = bookKey.split('-')[0]!;\n    const metaHash = book.metaHash;\n    const newConfig = { ...config, bookHash, metaHash };\n    const compressedConfig = JSON.parse(\n      serializeConfig(newConfig, settings.globalViewSettings, DEFAULT_BOOK_SEARCH_CONFIG),\n    );\n    delete compressedConfig.booknotes;\n    await syncConfigs([compressedConfig], bookHash, metaHash, 'push');\n  };\n\n  const pullConfig = async (bookKey: string) => {\n    const book = getBookData(bookKey)?.book;\n    if (!user || !book) return;\n    const bookHash = bookKey.split('-')[0]!;\n    const metaHash = book.metaHash;\n    await syncConfigs([], bookHash, metaHash, 'pull');\n  };\n\n  const syncConfig = async () => {\n    if (!configPulled.current) {\n      pullConfig(bookKey);\n    } else {\n      const config = getConfig(bookKey);\n      const view = getView(bookKey);\n      const book = getBookData(bookKey)?.book;\n      if (config && view && book && config.progress && config.progress[0] > 0) {\n        try {\n          const content = view.renderer.getContents()[0];\n          if (content && !FIXED_LAYOUT_FORMATS.has(book.format)) {\n            const { doc, index } = content;\n            const xpointerResult = await getXPointerFromCFI(config.location!, doc, index || 0);\n            config.xpointer = normalizeProgressXPointer(xpointerResult.xpointer);\n          }\n        } catch (error) {\n          console.warn('Failed to convert CFI to XPointer', error);\n        }\n        pushConfig(bookKey, config);\n      }\n    }\n  };\n\n  const handleSyncBookProgress = async (event: CustomEvent) => {\n    const { bookKey: syncBookKey } = event.detail;\n    if (syncBookKey === bookKey) {\n      configPulled.current = false;\n      await pullConfig(bookKey);\n    }\n  };\n\n  // Push: ad-hoc push when the book is closed\n  useEffect(() => {\n    eventDispatcher.on('sync-book-progress', handleSyncBookProgress);\n    return () => {\n      eventDispatcher.off('sync-book-progress', handleSyncBookProgress);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey]);\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const handleAutoSync = useCallback(\n    debounce(() => {\n      syncConfig();\n    }, SYNC_PROGRESS_INTERVAL_SEC * 1000),\n    [],\n  );\n\n  // Push: auto-push progress when progress changes with a debounce\n  useEffect(() => {\n    if (!progress?.location || !user) return;\n    handleAutoSync();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [progress?.location]);\n\n  // Pull: pull progress once when the book is opened\n  useEffect(() => {\n    if (!progress || hasPulledConfigOnce.current) return;\n    hasPulledConfigOnce.current = true;\n    pullConfig(bookKey);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [progress]);\n\n  const applyRemoteProgress = async (syncedConfigs: BookConfig[]) => {\n    const config = getConfig(bookKey);\n    const book = getBookData(bookKey)?.book;\n    if (!syncedConfigs || syncedConfigs.length === 0 || !config || !book) return;\n\n    const bookHash = bookKey.split('-')[0]!;\n    const metaHash = book.metaHash;\n    const syncedConfig = syncedConfigs.filter(\n      (c) => c.bookHash === bookHash || c.metaHash === metaHash,\n    )[0];\n    if (syncedConfig) {\n      const configCFI = config?.location;\n      let remoteCFILocation = syncedConfig.location;\n      const xPointer = syncedConfig.xpointer;\n      const bookData = getBookData(bookKey);\n      const view = getView(bookKey);\n      if (xPointer && view && bookData && bookData.bookDoc) {\n        const content = view.renderer.getContents()[0];\n        const koProgress = normalizeProgressXPointer(xPointer);\n        const candidateCFI = await getCFIFromXPointer(\n          koProgress,\n          content?.doc,\n          content?.index,\n          bookData.bookDoc,\n        );\n        if (!remoteCFILocation || CFI.compare(remoteCFILocation, candidateCFI) < 0) {\n          remoteCFILocation = candidateCFI;\n        }\n      }\n      const filteredSyncedConfig = Object.fromEntries(\n        Object.entries(syncedConfig).filter(([_, value]) => value !== null && value !== undefined),\n      );\n      if (syncedConfig.updatedAt >= config.updatedAt) {\n        setConfig(bookKey, { ...config, ...filteredSyncedConfig });\n      } else {\n        setConfig(bookKey, { ...filteredSyncedConfig, ...config });\n      }\n      if (remoteCFILocation && configCFI) {\n        if (CFI.compare(configCFI, remoteCFILocation) < 0) {\n          if (view) {\n            view.goTo(remoteCFILocation);\n            setHoveredBookKey(null);\n            eventDispatcher.dispatch('hint', {\n              bookKey,\n              message: _('Reading Progress Synced'),\n            });\n          }\n        }\n      }\n    }\n  };\n\n  // Pull: proccess the pulled progress\n  useEffect(() => {\n    if (!configPulled.current && syncedConfigs) {\n      configPulled.current = true;\n      applyRemoteProgress(syncedConfigs).catch((error) => {\n        console.error('Failed to apply remote progress', error);\n      });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [syncedConfigs]);\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1860, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useProgressAutoSave.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useEffect } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { throttle } from '@/utils/throttle';\n\nexport const useProgressAutoSave = (bookKey: string) => {\n  const { envConfig } = useEnv();\n  const { getConfig, saveConfig } = useBookDataStore();\n  const { getProgress } = useReaderStore();\n  const progress = getProgress(bookKey);\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const saveBookConfig = useCallback(\n    throttle(() => {\n      setTimeout(async () => {\n        const config = getConfig(bookKey)!;\n        const settings = useSettingsStore.getState().settings;\n        await saveConfig(envConfig, bookKey, config, settings);\n      }, 5000);\n    }, 10000),\n    [],\n  );\n\n  useEffect(() => {\n    saveBookConfig();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [progress, bookKey]);\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;AACA;;;;;;;AAPA;;;;;;;AASO,MAAM,sBAAsB,CAAC;IAClC,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,0JAAM;IAC5B,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,IAAA,oKAAgB;IAClD,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,gKAAc;IACtC,MAAM,WAAW,YAAY;IAE7B,uDAAuD;IACvD,MAAM,iBAAiB,IAAA,kHAAW,EAChC,IAAA,uJAAQ,EAAC;QACP,WAAW;YACT,MAAM,SAAS,UAAU;YACzB,MAAM,WAAW,oKAAgB,CAAC,QAAQ,GAAG,QAAQ;YACrD,MAAM,WAAW,WAAW,SAAS,QAAQ;QAC/C,GAAG;IACL,GAAG,QACH,EAAE;IAGJ,IAAA,gHAAS,EAAC;QACR;IACA,uDAAuD;IACzD,GAAG;QAAC;QAAU;KAAQ;AACxB"}},
    {"offset": {"line": 1911, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useKOSync.ts"],"sourcesContent":["'use client';\n\nimport { useState, useEffect, useCallback, useRef, useMemo } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { KOSyncClient, KoSyncProgress } from '@/services/sync/KOSyncClient';\nimport { Book, BookProgress, FIXED_LAYOUT_FORMATS } from '@/types/book';\nimport { BookDoc } from '@/libs/document';\nimport { debounce } from '@/utils/debounce';\nimport { eventDispatcher } from '@/utils/event';\nimport { getCFIFromXPointer, normalizeProgressXPointer, XCFI } from '@/utils/xcfi';\n\ntype SyncState = 'idle' | 'checking' | 'conflict' | 'synced' | 'error';\n\nexport interface SyncDetails {\n  book: Book;\n  bookDoc: BookDoc;\n  local: {\n    cfi?: string;\n    preview: string;\n  };\n  remote: KoSyncProgress & {\n    preview: string;\n    percentage?: number;\n  };\n}\n\nexport const useKOSync = (bookKey: string) => {\n  const _ = useTranslation();\n  const { appService } = useEnv();\n  const { settings } = useSettingsStore();\n  const { getProgress, getView } = useReaderStore();\n  const { getBookData } = useBookDataStore();\n\n  const [kosyncClient, setKOSyncClient] = useState<KOSyncClient | null>(null);\n  const [syncState, setSyncState] = useState<SyncState>('idle');\n  const [conflictDetails, setConflictDetails] = useState<SyncDetails | null>(null);\n  const [errorMessage] = useState<string | null>(null);\n  const hasPulledOnce = useRef(false);\n\n  const progress = getProgress(bookKey);\n\n  useEffect(() => {\n    if (!settings.kosync.username || !settings.kosync.userkey) {\n      setKOSyncClient(null);\n      return;\n    }\n    const client = new KOSyncClient(settings.kosync);\n    setKOSyncClient(client);\n  }, [settings]);\n\n  const generateKOProgress = useCallback(() => {\n    const progress = getProgress(bookKey);\n    const book = getBookData(bookKey)?.book;\n    if (!progress || !book) return null;\n\n    let koProgress = '';\n    let percentage: number;\n    if (FIXED_LAYOUT_FORMATS.has(book.format)) {\n      const page = progress.section?.current ?? 0;\n      const totalPages = progress.section?.total ?? 0;\n      koProgress = page.toString();\n      percentage = totalPages > 0 ? (page + 1) / totalPages : 0;\n    } else {\n      const view = getView(bookKey);\n      const cfi = progress.location;\n      if (!view || !cfi) return null;\n      try {\n        const content = view.renderer.getContents()[0];\n        if (content) {\n          const { doc, index: spineIndex } = content;\n          const converter = new XCFI(doc, spineIndex || 0);\n          const xpointerResult = converter.cfiToXPointer(cfi);\n          koProgress = normalizeProgressXPointer(xpointerResult.xpointer);\n        }\n      } catch (error) {\n        console.error('Failed to convert CFI to XPointer', error);\n      }\n\n      const page = progress.pageinfo?.current ?? 0;\n      const totalPages = progress.pageinfo?.total ?? 0;\n      percentage = totalPages > 0 ? (page + 1) / totalPages : 0;\n    }\n\n    return { koProgress, percentage };\n  }, [bookKey, getProgress, getBookData, getView]);\n\n  const applyRemoteProgress = async (book: Book, bookDoc: BookDoc, remote: KoSyncProgress) => {\n    const view = getView(bookKey);\n    if (FIXED_LAYOUT_FORMATS.has(book.format)) {\n      const pageToGo = parseInt(remote.progress!, 10);\n      if (isNaN(pageToGo)) return;\n      view?.select(pageToGo - 1);\n    } else {\n      if (!remote.progress?.startsWith('/body')) return;\n      try {\n        const content = view?.renderer.getContents()[0];\n        const koProgress = normalizeProgressXPointer(remote.progress);\n        const cfi = await getCFIFromXPointer(koProgress, content?.doc, content?.index, bookDoc);\n        view?.goTo(cfi);\n      } catch (error) {\n        console.error('Failed to convert XPointer to CFI', error);\n        return;\n      }\n    }\n    eventDispatcher.dispatch('toast', { message: _('Reading Progress Synced'), type: 'info' });\n  };\n\n  const promptedSync = async (\n    book: Book,\n    bookDoc: BookDoc,\n    local: BookProgress,\n    remote: KoSyncProgress,\n  ) => {\n    let localPreview = '';\n    let remotePreview = '';\n    const remotePercentage = remote.percentage || 0;\n\n    if (FIXED_LAYOUT_FORMATS.has(book.format)) {\n      const localPageInfo = local.section;\n      const localPercentage =\n        localPageInfo && localPageInfo.total > 0\n          ? Math.round(((localPageInfo.current + 1) / localPageInfo.total) * 100)\n          : 0;\n      localPreview = localPageInfo\n        ? _('Page {{page}} of {{total}} ({{percentage}}%)', {\n            page: localPageInfo.current + 1,\n            total: localPageInfo.total,\n            percentage: localPercentage,\n          })\n        : _('Current position');\n\n      const remotePage = parseInt(remote.progress!, 10);\n      if (!isNaN(remotePage) && remotePercentage > 0) {\n        const localTotalPages = localPageInfo?.total ?? 0;\n        const remoteTotalPages = Math.round(remotePage / remotePercentage);\n        const pagesMatch = Math.abs(localTotalPages - remoteTotalPages) <= 1;\n\n        if (pagesMatch) {\n          remotePreview = _('Page {{page}} of {{total}} ({{percentage}}%)', {\n            page: remotePage,\n            total: remoteTotalPages,\n            percentage: Math.round(remotePercentage * 100),\n          });\n        } else {\n          remotePreview = _('Approximately page {{page}} of {{total}} ({{percentage}}%)', {\n            page: remotePage,\n            total: remoteTotalPages,\n            percentage: Math.round(remotePercentage * 100),\n          });\n        }\n      } else {\n        remotePreview = _('Approximately {{percentage}}%', {\n          percentage: Math.round(remotePercentage * 100),\n        });\n      }\n    } else {\n      const localPageInfo = local.pageinfo;\n      const localPercentage =\n        localPageInfo && localPageInfo.total > 0\n          ? Math.round(((localPageInfo.current + 1) / localPageInfo.total) * 100)\n          : 0;\n      localPreview = `${local.sectionLabel} (${localPercentage}%)`;\n\n      remotePreview = _('Approximately {{percentage}}%', {\n        percentage: Math.round(remotePercentage * 100),\n      });\n    }\n\n    setConflictDetails({\n      book,\n      bookDoc,\n      local: { cfi: local.location, preview: localPreview },\n      remote: { ...remote, preview: remotePreview },\n    });\n  };\n\n  const pushProgress = useMemo(\n    () =>\n      debounce(async () => {\n        if (!bookKey || !appService || !kosyncClient || !hasPulledOnce.current) return;\n        const { settings } = useSettingsStore.getState();\n        if (['receive', 'disable'].includes(settings.kosync.strategy)) return;\n\n        const currentBook = getBookData(bookKey)?.book;\n        const progress = generateKOProgress();\n        if (!currentBook || !progress || !progress.koProgress) return;\n\n        await kosyncClient.updateProgress(currentBook, progress.koProgress, progress.percentage);\n      }, 5000),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [bookKey, appService, kosyncClient],\n  );\n\n  const pullProgress = useCallback(\n    async () => {\n      if (!progress?.location || !appService || !kosyncClient) return;\n\n      const bookData = getBookData(bookKey);\n      const book = bookData?.book;\n      const bookDoc = bookData?.bookDoc;\n      if (!book || !bookDoc) return;\n\n      const { strategy, enabled } = settings.kosync;\n      if (!enabled) return;\n\n      hasPulledOnce.current = true;\n      if (strategy === 'send') {\n        setSyncState('synced');\n        return;\n      }\n\n      setSyncState('checking');\n      const remoteProgress = await kosyncClient.getProgress(book);\n      if (!remoteProgress || !remoteProgress.progress) {\n        setSyncState('synced');\n        return;\n      }\n\n      const localTimestamp = bookData?.config?.updatedAt || book.updatedAt;\n      const remoteTimestamp = remoteProgress.timestamp\n        ? remoteProgress.timestamp * 1000\n        : Date.now();\n      const remoteIsNewer = remoteTimestamp > localTimestamp;\n      if (strategy === 'receive' || (strategy === 'silent' && remoteIsNewer)) {\n        applyRemoteProgress(book, bookDoc, remoteProgress);\n        setSyncState('synced');\n      } else if (strategy === 'prompt') {\n        promptedSync(book, bookDoc, progress, remoteProgress);\n        setSyncState('conflict');\n      } else {\n        setSyncState('synced');\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [bookKey, appService, kosyncClient, settings.kosync, progress],\n  );\n\n  useEffect(() => {\n    const handlePushProgress = (event: CustomEvent) => {\n      if (event.detail.bookKey !== bookKey) return;\n      pushProgress();\n      pushProgress.flush();\n    };\n    const handleFlush = (event: CustomEvent) => {\n      if (event.detail.bookKey !== bookKey) return;\n      pushProgress.flush();\n    };\n    eventDispatcher.on('push-kosync', handlePushProgress);\n    eventDispatcher.on('flush-kosync', handleFlush);\n    return () => {\n      eventDispatcher.off('push-kosync', handlePushProgress);\n      eventDispatcher.off('flush-kosync', handleFlush);\n      pushProgress.flush();\n    };\n  }, [bookKey, pushProgress]);\n\n  useEffect(() => {\n    const handlePullProgress = (event: CustomEvent) => {\n      if (event.detail.bookKey !== bookKey) return;\n      pullProgress();\n    };\n    eventDispatcher.on('pull-kosync', handlePullProgress);\n    return () => {\n      eventDispatcher.off('pull-kosync', handlePullProgress);\n    };\n  }, [bookKey, pullProgress]);\n\n  // Pull: pull progress once when the book is opened\n  useEffect(() => {\n    if (!appService || !kosyncClient || !progress?.location) return;\n    if (hasPulledOnce.current) return;\n\n    pullProgress();\n  }, [appService, kosyncClient, progress?.location, pushProgress, pullProgress]);\n\n  // Push: auto-push progress when progress changes with a debounce\n  useEffect(() => {\n    if (syncState === 'synced' && progress) {\n      const { strategy, enabled } = settings.kosync;\n      if (strategy !== 'receive' && enabled) {\n        pushProgress();\n      }\n    }\n  }, [progress, syncState, settings.kosync, pushProgress]);\n\n  const resolveWithLocal = () => {\n    pushProgress();\n    pushProgress.flush();\n    setSyncState('synced');\n    setConflictDetails(null);\n  };\n\n  const resolveWithRemote = async () => {\n    const view = getView(bookKey);\n    const remote = conflictDetails?.remote;\n    const book = conflictDetails?.book;\n    const bookDoc = conflictDetails?.bookDoc;\n\n    if (!book || !bookDoc || !remote || !remote.progress || !view) return;\n\n    applyRemoteProgress(book, bookDoc, remote);\n    setSyncState('synced');\n    setConflictDetails(null);\n  };\n\n  return {\n    syncState,\n    conflictDetails,\n    errorMessage,\n    pushProgress,\n    pullProgress,\n    resolveWithLocal,\n    resolveWithRemote,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2236, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useAutoSaveBookCover.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useEffect } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { throttle } from '@/utils/throttle';\nimport { getCoverFilename } from '@/utils/book';\nimport { eventDispatcher } from '@/utils/event';\n\nexport const useBookCoverAutoSave = (bookKey: string) => {\n  const _ = useTranslation();\n  const { envConfig, appService } = useEnv();\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const saveBookCover = useCallback(\n    throttle(\n      () => {\n        setTimeout(async () => {\n          const settings = useSettingsStore.getState().settings;\n          const bookData = useBookDataStore.getState().getBookData(bookKey);\n          const book = bookData?.book;\n          const savedBookHash = settings.savedBookCoverForLockScreen;\n          const savedCoverPath = settings.savedBookCoverForLockScreenPath;\n          if (appService && book && savedBookHash && savedBookHash !== book?.hash) {\n            const coverPath = await appService.resolveFilePath(getCoverFilename(book), 'Books');\n            try {\n              const lastCoverFilename = 'last-book-cover.png';\n              const builtinImagesPath = await appService.resolveFilePath('', 'Images');\n              if (!savedCoverPath || savedCoverPath === builtinImagesPath) {\n                await appService.copyFile(coverPath, lastCoverFilename, 'Images');\n              } else {\n                await appService.copyFile(\n                  coverPath,\n                  `${savedCoverPath}/${lastCoverFilename}`,\n                  'None',\n                );\n              }\n              settings.savedBookCoverForLockScreen = book.hash;\n              useSettingsStore.getState().setSettings(settings);\n              useSettingsStore.getState().saveSettings(envConfig, settings);\n            } catch (error) {\n              eventDispatcher.dispatch('toast', {\n                type: 'error',\n                message: _('Failed to auto-save book cover for lock screen: {{error}}', {\n                  error: error instanceof Error ? error.message : String(error),\n                }),\n              });\n            }\n          }\n        }, 5000);\n      },\n      5000,\n      { emitLast: false },\n    ),\n    [],\n  );\n\n  useEffect(() => {\n    saveBookCover();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AATA;;;;;;;;;AAWO,MAAM,uBAAuB,CAAC;IACnC,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAExC,uDAAuD;IACvD,MAAM,gBAAgB,IAAA,kHAAW,EAC/B,IAAA,uJAAQ,EACN;QACE,WAAW;YACT,MAAM,WAAW,oKAAgB,CAAC,QAAQ,GAAG,QAAQ;YACrD,MAAM,WAAW,oKAAgB,CAAC,QAAQ,GAAG,WAAW,CAAC;YACzD,MAAM,OAAO,UAAU;YACvB,MAAM,gBAAgB,SAAS,2BAA2B;YAC1D,MAAM,iBAAiB,SAAS,+BAA+B;YAC/D,IAAI,cAAc,QAAQ,iBAAiB,kBAAkB,MAAM,MAAM;gBACvE,MAAM,YAAY,MAAM,WAAW,eAAe,CAAC,IAAA,2JAAgB,EAAC,OAAO;gBAC3E,IAAI;oBACF,MAAM,oBAAoB;oBAC1B,MAAM,oBAAoB,MAAM,WAAW,eAAe,CAAC,IAAI;oBAC/D,IAAI,CAAC,kBAAkB,mBAAmB,mBAAmB;wBAC3D,MAAM,WAAW,QAAQ,CAAC,WAAW,mBAAmB;oBAC1D,OAAO;wBACL,MAAM,WAAW,QAAQ,CACvB,WACA,GAAG,eAAe,CAAC,EAAE,mBAAmB,EACxC;oBAEJ;oBACA,SAAS,2BAA2B,GAAG,KAAK,IAAI;oBAChD,oKAAgB,CAAC,QAAQ,GAAG,WAAW,CAAC;oBACxC,oKAAgB,CAAC,QAAQ,GAAG,YAAY,CAAC,WAAW;gBACtD,EAAE,OAAO,OAAO;oBACd,2JAAe,CAAC,QAAQ,CAAC,SAAS;wBAChC,MAAM;wBACN,SAAS,EAAE,6DAA6D;4BACtE,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;wBACzD;oBACF;gBACF;YACF;QACF,GAAG;IACL,GACA,MACA;QAAE,UAAU;IAAM,IAEpB,EAAE;IAGJ,IAAA,gHAAS,EAAC;QACR;IACA,uDAAuD;IACzD,GAAG,EAAE;AACP"}},
    {"offset": {"line": 2313, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useNotesSync.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useEffect } from 'react';\nimport { useAuth } from '@/context/AuthContext';\nimport { useSync } from '@/hooks/useSync';\nimport { BookNote } from '@/types/book';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { SYNC_NOTES_INTERVAL_SEC } from '@/services/constants';\nimport { throttle } from '@/utils/throttle';\n\nexport const useNotesSync = (bookKey: string) => {\n  const { user } = useAuth();\n  const { syncedNotes, syncNotes, lastSyncedAtNotes } = useSync(bookKey);\n  const { getConfig, setConfig, getBookData } = useBookDataStore();\n\n  const config = getConfig(bookKey);\n\n  const getNewNotes = useCallback(() => {\n    const config = getConfig(bookKey);\n    const book = getBookData(bookKey)?.book;\n    if (!config?.location || !book || !user) return {};\n\n    const bookNotes = config.booknotes ?? [];\n    const newNotes = bookNotes.filter(\n      (note) => lastSyncedAtNotes < note.updatedAt || lastSyncedAtNotes < (note.deletedAt ?? 0),\n    );\n    newNotes.forEach((note) => {\n      note.bookHash = book.hash;\n      note.metaHash = book.metaHash;\n    });\n    return {\n      notes: newNotes,\n      lastSyncedAt: lastSyncedAtNotes,\n    };\n  }, [user, bookKey, lastSyncedAtNotes, getConfig, getBookData]);\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const handleAutoSync = useCallback(\n    throttle(\n      () => {\n        const book = getBookData(bookKey)?.book;\n        const newNotes = getNewNotes();\n        syncNotes(newNotes.notes, book?.hash, book?.metaHash, 'both');\n      },\n      SYNC_NOTES_INTERVAL_SEC * 1000,\n      { emitLast: false },\n    ),\n    [syncNotes],\n  );\n\n  useEffect(() => {\n    if (!config?.location || !user) return;\n    handleAutoSync();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [config?.booknotes, handleAutoSync]);\n\n  useEffect(() => {\n    const processNewNote = (note: BookNote) => {\n      const config = getConfig(bookKey);\n      const oldNotes = config?.booknotes ?? [];\n      const existingNote = oldNotes.find((oldNote) => oldNote.id === note.id);\n      if (existingNote) {\n        if (\n          existingNote.updatedAt < note.updatedAt ||\n          (existingNote.deletedAt ?? 0) < (note.deletedAt ?? 0)\n        ) {\n          return { ...existingNote, ...note };\n        } else {\n          return { ...note, ...existingNote };\n        }\n      }\n      return note;\n    };\n    if (syncedNotes?.length && config) {\n      const book = getBookData(bookKey)?.book;\n      const newNotes = syncedNotes.filter(\n        (note) => note.bookHash === book?.hash || note.metaHash === book?.metaHash,\n      );\n      if (!newNotes.length) return;\n      const oldNotes = config.booknotes ?? [];\n      const mergedNotes = [\n        ...oldNotes.filter((oldNote) => !newNotes.some((newNote) => newNote.id === oldNote.id)),\n        ...newNotes.map(processNewNote),\n      ];\n      setConfig(bookKey, { booknotes: mergedNotes });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [syncedNotes]);\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AAEA;AACA;AACA;;;;;;AARA;;;;;;;AAUO,MAAM,eAAe,CAAC;IAC3B,MAAM,EAAE,IAAI,EAAE,GAAG,IAAA,4JAAO;IACxB,MAAM,EAAE,WAAW,EAAE,SAAS,EAAE,iBAAiB,EAAE,GAAG,IAAA,qJAAO,EAAC;IAC9D,MAAM,EAAE,SAAS,EAAE,SAAS,EAAE,WAAW,EAAE,GAAG,IAAA,oKAAgB;IAE9D,MAAM,SAAS,UAAU;IAEzB,MAAM,cAAc,IAAA,kHAAW,EAAC;QAC9B,MAAM,SAAS,UAAU;QACzB,MAAM,OAAO,YAAY,UAAU;QACnC,IAAI,CAAC,QAAQ,YAAY,CAAC,QAAQ,CAAC,MAAM,OAAO,CAAC;QAEjD,MAAM,YAAY,OAAO,SAAS,IAAI,EAAE;QACxC,MAAM,WAAW,UAAU,MAAM,CAC/B,CAAC,OAAS,oBAAoB,KAAK,SAAS,IAAI,oBAAoB,CAAC,KAAK,SAAS,IAAI,CAAC;QAE1F,SAAS,OAAO,CAAC,CAAC;YAChB,KAAK,QAAQ,GAAG,KAAK,IAAI;YACzB,KAAK,QAAQ,GAAG,KAAK,QAAQ;QAC/B;QACA,OAAO;YACL,OAAO;YACP,cAAc;QAChB;IACF,GAAG;QAAC;QAAM;QAAS;QAAmB;QAAW;KAAY;IAE7D,uDAAuD;IACvD,MAAM,iBAAiB,IAAA,kHAAW,EAChC,IAAA,uJAAQ,EACN;QACE,MAAM,OAAO,YAAY,UAAU;QACnC,MAAM,WAAW;QACjB,UAAU,SAAS,KAAK,EAAE,MAAM,MAAM,MAAM,UAAU;IACxD,GACA,0KAAuB,GAAG,MAC1B;QAAE,UAAU;IAAM,IAEpB;QAAC;KAAU;IAGb,IAAA,gHAAS,EAAC;QACR,IAAI,CAAC,QAAQ,YAAY,CAAC,MAAM;QAChC;IACA,uDAAuD;IACzD,GAAG;QAAC,QAAQ;QAAW;KAAe;IAEtC,IAAA,gHAAS,EAAC;QACR,MAAM,iBAAiB,CAAC;YACtB,MAAM,SAAS,UAAU;YACzB,MAAM,WAAW,QAAQ,aAAa,EAAE;YACxC,MAAM,eAAe,SAAS,IAAI,CAAC,CAAC,UAAY,QAAQ,EAAE,KAAK,KAAK,EAAE;YACtE,IAAI,cAAc;gBAChB,IACE,aAAa,SAAS,GAAG,KAAK,SAAS,IACvC,CAAC,aAAa,SAAS,IAAI,CAAC,IAAI,CAAC,KAAK,SAAS,IAAI,CAAC,GACpD;oBACA,OAAO;wBAAE,GAAG,YAAY;wBAAE,GAAG,IAAI;oBAAC;gBACpC,OAAO;oBACL,OAAO;wBAAE,GAAG,IAAI;wBAAE,GAAG,YAAY;oBAAC;gBACpC;YACF;YACA,OAAO;QACT;QACA,IAAI,aAAa,UAAU,QAAQ;YACjC,MAAM,OAAO,YAAY,UAAU;YACnC,MAAM,WAAW,YAAY,MAAM,CACjC,CAAC,OAAS,KAAK,QAAQ,KAAK,MAAM,QAAQ,KAAK,QAAQ,KAAK,MAAM;YAEpE,IAAI,CAAC,SAAS,MAAM,EAAE;YACtB,MAAM,WAAW,OAAO,SAAS,IAAI,EAAE;YACvC,MAAM,cAAc;mBACf,SAAS,MAAM,CAAC,CAAC,UAAY,CAAC,SAAS,IAAI,CAAC,CAAC,UAAY,QAAQ,EAAE,KAAK,QAAQ,EAAE;mBAClF,SAAS,GAAG,CAAC;aACjB;YACD,UAAU,SAAS;gBAAE,WAAW;YAAY;QAC9C;IACA,uDAAuD;IACzD,GAAG;QAAC;KAAY;AAClB"}},
    {"offset": {"line": 2424, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useInstantAnnotation.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useRef } from 'react';\nimport { BookNote } from '@/types/book';\nimport { Point, TextSelection } from '@/utils/sel';\nimport { useEnv } from '@/context/EnvContext';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { uniqueId } from '@/utils/misc';\n\ninterface UseInstantAnnotationProps {\n  bookKey: string;\n  getAnnotationText: (range: Range) => Promise<string>;\n  setSelection: React.Dispatch<React.SetStateAction<TextSelection | null>>;\n}\n\nexport const useInstantAnnotation = ({ bookKey, getAnnotationText }: UseInstantAnnotationProps) => {\n  const { envConfig } = useEnv();\n  const { settings } = useSettingsStore();\n  const { getConfig, saveConfig, updateBooknotes } = useBookDataStore();\n  const { getView, getViewsById, getViewSettings } = useReaderStore();\n\n  const startPointRef = useRef<Point | null>(null);\n  const startDocRef = useRef<Document | null>(null);\n  const startIndexRef = useRef<number>(0);\n  const previewAnnotationRef = useRef<BookNote | null>(null);\n  const annotationIdRef = useRef<string>(uniqueId());\n\n  const isInstantAnnotationEnabled = useCallback(() => {\n    const viewSettings = getViewSettings(bookKey);\n    return (\n      viewSettings?.enableAnnotationQuickActions &&\n      viewSettings?.annotationQuickAction === 'highlight'\n    );\n  }, [bookKey, getViewSettings]);\n\n  const clearPreviewAnnotation = useCallback(() => {\n    if (previewAnnotationRef.current) {\n      const views = getViewsById(bookKey.split('-')[0]!);\n      views.forEach((v) => v?.addAnnotation(previewAnnotationRef.current!, true));\n      previewAnnotationRef.current = null;\n    }\n  }, [bookKey, getViewsById]);\n\n  const findPositionAtPoint = useCallback((doc: Document, x: number, y: number) => {\n    if (doc.caretPositionFromPoint) {\n      const pos = doc.caretPositionFromPoint(x, y);\n      if (pos) return { node: pos.offsetNode, offset: pos.offset };\n    }\n    if (doc.caretRangeFromPoint) {\n      const range = doc.caretRangeFromPoint(x, y);\n      if (range) return { node: range.startContainer, offset: range.startOffset };\n    }\n    return null;\n  }, []);\n\n  const isSelectableContent = useCallback(\n    (doc: Document, x: number, y: number): boolean => {\n      const pos = findPositionAtPoint(doc, x, y);\n      if (!pos) return false;\n\n      // Must be a text node\n      if (pos.node.nodeType !== Node.TEXT_NODE) return false;\n\n      const textNode = pos.node as Text;\n      const textLength = textNode.length;\n      if (textLength === 0) return false;\n\n      // Create a range around the caret position to get the character bounds\n      const range = doc.createRange();\n      try {\n        // Get bounds of character at or after the caret position\n        const startOffset = Math.min(pos.offset, textLength - 1);\n        const endOffset = Math.min(pos.offset + 1, textLength);\n        range.setStart(textNode, startOffset);\n        range.setEnd(textNode, endOffset);\n\n        const rects = range.getClientRects();\n        for (const rect of rects) {\n          const tolerance = 20;\n          if (\n            x >= rect.left - tolerance &&\n            x <= rect.right + tolerance &&\n            y >= rect.top - tolerance &&\n            y <= rect.bottom + tolerance\n          ) {\n            return true;\n          }\n        }\n      } catch {\n        return false;\n      }\n\n      return false;\n    },\n    [findPositionAtPoint],\n  );\n\n  const createRangeFromPoints = useCallback(\n    (doc: Document, startPoint: Point, endPoint: Point) => {\n      const startPos = findPositionAtPoint(doc, startPoint.x, startPoint.y);\n      const endPos = findPositionAtPoint(doc, endPoint.x, endPoint.y);\n\n      if (!startPos || !endPos) return null;\n\n      const newRange = doc.createRange();\n      try {\n        const positionComparison = startPos.node.compareDocumentPosition(endPos.node);\n        const needsSwap =\n          positionComparison & Node.DOCUMENT_POSITION_PRECEDING ||\n          (startPos.node === endPos.node && startPos.offset > endPos.offset);\n\n        if (needsSwap) {\n          newRange.setStart(endPos.node, endPos.offset);\n          newRange.setEnd(startPos.node, startPos.offset);\n        } else {\n          newRange.setStart(startPos.node, startPos.offset);\n          newRange.setEnd(endPos.node, endPos.offset);\n        }\n\n        if (newRange.collapsed) {\n          return null;\n        }\n        return newRange;\n      } catch (e) {\n        console.warn('Failed to create range:', e);\n        return null;\n      }\n    },\n    [findPositionAtPoint],\n  );\n\n  const createAnnotation = useCallback((cfi: string, text?: string) => {\n    const style = settings.globalReadSettings.highlightStyle;\n    const color = settings.globalReadSettings.highlightStyles[style];\n    const annotation: BookNote = {\n      id: annotationIdRef.current,\n      type: 'annotation',\n      cfi,\n      style,\n      color,\n      text: text ?? '',\n      note: '',\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n    return annotation;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const handleInstantAnnotationPointerDown = useCallback(\n    (doc: Document, index: number, ev: PointerEvent) => {\n      if (!isInstantAnnotationEnabled()) return false;\n\n      // Only handle primary button (left click / touch / stylus)\n      if (ev.button !== 0) return false;\n\n      if (!isSelectableContent(doc, ev.clientX, ev.clientY)) return false;\n\n      startPointRef.current = { x: ev.clientX, y: ev.clientY };\n      startDocRef.current = doc;\n      startIndexRef.current = index;\n      previewAnnotationRef.current = null;\n      annotationIdRef.current = uniqueId();\n      return true;\n    },\n    [isInstantAnnotationEnabled, isSelectableContent],\n  );\n\n  const handleInstantAnnotationPointerMove = useCallback(\n    (doc: Document, index: number, ev: PointerEvent) => {\n      if (!isInstantAnnotationEnabled()) return false;\n\n      const view = getView(bookKey);\n      if (!startPointRef.current || !startDocRef.current || !view) {\n        return false;\n      }\n\n      const endPoint: Point = { x: ev.clientX, y: ev.clientY };\n      const startPoint = startPointRef.current;\n\n      const deltaX = Math.abs(endPoint.x - startPoint.x);\n      const deltaY = Math.abs(endPoint.y - startPoint.y);\n      const distance = Math.sqrt(Math.pow(deltaX, 2) + Math.pow(deltaY, 2));\n      // need a longer horizontal or vertical drag to avoid accidental selections\n      if (distance < 20 || (deltaX / deltaY < 5 && deltaY / deltaX < 5 && distance < 30)) {\n        return false;\n      }\n\n      const newRange = createRangeFromPoints(doc, startPoint, endPoint);\n      if (!newRange) return false;\n\n      const cfi = view.getCFI(index, newRange);\n      if (!cfi) return false;\n\n      clearPreviewAnnotation();\n      const annotation = createAnnotation(cfi);\n      const views = getViewsById(bookKey.split('-')[0]!);\n      views.forEach((v) => v?.addAnnotation(annotation));\n      previewAnnotationRef.current = annotation;\n\n      return true;\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [isInstantAnnotationEnabled, createRangeFromPoints],\n  );\n\n  const handleInstantAnnotationPointerCancel = useCallback(() => {\n    if (!isInstantAnnotationEnabled()) return false;\n\n    startPointRef.current = null;\n    startDocRef.current = null;\n    clearPreviewAnnotation();\n    return true;\n  }, [isInstantAnnotationEnabled, clearPreviewAnnotation]);\n\n  const handleInstantAnnotationPointerUp = useCallback(\n    async (doc: Document, index: number, ev: PointerEvent) => {\n      if (!isInstantAnnotationEnabled()) return false;\n\n      const view = getView(bookKey);\n      if (!startPointRef.current || !view) {\n        startPointRef.current = null;\n        startDocRef.current = null;\n        clearPreviewAnnotation();\n        return false;\n      }\n\n      const endPoint: Point = { x: ev.clientX, y: ev.clientY };\n      const startPoint = startPointRef.current;\n\n      startPointRef.current = null;\n      startDocRef.current = null;\n\n      const distance = Math.sqrt(\n        Math.pow(endPoint.x - startPoint.x, 2) + Math.pow(endPoint.y - startPoint.y, 2),\n      );\n      if (distance < 10) {\n        clearPreviewAnnotation();\n        return false;\n      }\n\n      const newRange = createRangeFromPoints(doc, startPoint, endPoint);\n      if (!newRange) {\n        clearPreviewAnnotation();\n        return false;\n      }\n\n      const text = await getAnnotationText(newRange);\n      const cfi = view.getCFI(index, newRange);\n\n      if (!text || !cfi || text.trim().length === 0) {\n        clearPreviewAnnotation();\n        return false;\n      }\n\n      clearPreviewAnnotation();\n      const annotation = createAnnotation(cfi, text);\n      const views = getViewsById(bookKey.split('-')[0]!);\n      views.forEach((v) => v?.addAnnotation(annotation));\n\n      const config = getConfig(bookKey)!;\n      const { booknotes: annotations = [] } = config;\n      const existingIndex = annotations.findIndex(\n        (a) => a.cfi === cfi && a.type === 'annotation' && a.style && !a.deletedAt,\n      );\n\n      if (existingIndex !== -1) {\n        annotations[existingIndex] = {\n          ...annotations[existingIndex]!,\n          ...annotation,\n          id: annotations[existingIndex]!.id,\n        };\n      } else {\n        annotations.push(annotation);\n      }\n\n      const updatedConfig = updateBooknotes(bookKey, annotations);\n      if (updatedConfig) {\n        saveConfig(envConfig, bookKey, updatedConfig, settings);\n      }\n\n      return true;\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [isInstantAnnotationEnabled, createRangeFromPoints, getAnnotationText, clearPreviewAnnotation],\n  );\n\n  const cancelInstantAnnotation = useCallback(() => {\n    startPointRef.current = null;\n    startDocRef.current = null;\n    clearPreviewAnnotation();\n  }, [clearPreviewAnnotation]);\n\n  return {\n    isInstantAnnotationEnabled,\n    handleInstantAnnotationPointerDown,\n    handleInstantAnnotationPointerMove,\n    handleInstantAnnotationPointerCancel,\n    handleInstantAnnotationPointerUp,\n    cancelInstantAnnotation,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2708, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useTextSelector.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useReaderStore } from '@/store/readerStore';\nimport { getOSPlatform } from '@/utils/misc';\nimport { eventDispatcher } from '@/utils/event';\nimport { isPointerInsideSelection, TextSelection } from '@/utils/sel';\nimport { useInstantAnnotation } from './useInstantAnnotation';\n\nexport const useTextSelector = (\n  bookKey: string,\n  setSelection: React.Dispatch<React.SetStateAction<TextSelection | null>>,\n  getAnnotationText: (range: Range) => Promise<string>,\n  handleDismissPopup: () => void,\n) => {\n  const { appService } = useEnv();\n  const { getView, getViewSettings } = useReaderStore();\n  const view = getView(bookKey);\n  const osPlatform = getOSPlatform();\n\n  const isPopuped = useRef(false);\n  const isUpToPopup = useRef(false);\n  const isTextSelected = useRef(false);\n  const isTouchStarted = useRef(false);\n  const selectionPosition = useRef<number | null>(null);\n  const lastPointerType = useRef<string>('mouse');\n  const isInstantAnnotating = useRef(false);\n  const isInstantAnnotated = useRef(false);\n\n  const {\n    isInstantAnnotationEnabled,\n    handleInstantAnnotationPointerDown,\n    handleInstantAnnotationPointerMove,\n    handleInstantAnnotationPointerCancel,\n    handleInstantAnnotationPointerUp,\n  } = useInstantAnnotation({ bookKey, getAnnotationText, setSelection });\n\n  const isValidSelection = (sel: Selection) => {\n    return sel && sel.toString().trim().length > 0 && sel.rangeCount > 0;\n  };\n\n  const makeSelection = async (sel: Selection, index: number, rebuildRange = false) => {\n    isTextSelected.current = true;\n    const range = sel.getRangeAt(0);\n    if (rebuildRange) {\n      sel.removeAllRanges();\n      sel.addRange(range);\n    }\n    setSelection({\n      key: bookKey,\n      text: await getAnnotationText(range),\n      cfi: view?.getCFI(index, range),\n      range,\n      index,\n    });\n  };\n  // FIXME: extremely hacky way to dismiss system selection tools on iOS\n  const makeSelectionOnIOS = async (sel: Selection, index: number) => {\n    isTextSelected.current = true;\n    const range = sel.getRangeAt(0);\n    setTimeout(() => {\n      sel.removeAllRanges();\n      setTimeout(async () => {\n        if (!isTextSelected.current) return;\n        sel.addRange(range);\n        setSelection({\n          key: bookKey,\n          text: await getAnnotationText(range),\n          cfi: view?.getCFI(index, range),\n          range,\n          index,\n        });\n      }, 30);\n    }, 30);\n  };\n\n  const startInstantAnnotating = (ev: PointerEvent) => {\n    isInstantAnnotating.current = true;\n    isInstantAnnotated.current = false;\n    if (view) view.renderer.scrollLocked = true;\n    (ev.target as HTMLElement).style.userSelect = 'none';\n  };\n\n  const stopInstantAnnotating = (ev: PointerEvent) => {\n    isInstantAnnotating.current = false;\n    isInstantAnnotated.current = false;\n    if (view) view.renderer.scrollLocked = false;\n    (ev.target as HTMLElement).style.userSelect = '';\n  };\n\n  const handlePointerDown = (doc: Document, index: number, ev: PointerEvent) => {\n    lastPointerType.current = ev.pointerType;\n\n    if (isInstantAnnotationEnabled()) {\n      const handled = handleInstantAnnotationPointerDown(doc, index, ev);\n      if (handled) {\n        ev.preventDefault();\n        startInstantAnnotating(ev);\n      }\n    }\n  };\n\n  const handlePointerMove = (doc: Document, index: number, ev: PointerEvent) => {\n    if (isInstantAnnotating.current) {\n      ev.preventDefault();\n      isInstantAnnotated.current = handleInstantAnnotationPointerMove(doc, index, ev);\n    }\n  };\n\n  const handlePointerCancel = (_doc: Document, _index: number, ev: PointerEvent) => {\n    if (isInstantAnnotating.current) {\n      stopInstantAnnotating(ev);\n      handleInstantAnnotationPointerCancel();\n    }\n  };\n\n  const handlePointerUp = async (doc: Document, index: number, ev?: PointerEvent) => {\n    if (isInstantAnnotating.current && ev) {\n      stopInstantAnnotating(ev);\n      const handled = await handleInstantAnnotationPointerUp(doc, index, ev);\n      if (handled) {\n        isTextSelected.current = true;\n        return;\n      } else {\n        // If instant annotation was not created, we let the event propagate\n        // as an iframe click event which relies on a mousedown event\n        (ev.target as Element)?.dispatchEvent(\n          new MouseEvent('mousedown', {\n            ...ev,\n            bubbles: true,\n            cancelable: true,\n          }),\n        );\n      }\n    }\n\n    // Available on iOS and Desktop, fired at touchend or mouseup\n    // Note that on Android, we mock pointer events with native touch events\n    const sel = doc.getSelection() as Selection;\n    if (isValidSelection(sel)) {\n      const isPointerInside = ev && isPointerInsideSelection(sel, ev);\n      const isIOS = osPlatform === 'ios' || appService?.isIOSApp;\n\n      if (isPointerInside && isIOS) {\n        makeSelectionOnIOS(sel, index);\n      } else if (isPointerInside) {\n        isUpToPopup.current = true;\n        makeSelection(sel, index, true);\n      }\n    }\n  };\n  const handleTouchStart = () => {\n    isTouchStarted.current = true;\n  };\n  const handleTouchMove = (ev: TouchEvent) => {\n    if (isInstantAnnotating.current && isInstantAnnotated.current) {\n      ev.preventDefault();\n    }\n  };\n  const handleTouchEnd = () => {\n    isTouchStarted.current = false;\n  };\n  const handleSelectionchange = (doc: Document, index: number) => {\n    // Available on iOS, Android and Desktop, fired when the selection is changed\n    if (osPlatform !== 'android' || !appService?.isAndroidApp) return;\n\n    const sel = doc.getSelection() as Selection;\n    if (isValidSelection(sel)) {\n      if (!selectionPosition.current) {\n        selectionPosition.current = view?.renderer?.start || null;\n      }\n      makeSelection(sel, index, false);\n    } else {\n      selectionPosition.current = null;\n    }\n  };\n  const handleScroll = () => {\n    // Prevent the container from scrolling when text is selected in paginated mode\n    // FIXME: this is a workaround for issue #873\n    // TODO: support text selection across pages\n    if (osPlatform !== 'android' || !appService?.isAndroidApp) return;\n\n    const viewSettings = getViewSettings(bookKey);\n    if (viewSettings?.scrolled) return;\n\n    if (isTextSelected.current && view?.renderer?.containerPosition && selectionPosition.current) {\n      console.warn('Keep container position', selectionPosition.current);\n      view.renderer.containerPosition = selectionPosition.current;\n    }\n  };\n\n  const handleShowPopup = (showPopup: boolean) => {\n    setTimeout(() => {\n      if (showPopup && !isPopuped.current) {\n        isUpToPopup.current = false;\n      }\n      isPopuped.current = showPopup;\n    }, 500);\n  };\n\n  const handleUpToPopup = () => {\n    isUpToPopup.current = true;\n  };\n\n  const handleContextmenu = (event: Event) => {\n    if (appService?.isMobile) {\n      event.preventDefault();\n      event.stopPropagation();\n      return false;\n    } else if (lastPointerType.current === 'touch' || lastPointerType.current === 'pen') {\n      event.preventDefault();\n      event.stopPropagation();\n      return false;\n    }\n    return;\n  };\n\n  useEffect(() => {\n    const handleSingleClick = (): boolean => {\n      if (isUpToPopup.current) {\n        isUpToPopup.current = false;\n        return true;\n      }\n      if (isTextSelected.current) {\n        handleDismissPopup();\n        isTextSelected.current = false;\n        view?.deselect();\n        return true;\n      }\n      if (isPopuped.current) {\n        handleDismissPopup();\n        return true;\n      }\n      return false;\n    };\n\n    eventDispatcher.onSync('iframe-single-click', handleSingleClick);\n    return () => {\n      eventDispatcher.offSync('iframe-single-click', handleSingleClick);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  return {\n    isTextSelected,\n    handleScroll,\n    handleTouchStart,\n    handleTouchMove,\n    handleTouchEnd,\n    handlePointerDown,\n    handlePointerMove,\n    handlePointerCancel,\n    handlePointerUp,\n    handleSelectionchange,\n    handleShowPopup,\n    handleUpToPopup,\n    handleContextmenu,\n  };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2958, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/hooks/useAnnotationEditor.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useRef, useState } from 'react';\nimport { BookNote } from '@/types/book';\nimport { Point, TextSelection } from '@/utils/sel';\nimport { useEnv } from '@/context/EnvContext';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\n\ninterface HandlePositions {\n  start: Point;\n  end: Point;\n}\n\ninterface UseAnnotationEditorProps {\n  bookKey: string;\n  annotation: BookNote;\n  getAnnotationText: (range: Range) => Promise<string>;\n  setSelection: React.Dispatch<React.SetStateAction<TextSelection | null>>;\n}\n\nexport const useAnnotationEditor = ({\n  bookKey,\n  annotation,\n  getAnnotationText,\n  setSelection,\n}: UseAnnotationEditorProps) => {\n  const { envConfig } = useEnv();\n  const { settings } = useSettingsStore();\n  const { getConfig, saveConfig, updateBooknotes } = useBookDataStore();\n  const { getView, getViewsById } = useReaderStore();\n\n  const view = getView(bookKey);\n  const editingAnnotationRef = useRef(annotation);\n  const [handlePositions, setHandlePositions] = useState<HandlePositions | null>(null);\n\n  const getHandlePositionsFromRange = useCallback(\n    (range: Range, isVertical: boolean): HandlePositions | null => {\n      const gridFrame = document.querySelector(`#gridcell-${bookKey}`);\n      if (!gridFrame) return null;\n\n      const rects = Array.from(range.getClientRects());\n      if (rects.length === 0) return null;\n\n      const firstRect = rects[0]!;\n      const lastRect = rects[rects.length - 1]!;\n      const frameElement = range.commonAncestorContainer.ownerDocument?.defaultView?.frameElement;\n      const frameRect = frameElement?.getBoundingClientRect() ?? { top: 0, left: 0 };\n\n      return {\n        start: {\n          x: frameRect.left + (isVertical ? firstRect.right : firstRect.left),\n          y: frameRect.top + firstRect.top,\n        },\n        end: {\n          x: frameRect.left + (isVertical ? lastRect.left : lastRect.right),\n          y: frameRect.top + lastRect.bottom,\n        },\n      };\n    },\n    [bookKey],\n  );\n\n  const handleAnnotationRangeChange = useCallback(\n    async (startPoint: Point, endPoint: Point, isVertical: boolean, isDragging: boolean) => {\n      if (!editingAnnotationRef.current || !view) return;\n\n      const contents = view.renderer.getContents();\n      if (!contents || contents.length === 0) return;\n\n      // the point is from viewport, need to adjust to each content's coordinate\n      const findPositionAtPoint = (doc: Document, x: number, y: number) => {\n        const frameElement = doc.defaultView?.frameElement;\n        const frameRect = frameElement?.getBoundingClientRect() ?? { top: 0, left: 0 };\n        const adjustedX = x - frameRect.left;\n        const adjustedY = y - frameRect.top;\n\n        if (doc.caretPositionFromPoint) {\n          const pos = doc.caretPositionFromPoint(adjustedX, adjustedY);\n          if (pos) return { node: pos.offsetNode, offset: pos.offset };\n        }\n        if (doc.caretRangeFromPoint) {\n          const range = doc.caretRangeFromPoint(adjustedX, adjustedY);\n          if (range) return { node: range.startContainer, offset: range.startOffset };\n        }\n        return null;\n      };\n\n      let startPos = null;\n      let endPos = null;\n      let targetDoc: Document | null = null;\n      let targetIndex = 0;\n\n      for (const content of contents) {\n        const { doc, index } = content;\n        if (!doc) continue;\n\n        const sp = findPositionAtPoint(doc, startPoint.x, startPoint.y);\n        const ep = findPositionAtPoint(doc, endPoint.x, endPoint.y);\n\n        if (sp && ep) {\n          startPos = sp;\n          endPos = ep;\n          targetDoc = doc;\n          targetIndex = index ?? 0;\n          break;\n        }\n      }\n\n      if (!startPos || !endPos || !targetDoc) return;\n\n      const newRange = targetDoc.createRange();\n      try {\n        const positionComparison = startPos.node.compareDocumentPosition(endPos.node);\n        const needsSwap =\n          positionComparison & Node.DOCUMENT_POSITION_PRECEDING ||\n          (startPos.node === endPos.node && startPos.offset > endPos.offset);\n\n        if (needsSwap) {\n          newRange.setStart(endPos.node, endPos.offset);\n          newRange.setEnd(startPos.node, startPos.offset);\n        } else {\n          newRange.setStart(startPos.node, startPos.offset);\n          newRange.setEnd(endPos.node, endPos.offset);\n        }\n\n        if (newRange.collapsed) {\n          console.warn('Range is collapsed');\n          return;\n        }\n      } catch (e) {\n        console.warn('Failed to create range:', e);\n        return;\n      }\n\n      const newPositions = getHandlePositionsFromRange(newRange, isVertical);\n      if (newPositions) {\n        setHandlePositions(newPositions);\n      }\n\n      const newCfi = view.getCFI(targetIndex, newRange);\n      const newText = await getAnnotationText(newRange);\n\n      if (newCfi && newText) {\n        const config = getConfig(bookKey)!;\n        const { booknotes: annotations = [] } = config;\n        const existingIndex = annotations.findIndex(\n          (a) => a.id === editingAnnotationRef.current.id && !a.deletedAt,\n        );\n\n        if (existingIndex !== -1) {\n          const updatedAnnotation: BookNote = {\n            ...annotations[existingIndex]!,\n            cfi: newCfi,\n            text: newText,\n            updatedAt: Date.now(),\n          };\n\n          const views = getViewsById(bookKey.split('-')[0]!);\n          views.forEach((v) => v?.addAnnotation(editingAnnotationRef.current, true));\n          views.forEach((v) => v?.addAnnotation(updatedAnnotation));\n          editingAnnotationRef.current = updatedAnnotation;\n\n          if (!isDragging) {\n            annotations[existingIndex] = updatedAnnotation;\n            const updatedConfig = updateBooknotes(bookKey, annotations);\n            if (updatedConfig) {\n              saveConfig(envConfig, bookKey, updatedConfig, settings);\n            }\n\n            setSelection({\n              key: bookKey,\n              annotated: true,\n              text: newText,\n              cfi: newCfi,\n              range: newRange,\n              index: targetIndex,\n            });\n          }\n        }\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [bookKey, getHandlePositionsFromRange, getAnnotationText, setSelection],\n  );\n\n  return {\n    handlePositions,\n    setHandlePositions,\n    getHandlePositionsFromRange,\n    handleAnnotationRangeChange,\n  };\n};\n"],"names":[],"mappings":"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"}}]
}