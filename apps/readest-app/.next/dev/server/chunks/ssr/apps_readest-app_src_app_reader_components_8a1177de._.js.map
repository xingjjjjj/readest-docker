{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/KOSyncSettings.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useState, useEffect, useMemo, useCallback } from 'react';\nimport { md5 } from 'js-md5';\nimport { type as osType } from '@tauri-apps/plugin-os';\nimport { useEnv } from '@/context/EnvContext';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { eventDispatcher } from '@/utils/event';\nimport { KOSyncClient } from '@/services/sync/KOSyncClient';\nimport { KOSyncChecksumMethod, KOSyncStrategy } from '@/types/settings';\nimport { debounce } from '@/utils/debounce';\nimport { getOSPlatform } from '@/utils/misc';\nimport Dialog from '@/components/Dialog';\n\ntype Option = {\n  value: string;\n  label: string;\n  disabled?: boolean;\n};\n\ntype SelectProps = {\n  value: string;\n  onChange: (e: React.ChangeEvent<HTMLSelectElement>) => void;\n  options: Option[];\n  disabled?: boolean;\n  className?: string;\n};\n\nconst StyledSelect: React.FC<SelectProps> = ({\n  value,\n  onChange,\n  options,\n  className,\n  disabled = false,\n}) => {\n  return (\n    <select\n      value={value}\n      onChange={onChange}\n      className={clsx(\n        'select select-bordered h-12 w-full text-sm focus:outline-none focus:ring-0',\n        className,\n      )}\n      disabled={disabled}\n    >\n      {options.map(({ value, label, disabled = false }) => (\n        <option key={value} value={value} disabled={disabled}>\n          {label}\n        </option>\n      ))}\n    </select>\n  );\n};\n\nexport const setKOSyncSettingsWindowVisible = (visible: boolean) => {\n  const dialog = document.getElementById('kosync_settings_window');\n  if (dialog) {\n    const event = new CustomEvent('setKOSyncSettingsVisibility', {\n      detail: { visible },\n    });\n    dialog.dispatchEvent(event);\n  }\n};\n\nexport const KOSyncSettingsWindow: React.FC = () => {\n  const _ = useTranslation();\n  const { settings, setSettings, saveSettings } = useSettingsStore();\n  const { envConfig, appService } = useEnv();\n\n  const [isOpen, setIsOpen] = useState(false);\n  const [url, setUrl] = useState(settings.kosync.serverUrl || '');\n  const [username, setUsername] = useState(settings.kosync.username || '');\n  const [password, setPassword] = useState('');\n  const [isConnecting, setIsConnecting] = useState(false);\n  const [connectionStatus, setConnectionStatus] = useState('');\n  const [deviceName, setDeviceName] = useState('');\n  const [osName, setOsName] = useState('');\n\n  // Get the OS name once\n  useEffect(() => {\n    const formatOsName = (name: string): string => {\n      if (!name) return '';\n      if (name.toLowerCase() === 'macos') return 'macOS';\n      if (name.toLowerCase() === 'ios') return 'iOS';\n      return name.charAt(0).toUpperCase() + name.slice(1);\n    };\n\n    const getOsName = async () => {\n      let name = '';\n      if (appService?.appPlatform === 'tauri') {\n        name = await osType();\n      } else {\n        const platform = getOSPlatform();\n        if (platform !== 'unknown') {\n          name = platform;\n        }\n      }\n      setOsName(formatOsName(name));\n    };\n    getOsName();\n  }, [appService]);\n\n  useEffect(() => {\n    const defaultName = osName ? `Readest (${osName})` : 'Readest';\n    setDeviceName(settings.kosync.deviceName || defaultName);\n  }, [settings.kosync.deviceName, osName]);\n\n  const isConfigured = useMemo(() => !!settings.kosync.userkey, [settings.kosync.userkey]);\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const debouncedSaveDeviceName = useCallback(\n    debounce((newDeviceName: string) => {\n      const newSettings = { ...settings, koreaderSyncDeviceName: newDeviceName };\n      setSettings(newSettings);\n      saveSettings(envConfig, newSettings);\n    }, 500),\n    [settings, setSettings, saveSettings, envConfig],\n  );\n\n  const handleDeviceNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const newName = e.target.value;\n    setDeviceName(newName);\n    debouncedSaveDeviceName(newName);\n  };\n\n  useEffect(() => {\n    const handleCustomEvent = (event: CustomEvent) => {\n      setIsOpen(event.detail.visible);\n      if (event.detail.visible) {\n        setUrl(settings.kosync.serverUrl || '');\n        setUsername(settings.kosync.username || '');\n        setPassword('');\n        setConnectionStatus('');\n      }\n    };\n    const el = document.getElementById('kosync_settings_window');\n    el?.addEventListener('setKOSyncSettingsVisibility', handleCustomEvent as EventListener);\n    return () => {\n      el?.removeEventListener('setKOSyncSettingsVisibility', handleCustomEvent as EventListener);\n    };\n  }, [settings.kosync.serverUrl, settings.kosync.username]);\n\n  const handleConnect = async () => {\n    setIsConnecting(true);\n\n    const config = {\n      ...settings.kosync,\n      serverUrl: url,\n      username,\n      userkey: md5(password),\n      deviceName,\n      enabled: true,\n    };\n    const client = new KOSyncClient(config);\n    const result = await client.connect(username, password);\n\n    if (result.success) {\n      const newSettings = {\n        ...settings,\n        kosync: config,\n      };\n      setSettings(newSettings);\n      await saveSettings(envConfig, newSettings);\n    } else {\n      setConnectionStatus('');\n      eventDispatcher.dispatch('toast', {\n        message: `${_('Failed to connect')}: ${_(result.message || 'Connection error')}`,\n        type: 'error',\n      });\n    }\n    setIsConnecting(false);\n    setPassword('');\n  };\n\n  const handleDisconnect = async () => {\n    const kosync = {\n      ...settings.kosync,\n      userkey: '',\n      enabled: false,\n    };\n    const newSettings = { ...settings, kosync };\n    setSettings(newSettings);\n    await saveSettings(envConfig, newSettings);\n    setUsername('');\n    eventDispatcher.dispatch('toast', { message: _('Disconnected'), type: 'info' });\n  };\n\n  const handleStrategyChange = async (e: React.ChangeEvent<HTMLSelectElement>) => {\n    const kosync = {\n      ...settings.kosync,\n      strategy: e.target.value as KOSyncStrategy,\n    };\n\n    const newSettings = { ...settings, kosync };\n    setSettings(newSettings);\n    await saveSettings(envConfig, newSettings);\n  };\n\n  const handleChecksumMethodChange = async (e: React.ChangeEvent<HTMLSelectElement>) => {\n    const kosync = {\n      ...settings.kosync,\n      checksumMethod: e.target.value as KOSyncChecksumMethod,\n    };\n\n    const newSettings = { ...settings, kosync };\n    setSettings(newSettings);\n    await saveSettings(envConfig, newSettings);\n  };\n\n  return (\n    <Dialog\n      id='kosync_settings_window'\n      isOpen={isOpen}\n      onClose={() => setIsOpen(false)}\n      title={_('KOReader Sync Settings')}\n      boxClassName='sm:!min-w-[520px] sm:h-auto'\n    >\n      {isOpen && (\n        <div className='mb-4 mt-0 flex flex-col gap-4 p-2 sm:p-4'>\n          {isConfigured ? (\n            <>\n              <div className='text-center'>\n                <p className='text-base-content/80 text-sm'>\n                  {_('Sync as {{userDisplayName}}', {\n                    userDisplayName: settings.kosync.username,\n                  })}\n                </p>\n              </div>\n              <div className='flex h-14 items-center justify-between'>\n                <span className='text-base-content/80'>{_('Sync Server Connected')}</span>\n                <input\n                  type='checkbox'\n                  className='toggle'\n                  checked={settings.kosync.enabled}\n                  onChange={() => handleDisconnect()}\n                />\n              </div>\n              <div className='form-control w-full'>\n                <label className='label py-1'>\n                  <span className='label-text font-medium'>{_('Sync Strategy')}</span>\n                </label>\n                <StyledSelect\n                  value={settings.kosync.strategy}\n                  onChange={handleStrategyChange}\n                  options={[\n                    { value: 'prompt', label: _('Ask on conflict') },\n                    { value: 'silent', label: _('Always use latest') },\n                    { value: 'send', label: _('Send changes only') },\n                    { value: 'receive', label: _('Receive changes only') },\n                  ]}\n                />\n              </div>\n              <div className='form-control w-full'>\n                <label className='label py-1'>\n                  <span className='label-text font-medium'>{_('Checksum Method')}</span>\n                </label>\n                <StyledSelect\n                  value={settings.kosync.checksumMethod}\n                  onChange={handleChecksumMethodChange}\n                  options={[\n                    { value: 'binary', label: _('File Content (recommended)') },\n                    { value: 'filename', label: _('File Name'), disabled: true },\n                  ]}\n                />\n              </div>\n              <div className='form-control w-full'>\n                <label className='label py-1'>\n                  <span className='label-text font-medium'>{_('Device Name')}</span>\n                </label>\n                <input\n                  type='text'\n                  placeholder={osName ? `Readest (${osName})` : 'Readest'}\n                  className='input input-bordered h-12 w-full focus:outline-none focus:ring-0'\n                  value={deviceName}\n                  onChange={handleDeviceNameChange}\n                />\n              </div>\n            </>\n          ) : (\n            <>\n              <p className='text-base-content/70 text-center text-sm'>\n                {_('Connect to your KOReader Sync server.')}\n              </p>\n              <div className='form-control w-full'>\n                <label className='label py-1'>\n                  <span className='label-text font-medium'>{_('Server URL')}</span>\n                </label>\n                <input\n                  type='text'\n                  placeholder='https://koreader.sync.server'\n                  className='input input-bordered h-12 w-full focus:outline-none focus:ring-0'\n                  spellCheck='false'\n                  value={url}\n                  onChange={(e) => setUrl(e.target.value)}\n                />\n              </div>\n              <form className='flex flex-col gap-4'>\n                <div className='form-control w-full'>\n                  <label className='label py-1'>\n                    <span className='label-text font-medium'>{_('Username')}</span>\n                  </label>\n                  <input\n                    type='text'\n                    placeholder={_('Your Username')}\n                    className='input input-bordered h-12 w-full focus:outline-none focus:ring-0'\n                    spellCheck='false'\n                    value={username}\n                    onChange={(e) => setUsername(e.target.value)}\n                    autoComplete='username'\n                  />\n                </div>\n                <div className='form-control w-full'>\n                  <label className='label py-1'>\n                    <span className='label-text font-medium'>{_('Password')}</span>\n                  </label>\n                  <input\n                    type='password'\n                    placeholder={_('Your Password')}\n                    className='input input-bordered h-12 w-full focus:outline-none focus:ring-0'\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    autoComplete='current-password'\n                  />\n                </div>\n              </form>\n              <button\n                className='btn btn-primary mt-2 h-12 min-h-12 w-full'\n                onClick={handleConnect}\n                disabled={isConnecting || !url || !username || !password}\n              >\n                {isConnecting ? <span className='loading loading-spinner'></span> : _('Connect')}\n              </button>\n              {connectionStatus && (\n                <div className='text-error h-4 text-center text-sm'>{connectionStatus}</div>\n              )}\n            </>\n          )}\n        </div>\n      )}\n    </Dialog>\n  );\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 590, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/ProofreadRules.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useEffect, useState } from 'react';\nimport { RiEditLine, RiDeleteBin7Line } from 'react-icons/ri';\nimport { useEnv } from '@/context/EnvContext';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useProofreadStore } from '@/store/proofreadStore';\nimport { ProofreadRule, ProofreadScope } from '@/types/book';\nimport { eventDispatcher } from '@/utils/event';\nimport Dialog from '@/components/Dialog';\n\nconst dialogId = 'proofread_rules_window';\n\nexport const setProofreadRulesVisibility = (visible: boolean) => {\n  const dialog = document.getElementById(dialogId);\n  if (dialog) {\n    dialog.dispatchEvent(new CustomEvent('setProofreadRulesVisibility', { detail: { visible } }));\n  }\n};\n\nconst RuleItem: React.FC<{\n  rule: ProofreadRule;\n  scope: ProofreadScope;\n  isEditing: boolean;\n  editingData: { pattern: string; replacement: string; enabled: boolean };\n  onEdit: () => void;\n  onDelete: () => void;\n  onSave: () => void;\n  onCancel: () => void;\n  onEditChange: (field: 'replacement', value: string) => void;\n}> = ({\n  rule,\n  scope,\n  isEditing,\n  editingData,\n  onEdit,\n  onDelete,\n  onSave,\n  onCancel,\n  onEditChange,\n}) => {\n  const _ = useTranslation();\n  const { sideBarBookKey } = useSidebarStore();\n  const { getView } = useReaderStore();\n\n  const navigateToSelection = () => {\n    if (!sideBarBookKey || !rule.cfi) return;\n    eventDispatcher.dispatch('navigate', { bookKey: sideBarBookKey, cfi: rule.cfi });\n    getView(sideBarBookKey)?.goTo(rule.cfi);\n  };\n\n  if (isEditing) {\n    return (\n      <div className='flex flex-col gap-3 p-3'>\n        <div className='flex flex-col gap-1.5'>\n          <label className='text-base-content/70 text-xs font-medium'>{_('Selected text:')}</label>\n          <input\n            className='input input-sm bg-base-200 text-sm opacity-60'\n            value={editingData.pattern}\n            disabled\n          />\n        </div>\n\n        <div className='flex flex-col gap-1.5'>\n          <label className='text-base-content/70 text-xs font-medium'>{_('Replace with:')}</label>\n          <input\n            className='input input-sm text-sm'\n            value={editingData.replacement}\n            onChange={(e) => onEditChange('replacement', e.target.value)}\n          />\n        </div>\n\n        <div className='mt-1 flex gap-2'>\n          <button className='btn btn-primary btn-sm flex-1' onClick={onSave}>\n            {_('Save')}\n          </button>\n          <button className='btn btn-sm flex-1' onClick={onCancel}>\n            {_('Cancel')}\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className='relative flex items-start justify-between gap-3 p-3'>\n      <div className='flex min-w-0 flex-1 flex-col gap-1.5'>\n        <div className='break-words pe-20 text-base font-medium leading-snug'>{rule.pattern}</div>\n        <div className='text-base-content/70 break-words text-sm'>\n          <span className='text-base-content/80 mr-1.5 text-xs font-medium'>\n            {_('Replace with:')}\n          </span>\n          <span className='text-base-content/90 text-xs'>{\"'\" + rule.replacement + \"'\"}</span>\n        </div>\n        <div className='text-base-content/60 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs'>\n          <span className='inline-flex items-center gap-1'>\n            <span className='text-base-content/50'>{_('Scope:')}</span>\n            <span\n              role='none'\n              className={clsx(\n                'text-base-content/70 font-medium',\n                scope === 'selection' && 'cursor-pointer text-blue-400 hover:text-blue-500',\n              )}\n              onClick={scope === 'selection' ? navigateToSelection : undefined}\n            >\n              {scope === 'selection' ? _('Selection') : scope === 'book' ? _('Book') : _('Library')}\n            </span>\n          </span>\n          <span className='text-base-content/30'>•</span>\n          <span className='inline-flex items-center gap-1'>\n            <span className='text-base-content/50'>{_('Case sensitive:')}</span>\n            <span className='text-base-content/70 font-medium'>\n              {rule.caseSensitive !== false ? _('Yes') : _('No')}\n            </span>\n          </span>\n          <span className='text-base-content/30'>•</span>\n          <span className='inline-flex items-center gap-1'>\n            <span className='text-base-content/50'>{_('Only for TTS:')}</span>\n            <span className='text-base-content/70 font-medium'>\n              {rule.onlyForTTS === true ? _('Yes') : _('No')}\n            </span>\n          </span>\n        </div>\n      </div>\n      <div className='absolute right-2 top-2 flex items-center gap-1'>\n        <button\n          className='btn btn-ghost btn-sm h-8 w-8 p-0'\n          onClick={onEdit}\n          aria-label={_('Edit')}\n        >\n          <RiEditLine className='h-4 w-4' />\n        </button>\n        <button\n          className='btn btn-ghost btn-sm h-8 w-8 p-0'\n          onClick={onDelete}\n          aria-label={_('Delete')}\n        >\n          <RiDeleteBin7Line className='h-4 w-4' />\n        </button>\n      </div>\n    </div>\n  );\n};\n\n// Hook to manage rules logic\nconst useReplacementRules = (bookKey: string | null) => {\n  const { settings } = useSettingsStore();\n  const { getViewSettings } = useReaderStore();\n  const { getConfig } = useBookDataStore();\n\n  const viewSettings = bookKey ? getViewSettings(bookKey) : null;\n  const inMemoryRules = viewSettings?.proofreadRules || [];\n  const persistedConfig = bookKey ? getConfig(bookKey) : null;\n  const persistedBookRules = persistedConfig?.viewSettings?.proofreadRules || [];\n\n  // Prefer persisted rules; fall back to in-memory\n  const bookRuleSource = persistedBookRules.length ? persistedBookRules : inMemoryRules;\n\n  const singleRules = bookRuleSource.filter((r: ProofreadRule) => r.scope === 'selection');\n  const bookScopedRules = bookRuleSource.filter((r: ProofreadRule) => r.scope === 'book');\n  const globalRules = settings?.globalViewSettings?.proofreadRules || [];\n\n  // Merge book-scoped and global rules\n  const globalRuleIds = new Set(globalRules.map((gr: ProofreadRule) => gr.id));\n\n  // Remove orphaned overrides (disabled global rules that no longer exist)\n  const validBookRules = bookScopedRules.filter(\n    (br: ProofreadRule) => br.enabled !== false || globalRuleIds.has(br.id),\n  );\n\n  const mergedBookRules = validBookRules.concat(\n    globalRules.filter(\n      (gr: ProofreadRule) => !validBookRules.find((br: ProofreadRule) => br.id === gr.id),\n    ),\n  );\n\n  return { singleRules, bookRules: mergedBookRules };\n};\n\nexport const ProofreadRulesManager: React.FC = () => {\n  const _ = useTranslation();\n  const { envConfig } = useEnv();\n  const { recreateViewer } = useReaderStore();\n  const { sideBarBookKey } = useSidebarStore();\n  const { updateRule, removeRule } = useProofreadStore();\n\n  const [isOpen, setIsOpen] = useState(false);\n  const [editing, setEditing] = useState<{\n    id: string | null;\n    scope: ProofreadScope | null;\n    pattern: string;\n    replacement: string;\n    enabled: boolean;\n    onlyForTTS: boolean;\n  }>({ id: null, scope: null, pattern: '', replacement: '', enabled: true, onlyForTTS: false });\n\n  const { singleRules, bookRules } = useReplacementRules(sideBarBookKey);\n\n  useEffect(() => {\n    const handleVisibility = (event: CustomEvent) => setIsOpen(!!event.detail?.visible);\n    const el = document.getElementById(dialogId);\n    el?.addEventListener('setProofreadRulesVisibility', handleVisibility as EventListener);\n    return () =>\n      el?.removeEventListener('setProofreadRulesVisibility', handleVisibility as EventListener);\n  }, []);\n\n  const startEdit = (rule: ProofreadRule) => {\n    setEditing({\n      id: rule.id,\n      scope: rule.scope,\n      pattern: rule.pattern,\n      replacement: rule.replacement,\n      enabled: !!rule.enabled,\n      onlyForTTS: !!rule.onlyForTTS,\n    });\n  };\n\n  const cancelEdit = () => {\n    setEditing({\n      id: null,\n      scope: null,\n      pattern: '',\n      replacement: '',\n      enabled: true,\n      onlyForTTS: false,\n    });\n  };\n\n  const saveEdit = async () => {\n    if (!editing.id || !editing.scope || !sideBarBookKey) return;\n\n    await updateRule(envConfig, sideBarBookKey, editing.id, {\n      scope: editing.scope,\n      pattern: editing.pattern,\n      replacement: editing.replacement,\n      enabled: editing.enabled,\n      onlyForTTS: editing.onlyForTTS,\n    });\n\n    cancelEdit();\n\n    if (!editing.onlyForTTS) {\n      recreateViewer(envConfig, sideBarBookKey);\n    }\n  };\n\n  const deleteRule = async (rule: ProofreadRule) => {\n    if (!sideBarBookKey) return;\n    await removeRule(envConfig, sideBarBookKey, rule.id, rule.scope);\n    if (!rule.onlyForTTS) {\n      recreateViewer(envConfig, sideBarBookKey);\n    }\n  };\n\n  const renderRuleList = (\n    rules: ProofreadRule[],\n    scopeType: ProofreadScope,\n    title: string,\n    emptyMessage: string,\n  ) => (\n    <div className='flex flex-col gap-3'>\n      <h3 className='text-base-content/90 text-sm font-semibold'>{title}</h3>\n      {rules.length === 0 ? (\n        <div className='border-base-content/10 bg-base-200/30 rounded-lg border border-dashed p-6 text-center'>\n          <p className='text-base-content/50 text-sm'>{emptyMessage}</p>\n        </div>\n      ) : (\n        <ul className='flex flex-col gap-2'>\n          {rules.map((rule) => (\n            <li\n              key={rule.id}\n              className='border-base-content/10 bg-base-100 hover:border-base-content/20 rounded-lg border transition-colors'\n            >\n              <RuleItem\n                rule={rule}\n                scope={scopeType === 'selection' ? 'selection' : rule.scope}\n                isEditing={\n                  editing.id === rule.id &&\n                  editing.scope === (scopeType === 'selection' ? 'selection' : rule.scope)\n                }\n                editingData={editing}\n                onEdit={() => startEdit(rule)}\n                onDelete={() => deleteRule(rule)}\n                onSave={saveEdit}\n                onCancel={cancelEdit}\n                onEditChange={(_, value) => setEditing({ ...editing, replacement: value })}\n              />\n            </li>\n          ))}\n        </ul>\n      )}\n    </div>\n  );\n\n  return (\n    <Dialog\n      id={dialogId}\n      isOpen={isOpen}\n      onClose={() => setIsOpen(false)}\n      title={_('Proofread Replacement Rules')}\n      boxClassName='sm:!min-w-[560px] sm:!max-w-[640px] sm:h-auto'\n    >\n      {isOpen && (\n        <div className='flex max-h-[70vh] flex-col gap-6 p-4 sm:p-6'>\n          {renderRuleList(\n            singleRules,\n            'selection',\n            _('Selected Text Rules'),\n            _('No selected text replacement rules'),\n          )}\n          {renderRuleList(\n            bookRules,\n            'book',\n            _('Book Specific Rules'),\n            _('No book-level replacement rules'),\n          )}\n          <div className='p-1'></div>\n        </div>\n      )}\n    </Dialog>\n  );\n};\n\nexport default ProofreadRulesManager;\n"],"names":[],"mappings":";;;;;;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;;;;;;;;;AAdA;;;;;;;;;;;;;;AAgBA,MAAM,WAAW;AAEV,MAAM,8BAA8B,CAAC;IAC1C,MAAM,SAAS,SAAS,cAAc,CAAC;IACvC,IAAI,QAAQ;QACV,OAAO,aAAa,CAAC,IAAI,YAAY,+BAA+B;YAAE,QAAQ;gBAAE;YAAQ;QAAE;IAC5F;AACF;AAEA,MAAM,WAUD,CAAC,EACJ,IAAI,EACJ,KAAK,EACL,SAAS,EACT,WAAW,EACX,MAAM,EACN,QAAQ,EACR,MAAM,EACN,QAAQ,EACR,YAAY,EACb;IACC,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,cAAc,EAAE,GAAG,IAAA,kKAAe;IAC1C,MAAM,EAAE,OAAO,EAAE,GAAG,IAAA,gKAAc;IAElC,MAAM,sBAAsB;QAC1B,IAAI,CAAC,kBAAkB,CAAC,KAAK,GAAG,EAAE;QAClC,2JAAe,CAAC,QAAQ,CAAC,YAAY;YAAE,SAAS;YAAgB,KAAK,KAAK,GAAG;QAAC;QAC9E,QAAQ,iBAAiB,KAAK,KAAK,GAAG;IACxC;IAEA,IAAI,WAAW;QACb,qBACE,qKAAC;YAAI,WAAU;;8BACb,qKAAC;oBAAI,WAAU;;sCACb,qKAAC;4BAAM,WAAU;sCAA4C,EAAE;;;;;;sCAC/D,qKAAC;4BACC,WAAU;4BACV,OAAO,YAAY,OAAO;4BAC1B,QAAQ;;;;;;;;;;;;8BAIZ,qKAAC;oBAAI,WAAU;;sCACb,qKAAC;4BAAM,WAAU;sCAA4C,EAAE;;;;;;sCAC/D,qKAAC;4BACC,WAAU;4BACV,OAAO,YAAY,WAAW;4BAC9B,UAAU,CAAC,IAAM,aAAa,eAAe,EAAE,MAAM,CAAC,KAAK;;;;;;;;;;;;8BAI/D,qKAAC;oBAAI,WAAU;;sCACb,qKAAC;4BAAO,WAAU;4BAAgC,SAAS;sCACxD,EAAE;;;;;;sCAEL,qKAAC;4BAAO,WAAU;4BAAoB,SAAS;sCAC5C,EAAE;;;;;;;;;;;;;;;;;;IAKb;IAEA,qBACE,qKAAC;QAAI,WAAU;;0BACb,qKAAC;gBAAI,WAAU;;kCACb,qKAAC;wBAAI,WAAU;kCAAwD,KAAK,OAAO;;;;;;kCACnF,qKAAC;wBAAI,WAAU;;0CACb,qKAAC;gCAAK,WAAU;0CACb,EAAE;;;;;;0CAEL,qKAAC;gCAAK,WAAU;0CAAgC,MAAM,KAAK,WAAW,GAAG;;;;;;;;;;;;kCAE3E,qKAAC;wBAAI,WAAU;;0CACb,qKAAC;gCAAK,WAAU;;kDACd,qKAAC;wCAAK,WAAU;kDAAwB,EAAE;;;;;;kDAC1C,qKAAC;wCACC,MAAK;wCACL,WAAW,IAAA,mHAAI,EACb,oCACA,UAAU,eAAe;wCAE3B,SAAS,UAAU,cAAc,sBAAsB;kDAEtD,UAAU,cAAc,EAAE,eAAe,UAAU,SAAS,EAAE,UAAU,EAAE;;;;;;;;;;;;0CAG/E,qKAAC;gCAAK,WAAU;0CAAuB;;;;;;0CACvC,qKAAC;gCAAK,WAAU;;kDACd,qKAAC;wCAAK,WAAU;kDAAwB,EAAE;;;;;;kDAC1C,qKAAC;wCAAK,WAAU;kDACb,KAAK,aAAa,KAAK,QAAQ,EAAE,SAAS,EAAE;;;;;;;;;;;;0CAGjD,qKAAC;gCAAK,WAAU;0CAAuB;;;;;;0CACvC,qKAAC;gCAAK,WAAU;;kDACd,qKAAC;wCAAK,WAAU;kDAAwB,EAAE;;;;;;kDAC1C,qKAAC;wCAAK,WAAU;kDACb,KAAK,UAAU,KAAK,OAAO,EAAE,SAAS,EAAE;;;;;;;;;;;;;;;;;;;;;;;;0BAKjD,qKAAC;gBAAI,WAAU;;kCACb,qKAAC;wBACC,WAAU;wBACV,SAAS;wBACT,cAAY,EAAE;kCAEd,cAAA,qKAAC,sOAAU;4BAAC,WAAU;;;;;;;;;;;kCAExB,qKAAC;wBACC,WAAU;wBACV,SAAS;wBACT,cAAY,EAAE;kCAEd,cAAA,qKAAC,4OAAgB;4BAAC,WAAU;;;;;;;;;;;;;;;;;;;;;;;AAKtC;AAEA,6BAA6B;AAC7B,MAAM,sBAAsB,CAAC;IAC3B,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,oKAAgB;IACrC,MAAM,EAAE,eAAe,EAAE,GAAG,IAAA,gKAAc;IAC1C,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,oKAAgB;IAEtC,MAAM,eAAe,UAAU,gBAAgB,WAAW;IAC1D,MAAM,gBAAgB,cAAc,kBAAkB,EAAE;IACxD,MAAM,kBAAkB,UAAU,UAAU,WAAW;IACvD,MAAM,qBAAqB,iBAAiB,cAAc,kBAAkB,EAAE;IAE9E,iDAAiD;IACjD,MAAM,iBAAiB,mBAAmB,MAAM,GAAG,qBAAqB;IAExE,MAAM,cAAc,eAAe,MAAM,CAAC,CAAC,IAAqB,EAAE,KAAK,KAAK;IAC5E,MAAM,kBAAkB,eAAe,MAAM,CAAC,CAAC,IAAqB,EAAE,KAAK,KAAK;IAChF,MAAM,cAAc,UAAU,oBAAoB,kBAAkB,EAAE;IAEtE,qCAAqC;IACrC,MAAM,gBAAgB,IAAI,IAAI,YAAY,GAAG,CAAC,CAAC,KAAsB,GAAG,EAAE;IAE1E,yEAAyE;IACzE,MAAM,iBAAiB,gBAAgB,MAAM,CAC3C,CAAC,KAAsB,GAAG,OAAO,KAAK,SAAS,cAAc,GAAG,CAAC,GAAG,EAAE;IAGxE,MAAM,kBAAkB,eAAe,MAAM,CAC3C,YAAY,MAAM,CAChB,CAAC,KAAsB,CAAC,eAAe,IAAI,CAAC,CAAC,KAAsB,GAAG,EAAE,KAAK,GAAG,EAAE;IAItF,OAAO;QAAE;QAAa,WAAW;IAAgB;AACnD;AAEO,MAAM,wBAAkC;IAC7C,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,0JAAM;IAC5B,MAAM,EAAE,cAAc,EAAE,GAAG,IAAA,gKAAc;IACzC,MAAM,EAAE,cAAc,EAAE,GAAG,IAAA,kKAAe;IAC1C,MAAM,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG,IAAA,sKAAiB;IAEpD,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,+GAAQ,EAAC;IACrC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,+GAAQ,EAOnC;QAAE,IAAI;QAAM,OAAO;QAAM,SAAS;QAAI,aAAa;QAAI,SAAS;QAAM,YAAY;IAAM;IAE3F,MAAM,EAAE,WAAW,EAAE,SAAS,EAAE,GAAG,oBAAoB;IAEvD,IAAA,gHAAS,EAAC;QACR,MAAM,mBAAmB,CAAC,QAAuB,UAAU,CAAC,CAAC,MAAM,MAAM,EAAE;QAC3E,MAAM,KAAK,SAAS,cAAc,CAAC;QACnC,IAAI,iBAAiB,+BAA+B;QACpD,OAAO,IACL,IAAI,oBAAoB,+BAA+B;IAC3D,GAAG,EAAE;IAEL,MAAM,YAAY,CAAC;QACjB,WAAW;YACT,IAAI,KAAK,EAAE;YACX,OAAO,KAAK,KAAK;YACjB,SAAS,KAAK,OAAO;YACrB,aAAa,KAAK,WAAW;YAC7B,SAAS,CAAC,CAAC,KAAK,OAAO;YACvB,YAAY,CAAC,CAAC,KAAK,UAAU;QAC/B;IACF;IAEA,MAAM,aAAa;QACjB,WAAW;YACT,IAAI;YACJ,OAAO;YACP,SAAS;YACT,aAAa;YACb,SAAS;YACT,YAAY;QACd;IACF;IAEA,MAAM,WAAW;QACf,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,QAAQ,KAAK,IAAI,CAAC,gBAAgB;QAEtD,MAAM,WAAW,WAAW,gBAAgB,QAAQ,EAAE,EAAE;YACtD,OAAO,QAAQ,KAAK;YACpB,SAAS,QAAQ,OAAO;YACxB,aAAa,QAAQ,WAAW;YAChC,SAAS,QAAQ,OAAO;YACxB,YAAY,QAAQ,UAAU;QAChC;QAEA;QAEA,IAAI,CAAC,QAAQ,UAAU,EAAE;YACvB,eAAe,WAAW;QAC5B;IACF;IAEA,MAAM,aAAa,OAAO;QACxB,IAAI,CAAC,gBAAgB;QACrB,MAAM,WAAW,WAAW,gBAAgB,KAAK,EAAE,EAAE,KAAK,KAAK;QAC/D,IAAI,CAAC,KAAK,UAAU,EAAE;YACpB,eAAe,WAAW;QAC5B;IACF;IAEA,MAAM,iBAAiB,CACrB,OACA,WACA,OACA,6BAEA,qKAAC;YAAI,WAAU;;8BACb,qKAAC;oBAAG,WAAU;8BAA8C;;;;;;gBAC3D,MAAM,MAAM,KAAK,kBAChB,qKAAC;oBAAI,WAAU;8BACb,cAAA,qKAAC;wBAAE,WAAU;kCAAgC;;;;;;;;;;6EAG/C,qKAAC;oBAAG,WAAU;8BACX,MAAM,GAAG,CAAC,CAAC,qBACV,qKAAC;4BAEC,WAAU;sCAEV,cAAA,qKAAC;gCACC,MAAM;gCACN,OAAO,cAAc,cAAc,cAAc,KAAK,KAAK;gCAC3D,WACE,QAAQ,EAAE,KAAK,KAAK,EAAE,IACtB,QAAQ,KAAK,KAAK,CAAC,cAAc,cAAc,cAAc,KAAK,KAAK;gCAEzE,aAAa;gCACb,QAAQ,IAAM,UAAU;gCACxB,UAAU,IAAM,WAAW;gCAC3B,QAAQ;gCACR,UAAU;gCACV,cAAc,CAAC,GAAG,QAAU,WAAW;wCAAE,GAAG,OAAO;wCAAE,aAAa;oCAAM;;;;;;2BAfrE,KAAK,EAAE;;;;;;;;;;;;;;;;IAwBxB,qBACE,qKAAC,0JAAM;QACL,IAAI;QACJ,QAAQ;QACR,SAAS,IAAM,UAAU;QACzB,OAAO,EAAE;QACT,cAAa;kBAEZ,wBACC,qKAAC;YAAI,WAAU;;gBACZ,eACC,aACA,aACA,EAAE,wBACF,EAAE;gBAEH,eACC,WACA,QACA,EAAE,wBACF,EAAE;8BAEJ,qKAAC;oBAAI,WAAU;;;;;;;;;;;;;;;;;AAKzB;uCAEe"}},
    {"offset": {"line": 1132, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/notebook/Header.tsx"],"sourcesContent":["import clsx from 'clsx';\nimport React from 'react';\n\nimport { FiSearch } from 'react-icons/fi';\nimport { LuNotebookPen } from 'react-icons/lu';\nimport { MdArrowBackIosNew, MdOutlinePushPin, MdPushPin } from 'react-icons/md';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\n\nconst NotebookHeader: React.FC<{\n  isPinned: boolean;\n  isSearchBarVisible: boolean;\n  handleClose: () => void;\n  handleTogglePin: () => void;\n  handleToggleSearchBar: () => void;\n}> = ({ isPinned, isSearchBarVisible, handleClose, handleTogglePin, handleToggleSearchBar }) => {\n  const _ = useTranslation();\n  const iconSize14 = useResponsiveSize(14);\n  const iconSize18 = useResponsiveSize(18);\n  return (\n    <div className='notebook-header relative flex h-11 items-center px-3' dir='ltr'>\n      <div className='absolute inset-0 z-[-1] flex items-center justify-center space-x-2'>\n        <LuNotebookPen size={iconSize18} />\n        <div className='notebook-title hidden text-sm font-medium sm:flex'>{_('Notebook')}</div>\n      </div>\n      <div className='flex w-full items-center gap-x-4'>\n        <button\n          title={isPinned ? _('Unpin Notebook') : _('Pin Notebook')}\n          onClick={handleTogglePin}\n          className={clsx(\n            'btn btn-ghost btn-circle hidden h-6 min-h-6 w-6 sm:flex',\n            isPinned ? 'bg-base-300' : 'bg-base-300/65',\n          )}\n        >\n          {isPinned ? <MdPushPin size={iconSize14} /> : <MdOutlinePushPin size={iconSize14} />}\n        </button>\n        <button\n          title={_('Close')}\n          onClick={handleClose}\n          className={'btn btn-ghost btn-circle flex h-6 min-h-6 w-6 hover:bg-transparent sm:hidden'}\n        >\n          <MdArrowBackIosNew />\n        </button>\n      </div>\n      <div className='flex items-center justify-end gap-x-4'>\n        <button\n          title={isSearchBarVisible ? _('Hide Search Bar') : _('Show Search Bar')}\n          onClick={handleToggleSearchBar}\n          className={clsx('btn btn-ghost h-8 min-h-8 w-8 p-0', isSearchBarVisible && 'bg-base-300')}\n        >\n          <FiSearch size={iconSize18} />\n        </button>\n      </div>\n    </div>\n  );\n};\n\nexport default NotebookHeader;\n"],"names":[],"mappings":";;;;;AAAA;AAGA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;AAEA,MAAM,iBAMD,CAAC,EAAE,QAAQ,EAAE,kBAAkB,EAAE,WAAW,EAAE,eAAe,EAAE,qBAAqB,EAAE;IACzF,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,aAAa,IAAA,yKAAiB,EAAC;IACrC,MAAM,aAAa,IAAA,yKAAiB,EAAC;IACrC,qBACE,qKAAC;QAAI,WAAU;QAAuD,KAAI;;0BACxE,qKAAC;gBAAI,WAAU;;kCACb,qKAAC,yOAAa;wBAAC,MAAM;;;;;;kCACrB,qKAAC;wBAAI,WAAU;kCAAqD,EAAE;;;;;;;;;;;;0BAExE,qKAAC;gBAAI,WAAU;;kCACb,qKAAC;wBACC,OAAO,WAAW,EAAE,oBAAoB,EAAE;wBAC1C,SAAS;wBACT,WAAW,IAAA,mHAAI,EACb,2DACA,WAAW,gBAAgB;kCAG5B,yBAAW,qKAAC,qOAAS;4BAAC,MAAM;;;;;qFAAiB,qKAAC,4OAAgB;4BAAC,MAAM;;;;;;;;;;;kCAExE,qKAAC;wBACC,OAAO,EAAE;wBACT,SAAS;wBACT,WAAW;kCAEX,cAAA,qKAAC,6OAAiB;;;;;;;;;;;;;;;;0BAGtB,qKAAC;gBAAI,WAAU;0BACb,cAAA,qKAAC;oBACC,OAAO,qBAAqB,EAAE,qBAAqB,EAAE;oBACrD,SAAS;oBACT,WAAW,IAAA,mHAAI,EAAC,qCAAqC,sBAAsB;8BAE3E,cAAA,qKAAC,oOAAQ;wBAAC,MAAM;;;;;;;;;;;;;;;;;;;;;;AAK1B;uCAEe"}},
    {"offset": {"line": 1270, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/notebook/NoteEditor.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef, useState } from 'react';\nimport { useNotebookStore } from '@/store/notebookStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\nimport { TextSelection } from '@/utils/sel';\nimport { md5Fingerprint } from '@/utils/md5';\nimport { BookNote } from '@/types/book';\nimport useShortcuts from '@/hooks/useShortcuts';\nimport TextEditor, { TextEditorRef } from '@/components/TextEditor';\nimport TextButton from '@/components/TextButton';\n\ninterface NoteEditorProps {\n  onSave: (selection: TextSelection, note: string) => void;\n  onEdit: (annotation: BookNote) => void;\n}\n\nconst NoteEditor: React.FC<NoteEditorProps> = ({ onSave, onEdit }) => {\n  const _ = useTranslation();\n  const {\n    notebookNewAnnotation,\n    notebookEditAnnotation,\n    setNotebookNewAnnotation,\n    setNotebookEditAnnotation,\n    saveNotebookAnnotationDraft,\n    getNotebookAnnotationDraft,\n  } = useNotebookStore();\n\n  const editorRef = useRef<TextEditorRef>(null);\n  const [note, setNote] = useState('');\n  const separatorWidth = useResponsiveSize(3);\n\n  useEffect(() => {\n    if (notebookEditAnnotation) {\n      const noteText = notebookEditAnnotation.note;\n      setNote(noteText);\n      editorRef.current?.setValue(noteText);\n      editorRef.current?.focus();\n    } else if (notebookNewAnnotation) {\n      const noteText = getAnnotationText();\n      if (noteText) {\n        const draftNote = getNotebookAnnotationDraft(md5Fingerprint(noteText)) || '';\n        setNote(draftNote);\n        editorRef.current?.setValue(draftNote);\n        editorRef.current?.focus();\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [notebookNewAnnotation, notebookEditAnnotation]);\n\n  const getAnnotationText = () => {\n    return notebookEditAnnotation?.text || notebookNewAnnotation?.text || '';\n  };\n\n  const handleNoteChange = (value: string) => {\n    setNote(value);\n  };\n\n  const handleBlur = () => {\n    const currentValue = editorRef.current?.getValue();\n    if (currentValue) {\n      const noteText = getAnnotationText();\n      if (noteText) {\n        saveNotebookAnnotationDraft(md5Fingerprint(noteText), currentValue);\n      }\n    }\n  };\n\n  const handleSaveNote = () => {\n    const currentValue = editorRef.current?.getValue();\n    if (currentValue) {\n      if (notebookNewAnnotation) {\n        onSave(notebookNewAnnotation, currentValue);\n      } else if (notebookEditAnnotation) {\n        notebookEditAnnotation.note = currentValue;\n        onEdit(notebookEditAnnotation);\n      }\n    }\n  };\n\n  const handleEscape = () => {\n    if (notebookNewAnnotation) {\n      setNotebookNewAnnotation(null);\n    }\n    if (notebookEditAnnotation) {\n      setNotebookEditAnnotation(null);\n    }\n  };\n\n  useShortcuts({\n    onSaveNote: () => {\n      const currentValue = editorRef.current?.getValue();\n      if (currentValue) {\n        handleSaveNote();\n      }\n    },\n    onEscape: handleEscape,\n  });\n\n  const canSave = Boolean(note.trim());\n\n  return (\n    <div className='content booknote-item note-editor-container bg-base-100 mt-2 rounded-md p-2'>\n      <div className='flex w-full'>\n        <TextEditor\n          ref={editorRef}\n          value={note}\n          onChange={handleNoteChange}\n          onBlur={handleBlur}\n          onSave={handleSaveNote}\n          onEscape={handleEscape}\n          placeholder={_('Add your notes here...')}\n          spellCheck={false}\n        />\n      </div>\n\n      <div className='flex items-center pt-2'>\n        <div\n          className='me-2 mt-0.5 min-h-full self-stretch rounded-xl bg-gray-300'\n          style={{\n            minWidth: `${separatorWidth}px`,\n          }}\n        ></div>\n        <div className='content font-size-sm line-clamp-3'>\n          <span className='content font-size-xs text-gray-500'>{getAnnotationText()}</span>\n        </div>\n      </div>\n\n      <div className='flex justify-end space-x-3 p-2' dir='ltr'>\n        <TextButton onClick={handleEscape}>{_('Cancel')}</TextButton>\n        <TextButton onClick={handleSaveNote} disabled={!canSave}>\n          {_('Save')}\n        </TextButton>\n      </div>\n    </div>\n  );\n};\n\nexport default NoteEditor;\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;;;;;;;;AAXA;;;;;;;;;;AAkBA,MAAM,aAAwC,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE;IAC/D,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EACJ,qBAAqB,EACrB,sBAAsB,EACtB,wBAAwB,EACxB,yBAAyB,EACzB,2BAA2B,EAC3B,0BAA0B,EAC3B,GAAG,IAAA,oKAAgB;IAEpB,MAAM,YAAY,IAAA,6GAAM,EAAgB;IACxC,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,+GAAQ,EAAC;IACjC,MAAM,iBAAiB,IAAA,yKAAiB,EAAC;IAEzC,IAAA,gHAAS,EAAC;QACR,IAAI,wBAAwB;YAC1B,MAAM,WAAW,uBAAuB,IAAI;YAC5C,QAAQ;YACR,UAAU,OAAO,EAAE,SAAS;YAC5B,UAAU,OAAO,EAAE;QACrB,OAAO,IAAI,uBAAuB;YAChC,MAAM,WAAW;YACjB,IAAI,UAAU;gBACZ,MAAM,YAAY,2BAA2B,IAAA,wKAAc,EAAC,cAAc;gBAC1E,QAAQ;gBACR,UAAU,OAAO,EAAE,SAAS;gBAC5B,UAAU,OAAO,EAAE;YACrB;QACF;IACA,uDAAuD;IACzD,GAAG;QAAC;QAAuB;KAAuB;IAElD,MAAM,oBAAoB;QACxB,OAAO,wBAAwB,QAAQ,uBAAuB,QAAQ;IACxE;IAEA,MAAM,mBAAmB,CAAC;QACxB,QAAQ;IACV;IAEA,MAAM,aAAa;QACjB,MAAM,eAAe,UAAU,OAAO,EAAE;QACxC,IAAI,cAAc;YAChB,MAAM,WAAW;YACjB,IAAI,UAAU;gBACZ,4BAA4B,IAAA,wKAAc,EAAC,WAAW;YACxD;QACF;IACF;IAEA,MAAM,iBAAiB;QACrB,MAAM,eAAe,UAAU,OAAO,EAAE;QACxC,IAAI,cAAc;YAChB,IAAI,uBAAuB;gBACzB,OAAO,uBAAuB;YAChC,OAAO,IAAI,wBAAwB;gBACjC,uBAAuB,IAAI,GAAG;gBAC9B,OAAO;YACT;QACF;IACF;IAEA,MAAM,eAAe;QACnB,IAAI,uBAAuB;YACzB,yBAAyB;QAC3B;QACA,IAAI,wBAAwB;YAC1B,0BAA0B;QAC5B;IACF;IAEA,IAAA,0JAAY,EAAC;QACX,YAAY;YACV,MAAM,eAAe,UAAU,OAAO,EAAE;YACxC,IAAI,cAAc;gBAChB;YACF;QACF;QACA,UAAU;IACZ;IAEA,MAAM,UAAU,QAAQ,KAAK,IAAI;IAEjC,qBACE,qKAAC;QAAI,WAAU;;0BACb,qKAAC;gBAAI,WAAU;0BACb,cAAA,qKAAC,8JAAU;oBACT,KAAK;oBACL,OAAO;oBACP,UAAU;oBACV,QAAQ;oBACR,QAAQ;oBACR,UAAU;oBACV,aAAa,EAAE;oBACf,YAAY;;;;;;;;;;;0BAIhB,qKAAC;gBAAI,WAAU;;kCACb,qKAAC;wBACC,WAAU;wBACV,OAAO;4BACL,UAAU,GAAG,eAAe,EAAE,CAAC;wBACjC;;;;;;kCAEF,qKAAC;wBAAI,WAAU;kCACb,cAAA,qKAAC;4BAAK,WAAU;sCAAsC;;;;;;;;;;;;;;;;;0BAI1D,qKAAC;gBAAI,WAAU;gBAAiC,KAAI;;kCAClD,qKAAC,8JAAU;wBAAC,SAAS;kCAAe,EAAE;;;;;;kCACtC,qKAAC,8JAAU;wBAAC,SAAS;wBAAgB,UAAU,CAAC;kCAC7C,EAAE;;;;;;;;;;;;;;;;;;AAKb;uCAEe"}},
    {"offset": {"line": 1470, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/notebook/SearchBar.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef, useState } from 'react';\nimport { FaSearch, FaTimes } from 'react-icons/fa';\n\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { BookNote } from '@/types/book';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\n\ninterface SearchBarProps {\n  isVisible: boolean;\n  bookKey: string;\n  searchTerm: string;\n  onSearchResultChange: (results: BookNote[] | null) => void;\n}\n\nconst SearchBar: React.FC<SearchBarProps> = ({\n  isVisible,\n  bookKey,\n  searchTerm: term,\n  onSearchResultChange,\n}) => {\n  const _ = useTranslation();\n  const { getConfig } = useBookDataStore();\n  const [searchTerm, setSearchTerm] = useState(term);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const searchTimeout = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const iconSize16 = useResponsiveSize(16);\n  const iconSize12 = useResponsiveSize(12);\n\n  useEffect(() => {\n    handleSearchTermChange(searchTerm);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey]);\n\n  useEffect(() => {\n    setSearchTerm(term);\n    handleSearchTermChange(term);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [term]);\n\n  useEffect(() => {\n    if (isVisible && inputRef.current) {\n      inputRef.current.focus();\n    }\n  }, [isVisible]);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'Escape' && inputRef.current) {\n        inputRef.current.blur();\n      }\n    };\n    window.addEventListener('keydown', handleKeyDown);\n    return () => {\n      window.removeEventListener('keydown', handleKeyDown);\n      if (searchTimeout.current) {\n        clearTimeout(searchTimeout.current);\n      }\n    };\n  }, []);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    setSearchTerm(value);\n\n    if (searchTimeout.current) {\n      clearTimeout(searchTimeout.current);\n    }\n\n    searchTimeout.current = setTimeout(() => {\n      handleSearchTermChange(value);\n    }, 300);\n  };\n\n  const handleClearSearch = () => {\n    setSearchTerm('');\n    handleSearchTermChange('');\n    if (inputRef.current) {\n      inputRef.current.focus();\n    }\n  };\n\n  const filterNotes = (notes: BookNote[], query: string): BookNote[] => {\n    if (!query.trim()) return [];\n\n    const lowercaseQuery = query.toLowerCase();\n    return notes.filter((note) => {\n      const textMatch = note.text?.toLowerCase().includes(lowercaseQuery) || false;\n      const noteMatch = note.note?.toLowerCase().includes(lowercaseQuery) || false;\n      return textMatch || noteMatch;\n    });\n  };\n\n  const handleSearchTermChange = (term: string) => {\n    if (term.trim().length >= 1) {\n      handleSearch(term);\n    } else {\n      resetSearch();\n    }\n  };\n\n  const handleSearch = (term: string) => {\n    const config = getConfig(bookKey);\n    if (!config) {\n      resetSearch();\n      return;\n    }\n\n    const { booknotes: allNotes = [] } = config;\n    const validNotes = allNotes.filter((note) => !note.deletedAt);\n\n    const results = filterNotes(validNotes, term);\n    onSearchResultChange(results);\n  };\n\n  const resetSearch = () => {\n    onSearchResultChange(null);\n  };\n\n  return (\n    <div className='relative px-3 py-2'>\n      <div className='bg-base-100 flex h-8 items-center rounded-lg'>\n        <div className='pl-3'>\n          <FaSearch size={iconSize16} className='text-base-content/50' />\n        </div>\n\n        <input\n          ref={inputRef}\n          type='text'\n          value={searchTerm}\n          spellCheck={false}\n          onChange={handleInputChange}\n          placeholder={_('Search notes and excerpts...')}\n          className='w-full bg-transparent p-2 font-sans text-sm font-light focus:outline-none'\n        />\n\n        {searchTerm && (\n          <div className='bg-base-300 flex h-8 w-8 items-center rounded-r-lg'>\n            <button\n              onClick={handleClearSearch}\n              className='btn btn-ghost h-8 min-h-8 w-8 rounded-none rounded-r-lg p-0'\n            >\n              <FaTimes size={iconSize12} className='text-base-content/50' />\n            </button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default SearchBar;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1657, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/notebook/Notebook.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\n\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useNotebookStore } from '@/store/notebookStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useEnv } from '@/context/EnvContext';\nimport { DragKey, useDrag } from '@/hooks/useDrag';\nimport { TextSelection } from '@/utils/sel';\nimport { BookNote } from '@/types/book';\nimport { uniqueId } from '@/utils/misc';\nimport { eventDispatcher } from '@/utils/event';\nimport { getBookDirFromLanguage } from '@/utils/book';\nimport { Overlay } from '@/components/Overlay';\nimport { saveSysSettings } from '@/helpers/settings';\nimport { NOTE_PREFIX } from '@/types/view';\nimport useShortcuts from '@/hooks/useShortcuts';\nimport BooknoteItem from '../sidebar/BooknoteItem';\nimport NotebookHeader from './Header';\nimport NoteEditor from './NoteEditor';\nimport SearchBar from './SearchBar';\n\nconst MIN_NOTEBOOK_WIDTH = 0.15;\nconst MAX_NOTEBOOK_WIDTH = 0.45;\n\nconst Notebook: React.FC = ({}) => {\n  const _ = useTranslation();\n  const { updateAppTheme, safeAreaInsets } = useThemeStore();\n  const { envConfig, appService } = useEnv();\n  const { settings } = useSettingsStore();\n  const { sideBarBookKey } = useSidebarStore();\n  const { notebookWidth, isNotebookVisible, isNotebookPinned } = useNotebookStore();\n  const { notebookNewAnnotation, notebookEditAnnotation, setNotebookPin } = useNotebookStore();\n  const { getBookData, getConfig, saveConfig, updateBooknotes } = useBookDataStore();\n  const { getView, getViewSettings } = useReaderStore();\n  const { getNotebookWidth, setNotebookWidth, setNotebookVisible, toggleNotebookPin } =\n    useNotebookStore();\n  const { setNotebookNewAnnotation, setNotebookEditAnnotation } = useNotebookStore();\n\n  const [isSearchBarVisible, setIsSearchBarVisible] = useState(false);\n  const [searchResults, setSearchResults] = useState<BookNote[] | null>(null);\n  const [searchTerm, setSearchTerm] = useState('');\n\n  const onNavigateEvent = async () => {\n    const pinButton = document.querySelector('.sidebar-pin-btn');\n    const isPinButtonHidden = !pinButton || window.getComputedStyle(pinButton).display === 'none';\n    if (isPinButtonHidden) {\n      setNotebookVisible(false);\n    }\n  };\n\n  const handleHideNotebook = useCallback(() => {\n    if (!isNotebookPinned) {\n      setNotebookVisible(false);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isNotebookPinned]);\n\n  useShortcuts({ onEscape: handleHideNotebook }, [handleHideNotebook]);\n\n  useEffect(() => {\n    if (isNotebookVisible) {\n      updateAppTheme('base-200');\n    } else {\n      updateAppTheme('base-100');\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isNotebookVisible]);\n\n  useEffect(() => {\n    setNotebookWidth(settings.globalReadSettings.notebookWidth);\n    setNotebookPin(settings.globalReadSettings.isNotebookPinned);\n    setNotebookVisible(settings.globalReadSettings.isNotebookPinned);\n\n    eventDispatcher.on('navigate', onNavigateEvent);\n    return () => {\n      eventDispatcher.off('navigate', onNavigateEvent);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const handleNotebookResize = (newWidth: string) => {\n    setNotebookWidth(newWidth);\n    settings.globalReadSettings.notebookWidth = newWidth;\n  };\n\n  const handleTogglePin = () => {\n    toggleNotebookPin();\n    const globalReadSettings = settings.globalReadSettings;\n    const newGlobalReadSettings = { ...globalReadSettings, isNotebookPinned: !isNotebookPinned };\n    saveSysSettings(envConfig, 'globalReadSettings', newGlobalReadSettings);\n  };\n\n  const handleClickOverlay = () => {\n    setNotebookVisible(false);\n    setNotebookNewAnnotation(null);\n    setNotebookEditAnnotation(null);\n  };\n\n  const handleSaveNote = (selection: TextSelection, note: string) => {\n    if (!sideBarBookKey) return;\n    const view = getView(sideBarBookKey);\n    const config = getConfig(sideBarBookKey)!;\n\n    const cfi = view?.getCFI(selection.index, selection.range);\n    if (!cfi) return;\n\n    const { booknotes: annotations = [] } = config;\n    const annotation: BookNote = {\n      id: uniqueId(),\n      type: 'annotation',\n      cfi,\n      note,\n      text: selection.text,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n    view?.addAnnotation({ ...annotation, value: `${NOTE_PREFIX}${annotation.cfi}` });\n    annotations.push(annotation);\n    const updatedConfig = updateBooknotes(sideBarBookKey, annotations);\n    if (updatedConfig) {\n      saveConfig(envConfig, sideBarBookKey, updatedConfig, settings);\n    }\n    setNotebookNewAnnotation(null);\n  };\n\n  const handleEditNote = (note: BookNote, isDelete: boolean) => {\n    if (!sideBarBookKey) return;\n    const view = getView(sideBarBookKey);\n    const config = getConfig(sideBarBookKey)!;\n    const { booknotes: annotations = [] } = config;\n    const existingIndex = annotations.findIndex((item) => item.id === note.id);\n    if (existingIndex === -1) return;\n    if (isDelete) {\n      note.deletedAt = Date.now();\n    } else {\n      note.updatedAt = Date.now();\n    }\n    annotations[existingIndex] = note;\n    view?.addAnnotation({ ...note, value: `${NOTE_PREFIX}${note.cfi}` }, true);\n    const updatedConfig = updateBooknotes(sideBarBookKey, annotations);\n    if (updatedConfig) {\n      saveConfig(envConfig, sideBarBookKey, updatedConfig, settings);\n    }\n    setNotebookEditAnnotation(null);\n  };\n\n  const onDragMove = (data: { clientX: number }) => {\n    const widthFraction = 1 - data.clientX / window.innerWidth;\n    const newWidth = Math.max(MIN_NOTEBOOK_WIDTH, Math.min(MAX_NOTEBOOK_WIDTH, widthFraction));\n    handleNotebookResize(`${Math.round(newWidth * 10000) / 100}%`);\n  };\n\n  const onDragKeyDown = (data: { key: DragKey; step: number }) => {\n    const currentWidth = parseFloat(getNotebookWidth()) / 100;\n    let newWidth = currentWidth;\n\n    if (data.key === 'ArrowLeft') {\n      newWidth = Math.max(MIN_NOTEBOOK_WIDTH, currentWidth + data.step);\n    } else if (data.key === 'ArrowRight') {\n      newWidth = Math.min(MAX_NOTEBOOK_WIDTH, currentWidth - data.step);\n    }\n    handleNotebookResize(`${Math.round(newWidth * 10000) / 100}%`);\n  };\n\n  const { handleDragStart, handleDragKeyDown } = useDrag(onDragMove, onDragKeyDown);\n\n  const config = getConfig(sideBarBookKey);\n  const { booknotes: allNotes = [] } = config || {};\n  const annotationNotes = allNotes\n    .filter((note) => note.type === 'annotation' && note.note && !note.deletedAt)\n    .sort((a, b) => b.createdAt - a.createdAt);\n  const excerptNotes = allNotes\n    .filter((note) => note.type === 'excerpt' && note.text && !note.deletedAt)\n    .sort((a, b) => a.createdAt - b.createdAt);\n\n  const handleToggleSearchBar = () => {\n    setIsSearchBarVisible((prev) => !prev);\n    if (isSearchBarVisible) {\n      setSearchResults(null);\n      setSearchTerm('');\n    }\n  };\n\n  const filteredAnnotationNotes = useMemo(\n    () =>\n      isSearchBarVisible && searchResults\n        ? searchResults.filter((note) => note.type === 'annotation' && note.note && !note.deletedAt)\n        : annotationNotes,\n    [annotationNotes, searchResults, isSearchBarVisible],\n  );\n\n  const filteredExcerptNotes = useMemo(\n    () =>\n      isSearchBarVisible && searchResults\n        ? searchResults.filter((note) => note.type === 'excerpt' && note.text && !note.deletedAt)\n        : excerptNotes,\n    [excerptNotes, searchResults, isSearchBarVisible],\n  );\n\n  if (!sideBarBookKey) return null;\n\n  const bookData = getBookData(sideBarBookKey);\n  const viewSettings = getViewSettings(sideBarBookKey);\n  if (!bookData || !bookData.bookDoc) {\n    return null;\n  }\n  const { bookDoc } = bookData;\n  const languageDir = getBookDirFromLanguage(bookDoc.metadata.language);\n\n  const hasSearchResults = filteredAnnotationNotes.length > 0 || filteredExcerptNotes.length > 0;\n  const hasAnyNotes = annotationNotes.length > 0 || excerptNotes.length > 0;\n\n  return isNotebookVisible ? (\n    <>\n      {!isNotebookPinned && (\n        <Overlay\n          className={clsx('z-[45]', viewSettings?.isEink ? '' : 'bg-black/20')}\n          onDismiss={handleClickOverlay}\n        />\n      )}\n      <div\n        className={clsx(\n          'notebook-container right-0 flex min-w-60 select-none flex-col',\n          'full-height font-sans text-base font-normal sm:text-sm',\n          viewSettings?.isEink ? 'bg-base-100' : 'bg-base-200',\n          appService?.hasRoundedWindow && 'rounded-window-top-right rounded-window-bottom-right',\n          isNotebookPinned ? 'z-20' : 'z-[45] shadow-2xl',\n          !isNotebookPinned && viewSettings?.isEink && 'border-base-content border-s',\n        )}\n        role='group'\n        aria-label={_('Notebook')}\n        dir={viewSettings?.rtl && languageDir === 'rtl' ? 'rtl' : 'ltr'}\n        style={{\n          width: `${notebookWidth}`,\n          maxWidth: `${MAX_NOTEBOOK_WIDTH * 100}%`,\n          position: isNotebookPinned ? 'relative' : 'absolute',\n          paddingTop: `${safeAreaInsets?.top || 0}px`,\n        }}\n      >\n        <style jsx>{`\n          @media (max-width: 640px) {\n            .notebook-container {\n              width: 100%;\n              min-width: 100%;\n            }\n          }\n        `}</style>\n        <div\n          className={clsx(\n            'drag-bar absolute -left-2 top-0 h-full w-0.5 cursor-col-resize bg-transparent p-2',\n          )}\n          role='slider'\n          tabIndex={0}\n          aria-label={_('Resize Notebook')}\n          aria-orientation='horizontal'\n          aria-valuenow={parseFloat(notebookWidth)}\n          onMouseDown={handleDragStart}\n          onTouchStart={handleDragStart}\n          onKeyDown={handleDragKeyDown}\n        />\n        <div className='flex-shrink-0'>\n          <NotebookHeader\n            isPinned={isNotebookPinned}\n            isSearchBarVisible={isSearchBarVisible}\n            handleClose={() => setNotebookVisible(false)}\n            handleTogglePin={handleTogglePin}\n            handleToggleSearchBar={handleToggleSearchBar}\n          />\n          <div\n            className={clsx('search-bar', {\n              'search-bar-visible': isSearchBarVisible,\n            })}\n          >\n            <SearchBar\n              isVisible={isSearchBarVisible}\n              bookKey={sideBarBookKey}\n              searchTerm={searchTerm}\n              onSearchResultChange={setSearchResults}\n            />\n          </div>\n        </div>\n        <div className='flex-grow overflow-y-auto px-3'>\n          {isSearchBarVisible && searchResults && !hasSearchResults && hasAnyNotes && (\n            <div className='flex h-32 items-center justify-center text-gray-500'>\n              <p className='font-size-sm text-center'>{_('No notes match your search')}</p>\n            </div>\n          )}\n          <div dir='ltr'>\n            {filteredExcerptNotes.length > 0 && (\n              <p className='content font-size-base'>\n                {_('Excerpts')}\n                {isSearchBarVisible && searchResults && (\n                  <span className='font-size-xs ml-2 text-gray-500'>\n                    ({filteredExcerptNotes.length})\n                  </span>\n                )}\n              </p>\n            )}\n          </div>\n          <ul className=''>\n            {filteredExcerptNotes.map((item, index) => (\n              <li key={`${index}-${item.id}`} className='my-2'>\n                <div\n                  role='button'\n                  tabIndex={0}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Backspace' || e.key === 'Delete') {\n                      handleEditNote(item, true);\n                    }\n                  }}\n                  className='booknote-item collapse-arrow border-base-300 bg-base-100 collapse border'\n                >\n                  <div\n                    className={clsx(\n                      'collapse-title pe-8 text-sm font-medium',\n                      'h-[2.5rem] min-h-[2.5rem] p-[0.6rem]',\n                    )}\n                    style={\n                      {\n                        '--top-override': '1.25rem',\n                        '--end-override': '0.7rem',\n                      } as React.CSSProperties\n                    }\n                  >\n                    <p className='line-clamp-1'>{item.text || `Excerpt ${index + 1}`}</p>\n                  </div>\n                  <div className='collapse-content font-size-xs select-text px-3 pb-0'>\n                    <p className='hyphens-auto text-justify'>{item.text}</p>\n                    <div className='flex justify-end' dir='ltr'>\n                      {/* eslint-disable-next-line jsx-a11y/click-events-have-key-events, jsx-a11y/no-static-element-interactions*/}\n                      <div\n                        className='font-size-xs cursor-pointer align-bottom text-red-500 hover:text-red-600'\n                        onClick={handleEditNote.bind(null, item, true)}\n                        aria-label={_('Delete')}\n                      >\n                        {_('Delete')}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </li>\n            ))}\n          </ul>\n          <div dir='ltr'>\n            {(notebookNewAnnotation || filteredAnnotationNotes.length > 0) && (\n              <p className='content font-size-base'>\n                {_('Notes')}\n                {isSearchBarVisible && searchResults && filteredAnnotationNotes.length > 0 && (\n                  <span className='font-size-xs ml-2 text-gray-500'>\n                    ({filteredAnnotationNotes.length})\n                  </span>\n                )}\n              </p>\n            )}\n          </div>\n          {(notebookNewAnnotation || notebookEditAnnotation) && !isSearchBarVisible && (\n            <NoteEditor onSave={handleSaveNote} onEdit={(item) => handleEditNote(item, false)} />\n          )}\n          <ul>\n            {filteredAnnotationNotes.map((item, index) => (\n              <BooknoteItem key={`${index}-${item.cfi}`} bookKey={sideBarBookKey} item={item} />\n            ))}\n          </ul>\n        </div>\n      </div>\n    </>\n  ) : null;\n};\n\nexport default Notebook;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2188, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/KOSyncResolver.tsx"],"sourcesContent":["import React from 'react';\nimport Dialog from '@/components/Dialog';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { SyncDetails } from '../hooks/useKOSync';\n\ninterface KOSyncConflictResolverProps {\n  details: SyncDetails | null;\n  onResolveWithLocal: () => void;\n  onResolveWithRemote: () => void;\n  onClose: () => void;\n}\n\nconst KOSyncConflictResolver: React.FC<KOSyncConflictResolverProps> = ({\n  details,\n  onResolveWithLocal,\n  onResolveWithRemote,\n  onClose,\n}) => {\n  const _ = useTranslation();\n\n  if (!details) return null;\n\n  return (\n    <Dialog isOpen={true} onClose={onClose} title={_('Sync Conflict')}>\n      <p className='py-4 text-center'>\n        {_('Sync reading progress from \"{{deviceName}}\"?', {\n          deviceName: details.remote.device || _('another device'),\n        })}\n      </p>\n      <div className='mt-4 space-y-4'>\n        <button\n          className='btn h-auto w-full flex-col items-start py-2'\n          onClick={onResolveWithLocal}\n        >\n          <span>{_('Local Progress')}</span>\n          <span className='text-base-content/50 text-xs font-normal normal-case'>\n            {details.local.preview}\n          </span>\n        </button>\n        <button\n          className='btn btn-primary h-auto w-full flex-col items-start py-2'\n          onClick={onResolveWithRemote}\n        >\n          <span>{_('Remote Progress')}</span>\n          <span className='text-xs font-normal normal-case'>{details.remote.preview}</span>\n        </button>\n      </div>\n    </Dialog>\n  );\n};\n\nexport default KOSyncConflictResolver;\n"],"names":[],"mappings":";;;;;AACA;AACA;;;;;;;;;AAUA,MAAM,yBAAgE,CAAC,EACrE,OAAO,EACP,kBAAkB,EAClB,mBAAmB,EACnB,OAAO,EACR;IACC,MAAM,IAAI,IAAA,mKAAc;IAExB,IAAI,CAAC,SAAS,OAAO;IAErB,qBACE,qKAAC,0JAAM;QAAC,QAAQ;QAAM,SAAS;QAAS,OAAO,EAAE;;0BAC/C,qKAAC;gBAAE,WAAU;0BACV,EAAE,gDAAgD;oBACjD,YAAY,QAAQ,MAAM,CAAC,MAAM,IAAI,EAAE;gBACzC;;;;;;0BAEF,qKAAC;gBAAI,WAAU;;kCACb,qKAAC;wBACC,WAAU;wBACV,SAAS;;0CAET,qKAAC;0CAAM,EAAE;;;;;;0CACT,qKAAC;gCAAK,WAAU;0CACb,QAAQ,KAAK,CAAC,OAAO;;;;;;;;;;;;kCAG1B,qKAAC;wBACC,WAAU;wBACV,SAAS;;0CAET,qKAAC;0CAAM,EAAE;;;;;;0CACT,qKAAC;gCAAK,WAAU;0CAAmC,QAAQ,MAAM,CAAC,OAAO;;;;;;;;;;;;;;;;;;;;;;;;AAKnF;uCAEe"}},
    {"offset": {"line": 2295, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/FoliateViewer.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef, useState } from 'react';\nimport { BookDoc, getDirection } from '@/libs/document';\nimport { BookConfig } from '@/types/book';\nimport { FoliateView, wrappedFoliateView } from '@/types/view';\nimport { Insets } from '@/types/misc';\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useCustomFontStore } from '@/store/customFontStore';\nimport { useParallelViewStore } from '@/store/parallelViewStore';\nimport { useMouseEvent, useTouchEvent } from '../hooks/useIframeEvents';\nimport { usePagination } from '../hooks/usePagination';\nimport { useFoliateEvents } from '../hooks/useFoliateEvents';\nimport { useProgressSync } from '../hooks/useProgressSync';\nimport { useProgressAutoSave } from '../hooks/useProgressAutoSave';\nimport { useBackgroundTexture } from '@/hooks/useBackgroundTexture';\nimport { useAutoFocus } from '@/hooks/useAutoFocus';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useEinkMode } from '@/hooks/useEinkMode';\nimport { useKOSync } from '../hooks/useKOSync';\nimport {\n  applyFixedlayoutStyles,\n  applyImageStyle,\n  applyScrollModeClass,\n  applyTableStyle,\n  applyThemeModeClass,\n  applyTranslationStyle,\n  getStyles,\n  keepTextAlignment,\n  transformStylesheet,\n} from '@/utils/style';\nimport { mountAdditionalFonts, mountCustomFont } from '@/styles/fonts';\nimport { getBookDirFromLanguage, getBookDirFromWritingMode } from '@/utils/book';\nimport { useUICSS } from '@/hooks/useUICSS';\nimport {\n  handleKeydown,\n  handleKeyup,\n  handleMousedown,\n  handleMouseup,\n  handleClick,\n  handleWheel,\n  handleTouchStart,\n  handleTouchMove,\n  handleTouchEnd,\n} from '../utils/iframeEventHandlers';\nimport { getMaxInlineSize } from '@/utils/config';\nimport { getDirFromUILanguage } from '@/utils/rtl';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { TransformContext } from '@/services/transformers/types';\nimport { transformContent } from '@/services/transformService';\nimport { lockScreenOrientation } from '@/utils/bridge';\nimport { useTextTranslation } from '../hooks/useTextTranslation';\nimport { useBookCoverAutoSave } from '../hooks/useAutoSaveBookCover';\nimport { useDiscordPresence } from '@/hooks/useDiscordPresence';\nimport { manageSyntaxHighlighting } from '@/utils/highlightjs';\nimport { getViewInsets } from '@/utils/insets';\nimport { removeTabIndex } from '@/utils/a11y';\nimport { isCJKLang } from '@/utils/lang';\nimport { getLocale } from '@/utils/misc';\nimport Spinner from '@/components/Spinner';\nimport KOSyncConflictResolver from './KOSyncResolver';\n\ndeclare global {\n  interface Window {\n    eval(script: string): void;\n  }\n}\n\nconst FoliateViewer: React.FC<{\n  bookKey: string;\n  bookDoc: BookDoc;\n  config: BookConfig;\n  gridInsets: Insets;\n  contentInsets: Insets;\n}> = ({ bookKey, bookDoc, config, gridInsets, contentInsets: insets }) => {\n  const _ = useTranslation();\n  const { appService, envConfig } = useEnv();\n  const { themeCode, isDarkMode } = useThemeStore();\n  const { settings } = useSettingsStore();\n  const { loadCustomFonts, getLoadedFonts } = useCustomFontStore();\n  const { getView, setView: setFoliateView, setViewInited, setProgress } = useReaderStore();\n  const { getViewState, getViewSettings, setViewSettings } = useReaderStore();\n  const { getParallels } = useParallelViewStore();\n  const { getBookData } = useBookDataStore();\n  const { applyBackgroundTexture } = useBackgroundTexture();\n  const { applyEinkMode } = useEinkMode();\n  const bookData = getBookData(bookKey);\n  const viewState = getViewState(bookKey);\n  const viewSettings = getViewSettings(bookKey);\n\n  const viewRef = useRef<FoliateView | null>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const isViewCreated = useRef(false);\n  const doubleClickDisabled = useRef(!!viewSettings?.disableDoubleClick);\n  const [toastMessage, setToastMessage] = useState('');\n  const [loading, setLoading] = useState(false);\n  const docLoaded = useRef(false);\n\n  useAutoFocus<HTMLDivElement>({ ref: containerRef });\n\n  useDiscordPresence(\n    bookData?.book || null,\n    !!viewState?.isPrimary,\n    settings.discordRichPresenceEnabled,\n  );\n\n  useEffect(() => {\n    const timer = setTimeout(() => setToastMessage(''), 2000);\n    return () => clearTimeout(timer);\n  }, [toastMessage]);\n\n  useUICSS(bookKey);\n  useProgressSync(bookKey);\n  useProgressAutoSave(bookKey);\n  useBookCoverAutoSave(bookKey);\n  const { syncState, conflictDetails, resolveWithLocal, resolveWithRemote } = useKOSync(bookKey);\n  useTextTranslation(bookKey, viewRef.current);\n\n  const progressRelocateHandler = (event: Event) => {\n    const detail = (event as CustomEvent).detail;\n    setProgress(\n      bookKey,\n      detail.cfi,\n      detail.tocItem,\n      detail.section,\n      detail.location,\n      detail.time,\n      detail.range,\n    );\n  };\n\n  const getDocTransformHandler = ({ width, height }: { width: number; height: number }) => {\n    return (event: Event) => {\n      const { detail } = event as CustomEvent;\n      detail.data = Promise.resolve(detail.data)\n        .then((data) => {\n          const viewSettings = getViewSettings(bookKey);\n          const bookData = getBookData(bookKey);\n          if (viewSettings && detail.type === 'text/css')\n            return transformStylesheet(data, width, height, viewSettings.vertical);\n          const isHtml = detail.type === 'application/xhtml+xml' || detail.type === 'text/html';\n          if (viewSettings && bookData && isHtml) {\n            const ctx: TransformContext = {\n              bookKey,\n              viewSettings,\n              width,\n              height,\n              primaryLanguage: bookData.book?.primaryLanguage,\n              userLocale: getLocale(),\n              content: data,\n              sectionHref: detail.name,\n              transformers: [\n                'style',\n                'punctuation',\n                'footnote',\n                'whitespace',\n                'language',\n                'sanitizer',\n                'simplecc',\n                'proofread',\n              ],\n            };\n            return Promise.resolve(transformContent(ctx));\n          }\n          return data;\n        })\n        .catch((e) => {\n          console.error(new Error(`Failed to load ${detail.name}`, { cause: e }));\n          return '';\n        });\n    };\n  };\n\n  const docLoadHandler = (event: Event) => {\n    setLoading(false);\n    docLoaded.current = true;\n    const detail = (event as CustomEvent).detail;\n    console.log('doc index loaded:', detail.index);\n    if (detail.doc) {\n      const writingDir = viewRef.current?.renderer.setStyles && getDirection(detail.doc);\n      const viewSettings = getViewSettings(bookKey)!;\n      const bookData = getBookData(bookKey)!;\n\n      const newVertical =\n        writingDir?.vertical || viewSettings.writingMode.includes('vertical') || false;\n      const newRtl =\n        writingDir?.rtl ||\n        getDirFromUILanguage() === 'rtl' ||\n        viewSettings.writingMode.includes('rl') ||\n        false;\n      if (viewSettings.vertical !== newVertical || viewSettings.rtl !== newRtl) {\n        viewSettings.vertical = newVertical;\n        viewSettings.rtl = newRtl;\n        setViewSettings(bookKey, { ...viewSettings });\n      }\n\n      if (!bookData?.isFixedLayout) {\n        mountAdditionalFonts(detail.doc, isCJKLang(bookData.book?.primaryLanguage));\n      }\n\n      getLoadedFonts().forEach((font) => {\n        mountCustomFont(detail.doc, font);\n      });\n\n      if (bookDoc.rendition?.layout === 'pre-paginated') {\n        applyFixedlayoutStyles(detail.doc, viewSettings);\n      }\n\n      applyImageStyle(detail.doc);\n      applyTableStyle(detail.doc);\n      applyThemeModeClass(detail.doc, isDarkMode);\n      applyScrollModeClass(detail.doc, viewSettings.scrolled || false);\n      keepTextAlignment(detail.doc);\n      removeTabIndex(detail.doc);\n\n      // Inline scripts in tauri platforms are not executed by default\n      if (viewSettings.allowScript && isTauriAppPlatform()) {\n        evalInlineScripts(detail.doc);\n      }\n\n      // only call on load if we have highlighting turned on.\n      if (viewSettings.codeHighlighting) {\n        manageSyntaxHighlighting(detail.doc, viewSettings);\n      }\n\n      setTimeout(() => {\n        const booknotes = config.booknotes || [];\n        booknotes\n          .filter((item) => !item.deletedAt && item.type === 'annotation' && item.style)\n          .forEach((annotation) => viewRef.current?.addAnnotation(annotation));\n      }, 100);\n\n      if (!detail.doc.isEventListenersAdded) {\n        // listened events in iframes are posted to the main window\n        // and then used by useMouseEvent and useTouchEvent\n        // and more gesture events can be detected in the iframeEventHandlers\n        detail.doc.isEventListenersAdded = true;\n        detail.doc.addEventListener('keydown', handleKeydown.bind(null, bookKey));\n        detail.doc.addEventListener('keyup', handleKeyup.bind(null, bookKey));\n        detail.doc.addEventListener('mousedown', handleMousedown.bind(null, bookKey));\n        detail.doc.addEventListener('mouseup', handleMouseup.bind(null, bookKey));\n        detail.doc.addEventListener('click', handleClick.bind(null, bookKey, doubleClickDisabled));\n        detail.doc.addEventListener('wheel', handleWheel.bind(null, bookKey));\n        detail.doc.addEventListener('touchstart', handleTouchStart.bind(null, bookKey));\n        detail.doc.addEventListener('touchmove', handleTouchMove.bind(null, bookKey));\n        detail.doc.addEventListener('touchend', handleTouchEnd.bind(null, bookKey));\n      }\n    }\n  };\n\n  const evalInlineScripts = (doc: Document) => {\n    if (doc.defaultView && doc.defaultView.frameElement) {\n      const iframe = doc.defaultView.frameElement as HTMLIFrameElement;\n      const scripts = doc.querySelectorAll('script:not([src])');\n      scripts.forEach((script, index) => {\n        const scriptContent = script.textContent || script.innerHTML;\n        try {\n          console.warn('Evaluating inline scripts in iframe');\n          iframe.contentWindow?.eval(scriptContent);\n        } catch (error) {\n          console.error(`Error executing iframe script ${index + 1}:`, error);\n        }\n      });\n    }\n  };\n\n  const docRelocateHandler = (event: Event) => {\n    const detail = (event as CustomEvent).detail;\n    if (detail.reason !== 'scroll' && detail.reason !== 'page') return;\n\n    const parallelViews = getParallels(bookKey);\n    if (parallelViews && parallelViews.size > 0) {\n      parallelViews.forEach((key) => {\n        if (key !== bookKey) {\n          const target = getView(key)?.renderer;\n          if (target) {\n            target.goTo?.({ index: detail.index, anchor: detail.fraction });\n          }\n        }\n      });\n    }\n  };\n\n  const { handlePageFlip, handleContinuousScroll } = usePagination(bookKey, viewRef, containerRef);\n  const mouseHandlers = useMouseEvent(bookKey, handlePageFlip, handleContinuousScroll);\n  const touchHandlers = useTouchEvent(bookKey, handlePageFlip, handleContinuousScroll);\n\n  useFoliateEvents(viewRef.current, {\n    onLoad: docLoadHandler,\n    onRelocate: progressRelocateHandler,\n    onRendererRelocate: docRelocateHandler,\n  });\n\n  useEffect(() => {\n    if (isViewCreated.current) return;\n    isViewCreated.current = true;\n\n    setTimeout(() => setLoading(true), 200);\n\n    const openBook = async () => {\n      console.log('Opening book', bookKey);\n      await import('foliate-js/view.js');\n      const view = wrappedFoliateView(document.createElement('foliate-view') as FoliateView);\n      view.id = `foliate-view-${bookKey}`;\n      containerRef.current?.appendChild(view);\n\n      const viewSettings = getViewSettings(bookKey)!;\n      const writingMode = viewSettings.writingMode;\n      if (writingMode) {\n        const settingsDir = getBookDirFromWritingMode(writingMode);\n        const languageDir = getBookDirFromLanguage(bookDoc.metadata.language);\n        if (settingsDir !== 'auto') {\n          bookDoc.dir = settingsDir;\n        } else if (languageDir !== 'auto') {\n          bookDoc.dir = languageDir;\n        }\n      }\n\n      if (bookDoc.rendition?.layout === 'pre-paginated' && bookDoc.sections) {\n        bookDoc.rendition.spread = viewSettings.spreadMode;\n        const coverSide = bookDoc.dir === 'rtl' ? 'right' : 'left';\n        bookDoc.sections[0]!.pageSpread = viewSettings.keepCoverSpread ? '' : coverSide;\n      }\n\n      await view.open(bookDoc);\n      // make sure we can listen renderer events after opening book\n      viewRef.current = view;\n      setFoliateView(bookKey, view);\n\n      const { book } = view;\n\n      book.transformTarget?.addEventListener('load', (event: Event) => {\n        const { detail } = event as CustomEvent;\n        if (detail.isScript) {\n          detail.allow = viewSettings.allowScript ?? false;\n        }\n      });\n      const viewWidth = appService?.isMobile ? screen.width : window.innerWidth;\n      const viewHeight = appService?.isMobile ? screen.height : window.innerHeight;\n      const width = viewWidth;\n      const height = viewHeight;\n      book.transformTarget?.addEventListener('data', getDocTransformHandler({ width, height }));\n      view.renderer.setStyles?.(getStyles(viewSettings));\n      applyTranslationStyle(viewSettings);\n\n      doubleClickDisabled.current = viewSettings.disableDoubleClick!;\n      const animated = viewSettings.animated!;\n      const eink = viewSettings.isEink!;\n      const maxColumnCount = viewSettings.maxColumnCount!;\n      const maxInlineSize = getMaxInlineSize(viewSettings);\n      const maxBlockSize = viewSettings.maxBlockSize!;\n      const screenOrientation = viewSettings.screenOrientation!;\n      if (appService?.isMobileApp) {\n        await lockScreenOrientation({ orientation: screenOrientation });\n      }\n      if (animated) {\n        view.renderer.setAttribute('animated', '');\n      } else {\n        view.renderer.removeAttribute('animated');\n      }\n      if (appService?.isAndroidApp) {\n        if (eink) {\n          view.renderer.setAttribute('eink', '');\n        } else {\n          view.renderer.removeAttribute('eink');\n        }\n        applyEinkMode(eink);\n      }\n      if (bookDoc?.rendition?.layout === 'pre-paginated') {\n        view.renderer.setAttribute('zoom', viewSettings.zoomMode);\n        view.renderer.setAttribute('spread', viewSettings.spreadMode);\n        view.renderer.setAttribute('scale-factor', viewSettings.zoomLevel);\n      } else {\n        view.renderer.setAttribute('max-column-count', maxColumnCount);\n        view.renderer.setAttribute('max-inline-size', `${maxInlineSize}px`);\n        view.renderer.setAttribute('max-block-size', `${maxBlockSize}px`);\n      }\n      applyMarginAndGap();\n\n      const lastLocation = config.location;\n      if (lastLocation) {\n        await view.init({ lastLocation });\n      } else {\n        await view.goToFraction(0);\n      }\n      setViewInited(bookKey, true);\n    };\n\n    openBook();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const applyMarginAndGap = () => {\n    const viewSettings = getViewSettings(bookKey)!;\n    const viewState = getViewState(bookKey);\n    const viewInsets = getViewInsets(viewSettings);\n    const showDoubleBorder = viewSettings.vertical && viewSettings.doubleBorder;\n    const showDoubleBorderHeader = showDoubleBorder && viewSettings.showHeader;\n    const showDoubleBorderFooter = showDoubleBorder && viewSettings.showFooter;\n    const showTopHeader = viewSettings.showHeader && !viewSettings.vertical;\n    const showBottomFooter = viewSettings.showFooter && !viewSettings.vertical;\n    const moreTopInset = showTopHeader ? Math.max(0, 44 - insets.top) : 0;\n    const ttsBarHeight =\n      viewState?.ttsEnabled && viewSettings.showTTSBar ? 52 + gridInsets.bottom * 0.33 : 0;\n    const moreBottomInset = showBottomFooter\n      ? Math.max(0, Math.max(ttsBarHeight, 44) - insets.bottom)\n      : Math.max(0, ttsBarHeight);\n    const moreRightInset = showDoubleBorderHeader ? 32 : 0;\n    const moreLeftInset = showDoubleBorderFooter ? 32 : 0;\n    const topMargin = (showTopHeader ? insets.top : viewInsets.top) + moreTopInset;\n    const rightMargin = insets.right + moreRightInset;\n    const bottomMargin = (showBottomFooter ? insets.bottom : viewInsets.bottom) + moreBottomInset;\n    const leftMargin = insets.left + moreLeftInset;\n    const viewMargins = viewSettings.showMarginsOnScroll && viewSettings.scrolled;\n\n    viewRef.current?.renderer.setAttribute('margin-top', `${viewMargins ? 0 : topMargin}px`);\n    viewRef.current?.renderer.setAttribute('margin-right', `${rightMargin}px`);\n    viewRef.current?.renderer.setAttribute('margin-bottom', `${viewMargins ? 0 : bottomMargin}px`);\n    viewRef.current?.renderer.setAttribute('margin-left', `${leftMargin}px`);\n    viewRef.current?.renderer.setAttribute('gap', `${viewSettings.gapPercent}%`);\n    if (viewSettings.scrolled) {\n      viewRef.current?.renderer.setAttribute('flow', 'scrolled');\n    }\n  };\n\n  useEffect(() => {\n    if (viewRef.current && viewRef.current.renderer) {\n      const viewSettings = getViewSettings(bookKey)!;\n      viewRef.current.renderer.setStyles?.(getStyles(viewSettings));\n      const docs = viewRef.current.renderer.getContents();\n      docs.forEach(({ doc }) => {\n        if (bookDoc.rendition?.layout === 'pre-paginated') {\n          applyFixedlayoutStyles(doc, viewSettings);\n        }\n        applyThemeModeClass(doc, isDarkMode);\n        applyScrollModeClass(doc, viewSettings.scrolled || false);\n      });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    themeCode,\n    isDarkMode,\n    viewSettings?.scrolled,\n    viewSettings?.overrideColor,\n    viewSettings?.invertImgColorInDark,\n  ]);\n\n  useEffect(() => {\n    const mountCustomFonts = async () => {\n      await loadCustomFonts(envConfig);\n      getLoadedFonts().forEach((font) => {\n        mountCustomFont(document, font);\n        const docs = viewRef.current?.renderer.getContents();\n        docs?.forEach(({ doc }) => mountCustomFont(doc, font));\n      });\n    };\n    if (settings.customFonts) {\n      mountCustomFonts();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [settings.customFonts, envConfig]);\n\n  useEffect(() => {\n    if (!viewSettings) return;\n    applyBackgroundTexture(envConfig, viewSettings);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    viewSettings?.backgroundTextureId,\n    viewSettings?.backgroundOpacity,\n    viewSettings?.backgroundSize,\n    applyBackgroundTexture,\n  ]);\n\n  useEffect(() => {\n    if (viewRef.current && viewRef.current.renderer) {\n      doubleClickDisabled.current = !!viewSettings?.disableDoubleClick;\n    }\n  }, [viewSettings?.disableDoubleClick]);\n\n  useEffect(() => {\n    if (viewRef.current && viewRef.current.renderer && viewSettings) {\n      applyMarginAndGap();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    insets.top,\n    insets.right,\n    insets.bottom,\n    insets.left,\n    viewSettings?.doubleBorder,\n    viewSettings?.showHeader,\n    viewSettings?.showFooter,\n    viewSettings?.showTTSBar,\n    viewState?.ttsEnabled,\n  ]);\n\n  const showViewMargins = viewSettings?.showMarginsOnScroll && viewSettings?.scrolled;\n\n  return (\n    <>\n      <div\n        ref={containerRef}\n        tabIndex={-1}\n        role='document'\n        aria-label={_('Book Content')}\n        className='foliate-viewer h-[100%] w-[100%] focus:outline-none'\n        style={{\n          paddingTop: showViewMargins ? insets.top : 0,\n          paddingBottom: showViewMargins ? insets.bottom : 0,\n        }}\n        {...mouseHandlers}\n        {...touchHandlers}\n      />\n      {!docLoaded.current && loading && <Spinner loading={true} />}\n      {syncState === 'conflict' && conflictDetails && (\n        <KOSyncConflictResolver\n          details={conflictDetails}\n          onResolveWithLocal={resolveWithLocal}\n          onResolveWithRemote={resolveWithRemote}\n          onClose={resolveWithLocal}\n        />\n      )}\n    </>\n  );\n};\n\nexport default FoliateViewer;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2839, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/SectionInfo.tsx"],"sourcesContent":["import clsx from 'clsx';\nimport React from 'react';\nimport { Insets } from '@/types/misc';\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useTranslation } from '@/hooks/useTranslation';\n\ninterface SectionInfoProps {\n  bookKey: string;\n  section?: string;\n  showDoubleBorder: boolean;\n  isScrolled: boolean;\n  isVertical: boolean;\n  isEink: boolean;\n  horizontalGap: number;\n  contentInsets: Insets;\n  gridInsets: Insets;\n}\n\nconst SectionInfo: React.FC<SectionInfoProps> = ({\n  bookKey,\n  section,\n  showDoubleBorder,\n  isScrolled,\n  isVertical,\n  isEink,\n  horizontalGap,\n  contentInsets,\n  gridInsets,\n}) => {\n  const _ = useTranslation();\n  const { appService } = useEnv();\n  const { hoveredBookKey, setHoveredBookKey } = useReaderStore();\n  const { systemUIVisible, statusBarHeight } = useThemeStore();\n  const topInset = Math.max(\n    gridInsets.top,\n    appService?.isAndroidApp && systemUIVisible ? statusBarHeight / 2 : 0,\n  );\n\n  return (\n    <>\n      <div\n        className={clsx(\n          'absolute left-0 right-0 top-0 z-10',\n          isScrolled && !isVertical && 'bg-base-100',\n        )}\n        style={{\n          height: `${topInset}px`,\n        }}\n      />\n      <div\n        className={clsx(\n          'sectioninfo absolute flex items-center overflow-hidden font-sans',\n          isEink ? 'text-sm font-normal' : 'text-neutral-content text-xs font-light',\n          isVertical ? 'writing-vertical-rl max-h-[85%]' : 'top-0 h-[44px]',\n          isScrolled && !isVertical && 'bg-base-100',\n        )}\n        role='none'\n        onClick={() => setHoveredBookKey(bookKey)}\n        style={\n          isVertical\n            ? {\n                top: `${(contentInsets.top - gridInsets.top) * 1.5}px`,\n                right: showDoubleBorder\n                  ? `calc(${contentInsets.right}px)`\n                  : `calc(${Math.max(0, contentInsets.right - 32)}px)`,\n                width: showDoubleBorder ? '32px' : `${contentInsets.right}px`,\n                height: `calc(100% - ${contentInsets.top + contentInsets.bottom}px)`,\n              }\n            : {\n                top: `${topInset}px`,\n                paddingInline: `calc(${horizontalGap / 2}% + ${contentInsets.left / 2}px)`,\n                width: '100%',\n              }\n        }\n      >\n        <span\n          aria-label={section ? _('Section Title') + `: ${section}` : ''}\n          className={clsx(\n            'text-center',\n            isVertical ? '' : 'line-clamp-1',\n            !isVertical && hoveredBookKey == bookKey && 'hidden',\n          )}\n        >\n          {section || ''}\n        </span>\n      </div>\n    </>\n  );\n};\n\nexport default SectionInfo;\n"],"names":[],"mappings":";;;;;AAAA;AAGA;AACA;AACA;AACA;;;;;;;;;;;;;;AAcA,MAAM,cAA0C,CAAC,EAC/C,OAAO,EACP,OAAO,EACP,gBAAgB,EAChB,UAAU,EACV,UAAU,EACV,MAAM,EACN,aAAa,EACb,aAAa,EACb,UAAU,EACX;IACC,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAC7B,MAAM,EAAE,cAAc,EAAE,iBAAiB,EAAE,GAAG,IAAA,gKAAc;IAC5D,MAAM,EAAE,eAAe,EAAE,eAAe,EAAE,GAAG,IAAA,8JAAa;IAC1D,MAAM,WAAW,KAAK,GAAG,CACvB,WAAW,GAAG,EACd,YAAY,gBAAgB,kBAAkB,kBAAkB,IAAI;IAGtE,qBACE;;0BACE,qKAAC;gBACC,WAAW,IAAA,mHAAI,EACb,sCACA,cAAc,CAAC,cAAc;gBAE/B,OAAO;oBACL,QAAQ,GAAG,SAAS,EAAE,CAAC;gBACzB;;;;;;0BAEF,qKAAC;gBACC,WAAW,IAAA,mHAAI,EACb,oEACA,SAAS,wBAAwB,2CACjC,aAAa,oCAAoC,kBACjD,cAAc,CAAC,cAAc;gBAE/B,MAAK;gBACL,SAAS,IAAM,kBAAkB;gBACjC,OACE,aACI;oBACE,KAAK,GAAG,CAAC,cAAc,GAAG,GAAG,WAAW,GAAG,IAAI,IAAI,EAAE,CAAC;oBACtD,OAAO,mBACH,CAAC,KAAK,EAAE,cAAc,KAAK,CAAC,GAAG,CAAC,GAChC,CAAC,KAAK,EAAE,KAAK,GAAG,CAAC,GAAG,cAAc,KAAK,GAAG,IAAI,GAAG,CAAC;oBACtD,OAAO,mBAAmB,SAAS,GAAG,cAAc,KAAK,CAAC,EAAE,CAAC;oBAC7D,QAAQ,CAAC,YAAY,EAAE,cAAc,GAAG,GAAG,cAAc,MAAM,CAAC,GAAG,CAAC;gBACtE,IACA;oBACE,KAAK,GAAG,SAAS,EAAE,CAAC;oBACpB,eAAe,CAAC,KAAK,EAAE,gBAAgB,EAAE,IAAI,EAAE,cAAc,IAAI,GAAG,EAAE,GAAG,CAAC;oBAC1E,OAAO;gBACT;0BAGN,cAAA,qKAAC;oBACC,cAAY,UAAU,EAAE,mBAAmB,CAAC,EAAE,EAAE,SAAS,GAAG;oBAC5D,WAAW,IAAA,mHAAI,EACb,eACA,aAAa,KAAK,gBAClB,CAAC,cAAc,kBAAkB,WAAW;8BAG7C,WAAW;;;;;;;;;;;;;AAKtB;uCAEe"}},
    {"offset": {"line": 2919, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/SidebarToggler.tsx"],"sourcesContent":["import React from 'react';\nimport { TbLayoutSidebar, TbLayoutSidebarFilled } from 'react-icons/tb';\n\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport Button from '@/components/Button';\n\ninterface SidebarTogglerProps {\n  bookKey: string;\n}\n\nconst SidebarToggler: React.FC<SidebarTogglerProps> = ({ bookKey }) => {\n  const _ = useTranslation();\n  const { sideBarBookKey, isSideBarVisible, setSideBarBookKey, toggleSideBar } = useSidebarStore();\n  const { setHoveredBookKey } = useReaderStore();\n  const handleToggleSidebar = () => {\n    if (sideBarBookKey === bookKey) {\n      toggleSideBar();\n    } else {\n      setSideBarBookKey(bookKey);\n      if (!isSideBarVisible) toggleSideBar();\n    }\n    setHoveredBookKey('');\n  };\n  return (\n    <Button\n      icon={\n        sideBarBookKey === bookKey && isSideBarVisible ? (\n          <TbLayoutSidebarFilled className='text-base-content' />\n        ) : (\n          <TbLayoutSidebar className='text-base-content' />\n        )\n      }\n      onClick={handleToggleSidebar}\n      label={_('Toggle Sidebar')}\n    />\n  );\n};\n\nexport default SidebarToggler;\n"],"names":[],"mappings":";;;;;AACA;AAEA;AACA;AACA;AACA;;;;;;;;;;;;;;AAMA,MAAM,iBAAgD,CAAC,EAAE,OAAO,EAAE;IAChE,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,cAAc,EAAE,gBAAgB,EAAE,iBAAiB,EAAE,aAAa,EAAE,GAAG,IAAA,kKAAe;IAC9F,MAAM,EAAE,iBAAiB,EAAE,GAAG,IAAA,gKAAc;IAC5C,MAAM,sBAAsB;QAC1B,IAAI,mBAAmB,SAAS;YAC9B;QACF,OAAO;YACL,kBAAkB;YAClB,IAAI,CAAC,kBAAkB;QACzB;QACA,kBAAkB;IACpB;IACA,qBACE,qKAAC,0JAAM;QACL,MACE,mBAAmB,WAAW,iCAC5B,qKAAC,iPAAqB;YAAC,WAAU;;;;;mCAEjC,qKAAC,2OAAe;YAAC,WAAU;;;;;;QAG/B,SAAS;QACT,OAAO,EAAE;;;;;;AAGf;uCAEe"}},
    {"offset": {"line": 2985, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/BookmarkToggler.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useState } from 'react';\nimport { MdOutlineBookmarkAdd, MdOutlineBookmark } from 'react-icons/md';\n\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useEnv } from '@/context/EnvContext';\nimport { BookNote } from '@/types/book';\nimport { uniqueId } from '@/utils/misc';\nimport Button from '@/components/Button';\nimport { getCurrentPage } from '@/utils/book';\nimport { eventDispatcher } from '@/utils/event';\nimport { isCfiInLocation } from '@/utils/cfi';\n\ninterface BookmarkTogglerProps {\n  bookKey: string;\n}\n\nconst BookmarkToggler: React.FC<BookmarkTogglerProps> = ({ bookKey }) => {\n  const _ = useTranslation();\n  const { envConfig } = useEnv();\n  const { settings } = useSettingsStore();\n  const { getConfig, saveConfig, getBookData, updateBooknotes } = useBookDataStore();\n  const { getProgress, getViewState, setBookmarkRibbonVisibility } = useReaderStore();\n  const [isBookmarked, setIsBookmarked] = useState(false);\n  const config = getConfig(bookKey);\n  const progress = getProgress(bookKey);\n\n  const toggleBookmark = () => {\n    const bookData = getBookData(bookKey);\n    const config = getConfig(bookKey);\n    const progress = getProgress(bookKey);\n    if (!bookData || !config || !progress) return;\n\n    const { booknotes: bookmarks = [] } = config;\n    const { location: cfi, range } = progress;\n    if (!cfi) return;\n    const isBookmarked = getViewState(bookKey)?.ribbonVisible;\n    if (!isBookmarked) {\n      setIsBookmarked(true);\n      const text = range?.startContainer.textContent?.slice(0, 128) || '';\n      const truncatedText = text.length === 128 ? text + '...' : text;\n      const bookmark: BookNote = {\n        id: uniqueId(),\n        type: 'bookmark',\n        cfi,\n        text: truncatedText ? truncatedText : `${getCurrentPage(bookData.book!, progress)}`,\n        note: '',\n        createdAt: Date.now(),\n        updatedAt: Date.now(),\n      };\n      const existingBookmark = bookmarks.find(\n        (item) => item.type === 'bookmark' && item.cfi === cfi,\n      );\n      if (existingBookmark) {\n        existingBookmark.deletedAt = null;\n        existingBookmark.updatedAt = Date.now();\n        existingBookmark.text = bookmark.text;\n      } else {\n        bookmarks.push(bookmark);\n      }\n      const updatedConfig = updateBooknotes(bookKey, bookmarks);\n      if (updatedConfig) {\n        saveConfig(envConfig, bookKey, updatedConfig, settings);\n      }\n    } else {\n      setIsBookmarked(false);\n      bookmarks.forEach((item) => {\n        if (item.type === 'bookmark' && isCfiInLocation(item.cfi, cfi)) {\n          item.deletedAt = Date.now();\n        }\n      });\n      const updatedConfig = updateBooknotes(bookKey, bookmarks);\n      if (updatedConfig) {\n        saveConfig(envConfig, bookKey, updatedConfig, settings);\n      }\n    }\n  };\n\n  useEffect(() => {\n    const handleBookmarkToggle = (e: CustomEvent) => {\n      const { bookKey: eventBookKey } = e.detail;\n      if (eventBookKey !== bookKey) return;\n      toggleBookmark();\n    };\n    eventDispatcher.on('toggle-bookmark', handleBookmarkToggle);\n    return () => {\n      eventDispatcher.off('toggle-bookmark', handleBookmarkToggle);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey]);\n\n  useEffect(() => {\n    const { booknotes = [] } = config || {};\n    const { location: cfi } = progress || {};\n    if (!cfi) return;\n\n    const locationBookmarked = booknotes\n      .filter((booknote) => booknote.type === 'bookmark' && !booknote.deletedAt)\n      .some((item) => isCfiInLocation(item.cfi, cfi));\n    setIsBookmarked(locationBookmarked);\n    setBookmarkRibbonVisibility(bookKey, locationBookmarked);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [config, progress]);\n\n  return (\n    <Button\n      icon={\n        isBookmarked ? (\n          <MdOutlineBookmark className='text-base-content' />\n        ) : (\n          <MdOutlineBookmarkAdd className='text-base-content' />\n        )\n      }\n      onClick={toggleBookmark}\n      label={isBookmarked ? _('Remove Bookmark') : _('Add Bookmark')}\n    ></Button>\n  );\n};\n\nexport default BookmarkToggler;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3137, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/NotebookToggler.tsx"],"sourcesContent":["import React from 'react';\nimport { LuNotebookPen } from 'react-icons/lu';\n\nimport { useEnv } from '@/context/EnvContext';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useNotebookStore } from '@/store/notebookStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\nimport Button from '@/components/Button';\n\ninterface NotebookTogglerProps {\n  bookKey: string;\n}\n\nconst NotebookToggler: React.FC<NotebookTogglerProps> = ({ bookKey }) => {\n  const _ = useTranslation();\n  const { appService } = useEnv();\n  const { setHoveredBookKey } = useReaderStore();\n  const { sideBarBookKey, setSideBarBookKey } = useSidebarStore();\n  const { isNotebookVisible, toggleNotebook } = useNotebookStore();\n  const iconSize16 = useResponsiveSize(16);\n\n  const handleToggleSidebar = () => {\n    if (appService?.isMobile) {\n      setHoveredBookKey('');\n    }\n    if (sideBarBookKey === bookKey) {\n      toggleNotebook();\n    } else {\n      setSideBarBookKey(bookKey);\n      if (!isNotebookVisible) toggleNotebook();\n    }\n  };\n  return (\n    <Button\n      icon={\n        sideBarBookKey == bookKey && isNotebookVisible ? (\n          <LuNotebookPen size={iconSize16} className='text-base-content' />\n        ) : (\n          <LuNotebookPen size={iconSize16} className='text-base-content' />\n        )\n      }\n      onClick={handleToggleSidebar}\n      label={_('Notebook')}\n    ></Button>\n  );\n};\n\nexport default NotebookToggler;\n"],"names":[],"mappings":";;;;;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;AAMA,MAAM,kBAAkD,CAAC,EAAE,OAAO,EAAE;IAClE,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAC7B,MAAM,EAAE,iBAAiB,EAAE,GAAG,IAAA,gKAAc;IAC5C,MAAM,EAAE,cAAc,EAAE,iBAAiB,EAAE,GAAG,IAAA,kKAAe;IAC7D,MAAM,EAAE,iBAAiB,EAAE,cAAc,EAAE,GAAG,IAAA,oKAAgB;IAC9D,MAAM,aAAa,IAAA,yKAAiB,EAAC;IAErC,MAAM,sBAAsB;QAC1B,IAAI,YAAY,UAAU;YACxB,kBAAkB;QACpB;QACA,IAAI,mBAAmB,SAAS;YAC9B;QACF,OAAO;YACL,kBAAkB;YAClB,IAAI,CAAC,mBAAmB;QAC1B;IACF;IACA,qBACE,qKAAC,0JAAM;QACL,MACE,kBAAkB,WAAW,kCAC3B,qKAAC,yOAAa;YAAC,MAAM;YAAY,WAAU;;;;;mCAE3C,qKAAC,yOAAa;YAAC,MAAM;YAAY,WAAU;;;;;;QAG/C,SAAS;QACT,OAAO,EAAE;;;;;;AAGf;uCAEe"}},
    {"offset": {"line": 3217, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/SettingsToggler.tsx"],"sourcesContent":["import React from 'react';\nimport { RiFontSize } from 'react-icons/ri';\n\nimport { useReaderStore } from '@/store/readerStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport Button from '@/components/Button';\n\ninterface SettingsTogglerProps {\n  bookKey: string;\n}\n\nconst SettingsToggler: React.FC<SettingsTogglerProps> = ({ bookKey }) => {\n  const _ = useTranslation();\n  const { setHoveredBookKey } = useReaderStore();\n  const { isSettingsDialogOpen, setSettingsDialogOpen } = useSettingsStore();\n  const { setSettingsDialogBookKey } = useSettingsStore();\n  const handleToggleSettings = () => {\n    setHoveredBookKey('');\n    setSettingsDialogBookKey(bookKey);\n    setSettingsDialogOpen(!isSettingsDialogOpen);\n  };\n  return (\n    <Button\n      icon={<RiFontSize className='text-base-content' />}\n      onClick={handleToggleSettings}\n      label={_('Font & Layout')}\n    ></Button>\n  );\n};\n\nexport default SettingsToggler;\n"],"names":[],"mappings":";;;;;AACA;AAEA;AACA;AACA;AACA;;;;;;;;;;;;;;AAMA,MAAM,kBAAkD,CAAC,EAAE,OAAO,EAAE;IAClE,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,iBAAiB,EAAE,GAAG,IAAA,gKAAc;IAC5C,MAAM,EAAE,oBAAoB,EAAE,qBAAqB,EAAE,GAAG,IAAA,oKAAgB;IACxE,MAAM,EAAE,wBAAwB,EAAE,GAAG,IAAA,oKAAgB;IACrD,MAAM,uBAAuB;QAC3B,kBAAkB;QAClB,yBAAyB;QACzB,sBAAsB,CAAC;IACzB;IACA,qBACE,qKAAC,0JAAM;QACL,oBAAM,qKAAC,sOAAU;YAAC,WAAU;;;;;;QAC5B,SAAS;QACT,OAAO,EAAE;;;;;;AAGf;uCAEe"}},
    {"offset": {"line": 3274, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/TranslationToggler.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useState } from 'react';\nimport { RiTranslateAi } from 'react-icons/ri';\n\nimport { useEnv } from '@/context/EnvContext';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { saveViewSettings } from '@/helpers/settings';\nimport { isTranslationAvailable } from '@/services/translators/utils';\nimport Button from '@/components/Button';\n\nconst TranslationToggler = ({ bookKey }: { bookKey: string }) => {\n  const _ = useTranslation();\n  const { envConfig, appService } = useEnv();\n  const { getBookData } = useBookDataStore();\n  const { getViewSettings, setViewSettings, setHoveredBookKey } = useReaderStore();\n\n  const bookData = getBookData(bookKey);\n  const viewSettings = getViewSettings(bookKey)!;\n  const [translationEnabled, setTranslationEnabled] = useState(viewSettings.translationEnabled!);\n  const [translationAvailable, setTranslationAvailable] = useState(\n    isTranslationAvailable(bookData?.book, viewSettings.translateTargetLang),\n  );\n\n  useEffect(() => {\n    if (translationEnabled === viewSettings.translationEnabled) return;\n    if (appService?.isMobile) {\n      setHoveredBookKey('');\n    }\n    saveViewSettings(envConfig, bookKey, 'translationEnabled', translationEnabled, true, false);\n    viewSettings.translationEnabled = translationEnabled;\n    setViewSettings(bookKey, { ...viewSettings });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [translationEnabled]);\n\n  useEffect(() => {\n    setTranslationEnabled(viewSettings.translationEnabled);\n    setTranslationAvailable(\n      isTranslationAvailable(bookData?.book, viewSettings.translateTargetLang),\n    );\n  }, [bookData, viewSettings.translationEnabled, viewSettings.translateTargetLang]);\n\n  return (\n    <Button\n      icon={\n        <RiTranslateAi className={translationEnabled ? 'text-blue-500' : 'text-base-content'} />\n      }\n      aria-label={_('Toggle Translation')}\n      disabled={!translationAvailable && !translationEnabled}\n      onClick={() => setTranslationEnabled(!translationEnabled)}\n      label={\n        translationAvailable\n          ? translationEnabled\n            ? _('Disable Translation')\n            : _('Enable Translation')\n          : _('Translation Disabled')\n      }\n    ></Button>\n  );\n};\n\nexport default TranslationToggler;\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;AAXA;;;;;;;;;;;AAaA,MAAM,qBAAqB,CAAC,EAAE,OAAO,EAAuB;IAC1D,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IACxC,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,oKAAgB;IACxC,MAAM,EAAE,eAAe,EAAE,eAAe,EAAE,iBAAiB,EAAE,GAAG,IAAA,gKAAc;IAE9E,MAAM,WAAW,YAAY;IAC7B,MAAM,eAAe,gBAAgB;IACrC,MAAM,CAAC,oBAAoB,sBAAsB,GAAG,IAAA,+GAAQ,EAAC,aAAa,kBAAkB;IAC5F,MAAM,CAAC,sBAAsB,wBAAwB,GAAG,IAAA,+GAAQ,EAC9D,IAAA,oLAAsB,EAAC,UAAU,MAAM,aAAa,mBAAmB;IAGzE,IAAA,gHAAS,EAAC;QACR,IAAI,uBAAuB,aAAa,kBAAkB,EAAE;QAC5D,IAAI,YAAY,UAAU;YACxB,kBAAkB;QACpB;QACA,IAAA,iKAAgB,EAAC,WAAW,SAAS,sBAAsB,oBAAoB,MAAM;QACrF,aAAa,kBAAkB,GAAG;QAClC,gBAAgB,SAAS;YAAE,GAAG,YAAY;QAAC;IAC3C,uDAAuD;IACzD,GAAG;QAAC;KAAmB;IAEvB,IAAA,gHAAS,EAAC;QACR,sBAAsB,aAAa,kBAAkB;QACrD,wBACE,IAAA,oLAAsB,EAAC,UAAU,MAAM,aAAa,mBAAmB;IAE3E,GAAG;QAAC;QAAU,aAAa,kBAAkB;QAAE,aAAa,mBAAmB;KAAC;IAEhF,qBACE,qKAAC,0JAAM;QACL,oBACE,qKAAC,yOAAa;YAAC,WAAW,qBAAqB,kBAAkB;;;;;;QAEnE,cAAY,EAAE;QACd,UAAU,CAAC,wBAAwB,CAAC;QACpC,SAAS,IAAM,sBAAsB,CAAC;QACtC,OACE,uBACI,qBACE,EAAE,yBACF,EAAE,wBACJ,EAAE;;;;;;AAId;uCAEe"}},
    {"offset": {"line": 3365, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/ViewMenu.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useEffect } from 'react';\nimport { useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { BiMoon, BiSun } from 'react-icons/bi';\nimport { TbSunMoon } from 'react-icons/tb';\nimport { MdZoomOut, MdZoomIn, MdCheck } from 'react-icons/md';\nimport { MdSync, MdSyncProblem } from 'react-icons/md';\nimport { IoMdExpand } from 'react-icons/io';\nimport { TbArrowAutofitWidth } from 'react-icons/tb';\nimport { TbColumns1, TbColumns2 } from 'react-icons/tb';\n\nimport { MAX_ZOOM_LEVEL, MIN_ZOOM_LEVEL, ZOOM_STEP } from '@/services/constants';\nimport { useEnv } from '@/context/EnvContext';\nimport { useAuth } from '@/context/AuthContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { getStyles } from '@/utils/style';\nimport { navigateToLogin } from '@/utils/nav';\nimport { eventDispatcher } from '@/utils/event';\nimport { getMaxInlineSize } from '@/utils/config';\nimport { saveViewSettings } from '@/helpers/settings';\nimport { tauriHandleToggleFullScreen } from '@/utils/window';\nimport MenuItem from '@/components/MenuItem';\nimport Menu from '@/components/Menu';\n\ninterface ViewMenuProps {\n  bookKey: string;\n  setIsDropdownOpen?: (open: boolean) => void;\n}\n\nconst ViewMenu: React.FC<ViewMenuProps> = ({ bookKey, setIsDropdownOpen }) => {\n  const _ = useTranslation();\n  const router = useRouter();\n  const { user } = useAuth();\n  const { envConfig, appService } = useEnv();\n  const { getConfig, getBookData } = useBookDataStore();\n  const { setSettingsDialogOpen, setSettingsDialogBookKey } = useSettingsStore();\n  const { getView, getViewSettings, getViewState, setViewSettings } = useReaderStore();\n  const config = getConfig(bookKey)!;\n  const bookData = getBookData(bookKey)!;\n  const viewSettings = getViewSettings(bookKey)!;\n  const viewState = getViewState(bookKey);\n\n  const { themeMode, isDarkMode, setThemeMode } = useThemeStore();\n  const [isScrolledMode, setScrolledMode] = useState(viewSettings!.scrolled);\n  const [zoomLevel, setZoomLevel] = useState(viewSettings!.zoomLevel!);\n  const [zoomMode, setZoomMode] = useState(viewSettings!.zoomMode!);\n  const [spreadMode, setSpreadMode] = useState(viewSettings!.spreadMode!);\n  const [keepCoverSpread, setKeepCoverSpread] = useState(viewSettings!.keepCoverSpread!);\n  const [invertImgColorInDark, setInvertImgColorInDark] = useState(\n    viewSettings!.invertImgColorInDark,\n  );\n\n  const zoomIn = () => setZoomLevel((prev) => Math.min(prev + ZOOM_STEP, MAX_ZOOM_LEVEL));\n  const zoomOut = () => setZoomLevel((prev) => Math.max(prev - ZOOM_STEP, MIN_ZOOM_LEVEL));\n  const resetZoom = () => setZoomLevel(100);\n  const toggleScrolledMode = () => setScrolledMode(!isScrolledMode);\n\n  const openFontLayoutMenu = () => {\n    setIsDropdownOpen?.(false);\n    setSettingsDialogBookKey(bookKey);\n    setSettingsDialogOpen(true);\n  };\n\n  const cycleThemeMode = () => {\n    const nextMode = themeMode === 'auto' ? 'light' : themeMode === 'light' ? 'dark' : 'auto';\n    setThemeMode(nextMode);\n  };\n\n  const handleFullScreen = () => {\n    tauriHandleToggleFullScreen();\n    setIsDropdownOpen?.(false);\n  };\n\n  const handleSync = () => {\n    if (!user) {\n      navigateToLogin(router);\n      setIsDropdownOpen?.(false);\n    } else {\n      eventDispatcher.dispatch('sync-book-progress', { bookKey });\n    }\n  };\n\n  useEffect(() => {\n    if (isScrolledMode === viewSettings!.scrolled) return;\n    viewSettings!.scrolled = isScrolledMode;\n    getView(bookKey)?.renderer.setAttribute('flow', isScrolledMode ? 'scrolled' : 'paginated');\n    getView(bookKey)?.renderer.setAttribute(\n      'max-inline-size',\n      `${getMaxInlineSize(viewSettings)}px`,\n    );\n    getView(bookKey)?.renderer.setStyles?.(getStyles(viewSettings!));\n    setViewSettings(bookKey, viewSettings!);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isScrolledMode]);\n\n  useEffect(() => {\n    saveViewSettings(envConfig, bookKey, 'zoomLevel', zoomLevel, true, true);\n    if (bookData.bookDoc?.rendition?.layout === 'pre-paginated') {\n      getView(bookKey)?.renderer.setAttribute('scale-factor', zoomLevel);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [zoomLevel]);\n\n  useEffect(() => {\n    if (invertImgColorInDark === viewSettings.invertImgColorInDark) return;\n    saveViewSettings(envConfig, bookKey, 'invertImgColorInDark', invertImgColorInDark, true, true);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [invertImgColorInDark]);\n\n  useEffect(() => {\n    if (zoomMode === viewSettings.zoomMode) return;\n    viewSettings.zoomMode = zoomMode;\n    getView(bookKey)?.renderer.setAttribute('zoom', zoomMode);\n    setViewSettings(bookKey, viewSettings);\n    saveViewSettings(envConfig, bookKey, 'zoomMode', zoomMode, true, false);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [zoomMode]);\n\n  useEffect(() => {\n    if (spreadMode === viewSettings.spreadMode) return;\n    viewSettings.spreadMode = spreadMode;\n    getView(bookKey)?.renderer.setAttribute('spread', spreadMode);\n    setViewSettings(bookKey, viewSettings);\n    saveViewSettings(envConfig, bookKey, 'spreadMode', spreadMode, true, false);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [spreadMode]);\n\n  useEffect(() => {\n    if (keepCoverSpread === viewSettings.keepCoverSpread) return;\n    if (!bookData?.bookDoc?.sections?.length) return;\n    viewSettings.keepCoverSpread = keepCoverSpread;\n    const coverSide = bookData.bookDoc.dir === 'rtl' ? 'right' : 'left';\n    bookData.bookDoc.sections[0]!.pageSpread = keepCoverSpread ? '' : coverSide;\n    getView(bookKey)?.renderer.setAttribute('spread', spreadMode);\n    setViewSettings(bookKey, viewSettings);\n    saveViewSettings(envConfig, bookKey, 'keepCoverSpread', keepCoverSpread, true, false);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [keepCoverSpread]);\n\n  const lastSyncTime = Math.max(config?.lastSyncedAtConfig || 0, config?.lastSyncedAtNotes || 0);\n\n  return (\n    <Menu\n      className={clsx(\n        'view-menu dropdown-content dropdown-right no-triangle z-20 mt-1 border',\n        'bgcolor-base-200 shadow-2xl',\n      )}\n      style={{\n        maxWidth: `${window.innerWidth - 40}px`,\n        marginRight: window.innerWidth < 640 ? '-36px' : '0px',\n      }}\n      onCancel={() => setIsDropdownOpen?.(false)}\n    >\n      {bookData.bookDoc?.rendition?.layout === 'pre-paginated' && (\n        <>\n          <div\n            title={_('Zoom Level')}\n            className={clsx('flex items-center justify-between rounded-md')}\n          >\n            <button\n              title={_('Zoom Out')}\n              onClick={zoomOut}\n              className={clsx(\n                'hover:bg-base-300 text-base-content rounded-full p-2',\n                zoomLevel <= MIN_ZOOM_LEVEL && 'btn-disabled text-gray-400',\n              )}\n            >\n              <MdZoomOut />\n            </button>\n            <button\n              title={_('Reset Zoom')}\n              className={clsx(\n                'hover:bg-base-300 text-base-content h-8 min-h-8 w-[50%] rounded-md p-1 text-center',\n              )}\n              onClick={resetZoom}\n            >\n              {zoomLevel}%\n            </button>\n            <button\n              title={_('Zoom In')}\n              onClick={zoomIn}\n              className={clsx(\n                'hover:bg-base-300 text-base-content rounded-full p-2',\n                zoomLevel >= MAX_ZOOM_LEVEL && 'btn-disabled text-gray-400',\n              )}\n            >\n              <MdZoomIn />\n            </button>\n          </div>\n\n          <>\n            <div\n              title={_('Zoom Mode')}\n              className={clsx('my-2 flex items-center justify-between rounded-md')}\n            >\n              <button\n                title={_('Single Page')}\n                onClick={setSpreadMode.bind(null, 'none')}\n                className={clsx(\n                  'hover:bg-base-300 text-base-content rounded-full p-2',\n                  spreadMode === 'none' && 'bg-base-300/75',\n                )}\n              >\n                <TbColumns1 />\n              </button>\n              <button\n                title={_('Auto Spread')}\n                onClick={setSpreadMode.bind(null, 'auto')}\n                className={clsx(\n                  'hover:bg-base-300 text-base-content rounded-full p-2',\n                  spreadMode === 'auto' && 'bg-base-300/75',\n                )}\n              >\n                <TbColumns2 />\n              </button>\n              <div className='bg-base-300 mx-2 h-6 w-[1px]' />\n              <button\n                title={_('Fit Page')}\n                onClick={setZoomMode.bind(null, 'fit-page')}\n                className={clsx(\n                  'hover:bg-base-300 text-base-content rounded-full p-2',\n                  zoomMode === 'fit-page' && 'bg-base-300/75',\n                )}\n              >\n                <IoMdExpand />\n              </button>\n              <button\n                title={_('Fit Width')}\n                onClick={setZoomMode.bind(null, 'fit-width')}\n                className={clsx(\n                  'hover:bg-base-300 text-base-content rounded-full p-2',\n                  zoomMode === 'fit-width' && 'bg-base-300/75',\n                )}\n              >\n                <TbArrowAutofitWidth />\n              </button>\n            </div>\n\n            <MenuItem\n              label={_('Separate Cover Page')}\n              Icon={keepCoverSpread ? MdCheck : undefined}\n              onClick={() => setKeepCoverSpread(!keepCoverSpread)}\n              disabled={spreadMode === 'none'}\n            />\n          </>\n          <hr aria-hidden='true' className='border-base-300 my-1' />\n        </>\n      )}\n\n      <MenuItem label={_('Font & Layout')} shortcut='Shift+F' onClick={openFontLayoutMenu} />\n\n      <MenuItem\n        label={_('Scrolled Mode')}\n        shortcut='Shift+J'\n        Icon={isScrolledMode ? MdCheck : undefined}\n        onClick={toggleScrolledMode}\n        disabled={bookData.isFixedLayout}\n      />\n\n      <hr aria-hidden='true' className='border-base-300 my-1' />\n\n      <MenuItem\n        label={\n          !user\n            ? _('Sign in to Sync')\n            : lastSyncTime\n              ? _('Synced at {{time}}', {\n                  time: new Date(lastSyncTime).toLocaleString(),\n                })\n              : _('Never synced')\n        }\n        Icon={user ? MdSync : MdSyncProblem}\n        iconClassName={user && viewState?.syncing ? 'animate-reverse-spin' : ''}\n        onClick={handleSync}\n      />\n\n      <hr aria-hidden='true' className='border-base-300 my-1' />\n\n      {appService?.hasWindow && <MenuItem label={_('Fullscreen')} onClick={handleFullScreen} />}\n      <MenuItem\n        label={\n          themeMode === 'dark'\n            ? _('Dark Mode')\n            : themeMode === 'light'\n              ? _('Light Mode')\n              : _('Auto Mode')\n        }\n        Icon={themeMode === 'dark' ? BiMoon : themeMode === 'light' ? BiSun : TbSunMoon}\n        onClick={cycleThemeMode}\n      />\n      <MenuItem\n        label={_('Invert Image In Dark Mode')}\n        disabled={!isDarkMode}\n        Icon={invertImgColorInDark ? MdCheck : undefined}\n        onClick={() => setInvertImgColorInDark(!invertImgColorInDark)}\n      />\n    </Menu>\n  );\n};\n\nexport default ViewMenu;\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;AA7BA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoCA,MAAM,WAAoC,CAAC,EAAE,OAAO,EAAE,iBAAiB,EAAE;IACvE,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,SAAS,IAAA,0SAAS;IACxB,MAAM,EAAE,IAAI,EAAE,GAAG,IAAA,4JAAO;IACxB,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IACxC,MAAM,EAAE,SAAS,EAAE,WAAW,EAAE,GAAG,IAAA,oKAAgB;IACnD,MAAM,EAAE,qBAAqB,EAAE,wBAAwB,EAAE,GAAG,IAAA,oKAAgB;IAC5E,MAAM,EAAE,OAAO,EAAE,eAAe,EAAE,YAAY,EAAE,eAAe,EAAE,GAAG,IAAA,gKAAc;IAClF,MAAM,SAAS,UAAU;IACzB,MAAM,WAAW,YAAY;IAC7B,MAAM,eAAe,gBAAgB;IACrC,MAAM,YAAY,aAAa;IAE/B,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,YAAY,EAAE,GAAG,IAAA,8JAAa;IAC7D,MAAM,CAAC,gBAAgB,gBAAgB,GAAG,IAAA,+GAAQ,EAAC,aAAc,QAAQ;IACzE,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,+GAAQ,EAAC,aAAc,SAAS;IAClE,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,+GAAQ,EAAC,aAAc,QAAQ;IAC/D,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,+GAAQ,EAAC,aAAc,UAAU;IACrE,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,IAAA,+GAAQ,EAAC,aAAc,eAAe;IACpF,MAAM,CAAC,sBAAsB,wBAAwB,GAAG,IAAA,+GAAQ,EAC9D,aAAc,oBAAoB;IAGpC,MAAM,SAAS,IAAM,aAAa,CAAC,OAAS,KAAK,GAAG,CAAC,OAAO,4JAAS,EAAE,iKAAc;IACrF,MAAM,UAAU,IAAM,aAAa,CAAC,OAAS,KAAK,GAAG,CAAC,OAAO,4JAAS,EAAE,iKAAc;IACtF,MAAM,YAAY,IAAM,aAAa;IACrC,MAAM,qBAAqB,IAAM,gBAAgB,CAAC;IAElD,MAAM,qBAAqB;QACzB,oBAAoB;QACpB,yBAAyB;QACzB,sBAAsB;IACxB;IAEA,MAAM,iBAAiB;QACrB,MAAM,WAAW,cAAc,SAAS,UAAU,cAAc,UAAU,SAAS;QACnF,aAAa;IACf;IAEA,MAAM,mBAAmB;QACvB,IAAA,wKAA2B;QAC3B,oBAAoB;IACtB;IAEA,MAAM,aAAa;QACjB,IAAI,CAAC,MAAM;YACT,IAAA,yJAAe,EAAC;YAChB,oBAAoB;QACtB,OAAO;YACL,2JAAe,CAAC,QAAQ,CAAC,sBAAsB;gBAAE;YAAQ;QAC3D;IACF;IAEA,IAAA,gHAAS,EAAC;QACR,IAAI,mBAAmB,aAAc,QAAQ,EAAE;QAC/C,aAAc,QAAQ,GAAG;QACzB,QAAQ,UAAU,SAAS,aAAa,QAAQ,iBAAiB,aAAa;QAC9E,QAAQ,UAAU,SAAS,aACzB,mBACA,GAAG,IAAA,6JAAgB,EAAC,cAAc,EAAE,CAAC;QAEvC,QAAQ,UAAU,SAAS,YAAY,IAAA,qJAAS,EAAC;QACjD,gBAAgB,SAAS;IACzB,uDAAuD;IACzD,GAAG;QAAC;KAAe;IAEnB,IAAA,gHAAS,EAAC;QACR,IAAA,iKAAgB,EAAC,WAAW,SAAS,aAAa,WAAW,MAAM;QACnE,IAAI,SAAS,OAAO,EAAE,WAAW,WAAW,iBAAiB;YAC3D,QAAQ,UAAU,SAAS,aAAa,gBAAgB;QAC1D;IACA,uDAAuD;IACzD,GAAG;QAAC;KAAU;IAEd,IAAA,gHAAS,EAAC;QACR,IAAI,yBAAyB,aAAa,oBAAoB,EAAE;QAChE,IAAA,iKAAgB,EAAC,WAAW,SAAS,wBAAwB,sBAAsB,MAAM;IACzF,uDAAuD;IACzD,GAAG;QAAC;KAAqB;IAEzB,IAAA,gHAAS,EAAC;QACR,IAAI,aAAa,aAAa,QAAQ,EAAE;QACxC,aAAa,QAAQ,GAAG;QACxB,QAAQ,UAAU,SAAS,aAAa,QAAQ;QAChD,gBAAgB,SAAS;QACzB,IAAA,iKAAgB,EAAC,WAAW,SAAS,YAAY,UAAU,MAAM;IACjE,uDAAuD;IACzD,GAAG;QAAC;KAAS;IAEb,IAAA,gHAAS,EAAC;QACR,IAAI,eAAe,aAAa,UAAU,EAAE;QAC5C,aAAa,UAAU,GAAG;QAC1B,QAAQ,UAAU,SAAS,aAAa,UAAU;QAClD,gBAAgB,SAAS;QACzB,IAAA,iKAAgB,EAAC,WAAW,SAAS,cAAc,YAAY,MAAM;IACrE,uDAAuD;IACzD,GAAG;QAAC;KAAW;IAEf,IAAA,gHAAS,EAAC;QACR,IAAI,oBAAoB,aAAa,eAAe,EAAE;QACtD,IAAI,CAAC,UAAU,SAAS,UAAU,QAAQ;QAC1C,aAAa,eAAe,GAAG;QAC/B,MAAM,YAAY,SAAS,OAAO,CAAC,GAAG,KAAK,QAAQ,UAAU;QAC7D,SAAS,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAE,UAAU,GAAG,kBAAkB,KAAK;QAClE,QAAQ,UAAU,SAAS,aAAa,UAAU;QAClD,gBAAgB,SAAS;QACzB,IAAA,iKAAgB,EAAC,WAAW,SAAS,mBAAmB,iBAAiB,MAAM;IAC/E,uDAAuD;IACzD,GAAG;QAAC;KAAgB;IAEpB,MAAM,eAAe,KAAK,GAAG,CAAC,QAAQ,sBAAsB,GAAG,QAAQ,qBAAqB;IAE5F,qBACE,qKAAC,wJAAI;QACH,WAAW,IAAA,mHAAI,EACb,0EACA;QAEF,OAAO;YACL,UAAU,GAAG,OAAO,UAAU,GAAG,GAAG,EAAE,CAAC;YACvC,aAAa,OAAO,UAAU,GAAG,MAAM,UAAU;QACnD;QACA,UAAU,IAAM,oBAAoB;;YAEnC,SAAS,OAAO,EAAE,WAAW,WAAW,iCACvC;;kCACE,qKAAC;wBACC,OAAO,EAAE;wBACT,WAAW,IAAA,mHAAI,EAAC;;0CAEhB,qKAAC;gCACC,OAAO,EAAE;gCACT,SAAS;gCACT,WAAW,IAAA,mHAAI,EACb,wDACA,aAAa,iKAAc,IAAI;0CAGjC,cAAA,qKAAC,qOAAS;;;;;;;;;;0CAEZ,qKAAC;gCACC,OAAO,EAAE;gCACT,WAAW,IAAA,mHAAI,EACb;gCAEF,SAAS;;oCAER;oCAAU;;;;;;;0CAEb,qKAAC;gCACC,OAAO,EAAE;gCACT,SAAS;gCACT,WAAW,IAAA,mHAAI,EACb,wDACA,aAAa,iKAAc,IAAI;0CAGjC,cAAA,qKAAC,oOAAQ;;;;;;;;;;;;;;;;kCAIb;;0CACE,qKAAC;gCACC,OAAO,EAAE;gCACT,WAAW,IAAA,mHAAI,EAAC;;kDAEhB,qKAAC;wCACC,OAAO,EAAE;wCACT,SAAS,cAAc,IAAI,CAAC,MAAM;wCAClC,WAAW,IAAA,mHAAI,EACb,wDACA,eAAe,UAAU;kDAG3B,cAAA,qKAAC,sOAAU;;;;;;;;;;kDAEb,qKAAC;wCACC,OAAO,EAAE;wCACT,SAAS,cAAc,IAAI,CAAC,MAAM;wCAClC,WAAW,IAAA,mHAAI,EACb,wDACA,eAAe,UAAU;kDAG3B,cAAA,qKAAC,sOAAU;;;;;;;;;;kDAEb,qKAAC;wCAAI,WAAU;;;;;;kDACf,qKAAC;wCACC,OAAO,EAAE;wCACT,SAAS,YAAY,IAAI,CAAC,MAAM;wCAChC,WAAW,IAAA,mHAAI,EACb,wDACA,aAAa,cAAc;kDAG7B,cAAA,qKAAC,sOAAU;;;;;;;;;;kDAEb,qKAAC;wCACC,OAAO,EAAE;wCACT,SAAS,YAAY,IAAI,CAAC,MAAM;wCAChC,WAAW,IAAA,mHAAI,EACb,wDACA,aAAa,eAAe;kDAG9B,cAAA,qKAAC,+OAAmB;;;;;;;;;;;;;;;;0CAIxB,qKAAC,4JAAQ;gCACP,OAAO,EAAE;gCACT,MAAM,kBAAkB,mOAAO,GAAG;gCAClC,SAAS,IAAM,mBAAmB,CAAC;gCACnC,UAAU,eAAe;;;;;;;;kCAG7B,qKAAC;wBAAG,eAAY;wBAAO,WAAU;;;;;;;;0BAIrC,qKAAC,4JAAQ;gBAAC,OAAO,EAAE;gBAAkB,UAAS;gBAAU,SAAS;;;;;;0BAEjE,qKAAC,4JAAQ;gBACP,OAAO,EAAE;gBACT,UAAS;gBACT,MAAM,iBAAiB,mOAAO,GAAG;gBACjC,SAAS;gBACT,UAAU,SAAS,aAAa;;;;;;0BAGlC,qKAAC;gBAAG,eAAY;gBAAO,WAAU;;;;;;0BAEjC,qKAAC,4JAAQ;gBACP,OACE,CAAC,OACG,EAAE,qBACF,eACE,EAAE,sBAAsB;oBACtB,MAAM,IAAI,KAAK,cAAc,cAAc;gBAC7C,KACA,EAAE;gBAEV,MAAM,OAAO,kOAAM,GAAG,yOAAa;gBACnC,eAAe,QAAQ,WAAW,UAAU,yBAAyB;gBACrE,SAAS;;;;;;0BAGX,qKAAC;gBAAG,eAAY;gBAAO,WAAU;;;;;;YAEhC,YAAY,2BAAa,qKAAC,4JAAQ;gBAAC,OAAO,EAAE;gBAAe,SAAS;;;;;;0BACrE,qKAAC,4JAAQ;gBACP,OACE,cAAc,SACV,EAAE,eACF,cAAc,UACZ,EAAE,gBACF,EAAE;gBAEV,MAAM,cAAc,SAAS,kOAAM,GAAG,cAAc,UAAU,iOAAK,GAAG,qOAAS;gBAC/E,SAAS;;;;;;0BAEX,qKAAC,4JAAQ;gBACP,OAAO,EAAE;gBACT,UAAU,CAAC;gBACX,MAAM,uBAAuB,mOAAO,GAAG;gBACvC,SAAS,IAAM,wBAAwB,CAAC;;;;;;;;;;;;AAIhD;uCAEe"}},
    {"offset": {"line": 3792, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/HeaderBar.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { PiDotsThreeVerticalBold } from 'react-icons/pi';\n\nimport { Insets } from '@/types/misc';\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useTrafficLightStore } from '@/store/trafficLightStore';\nimport { useTrafficLight } from '@/hooks/useTrafficLight';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\nimport { getHighlightColorHex } from '../utils/annotatorUtil';\nimport { annotationToolQuickActions } from './annotator/AnnotationTools';\nimport { AnnotationToolType } from '@/types/annotator';\nimport { saveViewSettings } from '@/helpers/settings';\nimport { HighlighterIcon } from '@/components/HighlighterIcon';\nimport Dropdown from '@/components/Dropdown';\nimport WindowButtons from '@/components/WindowButtons';\nimport QuickActionMenu from './annotator/QuickActionMenu';\nimport SidebarToggler from './SidebarToggler';\nimport BookmarkToggler from './BookmarkToggler';\nimport NotebookToggler from './NotebookToggler';\nimport SettingsToggler from './SettingsToggler';\nimport TranslationToggler from './TranslationToggler';\nimport ViewMenu from './ViewMenu';\n\ninterface HeaderBarProps {\n  bookKey: string;\n  bookTitle: string;\n  isTopLeft: boolean;\n  isHoveredAnim: boolean;\n  gridInsets: Insets;\n  onCloseBook: (bookKey: string) => void;\n}\n\nconst HeaderBar: React.FC<HeaderBarProps> = ({\n  bookKey,\n  bookTitle,\n  isTopLeft,\n  isHoveredAnim,\n  gridInsets,\n  onCloseBook,\n}) => {\n  const _ = useTranslation();\n  const { envConfig, appService } = useEnv();\n  const { settings } = useSettingsStore();\n  const { isTrafficLightVisible } = useTrafficLight();\n  const { trafficLightInFullscreen, setTrafficLightVisibility } = useTrafficLightStore();\n  const { bookKeys, hoveredBookKey } = useReaderStore();\n  const { isDarkMode, systemUIVisible, statusBarHeight } = useThemeStore();\n  const { isSideBarVisible } = useSidebarStore();\n  const { getView, getViewSettings, setHoveredBookKey } = useReaderStore();\n  const viewSettings = getViewSettings(bookKey);\n\n  const [isDropdownOpen, setIsDropdownOpen] = useState(false);\n  const view = getView(bookKey);\n  const iconSize16 = useResponsiveSize(16);\n  const headerRef = useRef<HTMLDivElement>(null);\n  const windowButtonVisible = appService?.hasWindowBar && !isTrafficLightVisible;\n\n  const docs = view?.renderer.getContents() ?? [];\n  const pointerInDoc = docs.some(({ doc }) => doc?.body?.style.cursor === 'pointer');\n\n  const enableAnnotationQuickActions = viewSettings?.enableAnnotationQuickActions;\n  const annotationQuickActionButton =\n    annotationToolQuickActions.find(\n      (button) => button.type === viewSettings?.annotationQuickAction,\n    ) || annotationToolQuickActions[0]!;\n  const annotationQuickAction = viewSettings?.annotationQuickAction;\n  const AnnotationToolQuickActionIcon = annotationQuickActionButton.Icon;\n  const highlightStyle = settings.globalReadSettings.highlightStyle;\n  const highlightColor = settings.globalReadSettings.highlightStyles[highlightStyle];\n  const highlightHexColor = getHighlightColorHex(settings, highlightColor);\n\n  const handleToggleDropdown = (isOpen: boolean) => {\n    setIsDropdownOpen(isOpen);\n    if (!isOpen) setHoveredBookKey('');\n  };\n\n  const handleAnnotationQuickActionSelect = (action: AnnotationToolType | null) => {\n    if (viewSettings?.annotationQuickAction === action) action = null;\n    saveViewSettings(envConfig, bookKey, 'annotationQuickAction', action, false, true);\n  };\n\n  useEffect(() => {\n    if (!appService?.hasTrafficLight) return;\n    if (isSideBarVisible) return;\n\n    if (hoveredBookKey === bookKey && isTopLeft) {\n      setTrafficLightVisibility(true, { x: 10, y: 20 });\n    } else if (!hoveredBookKey) {\n      setTrafficLightVisibility(false);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [appService, isSideBarVisible, hoveredBookKey]);\n\n  // Check if mouse is outside header area to avoid false positive event of MouseLeave when clicking inside header on Windows\n  const isMouseOutsideHeader = useCallback((clientX: number, clientY: number) => {\n    if (!headerRef.current) return true;\n\n    const rect = headerRef.current.getBoundingClientRect();\n    return (\n      clientX <= rect.left || clientX >= rect.right || clientY <= rect.top || clientY >= rect.bottom\n    );\n  }, []);\n\n  const isHeaderVisible = hoveredBookKey === bookKey || isDropdownOpen;\n  const trafficLightInHeader =\n    appService?.hasTrafficLight && !trafficLightInFullscreen && !isSideBarVisible && isTopLeft;\n\n  return (\n    <div\n      className={clsx('bg-base-100 absolute top-0 w-full')}\n      style={{\n        paddingTop: appService?.hasSafeAreaInset ? `${gridInsets.top}px` : '0px',\n      }}\n    >\n      <div\n        role='none'\n        className={clsx('absolute top-0 z-10 h-11 w-full', pointerInDoc && 'pointer-events-none')}\n        onClick={() => setHoveredBookKey(bookKey)}\n        onMouseEnter={() => !appService?.isMobile && setHoveredBookKey(bookKey)}\n        onTouchStart={() => !appService?.isMobile && setHoveredBookKey(bookKey)}\n      />\n      <div\n        className={clsx(\n          'bg-base-100 absolute left-0 right-0 top-0 z-10',\n          appService?.hasRoundedWindow && 'rounded-window-top-right',\n          isHeaderVisible ? 'visible' : 'hidden',\n        )}\n        style={{\n          height: systemUIVisible ? `${Math.max(gridInsets.top, statusBarHeight)}px` : '0px',\n        }}\n      />\n      <div\n        ref={headerRef}\n        role='group'\n        aria-label={_('Header Bar')}\n        className={clsx(\n          `header-bar bg-base-100 absolute top-0 z-10 flex h-11 w-full items-center pr-4`,\n          `shadow-xs transition-[opacity,margin-top] duration-300`,\n          trafficLightInHeader ? 'pl-20' : 'pl-4',\n          appService?.hasRoundedWindow && 'rounded-window-top-right',\n          !isSideBarVisible && appService?.hasRoundedWindow && 'rounded-window-top-left',\n          isHoveredAnim && 'hover-bar-anim',\n          isHeaderVisible ? 'pointer-events-auto visible' : 'pointer-events-none opacity-0',\n          isDropdownOpen && 'header-bar-pinned',\n        )}\n        style={{\n          marginTop: systemUIVisible\n            ? `${Math.max(gridInsets.top, statusBarHeight)}px`\n            : `${gridInsets.top}px`,\n        }}\n        onFocus={() => !appService?.isMobile && setHoveredBookKey(bookKey)}\n        onMouseLeave={(e) => {\n          if (!appService?.isMobile && isMouseOutsideHeader(e.clientX, e.clientY)) {\n            setHoveredBookKey('');\n          }\n        }}\n      >\n        <div className='bg-base-100 sidebar-bookmark-toggler z-20 flex h-full items-center gap-x-4 pe-2'>\n          <div className='hidden sm:flex'>\n            <SidebarToggler bookKey={bookKey} />\n          </div>\n          <BookmarkToggler bookKey={bookKey} />\n          <TranslationToggler bookKey={bookKey} />\n          {enableAnnotationQuickActions && (\n            <Dropdown\n              label={\n                annotationQuickAction\n                  ? _('Disable Quick Action')\n                  : _('Enable Quick Action on Selection')\n              }\n              className='exclude-title-bar-mousedown dropdown-bottom'\n              buttonClassName={clsx(\n                'btn btn-ghost h-8 min-h-8 w-8 p-0',\n                viewSettings?.annotationQuickAction && 'bg-base-300/50',\n              )}\n              toggleButton={\n                annotationQuickAction === 'highlight' || annotationQuickAction === null ? (\n                  <HighlighterIcon\n                    size={iconSize16}\n                    tipColor={annotationQuickAction === null ? '#8F8F8F' : highlightHexColor}\n                    tipStyle={{\n                      opacity: annotationQuickAction === null ? 0.5 : 0.8,\n                      mixBlendMode: isDarkMode ? 'screen' : 'multiply',\n                    }}\n                  />\n                ) : (\n                  <AnnotationToolQuickActionIcon size={iconSize16} />\n                )\n              }\n              onToggle={handleToggleDropdown}\n            >\n              <QuickActionMenu\n                selectedAction={viewSettings.annotationQuickAction}\n                onActionSelect={handleAnnotationQuickActionSelect}\n              />\n            </Dropdown>\n          )}\n        </div>\n\n        <div\n          role='contentinfo'\n          aria-label={_('Title') + ' - ' + bookTitle}\n          className={clsx(\n            'header-title z-15 bg-base-100 pointer-events-none hidden flex-1 items-center justify-center sm:flex',\n            !windowButtonVisible && 'absolute inset-0',\n          )}\n        >\n          <div\n            aria-hidden='true'\n            className={clsx(\n              'line-clamp-1 text-center text-xs font-semibold',\n              !windowButtonVisible && 'max-w-[50%]',\n            )}\n          >\n            {bookTitle}\n          </div>\n        </div>\n\n        <div className='bg-base-100 z-20 ml-auto flex h-full items-center space-x-4 ps-2'>\n          <SettingsToggler bookKey={bookKey} />\n          <NotebookToggler bookKey={bookKey} />\n          <Dropdown\n            label={_('View Options')}\n            className='exclude-title-bar-mousedown dropdown-bottom dropdown-end'\n            buttonClassName='btn btn-ghost h-8 min-h-8 w-8 p-0'\n            toggleButton={<PiDotsThreeVerticalBold size={iconSize16} />}\n            onToggle={handleToggleDropdown}\n          >\n            <ViewMenu bookKey={bookKey} />\n          </Dropdown>\n\n          <WindowButtons\n            className='window-buttons flex h-full items-center'\n            headerRef={headerRef}\n            showMinimize={bookKeys.length == 1 && windowButtonVisible}\n            showMaximize={bookKeys.length == 1 && windowButtonVisible}\n            onClose={() => {\n              setHoveredBookKey(null);\n              onCloseBook(bookKey);\n            }}\n          />\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default HeaderBar;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4143, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/ProgressInfo.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useEffect, useState } from 'react';\nimport { Insets } from '@/types/misc';\nimport { PageInfo, TimeInfo } from '@/types/book';\nimport { useEnv } from '@/context/EnvContext';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { formatNumber, formatProgress } from '@/utils/progress';\nimport { saveViewSettings } from '@/helpers/settings';\n\ninterface PageInfoProps {\n  bookKey: string;\n  section?: PageInfo;\n  pageinfo?: PageInfo;\n  timeinfo?: TimeInfo;\n  horizontalGap: number;\n  contentInsets: Insets;\n  gridInsets: Insets;\n}\n\nconst ProgressInfoView: React.FC<PageInfoProps> = ({\n  bookKey,\n  section,\n  pageinfo,\n  timeinfo,\n  horizontalGap,\n  contentInsets,\n  gridInsets,\n}) => {\n  const _ = useTranslation();\n  const { envConfig, appService } = useEnv();\n  const { getBookData } = useBookDataStore();\n  const { getView, getViewSettings } = useReaderStore();\n  const view = getView(bookKey);\n  const bookData = getBookData(bookKey);\n  const viewSettings = getViewSettings(bookKey)!;\n\n  const showDoubleBorder = viewSettings.vertical && viewSettings.doubleBorder;\n  const isScrolled = viewSettings.scrolled;\n  const isVertical = viewSettings.vertical;\n  const isEink = viewSettings.isEink;\n  const { progressStyle: readingProgressStyle } = viewSettings;\n\n  const template =\n    readingProgressStyle === 'fraction'\n      ? isVertical\n        ? '{current} · {total}'\n        : '{current} / {total}'\n      : '{percent}%';\n\n  const lang = localStorage?.getItem('i18nextLng') || '';\n  const localize = isVertical && lang.toLowerCase().startsWith('zh');\n  const progress = bookData?.isFixedLayout ? section : pageinfo;\n  const progressInfo = formatProgress(progress?.current, progress?.total, template, localize, lang);\n\n  const timeLeft = timeinfo\n    ? _('{{time}} min left in chapter', {\n        time: formatNumber(Math.round(timeinfo.section), localize, lang),\n      })\n    : '';\n  const { page = 0, pages = 0 } = view?.renderer || {};\n  const pageLeft =\n    pages - 1 > page\n      ? localize\n        ? _('{{number}} pages left in chapter', {\n            number: formatNumber(pages - page - 1, localize, lang),\n          })\n        : _('{{count}} pages left in chapter', {\n            count: pages - page - 1,\n          })\n      : '';\n\n  const [progressInfoMode, setProgressInfoMode] = useState(viewSettings.progressInfoMode);\n\n  const cycleProgressInfoModes = () => {\n    if (!viewSettings.tapToToggleFooter) return;\n\n    const hasRemainingInfo = viewSettings.showRemainingTime || viewSettings.showRemainingPages;\n    const hasProgressInfo = viewSettings.showProgressInfo;\n    const modeSequence: (typeof progressInfoMode)[] = ['all', 'remaining', 'progress', 'none'];\n    const currentIndex = modeSequence.indexOf(progressInfoMode);\n    for (let i = 1; i <= modeSequence.length; i++) {\n      const nextIndex = (currentIndex + i) % modeSequence.length;\n      const nextMode = modeSequence[nextIndex]!;\n\n      const currentRenders = {\n        remaining:\n          progressInfoMode === 'all' || progressInfoMode === 'remaining' ? hasRemainingInfo : false,\n        progress:\n          progressInfoMode === 'all' || progressInfoMode === 'progress' ? hasProgressInfo : false,\n      };\n\n      const nextRenders = {\n        remaining: nextMode === 'all' || nextMode === 'remaining' ? hasRemainingInfo : false,\n        progress: nextMode === 'all' || nextMode === 'progress' ? hasProgressInfo : false,\n      };\n\n      const isDifferent =\n        currentRenders.remaining !== nextRenders.remaining ||\n        currentRenders.progress !== nextRenders.progress;\n\n      if (isDifferent) {\n        setProgressInfoMode(nextMode);\n        return;\n      }\n    }\n\n    const nextIndex = (currentIndex + 1) % modeSequence.length;\n    setProgressInfoMode(modeSequence[nextIndex]!);\n  };\n\n  useEffect(() => {\n    saveViewSettings(envConfig, bookKey, 'progressInfoMode', progressInfoMode);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [progressInfoMode]);\n\n  const isMobile = appService?.isMobile || window.innerWidth < 640;\n\n  return (\n    <div\n      role='presentation'\n      className={clsx(\n        'progressinfo absolute bottom-0 flex items-center justify-between font-sans',\n        isEink ? 'text-sm font-normal' : 'text-neutral-content text-xs font-extralight',\n        isVertical ? 'writing-vertical-rl' : 'w-full',\n        isScrolled && !isVertical && 'bg-base-100',\n        isMobile ? 'pointer-events-auto' : 'pointer-events-none',\n      )}\n      onClick={() => cycleProgressInfoModes()}\n      aria-label={[\n        progress\n          ? _('On {{current}} of {{total}} page', {\n              current: progress.current + 1,\n              total: progress.total,\n            })\n          : '',\n        timeLeft,\n        pageLeft,\n      ]\n        .filter(Boolean)\n        .join(', ')}\n      style={\n        isVertical\n          ? {\n              bottom: `${(contentInsets.bottom - gridInsets.bottom) * 1.5}px`,\n              left: showDoubleBorder\n                ? `calc(${contentInsets.left}px)`\n                : `calc(${Math.max(0, contentInsets.left - 32)}px)`,\n              width: showDoubleBorder ? '32px' : `${contentInsets.left}px`,\n              height: `calc(100% - ${((contentInsets.top + contentInsets.bottom) / 2) * 3}px)`,\n            }\n          : {\n              paddingInlineStart: `calc(${horizontalGap / 2}% + ${contentInsets.left / 2}px)`,\n              paddingInlineEnd: `calc(${horizontalGap / 2}% + ${contentInsets.right / 2}px)`,\n              paddingBottom: appService?.hasSafeAreaInset ? `${gridInsets.bottom * 0.33}px` : 0,\n            }\n      }\n    >\n      <div\n        aria-hidden='true'\n        className={clsx(\n          'flex items-center justify-between',\n          isVertical ? 'h-full' : 'h-[52px] w-full',\n        )}\n      >\n        {(progressInfoMode === 'all' || progressInfoMode === 'remaining') && (\n          <>\n            {viewSettings.showRemainingTime ? (\n              <span className='text-start'>{timeLeft}</span>\n            ) : viewSettings.showRemainingPages ? (\n              <span className='text-start'>{pageLeft}</span>\n            ) : null}\n          </>\n        )}\n\n        {(progressInfoMode === 'all' || progressInfoMode === 'progress') && (\n          <>\n            {viewSettings.showProgressInfo && (\n              <span className={clsx('text-end', isVertical ? 'mt-auto' : 'ms-auto')}>\n                {progressInfo}\n              </span>\n            )}\n          </>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default ProgressInfoView;\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;AAXA;;;;;;;;;;AAuBA,MAAM,mBAA4C,CAAC,EACjD,OAAO,EACP,OAAO,EACP,QAAQ,EACR,QAAQ,EACR,aAAa,EACb,aAAa,EACb,UAAU,EACX;IACC,MAAM,IAAI,IAAA,mKAAc;IACxB,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IACxC,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,oKAAgB;IACxC,MAAM,EAAE,OAAO,EAAE,eAAe,EAAE,GAAG,IAAA,gKAAc;IACnD,MAAM,OAAO,QAAQ;IACrB,MAAM,WAAW,YAAY;IAC7B,MAAM,eAAe,gBAAgB;IAErC,MAAM,mBAAmB,aAAa,QAAQ,IAAI,aAAa,YAAY;IAC3E,MAAM,aAAa,aAAa,QAAQ;IACxC,MAAM,aAAa,aAAa,QAAQ;IACxC,MAAM,SAAS,aAAa,MAAM;IAClC,MAAM,EAAE,eAAe,oBAAoB,EAAE,GAAG;IAEhD,MAAM,WACJ,yBAAyB,aACrB,aACE,wBACA,wBACF;IAEN,MAAM,OAAO,cAAc,QAAQ,iBAAiB;IACpD,MAAM,WAAW,cAAc,KAAK,WAAW,GAAG,UAAU,CAAC;IAC7D,MAAM,WAAW,UAAU,gBAAgB,UAAU;IACrD,MAAM,eAAe,IAAA,6JAAc,EAAC,UAAU,SAAS,UAAU,OAAO,UAAU,UAAU;IAE5F,MAAM,WAAW,WACb,EAAE,gCAAgC;QAChC,MAAM,IAAA,2JAAY,EAAC,KAAK,KAAK,CAAC,SAAS,OAAO,GAAG,UAAU;IAC7D,KACA;IACJ,MAAM,EAAE,OAAO,CAAC,EAAE,QAAQ,CAAC,EAAE,GAAG,MAAM,YAAY,CAAC;IACnD,MAAM,WACJ,QAAQ,IAAI,OACR,WACE,EAAE,oCAAoC;QACpC,QAAQ,IAAA,2JAAY,EAAC,QAAQ,OAAO,GAAG,UAAU;IACnD,KACA,EAAE,mCAAmC;QACnC,OAAO,QAAQ,OAAO;IACxB,KACF;IAEN,MAAM,CAAC,kBAAkB,oBAAoB,GAAG,IAAA,+GAAQ,EAAC,aAAa,gBAAgB;IAEtF,MAAM,yBAAyB;QAC7B,IAAI,CAAC,aAAa,iBAAiB,EAAE;QAErC,MAAM,mBAAmB,aAAa,iBAAiB,IAAI,aAAa,kBAAkB;QAC1F,MAAM,kBAAkB,aAAa,gBAAgB;QACrD,MAAM,eAA4C;YAAC;YAAO;YAAa;YAAY;SAAO;QAC1F,MAAM,eAAe,aAAa,OAAO,CAAC;QAC1C,IAAK,IAAI,IAAI,GAAG,KAAK,aAAa,MAAM,EAAE,IAAK;YAC7C,MAAM,YAAY,CAAC,eAAe,CAAC,IAAI,aAAa,MAAM;YAC1D,MAAM,WAAW,YAAY,CAAC,UAAU;YAExC,MAAM,iBAAiB;gBACrB,WACE,qBAAqB,SAAS,qBAAqB,cAAc,mBAAmB;gBACtF,UACE,qBAAqB,SAAS,qBAAqB,aAAa,kBAAkB;YACtF;YAEA,MAAM,cAAc;gBAClB,WAAW,aAAa,SAAS,aAAa,cAAc,mBAAmB;gBAC/E,UAAU,aAAa,SAAS,aAAa,aAAa,kBAAkB;YAC9E;YAEA,MAAM,cACJ,eAAe,SAAS,KAAK,YAAY,SAAS,IAClD,eAAe,QAAQ,KAAK,YAAY,QAAQ;YAElD,IAAI,aAAa;gBACf,oBAAoB;gBACpB;YACF;QACF;QAEA,MAAM,YAAY,CAAC,eAAe,CAAC,IAAI,aAAa,MAAM;QAC1D,oBAAoB,YAAY,CAAC,UAAU;IAC7C;IAEA,IAAA,gHAAS,EAAC;QACR,IAAA,iKAAgB,EAAC,WAAW,SAAS,oBAAoB;IACzD,uDAAuD;IACzD,GAAG;QAAC;KAAiB;IAErB,MAAM,WAAW,YAAY,YAAY,OAAO,UAAU,GAAG;IAE7D,qBACE,qKAAC;QACC,MAAK;QACL,WAAW,IAAA,mHAAI,EACb,8EACA,SAAS,wBAAwB,gDACjC,aAAa,wBAAwB,UACrC,cAAc,CAAC,cAAc,eAC7B,WAAW,wBAAwB;QAErC,SAAS,IAAM;QACf,cAAY;YACV,WACI,EAAE,oCAAoC;gBACpC,SAAS,SAAS,OAAO,GAAG;gBAC5B,OAAO,SAAS,KAAK;YACvB,KACA;YACJ;YACA;SACD,CACE,MAAM,CAAC,SACP,IAAI,CAAC;QACR,OACE,aACI;YACE,QAAQ,GAAG,CAAC,cAAc,MAAM,GAAG,WAAW,MAAM,IAAI,IAAI,EAAE,CAAC;YAC/D,MAAM,mBACF,CAAC,KAAK,EAAE,cAAc,IAAI,CAAC,GAAG,CAAC,GAC/B,CAAC,KAAK,EAAE,KAAK,GAAG,CAAC,GAAG,cAAc,IAAI,GAAG,IAAI,GAAG,CAAC;YACrD,OAAO,mBAAmB,SAAS,GAAG,cAAc,IAAI,CAAC,EAAE,CAAC;YAC5D,QAAQ,CAAC,YAAY,EAAE,AAAC,CAAC,cAAc,GAAG,GAAG,cAAc,MAAM,IAAI,IAAK,EAAE,GAAG,CAAC;QAClF,IACA;YACE,oBAAoB,CAAC,KAAK,EAAE,gBAAgB,EAAE,IAAI,EAAE,cAAc,IAAI,GAAG,EAAE,GAAG,CAAC;YAC/E,kBAAkB,CAAC,KAAK,EAAE,gBAAgB,EAAE,IAAI,EAAE,cAAc,KAAK,GAAG,EAAE,GAAG,CAAC;YAC9E,eAAe,YAAY,mBAAmB,GAAG,WAAW,MAAM,GAAG,KAAK,EAAE,CAAC,GAAG;QAClF;kBAGN,cAAA,qKAAC;YACC,eAAY;YACZ,WAAW,IAAA,mHAAI,EACb,qCACA,aAAa,WAAW;;gBAGzB,CAAC,qBAAqB,SAAS,qBAAqB,WAAW,mBAC9D;8BACG,aAAa,iBAAiB,iBAC7B,qKAAC;wBAAK,WAAU;kCAAc;;;;;mEAC5B,aAAa,kBAAkB,iBACjC,qKAAC;wBAAK,WAAU;kCAAc;;;;;mEAC5B;;gBAIP,CAAC,qBAAqB,SAAS,qBAAqB,UAAU,mBAC7D;8BACG,aAAa,gBAAgB,kBAC5B,qKAAC;wBAAK,WAAW,IAAA,mHAAI,EAAC,YAAY,aAAa,YAAY;kCACxD;;;;;;;;;;;;;;;;;;AAQjB;uCAEe"}},
    {"offset": {"line": 4313, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/Ribbon.tsx"],"sourcesContent":["import clsx from 'clsx';\nimport React from 'react';\nimport { useThemeStore } from '@/store/themeStore';\n\ninterface RibbonProps {\n  width: string;\n}\n\nconst Ribbon: React.FC<RibbonProps> = ({}) => {\n  const { safeAreaInsets } = useThemeStore();\n\n  return (\n    <div\n      className={clsx('ribbon absolute inset-0 z-10 flex w-8 justify-center sm:w-6')}\n      style={{\n        height: `${(safeAreaInsets?.top || 0) + 44}px`,\n      }}\n    >\n      <svg\n        width='100%'\n        height='100%'\n        preserveAspectRatio='none'\n        viewBox='0 0 100 100'\n        xmlns='http://www.w3.org/2000/svg'\n        shapeRendering='geometricPrecision'\n        imageRendering='optimizeQuality'\n      >\n        <polygon fill='#F44336' points='100 100, 50 78, 0 100, 0 0, 100 0' />\n      </svg>\n    </div>\n  );\n};\n\nexport default Ribbon;\n"],"names":[],"mappings":";;;;;AAAA;AAEA;;;;;;;;;AAMA,MAAM,SAAgC,CAAC,EAAE;IACvC,MAAM,EAAE,cAAc,EAAE,GAAG,IAAA,8JAAa;IAExC,qBACE,qKAAC;QACC,WAAW,IAAA,mHAAI,EAAC;QAChB,OAAO;YACL,QAAQ,GAAG,CAAC,gBAAgB,OAAO,CAAC,IAAI,GAAG,EAAE,CAAC;QAChD;kBAEA,cAAA,qKAAC;YACC,OAAM;YACN,QAAO;YACP,qBAAoB;YACpB,SAAQ;YACR,OAAM;YACN,gBAAe;YACf,gBAAe;sBAEf,cAAA,qKAAC;gBAAQ,MAAK;gBAAU,QAAO;;;;;;;;;;;;;;;;AAIvC;uCAEe"}},
    {"offset": {"line": 4370, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/FootnotePopup.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef, useState } from 'react';\n\nimport { BookDoc } from '@/libs/document';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useFoliateEvents } from '../hooks/useFoliateEvents';\nimport { useCustomFontStore } from '@/store/customFontStore';\nimport { getFootnoteStyles, getStyles, getThemeCode } from '@/utils/style';\nimport { getPopupPosition, getPosition, Position } from '@/utils/sel';\nimport { FootnoteHandler } from 'foliate-js/footnotes.js';\nimport { mountAdditionalFonts, mountCustomFont } from '@/styles/fonts';\nimport { eventDispatcher } from '@/utils/event';\nimport { FoliateView } from '@/types/view';\nimport { isCJKLang } from '@/utils/lang';\nimport { Overlay } from '@/components/Overlay';\nimport Popup from '@/components/Popup';\n\ninterface FootnotePopupProps {\n  bookKey: string;\n  bookDoc: BookDoc;\n}\n\nconst popupWidth = 360;\nconst popupHeight = 88;\nconst popupPadding = 10;\n\nconst FootnotePopup: React.FC<FootnotePopupProps> = ({ bookKey, bookDoc }) => {\n  const footnoteRef = useRef<HTMLDivElement>(null);\n  const footnoteViewRef = useRef<FoliateView | null>(null);\n  const [trianglePosition, setTrianglePosition] = useState<Position | null>();\n  const [popupPosition, setPopupPosition] = useState<Position | null>();\n  const [showPopup, setShowPopup] = useState(false);\n\n  const { getBookData } = useBookDataStore();\n  const { getView, getViewSettings } = useReaderStore();\n  const { getLoadedFonts } = useCustomFontStore();\n  const view = getView(bookKey);\n  const viewSettings = getViewSettings(bookKey)!;\n  const footnoteHandler = new FootnoteHandler();\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  const [gridRect, setGridRect] = useState<DOMRect | null>(null);\n  const [responsiveWidth, setResponsiveWidth] = useState(popupWidth);\n  const [responsiveHeight, setResponsiveHeight] = useState(popupHeight);\n\n  const getResponsivePopupSize = (size: number, isVertical: boolean) => {\n    const maxSize = isVertical ? window.innerWidth / 2 : window.innerHeight / 2;\n    return Math.min(size, maxSize - popupPadding - 12);\n  };\n\n  const clipPopupWith = (size: number) => {\n    return Math.min(size, window.innerWidth - popupPadding - 12);\n  };\n\n  const clipPopupHeight = (size: number) => {\n    return Math.min(size, window.innerHeight - popupPadding - 12);\n  };\n\n  useEffect(() => {\n    const handleBeforeRender = (e: Event) => {\n      const detail = (e as CustomEvent).detail;\n      const { view } = detail;\n      view.addEventListener('link', (e: Event) => {\n        e.preventDefault();\n        const { detail: popupLinkDetail } = e as CustomEvent;\n        popupLinkDetail['follow'] = true;\n        footnoteHandler.handle(bookDoc, e)?.catch((err) => {\n          console.warn(err);\n          getView(bookKey)?.goTo(popupLinkDetail.href);\n        });\n      });\n      view.addEventListener('load', (e: CustomEvent) => {\n        const { doc } = e.detail;\n        const bookData = getBookData(bookKey)!;\n        mountAdditionalFonts(doc, isCJKLang(bookData.book?.primaryLanguage));\n        getLoadedFonts().forEach((font) => {\n          mountCustomFont(doc, font);\n        });\n      });\n      footnoteViewRef.current = view;\n      footnoteRef.current?.replaceChildren(view);\n      const { renderer } = view;\n      renderer.setAttribute('flow', 'scrolled');\n      renderer.setAttribute('margin-top', '0px');\n      renderer.setAttribute('margin-right', '0px');\n      renderer.setAttribute('margin-bottom', '0px');\n      renderer.setAttribute('margin-left', '0px');\n      renderer.setAttribute('gap', '0%');\n      const viewSettings = getViewSettings(bookKey)!;\n      const themeCode = getThemeCode();\n      const popupTheme = { ...themeCode };\n      const popupContainer = document.getElementById('popup-container');\n      if (popupContainer) {\n        const backgroundColor = getComputedStyle(popupContainer).backgroundColor;\n        popupTheme.bg = backgroundColor;\n      }\n      const mainStyles = getStyles(viewSettings, popupTheme);\n      const footnoteStyles = getFootnoteStyles();\n      renderer.setStyles?.(`${mainStyles}\\n${footnoteStyles}`);\n    };\n\n    const handleRender = (e: Event) => {\n      const detail = (e as CustomEvent).detail;\n      // console.log('render footnote', detail);\n      const { view } = detail;\n      view.addEventListener('relocate', () => {\n        const { renderer } = view as FoliateView;\n        const viewSettings = getViewSettings(bookKey)!;\n        if (viewSettings.vertical) {\n          setResponsiveWidth(clipPopupWith(getResponsivePopupSize(renderer.viewSize, true)));\n        } else {\n          setResponsiveHeight(clipPopupHeight(getResponsivePopupSize(renderer.viewSize, false)));\n        }\n        setShowPopup(true);\n      });\n    };\n\n    footnoteHandler.addEventListener('before-render', handleBeforeRender);\n    footnoteHandler.addEventListener('render', handleRender);\n    return () => {\n      footnoteHandler.removeEventListener('before-render', handleBeforeRender);\n      footnoteHandler.removeEventListener('render', handleRender);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [view]);\n\n  useEffect(() => {\n    if (showPopup) {\n      containerRef.current?.focus();\n    }\n  }, [showPopup]);\n\n  useEffect(() => {\n    if (viewSettings.vertical) {\n      setResponsiveWidth(clipPopupWith(popupHeight));\n      setResponsiveHeight(clipPopupHeight(Math.max(popupWidth, window.innerHeight / 4)));\n    } else {\n      setResponsiveWidth(clipPopupWith(Math.max(popupWidth, window.innerWidth / 4)));\n      setResponsiveHeight(clipPopupHeight(popupHeight));\n    }\n  }, [viewSettings]);\n\n  useEffect(() => {\n    if (trianglePosition && gridRect) {\n      const popupPos = getPopupPosition(\n        trianglePosition,\n        gridRect,\n        responsiveWidth,\n        responsiveHeight,\n        popupPadding,\n      );\n      setPopupPosition(popupPos);\n    }\n  }, [trianglePosition, gridRect, responsiveWidth, responsiveHeight]);\n\n  const docLinkHandler = async (event: Event) => {\n    const detail = (event as CustomEvent).detail;\n    // console.log('doc link click', detail);\n    const gridFrame = document.querySelector(`#gridcell-${bookKey}`);\n    if (!gridFrame) return;\n    const rect = gridFrame.getBoundingClientRect();\n    const viewSettings = getViewSettings(bookKey)!;\n    const triangPos = getPosition(detail.a, rect, popupPadding, viewSettings.vertical);\n    setGridRect(rect);\n    setTrianglePosition(triangPos);\n\n    const { a: anchor } = detail as { a: HTMLAnchorElement };\n    const footnoteClasses = ['duokan-footnote', 'footnote-link', 'footnote'];\n    if (footnoteClasses.some((cls) => anchor.classList.contains(cls))) {\n      detail['follow'] = true;\n    }\n    footnoteHandler.handle(bookDoc, event)?.catch((err) => {\n      console.warn(err);\n      const detail = (event as CustomEvent).detail;\n      view?.goTo(detail.href);\n    });\n  };\n\n  const closePopup = () => {\n    const view = footnoteRef.current?.querySelector('foliate-view') as FoliateView;\n    view?.close();\n    view?.remove();\n  };\n\n  const handleDismissPopup = () => {\n    closePopup();\n    setGridRect(null);\n    setPopupPosition(null);\n    setTrianglePosition(null);\n    setShowPopup(false);\n  };\n\n  // Handle custom footnote popup event from iframe event\n  const handleFootnotePopupEvent = (event: CustomEvent) => {\n    const { element, footnote } = event.detail;\n    const gridFrame = document.querySelector(`#gridcell-${bookKey}`);\n    if (!gridFrame) return;\n    const rect = gridFrame.getBoundingClientRect();\n    const viewSettings = getViewSettings(bookKey)!;\n    const triangPos = getPosition(element, rect, popupPadding, viewSettings.vertical);\n    if (footnoteRef.current) {\n      const elem = document.createElement('p');\n      elem.textContent = footnote;\n      elem.setAttribute('style', `padding: 1em; hanging-punctuation: allow-end last;`);\n      elem.style.visibility = 'hidden';\n      if (viewSettings.vertical) {\n        elem.style.height = `${responsiveHeight}px`;\n      } else {\n        elem.style.width = `${responsiveWidth}px`;\n      }\n      document.body.appendChild(elem);\n      const popupSize = elem.getBoundingClientRect();\n      if (viewSettings.vertical) {\n        setResponsiveWidth(getResponsivePopupSize(popupSize.width, true));\n      } else {\n        setResponsiveHeight(getResponsivePopupSize(popupSize.height, false));\n      }\n      document.body.removeChild(elem);\n\n      elem.style.visibility = 'visible';\n      footnoteRef.current.replaceChildren(elem);\n      setGridRect(rect);\n      setTrianglePosition(triangPos);\n      setShowPopup(true);\n    }\n  };\n\n  useFoliateEvents(view, {\n    onLinkClick: docLinkHandler,\n  });\n\n  useEffect(() => {\n    window.addEventListener('resize', handleDismissPopup);\n    eventDispatcher.on('footnote-popup', handleFootnotePopupEvent);\n    return () => {\n      window.removeEventListener('resize', handleDismissPopup);\n      eventDispatcher.off('footnote-popup', handleFootnotePopupEvent);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  useEffect(() => {\n    if (footnoteViewRef.current) {\n      footnoteRef.current?.replaceChildren(footnoteViewRef.current);\n    }\n  }, [footnoteRef]);\n\n  return (\n    <div ref={containerRef} role='toolbar' tabIndex={-1}>\n      {showPopup && <Overlay onDismiss={handleDismissPopup} />}\n      <Popup\n        isOpen={showPopup}\n        width={responsiveWidth}\n        height={responsiveHeight}\n        position={showPopup ? popupPosition! : undefined}\n        trianglePosition={showPopup ? trianglePosition! : undefined}\n        className='select-text overflow-y-auto'\n        onDismiss={handleDismissPopup}\n      >\n        <div\n          className='footnote-content'\n          ref={footnoteRef}\n          style={{\n            width: `${responsiveWidth}px`,\n            height: `${responsiveHeight}px`,\n          }}\n        ></div>\n      </Popup>\n    </div>\n  );\n};\n\nexport default FootnotePopup;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4682, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/HintInfo.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useEffect, useRef } from 'react';\nimport { Insets } from '@/types/misc';\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { eventDispatcher } from '@/utils/event';\n\ninterface SectionInfoProps {\n  bookKey: string;\n  showDoubleBorder: boolean;\n  isScrolled: boolean;\n  isVertical: boolean;\n  isEink: boolean;\n  horizontalGap: number;\n  contentInsets: Insets;\n  gridInsets: Insets;\n}\n\nconst HintInfo: React.FC<SectionInfoProps> = ({\n  bookKey,\n  showDoubleBorder,\n  isScrolled,\n  isVertical,\n  isEink,\n  horizontalGap,\n  contentInsets,\n  gridInsets,\n}) => {\n  const { appService } = useEnv();\n  const { systemUIVisible, statusBarHeight } = useThemeStore();\n  const topInset = Math.max(\n    gridInsets.top,\n    appService?.isAndroidApp && systemUIVisible ? statusBarHeight / 2 : 0,\n  );\n\n  const [hintMessage, setHintMessage] = React.useState<string | null>(null);\n  const hintTimeout = useRef(2000);\n  const dismissTimeout = useRef<ReturnType<typeof setTimeout> | null>(null);\n\n  const handleShowHint = (event: CustomEvent) => {\n    const { message, bookKey: hintBookKey, timeout = 2000 } = event.detail;\n    if (hintBookKey !== bookKey) return;\n    setHintMessage(message);\n    hintTimeout.current = timeout;\n  };\n\n  useEffect(() => {\n    eventDispatcher.on('hint', handleShowHint);\n    return () => {\n      eventDispatcher.off('hint', handleShowHint);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  useEffect(() => {\n    if (dismissTimeout.current) clearTimeout(dismissTimeout.current);\n    dismissTimeout.current = setTimeout(() => setHintMessage(''), hintTimeout.current);\n    return () => {\n      if (dismissTimeout.current) clearTimeout(dismissTimeout.current);\n    };\n  }, [hintMessage]);\n\n  if (!hintMessage) return null;\n\n  return (\n    <>\n      <div\n        className={clsx('absolute left-0 right-0 top-0 z-10', hintMessage ? '' : 'bg-transparent')}\n        style={{\n          height: `${topInset}px`,\n        }}\n      />\n      <div\n        className={clsx(\n          'hintinfo absolute flex items-center justify-end overflow-hidden ps-2',\n          hintMessage ? '' : 'bg-transparent',\n          isVertical ? 'writing-vertical-rl' : 'top-0 h-[44px]',\n          isScrolled\n            ? isVertical\n              ? 'h-full'\n              : 'w-full'\n            : isVertical\n              ? 'max-h-[50%]'\n              : 'max-w-[50%]',\n        )}\n        style={\n          isVertical\n            ? {\n                bottom: `${(contentInsets.bottom - gridInsets.bottom) * 1.5}px`,\n                right: showDoubleBorder\n                  ? `calc(${contentInsets.right}px)`\n                  : `calc(${Math.max(0, contentInsets.right - 32)}px)`,\n                width: showDoubleBorder ? '30px' : `${contentInsets.right}px`,\n              }\n            : {\n                top: `${topInset}px`,\n                insetInlineEnd: `calc(${horizontalGap / 2}% + ${contentInsets.right / 2}px)`,\n              }\n        }\n      >\n        <h2\n          className={clsx(\n            'text-center font-sans',\n            isEink ? 'text-sm font-normal' : 'text-neutral-content text-xs font-light',\n          )}\n        >\n          {hintMessage || ''}\n        </h2>\n      </div>\n    </>\n  );\n};\n\nexport default HintInfo;\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAEA;AACA;AACA;;;;;;AAPA;;;;;;;AAoBA,MAAM,WAAuC,CAAC,EAC5C,OAAO,EACP,gBAAgB,EAChB,UAAU,EACV,UAAU,EACV,MAAM,EACN,aAAa,EACb,aAAa,EACb,UAAU,EACX;IACC,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAC7B,MAAM,EAAE,eAAe,EAAE,eAAe,EAAE,GAAG,IAAA,8JAAa;IAC1D,MAAM,WAAW,KAAK,GAAG,CACvB,WAAW,GAAG,EACd,YAAY,gBAAgB,kBAAkB,kBAAkB,IAAI;IAGtE,MAAM,CAAC,aAAa,eAAe,GAAG,8GAAK,CAAC,QAAQ,CAAgB;IACpE,MAAM,cAAc,IAAA,6GAAM,EAAC;IAC3B,MAAM,iBAAiB,IAAA,6GAAM,EAAuC;IAEpE,MAAM,iBAAiB,CAAC;QACtB,MAAM,EAAE,OAAO,EAAE,SAAS,WAAW,EAAE,UAAU,IAAI,EAAE,GAAG,MAAM,MAAM;QACtE,IAAI,gBAAgB,SAAS;QAC7B,eAAe;QACf,YAAY,OAAO,GAAG;IACxB;IAEA,IAAA,gHAAS,EAAC;QACR,2JAAe,CAAC,EAAE,CAAC,QAAQ;QAC3B,OAAO;YACL,2JAAe,CAAC,GAAG,CAAC,QAAQ;QAC9B;IACA,uDAAuD;IACzD,GAAG,EAAE;IAEL,IAAA,gHAAS,EAAC;QACR,IAAI,eAAe,OAAO,EAAE,aAAa,eAAe,OAAO;QAC/D,eAAe,OAAO,GAAG,WAAW,IAAM,eAAe,KAAK,YAAY,OAAO;QACjF,OAAO;YACL,IAAI,eAAe,OAAO,EAAE,aAAa,eAAe,OAAO;QACjE;IACF,GAAG;QAAC;KAAY;IAEhB,IAAI,CAAC,aAAa,OAAO;IAEzB,qBACE;;0BACE,qKAAC;gBACC,WAAW,IAAA,mHAAI,EAAC,sCAAsC,cAAc,KAAK;gBACzE,OAAO;oBACL,QAAQ,GAAG,SAAS,EAAE,CAAC;gBACzB;;;;;;0BAEF,qKAAC;gBACC,WAAW,IAAA,mHAAI,EACb,wEACA,cAAc,KAAK,kBACnB,aAAa,wBAAwB,kBACrC,aACI,aACE,WACA,WACF,aACE,gBACA;gBAER,OACE,aACI;oBACE,QAAQ,GAAG,CAAC,cAAc,MAAM,GAAG,WAAW,MAAM,IAAI,IAAI,EAAE,CAAC;oBAC/D,OAAO,mBACH,CAAC,KAAK,EAAE,cAAc,KAAK,CAAC,GAAG,CAAC,GAChC,CAAC,KAAK,EAAE,KAAK,GAAG,CAAC,GAAG,cAAc,KAAK,GAAG,IAAI,GAAG,CAAC;oBACtD,OAAO,mBAAmB,SAAS,GAAG,cAAc,KAAK,CAAC,EAAE,CAAC;gBAC/D,IACA;oBACE,KAAK,GAAG,SAAS,EAAE,CAAC;oBACpB,gBAAgB,CAAC,KAAK,EAAE,gBAAgB,EAAE,IAAI,EAAE,cAAc,KAAK,GAAG,EAAE,GAAG,CAAC;gBAC9E;0BAGN,cAAA,qKAAC;oBACC,WAAW,IAAA,mHAAI,EACb,yBACA,SAAS,wBAAwB;8BAGlC,eAAe;;;;;;;;;;;;;AAK1B;uCAEe"}},
    {"offset": {"line": 4778, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/DoubleBorder.tsx"],"sourcesContent":["import { Insets } from '@/types/misc';\n\ninterface DoubleBorderProps {\n  borderColor: string;\n  horizontalGap: number;\n  showHeader: boolean;\n  showFooter: boolean;\n  insets: Insets;\n}\n\nconst paddingPx = 10;\n\nconst DoubleBorder: React.FC<DoubleBorderProps> = ({\n  borderColor,\n  showHeader,\n  showFooter,\n  insets,\n}) => {\n  return (\n    <div>\n      {/* outter frame */}\n      <div\n        className={'borderframe pointer-events-none absolute'}\n        style={{\n          border: `4px solid ${borderColor}`,\n          height: `calc(100% - ${insets.top + insets.bottom}px + ${paddingPx * 2}px)`,\n          top: `calc(${insets.top}px - ${paddingPx}px)`,\n          left: `calc(${insets.left}px - ${paddingPx}px)`,\n          right: `calc(${insets.right}px - ${paddingPx}px)`,\n        }}\n      ></div>\n      {/* inner frame */}\n      <div\n        className={'borderframe pointer-events-none absolute'}\n        style={{\n          border: `1px solid ${borderColor}`,\n          height: `calc(100% - ${insets.top + insets.bottom}px)`,\n          top: `${insets.top}px`,\n          left: `calc(${insets.left + (showFooter ? 32 : 0)}px`,\n          right: `calc(${insets.right + (showHeader ? 32 : 0)}px`,\n        }}\n      />\n      {/* footer */}\n      {showFooter && (\n        <div\n          className={'borderframe pointer-events-none absolute'}\n          style={{\n            borderTop: `1px solid ${borderColor}`,\n            borderBottom: `1px solid ${borderColor}`,\n            borderLeft: `1px solid ${borderColor}`,\n            width: '32px',\n            height: `calc(100% - ${insets.top + insets.bottom}px)`,\n            top: `${insets.top}px`,\n            left: `calc(${insets.left}px)`,\n          }}\n        />\n      )}\n      {/* header */}\n      {showHeader && (\n        <div\n          className={'borderframe pointer-events-none absolute'}\n          style={{\n            borderTop: `1px solid ${borderColor}`,\n            borderBottom: `1px solid ${borderColor}`,\n            borderRight: `1px solid ${borderColor}`,\n            width: '32px',\n            height: `calc(100% - ${insets.top + insets.bottom}px)`,\n            top: `${insets.top}px`,\n            left: `calc(100% - ${insets.right}px - 32px)`,\n          }}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default DoubleBorder;\n"],"names":[],"mappings":";;;;;;AAUA,MAAM,YAAY;AAElB,MAAM,eAA4C,CAAC,EACjD,WAAW,EACX,UAAU,EACV,UAAU,EACV,MAAM,EACP;IACC,qBACE,qKAAC;;0BAEC,qKAAC;gBACC,WAAW;gBACX,OAAO;oBACL,QAAQ,CAAC,UAAU,EAAE,aAAa;oBAClC,QAAQ,CAAC,YAAY,EAAE,OAAO,GAAG,GAAG,OAAO,MAAM,CAAC,KAAK,EAAE,YAAY,EAAE,GAAG,CAAC;oBAC3E,KAAK,CAAC,KAAK,EAAE,OAAO,GAAG,CAAC,KAAK,EAAE,UAAU,GAAG,CAAC;oBAC7C,MAAM,CAAC,KAAK,EAAE,OAAO,IAAI,CAAC,KAAK,EAAE,UAAU,GAAG,CAAC;oBAC/C,OAAO,CAAC,KAAK,EAAE,OAAO,KAAK,CAAC,KAAK,EAAE,UAAU,GAAG,CAAC;gBACnD;;;;;;0BAGF,qKAAC;gBACC,WAAW;gBACX,OAAO;oBACL,QAAQ,CAAC,UAAU,EAAE,aAAa;oBAClC,QAAQ,CAAC,YAAY,EAAE,OAAO,GAAG,GAAG,OAAO,MAAM,CAAC,GAAG,CAAC;oBACtD,KAAK,GAAG,OAAO,GAAG,CAAC,EAAE,CAAC;oBACtB,MAAM,CAAC,KAAK,EAAE,OAAO,IAAI,GAAG,CAAC,aAAa,KAAK,CAAC,EAAE,EAAE,CAAC;oBACrD,OAAO,CAAC,KAAK,EAAE,OAAO,KAAK,GAAG,CAAC,aAAa,KAAK,CAAC,EAAE,EAAE,CAAC;gBACzD;;;;;;YAGD,4BACC,qKAAC;gBACC,WAAW;gBACX,OAAO;oBACL,WAAW,CAAC,UAAU,EAAE,aAAa;oBACrC,cAAc,CAAC,UAAU,EAAE,aAAa;oBACxC,YAAY,CAAC,UAAU,EAAE,aAAa;oBACtC,OAAO;oBACP,QAAQ,CAAC,YAAY,EAAE,OAAO,GAAG,GAAG,OAAO,MAAM,CAAC,GAAG,CAAC;oBACtD,KAAK,GAAG,OAAO,GAAG,CAAC,EAAE,CAAC;oBACtB,MAAM,CAAC,KAAK,EAAE,OAAO,IAAI,CAAC,GAAG,CAAC;gBAChC;;;;;;YAIH,4BACC,qKAAC;gBACC,WAAW;gBACX,OAAO;oBACL,WAAW,CAAC,UAAU,EAAE,aAAa;oBACrC,cAAc,CAAC,UAAU,EAAE,aAAa;oBACxC,aAAa,CAAC,UAAU,EAAE,aAAa;oBACvC,OAAO;oBACP,QAAQ,CAAC,YAAY,EAAE,OAAO,GAAG,GAAG,OAAO,MAAM,CAAC,GAAG,CAAC;oBACtD,KAAK,GAAG,OAAO,GAAG,CAAC,EAAE,CAAC;oBACtB,MAAM,CAAC,YAAY,EAAE,OAAO,KAAK,CAAC,UAAU,CAAC;gBAC/C;;;;;;;;;;;;AAKV;uCAEe"}},
    {"offset": {"line": 4862, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/BooksGrid.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useEffect } from 'react';\n\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { getGridTemplate, getInsetEdges } from '@/utils/grid';\nimport { getViewInsets } from '@/utils/insets';\nimport SearchResultsNav from './sidebar/SearchResultsNav';\nimport BooknotesNav from './sidebar/BooknotesNav';\nimport FoliateViewer from './FoliateViewer';\nimport SectionInfo from './SectionInfo';\nimport HeaderBar from './HeaderBar';\nimport FooterBar from './footerbar/FooterBar';\nimport ProgressInfoView from './ProgressInfo';\nimport Ribbon from './Ribbon';\nimport Annotator from './annotator/Annotator';\nimport FootnotePopup from './FootnotePopup';\nimport HintInfo from './HintInfo';\nimport DoubleBorder from './DoubleBorder';\n\ninterface BooksGridProps {\n  bookKeys: string[];\n  onCloseBook: (bookKey: string) => void;\n}\n\nconst BooksGrid: React.FC<BooksGridProps> = ({ bookKeys, onCloseBook }) => {\n  const _ = useTranslation();\n  const { appService } = useEnv();\n  const { getConfig, getBookData } = useBookDataStore();\n  const { getProgress, getViewState, getViewSettings } = useReaderStore();\n  const { setGridInsets, hoveredBookKey } = useReaderStore();\n  const { sideBarBookKey } = useSidebarStore();\n\n  const { safeAreaInsets: screenInsets } = useThemeStore();\n  const aspectRatio = window.innerWidth / window.innerHeight;\n  const gridTemplate = getGridTemplate(bookKeys.length, aspectRatio);\n\n  useEffect(() => {\n    if (!sideBarBookKey) return;\n    const bookData = getBookData(sideBarBookKey);\n    if (!bookData || !bookData.book) return;\n    document.title = bookData.book.title;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [sideBarBookKey]);\n\n  const calcGridInsets = (index: number, count: number) => {\n    if (!screenInsets) return { top: 0, right: 0, bottom: 0, left: 0 };\n    const { top, right, bottom, left } = getInsetEdges(index, count, aspectRatio);\n    return {\n      top: top ? screenInsets.top : 0,\n      right: right ? screenInsets.right : 0,\n      bottom: bottom ? screenInsets.bottom : 0,\n      left: left ? screenInsets.left : 0,\n    };\n  };\n\n  useEffect(() => {\n    if (!screenInsets) return;\n    bookKeys.forEach((bookKey, index) => {\n      const gridInsets = calcGridInsets(index, bookKeys.length);\n      setGridInsets(bookKey, gridInsets);\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKeys, screenInsets]);\n\n  if (!screenInsets) return null;\n\n  return (\n    <div\n      className={clsx('books-grid bg-base-100 relative grid h-full flex-grow')}\n      style={{\n        gridTemplateColumns: gridTemplate.columns,\n        gridTemplateRows: gridTemplate.rows,\n      }}\n      role='main'\n      aria-label={_('Books Content')}\n    >\n      {bookKeys.map((bookKey, index) => {\n        const bookData = getBookData(bookKey);\n        const config = getConfig(bookKey);\n        const progress = getProgress(bookKey);\n        const viewSettings = getViewSettings(bookKey);\n        const viewState = getViewState(bookKey);\n        const gridInsets = calcGridInsets(index, bookKeys.length);\n        const { book, bookDoc } = bookData || {};\n        if (!book || !config || !bookDoc || !viewSettings || !viewState) return null;\n\n        const { section, pageinfo, timeinfo, sectionLabel } = progress || {};\n        const isBookmarked = viewState.ribbonVisible;\n        const viewerKey = viewState.viewerKey;\n        const horizontalGapPercent = viewSettings.gapPercent;\n        const viewInsets = getViewInsets(viewSettings);\n        const contentInsets = {\n          top: gridInsets.top + viewInsets.top,\n          right: gridInsets.right + viewInsets.right,\n          bottom: gridInsets.bottom + viewInsets.bottom,\n          left: gridInsets.left + viewInsets.left,\n        };\n        const scrolled = viewSettings.scrolled;\n        const showBarsOnScroll = viewSettings.showBarsOnScroll;\n        const showHeader = viewSettings.showHeader && (scrolled ? showBarsOnScroll : true);\n        const showFooter = viewSettings.showFooter && (scrolled ? showBarsOnScroll : true);\n\n        return (\n          <div\n            id={`gridcell-${bookKey}`}\n            key={bookKey}\n            className={clsx(\n              'relative h-full w-full overflow-hidden',\n              appService?.hasRoundedWindow && 'rounded-window',\n            )}\n          >\n            {isBookmarked && !hoveredBookKey && <Ribbon width={`${horizontalGapPercent}%`} />}\n            <HeaderBar\n              bookKey={bookKey}\n              bookTitle={book.title}\n              isTopLeft={index === 0}\n              isHoveredAnim={bookKeys.length > 2}\n              onCloseBook={onCloseBook}\n              gridInsets={gridInsets}\n            />\n            <FoliateViewer\n              key={viewerKey}\n              bookKey={bookKey}\n              bookDoc={bookDoc}\n              config={config}\n              gridInsets={gridInsets}\n              contentInsets={contentInsets}\n            />\n            {viewSettings.vertical && viewSettings.scrolled && (\n              <>\n                {(showFooter || viewSettings.doubleBorder) && (\n                  <div\n                    className='bg-base-100 absolute left-0 top-0 h-full'\n                    style={{\n                      width: `calc(${contentInsets.left + (showFooter ? 32 : 0)}px)`,\n                      height: `calc(100%)`,\n                    }}\n                  />\n                )}\n                {(showHeader || viewSettings.doubleBorder) && (\n                  <div\n                    className='bg-base-100 absolute right-0 top-0 h-full'\n                    style={{\n                      width: `calc(${contentInsets.right + (showHeader ? 32 : 0)}px)`,\n                      height: `calc(100%)`,\n                    }}\n                  />\n                )}\n              </>\n            )}\n            {viewSettings.vertical && viewSettings.doubleBorder && (\n              <DoubleBorder\n                showHeader={showHeader}\n                showFooter={showFooter}\n                borderColor={viewSettings.borderColor}\n                horizontalGap={horizontalGapPercent}\n                insets={viewInsets}\n              />\n            )}\n            {showHeader && (\n              <SectionInfo\n                bookKey={bookKey}\n                section={sectionLabel}\n                showDoubleBorder={viewSettings.vertical && viewSettings.doubleBorder}\n                isScrolled={viewSettings.scrolled}\n                isVertical={viewSettings.vertical}\n                isEink={viewSettings.isEink}\n                horizontalGap={horizontalGapPercent}\n                contentInsets={contentInsets}\n                gridInsets={gridInsets}\n              />\n            )}\n            <HintInfo\n              bookKey={bookKey}\n              showDoubleBorder={viewSettings.vertical && viewSettings.doubleBorder}\n              isScrolled={viewSettings.scrolled}\n              isVertical={viewSettings.vertical}\n              isEink={viewSettings.isEink}\n              horizontalGap={horizontalGapPercent}\n              contentInsets={contentInsets}\n              gridInsets={gridInsets}\n            />\n            {showFooter && (\n              <ProgressInfoView\n                bookKey={bookKey}\n                section={section}\n                pageinfo={pageinfo}\n                timeinfo={timeinfo}\n                horizontalGap={horizontalGapPercent}\n                contentInsets={contentInsets}\n                gridInsets={gridInsets}\n              />\n            )}\n            <Annotator bookKey={bookKey} />\n            <SearchResultsNav bookKey={bookKey} gridInsets={gridInsets} />\n            <BooknotesNav bookKey={bookKey} gridInsets={gridInsets} toc={bookDoc.toc || []} />\n            <FootnotePopup bookKey={bookKey} bookDoc={bookDoc} />\n            <FooterBar\n              bookKey={bookKey}\n              bookFormat={book.format}\n              section={section}\n              pageinfo={pageinfo}\n              isHoveredAnim={false}\n              gridInsets={gridInsets}\n            />\n          </div>\n        );\n      })}\n    </div>\n  );\n};\n\nexport default BooksGrid;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5189, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/ReaderContent.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef, useState } from 'react';\nimport { useRouter, useSearchParams } from 'next/navigation';\n\nimport { Book } from '@/types/book';\nimport { useEnv } from '@/context/EnvContext';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { SystemSettings } from '@/types/settings';\nimport { parseOpenWithFiles } from '@/helpers/openWith';\nimport { getCurrentWindow } from '@tauri-apps/api/window';\nimport { UnlistenFn } from '@tauri-apps/api/event';\nimport { tauriHandleClose, tauriHandleOnCloseWindow } from '@/utils/window';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { uniqueId } from '@/utils/misc';\nimport { throttle } from '@/utils/throttle';\nimport { eventDispatcher } from '@/utils/event';\nimport { navigateToLibrary } from '@/utils/nav';\nimport { clearDiscordPresence } from '@/utils/discord';\nimport { BOOK_IDS_SEPARATOR } from '@/services/constants';\nimport { BookDetailModal } from '@/components/metadata';\n\nimport useBooksManager from '../hooks/useBooksManager';\nimport useBookShortcuts from '../hooks/useBookShortcuts';\nimport Spinner from '@/components/Spinner';\nimport SideBar from './sidebar/SideBar';\nimport Notebook from './notebook/Notebook';\nimport BooksGrid from './BooksGrid';\nimport SettingsDialog from '@/components/settings/SettingsDialog';\n\nconst ReaderContent: React.FC<{ ids?: string; settings: SystemSettings }> = ({ ids, settings }) => {\n  const _ = useTranslation();\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const { envConfig, appService } = useEnv();\n  const { bookKeys, dismissBook, getNextBookKey } = useBooksManager();\n  const { sideBarBookKey, setSideBarBookKey } = useSidebarStore();\n  const { saveSettings } = useSettingsStore();\n  const { getConfig, getBookData, saveConfig } = useBookDataStore();\n  const { getView, setBookKeys, getViewSettings } = useReaderStore();\n  const { initViewState, getViewState, clearViewState } = useReaderStore();\n  const { isSettingsDialogOpen, settingsDialogBookKey } = useSettingsStore();\n  const [showDetailsBook, setShowDetailsBook] = useState<Book | null>(null);\n  const isInitiating = useRef(false);\n  const [loading, setLoading] = useState(false);\n  const [errorLoading, setErrorLoading] = useState(false);\n\n  useBookShortcuts({ sideBarBookKey, bookKeys });\n\n  useEffect(() => {\n    if (isInitiating.current) return;\n    isInitiating.current = true;\n\n    const pathname = window.location.pathname;\n    const bookIds = ids || searchParams?.get('ids') || pathname.split('/reader/')[1] || '';\n    const initialIds = bookIds.split(BOOK_IDS_SEPARATOR).filter(Boolean);\n    const initialBookKeys = initialIds.map((id) => `${id}-${uniqueId()}`);\n    setBookKeys(initialBookKeys);\n    const uniqueIds = new Set<string>();\n    console.log('Initialize books', initialBookKeys);\n    initialBookKeys.forEach((key, index) => {\n      const id = key.split('-')[0]!;\n      const isPrimary = !uniqueIds.has(id);\n      uniqueIds.add(id);\n      if (!getViewState(key)) {\n        initViewState(envConfig, id, key, isPrimary).catch((error) => {\n          console.log('Error initializing book', key, error);\n          setErrorLoading(true);\n          eventDispatcher.dispatch('toast', {\n            message: _('Unable to open book'),\n            callback: () => navigateBackToLibrary(),\n            timeout: 2000,\n            type: 'error',\n          });\n        });\n        if (index === 0) setSideBarBookKey(key);\n      }\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  useEffect(() => {\n    const handleShowBookDetails = (event: CustomEvent) => {\n      setShowDetailsBook(event.detail as Book);\n      return true;\n    };\n    eventDispatcher.onSync('show-book-details', handleShowBookDetails);\n\n    return () => {\n      eventDispatcher.offSync('show-book-details', handleShowBookDetails);\n    };\n  }, []);\n\n  useEffect(() => {\n    if (bookKeys && bookKeys.length > 0) {\n      const settings = useSettingsStore.getState().settings;\n      const lastOpenBooks = bookKeys.map((key) => key.split('-')[0]!);\n      if (settings.lastOpenBooks?.toString() !== lastOpenBooks.toString()) {\n        settings.lastOpenBooks = lastOpenBooks;\n        saveSettings(envConfig, settings);\n      }\n    }\n\n    let unlistenOnCloseWindow: Promise<UnlistenFn>;\n    if (isTauriAppPlatform()) {\n      unlistenOnCloseWindow = tauriHandleOnCloseWindow(handleCloseBooks);\n    }\n    window.addEventListener('beforeunload', handleCloseBooks);\n    eventDispatcher.on('beforereload', handleCloseBooks);\n    eventDispatcher.on('close-reader', handleCloseBooks);\n    eventDispatcher.on('quit-app', handleCloseBooks);\n    return () => {\n      window.removeEventListener('beforeunload', handleCloseBooks);\n      eventDispatcher.off('beforereload', handleCloseBooks);\n      eventDispatcher.off('close-reader', handleCloseBooks);\n      eventDispatcher.off('quit-app', handleCloseBooks);\n      unlistenOnCloseWindow?.then((fn) => fn());\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKeys]);\n\n  const saveBookConfig = async (bookKey: string) => {\n    const config = getConfig(bookKey);\n    const { book } = getBookData(bookKey) || {};\n    const { isPrimary } = getViewState(bookKey) || {};\n    if (isPrimary && book && config) {\n      const settings = useSettingsStore.getState().settings;\n      eventDispatcher.dispatch('sync-book-progress', { bookKey });\n      eventDispatcher.dispatch('flush-kosync', { bookKey });\n      await saveConfig(envConfig, bookKey, config, settings);\n    }\n  };\n\n  const saveConfigAndCloseBook = async (bookKey: string) => {\n    console.log('Closing book', bookKey);\n\n    const viewState = getViewState(bookKey);\n    if (viewState?.isPrimary && appService?.isDesktopApp) {\n      await clearDiscordPresence(appService);\n    }\n\n    try {\n      getView(bookKey)?.close();\n      getView(bookKey)?.remove();\n    } catch {\n      console.info('Error closing book', bookKey);\n    }\n    eventDispatcher.dispatch('tts-stop', { bookKey });\n    await saveBookConfig(bookKey);\n    clearViewState(bookKey);\n  };\n\n  const navigateBackToLibrary = () => {\n    navigateToLibrary(router, '', undefined, true);\n  };\n\n  const saveSettingsAndGoToLibrary = () => {\n    saveSettings(envConfig, settings);\n    navigateBackToLibrary();\n  };\n\n  const handleCloseBooks = throttle(async () => {\n    const settings = useSettingsStore.getState().settings;\n    await Promise.all(bookKeys.map(async (key) => await saveConfigAndCloseBook(key)));\n    await saveSettings(envConfig, settings);\n  }, 200);\n\n  const handleCloseBooksToLibrary = () => {\n    handleCloseBooks();\n    if (isTauriAppPlatform()) {\n      const currentWindow = getCurrentWindow();\n      if (currentWindow.label === 'main') {\n        navigateBackToLibrary();\n      } else {\n        currentWindow.close();\n      }\n    } else {\n      navigateBackToLibrary();\n    }\n  };\n\n  const handleCloseBook = async (bookKey: string) => {\n    saveConfigAndCloseBook(bookKey);\n    if (sideBarBookKey === bookKey) {\n      setSideBarBookKey(getNextBookKey(sideBarBookKey));\n    }\n    dismissBook(bookKey);\n    if (bookKeys.filter((key) => key !== bookKey).length == 0) {\n      const openWithFiles = (await parseOpenWithFiles(appService)) || [];\n      if (appService?.hasWindow) {\n        if (openWithFiles.length > 0) {\n          tauriHandleOnCloseWindow(handleCloseBooks);\n          return await tauriHandleClose();\n        }\n        const currentWindow = getCurrentWindow();\n        if (currentWindow.label.startsWith('reader')) {\n          return await currentWindow.close();\n        }\n      }\n      saveSettingsAndGoToLibrary();\n    }\n  };\n\n  if (!bookKeys || bookKeys.length === 0) return null;\n  const bookData = getBookData(bookKeys[0]!);\n  const viewSettings = getViewSettings(bookKeys[0]!);\n  if (!bookData || !bookData.book || !bookData.bookDoc || !viewSettings) {\n    setTimeout(() => setLoading(true), 200);\n    return (\n      loading &&\n      !errorLoading && (\n        <div className='hero hero-content full-height'>\n          <Spinner loading={true} />\n        </div>\n      )\n    );\n  }\n\n  return (\n    <div className='reader-content full-height flex'>\n      <SideBar onGoToLibrary={handleCloseBooksToLibrary} />\n      <BooksGrid bookKeys={bookKeys} onCloseBook={handleCloseBook} />\n      {isSettingsDialogOpen && <SettingsDialog bookKey={settingsDialogBookKey} />}\n      <Notebook />\n      {showDetailsBook && (\n        <BookDetailModal\n          isOpen={!!showDetailsBook}\n          book={showDetailsBook}\n          onClose={() => setShowDetailsBook(null)}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default ReaderContent;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5512, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/Reader.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport * as React from 'react';\nimport { useEffect, Suspense } from 'react';\nimport { useRouter } from 'next/navigation';\n\nimport { useEnv } from '@/context/EnvContext';\nimport { useTheme } from '@/hooks/useTheme';\nimport { useLibrary } from '@/hooks/useLibrary';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useNotebookStore } from '@/store/notebookStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useDeviceControlStore } from '@/store/deviceStore';\nimport { useScreenWakeLock } from '@/hooks/useScreenWakeLock';\nimport { useTransferQueue } from '@/hooks/useTransferQueue';\nimport { eventDispatcher } from '@/utils/event';\nimport { interceptWindowOpen } from '@/utils/open';\nimport { mountAdditionalFonts } from '@/styles/fonts';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { getSysFontsList, setSystemUIVisibility } from '@/utils/bridge';\nimport { AboutWindow } from '@/components/AboutWindow';\nimport { UpdaterWindow } from '@/components/UpdaterWindow';\nimport { KOSyncSettingsWindow } from './KOSyncSettings';\nimport { ProofreadRulesManager } from './ProofreadRules';\nimport { Toast } from '@/components/Toast';\nimport { getLocale } from '@/utils/misc';\nimport { initDayjs } from '@/utils/time';\nimport ReaderContent from './ReaderContent';\n\n/*\nZ-Index Layering Guide:\n---------------------------------\n99 – Window Border (Linux only)\n     • Ensures the border stays on top of all UI elements.\n50 – Loading Progress / Toast Notifications / Dialogs / Popups\n     • Includes Settings, About, Updater, KOSync dialogs and Annotation popups.\n45 – Sidebar / Notebook (Unpinned)\n     • Floats above the content but below global dialogs.\n40 – TTS Bar\n     • Mini controls for TTS playback on top of the TTS Control.\n30 – TTS Control\n     • Persistent TTS icon/panel.\n20 – Menu / Sidebar / Notebook (Pinned)\n     • Docked navigation or note views.\n10 – Headerbar / Footbar / Ribbon\n     • Top toolbar, bottom footbar and ribbon elements.\n 0 – Base Content\n     • Main reading area or background content.\n*/\n\nconst Reader: React.FC<{ ids?: string }> = ({ ids }) => {\n  const router = useRouter();\n  const { appService } = useEnv();\n  const { settings } = useSettingsStore();\n  const { libraryLoaded } = useLibrary();\n  const { sideBarBookKey } = useSidebarStore();\n  const { hoveredBookKey } = useReaderStore();\n  const { showSystemUI, dismissSystemUI } = useThemeStore();\n  const { getScreenBrightness, setScreenBrightness } = useDeviceControlStore();\n  const { acquireBackKeyInterception, releaseBackKeyInterception } = useDeviceControlStore();\n  const { isSideBarVisible, isSideBarPinned } = useSidebarStore();\n  const { getIsSideBarVisible, setSideBarVisible } = useSidebarStore();\n  const { isNotebookVisible, isNotebookPinned } = useNotebookStore();\n  const { getIsNotebookVisible, setNotebookVisible } = useNotebookStore();\n  const { isDarkMode, systemUIAlwaysHidden, isRoundedWindow } = useThemeStore();\n\n  useTheme({ systemUIVisible: settings.alwaysShowStatusBar, appThemeColor: 'base-100' });\n  useScreenWakeLock(settings.screenWakeLock);\n  useTransferQueue(libraryLoaded, 5000);\n\n  useEffect(() => {\n    mountAdditionalFonts(document);\n    interceptWindowOpen();\n    if (isTauriAppPlatform()) {\n      setTimeout(getSysFontsList, 3000);\n    }\n    initDayjs(getLocale());\n  }, []);\n\n  useEffect(() => {\n    const brightness = settings.screenBrightness;\n    const autoBrightness = settings.autoScreenBrightness;\n    if (appService?.hasScreenBrightness && !autoBrightness && brightness >= 0) {\n      setScreenBrightness(brightness / 100);\n    }\n    let previousBrightness = -1;\n    if (appService?.isIOSApp) {\n      getScreenBrightness().then((b) => {\n        previousBrightness = b;\n      });\n    }\n\n    return () => {\n      if (appService?.hasScreenBrightness && !autoBrightness) {\n        setScreenBrightness(previousBrightness);\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [appService]);\n\n  const handleKeyDown = (event: CustomEvent) => {\n    if (event.detail.keyName === 'Back') {\n      if (getIsSideBarVisible() && !isSideBarPinned) {\n        setSideBarVisible(false);\n      } else if (getIsNotebookVisible() && !isNotebookPinned) {\n        setNotebookVisible(false);\n      } else {\n        eventDispatcher.dispatch('close-reader');\n        router.back();\n      }\n      return true;\n    }\n    return false;\n  };\n\n  useEffect(() => {\n    if (!appService?.isAndroidApp) return;\n    acquireBackKeyInterception();\n    return () => {\n      releaseBackKeyInterception();\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [appService?.isAndroidApp]);\n\n  useEffect(() => {\n    if (appService?.isAndroidApp) {\n      eventDispatcher.onSync('native-key-down', handleKeyDown);\n    }\n    return () => {\n      if (appService?.isAndroidApp) {\n        eventDispatcher.offSync('native-key-down', handleKeyDown);\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    appService?.isAndroidApp,\n    sideBarBookKey,\n    isSideBarPinned,\n    isSideBarVisible,\n    isNotebookPinned,\n    isNotebookVisible,\n  ]);\n\n  useEffect(() => {\n    if (!appService?.isMobileApp) return;\n    const systemUIVisible = !!hoveredBookKey || settings.alwaysShowStatusBar;\n    const visible = !!(systemUIVisible && !systemUIAlwaysHidden);\n    setSystemUIVisibility({ visible, darkMode: isDarkMode });\n    if (visible) {\n      showSystemUI();\n    } else {\n      dismissSystemUI();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [hoveredBookKey]);\n\n  return libraryLoaded && settings.globalReadSettings ? (\n    <div\n      className={clsx(\n        'reader-page bg-base-100 text-base-content full-height select-none overflow-hidden',\n        appService?.hasRoundedWindow && isRoundedWindow && 'window-border rounded-window',\n      )}\n    >\n      <Suspense fallback={<div className='full-height'></div>}>\n        <ReaderContent ids={ids} settings={settings} />\n        <AboutWindow />\n        <UpdaterWindow />\n        <KOSyncSettingsWindow />\n        <ProofreadRulesManager />\n        <Toast />\n      </Suspense>\n    </div>\n  ) : (\n    <div className={clsx('full-height', !appService?.isLinuxApp && 'bg-base-100')}></div>\n  );\n};\n\nexport default Reader;\n"],"names":[],"mappings":"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"}}]
}