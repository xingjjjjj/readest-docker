{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useTheme.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useEffect, useRef } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { themes, applyCustomTheme, Palette } from '@/styles/themes';\nimport { getStatusBarHeight, setSystemUIVisibility } from '@/utils/bridge';\nimport { getOSPlatform } from '@/utils/misc';\nimport { parseWebViewVersion } from '@/utils/ua';\n\ntype UseThemeProps = {\n  systemUIVisible?: boolean;\n  appThemeColor?: keyof Palette;\n};\n\nexport const useTheme = ({\n  systemUIVisible = true,\n  appThemeColor = 'base-100',\n}: UseThemeProps = {}) => {\n  const { appService } = useEnv();\n  const { settings } = useSettingsStore();\n  const {\n    themeColor,\n    isDarkMode,\n    isEinkMode,\n    showSystemUI,\n    dismissSystemUI,\n    updateAppTheme,\n    setStatusBarHeight,\n    systemUIAlwaysHidden,\n    setSystemUIAlwaysHidden,\n  } = useThemeStore();\n\n  const useFallbackColors = useRef(false);\n\n  useEffect(() => {\n    updateAppTheme(appThemeColor);\n    if (appService?.isAndroidApp) {\n      getStatusBarHeight().then((res) => {\n        if (res.height && res.height > 0) {\n          setStatusBarHeight(res.height / window.devicePixelRatio);\n        }\n      });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [appService?.isAndroidApp]);\n\n  const handleSystemUIVisibility = useCallback(() => {\n    if (!appService?.isMobileApp) return;\n\n    const visible = !!(systemUIVisible && !systemUIAlwaysHidden);\n    if (visible) {\n      showSystemUI();\n    } else {\n      dismissSystemUI();\n    }\n    setSystemUIVisibility({ visible, darkMode: isDarkMode });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [appService, isDarkMode, systemUIVisible]);\n\n  useEffect(() => {\n    if (appService?.isMobileApp) {\n      handleSystemUIVisibility();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [handleSystemUIVisibility]);\n\n  useEffect(() => {\n    if (!appService?.isMobileApp) return;\n\n    handleSystemUIVisibility();\n    const handleVisibilityChange = () => {\n      if (document.visibilityState === 'visible') {\n        handleSystemUIVisibility();\n      }\n    };\n    const handleOrientationChange = () => {\n      if (appService?.isIOSApp && getOSPlatform() === 'ios') {\n        // FIXME: This is a workaround for iPhone apps where the system UI is not visible in landscape mode\n        // when the app is in fullscreen mode until we find a better solution to override the prefersStatusBarHidden\n        // in the ViewController. Note that screen.orientation.type is not abailable in iOS before 16.4.\n        const systemUIAlwaysHidden = screen.orientation?.type.includes('landscape');\n        setSystemUIAlwaysHidden(systemUIAlwaysHidden);\n        handleSystemUIVisibility();\n      }\n    };\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    screen.orientation?.addEventListener('change', handleOrientationChange);\n    return () => {\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n      screen.orientation?.removeEventListener('change', handleOrientationChange);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [handleSystemUIVisibility]);\n\n  useEffect(() => {\n    if (!appService?.isAndroidApp) return;\n    const webViewVersion = parseWebViewVersion(appService);\n    // OKLCH color model is supported in Chromium 111+\n    useFallbackColors.current = webViewVersion < 111;\n  }, [appService]);\n\n  useEffect(() => {\n    if (!themeColor || !themes.find((t) => t.name === themeColor)) return;\n    if (useFallbackColors.current) {\n      applyCustomTheme(undefined, themeColor, true);\n    }\n  }, [themeColor]);\n\n  useEffect(() => {\n    const customThemes = settings.globalReadSettings?.customThemes ?? [];\n    customThemes.forEach((customTheme) => {\n      applyCustomTheme(customTheme, undefined, useFallbackColors.current);\n    });\n    localStorage.setItem('customThemes', JSON.stringify(customThemes));\n  }, [settings.globalReadSettings?.customThemes]);\n\n  useEffect(() => {\n    const colorScheme = isDarkMode ? 'dark' : 'light';\n    document.documentElement.setAttribute('data-theme', `${themeColor}-${colorScheme}`);\n    document.documentElement.style.setProperty('color-scheme', colorScheme);\n    document.documentElement.style.setProperty(\n      '--overlayer-highlight-opacity',\n      isEinkMode ? '1.0' : '0.3',\n    );\n    document.documentElement.style.setProperty(\n      '--overlayer-highlight-blend-mode',\n      isEinkMode ? 'difference' : isDarkMode ? 'lighten' : 'normal',\n    );\n    document.documentElement.style.setProperty(\n      '--bg-texture-blend-mode',\n      isDarkMode ? 'lighten' : 'multiply',\n    );\n  }, [themeColor, isDarkMode, isEinkMode]);\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useLibrary.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef, useState } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useLibraryStore } from '@/store/libraryStore';\nimport { useSettingsStore } from '@/store/settingsStore';\n\nexport const useLibrary = () => {\n  const { envConfig } = useEnv();\n  const { setLibrary } = useLibraryStore();\n  const { setSettings } = useSettingsStore();\n  const [libraryLoaded, setLibraryLoaded] = useState(false);\n  const isInitiating = useRef(false);\n\n  useEffect(() => {\n    if (isInitiating.current) return;\n    isInitiating.current = true;\n    const initLibrary = async () => {\n      const appService = await envConfig.getAppService();\n      const settings = await appService.loadSettings();\n      setSettings(settings);\n      setLibrary(await appService.loadLibraryBooks());\n      setLibraryLoaded(true);\n    };\n\n    initLibrary();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  return { libraryLoaded };\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;;;;;;AALA;;;;;AAOO,MAAM,aAAa;IACxB,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,0JAAM;IAC5B,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,kKAAe;IACtC,MAAM,EAAE,WAAW,EAAE,GAAG,IAAA,oKAAgB;IACxC,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,+GAAQ,EAAC;IACnD,MAAM,eAAe,IAAA,6GAAM,EAAC;IAE5B,IAAA,gHAAS,EAAC;QACR,IAAI,aAAa,OAAO,EAAE;QAC1B,aAAa,OAAO,GAAG;QACvB,MAAM,cAAc;YAClB,MAAM,aAAa,MAAM,UAAU,aAAa;YAChD,MAAM,WAAW,MAAM,WAAW,YAAY;YAC9C,YAAY;YACZ,WAAW,MAAM,WAAW,gBAAgB;YAC5C,iBAAiB;QACnB;QAEA;IACA,uDAAuD;IACzD,GAAG,EAAE;IAEL,OAAO;QAAE;IAAc;AACzB"}},
    {"offset": {"line": 199, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useScreenWakeLock.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef } from 'react';\nimport { getCurrentWindow } from '@tauri-apps/api/window';\nimport { isTauriAppPlatform, isWebAppPlatform } from '@/services/environment';\n\nexport const useScreenWakeLock = (lock: boolean) => {\n  const wakeLockRef = useRef<WakeLockSentinel | null>(null);\n  const unlistenOnFocusChangedRef = useRef<Promise<() => void> | null>(null);\n\n  useEffect(() => {\n    const requestWakeLock = async () => {\n      try {\n        if ('wakeLock' in navigator) {\n          wakeLockRef.current = await navigator.wakeLock.request('screen');\n\n          wakeLockRef.current.addEventListener('release', () => {\n            wakeLockRef.current = null;\n          });\n\n          console.log('Wake lock acquired');\n        }\n      } catch (err) {\n        console.info('Failed to acquire wake lock:', err);\n      }\n    };\n\n    const releaseWakeLock = () => {\n      if (wakeLockRef.current) {\n        wakeLockRef.current.release();\n        wakeLockRef.current = null;\n        console.log('Wake lock released');\n      }\n    };\n\n    const handleVisibilityChange = () => {\n      if (document.hidden) {\n        releaseWakeLock();\n      } else {\n        requestWakeLock();\n      }\n    };\n\n    if (lock) {\n      requestWakeLock();\n    } else if (wakeLockRef.current) {\n      releaseWakeLock();\n    }\n\n    if (isWebAppPlatform() && lock) {\n      document.addEventListener('visibilitychange', handleVisibilityChange);\n    } else if (isTauriAppPlatform() && lock) {\n      unlistenOnFocusChangedRef.current = getCurrentWindow().onFocusChanged(\n        ({ payload: focused }) => {\n          if (focused) {\n            requestWakeLock();\n          } else {\n            releaseWakeLock();\n          }\n        },\n      );\n    }\n\n    return () => {\n      releaseWakeLock();\n      if (isWebAppPlatform() && lock) {\n        document.removeEventListener('visibilitychange', handleVisibilityChange);\n      }\n      if (unlistenOnFocusChangedRef.current) {\n        unlistenOnFocusChangedRef.current.then((f) => f());\n      }\n    };\n  }, [lock]);\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;;;;;AAJA;;;;AAMO,MAAM,oBAAoB,CAAC;IAChC,MAAM,cAAc,IAAA,6GAAM,EAA0B;IACpD,MAAM,4BAA4B,IAAA,6GAAM,EAA6B;IAErE,IAAA,gHAAS,EAAC;QACR,MAAM,kBAAkB;YACtB,IAAI;gBACF,IAAI,cAAc,WAAW;oBAC3B,YAAY,OAAO,GAAG,MAAM,UAAU,QAAQ,CAAC,OAAO,CAAC;oBAEvD,YAAY,OAAO,CAAC,gBAAgB,CAAC,WAAW;wBAC9C,YAAY,OAAO,GAAG;oBACxB;oBAEA,QAAQ,GAAG,CAAC;gBACd;YACF,EAAE,OAAO,KAAK;gBACZ,QAAQ,IAAI,CAAC,gCAAgC;YAC/C;QACF;QAEA,MAAM,kBAAkB;YACtB,IAAI,YAAY,OAAO,EAAE;gBACvB,YAAY,OAAO,CAAC,OAAO;gBAC3B,YAAY,OAAO,GAAG;gBACtB,QAAQ,GAAG,CAAC;YACd;QACF;QAEA,MAAM,yBAAyB;YAC7B,IAAI,SAAS,MAAM,EAAE;gBACnB;YACF,OAAO;gBACL;YACF;QACF;QAEA,IAAI,MAAM;YACR;QACF,OAAO,IAAI,YAAY,OAAO,EAAE;YAC9B;QACF;QAEA,IAAI,IAAA,qKAAgB,OAAM,MAAM;YAC9B,SAAS,gBAAgB,CAAC,oBAAoB;QAChD,OAAO,IAAI,IAAA,uKAAkB,OAAM,MAAM;YACvC,0BAA0B,OAAO,GAAG,IAAA,oLAAgB,IAAG,cAAc,CACnE,CAAC,EAAE,SAAS,OAAO,EAAE;gBACnB,IAAI,SAAS;oBACX;gBACF,OAAO;oBACL;gBACF;YACF;QAEJ;QAEA,OAAO;YACL;YACA,IAAI,IAAA,qKAAgB,OAAM,MAAM;gBAC9B,SAAS,mBAAmB,CAAC,oBAAoB;YACnD;YACA,IAAI,0BAA0B,OAAO,EAAE;gBACrC,0BAA0B,OAAO,CAAC,IAAI,CAAC,CAAC,IAAM;YAChD;QACF;IACF,GAAG;QAAC;KAAK;AACX"}},
    {"offset": {"line": 281, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useTranslation.ts"],"sourcesContent":["'use client';\n\nimport '@/i18n/i18n';\nimport { useCallback } from 'react';\nimport { useTranslation as _useTranslation } from 'react-i18next';\n\nexport type TranslationFunc = (key: string, options?: Record<string, number | string>) => string;\n\nexport const useTranslation = (namespace: string = 'translation') => {\n  const { t } = _useTranslation(namespace);\n\n  return useCallback((key: string, options = {}) => t(key, { defaultValue: key, ...options }), [t]);\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;;;;;;AAJA;;;;AAQO,MAAM,iBAAiB,CAAC,YAAoB,aAAa;IAC9D,MAAM,EAAE,CAAC,EAAE,GAAG,IAAA,kJAAe,EAAC;IAE9B,OAAO,IAAA,kHAAW,EAAC,CAAC,KAAa,UAAU,CAAC,CAAC,GAAK,EAAE,KAAK;YAAE,cAAc;YAAK,GAAG,OAAO;QAAC,IAAI;QAAC;KAAE;AAClG"}},
    {"offset": {"line": 313, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useTransferQueue.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useCallback, useMemo } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useTranslation } from './useTranslation';\nimport { useLibraryStore } from '@/store/libraryStore';\nimport { useTransferStore, TransferType } from '@/store/transferStore';\nimport { transferManager } from '@/services/transferManager';\nimport { Book } from '@/types/book';\n\nexport function useTransferQueue(libraryLoaded = true, delayInit = 0) {\n  const { envConfig, appService } = useEnv();\n  const _ = useTranslation();\n\n  const transfers = useTransferStore((state) => state.transfers);\n  const isQueuePaused = useTransferStore((state) => state.isQueuePaused);\n  const setIsTransferQueueOpen = useTransferStore((state) => state.setIsTransferQueueOpen);\n\n  useEffect(() => {\n    const initManager = async () => {\n      if (appService && envConfig) {\n        const getLibrary = () => useLibraryStore.getState().library;\n        const updateBookFn = async (book: Book) => {\n          await useLibraryStore.getState().updateBook(envConfig, book);\n        };\n        const translationFn = _;\n        await transferManager.initialize(appService, getLibrary, updateBookFn, translationFn);\n      }\n    };\n\n    // Initialize transfer manager only when library is loaded\n    if (libraryLoaded) {\n      setTimeout(() => {\n        initManager();\n      }, delayInit);\n    }\n  }, [appService, envConfig, libraryLoaded, delayInit, _]);\n\n  const queueUpload = useCallback((book: Book, priority?: number) => {\n    return transferManager.queueUpload(book, priority);\n  }, []);\n\n  const queueDownload = useCallback((book: Book, priority?: number) => {\n    return transferManager.queueDownload(book, priority);\n  }, []);\n\n  const queueBatchUploads = useCallback((books: Book[], priority?: number) => {\n    return transferManager.queueBatchUploads(books, priority);\n  }, []);\n\n  const cancelTransfer = useCallback((transferId: string) => {\n    transferManager.cancelTransfer(transferId);\n  }, []);\n\n  const retryTransfer = useCallback((transferId: string) => {\n    transferManager.retryTransfer(transferId);\n  }, []);\n\n  const retryAllFailed = useCallback(() => {\n    transferManager.retryAllFailed();\n  }, []);\n\n  const pauseQueue = useCallback(() => {\n    transferManager.pauseQueue();\n  }, []);\n\n  const resumeQueue = useCallback(() => {\n    transferManager.resumeQueue();\n  }, []);\n\n  const clearCompleted = useCallback(() => {\n    useTransferStore.getState().clearCompleted();\n  }, []);\n\n  const clearFailed = useCallback(() => {\n    useTransferStore.getState().clearFailed();\n  }, []);\n\n  const clearAll = useCallback(() => {\n    useTransferStore.getState().clearAll();\n  }, []);\n\n  const getTransferProgress = useCallback((bookHash: string, type: TransferType) => {\n    return useTransferStore.getState().getTransferByBookHash(bookHash, type);\n  }, []);\n\n  const stats = useMemo(() => {\n    const transferList = Object.values(transfers);\n    return {\n      pending: transferList.filter((t) => t.status === 'pending').length,\n      active: transferList.filter((t) => t.status === 'in_progress').length,\n      completed: transferList.filter((t) => t.status === 'completed').length,\n      failed: transferList.filter((t) => t.status === 'failed' || t.status === 'cancelled').length,\n      total: transferList.length,\n    };\n  }, [transfers]);\n\n  const pendingTransfers = useMemo(() => {\n    return Object.values(transfers).filter((t) => t.status === 'pending');\n  }, [transfers]);\n\n  const activeTransfers = useMemo(() => {\n    return Object.values(transfers).filter((t) => t.status === 'in_progress');\n  }, [transfers]);\n\n  const failedTransfers = useMemo(() => {\n    return Object.values(transfers).filter(\n      (t) => t.status === 'failed' || t.status === 'cancelled',\n    );\n  }, [transfers]);\n\n  const completedTransfers = useMemo(() => {\n    return Object.values(transfers).filter((t) => t.status === 'completed');\n  }, [transfers]);\n\n  const hasActiveTransfers = useMemo(() => {\n    return pendingTransfers.length > 0 || activeTransfers.length > 0;\n  }, [pendingTransfers, activeTransfers]);\n\n  return {\n    transfers: Object.values(transfers),\n    isQueuePaused,\n    stats,\n    pendingTransfers,\n    activeTransfers,\n    failedTransfers,\n    completedTransfers,\n    hasActiveTransfers,\n\n    setIsTransferQueueOpen,\n    queueUpload,\n    queueDownload,\n    queueBatchUploads,\n    cancelTransfer,\n    retryTransfer,\n    retryAllFailed,\n    pauseQueue,\n    resumeQueue,\n    clearCompleted,\n    clearFailed,\n    clearAll,\n    getTransferProgress,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 472, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useTranslator.ts"],"sourcesContent":["'use client';\n\nimport { useState, useCallback, useEffect } from 'react';\nimport { useAuth } from '@/context/AuthContext';\nimport { ErrorCodes, getTranslator, getTranslators, TranslatorName } from '@/services/translators';\nimport { getFromCache, storeInCache, UseTranslatorOptions } from '@/services/translators';\nimport { polish, preprocess } from '@/services/translators';\nimport { eventDispatcher } from '@/utils/event';\nimport { getLocale } from '@/utils/misc';\nimport { useTranslation } from './useTranslation';\n\nexport function useTranslator({\n  provider = 'deepl',\n  sourceLang = 'AUTO',\n  targetLang = 'EN',\n  enablePolishing = true,\n  enablePreprocessing = true,\n}: UseTranslatorOptions = {}) {\n  const _ = useTranslation();\n  const { token } = useAuth();\n  const [loading, setLoading] = useState(false);\n  const [selectedProvider, setSelectedProvider] = useState(provider);\n  const [translator, setTransltor] = useState(() => getTranslator(provider));\n  const [translators] = useState(() => getTranslators());\n\n  useEffect(() => {\n    setLoading(false);\n  }, [provider, sourceLang, targetLang]);\n\n  useEffect(() => {\n    const availableTranslators = getTranslators().filter(\n      (t) => (t.authRequired ? !!token : true) && !t.quotaExceeded,\n    );\n    const selectedTranslator =\n      availableTranslators.find((t) => t.name === provider) || availableTranslators[0]!;\n    const selectedProviderName = selectedTranslator.name as TranslatorName;\n    setTransltor(getTranslator(selectedProviderName));\n    setSelectedProvider(selectedProviderName);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [provider]);\n\n  const translate = useCallback(\n    async (\n      input: string[],\n      options?: { source?: string; target?: string; useCache?: boolean },\n    ): Promise<string[]> => {\n      const sourceLanguage = options?.source || sourceLang;\n      const targetLanguage = options?.target || targetLang || getLocale();\n      const useCache = options?.useCache ?? false;\n      const textsToTranslate = enablePreprocessing ? preprocess(input) : input;\n\n      if (textsToTranslate.length === 0 || textsToTranslate.every((t) => !t?.trim())) {\n        return textsToTranslate;\n      }\n\n      const textsNeedingTranslation: string[] = [];\n      const indicesNeedingTranslation: number[] = [];\n\n      await Promise.all(\n        textsToTranslate.map(async (text, index) => {\n          if (!text?.trim()) return;\n\n          const cachedTranslation = await getFromCache(\n            text,\n            sourceLanguage,\n            targetLanguage,\n            selectedProvider,\n          );\n          if (cachedTranslation) return;\n\n          textsNeedingTranslation.push(text);\n          indicesNeedingTranslation.push(index);\n        }),\n      );\n\n      if (textsNeedingTranslation.length === 0) {\n        const results = await Promise.all(\n          textsToTranslate.map((text) =>\n            getFromCache(text, sourceLanguage, targetLanguage, selectedProvider).then(\n              (cached) => cached || text,\n            ),\n          ),\n        );\n\n        return enablePolishing ? polish(results, targetLanguage) : results;\n      }\n\n      setLoading(true);\n\n      try {\n        const translator = translators.find((t) => t.name === selectedProvider);\n        if (!translator) {\n          throw new Error(`No translator found for provider: ${selectedProvider}`);\n        }\n        const translatedTexts = await translator.translate(\n          textsNeedingTranslation,\n          sourceLanguage,\n          targetLanguage,\n          token,\n          useCache,\n        );\n\n        await Promise.all(\n          textsNeedingTranslation.map(async (text, index) => {\n            return storeInCache(\n              text,\n              translatedTexts[index] || '',\n              sourceLanguage,\n              targetLanguage,\n              selectedProvider,\n            );\n          }),\n        );\n\n        const results = [...textsToTranslate];\n        indicesNeedingTranslation.forEach((originalIndex, translationIndex) => {\n          results[originalIndex] = translatedTexts[translationIndex] || '';\n        });\n\n        await Promise.all(\n          results.map(async (_, index) => {\n            if (!indicesNeedingTranslation.includes(index)) {\n              const originalText = textsToTranslate[index];\n              if (!originalText?.trim()) return;\n\n              const cachedTranslation = await getFromCache(\n                originalText,\n                sourceLanguage,\n                targetLanguage,\n                selectedProvider,\n              );\n\n              if (cachedTranslation) {\n                results[index] = cachedTranslation;\n              }\n            }\n          }),\n        );\n\n        setLoading(false);\n        return enablePolishing ? polish(results, targetLanguage) : results;\n      } catch (err) {\n        if (err instanceof Error && err.message.includes(ErrorCodes.DAILY_QUOTA_EXCEEDED)) {\n          eventDispatcher.dispatch('toast', {\n            timeout: 5000,\n            message: _(\n              'Daily translation quota reached. Upgrade your plan to continue using AI translations.',\n            ),\n            type: 'error',\n          });\n          setSelectedProvider('azure');\n        }\n        setLoading(false);\n        throw err instanceof Error ? err : new Error(String(err));\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [selectedProvider, sourceLang, targetLang, translator, token],\n  );\n\n  return {\n    translate,\n    translator,\n    translators,\n    loading,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 607, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useDrag.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useRef } from 'react';\n\nexport type DragKey = 'ArrowLeft' | 'ArrowRight' | 'ArrowUp' | 'ArrowDown';\n\nexport const useDrag = (\n  onDragMove: (data: { clientX: number; clientY: number; deltaX: number; deltaY: number }) => void,\n  onDragKeyDown: (data: { key: DragKey; step: number }) => void,\n  onDragEnd?: (data: {\n    velocity: number;\n    deltaT: number;\n    clientX: number;\n    clientY: number;\n    deltaX: number;\n    deltaY: number;\n  }) => void,\n) => {\n  const isDragging = useRef(false);\n  const startX = useRef(0);\n  const startY = useRef(0);\n  const lastX = useRef(0);\n  const lastY = useRef(0);\n  const startTime = useRef(0);\n\n  const handleDragStart = useCallback(\n    (e: React.MouseEvent | React.TouchEvent) => {\n      isDragging.current = true;\n\n      if ('touches' in e) {\n        startY.current = e.touches[0]!.clientY;\n        startX.current = e.touches[0]!.clientX;\n      } else {\n        startY.current = e.clientY;\n        startX.current = e.clientX;\n      }\n      startTime.current = performance.now();\n\n      document.body.style.pointerEvents = 'none';\n      document.body.style.userSelect = 'none';\n      document.documentElement.style.cursor = 'col-resize';\n\n      const handleMove = (event: MouseEvent | TouchEvent) => {\n        if (isDragging.current) {\n          let deltaX = 0;\n          let deltaY = 0;\n          let clientX = 0;\n          let clientY = 0;\n\n          if ('touches' in event && event.touches.length > 0) {\n            const currentTouch = event.touches[0]!;\n            clientX = currentTouch.clientX;\n            clientY = currentTouch.clientY;\n          } else {\n            const evt = event as MouseEvent;\n            clientX = evt.clientX;\n            clientY = evt.clientY;\n          }\n          deltaX = clientX - lastX.current;\n          deltaY = clientY - lastY.current;\n          lastX.current = clientX;\n          lastY.current = clientY;\n\n          onDragMove({ clientX, clientY, deltaX, deltaY });\n        }\n      };\n\n      const handleEnd = (event: MouseEvent | TouchEvent) => {\n        isDragging.current = false;\n\n        document.body.style.pointerEvents = '';\n        document.body.style.userSelect = '';\n        document.documentElement.style.cursor = '';\n\n        let deltaX = 0;\n        let deltaY = 0;\n        let clientX = 0;\n        let clientY = 0;\n        const endTime = performance.now();\n        const deltaT = endTime - startTime.current;\n\n        if ('touches' in event) {\n          const currentTouch = event.changedTouches[0]!;\n          clientX = currentTouch.clientX;\n          clientY = currentTouch.clientY;\n        } else {\n          const evt = event as MouseEvent;\n          clientX = evt.clientX;\n          clientY = evt.clientY;\n        }\n        deltaX = clientX - startX.current;\n        deltaY = clientY - startY.current;\n        const velocity = deltaY / deltaT;\n\n        if (onDragEnd) {\n          onDragEnd({ velocity, deltaT, clientX, clientY, deltaX, deltaY });\n        }\n\n        window.removeEventListener('mousemove', handleMove);\n        window.removeEventListener('mouseup', handleEnd);\n        window.removeEventListener('touchmove', handleMove);\n        window.removeEventListener('touchend', handleEnd);\n      };\n\n      window.addEventListener('mousemove', handleMove, { passive: true });\n      window.addEventListener('mouseup', handleEnd);\n      window.addEventListener('touchmove', handleMove, { passive: true });\n      window.addEventListener('touchend', handleEnd);\n    },\n    [onDragMove, onDragEnd],\n  );\n\n  const handleDragKeyDown = useCallback(\n    (e: React.KeyboardEvent) => {\n      const step = 0.02;\n      switch (e.key) {\n        case 'ArrowUp':\n        case 'ArrowDown':\n        case 'ArrowLeft':\n        case 'ArrowRight':\n          onDragKeyDown({ key: e.key, step });\n          break;\n        default:\n          return;\n      }\n      e.preventDefault();\n      e.stopPropagation();\n    },\n    [onDragKeyDown],\n  );\n\n  return { handleDragStart, handleDragKeyDown };\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 742, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useKeyDownActions.ts"],"sourcesContent":["'use client';\n\nimport { RefObject, useEffect, useRef } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useDeviceControlStore } from '@/store/deviceStore';\nimport { eventDispatcher } from '@/utils/event';\n\ninterface UseKeyDownOptions {\n  onCancel?: () => void;\n  onConfirm?: () => void;\n  enabled?: boolean;\n  elementRef?: RefObject<HTMLElement>;\n}\n\nexport const useKeyDownActions = ({\n  onCancel,\n  onConfirm,\n  enabled = true,\n  elementRef: providedRef,\n}: UseKeyDownOptions) => {\n  const { appService } = useEnv();\n  const { acquireBackKeyInterception, releaseBackKeyInterception } = useDeviceControlStore();\n  const internalRef = useRef<HTMLDivElement>(null);\n  const elementRef = providedRef || internalRef;\n\n  useEffect(() => {\n    if (!enabled) return;\n\n    const handleKeyDown = (event: KeyboardEvent | CustomEvent) => {\n      if (event instanceof CustomEvent) {\n        if (event.detail.keyName === 'Back') {\n          onCancel?.();\n          return true;\n        }\n      } else {\n        if (event.key === 'Escape') {\n          onCancel?.();\n        } else if (event.key === 'Enter') {\n          onConfirm?.();\n        }\n        event.stopPropagation();\n      }\n      return false;\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n\n    if (elementRef.current) {\n      elementRef.current.addEventListener('keydown', handleKeyDown);\n    }\n\n    if (appService?.isAndroidApp) {\n      acquireBackKeyInterception?.();\n      eventDispatcher.onSync('native-key-down', handleKeyDown);\n    }\n\n    return () => {\n      window.removeEventListener('keydown', handleKeyDown);\n\n      if (appService?.isAndroidApp) {\n        releaseBackKeyInterception?.();\n        eventDispatcher.offSync('native-key-down', handleKeyDown);\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [enabled, appService?.isAndroidApp]);\n\n  return internalRef;\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;;;;;AALA;;;;;AAcO,MAAM,oBAAoB,CAAC,EAChC,QAAQ,EACR,SAAS,EACT,UAAU,IAAI,EACd,YAAY,WAAW,EACL;IAClB,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAC7B,MAAM,EAAE,0BAA0B,EAAE,0BAA0B,EAAE,GAAG,IAAA,uKAAqB;IACxF,MAAM,cAAc,IAAA,6GAAM,EAAiB;IAC3C,MAAM,aAAa,eAAe;IAElC,IAAA,gHAAS,EAAC;QACR,IAAI,CAAC,SAAS;QAEd,MAAM,gBAAgB,CAAC;YACrB,IAAI,iBAAiB,aAAa;gBAChC,IAAI,MAAM,MAAM,CAAC,OAAO,KAAK,QAAQ;oBACnC;oBACA,OAAO;gBACT;YACF,OAAO;gBACL,IAAI,MAAM,GAAG,KAAK,UAAU;oBAC1B;gBACF,OAAO,IAAI,MAAM,GAAG,KAAK,SAAS;oBAChC;gBACF;gBACA,MAAM,eAAe;YACvB;YACA,OAAO;QACT;QAEA,OAAO,gBAAgB,CAAC,WAAW;QAEnC,IAAI,WAAW,OAAO,EAAE;YACtB,WAAW,OAAO,CAAC,gBAAgB,CAAC,WAAW;QACjD;QAEA,IAAI,YAAY,cAAc;YAC5B;YACA,2JAAe,CAAC,MAAM,CAAC,mBAAmB;QAC5C;QAEA,OAAO;YACL,OAAO,mBAAmB,CAAC,WAAW;YAEtC,IAAI,YAAY,cAAc;gBAC5B;gBACA,2JAAe,CAAC,OAAO,CAAC,mBAAmB;YAC7C;QACF;IACA,uDAAuD;IACzD,GAAG;QAAC;QAAS,YAAY;KAAa;IAEtC,OAAO;AACT"}},
    {"offset": {"line": 811, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useFileSelector.ts"],"sourcesContent":["import { AppService } from '@/types/system';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { basename } from '@tauri-apps/api/path';\nimport { stubTranslation as _ } from '@/utils/misc';\nimport { BOOK_ACCEPT_FORMATS, SUPPORTED_BOOK_EXTS } from '@/services/constants';\n\nexport interface FileSelectorOptions {\n  type: SelectionType;\n  accept?: string;\n  multiple?: boolean;\n  extensions?: string[];\n  dialogTitle?: string;\n}\n\nexport interface SelectedFile {\n  // For Web file\n  file?: File;\n\n  // For Tauri file\n  path?: string;\n  basePath?: string;\n}\n\nexport interface FileSelectionResult {\n  files: SelectedFile[];\n  error?: string;\n}\n\nconst selectFileWeb = (options: FileSelectorOptions): Promise<File[]> => {\n  return new Promise((resolve) => {\n    const fileInput = document.createElement('input');\n    fileInput.type = 'file';\n    fileInput.accept = options.accept || '*/*';\n    fileInput.multiple = options.multiple || false;\n    fileInput.click();\n\n    fileInput.onchange = () => {\n      resolve(Array.from(fileInput.files || []));\n    };\n  });\n};\n\nconst selectFileTauri = async (\n  options: FileSelectorOptions,\n  appService: AppService,\n  _: (key: string) => string,\n): Promise<string[]> => {\n  const noFilter = appService?.isIOSApp || (appService?.isAndroidApp && options.type === 'books');\n  const exts = noFilter ? [] : options.extensions || [];\n  const title = options.dialogTitle || _('Select Files');\n  let files = (await appService?.selectFiles(_(title), exts)) || [];\n\n  if (noFilter && options.extensions) {\n    files = await Promise.all(\n      files.map(async (file: string) => {\n        let processedFile = file;\n        if (appService?.isAndroidApp && file.startsWith('content://')) {\n          processedFile = await basename(file);\n        }\n        const fileExt = processedFile.split('.').pop()?.toLowerCase() || 'unknown';\n        const extensions = options.extensions!;\n        const shouldInclude = extensions.includes(fileExt) || extensions.includes('*');\n        return shouldInclude ? file : null;\n      }),\n    ).then((results) => results.filter((file) => file !== null));\n  }\n\n  return files;\n};\n\nconst processWebFiles = (files: File[]): SelectedFile[] => {\n  return files.map((file) => ({\n    file,\n  }));\n};\n\nconst processTauriFiles = (files: string[]): SelectedFile[] => {\n  return files.map((path) => ({\n    path,\n  }));\n};\n\nexport const useFileSelector = (appService: AppService | null, _: (key: string) => string) => {\n  const selectFiles = async (options: FileSelectorOptions = { type: 'generic' }) => {\n    options = { ...FILE_SELECTION_PRESETS[options.type], ...options };\n    if (!appService) {\n      return { files: [] as SelectedFile[], error: 'App service is not available' };\n    }\n    try {\n      if (isTauriAppPlatform()) {\n        const filePaths = await selectFileTauri(options, appService, _);\n        const files = await processTauriFiles(filePaths);\n        return { files };\n      } else {\n        const webFiles = await selectFileWeb(options);\n        const files = processWebFiles(webFiles);\n        return { files };\n      }\n    } catch (error) {\n      return {\n        files: [],\n        error: error instanceof Error ? error.message : 'Unknown error occurred',\n      };\n    }\n  };\n  return {\n    selectFiles,\n  };\n};\n\nexport const FILE_SELECTION_PRESETS = {\n  generic: {\n    accept: '*/*',\n    extensions: ['*'],\n    dialogTitle: _('Select Files'),\n  },\n  images: {\n    accept: 'image/*',\n    extensions: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'],\n    dialogTitle: _('Select Image'),\n  },\n  videos: {\n    accept: 'video/*',\n    extensions: ['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'],\n    dialogTitle: _('Select Video'),\n  },\n  audio: {\n    accept: 'audio/*',\n    extensions: ['mp3', 'wav', 'ogg', 'flac', 'm4a'],\n    dialogTitle: _('Select Audio'),\n  },\n  books: {\n    accept: BOOK_ACCEPT_FORMATS,\n    extensions: SUPPORTED_BOOK_EXTS,\n    dialogTitle: _('Select Books'),\n  },\n  fonts: {\n    accept: '.ttf, .otf, .woff, .woff2',\n    extensions: ['ttf', 'otf', 'woff', 'woff2'],\n    dialogTitle: _('Select Fonts'),\n  },\n  covers: {\n    accept: '.png, .jpg, .jpeg, .gif',\n    extensions: ['png', 'jpg', 'jpeg', 'gif'],\n    dialogTitle: _('Select Image'),\n  },\n};\n\nexport type SelectionType = keyof typeof FILE_SELECTION_PRESETS;\n"],"names":[],"mappings":";;;;;;AACA;AACA;AACA;AACA;;;;;;;;;AAwBA,MAAM,gBAAgB,CAAC;IACrB,OAAO,IAAI,QAAQ,CAAC;QAClB,MAAM,YAAY,SAAS,aAAa,CAAC;QACzC,UAAU,IAAI,GAAG;QACjB,UAAU,MAAM,GAAG,QAAQ,MAAM,IAAI;QACrC,UAAU,QAAQ,GAAG,QAAQ,QAAQ,IAAI;QACzC,UAAU,KAAK;QAEf,UAAU,QAAQ,GAAG;YACnB,QAAQ,MAAM,IAAI,CAAC,UAAU,KAAK,IAAI,EAAE;QAC1C;IACF;AACF;AAEA,MAAM,kBAAkB,OACtB,SACA,YACA;IAEA,MAAM,WAAW,YAAY,YAAa,YAAY,gBAAgB,QAAQ,IAAI,KAAK;IACvF,MAAM,OAAO,WAAW,EAAE,GAAG,QAAQ,UAAU,IAAI,EAAE;IACrD,MAAM,QAAQ,QAAQ,WAAW,IAAI,EAAE;IACvC,IAAI,QAAQ,AAAC,MAAM,YAAY,YAAY,EAAE,QAAQ,SAAU,EAAE;IAEjE,IAAI,YAAY,QAAQ,UAAU,EAAE;QAClC,QAAQ,MAAM,QAAQ,GAAG,CACvB,MAAM,GAAG,CAAC,OAAO;YACf,IAAI,gBAAgB;YACpB,IAAI,YAAY,gBAAgB,KAAK,UAAU,CAAC,eAAe;gBAC7D,gBAAgB,MAAM,8KAAS;YACjC;YACA,MAAM,UAAU,cAAc,KAAK,CAAC,KAAK,GAAG,IAAI,iBAAiB;YACjE,MAAM,aAAa,QAAQ,UAAU;YACrC,MAAM,gBAAgB,WAAW,QAAQ,CAAC,YAAY,WAAW,QAAQ,CAAC;YAC1E,OAAO,gBAAgB,OAAO;QAChC,IACA,IAAI,CAAC,CAAC,UAAY,QAAQ,MAAM,CAAC,CAAC,OAAS,SAAS;IACxD;IAEA,OAAO;AACT;AAEA,MAAM,kBAAkB,CAAC;IACvB,OAAO,MAAM,GAAG,CAAC,CAAC,OAAS,CAAC;YAC1B;QACF,CAAC;AACH;AAEA,MAAM,oBAAoB,CAAC;IACzB,OAAO,MAAM,GAAG,CAAC,CAAC,OAAS,CAAC;YAC1B;QACF,CAAC;AACH;AAEO,MAAM,kBAAkB,CAAC,YAA+B;IAC7D,MAAM,cAAc,OAAO,UAA+B;QAAE,MAAM;IAAU,CAAC;QAC3E,UAAU;YAAE,GAAG,sBAAsB,CAAC,QAAQ,IAAI,CAAC;YAAE,GAAG,OAAO;QAAC;QAChE,IAAI,CAAC,YAAY;YACf,OAAO;gBAAE,OAAO,EAAE;gBAAoB,OAAO;YAA+B;QAC9E;QACA,IAAI;YACF,IAAI,IAAA,uKAAkB,KAAI;gBACxB,MAAM,YAAY,MAAM,gBAAgB,SAAS,YAAY;gBAC7D,MAAM,QAAQ,MAAM,kBAAkB;gBACtC,OAAO;oBAAE;gBAAM;YACjB,OAAO;gBACL,MAAM,WAAW,MAAM,cAAc;gBACrC,MAAM,QAAQ,gBAAgB;gBAC9B,OAAO;oBAAE;gBAAM;YACjB;QACF,EAAE,OAAO,OAAO;YACd,OAAO;gBACL,OAAO,EAAE;gBACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;YAClD;QACF;IACF;IACA,OAAO;QACL;IACF;AACF;AAEO,MAAM,yBAAyB;IACpC,SAAS;QACP,QAAQ;QACR,YAAY;YAAC;SAAI;QACjB,aAAa,IAAA,0JAAC,EAAC;IACjB;IACA,QAAQ;QACN,QAAQ;QACR,YAAY;YAAC;YAAO;YAAQ;YAAO;YAAO;YAAQ;SAAM;QACxD,aAAa,IAAA,0JAAC,EAAC;IACjB;IACA,QAAQ;QACN,QAAQ;QACR,YAAY;YAAC;YAAO;YAAO;YAAO;YAAO;YAAO;SAAO;QACvD,aAAa,IAAA,0JAAC,EAAC;IACjB;IACA,OAAO;QACL,QAAQ;QACR,YAAY;YAAC;YAAO;YAAO;YAAO;YAAQ;SAAM;QAChD,aAAa,IAAA,0JAAC,EAAC;IACjB;IACA,OAAO;QACL,QAAQ,sKAAmB;QAC3B,YAAY,sKAAmB;QAC/B,aAAa,IAAA,0JAAC,EAAC;IACjB;IACA,OAAO;QACL,QAAQ;QACR,YAAY;YAAC;YAAO;YAAO;YAAQ;SAAQ;QAC3C,aAAa,IAAA,0JAAC,EAAC;IACjB;IACA,QAAQ;QACN,QAAQ;QACR,YAAY;YAAC;YAAO;YAAO;YAAQ;SAAM;QACzC,aAAa,IAAA,0JAAC,EAAC;IACjB;AACF"}},
    {"offset": {"line": 983, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useShortcuts.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useState } from 'react';\nimport { loadShortcuts, ShortcutConfig } from '../helpers/shortcuts';\n\nexport type KeyActionHandlers = {\n  [K in keyof ShortcutConfig]?: (event?: KeyboardEvent | MessageEvent) => void;\n};\n\nconst useShortcuts = (actions: KeyActionHandlers, dependencies: React.DependencyList = []) => {\n  const [shortcuts, setShortcuts] = useState<ShortcutConfig>(loadShortcuts);\n\n  useEffect(() => {\n    const handleShortcutUpdate = () => {\n      setShortcuts(loadShortcuts());\n    };\n\n    window.addEventListener('shortcutUpdate', handleShortcutUpdate);\n    return () => window.removeEventListener('shortcutUpdate', handleShortcutUpdate);\n  }, []);\n\n  const parseShortcut = (shortcut: string) => {\n    const keys = shortcut.toLowerCase().split('+');\n    return {\n      ctrlKey: keys.includes('ctrl'),\n      altKey: keys.includes('alt') || keys.includes('opt'),\n      metaKey: keys.includes('meta') || keys.includes('cmd'),\n      shiftKey: keys.includes('shift'),\n      key: keys.find((k) => !['ctrl', 'alt', 'opt', 'meta', 'cmd', 'shift'].includes(k)),\n    };\n  };\n\n  const isShortcutMatch = (\n    shortcut: string,\n    key: string,\n    ctrlKey: boolean,\n    altKey: boolean,\n    metaKey: boolean,\n    shiftKey: boolean,\n  ) => {\n    const parsedShortcut = parseShortcut(shortcut);\n    return (\n      parsedShortcut.key === key.toLowerCase() &&\n      parsedShortcut.ctrlKey === ctrlKey &&\n      parsedShortcut.altKey === altKey &&\n      parsedShortcut.metaKey === metaKey &&\n      parsedShortcut.shiftKey === shiftKey\n    );\n  };\n\n  const processKeyEvent = (\n    key: string,\n    ctrlKey: boolean,\n    altKey: boolean,\n    metaKey: boolean,\n    shiftKey: boolean,\n    event: KeyboardEvent | MessageEvent,\n  ) => {\n    // FIXME: This is a temporary fix to disable Back button navigation\n    if (key === 'backspace') return true;\n    for (const [actionName, actionHandler] of Object.entries(actions)) {\n      const shortcutKey = actionName as keyof ShortcutConfig;\n      const handler = actionHandler as\n        | ((event?: KeyboardEvent | MessageEvent) => void | boolean)\n        | undefined;\n      const shortcutList = shortcuts[shortcutKey as keyof ShortcutConfig];\n      // console.log('Checking action:', shortcutKey);\n      if (\n        handler &&\n        shortcutList?.some((shortcut) =>\n          isShortcutMatch(shortcut, key, ctrlKey, altKey, metaKey, shiftKey),\n        )\n      ) {\n        if (handler(event)) {\n          return true;\n        }\n      }\n    }\n    return false;\n  };\n\n  const unifiedHandleKeyDown = (event: KeyboardEvent | MessageEvent) => {\n    // Check if the focus is on an input, textarea, or contenteditable element\n    const activeElement = document.activeElement as HTMLElement;\n    const isInteractiveElement =\n      activeElement.tagName === 'INPUT' ||\n      activeElement.tagName === 'TEXTAREA' ||\n      activeElement.isContentEditable;\n\n    const isNoteEditor =\n      activeElement.tagName === 'TEXTAREA' && activeElement.classList.contains('note-editor');\n\n    if (isInteractiveElement && !isNoteEditor) {\n      return; // Skip handling if the user is typing in an input, textarea, or contenteditable\n    }\n\n    if (event instanceof KeyboardEvent) {\n      const { key, ctrlKey, altKey, metaKey, shiftKey } = event;\n\n      if (isNoteEditor && !((key === 'Enter' && ctrlKey) || key == 'Escape')) {\n        return;\n      }\n\n      const handled = processKeyEvent(key.toLowerCase(), ctrlKey, altKey, metaKey, shiftKey, event);\n      // console.log('Key event handled:', key, handled);\n      if (handled) event.preventDefault();\n    } else if (\n      event instanceof MessageEvent &&\n      event.data &&\n      event.data.type === 'iframe-keydown'\n    ) {\n      const { key, ctrlKey, altKey, metaKey, shiftKey } = event.data;\n      processKeyEvent(key.toLowerCase(), ctrlKey, altKey, metaKey, shiftKey, event);\n    }\n  };\n\n  useEffect(() => {\n    window.addEventListener('keydown', unifiedHandleKeyDown);\n    window.addEventListener('message', unifiedHandleKeyDown);\n\n    return () => {\n      window.removeEventListener('keydown', unifiedHandleKeyDown);\n      window.removeEventListener('message', unifiedHandleKeyDown);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [shortcuts, ...dependencies]);\n};\n\nexport default useShortcuts;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1079, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useTrafficLight.ts"],"sourcesContent":["'use client';\n\nimport { useEffect } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useTrafficLightStore } from '@/store/trafficLightStore';\n\nexport const useTrafficLight = () => {\n  const { appService } = useEnv();\n\n  const {\n    isTrafficLightVisible,\n    initializeTrafficLightStore,\n    initializeTrafficLightListeners,\n    setTrafficLightVisibility,\n    cleanupTrafficLightListeners,\n  } = useTrafficLightStore();\n\n  useEffect(() => {\n    if (!appService?.hasTrafficLight) return;\n\n    initializeTrafficLightStore(appService);\n    initializeTrafficLightListeners();\n    setTrafficLightVisibility(true);\n    return () => {\n      cleanupTrafficLightListeners();\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [appService?.hasTrafficLight]);\n\n  return { isTrafficLightVisible };\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;;;;;AAJA;;;;AAMO,MAAM,kBAAkB;IAC7B,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAE7B,MAAM,EACJ,qBAAqB,EACrB,2BAA2B,EAC3B,+BAA+B,EAC/B,yBAAyB,EACzB,4BAA4B,EAC7B,GAAG,IAAA,4KAAoB;IAExB,IAAA,gHAAS,EAAC;QACR,IAAI,CAAC,YAAY,iBAAiB;QAElC,4BAA4B;QAC5B;QACA,0BAA0B;QAC1B,OAAO;YACL;QACF;IACA,uDAAuD;IACzD,GAAG;QAAC,YAAY;KAAgB;IAEhC,OAAO;QAAE;IAAsB;AACjC"}},
    {"offset": {"line": 1120, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useSync.ts"],"sourcesContent":["'use client';\n\nimport { useCallback, useEffect, useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useSyncContext } from '@/context/SyncContext';\nimport { SyncData, SyncOp, SyncResult, SyncType } from '@/libs/sync';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { transformBookConfigFromDB } from '@/utils/transform';\nimport { transformBookNoteFromDB } from '@/utils/transform';\nimport { transformBookFromDB } from '@/utils/transform';\nimport { DBBook, DBBookConfig, DBBookNote } from '@/types/records';\nimport { Book, BookConfig, BookDataRecord, BookNote } from '@/types/book';\nimport { navigateToLogin } from '@/utils/nav';\nimport { useReaderStore } from '@/store/readerStore';\n\nconst transformsFromDB = {\n  books: transformBookFromDB,\n  notes: transformBookNoteFromDB,\n  configs: transformBookConfigFromDB,\n};\n\nconst computeMaxTimestamp = (records: BookDataRecord[]): number => {\n  let maxTime = 0;\n  for (const rec of records) {\n    if (rec.updated_at) {\n      const updatedTime = new Date(rec.updated_at).getTime();\n      maxTime = Math.max(maxTime, updatedTime);\n    }\n    if (rec.deleted_at) {\n      const deletedTime = new Date(rec.deleted_at).getTime();\n      maxTime = Math.max(maxTime, deletedTime);\n    }\n  }\n  return maxTime;\n};\n\nconst ONE_DAY_IN_MS = 24 * 60 * 60 * 1000;\nexport function useSync(bookKey?: string) {\n  const router = useRouter();\n  const { settings, setSettings } = useSettingsStore();\n  const { getConfig, setConfig } = useBookDataStore();\n  const { setIsSyncing } = useReaderStore();\n  const config = bookKey ? getConfig(bookKey) : null;\n\n  const [syncingBooks, setSyncingBooks] = useState(false);\n  const [syncingConfigs, setSyncingConfigs] = useState(false);\n  const [syncingNotes, setSyncingNotes] = useState(false);\n  const [syncError, setSyncError] = useState<string | null>(null);\n  const [lastSyncedAtBooks, setLastSyncedAtBooks] = useState<number>(0);\n  const [lastSyncedAtConfigs, setLastSyncedAtConfigs] = useState<number>(0);\n  const [lastSyncedAtNotes, setLastSyncedAtNotes] = useState<number>(0);\n  const [lastSyncedAtInited, setLastSyncedAtInited] = useState(false);\n\n  const [syncing, setSyncing] = useState(false);\n  // null means unsynced, empty array means synced no changes\n  const [syncResult, setSyncResult] = useState<SyncResult>({\n    books: null,\n    configs: null,\n    notes: null,\n  });\n  const [syncedBooks, setSyncedBooks] = useState<Book[] | null>(null);\n  const [syncedConfigs, setSyncedConfigs] = useState<BookConfig[] | null>(null);\n  const [syncedNotes, setSyncedNotes] = useState<BookNote[] | null>(null);\n\n  const { syncClient } = useSyncContext();\n\n  useEffect(() => {\n    if (!bookKey) return;\n    setIsSyncing(bookKey, syncing);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey, syncing]);\n\n  useEffect(() => {\n    if (!settings.version) return;\n    if (bookKey && !config?.location) return;\n    if (lastSyncedAtInited) return;\n\n    const lastSyncedBooksAt = settings.lastSyncedAtBooks ?? 0;\n    const lastSyncedConfigsAt = config?.lastSyncedAtConfig ?? settings.lastSyncedAtConfigs ?? 0;\n    const lastSyncedNotesAt = config?.lastSyncedAtNotes ?? settings.lastSyncedAtNotes ?? 0;\n    const now = Date.now();\n    setLastSyncedAtBooks(\n      now - lastSyncedBooksAt > 3 * ONE_DAY_IN_MS ? 0 : lastSyncedBooksAt - ONE_DAY_IN_MS,\n    );\n    setLastSyncedAtConfigs(\n      now - lastSyncedConfigsAt > 3 * ONE_DAY_IN_MS ? 0 : lastSyncedConfigsAt - ONE_DAY_IN_MS,\n    );\n    setLastSyncedAtNotes(\n      now - lastSyncedNotesAt > 3 * ONE_DAY_IN_MS ? 0 : lastSyncedNotesAt - ONE_DAY_IN_MS,\n    );\n    setLastSyncedAtInited(true);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey, settings, config]);\n\n  // bookId is for configs and notes only, if bookId is provided, only pull changes for that book\n  // and update the lastSyncedAt for that book in the book config\n  const pullChanges = async (\n    type: SyncType,\n    since: number,\n    setLastSyncedAt: React.Dispatch<React.SetStateAction<number>>,\n    setSyncing: React.Dispatch<React.SetStateAction<boolean>>,\n    bookId?: string,\n    metaHash?: string,\n  ) => {\n    setSyncing(true);\n    setSyncError(null);\n\n    try {\n      const result = await syncClient.pullChanges(since, type, bookId, metaHash);\n      setSyncResult({ ...syncResult, [type]: result[type] });\n      const records = result[type];\n      if (since > 0 && !records?.length) return;\n      // For since = 0, we set lastSyncedAt to now if no records returned\n      const maxTime = records?.length ? computeMaxTimestamp(records) : Date.now();\n      setLastSyncedAt(maxTime);\n\n      // due to closures in React hooks the settings might be stale\n      // we need to fetch the latest settings from store\n      const settings = useSettingsStore.getState().settings;\n      switch (type) {\n        case 'books':\n          settings.lastSyncedAtBooks = maxTime;\n          setSettings(settings);\n          break;\n        case 'configs':\n          if (!bookId) {\n            settings.lastSyncedAtConfigs = maxTime;\n            setSettings(settings);\n          } else if (bookKey) {\n            setConfig(bookKey, { lastSyncedAtConfig: maxTime });\n          }\n          break;\n        case 'notes':\n          if (!bookId) {\n            settings.lastSyncedAtNotes = maxTime;\n            setSettings(settings);\n          } else if (bookKey) {\n            setConfig(bookKey, { lastSyncedAtNotes: maxTime });\n          }\n          break;\n      }\n    } catch (err: unknown) {\n      console.error(err);\n      if (err instanceof Error) {\n        if (err.message.includes('Not authenticated') && settings.keepLogin) {\n          settings.keepLogin = false;\n          setSettings(settings);\n          navigateToLogin(router);\n        }\n        setSyncError(err.message || `Error pulling ${type}`);\n      } else {\n        setSyncError(`Error pulling ${type}`);\n      }\n    } finally {\n      setSyncing(false);\n    }\n  };\n\n  const pushChanges = async (payload: SyncData) => {\n    setSyncing(true);\n    setSyncError(null);\n\n    try {\n      const result = await syncClient.pushChanges(payload);\n      setSyncResult(result);\n    } catch (err: unknown) {\n      console.error(err);\n      if (err instanceof Error) {\n        setSyncError(err.message || 'Error pushing changes');\n      } else {\n        setSyncError('Error pushing changes');\n      }\n    } finally {\n      setSyncing(false);\n    }\n  };\n\n  const syncBooks = useCallback(\n    async (books?: Book[], op: SyncOp = 'both') => {\n      if (!lastSyncedAtInited) return;\n      if ((op === 'push' || op === 'both') && books?.length) {\n        await pushChanges({ books });\n      }\n      if (op === 'pull' || op === 'both') {\n        await pullChanges('books', lastSyncedAtBooks + 1, setLastSyncedAtBooks, setSyncingBooks);\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [lastSyncedAtInited, lastSyncedAtBooks],\n  );\n\n  const syncConfigs = useCallback(\n    async (bookConfigs?: BookConfig[], bookId?: string, metaHash?: string, op: SyncOp = 'both') => {\n      if (!bookId && !lastSyncedAtInited) return;\n      if ((op === 'push' || op === 'both') && bookConfigs?.length) {\n        await pushChanges({ configs: bookConfigs });\n      }\n      if (op === 'pull' || op === 'both') {\n        await pullChanges(\n          'configs',\n          lastSyncedAtConfigs,\n          setLastSyncedAtConfigs,\n          setSyncingConfigs,\n          bookId,\n          metaHash,\n        );\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [lastSyncedAtInited, lastSyncedAtConfigs],\n  );\n\n  const syncNotes = useCallback(\n    async (bookNotes?: BookNote[], bookId?: string, metaHash?: string, op: SyncOp = 'both') => {\n      if (!lastSyncedAtInited) return;\n      if ((op === 'push' || op === 'both') && bookNotes?.length) {\n        await pushChanges({ notes: bookNotes });\n      }\n      if (op === 'pull' || op === 'both') {\n        await pullChanges(\n          'notes',\n          lastSyncedAtNotes,\n          setLastSyncedAtNotes,\n          setSyncingNotes,\n          bookId,\n          metaHash,\n        );\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [lastSyncedAtInited, lastSyncedAtNotes],\n  );\n\n  useEffect(() => {\n    if (!syncing && syncResult) {\n      const { books: dbBooks, configs: dbBookConfigs, notes: dbBookNotes } = syncResult;\n      const books = dbBooks?.map((dbBook) =>\n        transformsFromDB['books'](dbBook as unknown as DBBook),\n      );\n      const configs = dbBookConfigs?.map((dbBookConfig) =>\n        transformsFromDB['configs'](dbBookConfig as unknown as DBBookConfig),\n      );\n      const notes = dbBookNotes?.map((dbBookNote) =>\n        transformsFromDB['notes'](dbBookNote as unknown as DBBookNote),\n      );\n      if (books) setSyncedBooks(books);\n      if (configs) setSyncedConfigs(configs);\n      if (notes) setSyncedNotes(notes);\n    }\n  }, [syncResult, syncing]);\n\n  return {\n    syncing: syncingBooks || syncingConfigs || syncingNotes,\n    syncError,\n    syncResult,\n    syncedBooks,\n    syncedConfigs,\n    syncedNotes,\n    lastSyncedAtBooks,\n    lastSyncedAtNotes,\n    lastSyncedAtConfigs,\n    useSyncInited: lastSyncedAtInited,\n    pullChanges,\n    pushChanges,\n    syncBooks,\n    syncConfigs,\n    syncNotes,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1381, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useAutoFocus.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef } from 'react';\n\ninterface UseAutoFocusOptions {\n  ref?: React.RefObject<HTMLElement | null>;\n  delay?: number;\n  condition?: boolean;\n  preventScroll?: boolean;\n}\n\nexport const useAutoFocus = <T extends HTMLElement = HTMLDivElement>(\n  options: UseAutoFocusOptions = {},\n) => {\n  const { delay = 0, condition = true, preventScroll = false, ref } = options;\n  const localRef = useRef<T>(null);\n  const focusRef = ref || localRef;\n\n  useEffect(() => {\n    if (condition && focusRef.current) {\n      const focusElement = () => {\n        focusRef.current?.focus({ preventScroll });\n      };\n\n      if (delay > 0) {\n        const timer = setTimeout(focusElement, delay);\n        return () => clearTimeout(timer);\n      } else {\n        focusElement();\n      }\n    }\n    return;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [condition, delay, preventScroll]);\n\n  return focusRef as React.RefObject<T>;\n};\n"],"names":[],"mappings":";;;;AAEA;AAFA;;AAWO,MAAM,eAAe,CAC1B,UAA+B,CAAC,CAAC;IAEjC,MAAM,EAAE,QAAQ,CAAC,EAAE,YAAY,IAAI,EAAE,gBAAgB,KAAK,EAAE,GAAG,EAAE,GAAG;IACpE,MAAM,WAAW,IAAA,6GAAM,EAAI;IAC3B,MAAM,WAAW,OAAO;IAExB,IAAA,gHAAS,EAAC;QACR,IAAI,aAAa,SAAS,OAAO,EAAE;YACjC,MAAM,eAAe;gBACnB,SAAS,OAAO,EAAE,MAAM;oBAAE;gBAAc;YAC1C;YAEA,IAAI,QAAQ,GAAG;gBACb,MAAM,QAAQ,WAAW,cAAc;gBACvC,OAAO,IAAM,aAAa;YAC5B,OAAO;gBACL;YACF;QACF;QACA;IACA,uDAAuD;IACzD,GAAG;QAAC;QAAW;QAAO;KAAc;IAEpC,OAAO;AACT"}},
    {"offset": {"line": 1421, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useUICSS.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useState } from 'react';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSettingsStore } from '@/store/settingsStore';\n\n// This hook allows you to inject custom CSS into the reader UI.\n// Note that the book content is rendered in an iframe, so UI CSS won't affect book rendering.\nexport const useUICSS = (bookKey?: string) => {\n  const { settings } = useSettingsStore();\n  const { getViewSettings } = useReaderStore();\n  const viewSettings = getViewSettings(bookKey || '');\n  const [styleElement, setStyleElement] = useState<HTMLStyleElement | null>(null);\n\n  useEffect(() => {\n    if (styleElement) {\n      styleElement.remove();\n    }\n\n    const rawCSS =\n      viewSettings?.userUIStylesheet || settings?.globalViewSettings?.userUIStylesheet || '';\n\n    const newStyleEl = document.createElement('style');\n    newStyleEl.textContent = rawCSS.replace('foliate-view', `#foliate-view-${bookKey}`);\n    document.head.appendChild(newStyleEl);\n    setStyleElement(newStyleEl);\n\n    return () => {\n      newStyleEl.remove();\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewSettings?.userUIStylesheet, settings?.globalViewSettings?.userUIStylesheet, bookKey]);\n};\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;;;;;;AAJA;;;;AAQO,MAAM,WAAW,CAAC;IACvB,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,oKAAgB;IACrC,MAAM,EAAE,eAAe,EAAE,GAAG,IAAA,gKAAc;IAC1C,MAAM,eAAe,gBAAgB,WAAW;IAChD,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,+GAAQ,EAA0B;IAE1E,IAAA,gHAAS,EAAC;QACR,IAAI,cAAc;YAChB,aAAa,MAAM;QACrB;QAEA,MAAM,SACJ,cAAc,oBAAoB,UAAU,oBAAoB,oBAAoB;QAEtF,MAAM,aAAa,SAAS,aAAa,CAAC;QAC1C,WAAW,WAAW,GAAG,OAAO,OAAO,CAAC,gBAAgB,CAAC,cAAc,EAAE,SAAS;QAClF,SAAS,IAAI,CAAC,WAAW,CAAC;QAC1B,gBAAgB;QAEhB,OAAO;YACL,WAAW,MAAM;QACnB;IACA,uDAAuD;IACzD,GAAG;QAAC,cAAc;QAAkB,UAAU,oBAAoB;QAAkB;KAAQ;AAC9F"}},
    {"offset": {"line": 1468, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useDiscordPresence.ts"],"sourcesContent":["'use client';\n\nimport { useEffect, useRef } from 'react';\nimport { Book } from '@/types/book';\nimport { useEnv } from '@/context/EnvContext';\nimport { updateDiscordPresence, clearDiscordPresence } from '@/utils/discord';\n\n/**\n * Hook to manage Discord Rich Presence for a book\n * @param book - Current book being read (null if no book)\n * @param isPrimary - Whether this is the primary book (for multi-book scenarios)\n */\nexport const useDiscordPresence = (book: Book | null, isPrimary: boolean, enabled: boolean) => {\n  const { appService } = useEnv();\n\n  const sessionStartRef = useRef<number>(Date.now());\n  const updateIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const currentBookHashRef = useRef<string | null>(null);\n  const isUpdatingRef = useRef<boolean>(false);\n\n  useEffect(() => {\n    if (!isPrimary || !book) return;\n    if (!appService?.isDesktopApp) return;\n\n    const stopUpdates = () => {\n      if (updateIntervalRef.current) {\n        clearInterval(updateIntervalRef.current);\n        updateIntervalRef.current = null;\n      }\n      isUpdatingRef.current = false;\n    };\n\n    if (!enabled) {\n      stopUpdates();\n      clearDiscordPresence(appService);\n      currentBookHashRef.current = null;\n      return;\n    }\n\n    if (currentBookHashRef.current !== book.hash) {\n      sessionStartRef.current = Date.now();\n      currentBookHashRef.current = book.hash;\n    }\n\n    const safeUpdate = async () => {\n      if (isUpdatingRef.current) return;\n\n      isUpdatingRef.current = true;\n      try {\n        await updateDiscordPresence(book, sessionStartRef.current, appService);\n      } catch (err) {\n        console.error('Discord presence update failed:', err);\n      } finally {\n        isUpdatingRef.current = false;\n      }\n    };\n\n    void safeUpdate();\n\n    updateIntervalRef.current = setInterval(() => {\n      void safeUpdate();\n    }, 15000);\n\n    return () => {\n      stopUpdates();\n      clearDiscordPresence(appService);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [book?.hash, isPrimary, enabled, appService]);\n};\n"],"names":[],"mappings":";;;;AAEA;AAEA;AACA;;;;;AALA;;;;AAYO,MAAM,qBAAqB,CAAC,MAAmB,WAAoB;IACxE,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAE7B,MAAM,kBAAkB,IAAA,6GAAM,EAAS,KAAK,GAAG;IAC/C,MAAM,oBAAoB,IAAA,6GAAM,EAAwB;IACxD,MAAM,qBAAqB,IAAA,6GAAM,EAAgB;IACjD,MAAM,gBAAgB,IAAA,6GAAM,EAAU;IAEtC,IAAA,gHAAS,EAAC;QACR,IAAI,CAAC,aAAa,CAAC,MAAM;QACzB,IAAI,CAAC,YAAY,cAAc;QAE/B,MAAM,cAAc;YAClB,IAAI,kBAAkB,OAAO,EAAE;gBAC7B,cAAc,kBAAkB,OAAO;gBACvC,kBAAkB,OAAO,GAAG;YAC9B;YACA,cAAc,OAAO,GAAG;QAC1B;QAEA,IAAI,CAAC,SAAS;YACZ;YACA,IAAA,kKAAoB,EAAC;YACrB,mBAAmB,OAAO,GAAG;YAC7B;QACF;QAEA,IAAI,mBAAmB,OAAO,KAAK,KAAK,IAAI,EAAE;YAC5C,gBAAgB,OAAO,GAAG,KAAK,GAAG;YAClC,mBAAmB,OAAO,GAAG,KAAK,IAAI;QACxC;QAEA,MAAM,aAAa;YACjB,IAAI,cAAc,OAAO,EAAE;YAE3B,cAAc,OAAO,GAAG;YACxB,IAAI;gBACF,MAAM,IAAA,mKAAqB,EAAC,MAAM,gBAAgB,OAAO,EAAE;YAC7D,EAAE,OAAO,KAAK;gBACZ,QAAQ,KAAK,CAAC,mCAAmC;YACnD,SAAU;gBACR,cAAc,OAAO,GAAG;YAC1B;QACF;QAEA,KAAK;QAEL,kBAAkB,OAAO,GAAG,YAAY;YACtC,KAAK;QACP,GAAG;QAEH,OAAO;YACL;YACA,IAAA,kKAAoB,EAAC;QACvB;IACA,uDAAuD;IACzD,GAAG;QAAC,MAAM;QAAM;QAAW;QAAS;KAAW;AACjD"}},
    {"offset": {"line": 1541, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/hooks/useResetSettings.ts"],"sourcesContent":["import { Dispatch, SetStateAction } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { ViewSettings } from '@/types/book';\n\ntype SetterKey = keyof ViewSettings;\ntype SetterValue = SetStateAction<string> & SetStateAction<number> & SetStateAction<boolean>;\n\ntype StateSetters = Partial<{\n  [Key in SetterKey]: Dispatch<SetterValue>;\n}>;\n\nexport const useResetViewSettings = () => {\n  const { appService } = useEnv();\n\n  const resetToDefaults = (setters: StateSetters) => {\n    if (!appService) return;\n    const defaultSettings = appService.getDefaultViewSettings();\n\n    Object.entries(setters).forEach(([settingKey, setter]) => {\n      const freshValue = defaultSettings[settingKey as SetterKey];\n      if (freshValue !== undefined) {\n        setter(freshValue as SetterValue);\n      }\n    });\n  };\n\n  return resetToDefaults;\n};\n"],"names":[],"mappings":";;;;AACA;;AAUO,MAAM,uBAAuB;IAClC,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAM;IAE7B,MAAM,kBAAkB,CAAC;QACvB,IAAI,CAAC,YAAY;QACjB,MAAM,kBAAkB,WAAW,sBAAsB;QAEzD,OAAO,OAAO,CAAC,SAAS,OAAO,CAAC,CAAC,CAAC,YAAY,OAAO;YACnD,MAAM,aAAa,eAAe,CAAC,WAAwB;YAC3D,IAAI,eAAe,WAAW;gBAC5B,OAAO;YACT;QACF;IACF;IAEA,OAAO;AACT"}},
    {"offset": {"line": 1567, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/libraryStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { Book, BookGroupType, BooksGroup } from '@/types/book';\nimport { EnvConfigType, isTauriAppPlatform } from '@/services/environment';\nimport { BOOK_UNGROUPED_NAME } from '@/services/constants';\nimport { md5Fingerprint } from '@/utils/md5';\n\ninterface LibraryState {\n  library: Book[]; // might contain deleted books\n  isSyncing: boolean;\n  syncProgress: number;\n  checkOpenWithBooks: boolean;\n  checkLastOpenBooks: boolean;\n  currentBookshelf: (Book | BooksGroup)[];\n  selectedBooks: Set<string>; // hashes for books, ids for groups\n  groups: Record<string, string>;\n  setIsSyncing: (syncing: boolean) => void;\n  setSyncProgress: (progress: number) => void;\n  setSelectedBooks: (ids: string[]) => void;\n  getSelectedBooks: () => string[];\n  toggleSelectedBook: (id: string) => void;\n  getVisibleLibrary: () => Book[];\n  setCheckOpenWithBooks: (check: boolean) => void;\n  setCheckLastOpenBooks: (check: boolean) => void;\n  setLibrary: (books: Book[]) => void;\n  updateBook: (envConfig: EnvConfigType, book: Book) => void;\n  updateBooks: (envConfig: EnvConfigType, books: Book[]) => void;\n  setCurrentBookshelf: (bookshelf: (Book | BooksGroup)[]) => void;\n  refreshGroups: () => void;\n  addGroup: (name: string) => BookGroupType;\n  getGroups: () => BookGroupType[];\n  getGroupId: (path: string) => string | undefined;\n  getGroupName: (id: string) => string | undefined;\n  getParentPath: (path: string) => string | undefined;\n  getGroupsByParent: (parentPath?: string) => BookGroupType[];\n}\n\nexport const useLibraryStore = create<LibraryState>((set, get) => ({\n  library: [],\n  isSyncing: false,\n  syncProgress: 0,\n  currentBookshelf: [],\n  selectedBooks: new Set(),\n  groups: {},\n  checkOpenWithBooks: isTauriAppPlatform(),\n  checkLastOpenBooks: isTauriAppPlatform(),\n\n  setIsSyncing: (syncing: boolean) => set({ isSyncing: syncing }),\n  setSyncProgress: (progress: number) => set({ syncProgress: progress }),\n  getVisibleLibrary: () => get().library.filter((book) => !book.deletedAt),\n\n  setCurrentBookshelf: (bookshelf: (Book | BooksGroup)[]) => {\n    set({ currentBookshelf: bookshelf });\n  },\n\n  setCheckOpenWithBooks: (check) => set({ checkOpenWithBooks: check }),\n  setCheckLastOpenBooks: (check) => set({ checkLastOpenBooks: check }),\n  setLibrary: (books) => {\n    const { refreshGroups } = get();\n    set({ library: books });\n    refreshGroups();\n  },\n  updateBook: async (envConfig: EnvConfigType, book: Book) => {\n    const appService = await envConfig.getAppService();\n    const { library } = get();\n    const bookIndex = library.findIndex((b) => b.hash === book.hash);\n    if (bookIndex !== -1) {\n      library[bookIndex] = book;\n    }\n    set({ library: [...library] });\n    await appService.saveLibraryBooks(library);\n  },\n  updateBooks: async (envConfig: EnvConfigType, books: Book[]) => {\n    if (!books?.length) return;\n\n    const appService = await envConfig.getAppService();\n    const { library, refreshGroups } = get();\n\n    const newLibrary = Array.from(new Map([...library, ...books].map((b) => [b.hash, b])).values());\n    set({ library: newLibrary });\n    refreshGroups();\n    await appService.saveLibraryBooks(newLibrary);\n  },\n\n  setSelectedBooks: (ids: string[]) => {\n    set({ selectedBooks: new Set(ids) });\n  },\n\n  getSelectedBooks: () => {\n    return Array.from(get().selectedBooks);\n  },\n\n  toggleSelectedBook: (id: string) => {\n    set((state) => {\n      const newSelection = new Set(state.selectedBooks);\n      if (newSelection.has(id)) {\n        newSelection.delete(id);\n      } else {\n        newSelection.add(id);\n      }\n      return { selectedBooks: newSelection };\n    });\n  },\n\n  refreshGroups: () => {\n    const { library } = get();\n    const groups: Record<string, string> = {};\n\n    library.forEach((book) => {\n      if (book.groupName && book.groupName !== BOOK_UNGROUPED_NAME && !book.deletedAt) {\n        groups[md5Fingerprint(book.groupName)] = book.groupName;\n        let nextSlashIndex = book.groupName.indexOf('/', 0);\n        while (nextSlashIndex > 0) {\n          const groupName = book.groupName.substring(0, nextSlashIndex);\n          groups[md5Fingerprint(groupName)] = groupName;\n          nextSlashIndex = book.groupName.indexOf('/', nextSlashIndex + 1);\n        }\n      }\n    });\n\n    set({ groups });\n  },\n\n  addGroup: (name: string) => {\n    const trimmedName = name.trim();\n    if (!trimmedName) {\n      throw new Error('Group name cannot be empty');\n    }\n\n    const id = md5Fingerprint(trimmedName);\n    const { groups } = get();\n\n    set({ groups: { ...groups, [id]: trimmedName } });\n\n    return { id, name: trimmedName };\n  },\n\n  getGroups: () => {\n    const { groups } = get();\n    return Object.entries(groups)\n      .map(([id, name]) => ({ id, name }))\n      .sort((a, b) => a.name.localeCompare(b.name));\n  },\n\n  getGroupId: (path: string) => {\n    const { groups } = get();\n\n    const directId = Object.entries(groups).find(([_, name]) => name === path)?.[0];\n    if (directId) {\n      return directId;\n    }\n\n    return md5Fingerprint(path);\n  },\n\n  getGroupName: (id: string) => {\n    return get().groups[id];\n  },\n\n  getParentPath: (path: string) => {\n    const lastSlashIndex = path.lastIndexOf('/');\n    if (lastSlashIndex === -1) return '';\n    return path.slice(0, lastSlashIndex);\n  },\n\n  getGroupsByParent: (parentPath?: string) => {\n    const { groups } = get();\n    const result: BookGroupType[] = [];\n    Object.entries(groups).forEach(([id, name]) => {\n      const groupParentPath = get().getParentPath(name);\n      if (groupParentPath === (parentPath || '')) {\n        result.push({ id, name });\n      }\n    });\n    return result;\n  },\n}));\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1750, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/bookDataStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { SystemSettings } from '@/types/settings';\nimport { Book, BookConfig, BookNote } from '@/types/book';\nimport { EnvConfigType } from '@/services/environment';\nimport { BookDoc } from '@/libs/document';\nimport { useLibraryStore } from './libraryStore';\n\ninterface BookData {\n  /* Persistent data shared with different views of the same book */\n  id: string;\n  book: Book | null;\n  file: File | null;\n  config: BookConfig | null;\n  bookDoc: BookDoc | null;\n  isFixedLayout: boolean;\n}\n\ninterface BookDataState {\n  booksData: { [id: string]: BookData };\n  getConfig: (key: string | null) => BookConfig | null;\n  setConfig: (key: string, partialConfig: Partial<BookConfig>) => void;\n  saveConfig: (\n    envConfig: EnvConfigType,\n    bookKey: string,\n    config: BookConfig,\n    settings: SystemSettings,\n  ) => void;\n  updateBooknotes: (key: string, booknotes: BookNote[]) => BookConfig | undefined;\n  getBookData: (keyOrId: string) => BookData | null;\n  clearBookData: (keyOrId: string) => void;\n}\n\nexport const useBookDataStore = create<BookDataState>((set, get) => ({\n  booksData: {},\n  getBookData: (keyOrId: string) => {\n    const id = keyOrId.split('-')[0]!;\n    return get().booksData[id] || null;\n  },\n  clearBookData: (keyOrId: string) => {\n    const id = keyOrId.split('-')[0]!;\n    set((state) => {\n      const newBooksData = { ...state.booksData };\n      delete newBooksData[id];\n      return {\n        booksData: newBooksData,\n      };\n    });\n  },\n  getConfig: (key: string | null) => {\n    if (!key) return null;\n    const id = key.split('-')[0]!;\n    return get().booksData[id]?.config || null;\n  },\n  setConfig: (key: string, partialConfig: Partial<BookConfig>) => {\n    set((state: BookDataState) => {\n      const id = key.split('-')[0]!;\n      const config = (state.booksData[id]?.config || null) as BookConfig;\n      if (!config) {\n        console.warn('No config found for book', id);\n        return state;\n      }\n      Object.assign(config, partialConfig);\n      return {\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...state.booksData[id]!,\n            config,\n          },\n        },\n      };\n    });\n  },\n  saveConfig: async (\n    envConfig: EnvConfigType,\n    bookKey: string,\n    config: BookConfig,\n    settings: SystemSettings,\n  ) => {\n    const appService = await envConfig.getAppService();\n    const { library, setLibrary } = useLibraryStore.getState();\n    const bookIndex = library.findIndex((b) => b.hash === bookKey.split('-')[0]);\n    if (bookIndex == -1) return;\n    const book = library.splice(bookIndex, 1)[0]!;\n    book.progress = config.progress;\n    book.updatedAt = Date.now();\n    book.downloadedAt = book.downloadedAt || Date.now();\n    library.unshift(book);\n    setLibrary([...library]);\n    config.updatedAt = Date.now();\n    await appService.saveBookConfig(book, config, settings);\n    await appService.saveLibraryBooks(library);\n  },\n  updateBooknotes: (key: string, booknotes: BookNote[]) => {\n    let updatedConfig: BookConfig | undefined;\n    set((state) => {\n      const id = key.split('-')[0]!;\n      const book = state.booksData[id];\n      if (!book) return state;\n      const dedupedBooknotes = Array.from(\n        new Map(booknotes.map((item) => [`${item.id}-${item.type}-${item.cfi}`, item])).values(),\n      );\n      updatedConfig = {\n        ...book.config,\n        updatedAt: Date.now(),\n        booknotes: dedupedBooknotes,\n      };\n      return {\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...book,\n            config: {\n              ...book.config,\n              updatedAt: Date.now(),\n              booknotes: dedupedBooknotes,\n            },\n          },\n        },\n      };\n    });\n    return updatedConfig;\n  },\n}));\n"],"names":[],"mappings":";;;;AAAA;AAKA;;;;;;;;AA2BO,MAAM,mBAAmB,IAAA,wHAAM,EAAgB,CAAC,KAAK,MAAQ,CAAC;QACnE,WAAW,CAAC;QACZ,aAAa,CAAC;YACZ,MAAM,KAAK,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE;YAChC,OAAO,MAAM,SAAS,CAAC,GAAG,IAAI;QAChC;QACA,eAAe,CAAC;YACd,MAAM,KAAK,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE;YAChC,IAAI,CAAC;gBACH,MAAM,eAAe;oBAAE,GAAG,MAAM,SAAS;gBAAC;gBAC1C,OAAO,YAAY,CAAC,GAAG;gBACvB,OAAO;oBACL,WAAW;gBACb;YACF;QACF;QACA,WAAW,CAAC;YACV,IAAI,CAAC,KAAK,OAAO;YACjB,MAAM,KAAK,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE;YAC5B,OAAO,MAAM,SAAS,CAAC,GAAG,EAAE,UAAU;QACxC;QACA,WAAW,CAAC,KAAa;YACvB,IAAI,CAAC;gBACH,MAAM,KAAK,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE;gBAC5B,MAAM,SAAU,MAAM,SAAS,CAAC,GAAG,EAAE,UAAU;gBAC/C,IAAI,CAAC,QAAQ;oBACX,QAAQ,IAAI,CAAC,4BAA4B;oBACzC,OAAO;gBACT;gBACA,OAAO,MAAM,CAAC,QAAQ;gBACtB,OAAO;oBACL,WAAW;wBACT,GAAG,MAAM,SAAS;wBAClB,CAAC,GAAG,EAAE;4BACJ,GAAG,MAAM,SAAS,CAAC,GAAG;4BACtB;wBACF;oBACF;gBACF;YACF;QACF;QACA,YAAY,OACV,WACA,SACA,QACA;YAEA,MAAM,aAAa,MAAM,UAAU,aAAa;YAChD,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,kKAAe,CAAC,QAAQ;YACxD,MAAM,YAAY,QAAQ,SAAS,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE;YAC3E,IAAI,aAAa,CAAC,GAAG;YACrB,MAAM,OAAO,QAAQ,MAAM,CAAC,WAAW,EAAE,CAAC,EAAE;YAC5C,KAAK,QAAQ,GAAG,OAAO,QAAQ;YAC/B,KAAK,SAAS,GAAG,KAAK,GAAG;YACzB,KAAK,YAAY,GAAG,KAAK,YAAY,IAAI,KAAK,GAAG;YACjD,QAAQ,OAAO,CAAC;YAChB,WAAW;mBAAI;aAAQ;YACvB,OAAO,SAAS,GAAG,KAAK,GAAG;YAC3B,MAAM,WAAW,cAAc,CAAC,MAAM,QAAQ;YAC9C,MAAM,WAAW,gBAAgB,CAAC;QACpC;QACA,iBAAiB,CAAC,KAAa;YAC7B,IAAI;YACJ,IAAI,CAAC;gBACH,MAAM,KAAK,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE;gBAC5B,MAAM,OAAO,MAAM,SAAS,CAAC,GAAG;gBAChC,IAAI,CAAC,MAAM,OAAO;gBAClB,MAAM,mBAAmB,MAAM,IAAI,CACjC,IAAI,IAAI,UAAU,GAAG,CAAC,CAAC,OAAS;wBAAC,GAAG,KAAK,EAAE,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,CAAC,EAAE,KAAK,GAAG,EAAE;wBAAE;qBAAK,GAAG,MAAM;gBAExF,gBAAgB;oBACd,GAAG,KAAK,MAAM;oBACd,WAAW,KAAK,GAAG;oBACnB,WAAW;gBACb;gBACA,OAAO;oBACL,WAAW;wBACT,GAAG,MAAM,SAAS;wBAClB,CAAC,GAAG,EAAE;4BACJ,GAAG,IAAI;4BACP,QAAQ;gCACN,GAAG,KAAK,MAAM;gCACd,WAAW,KAAK,GAAG;gCACnB,WAAW;4BACb;wBACF;oBACF;gBACF;YACF;YACA,OAAO;QACT;IACF,CAAC"}},
    {"offset": {"line": 1862, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/readerStore.ts"],"sourcesContent":["import { create } from 'zustand';\n\nimport {\n  BookContent,\n  BookConfig,\n  PageInfo,\n  BookProgress,\n  ViewSettings,\n  TimeInfo,\n  FIXED_LAYOUT_FORMATS,\n} from '@/types/book';\nimport { Insets } from '@/types/misc';\nimport { EnvConfigType } from '@/services/environment';\nimport { FoliateView } from '@/types/view';\nimport { DocumentLoader, TOCItem } from '@/libs/document';\nimport { updateToc } from '@/utils/toc';\nimport { formatTitle, getMetadataHash, getPrimaryLanguage } from '@/utils/book';\nimport { getBaseFilename } from '@/utils/path';\nimport { SUPPORTED_LANGNAMES } from '@/services/constants';\nimport { useSettingsStore } from './settingsStore';\nimport { useBookDataStore } from './bookDataStore';\nimport { useLibraryStore } from './libraryStore';\nimport { uniqueId } from '@/utils/misc';\n\ninterface ViewState {\n  /* Unique key for each book view */\n  key: string;\n  view: FoliateView | null;\n  viewerKey: string;\n  isPrimary: boolean;\n  loading: boolean;\n  inited: boolean;\n  error: string | null;\n  progress: BookProgress | null;\n  ribbonVisible: boolean;\n  ttsEnabled: boolean;\n  syncing: boolean;\n  gridInsets: Insets | null;\n  /* View settings for the view: \n    generally view settings have a hierarchy of global settings < book settings < view settings\n    view settings for primary view are saved to book config which is persisted to config file\n    omitting settings that are not changed from global settings */\n  viewSettings: ViewSettings | null;\n}\n\ninterface ReaderStore {\n  viewStates: { [key: string]: ViewState };\n  bookKeys: string[];\n  hoveredBookKey: string | null;\n  setBookKeys: (keys: string[]) => void;\n  setHoveredBookKey: (key: string | null) => void;\n  setBookmarkRibbonVisibility: (key: string, visible: boolean) => void;\n  setTTSEnabled: (key: string, enabled: boolean) => void;\n  setIsSyncing: (key: string, syncing: boolean) => void;\n  setProgress: (\n    key: string,\n    location: string,\n    tocItem: TOCItem,\n    section: PageInfo,\n    pageinfo: PageInfo,\n    timeinfo: TimeInfo,\n    range: Range,\n  ) => void;\n  getProgress: (key: string) => BookProgress | null;\n  setView: (key: string, view: FoliateView) => void;\n  getView: (key: string | null) => FoliateView | null;\n  getViews: () => FoliateView[];\n  getViewsById: (id: string) => FoliateView[];\n  setViewSettings: (key: string, viewSettings: ViewSettings) => void;\n  getViewSettings: (key: string) => ViewSettings | null;\n\n  initViewState: (\n    envConfig: EnvConfigType,\n    id: string,\n    key: string,\n    isPrimary?: boolean,\n    reload?: boolean,\n  ) => Promise<void>;\n  clearViewState: (key: string) => void;\n  getViewState: (key: string) => ViewState | null;\n  getGridInsets: (key: string) => Insets | null;\n  setGridInsets: (key: string, insets: Insets | null) => void;\n  setViewInited: (key: string, inited: boolean) => void;\n  recreateViewer: (envConfig: EnvConfigType, key: string) => void;\n}\n\nexport const useReaderStore = create<ReaderStore>((set, get) => ({\n  viewStates: {},\n  bookKeys: [],\n  hoveredBookKey: null,\n  setBookKeys: (keys: string[]) => set({ bookKeys: keys }),\n  setHoveredBookKey: (key: string | null) => set({ hoveredBookKey: key }),\n  getView: (key: string | null) => (key && get().viewStates[key]?.view) || null,\n  setView: (key: string, view) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: { ...state.viewStates[key]!, view },\n      },\n    })),\n  getViews: () => Object.values(get().viewStates).map((state) => state.view!),\n  getViewsById: (id: string) => {\n    const { viewStates } = get();\n    return Object.values(viewStates)\n      .filter((state) => state.key && state.key.startsWith(id))\n      .map((state) => state.view!);\n  },\n\n  clearViewState: (key: string) => {\n    set((state) => {\n      const viewStates = { ...state.viewStates };\n      delete viewStates[key];\n      return { viewStates };\n    });\n  },\n  getViewState: (key: string) => get().viewStates[key] || null,\n  initViewState: async (\n    envConfig: EnvConfigType,\n    id: string,\n    key: string,\n    isPrimary = true,\n    reload = false,\n  ) => {\n    const booksData = useBookDataStore.getState().booksData;\n    const bookData = booksData[id];\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          key: '',\n          view: null,\n          viewerKey: '',\n          isPrimary: false,\n          loading: true,\n          inited: false,\n          error: null,\n          progress: null,\n          ribbonVisible: false,\n          ttsEnabled: false,\n          syncing: false,\n          gridInsets: null,\n          viewSettings: null,\n        },\n      },\n    }));\n    try {\n      const appService = await envConfig.getAppService();\n      const { settings } = useSettingsStore.getState();\n      const { library } = useLibraryStore.getState();\n      const book = library.find((b) => b.hash === id);\n      if (!book) {\n        throw new Error('Book not found');\n      }\n      let bookDoc = bookData?.bookDoc;\n      let file = bookData?.file;\n      if (!bookDoc || !file || reload) {\n        const content = (await appService.loadBookContent(book)) as BookContent;\n        file = content.file;\n        console.log('Loading book', key);\n        const doc = await new DocumentLoader(file).open();\n        bookDoc = doc.book;\n      }\n      const config = await appService.loadBookConfig(book, settings);\n      await updateToc(\n        bookDoc,\n        config.viewSettings?.sortedTOC ?? false,\n        config.viewSettings?.convertChineseVariant ?? 'none',\n      );\n      if (!bookDoc.metadata.title) {\n        bookDoc.metadata.title = getBaseFilename(file.name);\n      }\n      book.sourceTitle = formatTitle(bookDoc.metadata.title);\n      // Correct language codes mistakenly set with language names\n      if (typeof bookDoc.metadata?.language === 'string') {\n        if (bookDoc.metadata.language in SUPPORTED_LANGNAMES) {\n          bookDoc.metadata.language = SUPPORTED_LANGNAMES[bookDoc.metadata.language]!;\n        }\n      }\n      // Set the book's language for formerly imported books, newly imported books have this field set\n      const primaryLanguage = getPrimaryLanguage(bookDoc.metadata.language);\n      book.primaryLanguage = book.primaryLanguage ?? primaryLanguage;\n      book.metadata = book.metadata ?? bookDoc.metadata;\n      // TODO: uncomment this when we can ensure metaHash is correctly generated for all books\n      // book.metaHash = book.metaHash ?? getMetadataHash(bookDoc.metadata);\n      book.metaHash = getMetadataHash(bookDoc.metadata);\n\n      const isFixedLayout = FIXED_LAYOUT_FORMATS.has(book.format);\n      useBookDataStore.setState((state) => ({\n        booksData: {\n          ...state.booksData,\n          [id]: { id, book, file, config, bookDoc, isFixedLayout },\n        },\n      }));\n      const configViewSettings = config.viewSettings!;\n      const globalViewSettings = settings.globalViewSettings;\n      set((state) => ({\n        viewStates: {\n          ...state.viewStates,\n          [key]: {\n            ...state.viewStates[key],\n            key,\n            view: null,\n            viewerKey: `${key}-${uniqueId()}`,\n            isPrimary,\n            loading: false,\n            inited: false,\n            error: null,\n            progress: null,\n            ribbonVisible: false,\n            ttsEnabled: false,\n            syncing: false,\n            gridInsets: null,\n            viewSettings: { ...globalViewSettings, ...configViewSettings },\n          },\n        },\n      }));\n    } catch (error) {\n      console.error(error);\n      set((state) => ({\n        viewStates: {\n          ...state.viewStates,\n          [key]: {\n            ...state.viewStates[key],\n            key: '',\n            view: null,\n            viewerKey: '',\n            isPrimary: false,\n            loading: false,\n            inited: false,\n            error: 'Failed to load book.',\n            progress: null,\n            ribbonVisible: false,\n            ttsEnabled: false,\n            syncing: false,\n            gridInsets: null,\n            viewSettings: null,\n          },\n        },\n      }));\n      throw error;\n    }\n  },\n  getViewSettings: (key: string) => get().viewStates[key]?.viewSettings || null,\n  setViewSettings: (key: string, viewSettings: ViewSettings) => {\n    if (!key) return;\n    const id = key.split('-')[0]!;\n    const bookData = useBookDataStore.getState().booksData[id];\n    const viewState = get().viewStates[key];\n    if (!viewState || !bookData) return;\n    if (viewState.isPrimary) {\n      useBookDataStore.setState((state) => ({\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...bookData,\n            config: {\n              ...bookData.config,\n              updatedAt: Date.now(),\n              viewSettings,\n            },\n          },\n        },\n      }));\n    }\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          viewSettings,\n        },\n      },\n    }));\n  },\n  getProgress: (key: string) => get().viewStates[key]?.progress || null,\n  setProgress: (\n    key: string,\n    location: string,\n    tocItem: TOCItem,\n    section: PageInfo,\n    pageinfo: PageInfo,\n    timeinfo: TimeInfo,\n    range: Range,\n  ) =>\n    set((state) => {\n      const id = key.split('-')[0]!;\n      const bookData = useBookDataStore.getState().booksData[id];\n      const viewState = state.viewStates[key];\n      if (!viewState || !bookData) return state;\n\n      const pagePressInfo = bookData.isFixedLayout ? section : pageinfo;\n      const progress: [number, number] = [pagePressInfo.current + 1, pagePressInfo.total];\n\n      // Update library book progress\n      const { library, setLibrary } = useLibraryStore.getState();\n      const bookIndex = library.findIndex((b) => b.hash === id);\n      if (bookIndex !== -1) {\n        const updatedLibrary = [...library];\n        const existingBook = updatedLibrary[bookIndex]!;\n        updatedLibrary[bookIndex] = {\n          ...existingBook,\n          progress,\n          updatedAt: Date.now(),\n        };\n        setLibrary(updatedLibrary);\n      }\n\n      const oldConfig = bookData.config;\n      const newConfig = {\n        ...bookData.config,\n        progress,\n        location,\n      } as BookConfig;\n\n      useBookDataStore.setState((state) => ({\n        booksData: {\n          ...state.booksData,\n          [id]: {\n            ...bookData,\n            config: viewState.isPrimary ? newConfig : oldConfig,\n          },\n        },\n      }));\n\n      return {\n        viewStates: {\n          ...state.viewStates,\n          [key]: {\n            ...viewState,\n            progress: {\n              ...viewState.progress,\n              location,\n              sectionHref: tocItem?.href,\n              sectionLabel: tocItem?.label,\n              sectionId: tocItem?.id,\n              section,\n              pageinfo,\n              timeinfo,\n              range,\n            },\n          },\n        },\n      };\n    }),\n  setBookmarkRibbonVisibility: (key: string, visible: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          ribbonVisible: visible,\n        },\n      },\n    })),\n\n  setTTSEnabled: (key: string, enabled: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          ttsEnabled: enabled,\n        },\n      },\n    })),\n\n  setIsSyncing: (key: string, syncing: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          syncing,\n        },\n      },\n    })),\n\n  getGridInsets: (key: string) =>\n    get().viewStates[key]?.gridInsets || { top: 0, right: 0, bottom: 0, left: 0 },\n  setGridInsets: (key: string, insets: Insets | null) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          gridInsets: insets,\n        },\n      },\n    })),\n\n  setViewInited: (key: string, inited: boolean) =>\n    set((state) => ({\n      viewStates: {\n        ...state.viewStates,\n        [key]: {\n          ...state.viewStates[key]!,\n          inited,\n        },\n      },\n    })),\n\n  recreateViewer: (envConfig: EnvConfigType, key: string) => {\n    const id = key.split('-')[0]!;\n    get()\n      .initViewState(envConfig, id, key, true, true)\n      .then(() => {\n        set((state) => ({\n          viewStates: {\n            ...state.viewStates,\n            [key]: {\n              ...state.viewStates[key]!,\n              viewerKey: `${key}-${uniqueId()}`,\n            },\n          },\n        }));\n      });\n  },\n}));\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2225, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/sidebarStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { BookNote, BookNoteType, BookSearchMatch, BookSearchResult } from '@/types/book';\n\ntype SearchStatus = 'searching' | 'completed' | 'terminated';\n\n// Per-book search navigation state\ninterface SearchNavState {\n  searchTerm: string;\n  searchResults: BookSearchResult[] | BookSearchMatch[] | null;\n  searchResultIndex: number;\n  searchProgress: number; // 0 to 1, where 1 means search complete\n}\n\n// Per-book booknotes navigation state\ninterface BooknotesNavState {\n  activeBooknoteType: BookNoteType | null;\n  booknoteResults: BookNote[] | null;\n  booknoteIndex: number;\n}\n\ninterface SidebarState {\n  sideBarBookKey: string | null;\n  sideBarWidth: string;\n  isSideBarVisible: boolean;\n  isSideBarPinned: boolean;\n  // Per-book navigation states\n  searchNavStates: Record<string, SearchNavState>;\n  booknotesNavStates: Record<string, BooknotesNavState>;\n  searchStatuses: Record<string, SearchStatus>;\n  getIsSideBarVisible: () => boolean;\n  getSideBarWidth: () => string;\n  setSideBarBookKey: (key: string) => void;\n  setSideBarWidth: (width: string) => void;\n  toggleSideBar: () => void;\n  toggleSideBarPin: () => void;\n  setSideBarVisible: (visible: boolean) => void;\n  setSideBarPin: (pinned: boolean) => void;\n  // Search actions (per bookKey)\n  getSearchNavState: (bookKey: string) => SearchNavState;\n  setSearchTerm: (bookKey: string, term: string) => void;\n  setSearchStatus: (bookKey: string, status: SearchStatus) => void;\n  getSearchStatus: (bookKey: string) => SearchStatus | null;\n  setSearchResults: (\n    bookKey: string,\n    results: BookSearchResult[] | BookSearchMatch[] | null,\n  ) => void;\n  setSearchResultIndex: (bookKey: string, index: number) => void;\n  setSearchProgress: (bookKey: string, progress: number) => void;\n  clearSearch: (bookKey: string) => void;\n  // Booknotes navigation actions (per bookKey)\n  getBooknotesNavState: (bookKey: string) => BooknotesNavState;\n  setActiveBooknoteType: (bookKey: string, type: BookNoteType | null) => void;\n  setBooknoteResults: (bookKey: string, results: BookNote[] | null) => void;\n  setBooknoteIndex: (bookKey: string, index: number) => void;\n  clearBooknotesNav: (bookKey: string) => void;\n}\n\nconst defaultSearchNavState: SearchNavState = {\n  searchTerm: '',\n  searchResults: null,\n  searchResultIndex: 0,\n  searchProgress: 1,\n};\n\nconst defaultBooknotesNavState: BooknotesNavState = {\n  activeBooknoteType: null,\n  booknoteResults: null,\n  booknoteIndex: 0,\n};\n\nexport const useSidebarStore = create<SidebarState>((set, get) => ({\n  sideBarBookKey: null,\n  sideBarWidth: '',\n  isSideBarVisible: false,\n  isSideBarPinned: false,\n  // Per-book navigation states\n  searchNavStates: {},\n  booknotesNavStates: {},\n  searchStatuses: {},\n  getIsSideBarVisible: () => get().isSideBarVisible,\n  getSideBarWidth: () => get().sideBarWidth,\n  setSideBarBookKey: (key: string) => set({ sideBarBookKey: key }),\n  setSideBarWidth: (width: string) => set({ sideBarWidth: width }),\n  toggleSideBar: () => set((state) => ({ isSideBarVisible: !state.isSideBarVisible })),\n  toggleSideBarPin: () => set((state) => ({ isSideBarPinned: !state.isSideBarPinned })),\n  setSideBarVisible: (visible: boolean) => set({ isSideBarVisible: visible }),\n  setSideBarPin: (pinned: boolean) => set({ isSideBarPinned: pinned }),\n  // Search actions\n  getSearchStatus: (bookKey: string) => {\n    return get().searchStatuses[bookKey] || null;\n  },\n  getSearchNavState: (bookKey: string) => {\n    return get().searchNavStates[bookKey] || defaultSearchNavState;\n  },\n  setSearchTerm: (bookKey: string, term: string) =>\n    set((state) => ({\n      searchNavStates: {\n        ...state.searchNavStates,\n        [bookKey]: {\n          ...(state.searchNavStates[bookKey] || defaultSearchNavState),\n          searchTerm: term,\n        },\n      },\n    })),\n  setSearchResults: (bookKey: string, results: BookSearchResult[] | BookSearchMatch[] | null) =>\n    set((state) => ({\n      searchNavStates: {\n        ...state.searchNavStates,\n        [bookKey]: {\n          ...(state.searchNavStates[bookKey] || defaultSearchNavState),\n          searchResults: results,\n        },\n      },\n    })),\n  setSearchResultIndex: (bookKey: string, index: number) =>\n    set((state) => ({\n      searchNavStates: {\n        ...state.searchNavStates,\n        [bookKey]: {\n          ...(state.searchNavStates[bookKey] || defaultSearchNavState),\n          searchResultIndex: index,\n        },\n      },\n    })),\n  setSearchProgress: (bookKey: string, progress: number) =>\n    set((state) => ({\n      searchNavStates: {\n        ...state.searchNavStates,\n        [bookKey]: {\n          ...(state.searchNavStates[bookKey] || defaultSearchNavState),\n          searchProgress: progress,\n        },\n      },\n    })),\n  clearSearch: (bookKey: string) =>\n    set((state) => ({\n      searchNavStates: {\n        ...state.searchNavStates,\n        [bookKey]: { ...defaultSearchNavState },\n      },\n      searchStatuses: {\n        ...state.searchStatuses,\n        [bookKey]: 'terminated',\n      },\n    })),\n  setSearchStatus: (bookKey: string, status: SearchStatus) =>\n    set((state) => ({\n      searchStatuses: {\n        ...state.searchStatuses,\n        [bookKey]: status,\n      },\n    })),\n  // Booknotes navigation actions\n  getBooknotesNavState: (bookKey: string) => {\n    return get().booknotesNavStates[bookKey] || defaultBooknotesNavState;\n  },\n  setActiveBooknoteType: (bookKey: string, type: BookNoteType | null) =>\n    set((state) => ({\n      booknotesNavStates: {\n        ...state.booknotesNavStates,\n        [bookKey]: {\n          ...(state.booknotesNavStates[bookKey] || defaultBooknotesNavState),\n          activeBooknoteType: type,\n        },\n      },\n    })),\n  setBooknoteResults: (bookKey: string, results: BookNote[] | null) =>\n    set((state) => ({\n      booknotesNavStates: {\n        ...state.booknotesNavStates,\n        [bookKey]: {\n          ...(state.booknotesNavStates[bookKey] || defaultBooknotesNavState),\n          booknoteResults: results,\n        },\n      },\n    })),\n  setBooknoteIndex: (bookKey: string, index: number) =>\n    set((state) => ({\n      booknotesNavStates: {\n        ...state.booknotesNavStates,\n        [bookKey]: {\n          ...(state.booknotesNavStates[bookKey] || defaultBooknotesNavState),\n          booknoteIndex: index,\n        },\n      },\n    })),\n  clearBooknotesNav: (bookKey: string) =>\n    set((state) => ({\n      booknotesNavStates: {\n        ...state.booknotesNavStates,\n        [bookKey]: { ...defaultBooknotesNavState },\n      },\n    })),\n}));\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2383, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/notebookStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { BookNote } from '@/types/book';\nimport { TextSelection } from '@/utils/sel';\n\ninterface NotebookState {\n  notebookWidth: string;\n  isNotebookVisible: boolean;\n  isNotebookPinned: boolean;\n  notebookNewAnnotation: TextSelection | null;\n  notebookEditAnnotation: BookNote | null;\n  notebookAnnotationDrafts: { [key: string]: string };\n  getIsNotebookVisible: () => boolean;\n  toggleNotebook: () => void;\n  toggleNotebookPin: () => void;\n  getNotebookWidth: () => string;\n  setNotebookWidth: (width: string) => void;\n  setNotebookVisible: (visible: boolean) => void;\n  setNotebookPin: (pinned: boolean) => void;\n  setNotebookNewAnnotation: (selection: TextSelection | null) => void;\n  setNotebookEditAnnotation: (note: BookNote | null) => void;\n  saveNotebookAnnotationDraft: (key: string, note: string) => void;\n  getNotebookAnnotationDraft: (key: string) => string | undefined;\n}\n\nexport const useNotebookStore = create<NotebookState>((set, get) => ({\n  notebookWidth: '',\n  isNotebookVisible: false,\n  isNotebookPinned: false,\n  notebookNewAnnotation: null,\n  notebookEditAnnotation: null,\n  notebookAnnotationDrafts: {},\n  getIsNotebookVisible: () => get().isNotebookVisible,\n  getNotebookWidth: () => get().notebookWidth,\n  setNotebookWidth: (width: string) => set({ notebookWidth: width }),\n  toggleNotebook: () => set((state) => ({ isNotebookVisible: !state.isNotebookVisible })),\n  toggleNotebookPin: () => set((state) => ({ isNotebookPinned: !state.isNotebookPinned })),\n  setNotebookVisible: (visible: boolean) => set({ isNotebookVisible: visible }),\n  setNotebookPin: (pinned: boolean) => set({ isNotebookPinned: pinned }),\n  setNotebookNewAnnotation: (selection: TextSelection | null) =>\n    set({ notebookNewAnnotation: selection }),\n  setNotebookEditAnnotation: (note: BookNote | null) => set({ notebookEditAnnotation: note }),\n  saveNotebookAnnotationDraft: (key: string, note: string) =>\n    set((state) => ({\n      notebookAnnotationDrafts: { ...state.notebookAnnotationDrafts, [key]: note },\n    })),\n  getNotebookAnnotationDraft: (key: string) => get().notebookAnnotationDrafts[key],\n}));\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAwBO,MAAM,mBAAmB,IAAA,wHAAM,EAAgB,CAAC,KAAK,MAAQ,CAAC;QACnE,eAAe;QACf,mBAAmB;QACnB,kBAAkB;QAClB,uBAAuB;QACvB,wBAAwB;QACxB,0BAA0B,CAAC;QAC3B,sBAAsB,IAAM,MAAM,iBAAiB;QACnD,kBAAkB,IAAM,MAAM,aAAa;QAC3C,kBAAkB,CAAC,QAAkB,IAAI;gBAAE,eAAe;YAAM;QAChE,gBAAgB,IAAM,IAAI,CAAC,QAAU,CAAC;oBAAE,mBAAmB,CAAC,MAAM,iBAAiB;gBAAC,CAAC;QACrF,mBAAmB,IAAM,IAAI,CAAC,QAAU,CAAC;oBAAE,kBAAkB,CAAC,MAAM,gBAAgB;gBAAC,CAAC;QACtF,oBAAoB,CAAC,UAAqB,IAAI;gBAAE,mBAAmB;YAAQ;QAC3E,gBAAgB,CAAC,SAAoB,IAAI;gBAAE,kBAAkB;YAAO;QACpE,0BAA0B,CAAC,YACzB,IAAI;gBAAE,uBAAuB;YAAU;QACzC,2BAA2B,CAAC,OAA0B,IAAI;gBAAE,wBAAwB;YAAK;QACzF,6BAA6B,CAAC,KAAa,OACzC,IAAI,CAAC,QAAU,CAAC;oBACd,0BAA0B;wBAAE,GAAG,MAAM,wBAAwB;wBAAE,CAAC,IAAI,EAAE;oBAAK;gBAC7E,CAAC;QACH,4BAA4B,CAAC,MAAgB,MAAM,wBAAwB,CAAC,IAAI;IAClF,CAAC"}},
    {"offset": {"line": 2438, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/deviceStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { interceptKeys, getScreenBrightness, setScreenBrightness } from '@/utils/bridge';\nimport { eventDispatcher } from '@/utils/event';\nimport { NativeTouchEventType } from '@/types/system';\n\ndeclare global {\n  interface Window {\n    onNativeKeyDown?: (keyName: string) => void;\n    onNativeTouch?: (event: NativeTouchEventType) => void;\n  }\n}\n\nconst handleNativeKeyDown = (keyName: string) => {\n  if (keyName === 'VolumeUp' || keyName === 'VolumeDown') {\n    return eventDispatcher.dispatch('native-key-down', { keyName });\n  }\n  if (keyName === 'Back') {\n    return eventDispatcher.dispatchSync('native-key-down', { keyName });\n  }\n  return false;\n};\n\ntype DeviceControlState = {\n  volumeKeysIntercepted: boolean;\n  backKeyIntercepted: boolean;\n  volumeKeysInterceptionCount: number;\n  backKeyInterceptionCount: number;\n  getScreenBrightness: () => Promise<number>; // 0.0 to 1.0\n  setScreenBrightness: (brightness: number) => Promise<void>; // brightness: 0.0 to 1.0\n  acquireVolumeKeyInterception: () => void;\n  releaseVolumeKeyInterception: () => void;\n  acquireBackKeyInterception: () => void;\n  releaseBackKeyInterception: () => void;\n  listenToNativeTouchEvents: () => void;\n};\n\nexport const useDeviceControlStore = create<DeviceControlState>((set, get) => ({\n  volumeKeysIntercepted: false,\n  backKeyIntercepted: false,\n  volumeKeysInterceptionCount: 0,\n  backKeyInterceptionCount: 0,\n\n  acquireVolumeKeyInterception: () => {\n    const { volumeKeysInterceptionCount } = get();\n    if (volumeKeysInterceptionCount == 0) {\n      window.onNativeKeyDown = handleNativeKeyDown;\n      interceptKeys({ volumeKeys: true });\n      set({ volumeKeysIntercepted: true });\n    }\n    set({ volumeKeysInterceptionCount: volumeKeysInterceptionCount + 1 });\n  },\n\n  releaseVolumeKeyInterception: () => {\n    const { volumeKeysInterceptionCount } = get();\n    if (volumeKeysInterceptionCount <= 1) {\n      interceptKeys({ volumeKeys: false });\n      set({ volumeKeysIntercepted: false, volumeKeysInterceptionCount: 0 });\n    } else {\n      set({ volumeKeysInterceptionCount: volumeKeysInterceptionCount - 1 });\n    }\n  },\n\n  acquireBackKeyInterception: () => {\n    const { backKeyInterceptionCount } = get();\n    if (backKeyInterceptionCount == 0) {\n      window.onNativeKeyDown = handleNativeKeyDown;\n      interceptKeys({ backKey: true });\n      set({ backKeyIntercepted: true });\n    }\n    set({ backKeyInterceptionCount: backKeyInterceptionCount + 1 });\n  },\n\n  releaseBackKeyInterception: () => {\n    const { backKeyInterceptionCount } = get();\n    if (backKeyInterceptionCount <= 1) {\n      interceptKeys({ backKey: false });\n      set({ backKeyIntercepted: false, backKeyInterceptionCount: 0 });\n    } else {\n      set({ backKeyInterceptionCount: backKeyInterceptionCount - 1 });\n    }\n  },\n\n  listenToNativeTouchEvents: () => {\n    window.onNativeTouch = (event: NativeTouchEventType) => {\n      return eventDispatcher.dispatch('native-touch', event);\n    };\n  },\n\n  getScreenBrightness: async () => {\n    const res = await getScreenBrightness();\n    return res.brightness;\n  },\n\n  setScreenBrightness: async (brightness: number) => {\n    await setScreenBrightness({ brightness });\n  },\n}));\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAUA,MAAM,sBAAsB,CAAC;IAC3B,IAAI,YAAY,cAAc,YAAY,cAAc;QACtD,OAAO,2JAAe,CAAC,QAAQ,CAAC,mBAAmB;YAAE;QAAQ;IAC/D;IACA,IAAI,YAAY,QAAQ;QACtB,OAAO,2JAAe,CAAC,YAAY,CAAC,mBAAmB;YAAE;QAAQ;IACnE;IACA,OAAO;AACT;AAgBO,MAAM,wBAAwB,IAAA,wHAAM,EAAqB,CAAC,KAAK,MAAQ,CAAC;QAC7E,uBAAuB;QACvB,oBAAoB;QACpB,6BAA6B;QAC7B,0BAA0B;QAE1B,8BAA8B;YAC5B,MAAM,EAAE,2BAA2B,EAAE,GAAG;YACxC,IAAI,+BAA+B,GAAG;gBACpC,OAAO,eAAe,GAAG;gBACzB,IAAA,0JAAa,EAAC;oBAAE,YAAY;gBAAK;gBACjC,IAAI;oBAAE,uBAAuB;gBAAK;YACpC;YACA,IAAI;gBAAE,6BAA6B,8BAA8B;YAAE;QACrE;QAEA,8BAA8B;YAC5B,MAAM,EAAE,2BAA2B,EAAE,GAAG;YACxC,IAAI,+BAA+B,GAAG;gBACpC,IAAA,0JAAa,EAAC;oBAAE,YAAY;gBAAM;gBAClC,IAAI;oBAAE,uBAAuB;oBAAO,6BAA6B;gBAAE;YACrE,OAAO;gBACL,IAAI;oBAAE,6BAA6B,8BAA8B;gBAAE;YACrE;QACF;QAEA,4BAA4B;YAC1B,MAAM,EAAE,wBAAwB,EAAE,GAAG;YACrC,IAAI,4BAA4B,GAAG;gBACjC,OAAO,eAAe,GAAG;gBACzB,IAAA,0JAAa,EAAC;oBAAE,SAAS;gBAAK;gBAC9B,IAAI;oBAAE,oBAAoB;gBAAK;YACjC;YACA,IAAI;gBAAE,0BAA0B,2BAA2B;YAAE;QAC/D;QAEA,4BAA4B;YAC1B,MAAM,EAAE,wBAAwB,EAAE,GAAG;YACrC,IAAI,4BAA4B,GAAG;gBACjC,IAAA,0JAAa,EAAC;oBAAE,SAAS;gBAAM;gBAC/B,IAAI;oBAAE,oBAAoB;oBAAO,0BAA0B;gBAAE;YAC/D,OAAO;gBACL,IAAI;oBAAE,0BAA0B,2BAA2B;gBAAE;YAC/D;QACF;QAEA,2BAA2B;YACzB,OAAO,aAAa,GAAG,CAAC;gBACtB,OAAO,2JAAe,CAAC,QAAQ,CAAC,gBAAgB;YAClD;QACF;QAEA,qBAAqB;YACnB,MAAM,MAAM,MAAM,IAAA,gKAAmB;YACrC,OAAO,IAAI,UAAU;QACvB;QAEA,qBAAqB,OAAO;YAC1B,MAAM,IAAA,gKAAmB,EAAC;gBAAE;YAAW;QACzC;IACF,CAAC"}},
    {"offset": {"line": 2555, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/transferStore.ts"],"sourcesContent":["import { create } from 'zustand';\n\nexport type TransferType = 'upload' | 'download' | 'delete';\nexport type TransferStatus = 'pending' | 'in_progress' | 'completed' | 'failed' | 'cancelled';\n\nexport interface TransferItem {\n  id: string;\n  bookHash: string;\n  bookTitle: string;\n  type: TransferType;\n  status: TransferStatus;\n  progress: number; // 0-100 percentage\n  totalBytes: number;\n  transferredBytes: number;\n  transferSpeed: number; // bytes per second\n  error?: string;\n  retryCount: number;\n  maxRetries: number;\n  createdAt: number;\n  startedAt?: number;\n  completedAt?: number;\n  priority: number; // Lower = higher priority\n  isBackground: boolean;\n}\n\ninterface TransferState {\n  transfers: Record<string, TransferItem>;\n  isQueuePaused: boolean;\n  isTransferQueueOpen: boolean;\n  maxConcurrent: number;\n  activeCount: number;\n\n  // UI Actions\n  setIsTransferQueueOpen: (isOpen: boolean) => void;\n\n  // Actions\n  addTransfer: (\n    bookHash: string,\n    bookTitle: string,\n    type: TransferType,\n    priority?: number,\n    isBackground?: boolean,\n  ) => string;\n  removeTransfer: (transferId: string) => void;\n  updateTransferProgress: (\n    transferId: string,\n    progress: number,\n    transferred: number,\n    total: number,\n    speed: number,\n  ) => void;\n  setTransferStatus: (transferId: string, status: TransferStatus, error?: string) => void;\n  retryTransfer: (transferId: string) => void;\n  incrementRetryCount: (transferId: string) => void;\n\n  // Queue control\n  pauseQueue: () => void;\n  resumeQueue: () => void;\n  clearCompleted: () => void;\n  clearFailed: () => void;\n  clearAll: () => void;\n\n  // Getters\n  getPendingTransfers: () => TransferItem[];\n  getActiveTransfers: () => TransferItem[];\n  getFailedTransfers: () => TransferItem[];\n  getCompletedTransfers: () => TransferItem[];\n  getTransferByBookHash: (bookHash: string, type: TransferType) => TransferItem | undefined;\n  getQueueStats: () => {\n    pending: number;\n    active: number;\n    completed: number;\n    failed: number;\n    total: number;\n  };\n\n  // Internal\n  setActiveCount: (count: number) => void;\n\n  // Persistence\n  restoreTransfers: (transfers: Record<string, TransferItem>, isQueuePaused: boolean) => void;\n}\n\nconst generateTransferId = (): string => {\n  return `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\n};\n\nexport const useTransferStore = create<TransferState>((set, get) => ({\n  transfers: {},\n  isQueuePaused: false,\n  isTransferQueueOpen: false,\n  maxConcurrent: 2,\n  activeCount: 0,\n\n  setIsTransferQueueOpen: (isOpen) => set({ isTransferQueueOpen: isOpen }),\n\n  addTransfer: (bookHash, bookTitle, type, priority = 10, isBackground = false) => {\n    const id = generateTransferId();\n    const transfer: TransferItem = {\n      id,\n      bookHash,\n      bookTitle,\n      type,\n      status: 'pending',\n      progress: 0,\n      totalBytes: 0,\n      transferredBytes: 0,\n      transferSpeed: 0,\n      retryCount: 0,\n      maxRetries: 3,\n      createdAt: Date.now(),\n      priority,\n      isBackground,\n    };\n\n    set((state) => ({\n      transfers: { ...state.transfers, [id]: transfer },\n    }));\n\n    return id;\n  },\n\n  removeTransfer: (transferId) => {\n    set((state) => {\n      const { [transferId]: _, ...remaining } = state.transfers;\n      return { transfers: remaining };\n    });\n  },\n\n  updateTransferProgress: (transferId, progress, transferred, total, speed) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: {\n            ...transfer,\n            progress,\n            transferredBytes: transferred,\n            totalBytes: total,\n            transferSpeed: speed,\n          },\n        },\n      };\n    });\n  },\n\n  setTransferStatus: (transferId, status, error) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      const updates: Partial<TransferItem> = { status, error };\n\n      if (status === 'in_progress' && !transfer.startedAt) {\n        updates.startedAt = Date.now();\n      }\n\n      if (status === 'completed' || status === 'failed' || status === 'cancelled') {\n        updates.completedAt = Date.now();\n      }\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: { ...transfer, ...updates },\n        },\n      };\n    });\n  },\n\n  retryTransfer: (transferId) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: {\n            ...transfer,\n            status: 'pending',\n            progress: 0,\n            transferredBytes: 0,\n            transferSpeed: 0,\n            error: undefined,\n            startedAt: undefined,\n            completedAt: undefined,\n          },\n        },\n      };\n    });\n  },\n\n  incrementRetryCount: (transferId) => {\n    set((state) => {\n      const transfer = state.transfers[transferId];\n      if (!transfer) return state;\n\n      return {\n        transfers: {\n          ...state.transfers,\n          [transferId]: {\n            ...transfer,\n            retryCount: transfer.retryCount + 1,\n          },\n        },\n      };\n    });\n  },\n\n  pauseQueue: () => set({ isQueuePaused: true }),\n  resumeQueue: () => set({ isQueuePaused: false }),\n\n  clearCompleted: () => {\n    set((state) => {\n      const remaining: Record<string, TransferItem> = {};\n      Object.entries(state.transfers).forEach(([id, transfer]) => {\n        if (transfer.status !== 'completed') {\n          remaining[id] = transfer;\n        }\n      });\n      return { transfers: remaining };\n    });\n  },\n\n  clearFailed: () => {\n    set((state) => {\n      const remaining: Record<string, TransferItem> = {};\n      Object.entries(state.transfers).forEach(([id, transfer]) => {\n        if (transfer.status !== 'failed' && transfer.status !== 'cancelled') {\n          remaining[id] = transfer;\n        }\n      });\n      return { transfers: remaining };\n    });\n  },\n\n  clearAll: () => set({ transfers: {} }),\n\n  getPendingTransfers: () => {\n    return Object.values(get().transfers).filter((t) => t.status === 'pending');\n  },\n\n  getActiveTransfers: () => {\n    return Object.values(get().transfers).filter((t) => t.status === 'in_progress');\n  },\n\n  getFailedTransfers: () => {\n    return Object.values(get().transfers).filter(\n      (t) => t.status === 'failed' || t.status === 'cancelled',\n    );\n  },\n\n  getCompletedTransfers: () => {\n    return Object.values(get().transfers).filter((t) => t.status === 'completed');\n  },\n\n  getTransferByBookHash: (bookHash, type) => {\n    return Object.values(get().transfers).find(\n      (t) =>\n        t.bookHash === bookHash && t.type === type && ['pending', 'in_progress'].includes(t.status),\n    );\n  },\n\n  getQueueStats: () => {\n    const transfers = Object.values(get().transfers);\n    return {\n      pending: transfers.filter((t) => t.status === 'pending').length,\n      active: transfers.filter((t) => t.status === 'in_progress').length,\n      completed: transfers.filter((t) => t.status === 'completed').length,\n      failed: transfers.filter((t) => t.status === 'failed' || t.status === 'cancelled').length,\n      total: transfers.length,\n    };\n  },\n\n  setActiveCount: (count) => set({ activeCount: count }),\n\n  restoreTransfers: (transfers, isQueuePaused) => {\n    // Reset in_progress transfers to pending when restoring\n    const restoredTransfers: Record<string, TransferItem> = {};\n    Object.entries(transfers).forEach(([id, transfer]) => {\n      if (transfer.status === 'in_progress') {\n        restoredTransfers[id] = {\n          ...transfer,\n          status: 'pending',\n          progress: 0,\n          transferredBytes: 0,\n          transferSpeed: 0,\n        };\n      } else {\n        restoredTransfers[id] = transfer;\n      }\n    });\n    set({ transfers: restoredTransfers, isQueuePaused });\n  },\n}));\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2785, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/proofreadStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { ProofreadRule, ProofreadScope, ViewSettings } from '@/types/book';\nimport { SystemSettings } from '@/types/settings';\nimport { EnvConfigType } from '@/services/environment';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { uniqueId } from '@/utils/misc';\n\nexport interface CreateProofreadRuleOptions {\n  scope: ProofreadScope;\n  pattern: string;\n  replacement: string;\n  cfi?: string;\n  sectionHref?: string;\n  isRegex?: boolean;\n  enabled?: boolean;\n  caseSensitive?: boolean;\n  order?: number;\n  wholeWord?: boolean;\n  onlyForTTS?: boolean;\n}\n\ninterface ProofreadStoreState {\n  getBookRules: (bookKey: string) => ProofreadRule[];\n  getGlobalRules: () => ProofreadRule[];\n  getMergedRules: (bookKey: string) => ProofreadRule[];\n\n  addRule: (\n    envConfig: EnvConfigType,\n    bookKey: string,\n    options: CreateProofreadRuleOptions,\n  ) => Promise<ProofreadRule>;\n  updateRule: (\n    envConfig: EnvConfigType,\n    bookKey: string,\n    ruleId: string,\n    updates: Partial<Omit<ProofreadRule, 'id'>>,\n  ) => Promise<void>;\n  removeRule: (\n    envConfig: EnvConfigType,\n    bookKey: string,\n    ruleId: string,\n    scope: ProofreadScope,\n  ) => Promise<void>;\n  toggleRule: (envConfig: EnvConfigType, bookKey: string, ruleId: string) => Promise<void>;\n}\n\nfunction createProofreadRule(opts: CreateProofreadRuleOptions): ProofreadRule {\n  return {\n    id: uniqueId(),\n    scope: opts.scope,\n    pattern: opts.pattern,\n    replacement: opts.replacement,\n    cfi: opts.cfi,\n    sectionHref: opts.sectionHref,\n    isRegex: opts.isRegex ?? false,\n    enabled: opts.enabled ?? true,\n    caseSensitive: opts.caseSensitive ?? true,\n    order: opts.order ?? 1000,\n    wholeWord: opts.wholeWord ?? true,\n    onlyForTTS: opts.onlyForTTS ?? false,\n  };\n}\n\nfunction mergeRules(\n  globalRules: ProofreadRule[] | undefined,\n  bookRules: ProofreadRule[] | undefined,\n): ProofreadRule[] {\n  const map = new Map<string, ProofreadRule>();\n\n  (globalRules ?? []).forEach((r) => map.set(r.id, r));\n  (bookRules ?? []).forEach((r) => map.set(r.id, r));\n\n  return [...map.values()].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));\n}\n\nexport const useProofreadStore = create<ProofreadStoreState>(() => ({\n  getBookRules: (bookKey: string) => {\n    const { getViewSettings } = useReaderStore.getState();\n    const viewSettings = getViewSettings(bookKey);\n    return viewSettings?.proofreadRules || [];\n  },\n\n  getGlobalRules: () => {\n    const { settings } = useSettingsStore.getState();\n    return settings.globalViewSettings.proofreadRules || [];\n  },\n\n  getMergedRules: (bookKey: string) => {\n    const { settings } = useSettingsStore.getState();\n    const { getViewSettings } = useReaderStore.getState();\n    const viewSettings = getViewSettings(bookKey);\n\n    return mergeRules(settings.globalViewSettings.proofreadRules, viewSettings?.proofreadRules);\n  },\n\n  addRule: async (envConfig, bookKey, options) => {\n    const rule = createProofreadRule(options);\n\n    if (options.scope === 'library') {\n      await addGlobalRule(envConfig, rule);\n    } else {\n      await addBookRule(envConfig, bookKey, rule, options.scope);\n    }\n\n    return rule;\n  },\n\n  updateRule: async (envConfig, bookKey, ruleId, updates) => {\n    if (updates.scope === 'library') {\n      await updateGlobalRule(envConfig, ruleId, updates);\n    } else {\n      await updateBookRule(envConfig, bookKey, ruleId, updates);\n    }\n  },\n\n  removeRule: async (envConfig, bookKey, ruleId, scope) => {\n    if (scope === 'library') {\n      await removeGlobalRule(envConfig, ruleId);\n    } else {\n      await removeBookRule(envConfig, bookKey, ruleId);\n    }\n  },\n\n  toggleRule: async (envConfig, bookKey, ruleId) => {\n    const { getMergedRules } = useProofreadStore.getState();\n    const mergedRules = getMergedRules(bookKey);\n    const rule = mergedRules.find((r) => r.id === ruleId);\n\n    if (!rule) {\n      throw new Error(`Rule not found: ${ruleId}`);\n    }\n\n    const { updateRule } = useProofreadStore.getState();\n    await updateRule(envConfig, bookKey, ruleId, { enabled: !rule.enabled });\n  },\n}));\n\nasync function addBookRule(\n  envConfig: EnvConfigType,\n  bookKey: string,\n  rule: ProofreadRule,\n  scope: ProofreadScope,\n): Promise<void> {\n  const { getViewSettings } = useReaderStore.getState();\n\n  const viewSettings = getViewSettings(bookKey);\n  if (!viewSettings) return;\n\n  const existingRules = viewSettings.proofreadRules || [];\n\n  if (scope === 'selection') {\n    // Always add new single-instance rules (each has unique ID)\n    existingRules.push(rule);\n  } else {\n    // Check for duplicates in book scope\n    const existing = existingRules.find(\n      (r) => r.pattern === rule.pattern && r.isRegex === rule.isRegex && r.scope !== 'selection',\n    );\n\n    if (existing) {\n      Object.assign(existing, {\n        replacement: rule.replacement,\n        enabled: rule.enabled,\n        order: rule.order,\n      });\n    } else {\n      existingRules.push(rule);\n    }\n  }\n\n  await updateBookViewSettings(envConfig, bookKey, existingRules);\n}\n\nasync function updateBookRule(\n  envConfig: EnvConfigType,\n  bookKey: string,\n  ruleId: string,\n  updates: Partial<Omit<ProofreadRule, 'id'>>,\n): Promise<void> {\n  const { getViewSettings } = useReaderStore.getState();\n\n  const viewSettings = getViewSettings(bookKey);\n  if (!viewSettings) {\n    throw new Error(`No viewSettings found for book: ${bookKey}`);\n  }\n\n  const existingRules = viewSettings.proofreadRules || [];\n  const updatedRules = existingRules.map((r) => (r.id === ruleId ? { ...r, ...updates } : r));\n\n  await updateBookViewSettings(envConfig, bookKey, updatedRules);\n}\n\nasync function removeBookRule(\n  envConfig: EnvConfigType,\n  bookKey: string,\n  ruleId: string,\n): Promise<void> {\n  const { getViewSettings } = useReaderStore.getState();\n\n  const viewSettings = getViewSettings(bookKey);\n  if (!viewSettings) {\n    throw new Error(`No viewSettings found for book: ${bookKey}`);\n  }\n\n  const existingRules = viewSettings.proofreadRules || [];\n  const filteredRules = existingRules.filter((r) => r.id !== ruleId);\n\n  await updateBookViewSettings(envConfig, bookKey, filteredRules);\n}\n\nasync function updateBookViewSettings(\n  envConfig: EnvConfigType,\n  bookKey: string,\n  rules: ProofreadRule[],\n): Promise<void> {\n  const { getViewSettings, setViewSettings } = useReaderStore.getState();\n  const { getConfig, saveConfig } = useBookDataStore.getState();\n  const { settings } = useSettingsStore.getState();\n\n  const viewSettings = getViewSettings(bookKey);\n  if (!viewSettings) {\n    throw new Error(`No viewSettings found for book: ${bookKey}`);\n  }\n\n  const updatedViewSettings: ViewSettings = {\n    ...viewSettings,\n    proofreadRules: rules,\n  };\n\n  setViewSettings(bookKey, updatedViewSettings);\n\n  const config = getConfig(bookKey);\n  if (config) {\n    await saveConfig(\n      envConfig,\n      bookKey,\n      { ...config, viewSettings: updatedViewSettings, updatedAt: Date.now() },\n      settings,\n    );\n  }\n}\n\nasync function addGlobalRule(envConfig: EnvConfigType, rule: ProofreadRule): Promise<void> {\n  const { settings } = useSettingsStore.getState();\n  if (!settings || !settings.globalViewSettings) return;\n\n  const globalRules = settings.globalViewSettings.proofreadRules || [];\n\n  const existing = globalRules.find(\n    (r) => r.pattern === rule.pattern && r.isRegex === rule.isRegex,\n  );\n\n  if (existing) {\n    Object.assign(existing, {\n      replacement: rule.replacement,\n      enabled: rule.enabled,\n      order: rule.order,\n    });\n    await updateGlobalSettings(envConfig, globalRules);\n  } else {\n    await updateGlobalSettings(envConfig, [...globalRules, rule]);\n  }\n}\n\nasync function updateGlobalRule(\n  envConfig: EnvConfigType,\n  ruleId: string,\n  updates: Partial<Omit<ProofreadRule, 'id'>>,\n): Promise<void> {\n  const { settings } = useSettingsStore.getState();\n  const globalRules = settings.globalViewSettings.proofreadRules || [];\n\n  const updatedRules = globalRules.map((r) => (r.id === ruleId ? { ...r, ...updates } : r));\n\n  await updateGlobalSettings(envConfig, updatedRules);\n}\n\nasync function removeGlobalRule(envConfig: EnvConfigType, ruleId: string): Promise<void> {\n  const { settings } = useSettingsStore.getState();\n  const globalRules = settings.globalViewSettings.proofreadRules || [];\n\n  const filteredRules = globalRules.filter((r) => r.id !== ruleId);\n  await updateGlobalSettings(envConfig, filteredRules);\n}\n\nasync function updateGlobalSettings(\n  envConfig: EnvConfigType,\n  rules: ProofreadRule[],\n): Promise<void> {\n  const { settings, setSettings, saveSettings } = useSettingsStore.getState();\n\n  const updatedSettings: SystemSettings = {\n    ...settings,\n    globalViewSettings: {\n      ...settings.globalViewSettings,\n      proofreadRules: rules,\n    },\n  };\n\n  setSettings(updatedSettings);\n  await saveSettings(envConfig, updatedSettings);\n}\n\nexport function validateReplacementRulePattern(\n  pattern: string,\n  isRegex: boolean,\n): { valid: boolean; error?: string } {\n  if (!pattern?.trim()) {\n    return { valid: false, error: 'Pattern cannot be empty' };\n  }\n\n  if (isRegex) {\n    try {\n      new RegExp(pattern);\n      return { valid: true };\n    } catch (error) {\n      return {\n        valid: false,\n        error: error instanceof Error ? error.message : 'Invalid regex pattern',\n      };\n    }\n  }\n\n  return { valid: true };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3029, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/parallelViewStore.ts"],"sourcesContent":["import { create } from 'zustand';\n\ninterface ParallelViewState {\n  parallelViews: Set<string>[];\n  setParallel: (bookKeys: string[]) => void;\n  unsetParallel: (bookKeys: string[]) => void;\n  areParallels: (bookKey1: string, bookKey2: string) => boolean;\n  getParallels: (bookKey: string) => Set<string> | null;\n}\n\nexport const useParallelViewStore = create<ParallelViewState>((set, get) => ({\n  parallelViews: [],\n\n  setParallel: (bookKeys: string[]) => {\n    set((state) => {\n      const uniqueKeys = [...new Set(bookKeys.filter((key) => key.trim() !== ''))];\n      if (uniqueKeys.length < 2) {\n        return state;\n      }\n\n      const newGroups = [...state.parallelViews];\n      const existingGroups = newGroups.filter((group) => uniqueKeys.some((key) => group.has(key)));\n\n      let targetGroup: Set<string>;\n      if (existingGroups.length === 0) {\n        targetGroup = new Set(uniqueKeys);\n        newGroups.push(targetGroup);\n      } else if (existingGroups.length === 1) {\n        targetGroup = existingGroups[0]!;\n        uniqueKeys.forEach((key) => targetGroup.add(key));\n      } else {\n        targetGroup = existingGroups[0]!;\n        existingGroups.slice(1).forEach((group) => {\n          group.forEach((key) => targetGroup.add(key));\n          const index = newGroups.indexOf(group);\n          if (index > -1) {\n            newGroups.splice(index, 1);\n          }\n        });\n        uniqueKeys.forEach((key) => targetGroup.add(key));\n      }\n\n      console.log('Set parallel groups:', newGroups);\n      return { parallelViews: newGroups };\n    });\n  },\n  unsetParallel: (bookKeys: string[]) => {\n    set((state) => {\n      const uniqueKeys = [...new Set(bookKeys.filter((key) => key.trim() !== ''))];\n      if (uniqueKeys.length === 0) {\n        return state;\n      }\n\n      const newGroups = [...state.parallelViews];\n      const affectedGroups = newGroups.filter((group) => uniqueKeys.some((key) => group.has(key)));\n      affectedGroups.forEach((group) => {\n        uniqueKeys.forEach((key) => group.delete(key));\n        if (group.size <= 1) {\n          const index = newGroups.indexOf(group);\n          if (index > -1) {\n            newGroups.splice(index, 1);\n          }\n        }\n      });\n\n      console.log('Unset parallel groups:', newGroups);\n      return { parallelViews: newGroups };\n    });\n  },\n\n  areParallels(bookKey1, bookKey2) {\n    const { parallelViews } = get();\n    return parallelViews.some((group) => group.has(bookKey1) && group.has(bookKey2));\n  },\n\n  getParallels(bookKey) {\n    const { parallelViews } = get();\n    return parallelViews.find((group) => group.has(bookKey)) || null;\n  },\n}));\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAUO,MAAM,uBAAuB,IAAA,wHAAM,EAAoB,CAAC,KAAK,MAAQ,CAAC;QAC3E,eAAe,EAAE;QAEjB,aAAa,CAAC;YACZ,IAAI,CAAC;gBACH,MAAM,aAAa;uBAAI,IAAI,IAAI,SAAS,MAAM,CAAC,CAAC,MAAQ,IAAI,IAAI,OAAO;iBAAK;gBAC5E,IAAI,WAAW,MAAM,GAAG,GAAG;oBACzB,OAAO;gBACT;gBAEA,MAAM,YAAY;uBAAI,MAAM,aAAa;iBAAC;gBAC1C,MAAM,iBAAiB,UAAU,MAAM,CAAC,CAAC,QAAU,WAAW,IAAI,CAAC,CAAC,MAAQ,MAAM,GAAG,CAAC;gBAEtF,IAAI;gBACJ,IAAI,eAAe,MAAM,KAAK,GAAG;oBAC/B,cAAc,IAAI,IAAI;oBACtB,UAAU,IAAI,CAAC;gBACjB,OAAO,IAAI,eAAe,MAAM,KAAK,GAAG;oBACtC,cAAc,cAAc,CAAC,EAAE;oBAC/B,WAAW,OAAO,CAAC,CAAC,MAAQ,YAAY,GAAG,CAAC;gBAC9C,OAAO;oBACL,cAAc,cAAc,CAAC,EAAE;oBAC/B,eAAe,KAAK,CAAC,GAAG,OAAO,CAAC,CAAC;wBAC/B,MAAM,OAAO,CAAC,CAAC,MAAQ,YAAY,GAAG,CAAC;wBACvC,MAAM,QAAQ,UAAU,OAAO,CAAC;wBAChC,IAAI,QAAQ,CAAC,GAAG;4BACd,UAAU,MAAM,CAAC,OAAO;wBAC1B;oBACF;oBACA,WAAW,OAAO,CAAC,CAAC,MAAQ,YAAY,GAAG,CAAC;gBAC9C;gBAEA,QAAQ,GAAG,CAAC,wBAAwB;gBACpC,OAAO;oBAAE,eAAe;gBAAU;YACpC;QACF;QACA,eAAe,CAAC;YACd,IAAI,CAAC;gBACH,MAAM,aAAa;uBAAI,IAAI,IAAI,SAAS,MAAM,CAAC,CAAC,MAAQ,IAAI,IAAI,OAAO;iBAAK;gBAC5E,IAAI,WAAW,MAAM,KAAK,GAAG;oBAC3B,OAAO;gBACT;gBAEA,MAAM,YAAY;uBAAI,MAAM,aAAa;iBAAC;gBAC1C,MAAM,iBAAiB,UAAU,MAAM,CAAC,CAAC,QAAU,WAAW,IAAI,CAAC,CAAC,MAAQ,MAAM,GAAG,CAAC;gBACtF,eAAe,OAAO,CAAC,CAAC;oBACtB,WAAW,OAAO,CAAC,CAAC,MAAQ,MAAM,MAAM,CAAC;oBACzC,IAAI,MAAM,IAAI,IAAI,GAAG;wBACnB,MAAM,QAAQ,UAAU,OAAO,CAAC;wBAChC,IAAI,QAAQ,CAAC,GAAG;4BACd,UAAU,MAAM,CAAC,OAAO;wBAC1B;oBACF;gBACF;gBAEA,QAAQ,GAAG,CAAC,0BAA0B;gBACtC,OAAO;oBAAE,eAAe;gBAAU;YACpC;QACF;QAEA,cAAa,QAAQ,EAAE,QAAQ;YAC7B,MAAM,EAAE,aAAa,EAAE,GAAG;YAC1B,OAAO,cAAc,IAAI,CAAC,CAAC,QAAU,MAAM,GAAG,CAAC,aAAa,MAAM,GAAG,CAAC;QACxE;QAEA,cAAa,OAAO;YAClB,MAAM,EAAE,aAAa,EAAE,GAAG;YAC1B,OAAO,cAAc,IAAI,CAAC,CAAC,QAAU,MAAM,GAAG,CAAC,aAAa;QAC9D;IACF,CAAC"}},
    {"offset": {"line": 3120, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/trafficLightStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { invoke } from '@tauri-apps/api/core';\nimport { AppService } from '@/types/system';\n\nconst WINDOW_CONTROL_PAD_X = 10.0;\nconst WINDOW_CONTROL_PAD_Y = 22.0;\n\ninterface TrafficLightState {\n  appService?: AppService;\n  isTrafficLightVisible: boolean;\n  shouldShowTrafficLight: boolean;\n  trafficLightInFullscreen: boolean;\n  initializeTrafficLightStore: (appService: AppService) => void;\n  setTrafficLightVisibility: (visible: boolean, position?: { x: number; y: number }) => void;\n  initializeTrafficLightListeners: () => Promise<void>;\n  cleanupTrafficLightListeners: () => void;\n  unlistenEnterFullScreen?: () => void;\n  unlistenExitFullScreen?: () => void;\n}\n\nexport const useTrafficLightStore = create<TrafficLightState>((set, get) => {\n  return {\n    appService: undefined,\n    isTrafficLightVisible: false,\n    shouldShowTrafficLight: false,\n    trafficLightInFullscreen: false,\n\n    initializeTrafficLightStore: (appService: AppService) => {\n      set({\n        appService,\n        isTrafficLightVisible: appService.hasTrafficLight,\n        shouldShowTrafficLight: appService.hasTrafficLight,\n      });\n    },\n\n    setTrafficLightVisibility: async (visible: boolean, position?: { x: number; y: number }) => {\n      const { getCurrentWindow } = await import('@tauri-apps/api/window');\n      const currentWindow = getCurrentWindow();\n      const isFullscreen = await currentWindow.isFullscreen();\n      set({\n        isTrafficLightVisible: !isFullscreen && visible,\n        shouldShowTrafficLight: visible,\n        trafficLightInFullscreen: isFullscreen,\n      });\n      invoke('set_traffic_lights', {\n        visible: visible,\n        x: position?.x ?? WINDOW_CONTROL_PAD_X,\n        y: position?.y ?? WINDOW_CONTROL_PAD_Y,\n      });\n    },\n\n    initializeTrafficLightListeners: async () => {\n      const { getCurrentWindow } = await import('@tauri-apps/api/window');\n      const currentWindow = getCurrentWindow();\n\n      const unlistenEnterFullScreen = await currentWindow.listen('will-enter-fullscreen', () => {\n        set({ isTrafficLightVisible: false, trafficLightInFullscreen: true });\n      });\n\n      const unlistenExitFullScreen = await currentWindow.listen('will-exit-fullscreen', () => {\n        const { shouldShowTrafficLight } = get();\n        set({ isTrafficLightVisible: shouldShowTrafficLight, trafficLightInFullscreen: false });\n      });\n\n      set({ unlistenEnterFullScreen, unlistenExitFullScreen });\n    },\n\n    cleanupTrafficLightListeners: () => {\n      const { unlistenEnterFullScreen, unlistenExitFullScreen } = get();\n      if (unlistenEnterFullScreen) unlistenEnterFullScreen();\n      if (unlistenExitFullScreen) unlistenExitFullScreen();\n      set({ unlistenEnterFullScreen: undefined, unlistenExitFullScreen: undefined });\n    },\n  };\n});\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;;AAGA,MAAM,uBAAuB;AAC7B,MAAM,uBAAuB;AAetB,MAAM,uBAAuB,IAAA,wHAAM,EAAoB,CAAC,KAAK;IAClE,OAAO;QACL,YAAY;QACZ,uBAAuB;QACvB,wBAAwB;QACxB,0BAA0B;QAE1B,6BAA6B,CAAC;YAC5B,IAAI;gBACF;gBACA,uBAAuB,WAAW,eAAe;gBACjD,wBAAwB,WAAW,eAAe;YACpD;QACF;QAEA,2BAA2B,OAAO,SAAkB;YAClD,MAAM,EAAE,gBAAgB,EAAE,GAAG;YAC7B,MAAM,gBAAgB;YACtB,MAAM,eAAe,MAAM,cAAc,YAAY;YACrD,IAAI;gBACF,uBAAuB,CAAC,gBAAgB;gBACxC,wBAAwB;gBACxB,0BAA0B;YAC5B;YACA,IAAA,sKAAM,EAAC,sBAAsB;gBAC3B,SAAS;gBACT,GAAG,UAAU,KAAK;gBAClB,GAAG,UAAU,KAAK;YACpB;QACF;QAEA,iCAAiC;YAC/B,MAAM,EAAE,gBAAgB,EAAE,GAAG;YAC7B,MAAM,gBAAgB;YAEtB,MAAM,0BAA0B,MAAM,cAAc,MAAM,CAAC,yBAAyB;gBAClF,IAAI;oBAAE,uBAAuB;oBAAO,0BAA0B;gBAAK;YACrE;YAEA,MAAM,yBAAyB,MAAM,cAAc,MAAM,CAAC,wBAAwB;gBAChF,MAAM,EAAE,sBAAsB,EAAE,GAAG;gBACnC,IAAI;oBAAE,uBAAuB;oBAAwB,0BAA0B;gBAAM;YACvF;YAEA,IAAI;gBAAE;gBAAyB;YAAuB;QACxD;QAEA,8BAA8B;YAC5B,MAAM,EAAE,uBAAuB,EAAE,sBAAsB,EAAE,GAAG;YAC5D,IAAI,yBAAyB;YAC7B,IAAI,wBAAwB;YAC5B,IAAI;gBAAE,yBAAyB;gBAAW,wBAAwB;YAAU;QAC9E;IACF;AACF"}},
    {"offset": {"line": 3202, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/store/customFontStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { EnvConfigType } from '@/services/environment';\nimport { CustomFont, createCustomFont, getFontFormat, getMimeType } from '@/styles/fonts';\nimport { useSettingsStore } from './settingsStore';\n\ninterface FontStoreState {\n  fonts: CustomFont[];\n  loading: boolean;\n\n  setFonts: (fonts: CustomFont[]) => void;\n  addFont: (path: string, options?: Partial<Omit<CustomFont, 'id' | 'path'>>) => CustomFont;\n  removeFont: (id: string) => boolean;\n  updateFont: (id: string, updates: Partial<CustomFont>) => boolean;\n  getFont: (id: string) => CustomFont | undefined;\n  getAllFonts: () => CustomFont[];\n  getAvailableFonts: () => CustomFont[];\n  clearAllFonts: () => void;\n\n  loadFont: (envConfig: EnvConfigType, fontId: string) => Promise<CustomFont>;\n  loadFonts: (envConfig: EnvConfigType, fontIds: string[]) => Promise<CustomFont[]>;\n  loadAllFonts: (envConfig: EnvConfigType) => Promise<CustomFont[]>;\n  unloadFont: (fontId: string) => boolean;\n  unloadAllFonts: () => void;\n\n  getFontFamilies: () => string[];\n  getLoadedFonts: () => CustomFont[];\n  isFontLoaded: (fontId: string) => boolean;\n\n  loadCustomFonts: (envConfig: EnvConfigType) => Promise<void>;\n  saveCustomFonts: (envConfig: EnvConfigType) => Promise<void>;\n}\n\nfunction toSettingsFont(font: CustomFont): CustomFont {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  const { blobUrl, loaded, error, ...settingsFont } = font;\n  return settingsFont;\n}\n\nexport const useCustomFontStore = create<FontStoreState>((set, get) => ({\n  fonts: [],\n  loading: false,\n\n  setFonts: (fonts) => set({ fonts }),\n  addFont: (path, options) => {\n    const font = createCustomFont(path, options);\n    const existingFont = get().fonts.find((f) => f.id === font.id);\n    if (existingFont) {\n      get().updateFont(font.id, {\n        ...font,\n        path: font.path,\n        downloadedAt: Date.now(),\n        deletedAt: undefined,\n        loaded: false,\n        blobUrl: undefined,\n        error: undefined,\n      });\n      set((state) => ({\n        fonts: [...state.fonts],\n      }));\n      return existingFont;\n    }\n\n    const newFont = {\n      ...font,\n      downloadedAt: Date.now(),\n    };\n\n    set((state) => ({\n      fonts: [...state.fonts, newFont],\n    }));\n\n    return newFont;\n  },\n\n  removeFont: (id) => {\n    const font = get().getFont(id);\n    if (!font) return false;\n\n    if (font.blobUrl) {\n      URL.revokeObjectURL(font.blobUrl);\n    }\n\n    const result = get().updateFont(id, {\n      deletedAt: Date.now(),\n      blobUrl: undefined,\n      loaded: false,\n      error: undefined,\n    });\n    set((state) => ({\n      fonts: [...state.fonts],\n    }));\n    return result;\n  },\n\n  updateFont: (id, updates) => {\n    const state = get();\n    const fontIndex = state.fonts.findIndex((font) => font.id === id);\n\n    if (fontIndex === -1) return false;\n\n    set((state) => ({\n      fonts: state.fonts.map((font, index) =>\n        index === fontIndex ? { ...font, ...updates } : font,\n      ),\n    }));\n\n    return true;\n  },\n\n  getFont: (id) => {\n    return get().fonts.find((font) => font.id === id);\n  },\n\n  getAllFonts: () => {\n    return get().fonts;\n  },\n\n  getAvailableFonts: () => {\n    return get().fonts.filter((font) => !font.deletedAt);\n  },\n\n  clearAllFonts: () => {\n    const { fonts } = get();\n    fonts.forEach((font) => {\n      if (font.blobUrl) {\n        URL.revokeObjectURL(font.blobUrl);\n      }\n    });\n\n    set({ fonts: [] });\n  },\n\n  loadFont: async (envConfig, fontId) => {\n    const font = get().getFont(fontId);\n\n    if (!font) {\n      throw new Error(`Font with id \"${fontId}\" not found`);\n    }\n\n    if (font.deletedAt) {\n      throw new Error(`Font \"${font.name}\" has been deleted`);\n    }\n\n    if (font.loaded && font.blobUrl && !font.error) {\n      return font;\n    }\n\n    try {\n      get().updateFont(fontId, {\n        loaded: false,\n        error: undefined,\n      });\n\n      const appService = await envConfig.getAppService();\n      const fontFile = await appService.openFile(font.path, 'Fonts');\n\n      const format = getFontFormat(font.path);\n      const mimeType = getMimeType(format);\n      const blob = new Blob([await fontFile.arrayBuffer()], { type: mimeType });\n      const blobUrl = URL.createObjectURL(blob);\n\n      get().updateFont(fontId, {\n        blobUrl,\n        loaded: true,\n        error: undefined,\n      });\n\n      const updatedFont = get().getFont(fontId)!;\n      return updatedFont;\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      get().updateFont(fontId, {\n        loaded: false,\n        error: errorMessage,\n        blobUrl: undefined,\n      });\n\n      throw error;\n    }\n  },\n\n  loadFonts: async (envConfig, fontIds) => {\n    set({ loading: true });\n    try {\n      const results = await Promise.allSettled(fontIds.map((id) => get().loadFont(envConfig, id)));\n\n      return results\n        .filter(\n          (result): result is PromiseFulfilledResult<CustomFont> => result.status === 'fulfilled',\n        )\n        .map((result) => result.value);\n    } finally {\n      set({ loading: false });\n    }\n  },\n\n  loadAllFonts: async (envConfig) => {\n    const fontIds = get()\n      .getAvailableFonts()\n      .map((font) => font.id);\n    return await get().loadFonts(envConfig, fontIds);\n  },\n\n  unloadFont: (fontId) => {\n    const font = get().getFont(fontId);\n\n    if (font?.blobUrl) {\n      URL.revokeObjectURL(font.blobUrl);\n    }\n\n    return get().updateFont(fontId, {\n      blobUrl: undefined,\n      loaded: false,\n      error: undefined,\n    });\n  },\n\n  unloadAllFonts: () => {\n    const fonts = get().getAllFonts();\n\n    fonts.forEach((font) => {\n      if (font.blobUrl) {\n        URL.revokeObjectURL(font.blobUrl);\n      }\n    });\n\n    fonts.forEach((font) => {\n      get().updateFont(font.id, {\n        blobUrl: undefined,\n        loaded: false,\n        error: undefined,\n      });\n    });\n  },\n\n  getFontFamilies: () => {\n    return get()\n      .getAvailableFonts()\n      .filter((font) => font.loaded && !font.error)\n      .map((font) => font.family || font.name)\n      .filter((value, index, self) => self.indexOf(value) === index)\n      .sort((a, b) => a.localeCompare(b));\n  },\n\n  getLoadedFonts: () => {\n    return get()\n      .getAvailableFonts()\n      .filter((font) => font.loaded && !font.error);\n  },\n\n  isFontLoaded: (fontId) => {\n    const font = get().getFont(fontId);\n    return font?.loaded === true && !font.error && !font.deletedAt;\n  },\n\n  loadCustomFonts: async (envConfig) => {\n    try {\n      const { settings } = useSettingsStore.getState();\n      const currentFonts = get().fonts;\n      if (settings?.customFonts) {\n        const fonts = settings.customFonts.map((font) => {\n          const existingFont = currentFonts.find((f) => f.id === font.id);\n          return {\n            ...font,\n            loaded: existingFont?.loaded || false,\n            error: existingFont?.error,\n            blobUrl: existingFont?.blobUrl,\n          };\n        });\n        set({ fonts });\n        await get().loadAllFonts(envConfig);\n      }\n    } catch (error) {\n      console.error('Failed to load custom fonts settings:', error);\n    }\n  },\n\n  saveCustomFonts: async (envConfig) => {\n    try {\n      const { settings, setSettings, saveSettings } = useSettingsStore.getState();\n      const { fonts } = get();\n      settings.customFonts = fonts.map(toSettingsFont);\n      setSettings(settings);\n      saveSettings(envConfig, settings);\n    } catch (error) {\n      console.error('Failed to save custom fonts settings:', error);\n      throw error;\n    }\n  },\n}));\n\nif (typeof window !== 'undefined') {\n  window.addEventListener('beforeunload', () => {\n    const store = useCustomFontStore.getState();\n    const fonts = store.getAllFonts();\n    fonts.forEach((font) => {\n      if (font.blobUrl) {\n        URL.revokeObjectURL(font.blobUrl);\n      }\n    });\n  });\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3451, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/types/book.ts"],"sourcesContent":["import { BookMetadata } from '@/libs/document';\nimport { TTSHighlightOptions } from '@/services/tts/types';\nimport { AnnotationToolType } from './annotator';\n\nexport type BookFormat =\n  | 'EPUB'\n  | 'PDF'\n  | 'MOBI'\n  | 'AZW'\n  | 'AZW3'\n  | 'CBZ'\n  | 'FB2'\n  | 'FBZ'\n  | 'TXT'\n  | 'MD';\nexport type BookNoteType = 'bookmark' | 'annotation' | 'excerpt';\nexport type HighlightStyle = 'highlight' | 'underline' | 'squiggly';\nexport type HighlightColor = 'red' | 'yellow' | 'green' | 'blue' | 'violet';\n\nexport const FIXED_LAYOUT_FORMATS: Set<BookFormat> = new Set(['PDF', 'CBZ']);\n\nexport interface Book {\n  // if Book is a remote book we just lazy load the book content via url\n  url?: string;\n  // if Book is a transient local book we can load the book content via filePath\n  filePath?: string;\n  // For local storage mode: relative path from storage root (e.g., \"fiction/book.epub\")\n  relativePath?: string;\n  // Absolute file path in the file system (for path reconciliation)\n  absolutePath?: string;\n  // Partial md5 hash of the book file, used as the unique identifier\n  hash: string;\n  // Metadata md5 hash, used to aggregate different versions of the same book\n  metaHash?: string;\n  format: BookFormat;\n  title: string; // editable title from metadata\n  sourceTitle?: string; // parsed when the book is imported and used to locate the file\n  author: string;\n  group?: string; // deprecated in favor of groupId and groupName\n  groupId?: string;\n  groupName?: string;\n  tags?: string[];\n  coverImageUrl?: string | null;\n\n  createdAt: number;\n  updatedAt: number;\n  deletedAt?: number | null;\n\n  uploadedAt?: number | null;\n  downloadedAt?: number | null;\n  coverDownloadedAt?: number | null;\n  syncedAt?: number | null;\n\n  lastUpdated?: number; // deprecated in favor of updatedAt\n  progress?: [number, number]; // Add progress field: [current, total], 1-based page number\n  primaryLanguage?: string;\n\n  metadata?: BookMetadata;\n}\n\nexport interface BookGroupType {\n  id: string;\n  name: string;\n}\n\nexport interface PageInfo {\n  current: number;\n  next?: number;\n  total: number;\n}\n\n// Remaining time of the book in minutes\nexport interface TimeInfo {\n  section: number;\n  total: number;\n}\n\nexport interface BookNote {\n  bookHash?: string;\n  metaHash?: string;\n  id: string;\n  type: BookNoteType;\n  cfi: string;\n  text?: string;\n  style?: HighlightStyle;\n  color?: HighlightColor;\n  note: string;\n\n  createdAt: number;\n  updatedAt: number;\n  deletedAt?: number | null;\n}\n\nexport interface BooknoteGroup {\n  id: number;\n  href: string;\n  label: string;\n  booknotes: BookNote[];\n}\n\nexport type WritingMode = 'auto' | 'horizontal-tb' | 'horizontal-rl' | 'vertical-rl';\n\nexport interface BookLayout {\n  marginTopPx: number;\n  marginBottomPx: number;\n  marginLeftPx: number;\n  marginRightPx: number;\n  marginPx?: number; // deprecated\n  compactMarginTopPx: number;\n  compactMarginBottomPx: number;\n  compactMarginLeftPx: number;\n  compactMarginRightPx: number;\n  compactMarginPx?: number; // deprecated\n  gapPercent: number;\n  scrolled: boolean;\n  disableClick: boolean;\n  fullscreenClickArea: boolean;\n  swapClickArea: boolean;\n  disableDoubleClick: boolean;\n  volumeKeysToFlip: boolean;\n  continuousScroll: boolean;\n  maxColumnCount: number;\n  maxInlineSize: number;\n  maxBlockSize: number;\n  animated: boolean;\n  isEink: boolean;\n  writingMode: WritingMode;\n  vertical: boolean;\n  rtl: boolean;\n  scrollingOverlap: number;\n  allowScript: boolean;\n}\n\nexport interface BookStyle {\n  zoomLevel: number;\n  paragraphMargin: number;\n  lineHeight: number;\n  wordSpacing: number;\n  letterSpacing: number;\n  textIndent: number;\n  fullJustification: boolean;\n  hyphenation: boolean;\n  invertImgColorInDark: boolean;\n  theme: string;\n  overrideFont: boolean;\n  overrideLayout: boolean;\n  overrideColor: boolean;\n  backgroundTextureId: string;\n  backgroundOpacity: number;\n  backgroundSize: string;\n  codeHighlighting: boolean;\n  codeLanguage: string;\n  userStylesheet: string;\n  userUIStylesheet: string;\n\n  // fixed-layout specific\n  zoomMode: 'fit-page' | 'fit-width' | 'original-size' | 'custom';\n  spreadMode: 'auto' | 'none';\n  keepCoverSpread: boolean;\n}\n\nexport interface BookFont {\n  serifFont: string;\n  sansSerifFont: string;\n  monospaceFont: string;\n  defaultFont: string;\n  defaultCJKFont: string;\n  defaultFontSize: number;\n  minimumFontSize: number;\n  fontWeight: number;\n}\n\nexport type ConvertChineseVariant =\n  | 'none'\n  | 's2t'\n  | 't2s'\n  | 's2tw'\n  | 's2hk'\n  | 's2twp'\n  | 'tw2s'\n  | 'hk2s'\n  | 'tw2sp';\n\nexport interface BookLanguage {\n  replaceQuotationMarks: boolean;\n  convertChineseVariant: ConvertChineseVariant;\n}\n\nexport interface ViewConfig {\n  sideBarTab: string;\n  uiLanguage: string;\n  sortedTOC: boolean;\n\n  doubleBorder: boolean;\n  borderColor: string;\n\n  showHeader: boolean;\n  showFooter: boolean;\n  showRemainingTime: boolean;\n  showRemainingPages: boolean;\n  showProgressInfo: boolean;\n  tapToToggleFooter: boolean;\n  showBarsOnScroll: boolean;\n  showMarginsOnScroll: boolean;\n  progressStyle: 'percentage' | 'fraction';\n  progressInfoMode: 'remaining' | 'progress' | 'all' | 'none';\n}\n\nexport interface TTSConfig {\n  ttsRate: number;\n  ttsVoice: string;\n  ttsLocation: string;\n  showTTSBar: boolean;\n  ttsHighlightOptions: TTSHighlightOptions;\n}\n\nexport interface TranslatorConfig {\n  translationEnabled: boolean;\n  translationProvider: string;\n  translateTargetLang: string;\n  showTranslateSource: boolean;\n  ttsReadAloudText: string;\n}\n\nexport interface NoteExportConfig {\n  includeTitle: boolean;\n  includeAuthor: boolean;\n  includeDate: boolean;\n  includeChapterTitles: boolean;\n  includeQuotes: boolean;\n  includeNotes: boolean;\n  includeTimestamp: boolean;\n  includeChapterSeparator: boolean;\n  noteSeparator: string;\n  useCustomTemplate: boolean;\n  customTemplate: string;\n}\n\nexport interface AnnotatorConfig {\n  enableAnnotationQuickActions: boolean;\n  annotationQuickAction: AnnotationToolType | null;\n  copyToNotebook: boolean;\n  noteExportConfig: NoteExportConfig;\n}\n\nexport interface ScreenConfig {\n  screenOrientation: 'auto' | 'portrait' | 'landscape';\n}\n\nexport type ProofreadScope = 'selection' | 'book' | 'library';\n\nexport interface ProofreadRule {\n  id: string;\n  scope: ProofreadScope;\n  pattern: string;\n  replacement: string;\n  cfi?: string;\n  sectionHref?: string;\n  enabled: boolean;\n  isRegex: boolean;\n  order: number; // Lower numbers apply first\n  wholeWord?: boolean; // Match whole words only (uses \\b word boundaries)\n  caseSensitive?: boolean; // Case-sensitive matching (default true)\n  onlyForTTS?: boolean; // Only replace text for TTS, not in the book display (only for book/library scope)\n}\n\nexport interface ProofreadRulesConfig {\n  proofreadRules?: ProofreadRule[];\n}\n\nexport interface ViewSettings\n  extends BookLayout,\n  BookStyle,\n  BookFont,\n  BookLanguage,\n  ViewConfig,\n  TTSConfig,\n  TranslatorConfig,\n  ScreenConfig,\n  ProofreadRulesConfig,\n  AnnotatorConfig { }\n\nexport interface BookProgress {\n  location: string;\n  sectionId: number;\n  sectionHref: string;\n  sectionLabel: string;\n  section: PageInfo;\n  pageinfo: PageInfo;\n  timeinfo: TimeInfo;\n  range: Range;\n}\n\nexport interface BookSearchConfig {\n  scope: 'book' | 'section';\n  matchCase: boolean;\n  matchWholeWords: boolean;\n  matchDiacritics: boolean;\n  index?: number;\n  query?: string;\n  acceptNode?: (node: Node) => number;\n\n  // pre-cached search results\n  results?: BookSearchResult[] | BookSearchMatch[] | null;\n}\n\nexport interface SearchExcerpt {\n  pre: string;\n  match: string;\n  post: string;\n}\n\nexport interface BookSearchMatch {\n  cfi: string;\n  excerpt: SearchExcerpt;\n}\n\nexport interface BookSearchResult {\n  index?: number;\n  label: string;\n  subitems: BookSearchMatch[];\n  progress?: number;\n}\n\nexport interface BookConfig {\n  bookHash?: string;\n  metaHash?: string;\n  progress?: [number, number]; // [current pagenum, total pagenum], 1-based page number\n  location?: string; // CFI of the current location\n  xpointer?: string; // XPointer of the current location (for Koreader interoperability)\n  booknotes?: BookNote[];\n  searchConfig?: Partial<BookSearchConfig>;\n  viewSettings?: Partial<ViewSettings>;\n\n  lastSyncedAtConfig?: number;\n  lastSyncedAtNotes?: number;\n\n  updatedAt: number;\n}\n\nexport interface BookDataRecord {\n  id: string;\n  book_hash: string;\n  meta_hash?: string;\n  user_id: string;\n  updated_at: number | null;\n  deleted_at: number | null;\n}\n\nexport interface BooksGroup {\n  id: string;\n  name: string;\n  displayName: string;\n  books: Book[];\n\n  updatedAt: number;\n}\nexport interface BookContent {\n  book: Book;\n  file: File;\n}\n"],"names":[],"mappings":";;;;AAmBO,MAAM,uBAAwC,IAAI,IAAI;IAAC;IAAO;CAAM"}},
    {"offset": {"line": 3463, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/types/view.ts"],"sourcesContent":["import { BookDoc } from '@/libs/document';\nimport { BookNote, BookSearchConfig, BookSearchResult } from '@/types/book';\nimport { TTSGranularity } from '@/services/tts';\nimport { TTS } from 'foliate-js/tts.js';\nimport { LocaleWithTextInfo } from './misc';\n\nexport const NOTE_PREFIX = 'foliate-note:';\n\nexport interface FoliateView extends HTMLElement {\n  open: (book: BookDoc) => Promise<void>;\n  close: () => void;\n  init: (options: { lastLocation: string }) => void;\n  goTo: (href: string) => void;\n  goToFraction: (fraction: number) => void;\n  prev: (distance?: number) => void;\n  next: (distance?: number) => void;\n  pan: (dx: number, dy: number) => void;\n  isOverflowX: () => boolean;\n  isOverflowY: () => boolean;\n  goLeft: () => void;\n  goRight: () => void;\n  getCFI: (index: number, range: Range) => string;\n  resolveCFI: (cfi: string) => { index: number; anchor: (doc: Document) => Range };\n  addAnnotation: (\n    note: BookNote & { value?: string },\n    remove?: boolean,\n  ) => { index: number; label: string };\n  search: (config: BookSearchConfig) => AsyncGenerator<BookSearchResult | string, void, void>;\n  clearSearch: () => void;\n  select: (target: string | number | { fraction: number }) => void;\n  deselect: () => void;\n  initTTS: (\n    granularity?: TTSGranularity,\n    nodeFilter?: (node: Node) => number,\n    highlight?: (range: Range) => void,\n  ) => Promise<void>;\n  book: BookDoc;\n  tts: TTS | null;\n  language: {\n    locale?: LocaleWithTextInfo;\n    isCJK?: boolean;\n    canonical?: string;\n    direction?: string;\n  };\n  history: {\n    canGoBack: boolean;\n    canGoForward: boolean;\n    back: () => void;\n    forward: () => void;\n    clear: () => void;\n  };\n  renderer: {\n    scrolled?: boolean;\n    scrollLocked: boolean;\n    size: number; // current page height\n    viewSize: number; // whole document view height\n    start: number;\n    end: number;\n    page: number;\n    pages: number;\n    containerPosition: number;\n    sideProp: 'width' | 'height';\n    setAttribute: (name: string, value: string | number) => void;\n    removeAttribute: (name: string) => void;\n    next: () => Promise<void>;\n    prev: () => Promise<void>;\n    nextSection?: () => Promise<void>;\n    prevSection?: () => Promise<void>;\n    goTo?: (params: { index: number; anchor: number }) => void;\n    setStyles?: (css: string) => void;\n    getContents: () => { doc: Document; index?: number; overlayer?: unknown }[];\n    scrollToAnchor: (anchor: number | Range) => void;\n    addEventListener: (\n      type: string,\n      listener: EventListener,\n      option?: AddEventListenerOptions,\n    ) => void;\n    removeEventListener: (type: string, listener: EventListener) => void;\n  };\n}\n\nexport const wrappedFoliateView = (originalView: FoliateView): FoliateView => {\n  const originalAddAnnotation = originalView.addAnnotation.bind(originalView);\n  originalView.addAnnotation = (note: BookNote, remove = false) => {\n    // transform BookNote to foliate annotation\n    const annotation = {\n      value: note.cfi,\n      ...note,\n    };\n    return originalAddAnnotation(annotation, remove);\n  };\n  return originalView;\n};\n"],"names":[],"mappings":";;;;;;AAMO,MAAM,cAAc;AA2EpB,MAAM,qBAAqB,CAAC;IACjC,MAAM,wBAAwB,aAAa,aAAa,CAAC,IAAI,CAAC;IAC9D,aAAa,aAAa,GAAG,CAAC,MAAgB,SAAS,KAAK;QAC1D,2CAA2C;QAC3C,MAAM,aAAa;YACjB,OAAO,KAAK,GAAG;YACf,GAAG,IAAI;QACT;QACA,OAAO,sBAAsB,YAAY;IAC3C;IACA,OAAO;AACT"}},
    {"offset": {"line": 3486, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/libs/document.ts"],"sourcesContent":["import { BookFormat } from '@/types/book';\nimport { Contributor, Identifier, LanguageMap } from '@/utils/book';\nimport * as epubcfi from 'foliate-js/epubcfi.js';\n\nexport const CFI = epubcfi;\n\nexport type DocumentFile = File;\n\nexport type Location = {\n  current: number;\n  next: number;\n  total: number;\n};\n\nexport interface TOCItem {\n  id: number;\n  label: string;\n  href: string;\n  cfi?: string;\n  location?: Location;\n  subitems?: TOCItem[];\n}\n\nexport interface SectionItem {\n  id: string;\n  cfi: string;\n  size: number;\n  linear: string;\n  location?: Location;\n  pageSpread?: 'left' | 'right' | 'center' | '';\n\n  createDocument: () => Promise<Document>;\n}\n\nexport type BookMetadata = {\n  // NOTE: the title and author fields should be formatted\n  title: string | LanguageMap;\n  author: string | Contributor;\n  language: string | string[];\n  editor?: string;\n  publisher?: string;\n  published?: string;\n  description?: string;\n  subject?: string | string[] | Contributor;\n  identifier?: string;\n  altIdentifier?: string | string[] | Identifier;\n\n  subtitle?: string;\n  series?: string;\n  seriesIndex?: number;\n  seriesTotal?: number;\n\n  coverImageFile?: string;\n  coverImageUrl?: string;\n  coverImageBlobUrl?: string;\n};\n\nexport interface BookDoc {\n  metadata: BookMetadata;\n  rendition?: {\n    layout?: 'pre-paginated' | 'reflowable';\n    spread?: 'auto' | 'none';\n    viewport?: { width: number; height: number };\n  };\n  dir: string;\n  toc?: Array<TOCItem>;\n  sections?: Array<SectionItem>;\n  transformTarget?: EventTarget;\n  splitTOCHref(href: string): Array<string | number>;\n  getCover(): Promise<Blob | null>;\n}\n\nexport const EXTS: Record<BookFormat, string> = {\n  EPUB: 'epub',\n  PDF: 'pdf',\n  MOBI: 'mobi',\n  AZW: 'azw',\n  AZW3: 'azw3',\n  CBZ: 'cbz',\n  FB2: 'fb2',\n  FBZ: 'fbz',\n  TXT: 'txt',\n  MD: 'md',\n};\n\nexport const MIMETYPES: Record<BookFormat, string[]> = {\n  EPUB: ['application/epub+zip'],\n  PDF: ['application/pdf'],\n  MOBI: ['application/x-mobipocket-ebook'],\n  AZW: ['application/vnd.amazon.ebook'],\n  AZW3: ['application/vnd.amazon.mobi8-ebook', 'application/x-mobi8-ebook'],\n  CBZ: ['application/vnd.comicbook+zip', 'application/zip', 'application/x-cbz'],\n  FB2: ['application/x-fictionbook+xml', 'text/xml', 'application/xml'],\n  FBZ: ['application/x-zip-compressed-fb2', 'application/zip'],\n  TXT: ['text/plain'],\n  MD: ['text/markdown', 'text/x-markdown'],\n};\n\nexport class DocumentLoader {\n  private file: File;\n\n  constructor(file: File) {\n    this.file = file;\n  }\n\n  private async isZip(): Promise<boolean> {\n    const arr = new Uint8Array(await this.file.slice(0, 4).arrayBuffer());\n    return arr[0] === 0x50 && arr[1] === 0x4b && arr[2] === 0x03 && arr[3] === 0x04;\n  }\n\n  private async isPDF(): Promise<boolean> {\n    const arr = new Uint8Array(await this.file.slice(0, 5).arrayBuffer());\n    return (\n      arr[0] === 0x25 && arr[1] === 0x50 && arr[2] === 0x44 && arr[3] === 0x46 && arr[4] === 0x2d\n    );\n  }\n\n  private async makeZipLoader() {\n    const getComment = async (): Promise<string | null> => {\n      const EOCD_SIGNATURE = [0x50, 0x4b, 0x05, 0x06];\n      const maxEOCDSearch = 1024 * 64;\n\n      const sliceSize = Math.min(maxEOCDSearch, this.file.size);\n      const tail = await this.file.slice(this.file.size - sliceSize, this.file.size).arrayBuffer();\n      const bytes = new Uint8Array(tail);\n\n      for (let i = bytes.length - 22; i >= 0; i--) {\n        if (\n          bytes[i] === EOCD_SIGNATURE[0] &&\n          bytes[i + 1] === EOCD_SIGNATURE[1] &&\n          bytes[i + 2] === EOCD_SIGNATURE[2] &&\n          bytes[i + 3] === EOCD_SIGNATURE[3]\n        ) {\n          const commentLength = bytes[i + 20]! + (bytes[i + 21]! << 8);\n          const commentStart = i + 22;\n          const commentBytes = bytes.slice(commentStart, commentStart + commentLength);\n          return new TextDecoder().decode(commentBytes);\n        }\n      }\n\n      return null;\n    };\n\n    const { configure, ZipReader, BlobReader, TextWriter, BlobWriter } = await import(\n      '@zip.js/zip.js'\n    );\n    type Entry = import('@zip.js/zip.js').Entry;\n    configure({ useWebWorkers: false });\n    const reader = new ZipReader(new BlobReader(this.file));\n    const entries = await reader.getEntries();\n    const map = new Map(entries.map((entry) => [entry.filename, entry]));\n    const load =\n      (f: (entry: Entry, type?: string) => Promise<string | Blob> | null) =>\n      (name: string, ...args: [string?]) =>\n        map.has(name) ? f(map.get(name)!, ...args) : null;\n\n    const loadText = load((entry: Entry) =>\n      entry.getData ? entry.getData(new TextWriter()) : null,\n    );\n    const loadBlob = load((entry: Entry, type?: string) =>\n      entry.getData ? entry.getData(new BlobWriter(type!)) : null,\n    );\n    const getSize = (name: string) => map.get(name)?.uncompressedSize ?? 0;\n\n    return { entries, loadText, loadBlob, getSize, getComment, sha1: undefined };\n  }\n\n  private isCBZ(): boolean {\n    return (\n      this.file.type === 'application/vnd.comicbook+zip' || this.file.name.endsWith(`.${EXTS.CBZ}`)\n    );\n  }\n\n  private isFB2(): boolean {\n    return (\n      this.file.type === 'application/x-fictionbook+xml' || this.file.name.endsWith(`.${EXTS.FB2}`)\n    );\n  }\n\n  private isFBZ(): boolean {\n    return (\n      this.file.type === 'application/x-zip-compressed-fb2' ||\n      this.file.name.endsWith('.fb.zip') ||\n      this.file.name.endsWith('.fb2.zip') ||\n      this.file.name.endsWith(`.${EXTS.FBZ}`)\n    );\n  }\n\n  public async open(): Promise<{ book: BookDoc; format: BookFormat }> {\n    let book = null;\n    let format: BookFormat = 'EPUB';\n    if (!this.file.size) {\n      throw new Error('File is empty');\n    }\n    try {\n      if (await this.isZip()) {\n        const loader = await this.makeZipLoader();\n        const { entries } = loader;\n\n        if (this.isCBZ()) {\n          const { makeComicBook } = await import('foliate-js/comic-book.js');\n          book = await makeComicBook(loader, this.file);\n          format = 'CBZ';\n        } else if (this.isFBZ()) {\n          const entry = entries.find((entry) => entry.filename.endsWith(`.${EXTS.FB2}`));\n          const blob = await loader.loadBlob((entry ?? entries[0]!).filename);\n          const { makeFB2 } = await import('foliate-js/fb2.js');\n          book = await makeFB2(blob);\n          format = 'FBZ';\n        } else {\n          const { EPUB } = await import('foliate-js/epub.js');\n          book = await new EPUB(loader).init();\n          format = 'EPUB';\n        }\n      } else if (await this.isPDF()) {\n        const { makePDF } = await import('foliate-js/pdf.js');\n        book = await makePDF(this.file);\n        format = 'PDF';\n      } else if (await (await import('foliate-js/mobi.js')).isMOBI(this.file)) {\n        const fflate = await import('foliate-js/vendor/fflate.js');\n        const { MOBI } = await import('foliate-js/mobi.js');\n        book = await new MOBI({ unzlib: fflate.unzlibSync }).open(this.file);\n        const ext = this.file.name.split('.').pop()?.toLowerCase();\n        switch (ext) {\n          case 'azw':\n            format = 'AZW';\n            break;\n          case 'azw3':\n            format = 'AZW3';\n            break;\n          default:\n            format = 'MOBI';\n        }\n      } else if (this.isFB2()) {\n        const { makeFB2 } = await import('foliate-js/fb2.js');\n        book = await makeFB2(this.file);\n        format = 'FB2';\n      }\n    } catch (e: unknown) {\n      console.error('Failed to open document:', e);\n      if (e instanceof Error && e.message?.includes('not a valid zip')) {\n        throw new Error('Unsupported or corrupted book file');\n      }\n      throw e;\n    }\n    return { book, format } as { book: BookDoc; format: BookFormat };\n  }\n}\n\nexport const getDirection = (doc: Document) => {\n  const { defaultView } = doc;\n  const { writingMode, direction } = defaultView!.getComputedStyle(doc.body);\n  const vertical = writingMode === 'vertical-rl' || writingMode === 'vertical-lr';\n  const rtl = doc.body.dir === 'rtl' || direction === 'rtl' || doc.documentElement.dir === 'rtl';\n  return { vertical, rtl };\n};\n\nexport const getFileExtFromMimeType = (mimeType?: string): string => {\n  if (!mimeType) return '';\n\n  for (const format in MIMETYPES) {\n    const list = MIMETYPES[format as BookFormat];\n    if (list.includes(mimeType)) {\n      return EXTS[format as BookFormat];\n    }\n  }\n  return '';\n};\n\nexport const getMimeTypeFromFileExt = (ext: string): string => {\n  ext = ext.toLowerCase();\n  for (const format in EXTS) {\n    if (EXTS[format as BookFormat] === ext) {\n      const mimeTypes = MIMETYPES[format as BookFormat];\n      return mimeTypes[0] || 'application/octet-stream';\n    }\n  }\n  return 'application/octet-stream';\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3723, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/libs/metadata.ts"],"sourcesContent":["import { MetadataResult, SearchRequest } from '@/services/metadata/types';\nimport { getAPIBaseUrl } from '@/services/environment';\nimport { fetchWithAuth } from '@/utils/fetch';\n\ninterface ApiResponse<T> {\n  success: boolean;\n  data?: T;\n  error?: string;\n  timestamp: string;\n  responseTime?: number;\n}\n\nconst API_ENDPOINT = getAPIBaseUrl() + '/metadata/search';\n\nexport const searchMetadata = async (request: SearchRequest): Promise<MetadataResult[]> => {\n  const response = await fetchWithAuth(API_ENDPOINT, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(request),\n  });\n\n  const result: ApiResponse<MetadataResult[]> = await response.json();\n\n  if (!result.success) {\n    throw new Error(result.error || 'Search failed');\n  }\n\n  return result.data || [];\n};\n"],"names":[],"mappings":";;;;AACA;AACA;;;;;;;AAUA,MAAM,eAAe,IAAA,kKAAa,MAAK;AAEhC,MAAM,iBAAiB,OAAO;IACnC,MAAM,WAAW,MAAM,IAAA,yJAAa,EAAC,cAAc;QACjD,QAAQ;QACR,SAAS;YACP,gBAAgB;QAClB;QACA,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,MAAM,SAAwC,MAAM,SAAS,IAAI;IAEjE,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,IAAI,MAAM,OAAO,KAAK,IAAI;IAClC;IAEA,OAAO,OAAO,IAAI,IAAI,EAAE;AAC1B"}},
    {"offset": {"line": 3757, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/libs/edgeTTS.ts"],"sourcesContent":["import { md5 } from 'js-md5';\nimport WebSocket from 'isomorphic-ws';\nimport { createHash } from 'crypto';\nimport { randomMd5 } from '@/utils/misc';\nimport { LRUCache } from '@/utils/lru';\nimport { genSSML } from '@/utils/ssml';\nimport { fetchWithAuth } from '@/utils/fetch';\nimport { getNodeAPIBaseUrl, isTauriAppPlatform } from '@/services/environment';\n\nconst EDGE_SPEECH_URL =\n  'wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1';\nconst EDGE_API_TOKEN = '6A5AA1D4EAFF4E9FB37E23D68491D6F4';\nconst CHROMIUM_FULL_VERSION = '143.0.3650.75';\nconst CHROMIUM_MAJOR_VERSION = CHROMIUM_FULL_VERSION.split('.')[0];\n\nconst EDGE_TTS_VOICES = {\n  'af-ZA': ['af-ZA-AdriNeural', 'af-ZA-WillemNeural'],\n  'am-ET': ['am-ET-AmehaNeural', 'am-ET-MekdesNeural'],\n  'ar-AE': ['ar-AE-FatimaNeural', 'ar-AE-HamdanNeural'],\n  'ar-BH': ['ar-BH-AliNeural', 'ar-BH-LailaNeural'],\n  'ar-DZ': ['ar-DZ-AminaNeural', 'ar-DZ-IsmaelNeural'],\n  'ar-EG': ['ar-EG-SalmaNeural', 'ar-EG-ShakirNeural'],\n  'ar-IQ': ['ar-IQ-BasselNeural', 'ar-IQ-RanaNeural'],\n  'ar-JO': ['ar-JO-SanaNeural', 'ar-JO-TaimNeural'],\n  'ar-KW': ['ar-KW-FahedNeural', 'ar-KW-NouraNeural'],\n  'ar-LB': ['ar-LB-LaylaNeural', 'ar-LB-RamiNeural'],\n  'ar-LY': ['ar-LY-ImanNeural', 'ar-LY-OmarNeural'],\n  'ar-MA': ['ar-MA-JamalNeural', 'ar-MA-MounaNeural'],\n  'ar-OM': ['ar-OM-AbdullahNeural', 'ar-OM-AyshaNeural'],\n  'ar-QA': ['ar-QA-AmalNeural', 'ar-QA-MoazNeural'],\n  'ar-SA': ['ar-SA-HamedNeural', 'ar-SA-ZariyahNeural'],\n  'ar-SY': ['ar-SY-AmanyNeural', 'ar-SY-LaithNeural'],\n  'ar-TN': ['ar-TN-HediNeural', 'ar-TN-ReemNeural'],\n  'ar-YE': ['ar-YE-MaryamNeural', 'ar-YE-SalehNeural'],\n  'az-AZ': ['az-AZ-BabekNeural', 'az-AZ-BanuNeural'],\n  'bg-BG': ['bg-BG-BorislavNeural', 'bg-BG-KalinaNeural'],\n  'bn-BD': ['bn-BD-NabanitaNeural', 'bn-BD-PradeepNeural'],\n  'bn-IN': ['bn-IN-BashkarNeural', 'bn-IN-TanishaaNeural'],\n  'bs-BA': ['bs-BA-GoranNeural', 'bs-BA-VesnaNeural'],\n  'ca-ES': ['ca-ES-EnricNeural', 'ca-ES-JoanaNeural'],\n  'cs-CZ': ['cs-CZ-AntoninNeural', 'cs-CZ-VlastaNeural'],\n  'cy-GB': ['cy-GB-AledNeural', 'cy-GB-NiaNeural'],\n  'da-DK': ['da-DK-ChristelNeural', 'da-DK-JeppeNeural'],\n  'de-AT': ['de-AT-IngridNeural', 'de-AT-JonasNeural'],\n  'de-CH': ['de-CH-JanNeural', 'de-CH-LeniNeural'],\n  'de-DE': [\n    'de-DE-AmalaNeural',\n    'de-DE-ConradNeural',\n    'de-DE-FlorianMultilingualNeural',\n    'de-DE-KatjaNeural',\n    'de-DE-KillianNeural',\n    'de-DE-SeraphinaMultilingualNeural',\n  ],\n  'el-GR': ['el-GR-AthinaNeural', 'el-GR-NestorasNeural'],\n  'en-AU': ['en-AU-NatashaNeural', 'en-AU-WilliamNeural'],\n  'en-CA': ['en-CA-ClaraNeural', 'en-CA-LiamNeural'],\n  'en-GB': [\n    'en-GB-LibbyNeural',\n    'en-GB-MaisieNeural',\n    'en-GB-RyanNeural',\n    'en-GB-SoniaNeural',\n    'en-GB-ThomasNeural',\n  ],\n  'en-HK': ['en-HK-SamNeural', 'en-HK-YanNeural'],\n  'en-IE': ['en-IE-ConnorNeural', 'en-IE-EmilyNeural'],\n  'en-IN': ['en-IN-NeerjaExpressiveNeural', 'en-IN-NeerjaNeural', 'en-IN-PrabhatNeural'],\n  'en-KE': ['en-KE-AsiliaNeural', 'en-KE-ChilembaNeural'],\n  'en-NG': ['en-NG-AbeoNeural', 'en-NG-EzinneNeural'],\n  'en-NZ': ['en-NZ-MitchellNeural', 'en-NZ-MollyNeural'],\n  'en-PH': ['en-PH-JamesNeural', 'en-PH-RosaNeural'],\n  'en-SG': ['en-SG-LunaNeural', 'en-SG-WayneNeural'],\n  'en-TZ': ['en-TZ-ElimuNeural', 'en-TZ-ImaniNeural'],\n  'en-US': [\n    'en-US-AnaNeural',\n    'en-US-AndrewMultilingualNeural',\n    'en-US-AndrewNeural',\n    'en-US-AriaNeural',\n    'en-US-AvaMultilingualNeural',\n    'en-US-AvaNeural',\n    'en-US-BrianMultilingualNeural',\n    'en-US-BrianNeural',\n    'en-US-ChristopherNeural',\n    'en-US-EmmaMultilingualNeural',\n    'en-US-EmmaNeural',\n    'en-US-EricNeural',\n    'en-US-GuyNeural',\n    'en-US-JennyNeural',\n    'en-US-MichelleNeural',\n    'en-US-RogerNeural',\n    'en-US-SteffanNeural',\n  ],\n  'es-AR': ['es-AR-ElenaNeural', 'es-AR-TomasNeural'],\n  'es-BO': ['es-BO-MarceloNeural', 'es-BO-SofiaNeural'],\n  'es-CL': ['es-CL-CatalinaNeural', 'es-CL-LorenzoNeural'],\n  'es-CO': ['es-CO-GonzaloNeural', 'es-CO-SalomeNeural'],\n  'es-CR': ['es-CR-JuanNeural', 'es-CR-MariaNeural'],\n  'es-CU': ['es-CU-BelkysNeural', 'es-CU-ManuelNeural'],\n  'es-DO': ['es-DO-EmilioNeural', 'es-DO-RamonaNeural'],\n  'es-EC': ['es-EC-AndreaNeural', 'es-EC-LuisNeural'],\n  'es-ES': ['es-ES-AlvaroNeural', 'es-ES-ElviraNeural', 'es-ES-XimenaNeural'],\n  'es-US': ['es-US-AlonsoNeural', 'es-US-PalomaNeural'],\n  'et-EE': ['et-EE-AnuNeural', 'et-EE-KertNeural'],\n  'fa-IR': ['fa-IR-DilaraNeural', 'fa-IR-FaridNeural'],\n  'fi-FI': ['fi-FI-HarriNeural', 'fi-FI-NooraNeural'],\n  'fil-PH': ['fil-PH-AngeloNeural', 'fil-PH-BlessicaNeural'],\n  'fr-BE': ['fr-BE-CharlineNeural', 'fr-BE-GerardNeural'],\n  'fr-CA': ['fr-CA-AntoineNeural', 'fr-CA-JeanNeural', 'fr-CA-SylvieNeural', 'fr-CA-ThierryNeural'],\n  'fr-CH': ['fr-CH-ArianeNeural', 'fr-CH-FabriceNeural'],\n  'fr-FR': [\n    'fr-FR-DeniseNeural',\n    'fr-FR-EloiseNeural',\n    'fr-FR-HenriNeural',\n    'fr-FR-RemyMultilingualNeural',\n    'fr-FR-VivienneMultilingualNeural',\n  ],\n  'ga-IE': ['ga-IE-ColmNeural', 'ga-IE-OrlaNeural'],\n  'gl-ES': ['gl-ES-RoiNeural', 'gl-ES-SabelaNeural'],\n  'gu-IN': ['gu-IN-DhwaniNeural', 'gu-IN-NiranjanNeural'],\n  'he-IL': ['he-IL-AvriNeural', 'he-IL-HilaNeural'],\n  'hi-IN': ['hi-IN-MadhurNeural', 'hi-IN-SwaraNeural'],\n  'hr-HR': ['hr-HR-GabrijelaNeural', 'hr-HR-SreckoNeural'],\n  'hu-HU': ['hu-HU-NoemiNeural', 'hu-HU-TamasNeural'],\n  'id-ID': ['id-ID-ArdiNeural', 'id-ID-GadisNeural'],\n  'is-IS': ['is-IS-GudrunNeural', 'is-IS-GunnarNeural'],\n  'it-IT': [\n    'it-IT-DiegoNeural',\n    'it-IT-ElsaNeural',\n    'it-IT-GiuseppeMultilingualNeural',\n    'it-IT-IsabellaNeural',\n  ],\n  'iu-Cans-CA': ['iu-Cans-CA-SiqiniqNeural', 'iu-Cans-CA-TaqqiqNeural'],\n  'iu-Latn-CA': ['iu-Latn-CA-SiqiniqNeural', 'iu-Latn-CA-TaqqiqNeural'],\n  'ja-JP': ['ja-JP-KeitaNeural', 'ja-JP-NanamiNeural'],\n  'jv-ID': ['jv-ID-DimasNeural', 'jv-ID-SitiNeural'],\n  'ka-GE': ['ka-GE-EkaNeural', 'ka-GE-GiorgiNeural'],\n  'kk-KZ': ['kk-KZ-AigulNeural', 'kk-KZ-DauletNeural'],\n  'km-KH': ['km-KH-PisethNeural', 'km-KH-SreymomNeural'],\n  'kn-IN': ['kn-IN-GaganNeural', 'kn-IN-SapnaNeural'],\n  'ko-KR': ['ko-KR-HyunsuMultilingualNeural', 'ko-KR-InJoonNeural', 'ko-KR-SunHiNeural'],\n  'lo-LA': ['lo-LA-ChanthavongNeural', 'lo-LA-KeomanyNeural'],\n  'lt-LT': ['lt-LT-LeonasNeural', 'lt-LT-OnaNeural'],\n  'lv-LV': ['lv-LV-EveritaNeural', 'lv-LV-NilsNeural'],\n  'mk-MK': ['mk-MK-AleksandarNeural', 'mk-MK-MarijaNeural'],\n  'ml-IN': ['ml-IN-MidhunNeural', 'ml-IN-SobhanaNeural'],\n  'mn-MN': ['mn-MN-BataaNeural', 'mn-MN-YesuiNeural'],\n  'mr-IN': ['mr-IN-AarohiNeural', 'mr-IN-ManoharNeural'],\n  'ms-MY': ['ms-MY-OsmanNeural', 'ms-MY-YasminNeural'],\n  'mt-MT': ['mt-MT-GraceNeural', 'mt-MT-JosephNeural'],\n  'my-MM': ['my-MM-NilarNeural', 'my-MM-ThihaNeural'],\n  'nb-NO': ['nb-NO-FinnNeural', 'nb-NO-PernilleNeural'],\n  'ne-NP': ['ne-NP-HemkalaNeural', 'ne-NP-SagarNeural'],\n  'nl-BE': ['nl-BE-ArnaudNeural', 'nl-BE-DenaNeural'],\n  'nl-NL': ['nl-NL-ColetteNeural', 'nl-NL-FennaNeural', 'nl-NL-MaartenNeural'],\n  'pl-PL': ['pl-PL-MarekNeural', 'pl-PL-ZofiaNeural'],\n  'ps-AF': ['ps-AF-GulNawazNeural', 'ps-AF-LatifaNeural'],\n  'pt-BR': ['pt-BR-AntonioNeural', 'pt-BR-FranciscaNeural', 'pt-BR-ThalitaMultilingualNeural'],\n  'pt-PT': ['pt-PT-DuarteNeural', 'pt-PT-RaquelNeural'],\n  'ro-RO': ['ro-RO-AlinaNeural', 'ro-RO-EmilNeural'],\n  'ru-RU': ['ru-RU-DmitryNeural', 'ru-RU-SvetlanaNeural'],\n  'si-LK': ['si-LK-SameeraNeural', 'si-LK-ThiliniNeural'],\n  'sk-SK': ['sk-SK-LukasNeural', 'sk-SK-ViktoriaNeural'],\n  'sl-SI': ['sl-SI-PetraNeural', 'sl-SI-RokNeural'],\n  'so-SO': ['so-SO-MuuseNeural', 'so-SO-UbaxNeural'],\n  'sq-AL': ['sq-AL-AnilaNeural', 'sq-AL-IlirNeural'],\n  'sr-RS': ['sr-RS-NicholasNeural', 'sr-RS-SophieNeural'],\n  'su-ID': ['su-ID-JajangNeural', 'su-ID-TutiNeural'],\n  'sv-SE': ['sv-SE-MattiasNeural', 'sv-SE-SofieNeural'],\n  'sw-KE': ['sw-KE-RafikiNeural', 'sw-KE-ZuriNeural'],\n  'sw-TZ': ['sw-TZ-DaudiNeural', 'sw-TZ-RehemaNeural'],\n  'ta-IN': ['ta-IN-PallaviNeural', 'ta-IN-ValluvarNeural'],\n  'ta-LK': ['ta-LK-KumarNeural', 'ta-LK-SaranyaNeural'],\n  'ta-MY': ['ta-MY-KaniNeural', 'ta-MY-SuryaNeural'],\n  'ta-SG': ['ta-SG-AnbuNeural', 'ta-SG-VenbaNeural'],\n  'te-IN': ['te-IN-MohanNeural', 'te-IN-ShrutiNeural'],\n  'th-TH': ['th-TH-NiwatNeural', 'th-TH-PremwadeeNeural'],\n  'tr-TR': ['tr-TR-AhmetNeural', 'tr-TR-EmelNeural'],\n  'uk-UA': ['uk-UA-OstapNeural', 'uk-UA-PolinaNeural'],\n  'ur-IN': ['ur-IN-GulNeural', 'ur-IN-SalmanNeural'],\n  'ur-PK': ['ur-PK-AsadNeural', 'ur-PK-UzmaNeural'],\n  'uz-UZ': ['uz-UZ-MadinaNeural', 'uz-UZ-SardorNeural'],\n  'vi-VN': ['vi-VN-HoaiMyNeural', 'vi-VN-NamMinhNeural'],\n  'zh-CN': [\n    'zh-CN-XiaoxiaoNeural',\n    'zh-CN-XiaoyiNeural',\n    'zh-CN-YunjianNeural',\n    'zh-CN-YunxiNeural',\n    'zh-CN-YunxiaNeural',\n    'zh-CN-YunyangNeural',\n    'zh-CN-liaoning-XiaobeiNeural',\n    'zh-CN-shaanxi-XiaoniNeural',\n  ],\n  'zh-HK': ['zh-HK-HiuGaaiNeural', 'zh-HK-HiuMaanNeural', 'zh-HK-WanLungNeural'],\n  'zh-TW': ['zh-TW-HsiaoChenNeural', 'zh-TW-HsiaoYuNeural', 'zh-TW-YunJheNeural'],\n  'zu-ZA': ['zu-ZA-ThandoNeural', 'zu-ZA-ThembaNeural'],\n};\n\n/**\n * Generates the Sec-MS-GEC token value.\n * This function generates a token value based on the current time in Windows file time format\n * adjusted for clock skew, and rounded down to the nearest 5 minutes. The token is then hashed\n * using SHA256 and returned as an uppercased hex digest.\n *\n * @returns The generated Sec-MS-GEC token value.\n * @see https://github.com/rany2/edge-tts/issues/290#issuecomment-2464956570\n */\nconst WIN_EPOCH_OFFSET = 11644473600; // Windows epoch offset in seconds (1601 to 1970)\nconst S_TO_NS = 1000000000; // Seconds to nanoseconds conversion\nconst generateSecMsGec = () => {\n  let ticks = Math.floor(Date.now() / 1000);\n  // Switch to Windows file time epoch (1601-01-01 00:00:00 UTC)\n  ticks += WIN_EPOCH_OFFSET;\n  // Round down to the nearest 5 minutes (300 seconds)\n  ticks -= ticks % 300;\n  // Convert the ticks to 100-nanosecond intervals (Windows file time format)\n  ticks *= S_TO_NS / 100;\n  // Create the string to hash by concatenating the ticks and the trusted client token\n  const strToHash = `${ticks.toFixed(0)}${EDGE_API_TOKEN}`;\n  // Compute the SHA256 hash and return the uppercased hex digest\n  return createHash('sha256').update(strToHash, 'ascii').digest('hex').toUpperCase();\n};\n\nconst generateMuid = () => {\n  // Generate 16 random bytes (32 hex characters)\n  const array = new Uint8Array(16);\n  crypto.getRandomValues(array);\n\n  return Array.from(array)\n    .map((b) => b.toString(16).padStart(2, '0'))\n    .join('')\n    .toUpperCase();\n};\n\nconst genVoiceList = (voices: Record<string, string[]>) => {\n  return Object.entries(voices).flatMap(([lang, voices]) => {\n    return voices.map((id) => {\n      const name = id.replace(`${lang}-`, '').replace('Neural', '');\n      return { name, id, lang };\n    });\n  });\n};\n\nexport interface EdgeTTSPayload {\n  lang: string;\n  text: string;\n  voice: string;\n  rate: number;\n  pitch: number;\n}\n\nconst hashPayload = (payload: EdgeTTSPayload): string => {\n  const base = JSON.stringify(payload);\n  return md5(base);\n};\n\nexport type EDGE_TTS_PROTOCOL = 'wss' | 'https';\n\nexport class EdgeSpeechTTS {\n  static voices = genVoiceList(EDGE_TTS_VOICES);\n  private static audioCache = new LRUCache<string, Blob>(200);\n  private static audioUrlCache = new LRUCache<string, string>(200, (_, url) => {\n    if (url.startsWith('blob:')) {\n      URL.revokeObjectURL(url);\n    }\n  });\n  private protocol: EDGE_TTS_PROTOCOL = 'wss';\n\n  constructor(protocol?: EDGE_TTS_PROTOCOL) {\n    if (protocol) {\n      this.protocol = protocol;\n    }\n  }\n\n  async #fetchEdgeSpeechHttp({ lang, text, voice, rate }: EdgeTTSPayload): Promise<Response> {\n    const url = getNodeAPIBaseUrl() + '/tts/edge';\n\n    const response = await fetchWithAuth(url, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        input: text,\n        voice,\n        rate,\n        lang,\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`Edge TTS HTTP request failed: ${response.status} ${response.statusText}`);\n    }\n\n    return response;\n  }\n\n  async #fetchEdgeSpeechWs({ lang, text, voice, rate }: EdgeTTSPayload): Promise<Response> {\n    const connectId = randomMd5();\n    const params = new URLSearchParams({\n      ConnectionId: connectId,\n      TrustedClientToken: EDGE_API_TOKEN,\n      'Sec-MS-GEC': generateSecMsGec(),\n      'Sec-MS-GEC-Version': `1-${CHROMIUM_FULL_VERSION}`,\n    });\n    const url = `${EDGE_SPEECH_URL}?${params.toString()}`;\n    const date = new Date().toString();\n    const baseHeaders = {\n      'User-Agent':\n        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' +\n        ` (KHTML, like Gecko) Chrome/${CHROMIUM_MAJOR_VERSION}.0.0.0 Safari/537.36` +\n        ` Edg/${CHROMIUM_MAJOR_VERSION}.0.0.0`,\n      'Accept-Encoding': 'gzip, deflate, br, zstd',\n      'Accept-Language': 'en-US,en;q=0.9',\n      Pragma: 'no-cache',\n      'Cache-Control': 'no-cache',\n      Origin: 'chrome-extension://jdiccldimpdaibmpdkjnbmckianbfold',\n      'Sec-WebSocket-Version': '13',\n      Cookie: `muid=${generateMuid()};`,\n    };\n    const configHeaders = {\n      'Content-Type': 'application/json; charset=utf-8',\n      Path: 'speech.config',\n      'X-Timestamp': date,\n    };\n    const contentHeaders = {\n      'Content-Type': 'application/ssml+xml',\n      Path: 'ssml',\n      'X-RequestId': connectId,\n      'X-Timestamp': date,\n    };\n    const configContent = JSON.stringify({\n      context: {\n        synthesis: {\n          audio: {\n            metadataoptions: { sentenceBoundaryEnabled: false, wordBoundaryEnabled: true },\n            outputFormat: 'audio-24khz-48kbitrate-mono-mp3',\n          },\n        },\n      },\n    });\n\n    const genSendContent = (headerObj: Record<string, string>, content: string) => {\n      let header = '';\n      for (const key of Object.keys(headerObj)) {\n        header += `${key}: ${headerObj[key]}\\r\\n`;\n      }\n      return `${header}\\r\\n${content}`;\n    };\n\n    const getHeadersAndData = (message: string) => {\n      const lines = message.split('\\n');\n      const headers: Record<string, string> = {};\n      let body = '';\n      let lineIdx = 0;\n\n      for (lineIdx = 0; lineIdx < lines.length; lineIdx++) {\n        const line = lines[lineIdx]!.trim();\n        if (!line) break;\n        const separatorIndex = line.indexOf(':');\n        if (separatorIndex === -1) continue;\n        const key = line.slice(0, separatorIndex).trim();\n        const value = line.slice(separatorIndex + 1).trim();\n        headers[key] = value;\n      }\n\n      for (lineIdx = lineIdx + 1; lineIdx < lines.length; lineIdx++) {\n        body += lines[lineIdx] + '\\n';\n      }\n\n      return { headers, body };\n    };\n\n    const ssml = genSSML(lang, text, voice, rate);\n    const content = genSendContent(contentHeaders, ssml);\n    const config = genSendContent(configHeaders, configContent);\n\n    if (isTauriAppPlatform()) {\n      return new Promise(async (resolve, reject) => {\n        try {\n          const TauriWebSocket = (await import('@tauri-apps/plugin-websocket')).default;\n          const ws = await TauriWebSocket.connect(url, { headers: baseHeaders });\n          let audioData = new ArrayBuffer(0);\n          const messageUnlisten = await ws.addListener((msg) => {\n            if (msg.type === 'Text') {\n              const { headers } = getHeadersAndData(msg.data as string);\n              if (headers['Path'] === 'turn.end') {\n                ws.disconnect();\n                messageUnlisten();\n                if (!audioData.byteLength) {\n                  return reject(new Error('No audio data received.'));\n                }\n                const res = new Response(audioData);\n                resolve(res);\n              }\n            } else if (msg.type === 'Binary') {\n              let buffer: ArrayBufferLike;\n              if (msg.data instanceof Uint8Array) {\n                buffer = msg.data.buffer;\n              } else {\n                buffer = new Uint8Array(msg.data).buffer;\n              }\n              const dataView = new DataView(buffer);\n              const headerLength = dataView.getInt16(0);\n              if (buffer.byteLength > headerLength + 2) {\n                const newBody = buffer.slice(2 + headerLength);\n                const merged = new Uint8Array(audioData.byteLength + newBody.byteLength);\n                merged.set(new Uint8Array(audioData), 0);\n                merged.set(new Uint8Array(newBody), audioData.byteLength);\n                audioData = merged.buffer;\n              }\n            }\n          });\n          await ws.send(config);\n          await ws.send(content);\n        } catch (error) {\n          reject(new Error(`WebSocket error occurred: ${error}`));\n        }\n      });\n    } else {\n      return new Promise((resolve, reject) => {\n        const ws = new WebSocket(url, {\n          headers: baseHeaders,\n        });\n        ws.binaryType = 'arraybuffer';\n\n        let audioData = new ArrayBuffer(0);\n\n        ws.addEventListener('open', () => {\n          ws.send(config);\n          ws.send(content);\n        });\n\n        ws.addEventListener('message', (event: WebSocket.MessageEvent) => {\n          if (typeof event.data === 'string') {\n            const { headers } = getHeadersAndData(event.data);\n            if (headers['Path'] === 'turn.end') {\n              ws.close();\n              if (!audioData.byteLength) {\n                return reject(new Error('No audio data received.'));\n              }\n              const res = new Response(audioData);\n              resolve(res);\n            }\n          } else if (event.data instanceof ArrayBuffer) {\n            const dataView = new DataView(event.data);\n            const headerLength = dataView.getInt16(0);\n            if (event.data.byteLength > headerLength + 2) {\n              const newBody = event.data.slice(2 + headerLength);\n              const merged = new Uint8Array(audioData.byteLength + newBody.byteLength);\n              merged.set(new Uint8Array(audioData), 0);\n              merged.set(new Uint8Array(newBody), audioData.byteLength);\n              audioData = merged.buffer;\n            }\n          }\n        });\n\n        ws.addEventListener('close', () => {\n          if (!audioData.byteLength) {\n            reject(new Error('No audio data received.'));\n          }\n        });\n\n        ws.addEventListener('error', () => {\n          reject(new Error('WebSocket error occurred.'));\n        });\n      });\n    }\n  }\n\n  async create(payload: EdgeTTSPayload): Promise<Response> {\n    if (this.protocol === 'https') {\n      return this.#fetchEdgeSpeechHttp(payload);\n    } else {\n      return this.#fetchEdgeSpeechWs(payload);\n    }\n  }\n\n  async createAudioUrl(payload: EdgeTTSPayload): Promise<string> {\n    const cacheKey = hashPayload(payload);\n    if (EdgeSpeechTTS.audioUrlCache.has(cacheKey)) {\n      return EdgeSpeechTTS.audioUrlCache.get(cacheKey)!;\n    }\n    try {\n      const res = await this.create(payload);\n      const arrayBuffer = await res.arrayBuffer();\n      const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });\n      const objectUrl = URL.createObjectURL(blob);\n      EdgeSpeechTTS.audioCache.set(cacheKey, blob);\n      EdgeSpeechTTS.audioUrlCache.set(cacheKey, objectUrl);\n      return objectUrl;\n    } catch (error) {\n      throw error;\n    }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4617, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/libs/mediaSession.ts"],"sourcesContent":["import { isTauriAppPlatform } from '@/services/environment';\nimport { getOSPlatform } from '@/utils/misc';\nimport { invoke } from '@tauri-apps/api/core';\nimport { addPluginListener, PluginListener, PermissionState } from '@tauri-apps/api/core';\n\nexport interface MediaMetadata {\n  title?: string;\n  artist?: string;\n  album?: string;\n  artwork?: string;\n}\n\nexport interface PlaybackState {\n  playing: boolean;\n  position?: number; // in milliseconds\n  duration?: number; // in milliseconds\n}\n\nexport interface MediaSessionState {\n  active: boolean;\n  keepAppInForeground?: boolean;\n  notificationTitle?: string;\n  notificationText?: string;\n  foregroundServiceTitle?: string;\n  foregroundServiceText?: string;\n}\n\ninterface Permissions {\n  postNotification: PermissionState;\n}\n\nexport class TauriMediaSession {\n  private handlers: { [key: string]: (() => void) | ((position: number) => void) } = {};\n  private eventListenerInited: boolean = false;\n  private eventListeners: PluginListener[] = [];\n\n  private async requestPostNotificationPermission() {\n    const permission = await invoke<Permissions>('plugin:native-tts|checkPermissions');\n    if (permission.postNotification.startsWith('prompt')) {\n      await invoke<Permissions>('plugin:native-tts|requestPermissions', {\n        permissions: ['postNotification'],\n      });\n    }\n  }\n\n  private async initializeListeners() {\n    if (this.eventListenerInited) return;\n    this.eventListenerInited = true;\n\n    const playListener = await addPluginListener('native-tts', 'media-session-play', () => {\n      if (this.handlers['play']) {\n        (this.handlers['play'] as () => void)();\n      }\n    });\n    this.eventListeners.push(playListener);\n\n    const pauseListener = await addPluginListener('native-tts', 'media-session-pause', () => {\n      if (this.handlers['pause']) {\n        (this.handlers['pause'] as () => void)();\n      }\n    });\n    this.eventListeners.push(pauseListener);\n\n    const nextListener = await addPluginListener('native-tts', 'media-session-next', () => {\n      if (this.handlers['nexttrack']) {\n        (this.handlers['nexttrack'] as () => void)();\n      }\n    });\n    this.eventListeners.push(nextListener);\n\n    const previousListener = await addPluginListener('native-tts', 'media-session-previous', () => {\n      if (this.handlers['previoustrack']) {\n        (this.handlers['previoustrack'] as () => void)();\n      }\n    });\n    this.eventListeners.push(previousListener);\n\n    const seekListener = await addPluginListener(\n      'native-tts',\n      'media-session-seek',\n      (event: { payload: { position: number } }) => {\n        const position = event.payload.position;\n        if (this.handlers['seekto']) {\n          (this.handlers['seekto'] as (position: number) => void)(position);\n        }\n      },\n    );\n    this.eventListeners.push(seekListener);\n  }\n\n  private async cleanupListeners() {\n    for (const listener of this.eventListeners) {\n      await listener.unregister();\n    }\n    this.eventListeners = [];\n    this.eventListenerInited = false;\n  }\n\n  async updateMetadata(metadata: MediaMetadata) {\n    try {\n      await invoke('plugin:native-tts|update_media_session_metadata', { payload: metadata });\n    } catch (error) {\n      console.error('Failed to update media metadata:', error);\n    }\n  }\n\n  async updatePlaybackState(state: PlaybackState) {\n    try {\n      await invoke('plugin:native-tts|update_media_session_state', { payload: state });\n    } catch (error) {\n      console.error('Failed to update playback state:', error);\n    }\n  }\n\n  async setActive(sessionState: MediaSessionState) {\n    try {\n      if (sessionState.active) {\n        if (sessionState.keepAppInForeground) {\n          await this.requestPostNotificationPermission();\n        }\n        await this.initializeListeners();\n      } else {\n        await this.cleanupListeners();\n      }\n      await invoke('plugin:native-tts|set_media_session_active', {\n        payload: sessionState,\n      });\n    } catch (error) {\n      console.error('Failed to set media session active state:', error);\n    }\n  }\n\n  setActionHandler(action: string, handler: (() => void) | ((position: number) => void) | null) {\n    if (handler) {\n      this.handlers[action] = handler;\n    } else {\n      delete this.handlers[action];\n    }\n  }\n}\n\nexport function getMediaSession() {\n  if ('mediaSession' in navigator) {\n    return navigator.mediaSession;\n  } else if (getOSPlatform() === 'android' && isTauriAppPlatform()) {\n    return new TauriMediaSession();\n  }\n  return null;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4748, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/styles/fonts.ts"],"sourcesContent":["import { isCJKEnv } from '@/utils/misc';\nimport { getFilename } from '@/utils/path';\nimport { md5Fingerprint } from '@/utils/md5';\n\nexport type FontFormat = 'ttf' | 'otf' | 'woff' | 'woff2';\n\nconst basicGoogleFonts = [\n  { family: 'Bitter', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Fira Code', weights: 'wght@300..700' },\n  { family: 'Literata', weights: 'ital,opsz,wght@0,7..72,200..900;1,7..72,200..900' },\n  { family: 'Merriweather', weights: 'ital,opsz,wght@0,18..144,300..900;1,18..144,300..900' },\n  { family: 'Noto Sans', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Open Sans', weights: 'ital,wght@0,300..800;1,300..800' },\n  { family: 'Roboto', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Roboto Slab', weights: 'ital,wght@0,100..900;1,100..900' },\n  { family: 'Vollkorn', weights: 'ital,wght@0,400..900;1,400..900' },\n  { family: 'PT Sans', weights: 'ital,wght@0,400;0,700;1,400;1,700' },\n  { family: 'PT Serif', weights: 'ital,wght@0,400;0,700;1,400;1,700' },\n  { family: 'PT Mono', weights: '' },\n];\n\nconst cjkGoogleFonts = [\n  { family: 'LXGW WenKai TC', weights: '' },\n  { family: 'Noto Sans SC', weights: '' },\n  { family: 'Noto Sans TC', weights: '' },\n  { family: 'Noto Serif JP', weights: '' },\n];\n\n// Resource hints for faster font loading\nconst getResourceHints = (includeCJK = false) => {\n  const basicHints = `\n  <!-- Preconnect to Google Fonts for faster DNS resolution and connection -->\n  <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n  <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n  <link rel=\"dns-prefetch\" href=\"https://fonts.googleapis.com\">\n  <link rel=\"dns-prefetch\" href=\"https://fonts.gstatic.com\">\n`;\n\n  const cjkHints = `\n  <!-- Preconnect to CJK font CDNs -->\n  <link rel=\"preconnect\" href=\"https://cdn.jsdelivr.net\">\n  <link rel=\"preconnect\" href=\"https://cdnjs.cloudflare.com\">\n  <link rel=\"preconnect\" href=\"https://ik.imagekit.io\">\n  <link rel=\"preconnect\" href=\"https://db.onlinewebfonts.com\">\n  <link rel=\"dns-prefetch\" href=\"https://cdn.jsdelivr.net\">\n  <link rel=\"dns-prefetch\" href=\"https://cdnjs.cloudflare.com\">\n  <link rel=\"dns-prefetch\" href=\"https://ik.imagekit.io\">\n  <link rel=\"dns-prefetch\" href=\"https://db.onlinewebfonts.com\">\n`;\n\n  return includeCJK ? basicHints + cjkHints : basicHints;\n};\n\nconst getAdditionalBasicFontLinks = () => `\n  <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css2?${basicGoogleFonts\n    .map(\n      ({ family, weights }) =>\n        `family=${encodeURIComponent(family)}${weights ? `:${weights}` : ''}`,\n    )\n    .join('&')}&display=swap\" crossorigin=\"anonymous\">\n`;\n\nconst getAdditionalCJKFontLinks = () => `\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/misans-webfont@1.0.4/misans-l3/misans-l3/result.min.css\" crossorigin=\"anonymous\" />\n  <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/lxgw-wenkai-screen-web/1.520.0/lxgwwenkaigbscreen/result.css\" crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/hwmct/dist/%E6%B1%87%E6%96%87%E6%98%8E%E6%9C%9D%E4%BD%93/result.css' crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/jhlst/dist/%E4%BA%AC%E8%8F%AF%E8%80%81%E5%AE%8B%E4%BD%93v2_002/result.css' crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/syst/dist/SourceHanSerifCN/result.css' crossorigin=\"anonymous\" />\n  <link rel='stylesheet' href='https://ik.imagekit.io/fonts131/packages/GuanKiapTsingKhai/dist/GuanKiapTsingKhai-T/result.css' crossorigin=\"anonymous\" />\n  <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css2?${cjkGoogleFonts\n    .map(\n      ({ family, weights }) =>\n        `family=${encodeURIComponent(family)}${weights ? `:${weights}` : ''}`,\n    )\n    .join('&')}&display=swap\" crossorigin=\"anonymous\" />\n`;\n\nconst getAdditionalCJKFontFaces = () => `\n  @font-face {\n    font-family: \"FangSong\";\n    font-display: swap;\n    src: local(\"Fang Song\"), local(\"FangSong\"), local(\"Noto Serif CJK\"), local(\"Source Han Serif SC VF\"), url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.eot?#iefix\") format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.woff2\") format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.woff\") format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.ttf\") format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/2ecbfe1d9bfc191c6f15c0ccc23cbd43.svg#FangSong\") format(\"svg\");\n  }\n  @font-face {\n    font-family: \"Kaiti\";\n    font-display: swap;\n    src: local(\"Kai\"), local(\"KaiTi\"), local(\"AR PL UKai\"), local(\"LXGW WenKai GB Screen\"), url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.eot?#iefix\")format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.woff2\")format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.woff\")format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.ttf\")format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/1ee9941f1b8c128110ca4307dda59917.svg#STKaiti\")format(\"svg\");\n  }\n  @font-face {\n    font-family: \"Heiti\";\n    font-display: swap;\n    src: local(\"Hei\"), local(\"SimHei\"), local(\"WenQuanYi Zen Hei\"), local(\"Source Han Sans SC VF\"), url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.eot?#iefix\")format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.woff2\")format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.woff\")format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.ttf\")format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/a4948b9d43a91468825a5251df1ec58d.svg#WenQuanYi Micro Hei\")format(\"svg\");\n  }\n  @font-face {\n    font-family: \"XiHeiti\";\n    font-display: swap;\n    src: local(\"PingFang SC\"), local(\"Microsoft YaHei\"), local(\"WenQuanYi Micro Hei\"), local(\"FZHei-B01\"), url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.eot\");\n    src: url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.eot?#iefix\")format(\"embedded-opentype\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.woff2\")format(\"woff2\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.woff\")format(\"woff\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.ttf\")format(\"truetype\"),\n    url(\"https://db.onlinewebfonts.com/t/4f0b783ba4a1b381fc7e7af81ecab481.svg#STHeiti J Light\")format(\"svg\");\n}\n`;\n\nexport const mountAdditionalFonts = async (document: Document, isCJK = false) => {\n  const mountCJKFonts = isCJK || isCJKEnv();\n\n  const hints = getResourceHints(mountCJKFonts);\n  const hintsParser = new DOMParser();\n  const hintsDocument = hintsParser.parseFromString(hints, 'text/html');\n\n  // Mount resource hints at the beginning of head for priority\n  Array.from(hintsDocument.head.children).forEach((child) => {\n    if (child.tagName === 'LINK') {\n      const link = document.createElement('link');\n      link.rel = child.getAttribute('rel') || '';\n      link.href = child.getAttribute('href') || '';\n      const crossorigin = child.getAttribute('crossorigin');\n      if (crossorigin) {\n        link.crossOrigin = crossorigin;\n      }\n\n      // Insert at the beginning of head for maximum priority\n      if (document.head.firstChild) {\n        document.head.insertBefore(link, document.head.firstChild);\n      } else {\n        document.head.appendChild(link);\n      }\n    }\n  });\n\n  // Mount font stylesheets and @font-face rules\n  let links = getAdditionalBasicFontLinks();\n  let fontFaces = '';\n\n  if (mountCJKFonts) {\n    fontFaces = getAdditionalCJKFontFaces();\n    links = `${links}\\n${getAdditionalCJKFontLinks()}`;\n  }\n\n  if (fontFaces) {\n    const style = document.createElement('style');\n    style.textContent = fontFaces;\n    document.head.appendChild(style);\n  }\n\n  const parser = new DOMParser();\n  const linksDocument = parser.parseFromString(links, 'text/html');\n\n  Array.from(linksDocument.head.children).forEach((child) => {\n    if (child.tagName === 'LINK') {\n      const link = document.createElement('link');\n      link.rel = child.getAttribute('rel') || '';\n      link.href = child.getAttribute('href') || '';\n      link.crossOrigin = child.getAttribute('crossorigin') || '';\n\n      document.head.appendChild(link);\n    }\n  });\n};\n\nexport type FontStyle = 'normal' | 'italic' | 'oblique';\n\nexport interface CustomFont {\n  id: string;\n  name: string;\n  path: string;\n  family?: string;\n  style?: string;\n  weight?: number;\n  variable?: boolean;\n\n  downloadedAt?: number;\n  deletedAt?: number;\n\n  blobUrl?: string;\n  loaded?: boolean;\n  error?: string;\n}\n\nexport type CustomFontInfo = Partial<CustomFont> &\n  Required<Pick<CustomFont, 'path' | 'name' | 'family' | 'style' | 'weight' | 'variable'>>;\n\nexport function getFontName(path: string): string {\n  const fileName = getFilename(path);\n  return fileName.replace(/\\.(ttf|otf|woff|woff2)$/i, '');\n}\n\nexport function getFontId(name: string): string {\n  return md5Fingerprint(name);\n}\n\nexport function getFontFormat(path: string): FontFormat {\n  const extension = path.toLowerCase().split('.').pop();\n  switch (extension) {\n    case 'ttf':\n      return 'ttf';\n    case 'otf':\n      return 'otf';\n    case 'woff':\n      return 'woff';\n    case 'woff2':\n      return 'woff2';\n    default:\n      return 'ttf';\n  }\n}\n\nexport function getMimeType(format: FontFormat): string {\n  const types = { ttf: 'font/ttf', otf: 'font/otf', woff: 'font/woff', woff2: 'font/woff2' };\n  return types[format] || 'font/ttf';\n}\n\nexport function getCSSFormatString(format: FontFormat): string {\n  const formats = { ttf: 'truetype', otf: 'opentype', woff: 'woff', woff2: 'woff2' };\n  return formats[format] || 'truetype';\n}\n\nexport function createFontFamily(name: string): string {\n  return name.replace(/\\s+/g, ' ').trim();\n}\n\nexport function createFontCSS(font: CustomFont): string {\n  const format = getFontFormat(font.path);\n  const cssFormat = getCSSFormatString(format);\n  const fontFamily = createFontFamily(font.family || font.name);\n  const fontStyle = font.style || 'normal';\n  const fontWeight = font.weight || 400;\n  const variable = font.variable || false;\n  if (!font.blobUrl) {\n    throw new Error(`Blob URL not available for font: ${font.name}`);\n  }\n\n  const css = `\n    @font-face {\n      font-family: \"${fontFamily}\";\n      ${variable ? '' : `font-style: ${fontStyle};`}\n      ${variable ? '' : `font-weight: ${fontWeight};`}\n      src: url(\"${font.blobUrl}\") format(\"${cssFormat}\");\n      font-display: swap;\n    }\n  `;\n\n  return css;\n}\n\nexport function createCustomFont(\n  path: string,\n  options?: Partial<Omit<CustomFont, 'id' | 'path'>>,\n): CustomFont {\n  const name = options?.name || getFontName(path);\n  return {\n    id: getFontId(name),\n    name,\n    family: options?.family,\n    style: options?.style,\n    weight: options?.weight,\n    variable: options?.variable,\n    path,\n  };\n}\n\nexport const mountCustomFont = (document: Document, font: CustomFont) => {\n  const fontStyleId = `custom-font-${font.id}`;\n  const styleElement = document.getElementById(fontStyleId) || document.createElement('style');\n  styleElement.id = fontStyleId;\n  styleElement.textContent = createFontCSS(font);\n\n  if (!styleElement.parentNode) {\n    document.head.appendChild(styleElement);\n  }\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5063, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/updater.ts"],"sourcesContent":["import semver from 'semver';\nimport { check } from '@tauri-apps/plugin-updater';\nimport { type as osType } from '@tauri-apps/plugin-os';\nimport { fetch } from '@tauri-apps/plugin-http';\nimport { WebviewWindow } from '@tauri-apps/api/webviewWindow';\nimport { TranslationFunc } from '@/hooks/useTranslation';\nimport { setUpdaterWindowVisible } from '@/components/UpdaterWindow';\nimport { isTauriAppPlatform } from '@/services/environment';\nimport { getAppVersion } from '@/utils/version';\nimport {\n  CHECK_UPDATE_INTERVAL_SEC,\n  READEST_CHANGELOG_FILE,\n  READEST_UPDATER_FILE,\n} from '@/services/constants';\n\nconst LAST_CHECK_KEY = 'lastAppUpdateCheck';\n\nconst showUpdateWindow = (latestVersion: string) => {\n  const win = new WebviewWindow('updater', {\n    url: `/updater?latestVersion=${latestVersion}`,\n    title: 'Software Update',\n    width: 626,\n    height: 406,\n    center: true,\n    resizable: true,\n  });\n  win.once('tauri://created', () => {\n    console.log('new window created');\n  });\n  win.once('tauri://error', (e) => {\n    console.error('error creating window', e);\n  });\n};\n\nexport const checkForAppUpdates = async (\n  _: TranslationFunc,\n  isAutoCheck = true,\n): Promise<boolean> => {\n  const lastCheck = localStorage.getItem(LAST_CHECK_KEY);\n  const now = Date.now();\n  if (isAutoCheck && lastCheck && now - parseInt(lastCheck, 10) < CHECK_UPDATE_INTERVAL_SEC * 1000)\n    return false;\n  localStorage.setItem(LAST_CHECK_KEY, now.toString());\n\n  console.log('Checking for updates');\n  const OS_TYPE = osType();\n  if (['macos', 'windows', 'linux'].includes(OS_TYPE)) {\n    const update = await check();\n    if (update) {\n      showUpdateWindow(update.version);\n    }\n    return !!update;\n  } else if (OS_TYPE === 'android') {\n    try {\n      const response = await fetch(READEST_UPDATER_FILE, { connectTimeout: 5000 });\n      const data = await response.json();\n      const isNewer = semver.gt(data.version, getAppVersion());\n      if (isNewer && ('android-arm64' in data.platforms || 'android-universal' in data.platforms)) {\n        setUpdaterWindowVisible(true, data.version!, getAppVersion());\n      }\n      return isNewer;\n    } catch (err) {\n      console.warn('Failed to fetch Android update info', err);\n      throw new Error('Failed to fetch Android update info');\n    }\n  }\n\n  return false;\n};\n\nconst LAST_SHOWN_RELEASE_NOTES_KEY = 'lastShownReleaseNotesVersion';\n\nexport const setLastShownReleaseNotesVersion = (version: string) => {\n  localStorage.setItem(LAST_SHOWN_RELEASE_NOTES_KEY, version);\n};\n\nexport const getLastShownReleaseNotesVersion = () => {\n  return localStorage.getItem(LAST_SHOWN_RELEASE_NOTES_KEY) || '';\n};\n\nexport const checkAppReleaseNotes = async (isAutoCheck = true) => {\n  const currentVersion = getAppVersion();\n  const lastShownVersion = getLastShownReleaseNotesVersion();\n  if ((lastShownVersion && semver.gt(currentVersion, lastShownVersion)) || !isAutoCheck) {\n    try {\n      const fetchFunc = isTauriAppPlatform() ? fetch : window.fetch;\n      const res = await fetchFunc(READEST_CHANGELOG_FILE);\n      if (res.ok) {\n        setUpdaterWindowVisible(true, currentVersion, lastShownVersion, false);\n        return true;\n      }\n    } catch (err) {\n      console.warn('Failed to fetch release notes', err);\n    }\n  } else if (!lastShownVersion) {\n    setLastShownReleaseNotesVersion(currentVersion);\n  }\n  return false;\n};\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;AAMA,MAAM,iBAAiB;AAEvB,MAAM,mBAAmB,CAAC;IACxB,MAAM,MAAM,IAAI,+LAAa,CAAC,WAAW;QACvC,KAAK,CAAC,uBAAuB,EAAE,eAAe;QAC9C,OAAO;QACP,OAAO;QACP,QAAQ;QACR,QAAQ;QACR,WAAW;IACb;IACA,IAAI,IAAI,CAAC,mBAAmB;QAC1B,QAAQ,GAAG,CAAC;IACd;IACA,IAAI,IAAI,CAAC,iBAAiB,CAAC;QACzB,QAAQ,KAAK,CAAC,yBAAyB;IACzC;AACF;AAEO,MAAM,qBAAqB,OAChC,GACA,cAAc,IAAI;IAElB,MAAM,YAAY,aAAa,OAAO,CAAC;IACvC,MAAM,MAAM,KAAK,GAAG;IACpB,IAAI,eAAe,aAAa,MAAM,SAAS,WAAW,MAAM,4KAAyB,GAAG,MAC1F,OAAO;IACT,aAAa,OAAO,CAAC,gBAAgB,IAAI,QAAQ;IAEjD,QAAQ,GAAG,CAAC;IACZ,MAAM,UAAU,IAAA,sKAAM;IACtB,IAAI;QAAC;QAAS;QAAW;KAAQ,CAAC,QAAQ,CAAC,UAAU;QACnD,MAAM,SAAS,MAAM,IAAA,iLAAK;QAC1B,IAAI,QAAQ;YACV,iBAAiB,OAAO,OAAO;QACjC;QACA,OAAO,CAAC,CAAC;IACX,OAAO,IAAI,YAAY,WAAW;QAChC,IAAI;YACF,MAAM,WAAW,MAAM,IAAA,2KAAK,EAAC,uKAAoB,EAAE;gBAAE,gBAAgB;YAAK;YAC1E,MAAM,OAAO,MAAM,SAAS,IAAI;YAChC,MAAM,UAAU,gHAAM,CAAC,EAAE,CAAC,KAAK,OAAO,EAAE,IAAA,2JAAa;YACrD,IAAI,WAAW,CAAC,mBAAmB,KAAK,SAAS,IAAI,uBAAuB,KAAK,SAAS,GAAG;gBAC3F,IAAA,iLAAuB,EAAC,MAAM,KAAK,OAAO,EAAG,IAAA,2JAAa;YAC5D;YACA,OAAO;QACT,EAAE,OAAO,KAAK;YACZ,QAAQ,IAAI,CAAC,uCAAuC;YACpD,MAAM,IAAI,MAAM;QAClB;IACF;IAEA,OAAO;AACT;AAEA,MAAM,+BAA+B;AAE9B,MAAM,kCAAkC,CAAC;IAC9C,aAAa,OAAO,CAAC,8BAA8B;AACrD;AAEO,MAAM,kCAAkC;IAC7C,OAAO,aAAa,OAAO,CAAC,iCAAiC;AAC/D;AAEO,MAAM,uBAAuB,OAAO,cAAc,IAAI;IAC3D,MAAM,iBAAiB,IAAA,2JAAa;IACpC,MAAM,mBAAmB;IACzB,IAAI,AAAC,oBAAoB,gHAAM,CAAC,EAAE,CAAC,gBAAgB,qBAAsB,CAAC,aAAa;QACrF,IAAI;YACF,MAAM,YAAY,IAAA,uKAAkB,MAAK,2KAAK,GAAG,OAAO,KAAK;YAC7D,MAAM,MAAM,MAAM,UAAU,yKAAsB;YAClD,IAAI,IAAI,EAAE,EAAE;gBACV,IAAA,iLAAuB,EAAC,MAAM,gBAAgB,kBAAkB;gBAChE,OAAO;YACT;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,IAAI,CAAC,iCAAiC;QAChD;IACF,OAAO,IAAI,CAAC,kBAAkB;QAC5B,gCAAgC;IAClC;IACA,OAAO;AACT"}},
    {"offset": {"line": 5184, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/openWith.ts"],"sourcesContent":["import { isWebAppPlatform, hasCli } from '@/services/environment';\nimport { AppService } from '@/types/system';\nimport { getCurrent } from '@tauri-apps/plugin-deep-link';\n\ndeclare global {\n  interface Window {\n    OPEN_WITH_FILES?: string[] | null;\n  }\n}\n\ninterface CliArgument {\n  value: string;\n  occurrences: number;\n}\n\nconst parseWindowOpenWithFiles = () => {\n  const params = new URLSearchParams(window.location.search);\n  const files = params.getAll('file');\n  return files.length > 0 ? files : window.OPEN_WITH_FILES;\n};\n\nconst parseCLIOpenWithFiles = async () => {\n  const { getMatches } = await import('@tauri-apps/plugin-cli');\n  const matches = await getMatches();\n  const args = matches?.args;\n  const files: string[] = [];\n  if (args) {\n    for (const name of ['file1', 'file2', 'file3', 'file4']) {\n      const arg = args[name] as CliArgument;\n      if (arg && arg.occurrences > 0) {\n        files.push(arg.value);\n      }\n    }\n  }\n\n  return files;\n};\n\nconst parseIntentOpenWithFiles = async (appService: AppService | null) => {\n  const urls = await getCurrent();\n  if (urls && urls.length > 0) {\n    console.log('Intent Open with URL:', urls);\n    return urls\n      .map((url) => {\n        if (url.startsWith('file://')) {\n          if (appService?.isIOSApp) {\n            return decodeURI(url);\n          } else {\n            return decodeURI(url.replace('file://', ''));\n          }\n        } else if (url.startsWith('content://')) {\n          return url;\n        } else {\n          console.info('Skip non-file URL:', url);\n          return null;\n        }\n      })\n      .filter((url) => url !== null) as string[];\n  }\n  return null;\n};\n\nexport const parseOpenWithFiles = async (appService: AppService | null) => {\n  if (isWebAppPlatform()) return [];\n\n  let files = parseWindowOpenWithFiles();\n  if ((!files || files.length === 0) && hasCli()) {\n    files = await parseCLIOpenWithFiles();\n  }\n  if (!files || files.length === 0) {\n    files = await parseIntentOpenWithFiles(appService);\n  }\n  return files;\n};\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;;;;;AAaA,MAAM,2BAA2B;IAC/B,MAAM,SAAS,IAAI,gBAAgB,OAAO,QAAQ,CAAC,MAAM;IACzD,MAAM,QAAQ,OAAO,MAAM,CAAC;IAC5B,OAAO,MAAM,MAAM,GAAG,IAAI,QAAQ,OAAO,eAAe;AAC1D;AAEA,MAAM,wBAAwB;IAC5B,MAAM,EAAE,UAAU,EAAE,GAAG;IACvB,MAAM,UAAU,MAAM;IACtB,MAAM,OAAO,SAAS;IACtB,MAAM,QAAkB,EAAE;IAC1B,IAAI,MAAM;QACR,KAAK,MAAM,QAAQ;YAAC;YAAS;YAAS;YAAS;SAAQ,CAAE;YACvD,MAAM,MAAM,IAAI,CAAC,KAAK;YACtB,IAAI,OAAO,IAAI,WAAW,GAAG,GAAG;gBAC9B,MAAM,IAAI,CAAC,IAAI,KAAK;YACtB;QACF;IACF;IAEA,OAAO;AACT;AAEA,MAAM,2BAA2B,OAAO;IACtC,MAAM,OAAO,MAAM,IAAA,gMAAU;IAC7B,IAAI,QAAQ,KAAK,MAAM,GAAG,GAAG;QAC3B,QAAQ,GAAG,CAAC,yBAAyB;QACrC,OAAO,KACJ,GAAG,CAAC,CAAC;YACJ,IAAI,IAAI,UAAU,CAAC,YAAY;gBAC7B,IAAI,YAAY,UAAU;oBACxB,OAAO,UAAU;gBACnB,OAAO;oBACL,OAAO,UAAU,IAAI,OAAO,CAAC,WAAW;gBAC1C;YACF,OAAO,IAAI,IAAI,UAAU,CAAC,eAAe;gBACvC,OAAO;YACT,OAAO;gBACL,QAAQ,IAAI,CAAC,sBAAsB;gBACnC,OAAO;YACT;QACF,GACC,MAAM,CAAC,CAAC,MAAQ,QAAQ;IAC7B;IACA,OAAO;AACT;AAEO,MAAM,qBAAqB,OAAO;IACvC,IAAI,IAAA,qKAAgB,KAAI,OAAO,EAAE;IAEjC,IAAI,QAAQ;IACZ,IAAI,CAAC,CAAC,SAAS,MAAM,MAAM,KAAK,CAAC,KAAK,IAAA,2JAAM,KAAI;QAC9C,QAAQ,MAAM;IAChB;IACA,IAAI,CAAC,SAAS,MAAM,MAAM,KAAK,GAAG;QAChC,QAAQ,MAAM,yBAAyB;IACzC;IACA,OAAO;AACT"}},
    {"offset": {"line": 5258, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/shortcuts.ts"],"sourcesContent":["const DEFAULT_SHORTCUTS = {\n  onSwitchSideBar: ['ctrl+Tab', 'opt+Tab', 'alt+Tab'],\n  onToggleSideBar: ['s'],\n  onToggleNotebook: ['n'],\n  onShowSearchBar: ['ctrl+f', 'cmd+f'],\n  onToggleScrollMode: ['shift+j'],\n  onToggleSelectMode: ['shift+s'],\n  onToggleBookmark: ['ctrl+d', 'cmd+d'],\n  onToggleTTS: ['t'],\n  onHighlightSelection: ['ctrl+h', 'cmd+h'],\n  onUnderlineSelection: ['ctrl+u', 'cmd+u'],\n  onAnnotateSelection: ['ctrl+n', 'cmd+n'],\n  onSearchSelection: ['ctrl+f', 'cmd+f'],\n  onCopySelection: ['ctrl+c', 'cmd+c'],\n  onTranslateSelection: ['ctrl+t', 'cmd+t'],\n  onDictionarySelection: ['ctrl+d', 'cmd+d'],\n  onWikipediaSelection: ['ctrl+w', 'cmd+w'],\n  onReadAloudSelection: ['ctrl+r', 'cmd+r'],\n  onProofreadSelection: ['ctrl+p', 'cmd+p'],\n  onOpenFontLayoutSettings: ['shift+f', 'ctrl+,', 'cmd+,'],\n  onOpenBooks: ['ctrl+o'],\n  onReloadPage: ['shift+r'],\n  onToggleFullscreen: ['F11'],\n  onCloseWindow: ['ctrl+w', 'cmd+w'],\n  onQuitApp: ['ctrl+q', 'cmd+q'],\n  onGoLeft: ['ArrowLeft', 'h', 'shift+ '],\n  onGoRight: ['ArrowRight', 'l', ' '],\n  onGoUp: ['ArrowUp', 'k'],\n  onGoDown: ['ArrowDown', 'j'],\n  onGoNext: ['shift+j', 'shift+ArrowRight', 'shift+ArrowDown', 'PageDown'],\n  onGoPrev: ['shift+k', 'shift+ArrowLeft', 'shift+ArrowUp', 'PageUp'],\n  onGoLeftSection: ['opt+ArrowLeft', 'alt+ArrowLeft'],\n  onGoRightSection: ['opt+ArrowRight', 'alt+ArrowRight'],\n  onGoPrevSection: ['opt+ArrowUp', 'alt+ArrowUp'],\n  onGoNextSection: ['opt+ArrowDown', 'alt+ArrowDown'],\n  onGoHalfPageDown: ['shift+ArrowDown', 'd'],\n  onGoHalfPageUp: ['shift+ArrowUp', 'u'],\n  onGoBack: ['shift+ArrowLeft', 'shift+h', 'alt+ArrowLeft'],\n  onGoForward: ['shift+ArrowRight', 'shift+l', 'alt+ArrowRight'],\n  onZoomIn: ['ctrl+=', 'cmd+=', 'shift+='],\n  onZoomOut: ['ctrl+-', 'cmd+-', 'shift+-'],\n  onResetZoom: ['ctrl+0', 'cmd+0'],\n  onSaveNote: ['ctrl+Enter'],\n  onEscape: ['Escape'],\n};\n\nexport type ShortcutConfig = {\n  [K in keyof typeof DEFAULT_SHORTCUTS]: string[];\n};\n\n// Load shortcuts from localStorage or fallback to defaults\nexport const loadShortcuts = (): ShortcutConfig => {\n  if (typeof localStorage === 'undefined') return DEFAULT_SHORTCUTS;\n  const customShortcuts = JSON.parse(localStorage.getItem('customShortcuts') || '{}');\n  return {\n    ...DEFAULT_SHORTCUTS,\n    ...customShortcuts,\n  };\n};\n\n// Save custom shortcuts to localStorage\nexport const saveShortcuts = (shortcuts: ShortcutConfig) => {\n  localStorage.setItem('customShortcuts', JSON.stringify(shortcuts));\n};\n"],"names":[],"mappings":";;;;;;AAAA,MAAM,oBAAoB;IACxB,iBAAiB;QAAC;QAAY;QAAW;KAAU;IACnD,iBAAiB;QAAC;KAAI;IACtB,kBAAkB;QAAC;KAAI;IACvB,iBAAiB;QAAC;QAAU;KAAQ;IACpC,oBAAoB;QAAC;KAAU;IAC/B,oBAAoB;QAAC;KAAU;IAC/B,kBAAkB;QAAC;QAAU;KAAQ;IACrC,aAAa;QAAC;KAAI;IAClB,sBAAsB;QAAC;QAAU;KAAQ;IACzC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,qBAAqB;QAAC;QAAU;KAAQ;IACxC,mBAAmB;QAAC;QAAU;KAAQ;IACtC,iBAAiB;QAAC;QAAU;KAAQ;IACpC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,uBAAuB;QAAC;QAAU;KAAQ;IAC1C,sBAAsB;QAAC;QAAU;KAAQ;IACzC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,sBAAsB;QAAC;QAAU;KAAQ;IACzC,0BAA0B;QAAC;QAAW;QAAU;KAAQ;IACxD,aAAa;QAAC;KAAS;IACvB,cAAc;QAAC;KAAU;IACzB,oBAAoB;QAAC;KAAM;IAC3B,eAAe;QAAC;QAAU;KAAQ;IAClC,WAAW;QAAC;QAAU;KAAQ;IAC9B,UAAU;QAAC;QAAa;QAAK;KAAU;IACvC,WAAW;QAAC;QAAc;QAAK;KAAI;IACnC,QAAQ;QAAC;QAAW;KAAI;IACxB,UAAU;QAAC;QAAa;KAAI;IAC5B,UAAU;QAAC;QAAW;QAAoB;QAAmB;KAAW;IACxE,UAAU;QAAC;QAAW;QAAmB;QAAiB;KAAS;IACnE,iBAAiB;QAAC;QAAiB;KAAgB;IACnD,kBAAkB;QAAC;QAAkB;KAAiB;IACtD,iBAAiB;QAAC;QAAe;KAAc;IAC/C,iBAAiB;QAAC;QAAiB;KAAgB;IACnD,kBAAkB;QAAC;QAAmB;KAAI;IAC1C,gBAAgB;QAAC;QAAiB;KAAI;IACtC,UAAU;QAAC;QAAmB;QAAW;KAAgB;IACzD,aAAa;QAAC;QAAoB;QAAW;KAAiB;IAC9D,UAAU;QAAC;QAAU;QAAS;KAAU;IACxC,WAAW;QAAC;QAAU;QAAS;KAAU;IACzC,aAAa;QAAC;QAAU;KAAQ;IAChC,YAAY;QAAC;KAAa;IAC1B,UAAU;QAAC;KAAS;AACtB;AAOO,MAAM,gBAAgB;IAC3B,IAAI,OAAO,iBAAiB,aAAa,OAAO;IAChD,MAAM,kBAAkB,KAAK,KAAK,CAAC,aAAa,OAAO,CAAC,sBAAsB;IAC9E,OAAO;QACL,GAAG,iBAAiB;QACpB,GAAG,eAAe;IACpB;AACF;AAGO,MAAM,gBAAgB,CAAC;IAC5B,aAAa,OAAO,CAAC,mBAAmB,KAAK,SAAS,CAAC;AACzD"}},
    {"offset": {"line": 5457, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/helpers/settings.ts"],"sourcesContent":["import { ViewSettings } from '@/types/book';\nimport { SystemSettings } from '@/types/settings';\nimport { EnvConfigType } from '@/services/environment';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { getStyles } from '@/utils/style';\n\nexport const saveViewSettings = async <K extends keyof ViewSettings>(\n  envConfig: EnvConfigType,\n  bookKey: string,\n  key: K,\n  value: ViewSettings[K],\n  skipGlobal = false,\n  applyStyles = true,\n) => {\n  const { settings, isSettingsGlobal, setSettings, saveSettings } = useSettingsStore.getState();\n  const { bookKeys, getView, getViewState, getViewSettings, setViewSettings } =\n    useReaderStore.getState();\n  const { getConfig, saveConfig } = useBookDataStore.getState();\n\n  const applyViewSettings = async (bookKey: string) => {\n    const viewSettings = getViewSettings(bookKey);\n    const viewState = getViewState(bookKey);\n    if (bookKey && viewSettings && viewSettings[key] !== value) {\n      viewSettings[key] = value;\n      setViewSettings(bookKey, viewSettings);\n      if (applyStyles) {\n        const view = getView(bookKey);\n        view?.renderer.setStyles?.(getStyles(viewSettings));\n      }\n      const config = getConfig(bookKey);\n      if (viewState?.isPrimary && config) {\n        await saveConfig(envConfig, bookKey, config, settings);\n      }\n    }\n  };\n\n  if (isSettingsGlobal && !skipGlobal) {\n    settings.globalViewSettings[key] = value;\n    setSettings(settings);\n\n    for (const bookKey of bookKeys) {\n      await applyViewSettings(bookKey);\n    }\n    await saveSettings(envConfig, settings);\n  } else if (bookKey) {\n    await applyViewSettings(bookKey);\n  }\n};\n\nexport const saveSysSettings = async <K extends keyof SystemSettings>(\n  envConfig: EnvConfigType,\n  key: K,\n  value: SystemSettings[K],\n) => {\n  const { settings, setSettings, saveSettings } = useSettingsStore.getState();\n  if (settings[key] !== value) {\n    settings[key] = value;\n    setSettings(settings);\n    await saveSettings(envConfig, settings);\n  }\n};\n"],"names":[],"mappings":";;;;;;AAGA;AACA;AACA;AACA;;;;;;;;;;;;AAEO,MAAM,mBAAmB,OAC9B,WACA,SACA,KACA,OACA,aAAa,KAAK,EAClB,cAAc,IAAI;IAElB,MAAM,EAAE,QAAQ,EAAE,gBAAgB,EAAE,WAAW,EAAE,YAAY,EAAE,GAAG,oKAAgB,CAAC,QAAQ;IAC3F,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,YAAY,EAAE,eAAe,EAAE,eAAe,EAAE,GACzE,gKAAc,CAAC,QAAQ;IACzB,MAAM,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,oKAAgB,CAAC,QAAQ;IAE3D,MAAM,oBAAoB,OAAO;QAC/B,MAAM,eAAe,gBAAgB;QACrC,MAAM,YAAY,aAAa;QAC/B,IAAI,WAAW,gBAAgB,YAAY,CAAC,IAAI,KAAK,OAAO;YAC1D,YAAY,CAAC,IAAI,GAAG;YACpB,gBAAgB,SAAS;YACzB,IAAI,aAAa;gBACf,MAAM,OAAO,QAAQ;gBACrB,MAAM,SAAS,YAAY,IAAA,qJAAS,EAAC;YACvC;YACA,MAAM,SAAS,UAAU;YACzB,IAAI,WAAW,aAAa,QAAQ;gBAClC,MAAM,WAAW,WAAW,SAAS,QAAQ;YAC/C;QACF;IACF;IAEA,IAAI,oBAAoB,CAAC,YAAY;QACnC,SAAS,kBAAkB,CAAC,IAAI,GAAG;QACnC,YAAY;QAEZ,KAAK,MAAM,WAAW,SAAU;YAC9B,MAAM,kBAAkB;QAC1B;QACA,MAAM,aAAa,WAAW;IAChC,OAAO,IAAI,SAAS;QAClB,MAAM,kBAAkB;IAC1B;AACF;AAEO,MAAM,kBAAkB,OAC7B,WACA,KACA;IAEA,MAAM,EAAE,QAAQ,EAAE,WAAW,EAAE,YAAY,EAAE,GAAG,oKAAgB,CAAC,QAAQ;IACzE,IAAI,QAAQ,CAAC,IAAI,KAAK,OAAO;QAC3B,QAAQ,CAAC,IAAI,GAAG;QAChB,YAAY;QACZ,MAAM,aAAa,WAAW;IAChC;AACF"}},
    {"offset": {"line": 5524, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/pages/reader/%5Bids%5D.tsx"],"sourcesContent":["'use client';\n\nimport { useRouter } from 'next/router';\nimport { AuthProvider } from '@/context/AuthContext';\nimport { EnvProvider } from '@/context/EnvContext';\nimport { CSPostHogProvider } from '@/context/PHContext';\nimport { SyncProvider } from '@/context/SyncContext';\nimport Reader from '@/app/reader/components/Reader';\n\nexport default function Page() {\n  const router = useRouter();\n  const ids = router.query['ids'] as string;\n  return (\n    <CSPostHogProvider>\n      <EnvProvider>\n        <AuthProvider>\n          <SyncProvider>\n            <Reader ids={ids} />\n          </SyncProvider>\n        </AuthProvider>\n      </EnvProvider>\n    </CSPostHogProvider>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;AACA;;;;;AAPA;;;;;;;;AASe,SAAS;IACtB,MAAM,SAAS,IAAA,sSAAS;IACxB,MAAM,MAAM,OAAO,KAAK,CAAC,MAAM;IAC/B,qBACE,qKAAC,oKAAiB;kBAChB,cAAA,qKAAC,+JAAW;sBACV,cAAA,qKAAC,iKAAY;0BACX,cAAA,qKAAC,iKAAY;8BACX,cAAA,qKAAC,2KAAM;wBAAC,KAAK;;;;;;;;;;;;;;;;;;;;;;;;;;AAMzB"}}]
}