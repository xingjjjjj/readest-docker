{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/AnnotationTools.tsx"],"sourcesContent":["import { IconType } from 'react-icons';\nimport { FiSearch } from 'react-icons/fi';\nimport { FiCopy } from 'react-icons/fi';\nimport { PiHighlighterFill } from 'react-icons/pi';\nimport { FaWikipediaW } from 'react-icons/fa';\nimport { BsPencilSquare } from 'react-icons/bs';\nimport { BsTranslate } from 'react-icons/bs';\nimport { TbHexagonLetterD } from 'react-icons/tb';\nimport { FaHeadphones } from 'react-icons/fa6';\nimport { IoIosBuild } from 'react-icons/io';\nimport { AnnotationToolType } from '@/types/annotator';\nimport { stubTranslation as _ } from '@/utils/misc';\n\ntype AnnotationToolButton = {\n  type: AnnotationToolType;\n  label: string;\n  tooltip: string;\n  Icon: IconType;\n  quickAction?: boolean;\n};\n\nfunction createAnnotationToolButtons<T extends AnnotationToolType>(\n  buttons: AnnotationToolType extends T\n    ? {\n        [K in T]: {\n          type: K;\n          label: string;\n          tooltip: string;\n          Icon: IconType;\n          quickAction?: boolean;\n        };\n      }[T][]\n    : never,\n): AnnotationToolButton[] {\n  return buttons;\n}\n\nexport const annotationToolButtons = createAnnotationToolButtons([\n  { type: 'copy', label: _('Copy'), tooltip: _('Copy text after selection'), Icon: FiCopy },\n  {\n    type: 'highlight',\n    label: _('Highlight'),\n    tooltip: _('Highlight text after selection'),\n    Icon: PiHighlighterFill,\n    quickAction: true,\n  },\n  {\n    type: 'annotate',\n    label: _('Annotate'),\n    tooltip: _('Annotate text after selection'),\n    Icon: BsPencilSquare,\n  },\n  {\n    type: 'search',\n    label: _('Search'),\n    tooltip: _('Search text after selection'),\n    Icon: FiSearch,\n    quickAction: true,\n  },\n  {\n    type: 'dictionary',\n    label: _('Dictionary'),\n    tooltip: _('Look up text in dictionary after selection'),\n    Icon: TbHexagonLetterD,\n    quickAction: true,\n  },\n  {\n    type: 'wikipedia',\n    label: _('Wikipedia'),\n    tooltip: _('Look up text in Wikipedia after selection'),\n    Icon: FaWikipediaW,\n    quickAction: true,\n  },\n  {\n    type: 'translate',\n    label: _('Translate'),\n    tooltip: _('Translate text after selection'),\n    Icon: BsTranslate,\n    quickAction: true,\n  },\n  {\n    type: 'tts',\n    label: _('Speak'),\n    tooltip: _('Read text aloud after selection'),\n    Icon: FaHeadphones,\n    quickAction: true,\n  },\n  {\n    type: 'proofread',\n    label: _('Proofread'),\n    tooltip: _('Proofread text after selection'),\n    Icon: IoIosBuild,\n  },\n]);\n\nexport const annotationToolQuickActions = annotationToolButtons.filter(\n  (button) => button.quickAction,\n);\n"],"names":[],"mappings":";;;;;;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;;;;;;;;;;;AAUA,SAAS,4BACP,OAUS;IAET,OAAO;AACT;AAEO,MAAM,wBAAwB,4BAA4B;IAC/D;QAAE,MAAM;QAAQ,OAAO,IAAA,0JAAC,EAAC;QAAS,SAAS,IAAA,0JAAC,EAAC;QAA8B,MAAM,kOAAM;IAAC;IACxF;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,6OAAiB;QACvB,aAAa;IACf;IACA;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,0OAAc;IACtB;IACA;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,oOAAQ;QACd,aAAa;IACf;IACA;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,4OAAgB;QACtB,aAAa;IACf;IACA;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,wOAAY;QAClB,aAAa;IACf;IACA;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,uOAAW;QACjB,aAAa;IACf;IACA;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,yOAAY;QAClB,aAAa;IACf;IACA;QACE,MAAM;QACN,OAAO,IAAA,0JAAC,EAAC;QACT,SAAS,IAAA,0JAAC,EAAC;QACX,MAAM,sOAAU;IAClB;CACD;AAEM,MAAM,6BAA6B,sBAAsB,MAAM,CACpE,CAAC,SAAW,OAAO,WAAW"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/QuickActionMenu.tsx"],"sourcesContent":["import clsx from 'clsx';\nimport React from 'react';\n\nimport { AnnotationToolType } from '@/types/annotator';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { annotationToolQuickActions } from './AnnotationTools';\nimport { eventDispatcher } from '@/utils/event';\nimport MenuItem from '@/components/MenuItem';\nimport Menu from '@/components/Menu';\n\ninterface QuickActionMenuProps {\n  selectedAction?: AnnotationToolType | null;\n  onActionSelect: (action: AnnotationToolType) => void;\n  setIsDropdownOpen?: (open: boolean) => void;\n}\n\nconst QuickActionMenu: React.FC<QuickActionMenuProps> = ({\n  selectedAction,\n  onActionSelect,\n  setIsDropdownOpen,\n}) => {\n  const _ = useTranslation();\n\n  const handleActionClick = (action: AnnotationToolType) => {\n    onActionSelect(action);\n    if (selectedAction === action) {\n      eventDispatcher.dispatch('toast', {\n        type: 'info',\n        timeout: 2000,\n        message: _('Quick action disabled'),\n      });\n    } else {\n      eventDispatcher.dispatch('toast', {\n        type: 'info',\n        timeout: 2000,\n        message: _(annotationToolQuickActions.find((btn) => btn.type === action)?.tooltip || ''),\n      });\n    }\n    setIsDropdownOpen?.(false);\n  };\n\n  return (\n    <Menu\n      className={clsx(\n        'annotation-quick-action-menu dropdown-content z-20 mt-1 border',\n        'bgcolor-base-200 shadow-2xl',\n      )}\n      style={{\n        maxWidth: `${window.innerWidth - 40}px`,\n      }}\n      onCancel={() => setIsDropdownOpen?.(false)}\n    >\n      {annotationToolQuickActions.map((button) => (\n        <MenuItem\n          key={button.type}\n          label={_(button.label)}\n          tooltip={_(button.tooltip)}\n          buttonClass={selectedAction === button.type ? 'bg-base-300/85' : ''}\n          Icon={button.Icon}\n          onClick={() => handleActionClick(button.type)}\n        />\n      ))}\n    </Menu>\n  );\n};\n\nexport default QuickActionMenu;\n"],"names":[],"mappings":";;;;;AAAA;AAIA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;AAQA,MAAM,kBAAkD,CAAC,EACvD,cAAc,EACd,cAAc,EACd,iBAAiB,EAClB;IACC,MAAM,IAAI,IAAA,mKAAc;IAExB,MAAM,oBAAoB,CAAC;QACzB,eAAe;QACf,IAAI,mBAAmB,QAAQ;YAC7B,2JAAe,CAAC,QAAQ,CAAC,SAAS;gBAChC,MAAM;gBACN,SAAS;gBACT,SAAS,EAAE;YACb;QACF,OAAO;YACL,2JAAe,CAAC,QAAQ,CAAC,SAAS;gBAChC,MAAM;gBACN,SAAS;gBACT,SAAS,EAAE,oNAA0B,CAAC,IAAI,CAAC,CAAC,MAAQ,IAAI,IAAI,KAAK,SAAS,WAAW;YACvF;QACF;QACA,oBAAoB;IACtB;IAEA,qBACE,qKAAC,wJAAI;QACH,WAAW,IAAA,mHAAI,EACb,kEACA;QAEF,OAAO;YACL,UAAU,GAAG,OAAO,UAAU,GAAG,GAAG,EAAE,CAAC;QACzC;QACA,UAAU,IAAM,oBAAoB;kBAEnC,oNAA0B,CAAC,GAAG,CAAC,CAAC,uBAC/B,qKAAC,4JAAQ;gBAEP,OAAO,EAAE,OAAO,KAAK;gBACrB,SAAS,EAAE,OAAO,OAAO;gBACzB,aAAa,mBAAmB,OAAO,IAAI,GAAG,mBAAmB;gBACjE,MAAM,OAAO,IAAI;gBACjB,SAAS,IAAM,kBAAkB,OAAO,IAAI;eALvC,OAAO,IAAI;;;;;;;;;;AAU1B;uCAEe"}},
    {"offset": {"line": 175, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/AnnotationRangeEditor.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\n\nimport { BookNote, HighlightColor } from '@/types/book';\nimport { Point, TextSelection } from '@/utils/sel';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\nimport { useAnnotationEditor } from '../../hooks/useAnnotationEditor';\nimport { getHighlightColorHex } from '../../utils/annotatorUtil';\n\ninterface HandleProps {\n  position: Point;\n  isVertical: boolean;\n  type: 'start' | 'end';\n  color: string;\n  onDragStart: () => void;\n  onDrag: (point: Point) => void;\n  onDragEnd: () => void;\n}\n\nconst Handle: React.FC<HandleProps> = ({\n  position,\n  isVertical,\n  type,\n  color,\n  onDragStart,\n  onDrag,\n  onDragEnd,\n}) => {\n  const isDragging = useRef(false);\n  const size = useResponsiveSize(24);\n  const circleRadius = useResponsiveSize(8);\n  const stemHeight = useResponsiveSize(12);\n\n  const handlePointerDown = useCallback(\n    (e: React.PointerEvent) => {\n      e.preventDefault();\n      e.stopPropagation();\n      isDragging.current = true;\n      onDragStart();\n      (e.target as HTMLElement).setPointerCapture(e.pointerId);\n    },\n    [onDragStart],\n  );\n\n  const handlePointerMove = useCallback(\n    (e: React.PointerEvent) => {\n      if (!isDragging.current) return;\n      e.preventDefault();\n      e.stopPropagation();\n      onDrag({ x: e.clientX, y: e.clientY });\n    },\n    [onDrag],\n  );\n\n  const handlePointerUp = useCallback(\n    (e: React.PointerEvent) => {\n      if (!isDragging.current) return;\n      e.preventDefault();\n      e.stopPropagation();\n      isDragging.current = false;\n      (e.target as HTMLElement).releasePointerCapture(e.pointerId);\n      onDragEnd();\n    },\n    [onDragEnd],\n  );\n\n  return (\n    <div\n      className='pointer-events-auto absolute z-50 cursor-grab touch-none active:cursor-grabbing'\n      style={{\n        left: isVertical\n          ? type === 'start'\n            ? position.x - size / 2 + stemHeight / 4\n            : position.x - size / 2\n          : position.x - size / 2,\n        top: isVertical\n          ? type === 'start'\n            ? position.y - size + stemHeight / 2\n            : position.y - size / 2 - stemHeight / 2\n          : type === 'start'\n            ? position.y - size\n            : position.y - size / 2 - stemHeight / 8,\n        width: size,\n        height: size + stemHeight,\n      }}\n      onPointerDown={handlePointerDown}\n      onPointerMove={handlePointerMove}\n      onPointerUp={handlePointerUp}\n      onPointerCancel={handlePointerUp}\n    >\n      <svg\n        width={size}\n        height={size + stemHeight}\n        viewBox={`0 0 ${size} ${size + stemHeight}`}\n        className={clsx(type === 'start' && 'rotate-180')}\n        style={{\n          transform: isVertical\n            ? type === 'start'\n              ? 'rotate(270deg)'\n              : 'rotate(90deg)'\n            : type === 'start'\n              ? 'rotate(180deg)'\n              : undefined,\n        }}\n      >\n        {/* Stem/line */}\n        <line\n          x1={size / 2}\n          y1={0}\n          x2={size / 2}\n          y2={stemHeight}\n          stroke={color}\n          strokeWidth={2}\n          strokeLinecap='round'\n        />\n        {/* Circle handle */}\n        <circle cx={size / 2} cy={stemHeight + circleRadius} r={circleRadius} fill={color} />\n      </svg>\n    </div>\n  );\n};\n\ninterface AnnotationRangeEditorProps {\n  bookKey: string;\n  isVertical: boolean;\n  annotation: BookNote;\n  selection: TextSelection;\n  handleColor: HighlightColor;\n  getAnnotationText: (range: Range) => Promise<string>;\n  setSelection: React.Dispatch<React.SetStateAction<TextSelection | null>>;\n  onStartEdit: () => void;\n}\n\nconst AnnotationRangeEditor: React.FC<AnnotationRangeEditorProps> = ({\n  bookKey,\n  isVertical,\n  annotation,\n  selection,\n  handleColor,\n  getAnnotationText,\n  setSelection,\n  onStartEdit,\n}) => {\n  const { settings } = useSettingsStore();\n  const { isDarkMode } = useThemeStore();\n  const isEink = settings.globalViewSettings.isEink;\n  const einkFgColor = isDarkMode ? '#ffffff' : '#000000';\n  const { handlePositions, getHandlePositionsFromRange, handleAnnotationRangeChange } =\n    useAnnotationEditor({ bookKey, annotation, getAnnotationText, setSelection });\n\n  const initializedRef = useRef(false);\n  const handleColorHex = getHighlightColorHex(settings, handleColor) ?? '#FFFF00';\n  const draggingRef = useRef<'start' | 'end' | null>(null);\n  const startRef = useRef<Point>({ x: 0, y: 0 });\n  const endRef = useRef<Point>({ x: 0, y: 0 });\n  const [currentStart, setCurrentStart] = useState<Point>({ x: 0, y: 0 });\n  const [currentEnd, setCurrentEnd] = useState<Point>({ x: 0, y: 0 });\n\n  useEffect(() => {\n    if (initializedRef.current) return;\n    initializedRef.current = true;\n\n    const range = selection.range;\n    const positions = getHandlePositionsFromRange(range, isVertical);\n    if (positions) {\n      setTimeout(() => {\n        setCurrentStart(positions.start);\n        setCurrentEnd(positions.end);\n      }, 0);\n      startRef.current = positions.start;\n      endRef.current = positions.end;\n    }\n  }, [annotation, selection, isVertical, getHandlePositionsFromRange]);\n\n  useEffect(() => {\n    if (!handlePositions || draggingRef.current) return;\n    setTimeout(() => {\n      setCurrentStart(handlePositions.start);\n      setCurrentEnd(handlePositions.end);\n    }, 0);\n    startRef.current = handlePositions.start;\n    endRef.current = handlePositions.end;\n  }, [handlePositions]);\n\n  const handleStartDragStart = useCallback(() => {\n    draggingRef.current = 'start';\n    onStartEdit();\n  }, [onStartEdit]);\n\n  const handleEndDragStart = useCallback(() => {\n    draggingRef.current = 'end';\n    onStartEdit();\n  }, [onStartEdit]);\n\n  const handleStartDrag = useCallback(\n    (point: Point) => {\n      setCurrentStart(point);\n      startRef.current = point;\n      handleAnnotationRangeChange(point, endRef.current, isVertical, true);\n    },\n    [isVertical, handleAnnotationRangeChange],\n  );\n\n  const handleEndDrag = useCallback(\n    (point: Point) => {\n      setCurrentEnd(point);\n      endRef.current = point;\n      handleAnnotationRangeChange(startRef.current, point, isVertical, true);\n    },\n    [isVertical, handleAnnotationRangeChange],\n  );\n\n  const handleDragEnd = useCallback(() => {\n    draggingRef.current = null;\n    handleAnnotationRangeChange(startRef.current, endRef.current, isVertical, false);\n  }, [isVertical, handleAnnotationRangeChange]);\n\n  if (currentStart.x === 0 && currentStart.y === 0) {\n    return null;\n  }\n\n  return (\n    <div className='pointer-events-none fixed inset-0 z-50'>\n      <Handle\n        position={currentStart}\n        isVertical={isVertical}\n        type='start'\n        color={isEink ? einkFgColor : handleColorHex}\n        onDragStart={handleStartDragStart}\n        onDrag={handleStartDrag}\n        onDragEnd={handleDragEnd}\n      />\n      <Handle\n        position={currentEnd}\n        isVertical={isVertical}\n        type='end'\n        color={isEink ? einkFgColor : handleColorHex}\n        onDragStart={handleEndDragStart}\n        onDrag={handleEndDrag}\n        onDragEnd={handleDragEnd}\n      />\n    </div>\n  );\n};\n\nexport default AnnotationRangeEditor;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 436, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/AnnotationToolButton.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useState } from 'react';\n\ninterface AnnotationToolButtonProps {\n  showTooltip: boolean;\n  tooltipText: string;\n  disabled?: boolean;\n  Icon: React.ElementType;\n  onClick: () => void;\n}\n\nconst AnnotationToolButton: React.FC<AnnotationToolButtonProps> = ({\n  showTooltip,\n  tooltipText,\n  disabled,\n  Icon,\n  onClick,\n}) => {\n  const [buttonClicked, setButtonClicked] = useState(false);\n  const handleClick = () => {\n    setButtonClicked(true);\n    onClick();\n  };\n  return (\n    <div\n      className='lg:tooltip lg:tooltip-bottom'\n      title={!buttonClicked && showTooltip ? tooltipText : undefined}\n    >\n      <button\n        onClick={handleClick}\n        className={clsx(\n          'flex h-8 min-h-8 w-8 items-center justify-center p-0',\n          disabled\n            ? 'cursor-not-allowed opacity-50'\n            : 'not-eink:hover:bg-gray-500 eink:hover:border rounded-md',\n        )}\n        disabled={disabled}\n      >\n        <Icon />\n      </button>\n    </div>\n  );\n};\n\nexport default AnnotationToolButton;\n"],"names":[],"mappings":";;;;;AAEA;AACA;;;;;AAHA;;;;AAaA,MAAM,uBAA4D,CAAC,EACjE,WAAW,EACX,WAAW,EACX,QAAQ,EACR,IAAI,EACJ,OAAO,EACR;IACC,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,+GAAQ,EAAC;IACnD,MAAM,cAAc;QAClB,iBAAiB;QACjB;IACF;IACA,qBACE,qKAAC;QACC,WAAU;QACV,OAAO,CAAC,iBAAiB,cAAc,cAAc;kBAErD,cAAA,qKAAC;YACC,SAAS;YACT,WAAW,IAAA,mHAAI,EACb,wDACA,WACI,kCACA;YAEN,UAAU;sBAEV,cAAA,qKAAC;;;;;;;;;;;;;;;AAIT;uCAEe"}},
    {"offset": {"line": 488, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/AnnotationNotes.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport dayjs from 'dayjs';\nimport React, { useMemo } from 'react';\nimport { BookNote } from '@/types/book';\nimport { useEnv } from '@/context/EnvContext';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useSidebarStore } from '@/store/sidebarStore';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\n\ninterface AnnotationNotesProps {\n  bookKey: string;\n  isVertical: boolean;\n  notes: BookNote[];\n  toolsVisible: boolean;\n  triangleDir: 'up' | 'down' | 'left' | 'right';\n  popupWidth: number;\n  popupHeight: number;\n  onDismiss: () => void;\n}\n\nconst AnnotationNotes: React.FC<AnnotationNotesProps> = ({\n  bookKey,\n  isVertical,\n  notes,\n  toolsVisible,\n  triangleDir,\n  popupWidth,\n  popupHeight,\n  onDismiss,\n}) => {\n  const { appService } = useEnv();\n  const { getConfig, setConfig } = useBookDataStore();\n  const { setHoveredBookKey } = useReaderStore();\n  const { setSideBarVisible } = useSidebarStore();\n  const config = getConfig(bookKey);\n  const maxSize = useResponsiveSize(250);\n\n  const sortedNotes = useMemo(() => {\n    return [...notes].sort((a, b) => b.updatedAt - a.updatedAt);\n  }, [notes]);\n\n  const handleShowAnnotation = (note: BookNote) => {\n    if (!note.id) return;\n\n    if (appService?.isMobile) {\n      onDismiss();\n    }\n\n    setHoveredBookKey('');\n    setSideBarVisible(true);\n    if (config?.viewSettings) {\n      setConfig(bookKey, {\n        viewSettings: { ...config.viewSettings, sideBarTab: 'annotations' },\n      });\n    }\n  };\n\n  return (\n    <div\n      className={clsx('annotation-notes absolute flex rounded-lg text-white')}\n      style={{\n        ...(isVertical\n          ? {\n              right: triangleDir === 'left' ? `${toolsVisible ? popupWidth + 16 : 0}px` : undefined,\n              left: triangleDir === 'right' ? `${toolsVisible ? popupWidth + 16 : 0}px` : undefined,\n              height: `${popupHeight}px`,\n              maxWidth: `${maxSize}px`,\n              overflowX: 'auto',\n            }\n          : {\n              top: triangleDir === 'down' ? `${toolsVisible ? popupHeight + 16 : 0}px` : undefined,\n              bottom: triangleDir === 'up' ? `${toolsVisible ? popupHeight + 16 : 0}px` : undefined,\n              width: `${popupWidth}px`,\n              maxHeight: `${maxSize}px`,\n              overflowY: 'auto',\n            }),\n        scrollbarWidth: 'thin',\n      }}\n    >\n      <div\n        className={clsx('flex gap-4', isVertical ? 'h-full flex-row' : 'w-full flex-col')}\n        style={\n          isVertical\n            ? {\n                display: 'grid',\n                gridAutoFlow: 'column',\n                gridAutoColumns: 'max-content',\n                minWidth: 'min-content',\n                height: `${popupHeight}px`,\n                maxHeight: `${popupHeight}px`,\n              }\n            : {}\n        }\n      >\n        {sortedNotes.map((note, index) => (\n          <div\n            role='none'\n            key={note.id || index}\n            onClick={() => handleShowAnnotation?.(note)}\n            className={clsx(\n              'popup-container cursor-pointer rounded-lg bg-gray-600 shadow-lg transition-colors',\n            )}\n            style={\n              isVertical\n                ? {\n                    minWidth: 'max-content',\n                    height: `${popupHeight}px`,\n                    maxHeight: `${popupHeight}px`,\n                  }\n                : {}\n            }\n          >\n            {note.note && (\n              <div\n                dir='auto'\n                className={clsx(\n                  'm-4 hyphens-auto text-justify font-sans text-sm',\n                  'not-eink:text-white eink:text-base-content',\n                  isVertical && 'writing-vertical-rl',\n                )}\n                style={\n                  isVertical\n                    ? {\n                        fontFeatureSettings: \"'vrt2' 1, 'vert' 1\",\n                        minWidth: 'max-content',\n                      }\n                    : {}\n                }\n              >\n                <div className={clsx('flex flex-col justify-between gap-2')}>\n                  {note.note}\n                  <span className='not-eink:text-white/50 eink:text-base-content/50 text-sm sm:text-xs'>\n                    {dayjs(note.createdAt).fromNow()}\n                  </span>\n                </div>\n              </div>\n            )}\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n};\n\nexport default AnnotationNotes;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 639, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/HighlightOptions.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useState } from 'react';\nimport { FaCheckCircle } from 'react-icons/fa';\nimport { HighlightColor, HighlightStyle } from '@/types/book';\nimport { useEnv } from '@/context/EnvContext';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\nimport { saveSysSettings } from '@/helpers/settings';\n\nconst styles = ['highlight', 'underline', 'squiggly'] as HighlightStyle[];\nconst colors = ['red', 'violet', 'blue', 'green', 'yellow'] as HighlightColor[];\n\ninterface HighlightOptionsProps {\n  isVertical: boolean;\n  popupWidth: number;\n  popupHeight: number;\n  triangleDir: 'up' | 'down' | 'left' | 'right';\n  selectedStyle: HighlightStyle;\n  selectedColor: HighlightColor;\n  onHandleHighlight: (update: boolean) => void;\n}\n\nconst OPTIONS_HEIGHT_PIX = 28;\nconst OPTIONS_PADDING_PIX = 16;\n\nconst HighlightOptions: React.FC<HighlightOptionsProps> = ({\n  isVertical,\n  popupWidth,\n  popupHeight,\n  triangleDir,\n  selectedStyle: _selectedStyle,\n  selectedColor: _selectedColor,\n  onHandleHighlight,\n}) => {\n  const { envConfig } = useEnv();\n  const { settings } = useSettingsStore();\n  const { isDarkMode } = useThemeStore();\n  const globalReadSettings = settings.globalReadSettings;\n  const isEink = settings.globalViewSettings.isEink;\n  const einkBgColor = isDarkMode ? '#000000' : '#ffffff';\n  const einkFgColor = isDarkMode ? '#ffffff' : '#000000';\n  const customColors = globalReadSettings.customHighlightColors;\n  const [selectedStyle, setSelectedStyle] = useState<HighlightStyle>(_selectedStyle);\n  const [selectedColor, setSelectedColor] = useState<HighlightColor>(_selectedColor);\n  const size16 = useResponsiveSize(16);\n  const size28 = useResponsiveSize(28);\n  const highlightOptionsHeightPx = useResponsiveSize(OPTIONS_HEIGHT_PIX);\n  const highlightOptionsPaddingPx = useResponsiveSize(OPTIONS_PADDING_PIX);\n\n  const handleSelectStyle = (style: HighlightStyle) => {\n    const newGlobalReadSettings = { ...globalReadSettings, highlightStyle: style };\n    saveSysSettings(envConfig, 'globalReadSettings', newGlobalReadSettings);\n    setSelectedStyle(style);\n    setSelectedColor(globalReadSettings.highlightStyles[style]);\n    onHandleHighlight(true);\n  };\n  const handleSelectColor = (color: HighlightColor) => {\n    const newGlobalReadSettings = {\n      ...globalReadSettings,\n      highlightStyle: selectedStyle,\n      highlightStyles: { ...globalReadSettings.highlightStyles, [selectedStyle]: color },\n    };\n    saveSysSettings(envConfig, 'globalReadSettings', newGlobalReadSettings);\n    setSelectedColor(color);\n    onHandleHighlight(true);\n  };\n  return (\n    <div\n      className={clsx(\n        'highlight-options absolute flex items-center justify-between',\n        isVertical ? 'flex-col' : 'flex-row',\n      )}\n      style={{\n        width: `${popupWidth}px`,\n        height: `${popupHeight}px`,\n        ...(isVertical\n          ? {\n              left: `${\n                (highlightOptionsHeightPx + highlightOptionsPaddingPx) *\n                (triangleDir === 'left' ? -1 : 1)\n              }px`,\n            }\n          : {\n              top: `${\n                (highlightOptionsHeightPx + highlightOptionsPaddingPx) *\n                (triangleDir === 'up' ? -1 : 1)\n              }px`,\n            }),\n      }}\n    >\n      <div\n        className={clsx('flex gap-2', isVertical ? 'flex-col' : 'flex-row')}\n        style={isVertical ? { width: size28 } : { height: size28 }}\n      >\n        {styles.map((style) => (\n          <button\n            key={style}\n            onClick={() => handleSelectStyle(style)}\n            className='not-eink:bg-gray-700 eink-bordered flex items-center justify-center rounded-full p-0'\n            style={{ width: size28, height: size28, minHeight: size28 }}\n          >\n            <div\n              style={{\n                width: size16,\n                height: size16,\n                ...(style === 'highlight' &&\n                  selectedStyle === 'highlight' && {\n                    backgroundColor: isEink ? einkFgColor : customColors[selectedColor],\n                    color: isEink ? einkBgColor : '#d1d5db',\n                    paddingTop: '2px',\n                  }),\n                ...(style === 'highlight' &&\n                  selectedStyle !== 'highlight' && {\n                    backgroundColor: '#d1d5db',\n                    paddingTop: '2px',\n                  }),\n                ...((style === 'underline' || style === 'squiggly') && {\n                  color: isEink ? einkFgColor : '#d1d5db',\n                  textDecoration: 'underline',\n                  textDecorationThickness: '2px',\n                  textDecorationColor:\n                    selectedStyle === style\n                      ? isEink\n                        ? einkFgColor\n                        : customColors[selectedColor]\n                      : '#d1d5db',\n                  ...(style === 'squiggly' && { textDecorationStyle: 'wavy' }),\n                }),\n              }}\n              className='w-4 p-0 text-center leading-none'\n            >\n              A\n            </div>\n          </button>\n        ))}\n      </div>\n\n      <div\n        className={clsx(\n          'not-eink:bg-gray-700 eink-bordered flex items-center justify-center gap-2 rounded-3xl',\n          isVertical ? 'flex-col py-2' : 'flex-row px-2',\n        )}\n        style={isVertical ? { width: size28 } : { height: size28 }}\n      >\n        {colors\n          .filter((c) => (isEink ? selectedColor === c : true))\n          .map((color) => (\n            <button\n              key={color}\n              onClick={() => handleSelectColor(color)}\n              style={{\n                width: size16,\n                height: size16,\n                backgroundColor: selectedColor !== color ? customColors[color] : 'transparent',\n              }}\n              className='rounded-full p-0'\n            >\n              {selectedColor === color && (\n                <FaCheckCircle\n                  size={size16}\n                  style={{ fill: isEink ? einkFgColor : customColors[color] }}\n                />\n              )}\n            </button>\n          ))}\n      </div>\n    </div>\n  );\n};\n\nexport default HighlightOptions;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 838, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/AnnotationPopup.tsx"],"sourcesContent":["import clsx from 'clsx';\nimport React from 'react';\nimport { Position } from '@/utils/sel';\nimport { BookNote, HighlightColor, HighlightStyle } from '@/types/book';\nimport Popup from '@/components/Popup';\nimport AnnotationToolButton from './AnnotationToolButton';\nimport AnnotationNotes from './AnnotationNotes';\nimport HighlightOptions from './HighlightOptions';\n\ninterface AnnotationPopupProps {\n  bookKey: string;\n  dir: 'ltr' | 'rtl';\n  isVertical: boolean;\n  buttons: Array<{\n    tooltipText: string;\n    Icon: React.ElementType;\n    onClick: () => void;\n    disabled?: boolean;\n    visible?: boolean;\n  }>;\n  notes: BookNote[];\n  position: Position;\n  trianglePosition: Position;\n  highlightOptionsVisible: boolean;\n  selectedStyle: HighlightStyle;\n  selectedColor: HighlightColor;\n  popupWidth: number;\n  popupHeight: number;\n  onHighlight: (update?: boolean) => void;\n  onDismiss: () => void;\n}\n\nconst AnnotationPopup: React.FC<AnnotationPopupProps> = ({\n  bookKey,\n  dir,\n  isVertical,\n  buttons,\n  notes,\n  position,\n  trianglePosition,\n  highlightOptionsVisible,\n  selectedStyle,\n  selectedColor,\n  popupWidth,\n  popupHeight,\n  onHighlight,\n  onDismiss,\n}) => {\n  return (\n    <div dir={dir}>\n      <Popup\n        width={isVertical ? popupHeight : popupWidth}\n        height={isVertical ? popupWidth : popupHeight}\n        minHeight={isVertical ? popupWidth : popupHeight}\n        position={position}\n        trianglePosition={trianglePosition}\n        className={clsx(\n          'selection-popup bg-gray-600 text-white',\n          notes.length > 0 && 'bg-transparent',\n        )}\n        triangleClassName='text-gray-600'\n        onDismiss={onDismiss}\n      >\n        <div className={clsx('flex h-full gap-4', isVertical ? 'flex-row' : 'flex-col')}>\n          <div\n            className={clsx(\n              'selection-buttons flex h-full w-full items-center justify-between p-2',\n              isVertical ? 'flex-col overflow-y-auto' : 'flex-row overflow-x-auto',\n              notes.length > 0 && 'hidden',\n            )}\n            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\n          >\n            {buttons.map((button, index) => {\n              if (button.visible === false) return null;\n              return (\n                <AnnotationToolButton\n                  key={index}\n                  showTooltip={!highlightOptionsVisible}\n                  tooltipText={button.tooltipText}\n                  Icon={button.Icon}\n                  onClick={button.onClick}\n                  disabled={button.disabled}\n                />\n              );\n            })}\n          </div>\n          {notes.length > 0 ? (\n            <AnnotationNotes\n              bookKey={bookKey}\n              isVertical={isVertical}\n              notes={notes}\n              toolsVisible={false}\n              triangleDir={trianglePosition.dir!}\n              popupWidth={isVertical ? popupHeight : popupWidth}\n              popupHeight={isVertical ? popupWidth : popupHeight}\n              onDismiss={onDismiss}\n            />\n          ) : (\n            highlightOptionsVisible && (\n              <HighlightOptions\n                isVertical={isVertical}\n                triangleDir={trianglePosition.dir!}\n                popupWidth={isVertical ? popupHeight : popupWidth}\n                popupHeight={isVertical ? popupWidth : popupHeight}\n                selectedStyle={selectedStyle}\n                selectedColor={selectedColor}\n                onHandleHighlight={onHighlight}\n              />\n            )\n          )}\n        </div>\n      </Popup>\n    </div>\n  );\n};\n\nexport default AnnotationPopup;\n"],"names":[],"mappings":";;;;;AAAA;AAIA;AACA;AACA;AACA;;;;;;;;;;;;;;;AAyBA,MAAM,kBAAkD,CAAC,EACvD,OAAO,EACP,GAAG,EACH,UAAU,EACV,OAAO,EACP,KAAK,EACL,QAAQ,EACR,gBAAgB,EAChB,uBAAuB,EACvB,aAAa,EACb,aAAa,EACb,UAAU,EACV,WAAW,EACX,WAAW,EACX,SAAS,EACV;IACC,qBACE,qKAAC;QAAI,KAAK;kBACR,cAAA,qKAAC,yJAAK;YACJ,OAAO,aAAa,cAAc;YAClC,QAAQ,aAAa,aAAa;YAClC,WAAW,aAAa,aAAa;YACrC,UAAU;YACV,kBAAkB;YAClB,WAAW,IAAA,mHAAI,EACb,0CACA,MAAM,MAAM,GAAG,KAAK;YAEtB,mBAAkB;YAClB,WAAW;sBAEX,cAAA,qKAAC;gBAAI,WAAW,IAAA,mHAAI,EAAC,qBAAqB,aAAa,aAAa;;kCAClE,qKAAC;wBACC,WAAW,IAAA,mHAAI,EACb,yEACA,aAAa,6BAA6B,4BAC1C,MAAM,MAAM,GAAG,KAAK;wBAEtB,OAAO;4BAAE,gBAAgB;4BAAQ,iBAAiB;wBAAO;kCAExD,QAAQ,GAAG,CAAC,CAAC,QAAQ;4BACpB,IAAI,OAAO,OAAO,KAAK,OAAO,OAAO;4BACrC,qBACE,qKAAC,sMAAoB;gCAEnB,aAAa,CAAC;gCACd,aAAa,OAAO,WAAW;gCAC/B,MAAM,OAAO,IAAI;gCACjB,SAAS,OAAO,OAAO;gCACvB,UAAU,OAAO,QAAQ;+BALpB;;;;;wBAQX;;;;;;oBAED,MAAM,MAAM,GAAG,kBACd,qKAAC,iMAAe;wBACd,SAAS;wBACT,YAAY;wBACZ,OAAO;wBACP,cAAc;wBACd,aAAa,iBAAiB,GAAG;wBACjC,YAAY,aAAa,cAAc;wBACvC,aAAa,aAAa,aAAa;wBACvC,WAAW;;;;;mEAGb,yCACE,qKAAC,kMAAgB;wBACf,YAAY;wBACZ,aAAa,iBAAiB,GAAG;wBACjC,YAAY,aAAa,cAAc;wBACvC,aAAa,aAAa,aAAa;wBACvC,eAAe;wBACf,eAAe;wBACf,mBAAmB;;;;;;;;;;;;;;;;;;;;;;AAQnC;uCAEe"}},
    {"offset": {"line": 953, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/WiktionaryPopup.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef, useState } from 'react';\nimport { Position } from '@/utils/sel';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport Popup from '@/components/Popup';\n\ntype Definition = {\n  definition: string;\n  examples?: string[];\n};\n\ntype Result = {\n  partOfSpeech: string;\n  definitions: Definition[];\n  language: string;\n};\n\ninterface WiktionaryPopupProps {\n  word: string;\n  lang?: string;\n  position: Position;\n  trianglePosition: Position;\n  popupWidth: number;\n  popupHeight: number;\n  onDismiss?: () => void;\n}\n\nconst WiktionaryPopup: React.FC<WiktionaryPopupProps> = ({\n  word,\n  lang,\n  position,\n  trianglePosition,\n  popupWidth,\n  popupHeight,\n  onDismiss,\n}) => {\n  const _ = useTranslation();\n  const [lookupWord, setLookupWord] = useState(word);\n  const isLookingUp = useRef(false);\n\n  const interceptDictLinks = (definition: string): HTMLElement[] => {\n    const container = document.createElement('div');\n    container.innerHTML = definition;\n\n    const links = container.querySelectorAll<HTMLAnchorElement>('a[rel=\"mw:WikiLink\"]');\n\n    links.forEach((link) => {\n      const title = link.getAttribute('title');\n      if (title) {\n        link.addEventListener('click', (event) => {\n          event.preventDefault();\n          setLookupWord(title);\n          isLookingUp.current = false;\n        });\n\n        link.className = 'text-primary underline cursor-pointer';\n      }\n    });\n\n    return Array.from(container.childNodes) as HTMLElement[];\n  };\n\n  useEffect(() => {\n    if (isLookingUp.current) {\n      return;\n    }\n    isLookingUp.current = true;\n    const main = document.querySelector('main') as HTMLElement;\n    const footer = document.querySelector('footer') as HTMLElement;\n\n    const fetchDefinitions = async (word: string, language?: string) => {\n      main.innerHTML = '';\n      footer.dataset['state'] = 'loading';\n\n      try {\n        const response = await fetch(\n          `https://en.wiktionary.org/api/rest_v1/page/definition/${word}`,\n        );\n        if (!response.ok) {\n          throw new Error('Failed to fetch definitions');\n        }\n\n        const json = await response.json();\n        const results: Result[] | undefined = language\n          ? json[language] || json['en']\n          : json[Object.keys(json)[0]!];\n\n        if (!results || results.length === 0) {\n          throw new Error('No results found');\n        }\n\n        const hgroup = document.createElement('hgroup');\n        const h1 = document.createElement('h1');\n        h1.innerText = word;\n        h1.className = 'text-lg font-bold';\n\n        const p = document.createElement('p');\n        p.innerText = results[0]!.language;\n        p.className = 'text-sm italic opacity-75';\n        hgroup.append(h1, p);\n        main.append(hgroup);\n\n        results.forEach(({ partOfSpeech, definitions }: Result) => {\n          const h2 = document.createElement('h2');\n          h2.innerText = partOfSpeech;\n          h2.className = 'text-base font-semibold mt-4';\n\n          const ol = document.createElement('ol');\n          ol.className = 'pl-8 list-decimal';\n\n          definitions.forEach(({ definition, examples }: Definition) => {\n            if (!definition) return;\n            const li = document.createElement('li');\n            const processedContent = interceptDictLinks(definition);\n            li.append(...processedContent);\n\n            if (examples) {\n              const ul = document.createElement('ul');\n              ul.className = 'pl-8 list-disc text-sm italic opacity-75';\n\n              examples.forEach((example) => {\n                const exampleLi = document.createElement('li');\n                exampleLi.innerHTML = example;\n                ul.appendChild(exampleLi);\n              });\n\n              li.appendChild(ul);\n            }\n\n            ol.appendChild(li);\n          });\n\n          main.appendChild(h2);\n          main.appendChild(ol);\n        });\n\n        footer.dataset['state'] = 'loaded';\n      } catch (error) {\n        console.error(error);\n        footer.dataset['state'] = 'error';\n\n        const div = document.createElement('div');\n        div.className =\n          'flex flex-col items-center justify-center w-full h-full text-center absolute inset-0';\n\n        const h1 = document.createElement('h1');\n        h1.innerText = _('Error');\n        h1.className = 'text-lg font-bold';\n\n        const p = document.createElement('p');\n        p.innerHTML = _('Unable to load the word. Try searching directly on {{link}}.', {\n          link: `<a href=\"https://en.wiktionary.org/w/index.php?search=${encodeURIComponent(\n            word,\n          )}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-primary underline\">Wiktionary</a>`,\n        });\n\n        div.append(h1, p);\n        main.append(div);\n      }\n    };\n\n    const langCode = typeof lang === 'string' ? lang : lang?.[0];\n    fetchDefinitions(lookupWord, langCode);\n  }, [_, lookupWord, lang]);\n\n  return (\n    <div>\n      <Popup\n        trianglePosition={trianglePosition}\n        width={popupWidth}\n        height={popupHeight}\n        position={position}\n        className='select-text'\n        onDismiss={onDismiss}\n      >\n        <div className='flex h-full flex-col'>\n          <main className='flex-grow overflow-y-auto p-4 font-sans' />\n          <footer className='mt-auto hidden data-[state=loaded]:block data-[state=error]:hidden data-[state=loading]:hidden'>\n            <div className='flex items-center px-4 py-2 text-sm opacity-60'>\n              Source: Wiktionary (CC BY-SA)\n            </div>\n          </footer>\n        </div>\n      </Popup>\n    </div>\n  );\n};\n\nexport default WiktionaryPopup;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1129, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/WikipediaPopup.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useRef } from 'react';\nimport Popup from '@/components/Popup';\nimport { Position } from '@/utils/sel';\nimport { useTranslation } from '@/hooks/useTranslation';\n\ninterface WikipediaPopupProps {\n  text: string;\n  lang: string;\n  position: Position;\n  trianglePosition: Position;\n  popupWidth: number;\n  popupHeight: number;\n  onDismiss?: () => void;\n}\n\nconst WikipediaPopup: React.FC<WikipediaPopupProps> = ({\n  text,\n  lang,\n  position,\n  trianglePosition,\n  popupWidth,\n  popupHeight,\n  onDismiss,\n}) => {\n  const _ = useTranslation();\n  const isLoading = useRef(false);\n\n  useEffect(() => {\n    if (isLoading.current) {\n      return;\n    }\n    isLoading.current = true;\n\n    const main = document.querySelector('main') as HTMLElement;\n    const footer = document.querySelector('footer') as HTMLElement;\n\n    const fetchSummary = async (query: string, language: string) => {\n      main.innerHTML = '';\n      footer.dataset['state'] = 'loading';\n\n      try {\n        const response = await fetch(\n          `https://${language}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`,\n        );\n\n        if (!response.ok) {\n          throw new Error('Failed to fetch Wikipedia summary');\n        }\n\n        const data = await response.json();\n\n        const hgroup = document.createElement('hgroup');\n        hgroup.style.color = 'white';\n        hgroup.style.backgroundPosition = 'center center';\n        hgroup.style.backgroundSize = 'cover';\n        hgroup.style.backgroundColor = 'rgba(0, 0, 0, .4)';\n        hgroup.style.backgroundBlendMode = 'darken';\n        hgroup.style.borderRadius = '6px';\n        hgroup.style.padding = '12px';\n        hgroup.style.marginBottom = '12px';\n        hgroup.style.minHeight = '100px';\n\n        const h1 = document.createElement('h1');\n        h1.innerHTML = data.titles.display;\n        h1.className = 'text-lg font-bold';\n        hgroup.append(h1);\n\n        if (data.description) {\n          const description = document.createElement('p');\n          description.innerText = data.description;\n          hgroup.appendChild(description);\n        }\n\n        if (data.thumbnail) {\n          hgroup.style.backgroundImage = `url(\"${data.thumbnail.source}\")`;\n        }\n\n        const contentDiv = document.createElement('div');\n        contentDiv.innerHTML = data.extract_html;\n        contentDiv.className = 'p-2 text-sm';\n        contentDiv.dir = data.dir;\n\n        main.append(hgroup, contentDiv);\n        footer.dataset['state'] = 'loaded';\n      } catch (error) {\n        console.error(error);\n\n        const errorDiv = document.createElement('div');\n        const h1 = document.createElement('h1');\n        h1.innerText = _('Error');\n\n        const errorMsg = document.createElement('p');\n        errorMsg.innerHTML = _('Unable to load the article. Try searching directly on {{link}}.', {\n          link: `<a href=\"https://${language}.wikipedia.org/w/index.php?search=${encodeURIComponent(\n            query,\n          )}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-primary underline\">Wikipedia</a>`,\n        });\n\n        errorDiv.append(h1, errorMsg);\n        main.appendChild(errorDiv);\n        footer.dataset['state'] = 'error';\n      }\n    };\n\n    const bookLang = typeof lang === 'string' ? lang : lang?.[0];\n    const langCode = bookLang ? bookLang.split('-')[0]! : 'en';\n    fetchSummary(text, langCode);\n  }, [_, text, lang]);\n\n  return (\n    <div>\n      <Popup\n        width={popupWidth}\n        height={popupHeight}\n        position={position}\n        trianglePosition={trianglePosition}\n        className='select-text'\n        onDismiss={onDismiss}\n      >\n        <div className='text-base-content flex h-full flex-col pt-2'>\n          <main className='flex-grow overflow-y-auto px-2 font-sans'></main>\n          <footer className='mt-auto hidden data-[state=loaded]:block data-[state=error]:hidden data-[state=loading]:hidden'>\n            <div className='flex items-center px-4 py-2 text-sm opacity-60'>\n              Source: Wikipedia (CC BY-SA)\n            </div>\n          </footer>\n        </div>\n      </Popup>\n    </div>\n  );\n};\n\nexport default WikipediaPopup;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1274, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/TranslatorPopup.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useState } from 'react';\nimport Popup from '@/components/Popup';\nimport { Position } from '@/utils/sel';\nimport { useAuth } from '@/context/AuthContext';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useTranslator } from '@/hooks/useTranslator';\nimport { TRANSLATOR_LANGS } from '@/services/constants';\nimport { UseTranslatorOptions, getTranslators } from '@/services/translators';\nimport Select from '@/components/Select';\n\nconst notSupportedLangs = [''];\n\nconst generateTranslatorLangs = () => {\n  return Object.fromEntries(\n    Object.entries(TRANSLATOR_LANGS).filter(([code]) => !notSupportedLangs.includes(code)),\n  );\n};\n\nconst translatorLangs = generateTranslatorLangs();\n\ninterface TranslatorPopupProps {\n  text: string;\n  position: Position;\n  trianglePosition: Position;\n  popupWidth: number;\n  popupHeight: number;\n  onDismiss?: () => void;\n}\n\ninterface TranslatorType {\n  name: string;\n  label: string;\n}\n\nconst TranslatorPopup: React.FC<TranslatorPopupProps> = ({\n  text,\n  position,\n  trianglePosition,\n  popupWidth,\n  popupHeight,\n  onDismiss,\n}) => {\n  const _ = useTranslation();\n  const { token } = useAuth();\n  const { settings, setSettings } = useSettingsStore();\n  const [providers, setProviders] = useState<TranslatorType[]>([]);\n  const [sourceLang, setSourceLang] = useState('AUTO');\n  const [targetLang, setTargetLang] = useState(settings.globalReadSettings.translateTargetLang);\n  const [provider, setProvider] = useState(settings.globalReadSettings.translationProvider);\n  const [translation, setTranslation] = useState<string | null>(null);\n  const [detectedSourceLang, setDetectedSourceLang] = useState<string | null>(null);\n\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const { translate, translators } = useTranslator({\n    provider,\n    sourceLang,\n    targetLang,\n  } as UseTranslatorOptions);\n\n  const handleSourceLangChange = (event: React.ChangeEvent<HTMLSelectElement>) => {\n    setSourceLang(event.target.value);\n  };\n\n  const handleTargetLangChange = (event: React.ChangeEvent<HTMLSelectElement>) => {\n    settings.globalReadSettings.translateTargetLang = event.target.value;\n    setSettings(settings);\n    setTargetLang(event.target.value);\n  };\n\n  const handleProviderChange = (event: React.ChangeEvent<HTMLSelectElement>) => {\n    const requestedProvider = event.target.value;\n    const availableTranslators = getTranslators().filter(\n      (t) => (t.authRequired ? !!token : true) && !t.quotaExceeded,\n    );\n    const selectedTranslator =\n      availableTranslators.find((t) => t.name === requestedProvider) || availableTranslators[0]!;\n    if (selectedTranslator) {\n      settings.globalReadSettings.translationProvider = selectedTranslator.name;\n      setSettings(settings);\n      setProvider(selectedTranslator.name);\n    }\n  };\n\n  useEffect(() => {\n    const availableProviders = translators.map((t) => {\n      let label = t.label;\n      if (t.authRequired && !token) {\n        label = `${label} (${_('Login Required')})`;\n      } else if (t.quotaExceeded) {\n        label = `${label} (${_('Quota Exceeded')})`;\n      }\n      return { name: t.name, label };\n    });\n    setProviders(availableProviders);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [translators]);\n\n  useEffect(() => {\n    setLoading(true);\n    const fetchTranslation = async () => {\n      setError(null);\n      setTranslation(null);\n\n      try {\n        const input = text.replaceAll('\\n', '').trim();\n        const result = await translate([input]);\n        const translatedText = result[0];\n        const detectedSource = null;\n\n        if (!translatedText) {\n          throw new Error('No translation found');\n        }\n\n        setTranslation(translatedText);\n        if (sourceLang === 'AUTO' && detectedSource) {\n          setDetectedSourceLang(detectedSource);\n        }\n      } catch (err) {\n        console.error(err);\n        if (!token) {\n          setError(_('Unable to fetch the translation. Please log in first and try again.'));\n        } else {\n          setError(_('Unable to fetch the translation. Try again later.'));\n        }\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchTranslation();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [text, token, sourceLang, targetLang, provider, translate]);\n\n  return (\n    <div>\n      <Popup\n        trianglePosition={trianglePosition}\n        width={popupWidth}\n        minHeight={popupHeight}\n        maxHeight={720}\n        position={position}\n        className='not-eink:text-white grid h-full select-text grid-rows-[1fr,auto,1fr] bg-gray-600'\n        triangleClassName='text-gray-600'\n        onDismiss={onDismiss}\n      >\n        <div className='overflow-y-auto p-4 font-sans'>\n          <div className='mb-2 flex items-center justify-between'>\n            <h1 className='text-sm font-normal'>{_('Original Text')}</h1>\n            <Select\n              className='not-eink:bg-gray-600 not-eink:text-white eink:bg-base-100'\n              value={sourceLang}\n              onChange={handleSourceLangChange}\n              options={[\n                { value: 'AUTO', label: _('Auto Detect') },\n                ...Object.entries(translatorLangs)\n                  .sort((a, b) => a[1].localeCompare(b[1]))\n                  .map(([code, name]) => {\n                    const label =\n                      detectedSourceLang && sourceLang === 'AUTO' && code === 'AUTO'\n                        ? `${translatorLangs[detectedSourceLang] || detectedSourceLang} ` +\n                          _('(detected)')\n                        : name;\n                    return { value: code, label };\n                  }),\n              ]}\n            />\n          </div>\n          <p className='not-eink:text-white/90 text-base'>{text}</p>\n        </div>\n\n        <div className='mx-4 flex-shrink-0 border-t border-gray-500/30'></div>\n\n        <div className='overflow-y-auto px-4 pb-8 pt-4 font-sans'>\n          <div className='mb-2 flex items-center justify-between'>\n            <h2 className='text-sm font-normal'>{_('Translated Text')}</h2>\n            <Select\n              className='not-eink:bg-gray-600 not-eink:text-white eink:bg-base-100'\n              value={targetLang}\n              onChange={handleTargetLangChange}\n              options={[\n                { value: '', label: _('System Language') },\n                ...Object.entries(translatorLangs)\n                  .sort((a, b) => a[1].localeCompare(b[1]))\n                  .map(([code, name]) => ({ value: code, label: name })),\n              ]}\n            />\n          </div>\n          {loading ? (\n            <p className='text-base italic text-gray-500'>{_('Loading...')}</p>\n          ) : (\n            <div>\n              {error ? (\n                <p className='text-base text-red-600'>{error}</p>\n              ) : (\n                <p className='not-eink:text-white/90 text-base'>\n                  {translation || _('No translation available.')}\n                </p>\n              )}\n            </div>\n          )}\n        </div>\n        <div className='absolute bottom-0 flex h-8 w-full items-center justify-between px-4'>\n          <div className='line-clamp-1 text-xs opacity-60'>\n            {provider &&\n              !loading &&\n              !error &&\n              _('Translated by {{provider}}.', {\n                provider: providers.find((p) => p.name === provider)?.label,\n              })}\n          </div>\n          <Select\n            className='not-eink:bg-gray-600 not-eink:text-white eink:bg-base-100'\n            value={provider}\n            onChange={handleProviderChange}\n            options={providers.map(({ name: value, label }) => ({ value, label }))}\n          />\n        </div>\n      </Popup>\n    </div>\n  );\n};\n\nexport default TranslatorPopup;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1608, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/ProofreadPopup.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useRef, useState } from 'react';\nimport { useEnv } from '@/context/EnvContext';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useAutoFocus } from '@/hooks/useAutoFocus';\nimport { CreateProofreadRuleOptions, useProofreadStore } from '@/store/proofreadStore';\nimport { ProofreadScope } from '@/types/book';\nimport { eventDispatcher } from '@/utils/event';\nimport { Position, TextSelection } from '@/utils/sel';\nimport { isPunctuationOnly, isWholeWord } from '@/utils/word';\nimport Select from '@/components/Select';\nimport Popup from '@/components/Popup';\n\ninterface ProofreadPopupProps {\n  bookKey: string;\n  selection?: TextSelection;\n  position: Position;\n  trianglePosition: Position;\n  popupWidth: number;\n  popupHeight: number;\n  onConfirm?: (options: CreateProofreadRuleOptions) => void;\n  onDismiss: () => void;\n}\n\nconst ProofreadPopup: React.FC<ProofreadPopupProps> = ({\n  bookKey,\n  selection,\n  position,\n  trianglePosition,\n  popupWidth,\n  popupHeight,\n  onConfirm,\n  onDismiss,\n}) => {\n  const _ = useTranslation();\n  const { envConfig } = useEnv();\n  const { getProgress, getView, recreateViewer } = useReaderStore();\n  const { addRule } = useProofreadStore();\n  const progress = getProgress(bookKey)!;\n\n  const [replacementText, setReplacementText] = useState('');\n  const [caseSensitive, setCaseSensitive] = useState(true);\n  const [wholeWord, setWholeWord] = useState(!isPunctuationOnly(selection?.text || ''));\n  const [scope, setScope] = useState<ProofreadScope>('selection');\n  const [onlyForTTS, setOnlyForTTS] = useState(false);\n\n  const inputRef = useRef<HTMLInputElement>(null);\n  useAutoFocus<HTMLInputElement>({ ref: inputRef });\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const text = e.target.value;\n    setReplacementText(text);\n  };\n\n  const handleScopeChange = (event: React.ChangeEvent<HTMLSelectElement>) => {\n    setScope(event.target.value as ProofreadScope);\n  };\n\n  const handleApply = async () => {\n    if (!selection) return;\n\n    const range = selection?.range;\n\n    if (range) {\n      const isValidWholeWord = isWholeWord(range, selection?.text || '');\n\n      if (wholeWord && !isValidWholeWord) {\n        eventDispatcher.dispatch('toast', {\n          type: 'warning',\n          message: 'Please select a whole word or uncheck the \"Whole word\" option.',\n          timeout: 5000,\n        });\n        return;\n      }\n\n      if (scope === 'selection') {\n        range.deleteContents();\n        const textNode = document.createTextNode(replacementText);\n        range.insertNode(textNode);\n      }\n\n      const options: CreateProofreadRuleOptions = {\n        scope,\n        pattern: selection.text,\n        replacement: replacementText.trim(),\n        cfi: selection.cfi,\n        sectionHref: progress?.sectionHref,\n        isRegex: false,\n        enabled: true,\n        caseSensitive,\n        wholeWord: wholeWord,\n        onlyForTTS: scope !== 'selection' ? onlyForTTS : undefined,\n      };\n      onConfirm?.(options);\n\n      await addRule(envConfig, bookKey, options);\n\n      onDismiss();\n\n      if (scope !== 'selection' && !onlyForTTS) {\n        if (getView(bookKey)) {\n          recreateViewer(envConfig, bookKey);\n        }\n      }\n    }\n  };\n\n  const scopeOptions = [\n    { value: 'selection', label: _('Current selection') },\n    { value: 'book', label: _('All occurrences in this book') },\n    { value: 'library', label: _('All occurrences in your library') },\n  ];\n\n  return (\n    <div>\n      <Popup\n        trianglePosition={trianglePosition}\n        width={popupWidth}\n        minHeight={popupHeight}\n        position={position}\n        className='not-eink:text-gray-400 flex flex-col justify-between rounded-lg bg-gray-700'\n        triangleClassName='text-gray-700'\n        onDismiss={onDismiss}\n      >\n        <div className='flex flex-col gap-6 p-4'>\n          <div className='not-eink:text-gray-400 flex gap-1 text-xs'>\n            <span className='text-nowrap'>{_('Selected text:')}</span>\n            <span className='not-eink:text-yellow-300 line-clamp-1 select-text break-words font-medium'>\n              &quot;{selection?.text || ''}&quot;\n            </span>\n          </div>\n\n          <div className='flex items-center justify-between gap-2'>\n            <label htmlFor='replacement-input' className='text-xs'>\n              {_('Replace with:')}\n            </label>\n            <input\n              ref={inputRef}\n              type='text'\n              value={replacementText}\n              onChange={handleInputChange}\n              onKeyDown={(e) => {\n                if (e.key === 'Enter' && replacementText) {\n                  handleApply();\n                }\n              }}\n              placeholder={_('Enter text...')}\n              className={clsx(\n                'w-full flex-1 rounded-md p-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-0',\n                'not-eink:bg-gray-600 not-eink:text-white eink:border eink:border-base-content',\n              )}\n            />\n            <button\n              onClick={handleApply}\n              disabled={!replacementText}\n              className={clsx(\n                'btn btn-sm btn-ghost btn-primary disabled:text-base-content/75 text-blue-600 disabled:opacity-75',\n                'bg-transparent hover:bg-transparent disabled:bg-transparent',\n              )}\n            >\n              {_('Apply')}\n            </button>\n          </div>\n        </div>\n\n        <div className='flex flex-wrap items-center gap-4 p-4'>\n          <label className='flex cursor-pointer items-center gap-2'>\n            <span className='line-clamp-1 text-xs' title={_('Case sensitive:')}>\n              {_('Case sensitive:')}\n            </span>\n            <input\n              type='checkbox'\n              className='toggle toggle-sm bg-gray-500 checked:bg-black hover:bg-gray-500 hover:checked:bg-black'\n              style={\n                {\n                  '--tglbg': '#4B5563',\n                } as React.CSSProperties\n              }\n              checked={caseSensitive}\n              onChange={(e) => setCaseSensitive(e.target.checked)}\n            />\n          </label>\n\n          <label className='flex cursor-pointer items-center gap-2'>\n            <span className='line-clamp-1 text-xs' title={_('Whole word:')}>\n              {_('Whole word:')}\n            </span>\n            <input\n              type='checkbox'\n              className='toggle toggle-sm bg-gray-500 checked:bg-black hover:bg-gray-500 hover:checked:bg-black'\n              style={\n                {\n                  '--tglbg': '#4B5563',\n                } as React.CSSProperties\n              }\n              checked={wholeWord}\n              onChange={(e) => setWholeWord(e.target.checked)}\n            />\n          </label>\n\n          <label className='flex cursor-pointer items-center gap-2'>\n            <span className='line-clamp-1 text-xs' title={_('Only for TTS:')}>\n              {_('Only for TTS:')}\n            </span>\n            <input\n              type='checkbox'\n              disabled={scope === 'selection'}\n              className='toggle toggle-sm bg-gray-500 checked:bg-black hover:bg-gray-500 hover:checked:bg-black'\n              style={\n                {\n                  '--tglbg': '#4B5563',\n                } as React.CSSProperties\n              }\n              checked={onlyForTTS}\n              onChange={(e) => setOnlyForTTS(e.target.checked)}\n            />\n          </label>\n        </div>\n        <div className='flex flex-1 items-center justify-between gap-2 p-4'>\n          <label htmlFor='scope-select' className='line-clamp-1 text-xs' title={_('Scope:')}>\n            {_('Scope:')}\n          </label>\n          <Select\n            className='not-eink:bg-gray-600 eink:bg-base-100 not-eink:text-white max-w-[85%]'\n            value={scope}\n            onChange={handleScopeChange}\n            options={scopeOptions}\n          />\n        </div>\n      </Popup>\n    </div>\n  );\n};\n\nexport default ProofreadPopup;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1967, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/ExportMarkdownDialog.tsx"],"sourcesContent":["'use client';\n\nimport clsx from 'clsx';\nimport React, { useState, useMemo, useEffect } from 'react';\nimport { marked } from 'marked';\nimport { BookNote, BooknoteGroup, NoteExportConfig } from '@/types/book';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport Dialog from '@/components/Dialog';\nimport { useReaderStore } from '@/store/readerStore';\nimport { DEFAULT_NOTE_EXPORT_CONFIG } from '@/services/constants';\nimport { saveViewSettings } from '@/helpers/settings';\nimport { useEnv } from '@/context/EnvContext';\n\ninterface ExportMarkdownDialogProps {\n  bookKey: string;\n  isOpen: boolean;\n  bookTitle: string;\n  bookAuthor: string;\n  booknotes: BookNote[];\n  booknoteGroups: { [href: string]: BooknoteGroup };\n  onCancel: () => void;\n  onExport: (markdown: string) => void;\n}\n\ntype TemplateData = {\n  title: string;\n  author: string;\n  exportDate: string;\n  chapters: {\n    title: string;\n    annotations: {\n      text: string;\n      note?: string;\n      timestamp?: number;\n    }[];\n  }[];\n};\n\ntype TemplateVariable = { [key: string]: number | string | TemplateVariable | TemplateVariable[] };\n\nconst renderTemplate = (template: string, data: TemplateData): string => {\n  const applyFilter = (\n    value: TemplateVariable,\n    filter: string,\n    filterArg?: string,\n  ): TemplateVariable | string => {\n    if (filter === 'date') {\n      if (typeof value === 'number') {\n        const date = new Date(value);\n        if (filterArg) {\n          const format = filterArg;\n          return format\n            .replace('%Y', date.getFullYear().toString())\n            .replace('%m', String(date.getMonth() + 1).padStart(2, '0'))\n            .replace('%d', String(date.getDate()).padStart(2, '0'))\n            .replace('%H', String(date.getHours()).padStart(2, '0'))\n            .replace('%M', String(date.getMinutes()).padStart(2, '0'))\n            .replace('%S', String(date.getSeconds()).padStart(2, '0'));\n        }\n        return date.toLocaleString();\n      }\n      return value;\n    }\n    return value;\n  };\n\n  const getValue = (path: string, context: TemplateData) => {\n    const keys = path.trim().split('.');\n    let value = context as TemplateVariable;\n    for (const key of keys) {\n      value = value?.[key] as TemplateVariable;\n    }\n    return value;\n  };\n\n  let result = template;\n\n  // Process {% for %} loops - find first occurrence and recurse\n  const forMatch = result.match(/\\{%\\s*for\\s+(\\w+)\\s+in\\s+(\\w+(?:\\.\\w+)*)\\s*%\\}/);\n  if (forMatch) {\n    const itemName = forMatch[1]!;\n    const collectionPath = forMatch[2]!;\n\n    // Find matching {% endfor %} by counting nesting\n    let depth = 0;\n    let endPos = -1;\n    const startPos = forMatch.index! + forMatch[0].length;\n\n    for (let i = startPos; i < result.length; i++) {\n      const remaining = result.slice(i);\n      if (remaining.startsWith('{% for ')) {\n        depth++;\n        i += 6; // skip past \"{% for\"\n      } else if (remaining.startsWith('{% endfor %}')) {\n        if (depth === 0) {\n          endPos = i;\n          break;\n        }\n        depth--;\n        i += 11; // skip past \"{% endfor %}\"\n      }\n    }\n\n    if (endPos !== -1) {\n      const beforeLoop = result.slice(0, forMatch.index);\n      const loopContent = result.slice(startPos, endPos);\n      const afterLoop = result.slice(endPos + 13); // 13 = length of \"{% endfor %}\"\n\n      const collection = getValue(collectionPath, data);\n\n      if (Array.isArray(collection)) {\n        const renderedItems = collection\n          .map((item) => {\n            const loopData = { ...data, [itemName]: item };\n            return renderTemplate(loopContent, loopData);\n          })\n          .join('');\n\n        result = beforeLoop + renderedItems + afterLoop;\n        return renderTemplate(result, data);\n      } else {\n        // Collection not found or not an array, remove the loop\n        result = beforeLoop + afterLoop;\n        return renderTemplate(result, data);\n      }\n    }\n  }\n\n  // Process {% if condition %}...{% endif %}\n  result = result.replace(\n    /\\{%\\s*if\\s+([^%]+?)\\s*%\\}([\\s\\S]*?)\\{%\\s*endif\\s*%\\}/g,\n    (_match, condition, content) => {\n      const value = getValue(condition, data);\n      return value ? renderTemplate(content, data) : '';\n    },\n  );\n\n  // Replace {{ variable }}, {{ variable | filter }}, and {{ variable | filter('arg') }}\n  result = result.replace(\n    /\\{\\{\\s*([^}|]+?)(?:\\s*\\|\\s*(\\w+)(?:\\s*\\((['\"]?)([^)'\"]*)\\3\\))?)?\\s*\\}\\}/g,\n    (_match, path, filter, _quote, filterArg) => {\n      const value = getValue(path, data);\n      if (value === undefined || value === null) return '';\n      if (filter) {\n        return applyFilter(value, filter, filterArg) as string;\n      }\n      return String(value);\n    },\n  );\n\n  return result;\n};\n\nconst ExportMarkdownDialog: React.FC<ExportMarkdownDialogProps> = ({\n  bookKey,\n  isOpen,\n  bookTitle,\n  bookAuthor,\n  booknotes,\n  booknoteGroups,\n  onCancel,\n  onExport,\n}) => {\n  const _ = useTranslation();\n  const { envConfig } = useEnv();\n  const { getViewSettings } = useReaderStore();\n  const viewSettings = getViewSettings(bookKey);\n\n  const defaultTemplate = `## {{ title }}\n**${_('Author')}**: {{ author }}\n\n**${_('Exported from Readest')}**: {{ exportDate }}\n\n---\n\n### ${_('Highlights & Annotations')}\n\n{% for chapter in chapters %}\n#### {{ chapter.title }}\n{% for annotation in chapter.annotations %}\n> {{ annotation.text }}\n{% if annotation.note %}\n**${_('Note:')}** {{ annotation.note }}\n{% endif %}\n*${_('Time:')} {{ annotation.timestamp | date('%Y-%m-%d %H:%M') }}*\n{% endfor %}\n\n---\n{% endfor %}`;\n\n  const [exportConfig, setExportConfig] = useState<NoteExportConfig>(() => {\n    const noteExportConfig = viewSettings?.noteExportConfig || DEFAULT_NOTE_EXPORT_CONFIG;\n    if (!noteExportConfig.customTemplate) {\n      return {\n        ...noteExportConfig,\n        customTemplate: defaultTemplate,\n      };\n    }\n    return noteExportConfig;\n  });\n\n  const [showSource, setShowSource] = useState(false);\n  const [showAdvanced, setShowAdvanced] = useState(false);\n\n  useEffect(() => {\n    const customTemplate = exportConfig.customTemplate;\n    const newExportConfig = {\n      ...exportConfig,\n      customTemplate: customTemplate === defaultTemplate ? '' : customTemplate,\n    };\n    saveViewSettings(envConfig, bookKey, 'noteExportConfig', newExportConfig, false, false);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [exportConfig, envConfig, bookKey]);\n\n  // Generate markdown preview based on current format settings\n  const markdownPreview = useMemo(() => {\n    if (exportConfig.useCustomTemplate) {\n      // Prepare data for template rendering\n      const sortedGroups = Object.values(booknoteGroups).sort((a, b) => a.id - b.id);\n\n      const templateData = {\n        title: bookTitle,\n        author: bookAuthor,\n        exportDate: new Date().toISOString().slice(0, 10),\n        chapters: sortedGroups.map((group) => ({\n          title: group.label || _('Untitled'),\n          annotations: group.booknotes.map((note) => ({\n            text: note.text || '',\n            note: note.note || '',\n            style: note.style,\n            color: note.color,\n            timestamp: note.updatedAt,\n          })),\n        })),\n      };\n\n      return renderTemplate(exportConfig.customTemplate, templateData);\n    }\n\n    // Default formatting (non-template mode)\n    const sortedGroups = Object.values(booknoteGroups).sort((a, b) => a.id - b.id);\n\n    const lines: string[] = [];\n\n    // Add title\n    if (exportConfig.includeTitle) {\n      lines.push(`# ${bookTitle}`);\n    }\n\n    // Add author\n    if (exportConfig.includeAuthor && bookAuthor) {\n      lines.push(`**${_('Author')}**: ${bookAuthor}`);\n      lines.push('');\n    }\n\n    // Add export date\n    if (exportConfig.includeDate) {\n      lines.push(`**${_('Exported from Readest')}**: ${new Date().toISOString().slice(0, 10)}`);\n      lines.push('');\n    }\n\n    if (exportConfig.includeTitle || exportConfig.includeAuthor || exportConfig.includeDate) {\n      lines.push('---');\n      lines.push('');\n    }\n\n    lines.push(`## ${_('Highlights & Annotations')}`);\n    lines.push('');\n\n    for (const group of sortedGroups) {\n      // Add chapter title\n      if (exportConfig.includeChapterTitles) {\n        const chapterTitle = group.label || _('Untitled');\n        lines.push(`### ${chapterTitle}`);\n      }\n\n      for (const note of group.booknotes) {\n        // Add quote\n        if (exportConfig.includeQuotes && note.text) {\n          lines.push(`> ${note.text}`);\n        }\n\n        // Add note\n        if (exportConfig.includeNotes && note.note) {\n          lines.push('');\n          lines.push(`**${_('Note')}**:: ${note.note}`);\n        }\n\n        // Add timestamp\n        if (exportConfig.includeTimestamp && note.updatedAt) {\n          const timestamp = new Date(note.updatedAt).toLocaleString();\n          lines.push('');\n          lines.push(`*${_('Time:')} ${timestamp}*`);\n        }\n\n        lines.push(exportConfig.noteSeparator);\n      }\n\n      if (exportConfig.includeChapterSeparator) {\n        lines.push('---');\n        lines.push('');\n      }\n    }\n\n    return lines.join('\\n');\n  }, [exportConfig, booknoteGroups, bookTitle, bookAuthor, _]);\n\n  // Convert markdown to HTML for preview\n  const htmlPreview = useMemo(() => {\n    if (!markdownPreview) return '';\n    return marked.parse(markdownPreview);\n  }, [markdownPreview]);\n\n  const handleToggle = (field: keyof NoteExportConfig) => {\n    setExportConfig((prev) => ({\n      ...prev,\n      [field]: !prev[field],\n    }));\n  };\n\n  const handleExport = () => {\n    onExport(markdownPreview);\n  };\n\n  return (\n    <Dialog\n      isOpen={isOpen}\n      title={_('Export Annotations')}\n      onClose={onCancel}\n      boxClassName='sm:!w-[75%] sm:h-auto sm:!max-h-[90vh] sm:!max-w-5xl'\n      contentClassName='sm:!px-8 sm:!py-2'\n    >\n      <div className='flex flex-col gap-4'>\n        {/* Format Options */}\n        <div className='space-y-3'>\n          <h3 className='font-bold'>{_('Format Options')}</h3>\n\n          <div\n            className={clsx(\n              'grid grid-cols-2 gap-x-6 gap-y-3 sm:grid-cols-3',\n              exportConfig.useCustomTemplate && 'pointer-events-none opacity-50',\n            )}\n          >\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeTitle}\n                onChange={() => handleToggle('includeTitle')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Title')}</span>\n            </label>\n\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeAuthor}\n                onChange={() => handleToggle('includeAuthor')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Author')}</span>\n            </label>\n\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeDate}\n                onChange={() => handleToggle('includeDate')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Export Date')}</span>\n            </label>\n\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeChapterTitles}\n                onChange={() => handleToggle('includeChapterTitles')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Chapter Titles')}</span>\n            </label>\n\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeChapterSeparator}\n                onChange={() => handleToggle('includeChapterSeparator')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Chapter Separator')}</span>\n            </label>\n\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeQuotes}\n                onChange={() => handleToggle('includeQuotes')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Highlights')}</span>\n            </label>\n\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeNotes}\n                onChange={() => handleToggle('includeNotes')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Notes')}</span>\n            </label>\n\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={exportConfig.includeTimestamp}\n                onChange={() => handleToggle('includeTimestamp')}\n                className='checkbox checkbox-sm'\n                disabled={exportConfig.useCustomTemplate}\n              />\n              <span className='text-sm'>{_('Note Date')}</span>\n            </label>\n          </div>\n        </div>\n\n        {/* Advanced Options */}\n        <div className='space-y-3'>\n          <div className='flex items-center justify-between'>\n            <h3 className='font-bold'>{_('Advanced')}</h3>\n            <button\n              onClick={() => setShowAdvanced(!showAdvanced)}\n              className='text-sm text-blue-500 hover:underline'\n            >\n              {showAdvanced ? _('Hide') : _('Show')}\n            </button>\n          </div>\n\n          {showAdvanced && (\n            <div className='space-y-3'>\n              <label className='flex cursor-pointer items-center gap-2'>\n                <input\n                  type='checkbox'\n                  checked={exportConfig.useCustomTemplate}\n                  onChange={() => handleToggle('useCustomTemplate')}\n                  className='checkbox checkbox-sm'\n                />\n                <span className='text-sm font-medium'>{_('Use Custom Template')}</span>\n              </label>\n\n              {exportConfig.useCustomTemplate && (\n                <>\n                  <div className='space-y-2'>\n                    <label className='text-sm font-medium'>{_('Export Template')}</label>\n                    <textarea\n                      value={exportConfig.customTemplate}\n                      onChange={(e) =>\n                        setExportConfig({ ...exportConfig, customTemplate: e.target.value })\n                      }\n                      className='textarea textarea-bordered w-full font-mono text-xs'\n                      rows={12}\n                      placeholder={defaultTemplate}\n                    />\n                  </div>\n\n                  <div className='bg-base-200 space-y-3 rounded-lg p-3 text-xs'>\n                    <div>\n                      <p className='mb-2 font-bold'>{_('Template Syntax:')}</p>\n                      <ul className='space-y-1 font-mono'>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>{'{{ variable }}'}</code> -{' '}\n                          {_('Insert value')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>\n                            {'{{ variable | date }}'}\n                          </code>{' '}\n                          - {_('Format date (locale)')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>\n                            {\"{{ variable | date('%Y-%m-%d') }}\"}\n                          </code>{' '}\n                          - {_('Format date (custom)')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>\n                            {'{% if variable %}...{% endif %}'}\n                          </code>{' '}\n                          - {_('Conditional')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>\n                            {'{% for item in list %}...{% endfor %}'}\n                          </code>{' '}\n                          - {_('Loop')}\n                        </li>\n                      </ul>\n                    </div>\n                    <div>\n                      <p className='mb-2 font-bold'>{_('Available Variables:')}</p>\n                      <ul className='space-y-1'>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>title</code> -{' '}\n                          {_('Book title')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>author</code> -{' '}\n                          {_('Book author')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>exportDate</code> -{' '}\n                          {_('Export date')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>chapters</code> -{' '}\n                          {_('Array of chapters')}\n                        </li>\n                        <li className='ml-4'>\n                          <code className='bg-base-300 rounded px-1'>chapter.title</code> -{' '}\n                          {_('Chapter title')}\n                        </li>\n                        <li className='ml-4'>\n                          <code className='bg-base-300 rounded px-1'>chapter.annotations</code> -{' '}\n                          {_('Array of annotations')}\n                        </li>\n                        <li className='ml-8'>\n                          <code className='bg-base-300 rounded px-1'>annotation.text</code> -{' '}\n                          {_('Highlighted text')}\n                        </li>\n                        <li className='ml-8'>\n                          <code className='bg-base-300 rounded px-1'>annotation.note</code> -{' '}\n                          {_('Annotation note')}\n                        </li>\n                        <li className='ml-8'>\n                          <code className='bg-base-300 rounded px-1'>annotation.timestamp</code> -{' '}\n                          {_('Update time')}\n                        </li>\n                      </ul>\n                    </div>\n                    <div>\n                      <p className='mb-2 font-bold'>{_('Date Format Tokens:')}</p>\n                      <ul className='space-y-1 font-mono'>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>%Y</code> -{' '}\n                          {_('Year (4 digits)')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>%m</code> -{' '}\n                          {_('Month (01-12)')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>%d</code> - {_('Day (01-31)')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>%H</code> - {_('Hour (00-23)')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>%M</code> -{' '}\n                          {_('Minute (00-59)')}\n                        </li>\n                        <li>\n                          <code className='bg-base-300 rounded px-1'>%S</code> -{' '}\n                          {_('Second (00-59)')}\n                        </li>\n                      </ul>\n                    </div>\n                  </div>\n                </>\n              )}\n            </div>\n          )}\n        </div>\n\n        {/* Preview */}\n        <div className='space-y-2'>\n          <div className='flex items-center justify-between'>\n            <h3 className='font-bold'>{_('Preview')}</h3>\n            <label className='flex cursor-pointer items-center gap-2'>\n              <input\n                type='checkbox'\n                checked={showSource}\n                onChange={() => setShowSource(!showSource)}\n                className='checkbox checkbox-sm'\n              />\n              <span className='text-sm'>{_('Show Source')}</span>\n            </label>\n          </div>\n          {showSource ? (\n            <div\n              className={clsx(\n                'bg-base-200 max-h-[40vh] overflow-y-auto rounded-lg p-4 font-mono text-xs',\n                'select-text whitespace-pre-wrap break-words',\n              )}\n            >\n              {markdownPreview || _('No content to preview')}\n            </div>\n          ) : (\n            <div\n              className={clsx(\n                'bg-base-200 prose prose-sm max-w-none overflow-y-auto rounded-lg p-4',\n                'max-h-[40vh] select-text break-words',\n              )}\n              dangerouslySetInnerHTML={{\n                __html:\n                  htmlPreview ||\n                  `<p class=\"text-base-content/50\">${_('No content to preview')}</p>`,\n              }}\n            />\n          )}\n        </div>\n\n        {/* Footer Actions */}\n        <div className='mt-4 flex justify-end gap-4'>\n          <button onClick={onCancel} className='btn btn-ghost btn-sm'>\n            {_('Cancel')}\n          </button>\n          <button\n            onClick={handleExport}\n            className='btn btn-primary btn-sm'\n            disabled={booknotes.length === 0}\n          >\n            {_('Export')}\n          </button>\n        </div>\n      </div>\n    </Dialog>\n  );\n};\n\nexport default ExportMarkdownDialog;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3185, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/reader/components/annotator/Annotator.tsx"],"sourcesContent":["'use client';\n\nimport React, { useState, useEffect, useCallback, useMemo } from 'react';\nimport { RiDeleteBinLine } from 'react-icons/ri';\n\nimport * as CFI from 'foliate-js/epubcfi.js';\nimport { Overlayer } from 'foliate-js/overlayer.js';\nimport { useEnv } from '@/context/EnvContext';\nimport { BookNote, BooknoteGroup, HighlightColor, HighlightStyle } from '@/types/book';\nimport { NOTE_PREFIX } from '@/types/view';\nimport { NativeTouchEventType } from '@/types/system';\nimport { getLocale, getOSPlatform, makeSafeFilename, uniqueId } from '@/utils/misc';\nimport { useThemeStore } from '@/store/themeStore';\nimport { useBookDataStore } from '@/store/bookDataStore';\nimport { useSettingsStore } from '@/store/settingsStore';\nimport { useReaderStore } from '@/store/readerStore';\nimport { useNotebookStore } from '@/store/notebookStore';\nimport { useTranslation } from '@/hooks/useTranslation';\nimport { useResponsiveSize } from '@/hooks/useResponsiveSize';\nimport { useDeviceControlStore } from '@/store/deviceStore';\nimport { useFoliateEvents } from '../../hooks/useFoliateEvents';\nimport { useNotesSync } from '../../hooks/useNotesSync';\nimport { useTextSelector } from '../../hooks/useTextSelector';\nimport { Position, TextSelection } from '@/utils/sel';\nimport { getPopupPosition, getPosition, getTextFromRange } from '@/utils/sel';\nimport { eventDispatcher } from '@/utils/event';\nimport { findTocItemBS } from '@/utils/toc';\nimport { throttle } from '@/utils/throttle';\nimport { runSimpleCC } from '@/utils/simplecc';\nimport { getWordCount } from '@/utils/word';\nimport { isCfiInLocation } from '@/utils/cfi';\nimport { TransformContext } from '@/services/transformers/types';\nimport { transformContent } from '@/services/transformService';\nimport { getHighlightColorHex } from '../../utils/annotatorUtil';\nimport { annotationToolButtons } from './AnnotationTools';\nimport AnnotationRangeEditor from './AnnotationRangeEditor';\nimport AnnotationPopup from './AnnotationPopup';\nimport WiktionaryPopup from './WiktionaryPopup';\nimport WikipediaPopup from './WikipediaPopup';\nimport TranslatorPopup from './TranslatorPopup';\nimport useShortcuts from '@/hooks/useShortcuts';\nimport ProofreadPopup from './ProofreadPopup';\nimport ExportMarkdownDialog from './ExportMarkdownDialog';\n\nconst Annotator: React.FC<{ bookKey: string }> = ({ bookKey }) => {\n  const _ = useTranslation();\n  const { envConfig, appService } = useEnv();\n  const { settings } = useSettingsStore();\n  const { isDarkMode } = useThemeStore();\n  const { getConfig, saveConfig, getBookData, updateBooknotes } = useBookDataStore();\n  const { getProgress, getView, getViewsById, getViewSettings } = useReaderStore();\n  const { setNotebookVisible, setNotebookNewAnnotation } = useNotebookStore();\n  const { listenToNativeTouchEvents } = useDeviceControlStore();\n\n  useNotesSync(bookKey);\n\n  const osPlatform = getOSPlatform();\n  const config = getConfig(bookKey)!;\n  const progress = getProgress(bookKey)!;\n  const bookData = getBookData(bookKey)!;\n  const view = getView(bookKey);\n  const viewSettings = getViewSettings(bookKey)!;\n  const primaryLang = bookData.book?.primaryLanguage || 'en';\n\n  const containerRef = React.useRef<HTMLDivElement>(null);\n\n  const [selection, setSelection] = useState<TextSelection | null>(null);\n  const [showAnnotPopup, setShowAnnotPopup] = useState(false);\n  const [showWiktionaryPopup, setShowWiktionaryPopup] = useState(false);\n  const [showWikipediaPopup, setShowWikipediaPopup] = useState(false);\n  const [showDeepLPopup, setShowDeepLPopup] = useState(false);\n  const [showProofreadPopup, setShowProofreadPopup] = useState(false);\n  const [trianglePosition, setTrianglePosition] = useState<Position>();\n  const [annotPopupPosition, setAnnotPopupPosition] = useState<Position>();\n  const [dictPopupPosition, setDictPopupPosition] = useState<Position>();\n  const [translatorPopupPosition, setTranslatorPopupPosition] = useState<Position>();\n  const [proofreadPopupPosition, setProofreadPopupPosition] = useState<Position>();\n  const [highlightOptionsVisible, setHighlightOptionsVisible] = useState(false);\n  const [showAnnotationNotes, setShowAnnotationNotes] = useState(false);\n  const [annotationNotes, setAnnotationNotes] = useState<BookNote[]>([]);\n  const [editingAnnotation, setEditingAnnotation] = useState<BookNote | null>(null);\n  const [showExportDialog, setShowExportDialog] = useState(false);\n  const [exportData, setExportData] = useState<{\n    booknotes: BookNote[];\n    booknoteGroups: { [href: string]: BooknoteGroup };\n  } | null>(null);\n\n  const [selectedStyle, setSelectedStyle] = useState<HighlightStyle>(\n    settings.globalReadSettings.highlightStyle,\n  );\n  const [selectedColor, setSelectedColor] = useState<HighlightColor>(\n    settings.globalReadSettings.highlightStyles[selectedStyle],\n  );\n\n  const showingPopup =\n    showAnnotPopup ||\n    showWiktionaryPopup ||\n    showWikipediaPopup ||\n    showDeepLPopup ||\n    showProofreadPopup;\n\n  const popupPadding = useResponsiveSize(10);\n  const trianglePadding = popupPadding * 2 + 6;\n  const maxWidth = window.innerWidth - 2 * popupPadding;\n  const maxHeight = window.innerHeight - 2 * popupPadding;\n  const dictPopupWidth = Math.min(480, maxWidth);\n  const dictPopupHeight = Math.min(300, maxHeight);\n  const transPopupWidth = Math.min(480, maxWidth);\n  const transPopupHeight = Math.min(265, maxHeight);\n  const proofreadPopupWidth = Math.min(440, maxWidth);\n  const proofreadPopupHeight = Math.min(200, maxHeight);\n  const annotPopupWidth = Math.min(useResponsiveSize(300), maxWidth);\n  const annotPopupHeight = useResponsiveSize(44);\n  const androidSelectionHandlerHeight = 0;\n\n  // Reposition popups on scroll without dismissing them\n  const repositionPopups = useCallback(() => {\n    if (!selection || !selection.text) return;\n    const gridFrame = document.querySelector(`#gridcell-${bookKey}`);\n    if (!gridFrame) return;\n    const rect = gridFrame.getBoundingClientRect();\n    const triangPos = getPosition(selection, rect, trianglePadding, viewSettings.vertical);\n    const annotPopupPos = getPopupPosition(\n      triangPos,\n      rect,\n      viewSettings.vertical ? annotPopupHeight : annotPopupWidth,\n      viewSettings.vertical ? annotPopupWidth : annotPopupHeight,\n      popupPadding,\n    );\n    if (annotPopupPos.dir === 'down' && osPlatform === 'android') {\n      triangPos.point.y += androidSelectionHandlerHeight;\n      annotPopupPos.point.y += androidSelectionHandlerHeight;\n    }\n    const dictPopupPos = getPopupPosition(\n      triangPos,\n      rect,\n      dictPopupWidth,\n      dictPopupHeight,\n      popupPadding,\n    );\n    const transPopupPos = getPopupPosition(\n      triangPos,\n      rect,\n      transPopupWidth,\n      transPopupHeight,\n      popupPadding,\n    );\n    const proofreadPopupPos = getPopupPosition(\n      triangPos,\n      rect,\n      proofreadPopupWidth,\n      proofreadPopupHeight,\n      popupPadding,\n    );\n    if (triangPos.point.x == 0 || triangPos.point.y == 0) return;\n    setAnnotPopupPosition(annotPopupPos);\n    setDictPopupPosition(dictPopupPos);\n    setTranslatorPopupPosition(transPopupPos);\n    setProofreadPopupPosition(proofreadPopupPos);\n    setTrianglePosition(triangPos);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selection, bookKey, viewSettings.vertical]);\n\n  useEffect(() => {\n    setSelectedStyle(settings.globalReadSettings.highlightStyle);\n  }, [settings.globalReadSettings.highlightStyle]);\n\n  useEffect(() => {\n    setSelectedColor(settings.globalReadSettings.highlightStyles[selectedStyle]);\n  }, [settings.globalReadSettings.highlightStyles, selectedStyle]);\n\n  const transformCtx: TransformContext = useMemo(\n    () => ({\n      bookKey,\n      viewSettings: getViewSettings(bookKey)!,\n      userLocale: getLocale(),\n      content: '',\n      transformers: ['punctuation'],\n      reversePunctuationTransform: true,\n    }),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [],\n  );\n\n  const getAnnotationText = useCallback(\n    async (range: Range) => {\n      transformCtx['content'] = getTextFromRange(range, primaryLang.startsWith('ja') ? ['rt'] : []);\n      return await transformContent(transformCtx);\n    },\n    [primaryLang, transformCtx],\n  );\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const handleDismissPopup = useCallback(\n    throttle(() => {\n      setSelection(null);\n      setShowAnnotPopup(false);\n      setShowWiktionaryPopup(false);\n      setShowWikipediaPopup(false);\n      setShowDeepLPopup(false);\n      setShowProofreadPopup(false);\n      setEditingAnnotation(null);\n    }, 500),\n    [],\n  );\n\n  const {\n    isTextSelected,\n    handleScroll,\n    handleTouchStart,\n    handleTouchMove,\n    handleTouchEnd,\n    handlePointerDown,\n    handlePointerMove,\n    handlePointerCancel,\n    handlePointerUp,\n    handleSelectionchange,\n    handleShowPopup,\n    handleUpToPopup,\n    handleContextmenu,\n  } = useTextSelector(bookKey, setSelection, getAnnotationText, handleDismissPopup);\n\n  const handleDismissPopupAndSelection = () => {\n    handleDismissPopup();\n    view?.deselect();\n    isTextSelected.current = false;\n  };\n\n  const onLoad = (event: Event) => {\n    const detail = (event as CustomEvent).detail;\n    const { doc, index } = detail;\n\n    const handleTouchmove = (ev: TouchEvent) => {\n      // Available on iOS, on Android not fired\n      // To make the popup not follow the selection while dragging\n      setShowAnnotPopup(false);\n      setEditingAnnotation(null);\n      handleTouchMove(ev);\n    };\n\n    const handleNativeTouch = (event: CustomEvent) => {\n      const ev = event.detail as NativeTouchEventType;\n      if (ev.type === 'touchstart') {\n        handleTouchStart();\n      } else if (ev.type === 'touchend') {\n        handleTouchEnd();\n        handlePointerUp(doc, index);\n      }\n    };\n\n    if (appService?.isAndroidApp) {\n      listenToNativeTouchEvents();\n      eventDispatcher.on('native-touch', handleNativeTouch);\n    }\n\n    // Attach generic selection listeners for all formats, including PDF.\n    // For PDF we only guarantee Copy & Translate; highlight/annotate may be limited by CFI support.\n    view?.renderer?.addEventListener('scroll', handleScroll);\n    // Reposition popups on scroll to keep them in view\n    view?.renderer?.addEventListener('scroll', () => {\n      repositionPopups();\n    });\n    const opts = { passive: false };\n    detail.doc?.addEventListener('touchstart', handleTouchStart, opts);\n    detail.doc?.addEventListener('touchmove', handleTouchmove, opts);\n    detail.doc?.addEventListener('touchend', handleTouchEnd);\n    detail.doc?.addEventListener('pointerdown', handlePointerDown.bind(null, doc, index), opts);\n    detail.doc?.addEventListener('pointermove', handlePointerMove.bind(null, doc, index), opts);\n    detail.doc?.addEventListener('pointercancel', handlePointerCancel.bind(null, doc, index));\n    detail.doc?.addEventListener('pointerup', handlePointerUp.bind(null, doc, index));\n    detail.doc?.addEventListener('selectionchange', handleSelectionchange.bind(null, doc, index));\n\n    // For PDF selections, enable right-click context menu to directly open translator popup.\n    if (bookData.book?.format === 'PDF') {\n      detail.doc?.addEventListener('contextmenu', (e: Event) => {\n        try {\n          const sel = doc.getSelection?.();\n          if (sel && !sel.isCollapsed) {\n            const range = sel.getRangeAt(0);\n            const text = sel.toString();\n            if (text.trim()) {\n              setSelection({ key: bookKey, text, range, index, cfi: view?.getCFI(index, range) });\n              // Show translation popup preferentially for PDF right-click\n              setShowAnnotPopup(false);\n              setShowDeepLPopup(true);\n              setShowWiktionaryPopup(false);\n              setShowWikipediaPopup(false);\n            }\n          }\n        } catch (err) {\n          console.warn('PDF context menu translation failed:', err);\n        }\n        // Prevent native menu to keep experience consistent\n        e.preventDefault();\n        e.stopPropagation();\n        return false;\n      });\n    }\n\n    // Disable the default context menu on mobile devices (selection handles suffice)\n    detail.doc?.addEventListener('contextmenu', handleContextmenu);\n  };\n\n  const onDrawAnnotation = (event: Event) => {\n    const viewSettings = getViewSettings(bookKey)!;\n    const isEink = viewSettings.isEink;\n    const detail = (event as CustomEvent).detail;\n    const { draw, annotation, doc, range } = detail;\n    const { style, color } = annotation as BookNote;\n    const hexColor = getHighlightColorHex(settings, color);\n    const einkBgColor = isDarkMode ? '#000000' : '#ffffff';\n    const einkFgColor = isDarkMode ? '#ffffff' : '#000000';\n    if (annotation.note) {\n      const { defaultView } = doc;\n      const node = range.startContainer;\n      const el = node.nodeType === 1 ? node : node.parentElement;\n      const { writingMode } = defaultView.getComputedStyle(el);\n      draw(Overlayer.bubble, { writingMode });\n    } else if (style === 'highlight') {\n      draw(Overlayer.highlight, { color: isEink ? einkBgColor : hexColor });\n    } else if (['underline', 'squiggly'].includes(style as string)) {\n      const { defaultView } = doc;\n      const node = range.startContainer;\n      const el = node.nodeType === 1 ? node : node.parentElement;\n      const { writingMode, lineHeight, fontSize } = defaultView.getComputedStyle(el);\n      const fontSizeValue = parseFloat(fontSize) || viewSettings.defaultFontSize;\n      const lineHeightValue = parseFloat(lineHeight) || viewSettings.lineHeight * fontSizeValue;\n      const strokeWidth = 2;\n      const verticalCompensation = appService?.isMobile ? 0 : -1;\n      const horizontalCompensation = appService?.isMobile ? -1 : 0;\n      const padding = viewSettings.vertical\n        ? (lineHeightValue - fontSizeValue) / 2 - strokeWidth + verticalCompensation\n        : (lineHeightValue - fontSizeValue) / 2 - strokeWidth + horizontalCompensation;\n      draw(Overlayer[style as keyof typeof Overlayer], {\n        writingMode,\n        color: isEink ? einkFgColor : hexColor,\n        padding,\n      });\n    }\n  };\n\n  const onShowAnnotation = (event: Event) => {\n    const detail = (event as CustomEvent).detail;\n    const { value, index, range } = detail;\n    const { booknotes = [] } = getConfig(bookKey)!;\n    const isNote = value.startsWith(NOTE_PREFIX);\n    const cfi = isNote ? value.replace(NOTE_PREFIX, '') : value;\n    const annotations = booknotes.filter(\n      (booknote) => booknote.type === 'annotation' && !booknote.deletedAt && booknote.cfi === cfi,\n    );\n    const annotation = annotations.find(\n      (annotation) => (!isNote && annotation.style) || (isNote && annotation.note),\n    );\n    if (!annotation) return;\n\n    const { style, color, text, note } = annotation;\n    const selection = {\n      key: bookKey,\n      annotated: true,\n      text: text ?? '',\n      note: note ?? '',\n      rect: isNote ? detail.rect : undefined,\n      cfi,\n      range,\n      index,\n    };\n    if (isNote) {\n      setShowAnnotationNotes(true);\n      setHighlightOptionsVisible(false);\n      setEditingAnnotation(null);\n    } else {\n      setShowAnnotationNotes(false);\n      setAnnotationNotes([]);\n      if (style && color) {\n        setSelectedStyle(style);\n        setSelectedColor(color);\n      }\n      if (style && range) {\n        setEditingAnnotation(annotation);\n      }\n    }\n    setSelection(selection);\n    handleUpToPopup();\n  };\n\n  useFoliateEvents(view, { onLoad, onDrawAnnotation, onShowAnnotation });\n\n  useEffect(() => {\n    handleShowPopup(showingPopup);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [showingPopup]);\n\n  // When popups are visible, update their positions on scroll events\n  useEffect(() => {\n    const view = getView(bookKey);\n    if (!view?.renderer) return;\n    const onScroll = () => {\n      if (showingPopup) {\n        repositionPopups();\n      }\n    };\n    view.renderer.addEventListener('scroll', onScroll);\n    return () => {\n      view.renderer.removeEventListener('scroll', onScroll);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [bookKey, showingPopup, repositionPopups]);\n\n  useEffect(() => {\n    eventDispatcher.on('export-annotations', handleExportMarkdown);\n    return () => {\n      eventDispatcher.off('export-annotations', handleExportMarkdown);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const handleQuickAction = () => {\n    const action = viewSettings.annotationQuickAction;\n    switch (action) {\n      case 'copy':\n        handleCopy(false);\n        handleDismissPopupAndSelection();\n        break;\n      case 'highlight':\n        // highlight is already applied in instant annotating\n        handleDismissPopupAndSelection();\n        break;\n      case 'search':\n        handleSearch();\n        break;\n      case 'dictionary':\n        handleDictionary();\n        break;\n      case 'wikipedia':\n        handleWikipedia();\n        break;\n      case 'translate':\n        handleTranslation();\n        break;\n      case 'tts':\n        handleSpeakText(true);\n        break;\n    }\n  };\n\n  useEffect(() => {\n    setHighlightOptionsVisible(!!(selection && selection.annotated));\n    if (selection && selection.text.trim().length > 0) {\n      const gridFrame = document.querySelector(`#gridcell-${bookKey}`);\n      if (!gridFrame) return;\n      const rect = gridFrame.getBoundingClientRect();\n      const triangPos = getPosition(selection, rect, trianglePadding, viewSettings.vertical);\n      const annotPopupPos = getPopupPosition(\n        triangPos,\n        rect,\n        viewSettings.vertical ? annotPopupHeight : annotPopupWidth,\n        viewSettings.vertical ? annotPopupWidth : annotPopupHeight,\n        popupPadding,\n      );\n      if (annotPopupPos.dir === 'down' && osPlatform === 'android') {\n        triangPos.point.y += androidSelectionHandlerHeight;\n        annotPopupPos.point.y += androidSelectionHandlerHeight;\n      }\n      const dictPopupPos = getPopupPosition(\n        triangPos,\n        rect,\n        dictPopupWidth,\n        dictPopupHeight,\n        popupPadding,\n      );\n      const transPopupPos = getPopupPosition(\n        triangPos,\n        rect,\n        transPopupWidth,\n        transPopupHeight,\n        popupPadding,\n      );\n      const proofreadPopupPos = getPopupPosition(\n        triangPos,\n        rect,\n        proofreadPopupWidth,\n        proofreadPopupHeight,\n        popupPadding,\n      );\n      if (triangPos.point.x == 0 || triangPos.point.y == 0) return;\n      setAnnotPopupPosition(annotPopupPos);\n      setDictPopupPosition(dictPopupPos);\n      setTranslatorPopupPosition(transPopupPos);\n      setProofreadPopupPosition(proofreadPopupPos);\n      setTrianglePosition(triangPos);\n\n      const { enableAnnotationQuickActions, annotationQuickAction } = viewSettings;\n      if (enableAnnotationQuickActions && annotationQuickAction && isTextSelected.current) {\n        handleQuickAction();\n      } else {\n        handleShowAnnotPopup();\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selection, bookKey]);\n\n  useEffect(() => {\n    if (!progress) return;\n    const { location } = progress;\n    const { booknotes = [] } = config;\n    const annotations = booknotes.filter(\n      (item) =>\n        !item.deletedAt &&\n        item.type === 'annotation' &&\n        item.style &&\n        isCfiInLocation(item.cfi, location),\n    );\n    const notes = booknotes.filter(\n      (item) =>\n        !item.deletedAt &&\n        item.type === 'annotation' &&\n        item.note &&\n        item.note.trim().length > 0 &&\n        isCfiInLocation(item.cfi, location),\n    );\n    try {\n      Promise.all(annotations.map((annotation) => view?.addAnnotation(annotation)));\n      Promise.all(\n        notes.map((note) => view?.addAnnotation({ ...note, value: `${NOTE_PREFIX}${note.cfi}` })),\n      );\n    } catch (e) {\n      console.warn(e);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [progress]);\n\n  useEffect(() => {\n    if (!config.booknotes || !selection?.cfi || !showAnnotationNotes) return;\n    const annotations = config.booknotes.filter(\n      (booknote) =>\n        booknote.type === 'annotation' && !booknote.deletedAt && booknote.cfi === selection.cfi,\n    );\n    const notes = annotations.filter((item) => item.note && item.note.trim().length > 0);\n    setAnnotationNotes(notes);\n  }, [selection?.cfi, showAnnotationNotes, config.booknotes]);\n\n  const handleShowAnnotPopup = () => {\n    if (!appService?.isMobile) {\n      containerRef.current?.focus();\n    }\n    setShowAnnotPopup(true);\n    setShowDeepLPopup(false);\n    setShowWiktionaryPopup(false);\n    setShowWikipediaPopup(false);\n  };\n\n  const handleCopy = (dismissPopup = true) => {\n    if (!selection || !selection.text) return;\n    setTimeout(() => {\n      // Delay to ensure it won't be overridden by system clipboard actions\n      navigator.clipboard?.writeText(selection.text);\n    }, 100);\n    if (dismissPopup) {\n      handleDismissPopupAndSelection();\n    }\n\n    if (!viewSettings?.copyToNotebook) return;\n\n    eventDispatcher.dispatch('toast', {\n      type: 'info',\n      message: _('Copied to notebook'),\n      className: 'whitespace-nowrap',\n      timeout: 2000,\n    });\n\n    const { booknotes: annotations = [] } = config;\n    const cfi = view?.getCFI(selection.index, selection.range);\n    if (!cfi) return;\n    const annotation: BookNote = {\n      id: uniqueId(),\n      type: 'excerpt',\n      cfi,\n      text: selection.text,\n      note: '',\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    const existingIndex = annotations.findIndex(\n      (annotation) =>\n        annotation.cfi === cfi && annotation.type === 'excerpt' && !annotation.deletedAt,\n    );\n    if (existingIndex !== -1) {\n      annotations[existingIndex] = annotation;\n    } else {\n      annotations.push(annotation);\n    }\n    const updatedConfig = updateBooknotes(bookKey, annotations);\n    if (updatedConfig) {\n      saveConfig(envConfig, bookKey, updatedConfig, settings);\n    }\n    if (!appService?.isMobile) {\n      setNotebookVisible(true);\n    }\n  };\n\n  const handleHighlight = (update = false, highlightStyle?: HighlightStyle) => {\n    if (!selection || !selection.text) return;\n    setHighlightOptionsVisible(true);\n    const { booknotes: annotations = [] } = config;\n    const cfi = view?.getCFI(selection.index, selection.range);\n    if (!cfi) return;\n    const style = highlightStyle || settings.globalReadSettings.highlightStyle;\n    const color = settings.globalReadSettings.highlightStyles[style];\n    const annotation: BookNote = {\n      id: uniqueId(),\n      type: 'annotation',\n      cfi,\n      style,\n      color,\n      text: selection.text,\n      note: '',\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n    const existingIndex = annotations.findIndex(\n      (annotation) =>\n        annotation.cfi === cfi &&\n        annotation.type === 'annotation' &&\n        annotation.style &&\n        !annotation.deletedAt,\n    );\n    const views = getViewsById(bookKey.split('-')[0]!);\n    if (existingIndex !== -1) {\n      views.forEach((view) => view?.addAnnotation(annotation, true));\n      if (update) {\n        annotation.id = annotations[existingIndex]!.id;\n        annotations[existingIndex] = annotation;\n        views.forEach((view) => view?.addAnnotation(annotation));\n      } else {\n        annotations[existingIndex]!.deletedAt = Date.now();\n        handleDismissPopup();\n      }\n    } else {\n      annotations.push(annotation);\n      views.forEach((view) => view?.addAnnotation(annotation));\n      setSelection({ ...selection, cfi, annotated: true });\n    }\n\n    const updatedConfig = updateBooknotes(bookKey, annotations);\n    if (updatedConfig) {\n      saveConfig(envConfig, bookKey, updatedConfig, settings);\n    }\n  };\n\n  const handleAnnotate = () => {\n    if (!selection || !selection.text) return;\n    const { sectionHref: href } = progress;\n    selection.href = href;\n    handleHighlight(true);\n    setNotebookVisible(true);\n    setNotebookNewAnnotation(selection);\n    handleDismissPopup();\n  };\n\n  const handleSearch = () => {\n    if (!selection || !selection.text) return;\n    handleDismissPopupAndSelection();\n\n    let term = selection.text;\n    const convertChineseVariant = viewSettings.convertChineseVariant;\n    if (convertChineseVariant && convertChineseVariant !== 'none') {\n      term = runSimpleCC(term, convertChineseVariant, true);\n    }\n    eventDispatcher.dispatch('search-term', { term, bookKey });\n  };\n\n  const handleDictionary = () => {\n    if (!selection || !selection.text) return;\n    setShowAnnotPopup(false);\n    setShowWiktionaryPopup(true);\n  };\n\n  const handleWikipedia = () => {\n    if (!selection || !selection.text) return;\n    setShowAnnotPopup(false);\n    setShowWikipediaPopup(true);\n  };\n\n  const handleTranslation = () => {\n    if (!selection || !selection.text) return;\n    setShowAnnotPopup(false);\n    setShowDeepLPopup(true);\n  };\n\n  const handleSpeakText = async (oneTime = false) => {\n    if (!selection || !selection.text) return;\n    setShowAnnotPopup(false);\n    eventDispatcher.dispatch('tts-speak', { bookKey, range: selection.range, oneTime });\n  };\n\n  const handleProofread = () => {\n    if (!selection || !selection.text) return;\n    setShowAnnotPopup(false);\n    setShowProofreadPopup(true);\n\n    if (getWordCount(selection.text) > 30) {\n      eventDispatcher.dispatch('toast', {\n        type: 'warning',\n        message: _('Word limit of 30 words exceeded.'),\n        timeout: 3000,\n      });\n      return;\n    }\n  };\n\n  const handleStartEditAnnotation = useCallback(() => {\n    setShowAnnotPopup(false);\n  }, []);\n\n  // Keyboard shortcuts: trigger actions only if there's an active selection and popup hidden\n  useShortcuts(\n    {\n      onHighlightSelection: () => {\n        handleHighlight(false, 'highlight');\n      },\n      onUnderlineSelection: () => {\n        handleHighlight(false, 'underline');\n      },\n      onAnnotateSelection: () => {\n        handleAnnotate();\n      },\n      onSearchSelection: () => {\n        handleSearch();\n      },\n      onCopySelection: () => {\n        handleCopy(false);\n      },\n      onTranslateSelection: () => {\n        handleTranslation();\n      },\n      onDictionarySelection: () => {\n        handleDictionary();\n      },\n      onWikipediaSelection: () => {\n        handleWikipedia();\n      },\n      onReadAloudSelection: () => {\n        handleSpeakText();\n      },\n      onProofreadSelection: () => {\n        handleProofread();\n      },\n    },\n    [selection?.text],\n  );\n\n  const handleExportMarkdown = async (event: CustomEvent) => {\n    const { bookKey: exportBookKey } = event.detail;\n    if (bookKey !== exportBookKey) return;\n\n    const { bookDoc, book } = bookData;\n    if (!bookDoc || !book || !bookDoc.toc) return;\n\n    const config = getConfig(bookKey)!;\n    const { booknotes: allNotes = [] } = config;\n    const booknotes = allNotes.filter((note) => !note.deletedAt);\n    if (booknotes.length === 0) {\n      eventDispatcher.dispatch('toast', {\n        type: 'info',\n        message: _('No annotations to export'),\n        className: 'whitespace-nowrap',\n        timeout: 2000,\n      });\n      return;\n    }\n\n    // Organize booknotes into groups by chapter\n    const booknoteGroups: { [href: string]: BooknoteGroup } = {};\n    for (const booknote of booknotes) {\n      const tocItem = findTocItemBS(bookDoc.toc ?? [], booknote.cfi);\n      const href = tocItem?.href || '';\n      const label = tocItem?.label || '';\n      const id = tocItem?.id || 0;\n      if (!booknoteGroups[href]) {\n        booknoteGroups[href] = { id, href, label, booknotes: [] };\n      }\n      booknoteGroups[href].booknotes.push(booknote);\n    }\n\n    Object.values(booknoteGroups).forEach((group) => {\n      group.booknotes.sort((a, b) => {\n        return CFI.compare(a.cfi, b.cfi);\n      });\n    });\n\n    setExportData({ booknotes, booknoteGroups });\n    setShowExportDialog(true);\n  };\n\n  const handleConfirmExport = async (markdownContent: string) => {\n    const { book } = bookData;\n    if (!book) return;\n\n    setTimeout(() => {\n      // Delay to ensure it won't be overridden by system clipboard actions\n      navigator.clipboard?.writeText(markdownContent);\n    }, 100);\n\n    const filename = `${makeSafeFilename(book.title)}.md`;\n    const saved = await appService?.saveFile(filename, markdownContent, 'text/markdown');\n    eventDispatcher.dispatch('toast', {\n      type: 'info',\n      message: saved ? _('Exported successfully') : _('Copied to clipboard'),\n      timeout: 2000,\n    });\n\n    setShowExportDialog(false);\n    setExportData(null);\n  };\n\n  const handleCancelExport = () => {\n    setShowExportDialog(false);\n    setExportData(null);\n  };\n\n  const selectionAnnotated = selection?.annotated;\n  const toolButtons = annotationToolButtons.map(({ type, label, Icon }) => {\n    switch (type) {\n      case 'copy':\n        return { tooltipText: _(label), Icon, onClick: handleCopy };\n      case 'highlight':\n        return {\n          tooltipText: selectionAnnotated ? _('Delete Highlight') : _(label),\n          Icon: selectionAnnotated ? RiDeleteBinLine : Icon,\n          onClick: handleHighlight,\n          disabled: bookData.book?.format === 'PDF',\n        };\n      case 'annotate':\n        return {\n          tooltipText: _(label),\n          Icon,\n          onClick: handleAnnotate,\n          disabled: bookData.book?.format === 'PDF',\n        };\n      case 'search':\n        return {\n          tooltipText: _(label),\n          Icon,\n          onClick: handleSearch,\n          disabled: bookData.book?.format === 'PDF',\n        };\n      case 'dictionary':\n        return { tooltipText: _(label), Icon, onClick: handleDictionary };\n      case 'wikipedia':\n        return { tooltipText: _(label), Icon, onClick: handleWikipedia };\n      case 'translate':\n        return { tooltipText: _(label), Icon, onClick: handleTranslation };\n      case 'tts':\n        return {\n          tooltipText: _(label),\n          Icon,\n          onClick: handleSpeakText,\n          disabled: bookData.book?.format === 'PDF',\n        };\n      case 'proofread':\n        return {\n          tooltipText: _(label),\n          Icon,\n          onClick: handleProofread,\n          disabled: bookData.book?.format !== 'EPUB',\n        };\n      default:\n        return { tooltipText: '', Icon, onClick: () => {} };\n    }\n  });\n\n  return (\n    <div ref={containerRef} role='toolbar' tabIndex={-1}>\n      {showWiktionaryPopup && trianglePosition && dictPopupPosition && (\n        <WiktionaryPopup\n          word={selection?.text as string}\n          lang={bookData.bookDoc?.metadata.language as string}\n          position={dictPopupPosition}\n          trianglePosition={trianglePosition}\n          popupWidth={dictPopupWidth}\n          popupHeight={dictPopupHeight}\n          onDismiss={handleDismissPopupAndSelection}\n        />\n      )}\n      {showWikipediaPopup && trianglePosition && dictPopupPosition && (\n        <WikipediaPopup\n          text={selection?.text as string}\n          lang={bookData.bookDoc?.metadata.language as string}\n          position={dictPopupPosition}\n          trianglePosition={trianglePosition}\n          popupWidth={dictPopupWidth}\n          popupHeight={dictPopupHeight}\n          onDismiss={handleDismissPopupAndSelection}\n        />\n      )}\n      {showDeepLPopup && trianglePosition && translatorPopupPosition && (\n        <TranslatorPopup\n          text={selection?.text as string}\n          position={translatorPopupPosition}\n          trianglePosition={trianglePosition}\n          popupWidth={transPopupWidth}\n          popupHeight={transPopupHeight}\n          onDismiss={handleDismissPopupAndSelection}\n        />\n      )}\n      {showAnnotPopup && trianglePosition && annotPopupPosition && (\n        <AnnotationPopup\n          bookKey={bookKey}\n          dir={viewSettings.rtl ? 'rtl' : 'ltr'}\n          isVertical={viewSettings.vertical}\n          buttons={toolButtons}\n          notes={annotationNotes}\n          position={annotPopupPosition}\n          trianglePosition={trianglePosition}\n          highlightOptionsVisible={highlightOptionsVisible}\n          selectedStyle={selectedStyle}\n          selectedColor={selectedColor}\n          popupWidth={annotPopupWidth}\n          popupHeight={annotPopupHeight}\n          onHighlight={handleHighlight}\n          onDismiss={handleDismissPopupAndSelection}\n        />\n      )}\n      {showProofreadPopup && trianglePosition && proofreadPopupPosition && selection && (\n        <ProofreadPopup\n          bookKey={bookKey}\n          selection={selection}\n          position={proofreadPopupPosition}\n          trianglePosition={trianglePosition}\n          popupWidth={proofreadPopupWidth}\n          popupHeight={proofreadPopupHeight}\n          onDismiss={handleDismissPopupAndSelection}\n        />\n      )}\n      {editingAnnotation && editingAnnotation.color && selection && (\n        <AnnotationRangeEditor\n          bookKey={bookKey}\n          isVertical={viewSettings.vertical}\n          annotation={editingAnnotation}\n          selection={selection}\n          handleColor={selectedColor}\n          getAnnotationText={getAnnotationText}\n          setSelection={setSelection}\n          onStartEdit={handleStartEditAnnotation}\n        />\n      )}\n      {showExportDialog && exportData && bookData.book && (\n        <ExportMarkdownDialog\n          bookKey={bookKey}\n          isOpen={showExportDialog}\n          bookTitle={bookData.book.title}\n          bookAuthor={bookData.book.author || ''}\n          booknotes={exportData.booknotes}\n          booknoteGroups={exportData.booknoteGroups}\n          onCancel={handleCancelExport}\n          onExport={handleConfirmExport}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default Annotator;\n"],"names":[],"mappings":"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"}}]
}