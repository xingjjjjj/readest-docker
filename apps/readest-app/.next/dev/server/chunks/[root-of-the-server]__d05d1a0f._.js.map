{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/utils/jwt.ts"],"sourcesContent":["import { jwtVerify, SignJWT } from 'jose';\n\n// 单用户认证配置\n// 为确保中间件与API一致，开发环境使用固定默认密钥\nconst SECRET_KEY = process.env['AUTH_SECRET'] || 'dev-secret';\nconst USER_PASSWORD = process.env['AUTH_PASSWORD'] || 'changeme-' + Math.random().toString(36).substring(2, 15);\nconst USERNAME = 'xingjjjjj';\n\n// 在服务器端启动时打印认证信息\nif (typeof window === 'undefined' && process.env['NODE_ENV'] !== 'production') {\n    console.log('\\n========== READEST AUTHENTICATION (Development) ==========');\n    console.log(`Username: ${USERNAME}`);\n    console.log(`Password: ${USER_PASSWORD}`);\n    console.log(`Secret Key: ${SECRET_KEY}`);\n    console.log('==========================================================\\n');\n}\n\nconst key = new TextEncoder().encode(SECRET_KEY);\n\nexport interface AuthPayload {\n    username: string;\n    iat?: number;\n    exp?: number;\n}\n\n/**\n * 创建 JWT 令牌\n */\nexport async function createJWT(username: string): Promise<string> {\n    const token = await new SignJWT({ username })\n        .setProtectedHeader({ alg: 'HS256' })\n        .setIssuedAt()\n        .setExpirationTime('30d')\n        .sign(key);\n\n    return token;\n}\n\n/**\n * 验证 JWT 令牌\n */\nexport async function verifyJWT(token: string): Promise<AuthPayload | null> {\n    try {\n        const verified = await jwtVerify(token, key);\n        return verified.payload as unknown as AuthPayload;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * 验证用户名和密码\n */\nexport function validateCredentials(username: string, password: string): boolean {\n    return username === USERNAME && password === USER_PASSWORD;\n}\n\n/**\n * 从 Authorization header 中提取令牌\n */\nexport function extractToken(authHeader: string | null): string | null {\n    if (!authHeader) return null;\n\n    const parts = authHeader.split(' ');\n    if (parts.length !== 2 || parts[0] !== 'Bearer') {\n        return null;\n    }\n\n    return parts[1] ?? null;\n}\n\n/**\n * 生成凭证字符串（用于调试）\n */\nexport function getCredentials(): { username: string; password: string; secret: string } {\n    return {\n        username: USERNAME,\n        password: USER_PASSWORD,\n        secret: SECRET_KEY,\n    };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AAAA;;AAEA,UAAU;AACV,4BAA4B;AAC5B,MAAM,aAAa,QAAQ,GAAG,CAAC,cAAc,IAAI;AACjD,MAAM,gBAAgB,QAAQ,GAAG,CAAC,gBAAgB,IAAI,cAAc,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG;AAC5G,MAAM,WAAW;AAEjB,iBAAiB;AACjB,wCAA+E;IAC3E,QAAQ,GAAG,CAAC;IACZ,QAAQ,GAAG,CAAC,CAAC,UAAU,EAAE,UAAU;IACnC,QAAQ,GAAG,CAAC,CAAC,UAAU,EAAE,eAAe;IACxC,QAAQ,GAAG,CAAC,CAAC,YAAY,EAAE,YAAY;IACvC,QAAQ,GAAG,CAAC;AAChB;AAEA,MAAM,MAAM,IAAI,cAAc,MAAM,CAAC;AAW9B,eAAe,UAAU,QAAgB;IAC5C,MAAM,QAAQ,MAAM,IAAI,yNAAO,CAAC;QAAE;IAAS,GACtC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,OAClB,IAAI,CAAC;IAEV,OAAO;AACX;AAKO,eAAe,UAAU,KAAa;IACzC,IAAI;QACA,MAAM,WAAW,MAAM,IAAA,6NAAS,EAAC,OAAO;QACxC,OAAO,SAAS,OAAO;IAC3B,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAKO,SAAS,oBAAoB,QAAgB,EAAE,QAAgB;IAClE,OAAO,aAAa,YAAY,aAAa;AACjD;AAKO,SAAS,aAAa,UAAyB;IAClD,IAAI,CAAC,YAAY,OAAO;IAExB,MAAM,QAAQ,WAAW,KAAK,CAAC;IAC/B,IAAI,MAAM,MAAM,KAAK,KAAK,KAAK,CAAC,EAAE,KAAK,UAAU;QAC7C,OAAO;IACX;IAEA,OAAO,KAAK,CAAC,EAAE,IAAI;AACvB;AAKO,SAAS;IACZ,OAAO;QACH,UAAU;QACV,UAAU;QACV,QAAQ;IACZ;AACJ"}},
    {"offset": {"line": 131, "column": 0}, "map": {"version":3,"sources":["file:///app/readest/apps/readest-app/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createJWT, validateCredentials } from '@/utils/jwt';\n\nexport async function POST(request: NextRequest) {\n    try {\n        const body = await request.json();\n        const { username, password } = body;\n\n        if (!username || !password) {\n            return NextResponse.json(\n                { error: 'Username and password are required' },\n                { status: 400 }\n            );\n        }\n\n        // 验证凭证\n        if (!validateCredentials(username, password)) {\n            return NextResponse.json(\n                { error: 'Invalid username or password' },\n                { status: 401 }\n            );\n        }\n\n        // 生成令牌\n        const token = await createJWT(username);\n\n        const response = NextResponse.json(\n            {\n                success: true,\n                token,\n                user: {\n                    username,\n                    name: 'User',\n                    id: 'xingjjjjj',\n                    email: 'admin@local',\n                },\n            },\n            { status: 200 }\n        );\n\n        // 设置 httpOnly cookie，供中间件校验\n        // HTTP 环境下必须使用 secure: false，否则浏览器会拒绝设置 cookie\n        const isProduction = process.env['NODE_ENV'] === 'production';\n        const protocol = request.headers.get('x-forwarded-proto') ||\n            (request.url.startsWith('https') ? 'https' : 'http');\n\n        response.cookies.set('auth_token', token, {\n            httpOnly: true,\n            secure: protocol === 'https', // 仅在 HTTPS 时启用 secure\n            sameSite: 'lax',\n            path: '/',\n            maxAge: 60 * 60 * 24 * 30, // 30 天\n        });\n\n        return response;\n    } catch (error) {\n        console.error('Login error:', error);\n        return NextResponse.json(\n            { error: 'Internal server error' },\n            { status: 500 }\n        );\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAoB;IAC3C,IAAI;QACA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG;QAE/B,IAAI,CAAC,YAAY,CAAC,UAAU;YACxB,OAAO,kTAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAqC,GAC9C;gBAAE,QAAQ;YAAI;QAEtB;QAEA,OAAO;QACP,IAAI,CAAC,IAAA,sKAAmB,EAAC,UAAU,WAAW;YAC1C,OAAO,kTAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ;YAAI;QAEtB;QAEA,OAAO;QACP,MAAM,QAAQ,MAAM,IAAA,4JAAS,EAAC;QAE9B,MAAM,WAAW,kTAAY,CAAC,IAAI,CAC9B;YACI,SAAS;YACT;YACA,MAAM;gBACF;gBACA,MAAM;gBACN,IAAI;gBACJ,OAAO;YACX;QACJ,GACA;YAAE,QAAQ;QAAI;QAGlB,4BAA4B;QAC5B,+CAA+C;QAC/C,MAAM,eAAe,oDAA4B;QACjD,MAAM,WAAW,QAAQ,OAAO,CAAC,GAAG,CAAC,wBACjC,CAAC,QAAQ,GAAG,CAAC,UAAU,CAAC,WAAW,UAAU,MAAM;QAEvD,SAAS,OAAO,CAAC,GAAG,CAAC,cAAc,OAAO;YACtC,UAAU;YACV,QAAQ,aAAa;YACrB,UAAU;YACV,MAAM;YACN,QAAQ,KAAK,KAAK,KAAK;QAC3B;QAEA,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO,kTAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}