{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/apps/readest-app/src/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { jwtVerify } from 'jose';\n\nconst allowedOrigins = [\n  'https://web.readest.com',\n  'http://localhost:3000',\n  'http://localhost:3001',\n  'https://tauri.localhost',\n  'http://tauri.localhost',\n  'tauri://localhost',\n];\n\n// 在中间件中动态检查 origin，允许所有 192.168.*.* 和 localhost\nconst isOriginAllowed = (origin: string) => {\n  if (!origin) return false;\n  if (allowedOrigins.includes(origin)) return true;\n\n  // 允许局域网 IP\n  if (/^https?:\\/\\/(localhost|127\\.0\\.0\\.1|192\\.168\\.\\d+\\.\\d+|10\\.\\d+\\.\\d+\\.\\d+)(:\\d+)?$/.test(origin)) {\n    return true;\n  }\n\n  // 支持通过环境变量配置额外的允许域名（逗号分隔）\n  const customOrigins = process.env['ALLOWED_ORIGINS'];\n  if (customOrigins) {\n    const customList = customOrigins.split(',').map(o => o.trim());\n    if (customList.includes(origin)) {\n      return true;\n    }\n  }\n\n  return false;\n};\n\nconst corsOptions = {\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': '*',\n  'Access-Control-Max-Age': '86400',\n};\n\nconst isPublicPath = (pathname: string) => {\n  return (\n    pathname.startsWith('/auth') ||\n    pathname.startsWith('/_next') ||\n    pathname.startsWith('/public') ||\n    pathname === '/favicon.ico' ||\n    pathname === '/robots.txt' ||\n    pathname === '/sitemap.xml'\n  );\n};\n\nasync function verifyToken(token: string | undefined) {\n  if (!token) return false;\n  const secret = new TextEncoder().encode(process.env['AUTH_SECRET'] || 'dev-secret');\n  try {\n    await jwtVerify(token, secret);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nexport async function middleware(request: NextRequest) {\n  const origin = request.headers.get('origin') ?? '';\n  const isAllowedOrigin = isOriginAllowed(origin);\n\n  if (request.method === 'OPTIONS') {\n    const preflightHeaders = new Headers({\n      ...corsOptions,\n      ...(isAllowedOrigin && { 'Access-Control-Allow-Origin': origin }),\n    });\n\n    return new NextResponse(null, {\n      status: 200,\n      headers: preflightHeaders,\n    });\n  }\n\n  const { pathname } = request.nextUrl;\n\n  // 认证 API（/api/auth/*）不需要登录检查，直接通过\n  if (pathname.startsWith('/api/auth')) {\n    const response = NextResponse.next();\n    if (isAllowedOrigin) {\n      response.headers.set('Access-Control-Allow-Origin', origin);\n    }\n    Object.entries(corsOptions).forEach(([key, value]) => {\n      response.headers.set(key, value);\n    });\n    return response;\n  }\n\n  // 页面保护（非 public 路径且非 API）\n  if (!pathname.startsWith('/api') && !isPublicPath(pathname)) {\n    const token = request.cookies.get('auth_token')?.value;\n    const valid = await verifyToken(token);\n    if (!valid) {\n      const url = new URL('/auth', request.url);\n      const fullPath = request.nextUrl.pathname + (request.nextUrl.search || '');\n      url.searchParams.set('redirect', fullPath);\n      return NextResponse.redirect(url);\n    }\n  }\n\n  const response = NextResponse.next();\n\n  if (isAllowedOrigin) {\n    response.headers.set('Access-Control-Allow-Origin', origin);\n  }\n\n  Object.entries(corsOptions).forEach(([key, value]) => {\n    response.headers.set(key, value);\n  });\n\n  return response;\n}\n\nexport const config = {\n  // 保护所有页面路由；API 另匹配\n  matcher: [\n    // 排除所有 API 路由、public 路由、_next、auth 等\n    '/((?!_next|public|auth|api|favicon.ico|robots.txt|sitemap.xml).*)',\n    '/api/:path*',\n  ],\n};\n"],"names":[],"mappings":"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"}}]
}