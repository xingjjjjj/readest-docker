(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,684658,e=>{"use strict";let t,i=(e,t)=>[-1,...t,e.length].reduce(({xs:t,a:i},a)=>({xs:t?.concat([e.slice(i+1,a)])??[],a:a}),{}).xs,a=/\d/,r=/^epubcfi\((.*)\)$/,s=e=>e.replace(/[\^[\](),;=]/g,"^$&"),n=e=>r.test(e)?e:`epubcfi(${e})`,o=(t=(...e)=>e.join("!"),(...e)=>`epubcfi(${t(...e.map(e=>e.match(r)?.[1]??e))})`),l=(e,t)=>{let i;return i=([e])=>e===t,e.map((e,t,a)=>i(e,t,a)?t:null).filter(e=>null!=e)},c=e=>{let t,i=[];for(let[a,r]of e){if("/"===a)i.push({index:r});else{let e=i[i.length-1];if(":"===a)e.offset=r;else if("~"===a)e.temporal=r;else if("@"===a)e.spatial=(e.spatial??[]).concat(r);else if(";s"===a)e.side=r;else if("["===a)if("/"===t&&r)e.id=r;else{e.text=(e.text??[]).concat(r);continue}}t=a}return i},h=e=>i(e,l(e,"!")).map(c),f=e=>{let t=(e=>{let t=[],i,r,s="",n=e=>(t.push(e),i=null,s=""),o=e=>(s+=e,r=!1);for(let t of Array.from(e.trim()).concat("")){if("^"===t&&!r){r=!0;continue}if("!"===i)n(["!"]);else if(","===i)n([","]);else if("/"===i||":"===i)if(a.test(t)){o(t);continue}else n([i,parseInt(s)]);else if("~"===i)if(a.test(t)||"."===t){o(t);continue}else n(["~",parseFloat(s)]);else if("@"===i){if(":"===t){n(["@",parseFloat(s)]),i="@";continue}if(a.test(t)||"."===t){o(t);continue}n(["@",parseFloat(s)])}else if("["===i){";"!==t||r?","!==t||r?"]"!==t||r?o(t):n(["[",s]):(n(["[",s]),i="["):(n(["[",s]),i=";");continue}else if(i?.startsWith(";")){"="!==t||r?";"!==t||r?"]"!==t||r?o(t):n([i,s]):(n([i,s]),i=";"):(i=`;${s}`,s="");continue}("/"===t||":"===t||"~"===t||"@"===t||"["===t||"!"===t||","===t)&&(i=t)}return t})(e.match(r)?.[1]??e),s=l(t,",");if(!s.length)return h(t);let[n,o,c]=i(t,s).map(h);return{parent:n,start:o,end:c}},p=({index:e,id:t,offset:i,temporal:a,spatial:r,text:n,side:o})=>{let l=o?`;s=${o}`:"";return`/${e}`+(t?`[${s(t)}${l}]`:"")+(null!=i&&e%2?`:${i}`:"")+(a?`~${a}`:"")+(r?`@${r.join(":")}`:"")+(n||!t&&o?"["+(n?.map(s)?.join(",")??"")+l+"]":"")},d=e=>e.parent?[e.parent,e.start,e.end].map(d).join(","):e.map(e=>e.map(p).join("")).join("!"),u=e=>n(d(e)),w=(e,t)=>{let i,a;return"string"==typeof e?u(w(f(e),t)):e.parent?(i=e.parent,a=e[t?"end":"start"],i.slice(0,-1).concat([i[i.length-1].concat(a[0])]).concat(a.slice(1))):e},m=(e,t)=>{"string"==typeof e&&(e=f(e)),"string"==typeof t&&(t=f(t)),e=w(e),t=w(t,!0);let i=e[e.length-1],a=t[t.length-1],r=[],s=[],n=[],o=!0,l=Math.max(i.length,a.length);for(let e=0;e<l;e++){let t=i[e],l=a[e];(o&&=t?.index===l?.index&&!t?.offset&&!l?.offset)?r.push(t):(t&&s.push(t),l&&n.push(l))}return u({parent:e.slice(0,-1).concat([r]),start:[s],end:[n]})},g=(e,t)=>{if("string"==typeof e&&(e=f(e)),"string"==typeof t&&(t=f(t)),e.start||t.start)return g(w(e),w(t))||g(w(e,!0),w(t,!0));for(let i=0;i<Math.max(e.length,t.length);i++){let a=e[i]??[],r=t[i]??[],s=Math.max(a.length,r.length)-1;for(let e=0;e<=s;e++){let t=a[e],i=r[e];if(!t)return -1;if(!i||t.index>i.index)return 1;if(t.index<i.index)return -1;if(e===s){if(t.offset>i.offset)return 1;if(t.offset<i.offset)return -1}}}return 0},y=({nodeType:e})=>3===e||4===e,D=(e,t)=>{let i=Array.from(e.childNodes).filter(e=>y(e)||(({nodeType:e})=>1===e)(e));return t?i.map(e=>{let i=t(e);return i===NodeFilter.FILTER_REJECT?null:i===NodeFilter.FILTER_SKIP?D(e,t):e}).flat().filter(e=>e):i},A=(e,t)=>{let i=D(e,t).reduce((e,t)=>{let i=e[e.length-1];return i?y(t)?Array.isArray(i)?i.push(t):y(i)?e[e.length-1]=[i,t]:e.push(t):(({nodeType:e})=>1===e)(i)?e.push(null,t):e.push(t):e.push(t),e},[]);return(({nodeType:e})=>1===e)(i[0])&&i.unshift("first"),(({nodeType:e})=>1===e)(i[i.length-1])&&i.push("last"),i.unshift("before"),i.push("after"),i},v=(e,t,i)=>{let{id:a}=t[t.length-1];if(a){let t=e.ownerDocument.getElementById(a);if(t)return{node:t,offset:0}}for(let{index:a}of t){let t=e?A(e,i)[a]:null;if("first"===t)return{node:e.firstChild??e};if("last"===t)return{node:e.lastChild??e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}let{offset:r}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:r};let s=0;for(let t of e){let{length:e}=t.nodeValue;if(s+e>=r)return{node:t,offset:r-s};s+=e}},P=(e,t,i)=>{let{parentNode:a,id:r}=e,s=A(a,i),n=s.findIndex(t=>Array.isArray(t)?t.some(t=>t===e):t===e),o=s[n];if(Array.isArray(o)){let i=0;for(let a of o)if(a===e){i+=t;break}else i+=a.nodeValue.length;t=i}let l={id:r,index:n,offset:t};return(a!==e.ownerDocument.documentElement?P(a,null,i).concat(l):[l]).filter(e=>-1!==e.index)},b={fromIndex:e=>n(`/6/${(e+1)*2}`),toIndex:e=>e?.at(-1).index/2-1};e.s(["collapse",0,w,"compare",0,g,"fake",0,b,"fromCalibreHighlight",0,({spine_index:e,start_cfi:t,end_cfi:i})=>{let a=b.fromIndex(e)+"!";return m(a+t.slice(2),a+i.slice(2))},"fromCalibrePos",0,e=>{let[t]=f(e),i=t.shift();return t.shift(),u([[{index:6},i],t])},"fromElements",0,e=>{let t=[],{parentNode:i}=e[0],a=P(i);for(let[r,s]of A(i).entries()){let i=e[t.length];s===i&&t.push(u([a.concat({id:i.id,index:r})]))}return t},"fromRange",0,(e,t)=>{let{startContainer:i,startOffset:a,endContainer:r,endOffset:s}=e,n=P(i,a,t);return e.collapsed?u([n]):m([n],[P(r,s,t)])},"isCFI",0,r,"joinIndir",0,o,"parse",0,f,"toElement",0,(e,t)=>v(e.documentElement,w(t)).node,"toRange",0,(e,t,i)=>{let a=w(t),r=w(t,!0),s=e.documentElement,n=v(s,a[0],i),o=v(s,r[0],i),l=e.createRange();return n.before?l.setStartBefore(n.node):n.after?l.setStartAfter(n.node):l.setStart(n.node,n.offset),o.before?l.setEndBefore(o.node):o.after?l.setEndAfter(o.node):l.setEnd(o.node,o.offset),l}])},349114,e=>{"use strict";function t(){return window.__TAURI_OS_PLUGIN_INTERNALS__.os_type}function i(){return window.__TAURI_OS_PLUGIN_INTERNALS__.arch}e.i(194934),e.s(["arch",()=>i,"type",()=>t])},542436,e=>{"use strict";var t=e.i(119322),i=e.i(465454),a=e.i(308795),r=e.i(194934);async function s(e={}){return"object"==typeof e&&Object.freeze(e),await (0,r.invoke)("plugin:dialog|open",{options:e})}async function n(e={}){return"object"==typeof e&&Object.freeze(e),await (0,r.invoke)("plugin:dialog|save",{options:e})}var o=e.i(349114);async function l(e,t){await (0,r.invoke)("plugin:sharekit|share_file",{url:e,...t})}var c=e.i(431187),h=e.i(528934),f=e.i(883228),p=e.i(316217);let d=async(e,t,i)=>{let a=[];try{a=await e.readDirectory(t,"None")}catch{throw Error(`Dir ${t} failed to read.`)}for(let r=0;r<a.length;r++){let s=a[r],n=`${t}/${s.path}`,o=`${i}/${s.path}`;await e.copyFile(n,o,"None")}let r=await e.readDirectory(i,"None");for(let e of a)if(!r.find(t=>t.path===e.path&&t.size===e.size))throw Error(`File ${e.path} failed to copy.`)};var u=e.i(19347),w=e.i(481959);let m=null,g=()=>(null===m&&(m=(0,o.type)()),m),y=({customRootDir:e,isPortable:t,execDir:i}={})=>{let r=e?0:void 0,s=!!e,n=s?t=>()=>{let i=["Settings","Data","Books","Fonts","Images"].includes(t)?"":t;return i?`${e}/${i}`:e}:void 0,o=n?e=>async()=>n(e)():void 0;return(e,l)=>{let c=n?.(l),h=o?.(l);switch(l){case"Settings":return{baseDir:t?0:a.BaseDirectory.AppConfig,basePrefix:t&&i?async()=>i:a.appConfigDir,fp:t&&i?`${i}${e?`/${e}`:""}`:e,base:l};case"Cache":return{baseDir:a.BaseDirectory.AppCache,basePrefix:a.appCacheDir,fp:e,base:l};case"Log":return{baseDir:s?0:a.BaseDirectory.AppLog,basePrefix:h??a.appLogDir,fp:c?`${c()}${e?`/${e}`:""}`:e,base:l};case"Data":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h??a.appDataDir,fp:c?`${c()}/${w.DATA_SUBDIR}${e?`/${e}`:""}`:`${w.DATA_SUBDIR}${e?`/${e}`:""}`,base:l};case"Books":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h||a.appDataDir,fp:c?`${c()}/${w.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`:`${w.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Fonts":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h||a.appDataDir,fp:c?`${c()}/${w.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`:`${w.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Images":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h||a.appDataDir,fp:c?`${c()}/${w.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`:`${w.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`,base:l};case"None":return{baseDir:0,basePrefix:async()=>"",fp:e,base:l};default:return{baseDir:a.BaseDirectory.Temp,basePrefix:a.tempDir,fp:e,base:l}}}},D={resolvePath:y(),async getPrefix(e){let{basePrefix:t,fp:i,baseDir:r}=this.resolvePath("",e),s=await t();return s=s.replace(/\/+$/,""),i?0===r?i:await (0,a.join)(s,i):s},getURL:e=>(0,c.isValidURL)(e)?e:(0,r.convertFileSrc)(e),async getBlobURL(e,t){let i=await this.readFile(e,t,"binary");return URL.createObjectURL(new Blob([i]))},async getImageURL(e){return this.getURL(e)},async openFile(e,t,i){let{fp:r,baseDir:s}=this.resolvePath(e,t),n=i||(0,h.getFilename)(r);if((0,c.isValidURL)(e))return await new f.RemoteFile(e,n).open();if((0,c.isContentURI)(e)||(0,c.isFileURI)(e)&&"ios"===g()){if(n=await (0,a.basename)(e),e.includes("com.android.externalstorage"))return await new f.NativeFile(r,n,s||null).open();{let t=await this.getPrefix("Cache"),i=await (0,a.join)(t,decodeURIComponent(n)),r=await (0,p.copyURIToPath)({uri:e,dst:i});if(!r.success)throw console.error("Failed to open file:",r),Error("Failed to open file");return await new f.NativeFile(i,n,s||null).open()}}{if((0,c.isFileURI)(e)||"android"===g())return await new f.NativeFile(r,n,s||null).open();let i=await this.getPrefix(t),o=i?await (0,a.join)(i,e):e;return await new f.RemoteFile(this.getURL(o),n).open()}},async copyFile(e,t,r){try{await this.exists((0,h.getDirPath)(t),r)||await this.createDir((0,h.getDirPath)(t),r,!0)}catch(e){console.log("Failed to create directory for copying file:",e)}if((0,c.isContentURI)(e)){let i=await this.getPrefix(r);if(!i)throw Error("Invalid base directory");let s=await (0,p.copyURIToPath)({uri:e,dst:await (0,a.join)(i,t)});if(!s.success)throw console.error("Failed to copy file:",s),Error("Failed to copy file")}else{let{fp:a,baseDir:s}=this.resolvePath(t,r);await (0,i.copyFile)(e,a,s?{toPathBaseDir:s}:void 0)}},async readFile(e,t,a){let{fp:r,baseDir:s}=this.resolvePath(e,t);return"text"===a?(0,i.readTextFile)(r,s?{baseDir:s}:void 0):(await (0,i.readFile)(r,s?{baseDir:s}:void 0)).buffer},async writeFile(e,t,a){let{fp:r,baseDir:s}=this.resolvePath(e,t);return(await this.exists((0,h.getDirPath)(e),t)||await this.createDir((0,h.getDirPath)(e),t,!0),"string"==typeof a)?(0,i.writeTextFile)(r,a,s?{baseDir:s}:void 0):a instanceof File?await (0,i.writeFile)(r,a.stream(),{write:!0,create:!0,baseDir:s||void 0}):await (0,i.writeFile)(r,new Uint8Array(a),s?{baseDir:s}:void 0)},async removeFile(e,t){let{fp:a,baseDir:r}=this.resolvePath(e,t);await (0,i.remove)(a,r?{baseDir:r}:void 0)},async createDir(e,t,a=!1){let{fp:r,baseDir:s}=this.resolvePath(e,t);await (0,i.mkdir)(r,{baseDir:s||void 0,recursive:a})},async removeDir(e,t,a=!1){let{fp:r,baseDir:s}=this.resolvePath(e,t);await (0,i.remove)(r,{baseDir:s||void 0,recursive:a})},async readDir(e,t){let{fp:s,baseDir:n}=this.resolvePath(e,t);if(!n||0===n)try{return(await (0,r.invoke)("read_dir",{path:s,recursive:!0,extensions:["*"]})).map(e=>{var t;let i;return{path:(t=e.path,i=t,t.toLowerCase().startsWith(s.toLowerCase())&&(i=t.substring(s.length)),(i.startsWith("\\")||i.startsWith("/"))&&(i=i.substring(1)),i),size:e.size}})}catch(e){console.error("Rust read_dir failed, falling back to JS recursion",e)}let o=await (0,i.readDir)(s,n?{baseDir:n}:void 0),l=[],c=async(e,t,r,s)=>{for(let o of r)if(o.isDirectory){let r=await (0,a.join)(e,o.name),l=t?await (0,a.join)(t,o.name):o.name;try{let e=await (0,i.readDir)(r,n?{baseDir:n}:void 0);await c(r,l,e,s)}catch{console.warn(`Skipping unreadable dir: ${r}`)}}else{let r=await (0,a.join)(e,o.name),l=t?await (0,a.join)(t,o.name):o.name,c=n?{baseDir:n}:void 0,h=await (0,i.stat)(r,c).then(e=>e.size).catch(()=>0);s.push({path:l,size:h})}};return await c(s,"",o,l),l},async exists(e,t){let{fp:a,baseDir:r}=this.resolvePath(e,t);try{return await (0,i.exists)(a,r?{baseDir:r}:void 0)}catch{return!1}},async stats(e,t){let{fp:a,baseDir:r}=this.resolvePath(e,t);return await (0,i.stat)(a,r?{baseDir:r}:void 0)}},A=t.default.env.NEXT_PUBLIC_DIST_CHANNEL||"readest";class v extends u.BaseAppService{fs=D;appPlatform="tauri";isAppDataSandbox=!1;isMobile=!1;isAndroidApp=!1;isIOSApp=!1;isMacOSApp=!1;isLinuxApp=!1;isMobileApp=!1;isDesktopApp=!1;isEink=!!window.__READEST_IS_EINK;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir="appstore"!==A;canReadExternalDir="appstore"!==A&&"playstore"!==A;distChannel=A;execDir=void 0;async init(){if(!window.__TAURI__)throw Error("NativeAppService can only be initialized in Tauri environment");let e=g();this.isAppDataSandbox=["android","ios"].includes(e),this.isMobile=["android","ios"].includes(e),this.isAndroidApp="android"===e,this.isIOSApp="ios"===e,this.isMacOSApp="macos"===e,this.isLinuxApp="linux"===e,this.isMobileApp=["android","ios"].includes(e),this.isDesktopApp=["macos","windows","linux"].includes(e),this.hasTrafficLight="macos"===e,this.hasWindow="ios"!==e&&"android"!==e,this.hasWindowBar="ios"!==e&&"android"!==e,this.hasContextMenu="ios"!==e&&"android"!==e,this.hasRoundedWindow="linux"===e,this.hasSafeAreaInset="ios"===e||"android"===e,this.hasHaptics="ios"===e||"android"===e,this.hasUpdater="ios"!==e&&!t.default.env.NEXT_PUBLIC_DISABLE_UPDATER&&!window.__READEST_UPDATER_DISABLED,this.hasOrientationLock="ios"===e&&"ios"===(0,c.getOSPlatform)()||"android"===e,this.hasScreenBrightness="ios"===e||"android"===e,this.hasIAP="ios"===e||"android"===e&&"playstore"===A;let i=await (0,r.invoke)("get_executable_dir");this.execDir=i,(t.default.env.NEXT_PUBLIC_PORTABLE_APP||await this.fs.exists(`${i}/${w.SETTINGS_FILENAME}`,"None"))&&(this.isPortableApp=!0,this.fs.resolvePath=y({customRootDir:i,isPortable:this.isPortableApp,execDir:i}));let a=await this.loadSettings();a.customRootDir&&(this.fs.resolvePath=y({customRootDir:a.customRootDir,isPortable:this.isPortableApp,execDir:i})),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let e=await this.loadSettings(),t=e.migrationVersion||0;if(await super.runMigrations(t),t<0x1350195)try{await this.migrate20251029()}catch(e){console.error("Error migrating to version 20251029:",e)}t<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...e,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(e){console.error("Failed to run migrations:",e)}}resolvePath(e,t){return this.fs.resolvePath(e,t)}async setCustomRootDir(e){this.fs.resolvePath=y({customRootDir:e,isPortable:this.isPortableApp,execDir:this.execDir}),await this.prepareBooksDir()}async selectDirectory(){return await s({directory:!0,multiple:!1,recursive:!0})}async selectFiles(e,t){let i=await s({multiple:!0,filters:[{name:e,extensions:t}]});return Array.isArray(i)?i:i?[i]:[]}async saveFile(e,t,a,r){try{let s=e.split(".").pop()||"";if(this.isIOSApp)await l(a,{mimeType:r||"application/octet-stream"});else{let a=await n({defaultPath:e,filters:[{name:s.toUpperCase(),extensions:[s]}]});if(!a)return!1;"string"==typeof t?await (0,i.writeTextFile)(a,t):await (0,i.writeFile)(a,new Uint8Array(t))}return!0}catch(e){return console.error("Failed to save file:",e),!1}}async migrate20251029(){console.log("Running migration 20251029 to update paths in Images dir...");let e=await this.resolveFilePath("..","Data"),t=await this.fs.getPrefix("Images"),i=await (0,a.join)(e,"Images","Readest","Images");await d(this,i,t);let r=await (0,a.join)(e,"Images","Readest");await this.deleteDir(r,"None",!0)}}e.s(["NativeAppService",()=>v,"nativeFileSystem",0,D],542436)},367859,e=>{e.v(t=>Promise.all(["static/chunks/9adae417cfca96c8.js"].map(t=>e.l(t))).then(()=>t(153654)))},277226,e=>{e.v(t=>Promise.all(["static/chunks/096039d244e363cc.js"].map(t=>e.l(t))).then(()=>t(18337)))},858577,e=>{e.v(t=>Promise.all(["static/chunks/c3789c62da092ab3.js"].map(t=>e.l(t))).then(()=>t(343776)))},723039,e=>{e.v(t=>Promise.all(["static/chunks/d35e704bc36da78b.js"].map(t=>e.l(t))).then(()=>t(626030)))},573601,e=>{e.v(t=>Promise.all(["static/chunks/6c70c68d9ed6a1e3.js","static/chunks/69ed564344afa31e.js"].map(t=>e.l(t))).then(()=>t(914447)))},996714,e=>{e.v(t=>Promise.all(["static/chunks/a1f2c41ac4ac6382.js"].map(t=>e.l(t))).then(()=>t(92833)))},237758,e=>{e.v(t=>Promise.all(["static/chunks/b6b3249f38909eab.js"].map(t=>e.l(t))).then(()=>t(918531)))}]);