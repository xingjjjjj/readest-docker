(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,27357,e=>{"use strict";let t=new Set(["PDF","CBZ"]);e.s(["FIXED_LAYOUT_FORMATS",0,t])},897755,e=>{"use strict";function t(){return window.__TAURI_OS_PLUGIN_INTERNALS__.os_type}function i(){return window.__TAURI_OS_PLUGIN_INTERNALS__.arch}e.i(871611),e.s(["arch",()=>i,"type",()=>t])},399458,e=>{"use strict";let t,i=(e,t)=>[-1,...t,e.length].reduce(({xs:t,a:i},r)=>({xs:t?.concat([e.slice(i+1,r)])??[],a:r}),{}).xs,r=/\d/,a=/^epubcfi\((.*)\)$/,s=e=>e.replace(/[\^[\](),;=]/g,"^$&"),n=e=>a.test(e)?e:`epubcfi(${e})`,o=(t=(...e)=>e.join("!"),(...e)=>`epubcfi(${t(...e.map(e=>e.match(a)?.[1]??e))})`),l=(e,t)=>{let i;return i=([e])=>e===t,e.map((e,t,r)=>i(e,t,r)?t:null).filter(e=>null!=e)},c=e=>{let t,i=[];for(let[r,a]of e){if("/"===r)i.push({index:a});else{let e=i[i.length-1];if(":"===r)e.offset=a;else if("~"===r)e.temporal=a;else if("@"===r)e.spatial=(e.spatial??[]).concat(a);else if(";s"===r)e.side=a;else if("["===r)if("/"===t&&a)e.id=a;else{e.text=(e.text??[]).concat(a);continue}}t=r}return i},f=e=>i(e,l(e,"!")).map(c),p=e=>{let t=(e=>{let t=[],i,a,s="",n=e=>(t.push(e),i=null,s=""),o=e=>(s+=e,a=!1);for(let t of Array.from(e.trim()).concat("")){if("^"===t&&!a){a=!0;continue}if("!"===i)n(["!"]);else if(","===i)n([","]);else if("/"===i||":"===i)if(r.test(t)){o(t);continue}else n([i,parseInt(s)]);else if("~"===i)if(r.test(t)||"."===t){o(t);continue}else n(["~",parseFloat(s)]);else if("@"===i){if(":"===t){n(["@",parseFloat(s)]),i="@";continue}if(r.test(t)||"."===t){o(t);continue}n(["@",parseFloat(s)])}else if("["===i){";"!==t||a?","!==t||a?"]"!==t||a?o(t):n(["[",s]):(n(["[",s]),i="["):(n(["[",s]),i=";");continue}else if(i?.startsWith(";")){"="!==t||a?";"!==t||a?"]"!==t||a?o(t):n([i,s]):(n([i,s]),i=";"):(i=`;${s}`,s="");continue}("/"===t||":"===t||"~"===t||"@"===t||"["===t||"!"===t||","===t)&&(i=t)}return t})(e.match(a)?.[1]??e),s=l(t,",");if(!s.length)return f(t);let[n,o,c]=i(t,s).map(f);return{parent:n,start:o,end:c}},h=({index:e,id:t,offset:i,temporal:r,spatial:a,text:n,side:o})=>{let l=o?`;s=${o}`:"";return`/${e}`+(t?`[${s(t)}${l}]`:"")+(null!=i&&e%2?`:${i}`:"")+(r?`~${r}`:"")+(a?`@${a.join(":")}`:"")+(n||!t&&o?"["+(n?.map(s)?.join(",")??"")+l+"]":"")},u=e=>e.parent?[e.parent,e.start,e.end].map(u).join(","):e.map(e=>e.map(h).join("")).join("!"),d=e=>n(u(e)),m=(e,t)=>{let i,r;return"string"==typeof e?d(m(p(e),t)):e.parent?(i=e.parent,r=e[t?"end":"start"],i.slice(0,-1).concat([i[i.length-1].concat(r[0])]).concat(r.slice(1))):e},g=(e,t)=>{"string"==typeof e&&(e=p(e)),"string"==typeof t&&(t=p(t)),e=m(e),t=m(t,!0);let i=e[e.length-1],r=t[t.length-1],a=[],s=[],n=[],o=!0,l=Math.max(i.length,r.length);for(let e=0;e<l;e++){let t=i[e],l=r[e];(o&&=t?.index===l?.index&&!t?.offset&&!l?.offset)?a.push(t):(t&&s.push(t),l&&n.push(l))}return d({parent:e.slice(0,-1).concat([a]),start:[s],end:[n]})},w=(e,t)=>{if("string"==typeof e&&(e=p(e)),"string"==typeof t&&(t=p(t)),e.start||t.start)return w(m(e),m(t))||w(m(e,!0),m(t,!0));for(let i=0;i<Math.max(e.length,t.length);i++){let r=e[i]??[],a=t[i]??[],s=Math.max(r.length,a.length)-1;for(let e=0;e<=s;e++){let t=r[e],i=a[e];if(!t)return -1;if(!i||t.index>i.index)return 1;if(t.index<i.index)return -1;if(e===s){if(t.offset>i.offset)return 1;if(t.offset<i.offset)return -1}}}return 0},y=({nodeType:e})=>3===e||4===e,b=(e,t)=>{let i=Array.from(e.childNodes).filter(e=>y(e)||(({nodeType:e})=>1===e)(e));return t?i.map(e=>{let i=t(e);return i===NodeFilter.FILTER_REJECT?null:i===NodeFilter.FILTER_SKIP?b(e,t):e}).flat().filter(e=>e):i},D=(e,t)=>{let i=b(e,t).reduce((e,t)=>{let i=e[e.length-1];return i?y(t)?Array.isArray(i)?i.push(t):y(i)?e[e.length-1]=[i,t]:e.push(t):(({nodeType:e})=>1===e)(i)?e.push(null,t):e.push(t):e.push(t),e},[]);return(({nodeType:e})=>1===e)(i[0])&&i.unshift("first"),(({nodeType:e})=>1===e)(i[i.length-1])&&i.push("last"),i.unshift("before"),i.push("after"),i},v=(e,t,i)=>{let{id:r}=t[t.length-1];if(r){let t=e.ownerDocument.getElementById(r);if(t)return{node:t,offset:0}}for(let{index:r}of t){let t=e?D(e,i)[r]:null;if("first"===t)return{node:e.firstChild??e};if("last"===t)return{node:e.lastChild??e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}let{offset:a}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:a};let s=0;for(let t of e){let{length:e}=t.nodeValue;if(s+e>=a)return{node:t,offset:a-s};s+=e}},A=(e,t,i)=>{let{parentNode:r,id:a}=e,s=D(r,i),n=s.findIndex(t=>Array.isArray(t)?t.some(t=>t===e):t===e),o=s[n];if(Array.isArray(o)){let i=0;for(let r of o)if(r===e){i+=t;break}else i+=r.nodeValue.length;t=i}let l={id:a,index:n,offset:t};return(r!==e.ownerDocument.documentElement?A(r,null,i).concat(l):[l]).filter(e=>-1!==e.index)},P={fromIndex:e=>n(`/6/${(e+1)*2}`),toIndex:e=>e?.at(-1).index/2-1};e.s(["collapse",0,m,"compare",0,w,"fake",0,P,"fromCalibreHighlight",0,({spine_index:e,start_cfi:t,end_cfi:i})=>{let r=P.fromIndex(e)+"!";return g(r+t.slice(2),r+i.slice(2))},"fromCalibrePos",0,e=>{let[t]=p(e),i=t.shift();return t.shift(),d([[{index:6},i],t])},"fromElements",0,e=>{let t=[],{parentNode:i}=e[0],r=A(i);for(let[a,s]of D(i).entries()){let i=e[t.length];s===i&&t.push(d([r.concat({id:i.id,index:a})]))}return t},"fromRange",0,(e,t)=>{let{startContainer:i,startOffset:r,endContainer:a,endOffset:s}=e,n=A(i,r,t);return e.collapsed?d([n]):g([n],[A(a,s,t)])},"isCFI",0,a,"joinIndir",0,o,"parse",0,p,"toElement",0,(e,t)=>v(e.documentElement,m(t)).node,"toRange",0,(e,t,i)=>{let r=m(t),a=m(t,!0),s=e.documentElement,n=v(s,r[0],i),o=v(s,a[0],i),l=e.createRange();return n.before?l.setStartBefore(n.node):n.after?l.setStartAfter(n.node):l.setStart(n.node,n.offset),o.before?l.setEndBefore(o.node):o.after?l.setEndAfter(o.node):l.setEnd(o.node,o.offset),l}])},955066,835106,e=>{"use strict";var t=e.i(399458);let i={EPUB:"epub",PDF:"pdf",MOBI:"mobi",AZW:"azw",AZW3:"azw3",CBZ:"cbz",FB2:"fb2",FBZ:"fbz",TXT:"txt",MD:"md"},r={EPUB:["application/epub+zip"],PDF:["application/pdf"],MOBI:["application/x-mobipocket-ebook"],AZW:["application/vnd.amazon.ebook"],AZW3:["application/vnd.amazon.mobi8-ebook","application/x-mobi8-ebook"],CBZ:["application/vnd.comicbook+zip","application/zip","application/x-cbz"],FB2:["application/x-fictionbook+xml","text/xml","application/xml"],FBZ:["application/x-zip-compressed-fb2","application/zip"],TXT:["text/plain"],MD:["text/markdown","text/x-markdown"]};class a{file;constructor(e){this.file=e}async isZip(){let e=new Uint8Array(await this.file.slice(0,4).arrayBuffer());return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}async isPDF(){let e=new Uint8Array(await this.file.slice(0,5).arrayBuffer());return 37===e[0]&&80===e[1]&&68===e[2]&&70===e[3]&&45===e[4]}async makeZipLoader(){let t=async()=>{let e=Math.min(65536,this.file.size),t=new Uint8Array(await this.file.slice(this.file.size-e,this.file.size).arrayBuffer());for(let e=t.length-22;e>=0;e--)if(80===t[e]&&75===t[e+1]&&5===t[e+2]&&6===t[e+3]){let i=t[e+20]+(t[e+21]<<8),r=e+22,a=t.slice(r,r+i);return new TextDecoder().decode(a)}return null},{configure:i,ZipReader:r,BlobReader:a,TextWriter:s,BlobWriter:n}=await e.A(187722);i({useWebWorkers:!1});let o=new r(new a(this.file)),l=await o.getEntries(),c=new Map(l.map(e=>[e.filename,e])),f=e=>(t,...i)=>c.has(t)?e(c.get(t),...i):null,p=f(e=>e.getData?e.getData(new s):null);return{entries:l,loadText:p,loadBlob:f((e,t)=>e.getData?e.getData(new n(t)):null),getSize:e=>c.get(e)?.uncompressedSize??0,getComment:t,sha1:void 0}}isCBZ(){return"application/vnd.comicbook+zip"===this.file.type||this.file.name.endsWith(`.${i.CBZ}`)}isFB2(){return"application/x-fictionbook+xml"===this.file.type||this.file.name.endsWith(`.${i.FB2}`)}isFBZ(){return"application/x-zip-compressed-fb2"===this.file.type||this.file.name.endsWith(".fb.zip")||this.file.name.endsWith(".fb2.zip")||this.file.name.endsWith(`.${i.FBZ}`)}async open(){let t=null,r="EPUB";if(!this.file.size)throw Error("File is empty");try{if(await this.isZip()){let a=await this.makeZipLoader(),{entries:s}=a;if(this.isCBZ()){let{makeComicBook:i}=await e.A(664253);t=await i(a,this.file),r="CBZ"}else if(this.isFBZ()){let n=s.find(e=>e.filename.endsWith(`.${i.FB2}`)),o=await a.loadBlob((n??s[0]).filename),{makeFB2:l}=await e.A(119421);t=await l(o),r="FBZ"}else{let{EPUB:i}=await e.A(620701);t=await new i(a).init(),r="EPUB"}}else if(await this.isPDF()){let{makePDF:i}=await e.A(511607);t=await i(this.file),r="PDF"}else if(await (await e.A(722516)).isMOBI(this.file)){let i=await e.A(89544),{MOBI:a}=await e.A(722516);switch(t=await new a({unzlib:i.unzlibSync}).open(this.file),this.file.name.split(".").pop()?.toLowerCase()){case"azw":r="AZW";break;case"azw3":r="AZW3";break;default:r="MOBI"}}else if(this.isFB2()){let{makeFB2:i}=await e.A(119421);t=await i(this.file),r="FB2"}}catch(e){if(console.error("Failed to open document:",e),e instanceof Error&&e.message?.includes("not a valid zip"))throw Error("Unsupported or corrupted book file");throw e}return{book:t,format:r}}}e.s(["CFI",0,t,"DocumentLoader",()=>a,"EXTS",0,i,"getDirection",0,e=>{let{defaultView:t}=e,{writingMode:i,direction:r}=t.getComputedStyle(e.body);return{vertical:"vertical-rl"===i||"vertical-lr"===i,rtl:"rtl"===e.body.dir||"rtl"===r||"rtl"===e.documentElement.dir}},"getFileExtFromMimeType",0,e=>{if(!e)return"";for(let t in r)if(r[t].includes(e))return i[t];return""}],835106);var s=e.i(262504),n=e.i(62725),o=e.i(266765),l=e.i(819045);e.i(431263);var c=e.i(805143);let f=(e,t=!1)=>{let i=(0,n.getUserLang)();if(!e)return"";if("string"==typeof e)return e;let r=Object.keys(e);return t?e[r[0]]:e[i]||e[r[0]]},p=(e=!1,t="")=>(t=t||(0,n.getUserLang)(),e)?new Intl.ListFormat("en",{style:"narrow",type:"unit"}):new Intl.ListFormat(t,{style:"long",type:"conjunction"}),h=e=>{try{let t="string"==typeof e?e:e?.[0];return t?t.split("-")[0]:""}catch{return""}},u=["ar","bo","de","en","es","fr","hi","it","nl","pl","pt","ru","th","tr","uk"],d=(e,t)=>{if(!e)return"";let i=e.split(" ");return t&&i.length>1?`${i[i.length-1]}, ${i.slice(0,-1).join(" ")}`:e},m=e=>s.SUPPORTED_LANGS[e]||e.toUpperCase(),g=e=>{let t=Array.isArray(e)?e[0]:e;if((0,l.isValidLang)(t)){let e=(0,l.normalizedLangCode)(t);return(0,l.code6392to6391)(e)||e}return"en"},w=e=>{try{if(e.includes("urn:"))return e.match(/[^:]+$/)?.[0]||"";if(e.includes(":"))return e.match(/^[^:]+:(.+)$/)?.[1]||""}catch{}return e};e.s(["INIT_BOOK_CONFIG",0,{updatedAt:0},"flattenContributors",0,e=>e?Array.isArray(e)?e.map(e=>"string"==typeof e?e:f(e?.name)).join(", "):"string"==typeof e?e:f(e?.name):"","formatAuthors",0,(e,t,i)=>{let r=h(t)||"en",a=!!i&&u.includes(r);return Array.isArray(e)?p("zh"===r,r).format(e.map(e=>"string"==typeof e?d(e,a):d(f(e?.name),a))):"string"==typeof e?d(e,a):d(f(e?.name),a)},"formatBytes",0,(e,t="en-US")=>{if(!e)return"";let i=Math.floor(Math.log(e)/Math.log(1024)),r=e/Math.pow(1024,i);return new Intl.NumberFormat(t,{style:"unit",unit:["byte","kilobyte","megabyte","gigabyte","terabyte"][i],unitDisplay:"short",maximumFractionDigits:2}).format(r)},"formatDate",0,(e,t=!1)=>{if(!e)return;let i=(0,n.getUserLang)();try{return new Date(e).toLocaleDateString(i,{year:"numeric",month:"long",day:"numeric",timeZone:t?"UTC":void 0})}catch{return}},"formatDescription",0,e=>e?("string"==typeof e?e:f(e)).replace(/<\/?[^>]+(>|$)/g,"").replace(/&#\d+;/g,"").trim():"","formatLanguage",0,e=>Array.isArray(e)?e.map(m).join(", "):m(e||""),"formatPublisher",0,e=>"string"==typeof e?e:f(e),"formatTitle",0,e=>"string"==typeof e?e:f(e),"getBookDirFromLanguage",0,e=>{let t=g(e)||"";return(0,o.getDirFromLanguage)(t)},"getBookDirFromWritingMode",0,e=>{switch(e){case"horizontal-tb":return"ltr";case"horizontal-rl":case"vertical-rl":return"rtl";default:return"auto"}},"getBookLangCode",0,h,"getConfigFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,"");return`${t}/config.json`},"getCoverFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,""),i=`${t}/cover.png`;return console.log("[getCoverFilename] ✓ Using relativePath:",e.relativePath),console.log("[getCoverFilename] ✓ Cover path result:",i),i},"getCurrentPage",0,(e,t)=>{let i=e.format,{section:r,pageinfo:a}=t;return"PDF"===i?r?r.current+1:0:a?a.current+1:0},"getDir",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath.replace(/\.[^.]+$/,"")},"getLibraryBackupFilename",0,()=>"library_backup.json","getLibraryFilename",0,()=>"library.json","getLocalBookFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath},"getMetadataHash",0,e=>{try{var t;let i,r=(i=e.title,"string"==typeof i?i:f(i,!0)),a=(!(t=e.author)?[]:Array.isArray(t)?t.map(e=>"string"==typeof e?e:f(e?.name,!0)).filter(Boolean):["string"==typeof t?t:f(t?.name,!0)]).join(","),s=(e=>{if(!e)return[];if(Array.isArray(e)){let t=(e=>{for(let t of["uuid","calibre","isbn"]){let i=e.find(e=>"string"==typeof e?e.toLowerCase().includes(t):e.scheme.toLowerCase()===t);if(i)return"string"==typeof i?w(i):i.value}})(e);if(t)return[t]}return Array.isArray(e)?e.map(e=>"string"==typeof e?w(e):e.value).filter(Boolean):"string"==typeof e?[w(e)]:[e.value]})(e.altIdentifier||e.identifier).join(","),n=`${r}|${a}|${s}`;return(0,c.md5)(n.normalize("NFC"))}catch(e){console.error("Error generating metadata hash:",e)}},"getPrimaryLanguage",0,g,"listFormater",0,p],955066)},421966,e=>{"use strict";e.s(["deserializeConfig",0,(e,t,i)=>{let r=JSON.parse(e),{viewSettings:a,searchConfig:s}=r;return r.viewSettings={...t,...a},r.searchConfig={...i,...s},r.updatedAt??=Date.now(),r},"serializeConfig",0,(e,t,i)=>{let r=(e=JSON.parse(JSON.stringify(e))).viewSettings,a=e.searchConfig;return e.viewSettings=Object.entries(r).reduce((e,[i,r])=>(t[i]!==r&&(e[i]=r),e),{}),e.searchConfig=Object.entries(a).reduce((e,[t,r])=>(i[t]!==r&&(e[t]=r),e),{}),JSON.stringify(e)}])},724109,e=>{"use strict";var t=e.i(307178),i=e.i(898400),r=e.i(99500),a=e.i(871611);async function s(e={}){return"object"==typeof e&&Object.freeze(e),await (0,a.invoke)("plugin:dialog|open",{options:e})}async function n(e={}){return"object"==typeof e&&Object.freeze(e),await (0,a.invoke)("plugin:dialog|save",{options:e})}var o=e.i(897755);async function l(e,t){await (0,a.invoke)("plugin:sharekit|share_file",{url:e,...t})}var c=e.i(62725),f=e.i(329748),p=e.i(229435),h=e.i(341537);let u=async(e,t,i)=>{let r=[];try{r=await e.readDirectory(t,"None")}catch{throw Error(`Dir ${t} failed to read.`)}for(let a=0;a<r.length;a++){let s=r[a],n=`${t}/${s.path}`,o=`${i}/${s.path}`;await e.copyFile(n,o,"None")}let a=await e.readDirectory(i,"None");for(let e of r)if(!a.find(t=>t.path===e.path&&t.size===e.size))throw Error(`File ${e.path} failed to copy.`)};var d=e.i(669770),m=e.i(262504);let g=null,w=()=>(null===g&&(g=(0,o.type)()),g),y=({customRootDir:e,isPortable:t,execDir:i}={})=>{let a=e?0:void 0,s=!!e,n=s?t=>()=>{let i=["Settings","Data","Books","Fonts","Images"].includes(t)?"":t;return i?`${e}/${i}`:e}:void 0,o=n?e=>async()=>n(e)():void 0;return(e,l)=>{let c=n?.(l),f=o?.(l);switch(l){case"Settings":return{baseDir:t?0:r.BaseDirectory.AppConfig,basePrefix:t&&i?async()=>i:r.appConfigDir,fp:t&&i?`${i}${e?`/${e}`:""}`:e,base:l};case"Cache":return{baseDir:r.BaseDirectory.AppCache,basePrefix:r.appCacheDir,fp:e,base:l};case"Log":return{baseDir:s?0:r.BaseDirectory.AppLog,basePrefix:f??r.appLogDir,fp:c?`${c()}${e?`/${e}`:""}`:e,base:l};case"Data":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:f??r.appDataDir,fp:c?`${c()}/${m.DATA_SUBDIR}${e?`/${e}`:""}`:`${m.DATA_SUBDIR}${e?`/${e}`:""}`,base:l};case"Books":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:f||r.appDataDir,fp:c?`${c()}/${m.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`:`${m.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Fonts":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:f||r.appDataDir,fp:c?`${c()}/${m.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`:`${m.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Images":return{baseDir:a??r.BaseDirectory.AppData,basePrefix:f||r.appDataDir,fp:c?`${c()}/${m.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`:`${m.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`,base:l};case"None":return{baseDir:0,basePrefix:async()=>"",fp:e,base:l};default:return{baseDir:r.BaseDirectory.Temp,basePrefix:r.tempDir,fp:e,base:l}}}},b={resolvePath:y(),async getPrefix(e){let{basePrefix:t,fp:i,baseDir:a}=this.resolvePath("",e),s=await t();return s=s.replace(/\/+$/,""),i?0===a?i:await (0,r.join)(s,i):s},getURL:e=>(0,c.isValidURL)(e)?e:(0,a.convertFileSrc)(e),async getBlobURL(e,t){let i=await this.readFile(e,t,"binary");return URL.createObjectURL(new Blob([i]))},async getImageURL(e){return this.getURL(e)},async openFile(e,t,i){let{fp:a,baseDir:s}=this.resolvePath(e,t),n=i||(0,f.getFilename)(a);if((0,c.isValidURL)(e))return await new p.RemoteFile(e,n).open();if((0,c.isContentURI)(e)||(0,c.isFileURI)(e)&&"ios"===w()){if(n=await (0,r.basename)(e),e.includes("com.android.externalstorage"))return await new p.NativeFile(a,n,s||null).open();{let t=await this.getPrefix("Cache"),i=await (0,r.join)(t,decodeURIComponent(n)),a=await (0,h.copyURIToPath)({uri:e,dst:i});if(!a.success)throw console.error("Failed to open file:",a),Error("Failed to open file");return await new p.NativeFile(i,n,s||null).open()}}{if((0,c.isFileURI)(e)||"android"===w())return await new p.NativeFile(a,n,s||null).open();let i=await this.getPrefix(t),o=i?await (0,r.join)(i,e):e;return await new p.RemoteFile(this.getURL(o),n).open()}},async copyFile(e,t,a){try{await this.exists((0,f.getDirPath)(t),a)||await this.createDir((0,f.getDirPath)(t),a,!0)}catch(e){console.log("Failed to create directory for copying file:",e)}if((0,c.isContentURI)(e)){let i=await this.getPrefix(a);if(!i)throw Error("Invalid base directory");let s=await (0,h.copyURIToPath)({uri:e,dst:await (0,r.join)(i,t)});if(!s.success)throw console.error("Failed to copy file:",s),Error("Failed to copy file")}else{let{fp:r,baseDir:s}=this.resolvePath(t,a);await (0,i.copyFile)(e,r,s?{toPathBaseDir:s}:void 0)}},async readFile(e,t,r){let{fp:a,baseDir:s}=this.resolvePath(e,t);return"text"===r?(0,i.readTextFile)(a,s?{baseDir:s}:void 0):(await (0,i.readFile)(a,s?{baseDir:s}:void 0)).buffer},async writeFile(e,t,r){let{fp:a,baseDir:s}=this.resolvePath(e,t);return(await this.exists((0,f.getDirPath)(e),t)||await this.createDir((0,f.getDirPath)(e),t,!0),"string"==typeof r)?(0,i.writeTextFile)(a,r,s?{baseDir:s}:void 0):r instanceof File?await (0,i.writeFile)(a,r.stream(),{write:!0,create:!0,baseDir:s||void 0}):await (0,i.writeFile)(a,new Uint8Array(r),s?{baseDir:s}:void 0)},async removeFile(e,t){let{fp:r,baseDir:a}=this.resolvePath(e,t);await (0,i.remove)(r,a?{baseDir:a}:void 0)},async createDir(e,t,r=!1){let{fp:a,baseDir:s}=this.resolvePath(e,t);await (0,i.mkdir)(a,{baseDir:s||void 0,recursive:r})},async removeDir(e,t,r=!1){let{fp:a,baseDir:s}=this.resolvePath(e,t);await (0,i.remove)(a,{baseDir:s||void 0,recursive:r})},async readDir(e,t){let{fp:s,baseDir:n}=this.resolvePath(e,t);if(!n||0===n)try{return(await (0,a.invoke)("read_dir",{path:s,recursive:!0,extensions:["*"]})).map(e=>{var t;let i;return{path:(t=e.path,i=t,t.toLowerCase().startsWith(s.toLowerCase())&&(i=t.substring(s.length)),(i.startsWith("\\")||i.startsWith("/"))&&(i=i.substring(1)),i),size:e.size}})}catch(e){console.error("Rust read_dir failed, falling back to JS recursion",e)}let o=await (0,i.readDir)(s,n?{baseDir:n}:void 0),l=[],c=async(e,t,a,s)=>{for(let o of a)if(o.isDirectory){let a=await (0,r.join)(e,o.name),l=t?await (0,r.join)(t,o.name):o.name;try{let e=await (0,i.readDir)(a,n?{baseDir:n}:void 0);await c(a,l,e,s)}catch{console.warn(`Skipping unreadable dir: ${a}`)}}else{let a=await (0,r.join)(e,o.name),l=t?await (0,r.join)(t,o.name):o.name,c=n?{baseDir:n}:void 0,f=await (0,i.stat)(a,c).then(e=>e.size).catch(()=>0);s.push({path:l,size:f})}};return await c(s,"",o,l),l},async exists(e,t){let{fp:r,baseDir:a}=this.resolvePath(e,t);try{return await (0,i.exists)(r,a?{baseDir:a}:void 0)}catch{return!1}},async stats(e,t){let{fp:r,baseDir:a}=this.resolvePath(e,t);return await (0,i.stat)(r,a?{baseDir:a}:void 0)}},D=t.default.env.NEXT_PUBLIC_DIST_CHANNEL||"readest";class v extends d.BaseAppService{fs=b;appPlatform="tauri";isAppDataSandbox=!1;isMobile=!1;isAndroidApp=!1;isIOSApp=!1;isMacOSApp=!1;isLinuxApp=!1;isMobileApp=!1;isDesktopApp=!1;isEink=!!window.__READEST_IS_EINK;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir="appstore"!==D;canReadExternalDir="appstore"!==D&&"playstore"!==D;distChannel=D;execDir=void 0;async init(){if(!window.__TAURI__)throw Error("NativeAppService can only be initialized in Tauri environment");let e=w();this.isAppDataSandbox=["android","ios"].includes(e),this.isMobile=["android","ios"].includes(e),this.isAndroidApp="android"===e,this.isIOSApp="ios"===e,this.isMacOSApp="macos"===e,this.isLinuxApp="linux"===e,this.isMobileApp=["android","ios"].includes(e),this.isDesktopApp=["macos","windows","linux"].includes(e),this.hasTrafficLight="macos"===e,this.hasWindow="ios"!==e&&"android"!==e,this.hasWindowBar="ios"!==e&&"android"!==e,this.hasContextMenu="ios"!==e&&"android"!==e,this.hasRoundedWindow="linux"===e,this.hasSafeAreaInset="ios"===e||"android"===e,this.hasHaptics="ios"===e||"android"===e,this.hasUpdater="ios"!==e&&!t.default.env.NEXT_PUBLIC_DISABLE_UPDATER&&!window.__READEST_UPDATER_DISABLED,this.hasOrientationLock="ios"===e&&"ios"===(0,c.getOSPlatform)()||"android"===e,this.hasScreenBrightness="ios"===e||"android"===e,this.hasIAP="ios"===e||"android"===e&&"playstore"===D;let i=await (0,a.invoke)("get_executable_dir");this.execDir=i,(t.default.env.NEXT_PUBLIC_PORTABLE_APP||await this.fs.exists(`${i}/${m.SETTINGS_FILENAME}`,"None"))&&(this.isPortableApp=!0,this.fs.resolvePath=y({customRootDir:i,isPortable:this.isPortableApp,execDir:i}));let r=await this.loadSettings();r.customRootDir&&(this.fs.resolvePath=y({customRootDir:r.customRootDir,isPortable:this.isPortableApp,execDir:i})),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let e=await this.loadSettings(),t=e.migrationVersion||0;if(await super.runMigrations(t),t<0x1350195)try{await this.migrate20251029()}catch(e){console.error("Error migrating to version 20251029:",e)}t<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...e,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(e){console.error("Failed to run migrations:",e)}}resolvePath(e,t){return this.fs.resolvePath(e,t)}async setCustomRootDir(e){this.fs.resolvePath=y({customRootDir:e,isPortable:this.isPortableApp,execDir:this.execDir}),await this.prepareBooksDir()}async selectDirectory(){return await s({directory:!0,multiple:!1,recursive:!0})}async selectFiles(e,t){let i=await s({multiple:!0,filters:[{name:e,extensions:t}]});return Array.isArray(i)?i:i?[i]:[]}async saveFile(e,t,r,a){try{let s=e.split(".").pop()||"";if(this.isIOSApp)await l(r,{mimeType:a||"application/octet-stream"});else{let r=await n({defaultPath:e,filters:[{name:s.toUpperCase(),extensions:[s]}]});if(!r)return!1;"string"==typeof t?await (0,i.writeTextFile)(r,t):await (0,i.writeFile)(r,new Uint8Array(t))}return!0}catch(e){return console.error("Failed to save file:",e),!1}}async migrate20251029(){console.log("Running migration 20251029 to update paths in Images dir...");let e=await this.resolveFilePath("..","Data"),t=await this.fs.getPrefix("Images"),i=await (0,r.join)(e,"Images","Readest","Images");await u(this,i,t);let a=await (0,r.join)(e,"Images","Readest");await this.deleteDir(a,"None",!0)}}e.s(["NativeAppService",()=>v,"nativeFileSystem",0,b],724109)},187722,e=>{e.v(t=>Promise.all(["static/chunks/81d1d75e9e131825.js"].map(t=>e.l(t))).then(()=>t(859708)))},722516,e=>{e.v(t=>Promise.all(["static/chunks/469432e3b698cd7d.js"].map(t=>e.l(t))).then(()=>t(54225)))},119421,e=>{e.v(t=>Promise.all(["static/chunks/19020269b9e1aa74.js"].map(t=>e.l(t))).then(()=>t(283704)))},89544,e=>{e.v(t=>Promise.all(["static/chunks/684ebfba3ff2905e.js"].map(t=>e.l(t))).then(()=>t(516286)))},511607,e=>{e.v(t=>Promise.all(["static/chunks/d92df3567fe1713d.js","static/chunks/3be72551b54a43b7.js"].map(t=>e.l(t))).then(()=>t(186508)))},620701,e=>{e.v(t=>Promise.all(["static/chunks/8e4e60ea9cdebc21.js"].map(t=>e.l(t))).then(()=>t(480474)))},664253,e=>{e.v(t=>Promise.all(["static/chunks/2fd9391baa13278f.js"].map(t=>e.l(t))).then(()=>t(148225)))}]);