(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,346145,e=>{"use strict";var t=e.i(119322),r=e.i(431187),i=e.i(883228),a=e.i(479217),o=e.i(19347),s=e.i(481959),n=e.i(582538);let l=async()=>"",c={resolvePath:(e,r)=>{switch(void 0!==t.default||window.__STORAGE_MODE__,r){case"Data":return{baseDir:0,basePrefix:l,fp:`${s.DATA_SUBDIR}/${e}`,base:r};case"Settings":return{baseDir:0,basePrefix:l,fp:`.readest/${e}`,base:r};case"Books":if("library.json"===e||"library.json.bak"===e||"library_backup.json"===e)return console.log("[ResolvePath] Books/Library detected, routing to .readest"),{baseDir:0,basePrefix:l,fp:`.readest/${e}`,base:r};return console.log("[ResolvePath] ✓ Books base, flat path (no prefix):",e),console.log("[ResolvePath] ✓ Returning fp:",e),{baseDir:0,basePrefix:l,fp:e,base:r};case"Fonts":return{baseDir:0,basePrefix:l,fp:`${s.LOCAL_FONTS_SUBDIR}/${e}`,base:r};case"Images":return{baseDir:0,basePrefix:l,fp:`${s.LOCAL_IMAGES_SUBDIR}/${e}`,base:r};case"None":return{baseDir:0,basePrefix:l,fp:e,base:r};default:return{baseDir:0,basePrefix:l,fp:`${r}/${e}`,base:r}}},async getPrefix(e){let{basePrefix:t,fp:r}=this.resolvePath("",e),i=await t();return(r?i?`${i}/${r}`:r:i).replace(/\/+$/,"")},getURL:e=>(0,r.isValidURL)(e)?e:`/api/storage/file?filePath=${encodeURIComponent(e)}`,async getBlobURL(e,t){try{let r=await this.readFile(e,t,"binary");return URL.createObjectURL(new Blob([r]))}catch{return e}},async getImageURL(e){return this.getURL(e)},async openFile(e,t,a){if((0,r.isValidURL)(e))return await new i.RemoteFile(e,a).open();let{fp:o}=this.resolvePath(e,t),s=await fetch(`/api/storage/file?filePath=${encodeURIComponent(o)}`);if(!s.ok)throw Error("File not found");return new File([await s.arrayBuffer()],a||e)},async copyFile(e,t,r){let i=await this.openFile(e,r);await this.writeFile(t,r,i)},async readFile(e,t,r){let{fp:i}=this.resolvePath(e,t),a=await fetch(`/api/storage/file?filePath=${encodeURIComponent(i)}`);if(!a.ok)throw Error(`File not found: ${i}`);return"text"===r?await a.text():await a.arrayBuffer()},async writeFile(e,t,r){let i,{fp:a}=this.resolvePath(e,t);if(console.log("[APIFileSystem.writeFile] 11. Input path:",e),console.log("[APIFileSystem.writeFile] 12. Base:",t),console.log("[APIFileSystem.writeFile] 13. Resolved fp:",a),i=r instanceof File?n.Buffer.from(await r.arrayBuffer()):n.Buffer.from(r),console.log("[APIFileSystem.writeFile] 14. Calling PUT /api/storage/file with filePath:",a),!(await fetch(`/api/storage/file?filePath=${encodeURIComponent(a)}`,{method:"PUT",body:i})).ok)throw Error("Failed to write file")},async removeFile(e,t){let{fp:r}=this.resolvePath(e,t);if(!(await fetch(`/api/storage/delete?fileKey=${encodeURIComponent(r)}`,{method:"DELETE"})).ok)throw Error("Failed to delete file")},async createDir(e,t){},async removeDir(e,t){},readDir:async(e,t)=>[],async exists(e,t){let{fp:r}=this.resolvePath(e,t);return(await fetch(`/api/storage/file?filePath=${encodeURIComponent(r)}`)).ok},async stats(e,t){let{fp:r}=this.resolvePath(e,t),i=await fetch(`/api/storage/file?filePath=${encodeURIComponent(r)}`);if(!i.ok)throw Error("File not found");return{isFile:!0,isDirectory:!1,size:(await i.arrayBuffer()).byteLength,mtime:null,atime:null,birthtime:null}}};class f extends o.BaseAppService{get fs(){return window.__STORAGE_MODE__,c}isMobile=["android","ios"].includes((0,r.getOSPlatform)());appPlatform="web";hasSafeAreaInset=(0,a.isPWA)();async init(){await this.loadSettings(),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let e=await this.loadSettings(),t=e.migrationVersion||0;await super.runMigrations(t),t<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...e,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(e){console.error("Failed to run migrations:",e)}}resolvePath(e,t){return this.fs.resolvePath(e,t)}async setCustomRootDir(){}async selectDirectory(){throw Error("selectDirectory is not supported in browser")}async selectFiles(){throw Error("selectFiles is not supported in browser")}async saveFile(e,t,r){try{let i=new Blob([t],{type:r||"application/octet-stream"}),a=URL.createObjectURL(i),o=document.createElement("a");return o.href=a,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),!0}catch(e){return console.error("Failed to save file:",e),!1}}}e.s(["WebAppService",()=>f],346145)},367859,e=>{e.v(t=>Promise.all(["static/chunks/9adae417cfca96c8.js"].map(t=>e.l(t))).then(()=>t(153654)))}]);