(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,399458,e=>{"use strict";let t,r=(e,t)=>[-1,...t,e.length].reduce(({xs:t,a:r},i)=>({xs:t?.concat([e.slice(r+1,i)])??[],a:i}),{}).xs,i=/\d/,a=/^epubcfi\((.*)\)$/,n=e=>e.replace(/[\^[\](),;=]/g,"^$&"),l=e=>a.test(e)?e:`epubcfi(${e})`,o=(t=(...e)=>e.join("!"),(...e)=>`epubcfi(${t(...e.map(e=>e.match(a)?.[1]??e))})`),s=(e,t)=>{let r;return r=([e])=>e===t,e.map((e,t,i)=>r(e,t,i)?t:null).filter(e=>null!=e)},u=e=>{let t,r=[];for(let[i,a]of e){if("/"===i)r.push({index:a});else{let e=r[r.length-1];if(":"===i)e.offset=a;else if("~"===i)e.temporal=a;else if("@"===i)e.spatial=(e.spatial??[]).concat(a);else if(";s"===i)e.side=a;else if("["===i)if("/"===t&&a)e.id=a;else{e.text=(e.text??[]).concat(a);continue}}t=i}return r},c=e=>r(e,s(e,"!")).map(u),d=e=>{let t=(e=>{let t=[],r,a,n="",l=e=>(t.push(e),r=null,n=""),o=e=>(n+=e,a=!1);for(let t of Array.from(e.trim()).concat("")){if("^"===t&&!a){a=!0;continue}if("!"===r)l(["!"]);else if(","===r)l([","]);else if("/"===r||":"===r)if(i.test(t)){o(t);continue}else l([r,parseInt(n)]);else if("~"===r)if(i.test(t)||"."===t){o(t);continue}else l(["~",parseFloat(n)]);else if("@"===r){if(":"===t){l(["@",parseFloat(n)]),r="@";continue}if(i.test(t)||"."===t){o(t);continue}l(["@",parseFloat(n)])}else if("["===r){";"!==t||a?","!==t||a?"]"!==t||a?o(t):l(["[",n]):(l(["[",n]),r="["):(l(["[",n]),r=";");continue}else if(r?.startsWith(";")){"="!==t||a?";"!==t||a?"]"!==t||a?o(t):l([r,n]):(l([r,n]),r=";"):(r=`;${n}`,n="");continue}("/"===t||":"===t||"~"===t||"@"===t||"["===t||"!"===t||","===t)&&(r=t)}return t})(e.match(a)?.[1]??e),n=s(t,",");if(!n.length)return c(t);let[l,o,u]=r(t,n).map(c);return{parent:l,start:o,end:u}},f=({index:e,id:t,offset:r,temporal:i,spatial:a,text:l,side:o})=>{let s=o?`;s=${o}`:"";return`/${e}`+(t?`[${n(t)}${s}]`:"")+(null!=r&&e%2?`:${r}`:"")+(i?`~${i}`:"")+(a?`@${a.join(":")}`:"")+(l||!t&&o?"["+(l?.map(n)?.join(",")??"")+s+"]":"")},p=e=>e.parent?[e.parent,e.start,e.end].map(p).join(","):e.map(e=>e.map(f).join("")).join("!"),m=e=>l(p(e)),h=(e,t)=>{let r,i;return"string"==typeof e?m(h(d(e),t)):e.parent?(r=e.parent,i=e[t?"end":"start"],r.slice(0,-1).concat([r[r.length-1].concat(i[0])]).concat(i.slice(1))):e},g=(e,t)=>{"string"==typeof e&&(e=d(e)),"string"==typeof t&&(t=d(t)),e=h(e),t=h(t,!0);let r=e[e.length-1],i=t[t.length-1],a=[],n=[],l=[],o=!0,s=Math.max(r.length,i.length);for(let e=0;e<s;e++){let t=r[e],s=i[e];(o&&=t?.index===s?.index&&!t?.offset&&!s?.offset)?a.push(t):(t&&n.push(t),s&&l.push(s))}return m({parent:e.slice(0,-1).concat([a]),start:[n],end:[l]})},w=(e,t)=>{if("string"==typeof e&&(e=d(e)),"string"==typeof t&&(t=d(t)),e.start||t.start)return w(h(e),h(t))||w(h(e,!0),h(t,!0));for(let r=0;r<Math.max(e.length,t.length);r++){let i=e[r]??[],a=t[r]??[],n=Math.max(i.length,a.length)-1;for(let e=0;e<=n;e++){let t=i[e],r=a[e];if(!t)return -1;if(!r||t.index>r.index)return 1;if(t.index<r.index)return -1;if(e===n){if(t.offset>r.offset)return 1;if(t.offset<r.offset)return -1}}}return 0},y=({nodeType:e})=>3===e||4===e,b=(e,t)=>{let r=Array.from(e.childNodes).filter(e=>y(e)||(({nodeType:e})=>1===e)(e));return t?r.map(e=>{let r=t(e);return r===NodeFilter.FILTER_REJECT?null:r===NodeFilter.FILTER_SKIP?b(e,t):e}).flat().filter(e=>e):r},x=(e,t)=>{let r=b(e,t).reduce((e,t)=>{let r=e[e.length-1];return r?y(t)?Array.isArray(r)?r.push(t):y(r)?e[e.length-1]=[r,t]:e.push(t):(({nodeType:e})=>1===e)(r)?e.push(null,t):e.push(t):e.push(t),e},[]);return(({nodeType:e})=>1===e)(r[0])&&r.unshift("first"),(({nodeType:e})=>1===e)(r[r.length-1])&&r.push("last"),r.unshift("before"),r.push("after"),r},v=(e,t,r)=>{let{id:i}=t[t.length-1];if(i){let t=e.ownerDocument.getElementById(i);if(t)return{node:t,offset:0}}for(let{index:i}of t){let t=e?x(e,r)[i]:null;if("first"===t)return{node:e.firstChild??e};if("last"===t)return{node:e.lastChild??e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}let{offset:a}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:a};let n=0;for(let t of e){let{length:e}=t.nodeValue;if(n+e>=a)return{node:t,offset:a-n};n+=e}},A=(e,t,r)=>{let{parentNode:i,id:a}=e,n=x(i,r),l=n.findIndex(t=>Array.isArray(t)?t.some(t=>t===e):t===e),o=n[l];if(Array.isArray(o)){let r=0;for(let i of o)if(i===e){r+=t;break}else r+=i.nodeValue.length;t=r}let s={id:a,index:l,offset:t};return(i!==e.ownerDocument.documentElement?A(i,null,r).concat(s):[s]).filter(e=>-1!==e.index)},L={fromIndex:e=>l(`/6/${(e+1)*2}`),toIndex:e=>e?.at(-1).index/2-1};e.s(["collapse",0,h,"compare",0,w,"fake",0,L,"fromCalibreHighlight",0,({spine_index:e,start_cfi:t,end_cfi:r})=>{let i=L.fromIndex(e)+"!";return g(i+t.slice(2),i+r.slice(2))},"fromCalibrePos",0,e=>{let[t]=d(e),r=t.shift();return t.shift(),m([[{index:6},r],t])},"fromElements",0,e=>{let t=[],{parentNode:r}=e[0],i=A(r);for(let[a,n]of x(r).entries()){let r=e[t.length];n===r&&t.push(m([i.concat({id:r.id,index:a})]))}return t},"fromRange",0,(e,t)=>{let{startContainer:r,startOffset:i,endContainer:a,endOffset:n}=e,l=A(r,i,t);return e.collapsed?m([l]):g([l],[A(a,n,t)])},"isCFI",0,a,"joinIndir",0,o,"parse",0,d,"toElement",0,(e,t)=>v(e.documentElement,h(t)).node,"toRange",0,(e,t,r)=>{let i=h(t),a=h(t,!0),n=e.documentElement,l=v(n,i[0],r),o=v(n,a[0],r),s=e.createRange();return l.before?s.setStartBefore(l.node):l.after?s.setStartAfter(l.node):s.setStart(l.node,l.offset),o.before?s.setEndBefore(o.node):o.after?s.setEndAfter(o.node):s.setEnd(o.node,o.offset),s}])},955066,835106,e=>{"use strict";var t=e.i(399458);let r={EPUB:"epub",PDF:"pdf",MOBI:"mobi",AZW:"azw",AZW3:"azw3",CBZ:"cbz",FB2:"fb2",FBZ:"fbz",TXT:"txt",MD:"md"},i={EPUB:["application/epub+zip"],PDF:["application/pdf"],MOBI:["application/x-mobipocket-ebook"],AZW:["application/vnd.amazon.ebook"],AZW3:["application/vnd.amazon.mobi8-ebook","application/x-mobi8-ebook"],CBZ:["application/vnd.comicbook+zip","application/zip","application/x-cbz"],FB2:["application/x-fictionbook+xml","text/xml","application/xml"],FBZ:["application/x-zip-compressed-fb2","application/zip"],TXT:["text/plain"],MD:["text/markdown","text/x-markdown"]};class a{file;constructor(e){this.file=e}async isZip(){let e=new Uint8Array(await this.file.slice(0,4).arrayBuffer());return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}async isPDF(){let e=new Uint8Array(await this.file.slice(0,5).arrayBuffer());return 37===e[0]&&80===e[1]&&68===e[2]&&70===e[3]&&45===e[4]}async makeZipLoader(){let t=async()=>{let e=Math.min(65536,this.file.size),t=new Uint8Array(await this.file.slice(this.file.size-e,this.file.size).arrayBuffer());for(let e=t.length-22;e>=0;e--)if(80===t[e]&&75===t[e+1]&&5===t[e+2]&&6===t[e+3]){let r=t[e+20]+(t[e+21]<<8),i=e+22,a=t.slice(i,i+r);return new TextDecoder().decode(a)}return null},{configure:r,ZipReader:i,BlobReader:a,TextWriter:n,BlobWriter:l}=await e.A(187722);r({useWebWorkers:!1});let o=new i(new a(this.file)),s=await o.getEntries(),u=new Map(s.map(e=>[e.filename,e])),c=e=>(t,...r)=>u.has(t)?e(u.get(t),...r):null,d=c(e=>e.getData?e.getData(new n):null);return{entries:s,loadText:d,loadBlob:c((e,t)=>e.getData?e.getData(new l(t)):null),getSize:e=>u.get(e)?.uncompressedSize??0,getComment:t,sha1:void 0}}isCBZ(){return"application/vnd.comicbook+zip"===this.file.type||this.file.name.endsWith(`.${r.CBZ}`)}isFB2(){return"application/x-fictionbook+xml"===this.file.type||this.file.name.endsWith(`.${r.FB2}`)}isFBZ(){return"application/x-zip-compressed-fb2"===this.file.type||this.file.name.endsWith(".fb.zip")||this.file.name.endsWith(".fb2.zip")||this.file.name.endsWith(`.${r.FBZ}`)}async open(){let t=null,i="EPUB";if(!this.file.size)throw Error("File is empty");try{if(await this.isZip()){let a=await this.makeZipLoader(),{entries:n}=a;if(this.isCBZ()){let{makeComicBook:r}=await e.A(664253);t=await r(a,this.file),i="CBZ"}else if(this.isFBZ()){let l=n.find(e=>e.filename.endsWith(`.${r.FB2}`)),o=await a.loadBlob((l??n[0]).filename),{makeFB2:s}=await e.A(119421);t=await s(o),i="FBZ"}else{let{EPUB:r}=await e.A(620701);t=await new r(a).init(),i="EPUB"}}else if(await this.isPDF()){let{makePDF:r}=await e.A(511607);t=await r(this.file),i="PDF"}else if(await (await e.A(722516)).isMOBI(this.file)){let r=await e.A(89544),{MOBI:a}=await e.A(722516);switch(t=await new a({unzlib:r.unzlibSync}).open(this.file),this.file.name.split(".").pop()?.toLowerCase()){case"azw":i="AZW";break;case"azw3":i="AZW3";break;default:i="MOBI"}}else if(this.isFB2()){let{makeFB2:r}=await e.A(119421);t=await r(this.file),i="FB2"}}catch(e){if(console.error("Failed to open document:",e),e instanceof Error&&e.message?.includes("not a valid zip"))throw Error("Unsupported or corrupted book file");throw e}return{book:t,format:i}}}e.s(["CFI",0,t,"DocumentLoader",()=>a,"EXTS",0,r,"getDirection",0,e=>{let{defaultView:t}=e,{writingMode:r,direction:i}=t.getComputedStyle(e.body);return{vertical:"vertical-rl"===r||"vertical-lr"===r,rtl:"rtl"===e.body.dir||"rtl"===i||"rtl"===e.documentElement.dir}},"getFileExtFromMimeType",0,e=>{if(!e)return"";for(let t in i)if(i[t].includes(e))return r[t];return""}],835106);var n=e.i(262504),l=e.i(62725),o=e.i(266765),s=e.i(819045);e.i(431263);var u=e.i(805143);let c=(e,t=!1)=>{let r=(0,l.getUserLang)();if(!e)return"";if("string"==typeof e)return e;let i=Object.keys(e);return t?e[i[0]]:e[r]||e[i[0]]},d=(e=!1,t="")=>(t=t||(0,l.getUserLang)(),e)?new Intl.ListFormat("en",{style:"narrow",type:"unit"}):new Intl.ListFormat(t,{style:"long",type:"conjunction"}),f=e=>{try{let t="string"==typeof e?e:e?.[0];return t?t.split("-")[0]:""}catch{return""}},p=["ar","bo","de","en","es","fr","hi","it","nl","pl","pt","ru","th","tr","uk"],m=(e,t)=>{if(!e)return"";let r=e.split(" ");return t&&r.length>1?`${r[r.length-1]}, ${r.slice(0,-1).join(" ")}`:e},h=e=>n.SUPPORTED_LANGS[e]||e.toUpperCase(),g=e=>{let t=Array.isArray(e)?e[0]:e;if((0,s.isValidLang)(t)){let e=(0,s.normalizedLangCode)(t);return(0,s.code6392to6391)(e)||e}return"en"},w=e=>{try{if(e.includes("urn:"))return e.match(/[^:]+$/)?.[0]||"";if(e.includes(":"))return e.match(/^[^:]+:(.+)$/)?.[1]||""}catch{}return e};e.s(["INIT_BOOK_CONFIG",0,{updatedAt:0},"flattenContributors",0,e=>e?Array.isArray(e)?e.map(e=>"string"==typeof e?e:c(e?.name)).join(", "):"string"==typeof e?e:c(e?.name):"","formatAuthors",0,(e,t,r)=>{let i=f(t)||"en",a=!!r&&p.includes(i);return Array.isArray(e)?d("zh"===i,i).format(e.map(e=>"string"==typeof e?m(e,a):m(c(e?.name),a))):"string"==typeof e?m(e,a):m(c(e?.name),a)},"formatBytes",0,(e,t="en-US")=>{if(!e)return"";let r=Math.floor(Math.log(e)/Math.log(1024)),i=e/Math.pow(1024,r);return new Intl.NumberFormat(t,{style:"unit",unit:["byte","kilobyte","megabyte","gigabyte","terabyte"][r],unitDisplay:"short",maximumFractionDigits:2}).format(i)},"formatDate",0,(e,t=!1)=>{if(!e)return;let r=(0,l.getUserLang)();try{return new Date(e).toLocaleDateString(r,{year:"numeric",month:"long",day:"numeric",timeZone:t?"UTC":void 0})}catch{return}},"formatDescription",0,e=>e?("string"==typeof e?e:c(e)).replace(/<\/?[^>]+(>|$)/g,"").replace(/&#\d+;/g,"").trim():"","formatLanguage",0,e=>Array.isArray(e)?e.map(h).join(", "):h(e||""),"formatPublisher",0,e=>"string"==typeof e?e:c(e),"formatTitle",0,e=>"string"==typeof e?e:c(e),"getBookDirFromLanguage",0,e=>{let t=g(e)||"";return(0,o.getDirFromLanguage)(t)},"getBookDirFromWritingMode",0,e=>{switch(e){case"horizontal-tb":return"ltr";case"horizontal-rl":case"vertical-rl":return"rtl";default:return"auto"}},"getBookLangCode",0,f,"getConfigFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,"");return`${t}/config.json`},"getCoverFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);let t=e.relativePath.replace(/\.[^.]+$/,""),r=`${t}/cover.png`;return console.log("[getCoverFilename] ✓ Using relativePath:",e.relativePath),console.log("[getCoverFilename] ✓ Cover path result:",r),r},"getCurrentPage",0,(e,t)=>{let r=e.format,{section:i,pageinfo:a}=t;return"PDF"===r?i?i.current+1:0:a?a.current+1:0},"getDir",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath.replace(/\.[^.]+$/,"")},"getLibraryBackupFilename",0,()=>"library_backup.json","getLibraryFilename",0,()=>"library.json","getLocalBookFilename",0,e=>{if(!e.relativePath)throw Error(`Book ${e.title} (${e.hash}) is missing relativePath. Please re-import the book.`);return e.relativePath},"getMetadataHash",0,e=>{try{var t;let r,i=(r=e.title,"string"==typeof r?r:c(r,!0)),a=(!(t=e.author)?[]:Array.isArray(t)?t.map(e=>"string"==typeof e?e:c(e?.name,!0)).filter(Boolean):["string"==typeof t?t:c(t?.name,!0)]).join(","),n=(e=>{if(!e)return[];if(Array.isArray(e)){let t=(e=>{for(let t of["uuid","calibre","isbn"]){let r=e.find(e=>"string"==typeof e?e.toLowerCase().includes(t):e.scheme.toLowerCase()===t);if(r)return"string"==typeof r?w(r):r.value}})(e);if(t)return[t]}return Array.isArray(e)?e.map(e=>"string"==typeof e?w(e):e.value).filter(Boolean):"string"==typeof e?[w(e)]:[e.value]})(e.altIdentifier||e.identifier).join(","),l=`${i}|${a}|${n}`;return(0,u.md5)(l.normalize("NFC"))}catch(e){console.error("Error generating metadata hash:",e)}},"getPrimaryLanguage",0,g,"listFormater",0,d],955066)},168375,e=>{"use strict";var t=e.i(374517),r=e.i(7284),i=e.i(917409),a=e.i(981441),n=e.i(305133);e.s(["Toast",0,()=>{let{safeAreaInsets:e}=(0,a.useThemeStore)(),[l,o]=(0,i.useState)(""),[s,u]=(0,i.useState)("info"),[c,d]=(0,i.useState)(5e3),[f,p]=(0,i.useState)(""),[m,h]=(0,i.useState)(!1),g=(0,i.useRef)(null),w={info:"toast-info toast-center toast-middle",success:"toast-success toast-top sm:toast-end toast-center",warning:"toast-warning toast-top sm:toast-end toast-center",error:"toast-error toast-top sm:toast-end toast-center"},y={info:(0,t.jsx)("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),success:(0,t.jsx)("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),warning:(0,t.jsx)("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),error:(0,t.jsx)("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})};(0,i.useEffect)(()=>{l&&setTimeout(()=>{h(!0)},0)},[l]),(0,i.useEffect)(()=>{if(g.current&&clearTimeout(g.current),l){let e=setTimeout(()=>{h(!1),setTimeout(()=>o(""),300)},c);return g.current=e,()=>{e&&clearTimeout(e)}}},[l,c]);let b=async e=>{let{message:t,type:r="info",timeout:i,className:a="",callback:n=null}=e.detail;o(t),u(r),i&&d(i),n&&"function"==typeof n&&setTimeout(()=>n(),i||5e3),p(a)};return(0,i.useEffect)(()=>(n.eventDispatcher.on("toast",b),()=>{n.eventDispatcher.off("toast",b)}),[]),l&&(0,t.jsx)("div",{className:(0,r.default)("toast z-50 w-auto max-w-screen-sm transition-all duration-300",w[s],m?"scale-100 opacity-100":"scale-95 opacity-0"),style:{top:w[s].includes("toast-top")?`${(e?.top||0)+44}px`:void 0},children:(0,t.jsxs)("div",{className:(0,r.default)("alert flex items-center gap-3 shadow-2xl backdrop-blur-sm","min-h-0 rounded-2xl px-5 py-4","not-eink:bg-gradient-to-r border-0",{info:"alert-primary border-base-300",success:"alert-success not-eink:from-green-500 not-eink:to-emerald-500",warning:"alert-warning not-eink:from-amber-500 not-eink:to-orange-500",error:"alert-error not-eink:from-red-500 not-eink:to-rose-500"}[s],"eink:bg-base-100 eink:border eink:border-base-content","info"!==s&&"text-white"),children:[(0,t.jsx)("div",{className:"flex-shrink-0",children:y[s]}),(0,t.jsx)("span",{className:(0,r.default)("max-h-[50vh] flex-1 overflow-y-auto","font-sans text-base font-medium leading-snug sm:text-sm","info"===s?"max-w-[60vw] truncate sm:max-w-[80vw]":"min-w-[60vw] max-w-[80vw] whitespace-normal break-words sm:min-w-40 sm:max-w-80",f),children:l.split("\n").map((e,r)=>(0,t.jsxs)(i.default.Fragment,{children:[e||(0,t.jsx)(t.Fragment,{children:" "}),r<l.split("\n").length-1&&(0,t.jsx)("br",{})]},r))}),(0,t.jsx)("button",{onClick:()=>{h(!1),setTimeout(()=>o(""),300),g.current&&clearTimeout(g.current)},className:(0,r.default)("flex-shrink-0 rounded-lg p-1 transition-colors","info"===s?"hover:bg-base-300":"hover:bg-white/20 active:bg-white/30"),"aria-label":"Dismiss",children:(0,t.jsx)("svg",{className:"h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:(0,t.jsx)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]})})}])},647735,e=>{"use strict";e.i(553438);var t=e.i(503523),r=e.i(841964),i=e.i(141886),a=e.i(262504);let n=0,l=(e,i)=>{let a=(0,t.getCurrentWindow)().label,l=new r.WebviewWindow(`${"main"===a?"reader":a}-${n}`,{url:i,width:800,height:600,center:!0,resizable:!0,title:e.isMacOSApp?"":"Readest",decorations:!!e.isMacOSApp,transparent:!e.isMacOSApp,shadow:!e.isMacOSApp||void 0,titleBarStyle:e.isMacOSApp?"overlay":void 0});l.once("tauri://created",()=>{console.log("new window created"),n+=1}),l.once("tauri://error",e=>{console.error("error creating window",e)}),l.once("tauri://destroyed",()=>{n-=1})};e.s(["navigateToLibrary",0,(e,t,r,i)=>{let a=sessionStorage.getItem("lastLibraryParams");i&&a&&(t=a),e.replace(`/library${t?`?${t}`:""}`,r)},"navigateToLogin",0,e=>{let t=window.location.pathname,r=window.location.search;e.push(`/auth?redirect=${encodeURIComponent("/auth"!==t?t+r:"/")}`)},"navigateToProfile",0,e=>{e.push("/user")},"navigateToReader",0,(e,t,r,n)=>{let l=t.join(a.BOOK_IDS_SEPARATOR);if((0,i.isWebAppPlatform)()&&!(0,i.isPWA)())e.push(`/reader/${l}${r?`?${r}`:""}`,n);else{let t=new URLSearchParams(r||"");t.set("ids",l),e.push(`/reader?${t.toString()}`,n)}},"showLibraryWindow",0,(e,t)=>{let r=new URLSearchParams;t.forEach(e=>r.append("file",e)),l(e,`/library?${r.toString()}`)},"showReaderWindow",0,(e,t)=>{let r=t.join(a.BOOK_IDS_SEPARATOR),i=new URLSearchParams("");i.set("ids",r),l(e,`/reader?${i.toString()}`)}])},20414,e=>{"use strict";var t=e.i(128818),r=e.i(871611);let i=(0,t.create)((t,i)=>({appService:void 0,isTrafficLightVisible:!1,shouldShowTrafficLight:!1,trafficLightInFullscreen:!1,initializeTrafficLightStore:e=>{t({appService:e,isTrafficLightVisible:e.hasTrafficLight,shouldShowTrafficLight:e.hasTrafficLight})},setTrafficLightVisibility:async(i,a)=>{let{getCurrentWindow:n}=await e.A(888741),l=n(),o=await l.isFullscreen();t({isTrafficLightVisible:!o&&i,shouldShowTrafficLight:i,trafficLightInFullscreen:o}),(0,r.invoke)("set_traffic_lights",{visible:i,x:a?.x??10,y:a?.y??22})},initializeTrafficLightListeners:async()=>{let{getCurrentWindow:r}=await e.A(888741),a=r(),n=await a.listen("will-enter-fullscreen",()=>{t({isTrafficLightVisible:!1,trafficLightInFullscreen:!0})}),l=await a.listen("will-exit-fullscreen",()=>{let{shouldShowTrafficLight:e}=i();t({isTrafficLightVisible:e,trafficLightInFullscreen:!1})});t({unlistenEnterFullScreen:n,unlistenExitFullScreen:l})},cleanupTrafficLightListeners:()=>{let{unlistenEnterFullScreen:e,unlistenExitFullScreen:r}=i();e&&e(),r&&r(),t({unlistenEnterFullScreen:void 0,unlistenExitFullScreen:void 0})}}));e.s(["useTrafficLightStore",0,i])},345598,e=>{"use strict";var t=e.i(503523),r=e.i(283683),i=e.i(44438),a=e.i(897755),n=e.i(305133);let l=async()=>{let e=(0,t.getCurrentWindow)(),r=await e.scaleFactor(),i=await e.outerPosition();return{x:i.x/r,y:i.y/r}},o=async()=>{(0,t.getCurrentWindow)().minimize()},s=async()=>{let e=await (0,t.getCurrentWindow)().innerSize();e.width-=1,e.height-=1,await (0,t.getCurrentWindow)().setSize(e),setTimeout(async()=>{let e=await (0,t.getCurrentWindow)().innerSize();e.width+=1,e.height+=1,await (0,t.getCurrentWindow)().setSize(e)},100)},u=async()=>{let e=(0,t.getCurrentWindow)();await e.isFullscreen()?(await e.setFullscreen(!1),await e.unmaximize()):await e.toggleMaximize(),await (0,a.type)()==="linux"&&s()},c=async()=>{(0,t.getCurrentWindow)().close()},d=async e=>{let i=(0,t.getCurrentWindow)();return await i.onCloseRequested(async t=>{t.preventDefault(),await e(),i.label.startsWith("reader")?(await (0,r.emitTo)("main","close-reader-window",{label:i.label}),setTimeout(()=>i.destroy(),300)):"main"===i.label&&await i.destroy()})},f=async()=>{let e=(0,t.getCurrentWindow)(),r=await e.isFullscreen();await e.isMaximized()?await e.unmaximize():await e.setFullscreen(!r),await (0,a.type)()==="linux"&&s()},p=async e=>{let r=(0,t.getCurrentWindow)();await r.setAlwaysOnTop(e)},m=async()=>{await n.eventDispatcher.dispatch("quit-app"),await (0,i.exit)(0)};e.s(["tauriGetWindowLogicalPosition",0,l,"tauriHandleClose",0,c,"tauriHandleMinimize",0,o,"tauriHandleOnCloseWindow",0,d,"tauriHandleSetAlwaysOnTop",0,p,"tauriHandleToggleFullScreen",0,f,"tauriHandleToggleMaximize",0,u,"tauriQuitApp",0,m])},675788,e=>{"use strict";var t=e.i(374517),r=e.i(7284),i=e.i(917409),a=e.i(96508),n=e.i(345598),l=e.i(141886),o=e.i(604111);let s=({onClick:e,label:r,id:i,children:a})=>(0,t.jsx)("button",{id:i,onClick:e,className:"window-button bg-base-200/35 hover:bg-base-200 text-base-content/85 hover:text-base-content","aria-label":r,children:a});e.s(["default",0,({className:u,headerRef:c,showMinimize:d=!0,showMaximize:f=!0,showClose:p=!0,onMinimize:m,onToggleMaximize:h,onClose:g})=>{let w=(0,o.useTranslation)(),y=(0,i.useRef)(null),{appService:b}=(0,a.useEnv)(),x=(0,i.useRef)({lastPointerTime:0,pointerStartPosition:{x:0,y:0},isDragging:!1}),v=e=>e.closest(".btn")||e.closest(".window-button")||e.closest(".dropdown-container")||e.closest(".exclude-title-bar-mousedown"),A=async t=>{if(v(t.target))return;let{getCurrentWindow:r}=await e.A(888741);1===t.buttons&&(2===t.detail?r().toggleMaximize():r().startDragging())},L=async t=>{if(v(t.target)||"mouse"===t.pointerType)return;t.preventDefault();let r=Date.now(),i=r-x.current.lastPointerTime;if(x.current.pointerStartPosition={x:t.clientX,y:t.clientY},i<300){let{getCurrentWindow:t}=await e.A(888741);t().toggleMaximize();return}x.current.lastPointerTime=r,x.current.isDragging=!1},S=async t=>{if(v(t.target)||x.current.isDragging||"mouse"===t.pointerType)return;t.preventDefault();let r=Math.abs(t.clientX-x.current.pointerStartPosition.x),i=Math.abs(t.clientY-x.current.pointerStartPosition.y);if(r>5||i>5){x.current.isDragging=!0;try{let{getCurrentWindow:t}=await e.A(888741);await t().startDragging()}catch(e){console.warn("Failed to start window dragging:",e)}}},C=()=>{x.current.isDragging=!1};(0,i.useEffect)(()=>{if(!(0,l.isTauriAppPlatform)())return;let e=c?.current;if(e)return e.addEventListener("mousedown",A),e.addEventListener("pointerdown",L),e.addEventListener("pointermove",S),e.addEventListener("pointerup",C),e.addEventListener("pointercancel",C),()=>{e.removeEventListener("mousedown",A),e.removeEventListener("pointerdown",L),e.removeEventListener("pointermove",S),e.removeEventListener("pointerup",C),e.removeEventListener("pointercancel",C)}},[]);let T=async()=>{m?m():(0,n.tauriHandleMinimize)()},P=async()=>{h?h():(0,n.tauriHandleToggleMaximize)()},E=async()=>{g?g():(0,n.tauriHandleClose)()};return(0,t.jsxs)("div",{ref:y,className:(0,r.default)("window-buttons flex h-8 items-center justify-end space-x-2",p||f||d?"visible":"hidden",u),children:[d&&b?.hasWindowBar&&(0,t.jsx)(s,{onClick:T,label:w("Minimize"),id:"titlebar-minimize",children:(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{fill:"currentColor",d:"M20 14H4v-2h16"})})}),f&&b?.hasWindowBar&&(0,t.jsx)(s,{onClick:P,label:w("Maximize or Restore"),id:"titlebar-maximize",children:(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{fill:"currentColor",d:"M4 4h16v16H4zm2 4v10h12V8z"})})}),p&&(b?.hasWindowBar||g)&&(0,t.jsx)(s,{onClick:E,label:w("Close"),id:"titlebar-close",children:(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"})})})]})}])},463969,e=>{"use strict";let t="http://www.w3.org/2005/Atom",r="http://opds-spec.org/2010/catalog",i="application/atom+xml",a=["http://opds-spec.org/image","http://opds-spec.org/cover"],n=["http://opds-spec.org/image/thumbnail","http://opds-spec.org/thumbnail"],l={SUMMARY:Symbol("summary"),CONTENT:Symbol("content")},o=Symbol("facetGroup"),s=(e,t)=>{let r=new Map;if(e)for(let i of e)for(let e of[t(i)].flat()){let t=r.get(e);t?t.push(i):r.set(e,[i])}return r},u=e=>{if(!e)return null;let[t,...r]=e.split(/ *; */);return{mediaType:t.toLowerCase(),parameters:Object.fromEntries(r.map(e=>{let[t,r]=e.split("=");return[t.toLowerCase(),r?.replace(/(^"|"$)/g,"")]}))}},c=e=>{let t=u(e);if(!t)return!1;let{mediaType:r,parameters:a}=t;return"application/opds+json"===r||r===i&&a.profile?.toLowerCase()==="opds-catalog"},d=(e,t)=>e.lookupNamespaceURI(null)===t||e.lookupPrefix(t)?t:null,f=e=>e?t=>r=>r.namespaceURI===e&&r.localName===t:e=>t=>t.localName===e,p=e=>{if(!e)return;let t=e.getAttribute("type")??"text";return{value:"xhtml"===t?e.innerHTML:"html"===t?e.textContent.replaceAll("&lt;","<").replaceAll("&gt;",">").replaceAll("&amp;","&"):e.textContent,type:t}},m=e=>{let t=p(e);if(t?.type==="text")return t?.value},h=(e,t)=>m(e)??m(t),g=e=>{let t=e.getElementsByTagNameNS(r,"indirectAcquisition")[0];return t?[{type:t.getAttribute("type")},...g(t)]:[]},w=e=>{let t,i={rel:e.getAttribute("rel")?.split(/ +/),href:e.getAttribute("href"),type:e.getAttribute("type"),title:e.getAttribute("title"),properties:{price:(t=e.getElementsByTagNameNS(r,"price")[0])?{currency:t.getAttribute("currencycode"),value:t.textContent}:null,indirectAcquisition:g(e),numberOfItems:e.getAttributeNS("http://purl.org/syndication/thread/1.0","count")},[o]:e.getAttributeNS(r,"facetGroup")};return"true"===e.getAttributeNS(r,"activeFacet")&&(i.rel=[i.rel??[]].flat().concat("self")),i},y=e=>{let t=e.namespaceURI,r=e.getElementsByTagNameNS(t,"uri")[0]?.textContent;return{name:e.getElementsByTagNameNS(t,"name")[0]?.textContent??"",links:r?[{href:r}]:[]}},b=e=>{let r=f(d(e.ownerDocument,t)),i=Array.from(e.children),o=f("http://purl.org/dc/elements/1.1/"),u=f("http://purl.org/dc/terms/"),c=e=>{let t=o(e),r=u(e);return e=>t(e)||r(e)},m=i.filter(r("link")).map(w),h=s(m,e=>e.rel);return{metadata:{title:i.find(r("title"))?.textContent??"",author:i.filter(r("author")).map(y),contributor:i.filter(r("contributor")).map(y),publisher:i.find(c("publisher"))?.textContent,published:(i.find(u("issued"))??i.find(c("date")))?.textContent,language:i.find(c("language"))?.textContent,identifier:i.find(c("identifier"))?.textContent,subject:i.filter(r("category")).map(e=>({name:e.getAttribute("label"),code:e.getAttribute("term"),scheme:e.getAttribute("scheme")})),rights:i.find(r("rights"))?.textContent??"",[l.CONTENT]:p(i.find(r("content"))??i.find(r("summary")))},links:m,images:a.concat(n).map(e=>h.get(e)?.[0]).filter(e=>e)}};e.s(["getFeed",0,e=>{let r=f(d(e,t)),i=Array.from(e.documentElement.children),a=i.filter(r("entry")),n=i.filter(r("link")).map(w),u=s(n,e=>e.rel),p=new Map([[null,[]]]),m=new Map;for(let e of a){let t=Array.from(e.children),i=t.filter(r("link")).map(w),a=s(i,e=>e.rel),n=[...a.keys()].some(e=>e?.startsWith("http://opds-spec.org/acquisition")||"preview"===e),o=a.get("http://opds-spec.org/group")??a.get("collection"),u=o?.length?o.find(e=>p.has(e.href))??o[0]:null;u&&!m.has(u.href)&&m.set(u.href,u);let d=n?b(e):Object.assign(i.find(e=>c(e.type))??i[0]??{},{title:t.find(r("title"))?.textContent,[l.SUMMARY]:h(t.find(r("summary")),t.find(r("content")))}),f=p.get(u?.href??null);f?f.push(d):p.set(u.href,[d])}let[g,...y]=Array.from(p,([e,t])=>{let r=t[0]?.metadata?"publications":"navigation";if(null==e)return{[r]:t};let i=m.get(e);return{metadata:{title:i.title,numberOfItems:i.properties.numberOfItems},links:[{rel:"self",href:i.href,type:i.type}],[r]:t}});return{metadata:{title:i.find(r("title"))?.textContent,subtitle:i.find(r("subtitle"))?.textContent},links:n,...g,groups:y,facets:Array.from(s(u.get("http://opds-spec.org/facet")??[],e=>e[o]),([e,t])=>({metadata:{title:e},links:t}))}},"getOpenSearch",0,e=>{let t=e.documentElement.namespaceURI,r=f(t),a=Array.from(e.documentElement.children),n=a.filter(r("Url")),l=n.find(e=>c(e.getAttribute("type")))??n.find(e=>(e=>{let t=u(e);if(!t)return!1;let{mediaType:r}=t;return r===i})(e.getAttribute("type")))??n[0];if(!l)throw Error("document must contain at least one Url element");let o=/{(?:([^}]+?):)?(.+?)(\?)?}/g,s=new Map([["count","100"],["startIndex",l.getAttribute("indexOffset")??"0"],["startPage",l.getAttribute("pageOffset")??"0"],["language","*"],["inputEncoding","UTF-8"],["outputEncoding","UTF-8"]]),d=l.getAttribute("template");return{metadata:{title:(a.find(r("LongName"))??a.find(r("ShortName")))?.textContent,description:a.find(r("Description"))?.textContent},search:e=>d.replace(o,(r,i,a)=>{let n=i?l.lookupNamespaceURI(i):null,o=n===t?null:n;return encodeURIComponent(e.get(o)?.get(a)||(o?"":s.get(a)??""))}),params:Array.from(d.matchAll(o),([,e,r,i])=>{let a=e?l.lookupNamespaceURI(e):null,n=a===t?null:a;return{ns:n,name:r,required:!i,value:n&&n!==t?"":s.get(r)??""}})}},"getPublication",0,b,"isOPDSCatalog",0,c])},769217,e=>{"use strict";var t=e.i(141886);e.i(624098),e.i(98249);var r=e.i(341612);let i={upload:(0,t.getAPIBaseUrl)()+"/storage/upload",download:(0,t.getAPIBaseUrl)()+"/storage/download",delete:(0,t.getAPIBaseUrl)()+"/storage/delete",stats:(0,t.getAPIBaseUrl)()+"/storage/stats",list:(0,t.getAPIBaseUrl)()+"/storage/list",purge:(0,t.getAPIBaseUrl)()+"/storage/purge",scan:(0,t.getAPIBaseUrl)()+"/storage/scan",import:(0,t.getAPIBaseUrl)()+"/storage/import"},a=async(e,t)=>{let r=await fetch(e,t);if(!r.ok){let e=r.statusText;try{e=(await r.json()).error||e}catch{}throw Error(e||"Request failed")}return r},n=async e=>e,l=async({appService:e,dst:l,cfp:o,url:s,headers:u,singleThreaded:c,skipSslVerification:d,onProgress:f})=>{try{let p=s;if(!p){let e=await n(o),t=await a(`${i.download}?fileKey=${encodeURIComponent(e)}`,{method:"GET"}),{downloadUrl:r}=await t.json();p=r}if(!p)throw Error("No download URL available");if(!(0,t.isWebAppPlatform)())return await (0,r.tauriDownload)(p,l,f,u,void 0,c,d);{let{headers:t,blob:i}=await (0,r.webDownload)(p,f,u);return await e.writeFile(l,"None",await i.arrayBuffer()),t}}catch(e){throw console.error(`File '${l}' download failed:`,e),e}},o=async()=>{try{let e=await a(i.scan,{method:"POST"});return await e.json()}catch(e){throw console.error("Scan books failed:",e),Error("Scan books failed")}};e.s(["downloadFile",0,l,"scanBooks",0,o])},271947,358031,e=>{"use strict";var t,r=e.i(463969),i=e.i(835106),a=e.i(805143),n=e.i(141886),l=e.i(931955),o=e.i(262504);let s=`${(0,n.getAPIBaseUrl)()}/opds/proxy`,u=`${(0,n.getNodeAPIBaseUrl)()}/opds/proxy`,c=e=>{try{let t=new URL(e),r=decodeURIComponent(t.username)||void 0,i=decodeURIComponent(t.password)||void 0;if(r||i)return t.username="",t.password="",{url:t.toString(),username:r,password:i}}catch(e){console.warn("Failed to parse URL:",e)}return{url:e}},d={standardebooks:u},f=(e,t="",r=!1)=>{if(e.startsWith("http")){let{url:i}=c(e),a=new URLSearchParams;a.append("url",i),a.append("stream",`${r}`),t&&a.append("auth",t);let n=(e=>{for(let[t,r]of Object.entries(d))if(e.includes(t))return r;return s})(e);return`${n}?${a.toString()}`}return e},p=async(e,t,r,i,n)=>{let l,o,s,u,c,d,f=(e=>{let t,r={},i=/(\w+)=["']?([^"',]+)["']?/g;for(;null!==(t=i.exec(e));)r[t[1]]=t[2];return r})(r),p=Math.random().toString(36).slice(2),m="00000001",h=await (l=f.realm,o=f.nonce,s=f.qop,u=f.algorithm,c=(0,a.md5)(`${e}:${l}:${t}`),u&&"md5-sess"===u.toLowerCase()&&(c=(0,a.md5)(`${c}:${o}:${p}`)),d=(0,a.md5)(`${i}:${n}`),s?(0,a.md5)(`${c}:${o}:${m}:${p}:${s}:${d}`):(0,a.md5)(`${c}:${o}:${d}`)),g=[`username="${e}"`,`realm="${f.realm}"`,`nonce="${f.nonce}"`,`uri="${n}"`,`response="${h}"`];return f.algorithm&&g.push(`algorithm="${f.algorithm}"`),f.opaque&&g.push(`opaque="${f.opaque}"`),f.qop&&(g.push('qop="auth"'),g.push(`nc=${m}`),g.push(`cnonce="${p}"`)),`Digest ${g.join(", ")}`},m=(e,t)=>{let r=btoa(`${e}:${t}`);return`Basic ${r}`},h=async(e,t,r,i=!1)=>{let{url:a,username:s,password:u}=c(e),d=t||s,h=r||u;if(!d||!h)return null;let g=i?f(a):a,w={"User-Agent":o.READEST_OPDS_USER_AGENT,Accept:"application/atom+xml, application/xml, text/xml, */*"},y=(0,n.isTauriAppPlatform)()?l.fetch:window.fetch,b=await y(g,{method:"HEAD",headers:w,danger:{acceptInvalidCerts:!0,acceptInvalidHostnames:!0}});if(401===b.status||403===b.status){let e=b.headers.get("WWW-Authenticate");if(e)if(e.toLowerCase().startsWith("digest")){let t=new URL(a);return await p(d,h,e,"GET",t.pathname+t.search)}else e.toLowerCase().startsWith("basic")}return m(d,h)},g=async e=>{let t=e["content-disposition"];if(t){let e=t.match(/filename\*\s*=\s*(?:utf-8|UTF-8)'[^']*'([^;\s]+)/i);if(e?.[1])return decodeURIComponent(e[1]);let r=t.match(/filename\s*=\s*["']?([^"';\s]+)["']?/i);if(r?.[1])return decodeURIComponent(r[1])}return""},w=async(e,t,r,i=!1,a={})=>{let{url:s,username:u,password:d}=c(e),h=t||u,g=r||d,w=i?f(s):s,y={"User-Agent":o.READEST_OPDS_USER_AGENT,Accept:"application/atom+xml, application/xml, text/xml, */*",...a.headers},b=(0,n.isTauriAppPlatform)()?l.fetch:window.fetch,x=await b(w,{...a,method:a.method||"GET",headers:y,danger:{acceptInvalidCerts:!0,acceptInvalidHostnames:!0}});if(!x.ok&&(401===x.status||403===x.status)&&h&&g){let e=x.headers.get("WWW-Authenticate");if(e){let t=null;if(e.toLowerCase().startsWith("digest")){let r=new URL(s);t=await p(h,g,e,a.method||"GET",r.pathname+r.search)}else e.toLowerCase().startsWith("basic")&&(t=m(h,g));if(t){let e=i?`${w}&auth=${encodeURIComponent(t)}`:w;x=await b(e,{...a,method:a.method||"GET",headers:i?y:{...y,Authorization:t},danger:{acceptInvalidCerts:!0,acceptInvalidHostnames:!0}})}}}return x};e.s(["fetchWithAuth",0,w,"getProxiedURL",0,f,"needsProxy",0,e=>(0,n.isWebAppPlatform)()&&e.startsWith("http"),"probeAuth",0,h,"probeFilename",0,g],358031);let y={XML:"application/xml",ATOM:"application/atom+xml",XHTML:"application/xhtml+xml",HTML:"text/html",EPUB:"application/epub+zip",PDF:"application/pdf",OPENSEARCH:"application/opensearchdescription+xml"};(t={}).INVALID_URL="Invalid URL format",t.LOAD_FAILED="Failed to load OPDS feed",t.NOT_OPDS="Invalid OPDS feed URL",t.NO_OPDS_LINK="Document has no link to OPDS feeds",t.NO_HREF="OPDS link has no href attribute",t.INVALID_HTML="Invalid HTML document",t.INVALID_CONTENT="Content is neither valid XML nor JSON";let b=e=>{if(!e)return null;let[t,...r]=e.split(/ *; */);return t?{mediaType:t.toLowerCase(),parameters:Object.fromEntries(r.map(e=>{let[t,r]=e.split("=");return t?[t.toLowerCase(),r?.replace(/(^"|"$)/g,"")]:null}).filter(e=>null!==e))}:null},x=(e,t)=>{if(!e)return"";if(t.includes("/api/opds/proxy?url="))return x(e,new URLSearchParams(t.split("?")[1]).get("url")||"");try{if(t.includes(":"))return new URL(e,t).toString();let r="https://invalid.invalid/",i=new URL(e,r+t);return i.search="",decodeURI(i.href.replace(r,""))}catch(t){return console.warn(t),e}},v=async(e,t,i,a=!1)=>{try{let n=new AbortController,l=setTimeout(()=>n.abort(),1e4),o=await w(e,t,i,a,{signal:n.signal});if(clearTimeout(l),!o.ok){if(401===o.status)return{isValid:!1,error:"Authentication required. Please check your username and password."};return{isValid:!1,error:`Failed to load OPDS feed: ${o.status} ${o.statusText}`}}let s=o.url,u=await o.text();if(u.startsWith("<")){let e=new DOMParser().parseFromString(u,y.XML),{documentElement:{localName:t}}=e;if("feed"===t)return{isValid:!0,data:{type:"feed",doc:e,text:u,responseURL:s}};{if("entry"===t)return{isValid:!0,data:{type:"entry",doc:e,text:u,responseURL:s}};if("OpenSearchDescription"===t)return{isValid:!0,data:{type:"opensearch",doc:e,text:u,responseURL:s}};let i=o.headers.get("Content-Type")??y.HTML,a=b(i)?.mediaType??y.HTML,n=new DOMParser().parseFromString(u,a);if(!n.head)return{isValid:!1,error:"Invalid OPDS feed URL"};let l=Array.from(n.head.querySelectorAll("link")).find(e=>(0,r.isOPDSCatalog)(e.getAttribute("type")??""));if(!l)return{isValid:!1,error:"Invalid OPDS feed URL"};if(!l.getAttribute("href"))return{isValid:!1,error:"OPDS link has no href attribute"};return{isValid:!0,data:{type:"html",doc:n,text:u,responseURL:s}}}}try{let e=JSON.parse(u);if(!e.metadata&&!e.links&&!e.publications&&!e.navigation)return{isValid:!1,error:"Invalid OPDS feed URL"};return{isValid:!0,data:{type:"feed",doc:new Document,text:u,responseURL:s}}}catch{return{isValid:!1,error:"Invalid OPDS feed URL"}}}catch(e){return console.error("OPDS validation error:",e),{isValid:!1,error:e instanceof Error?e.message:"Invalid OPDS feed URL"}}};e.s(["MIME",0,y,"getFileExtFromPath",0,(e,t="/")=>{let r=e.split(t);for(let e of Object.values(i.EXTS))if(r.includes(e))return e;return""},"groupByArray",0,(e,t)=>{let r=new Map;if(e)for(let i of e)for(let e of[t(i)].flat()){let t=r.get(e);t?t.push(i):r.set(e,[i])}return r},"isSearchLink",0,e=>(Array.isArray(e.rel)?e.rel:[e.rel||""]).includes("search")&&(e.type===y.OPENSEARCH||e.type===y.ATOM),"parseMediaType",0,b,"resolveURL",0,x,"validateOPDSURL",0,v],271947)}]);