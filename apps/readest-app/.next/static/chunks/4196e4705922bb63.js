(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,542436,e=>{"use strict";var i=e.i(119322),t=e.i(465454),a=e.i(308795),r=e.i(194934);async function s(e={}){return"object"==typeof e&&Object.freeze(e),await (0,r.invoke)("plugin:dialog|open",{options:e})}async function o(e={}){return"object"==typeof e&&Object.freeze(e),await (0,r.invoke)("plugin:dialog|save",{options:e})}var n=e.i(349114);async function l(e,i){await (0,r.invoke)("plugin:sharekit|share_file",{url:e,...i})}var c=e.i(431187),h=e.i(528934),p=e.i(883228),d=e.i(316217);let w=async(e,i,t)=>{let a=[];try{a=await e.readDirectory(i,"None")}catch{throw Error(`Dir ${i} failed to read.`)}for(let r=0;r<a.length;r++){let s=a[r],o=`${i}/${s.path}`,n=`${t}/${s.path}`;await e.copyFile(o,n,"None")}let r=await e.readDirectory(t,"None");for(let e of a)if(!r.find(i=>i.path===e.path&&i.size===e.size))throw Error(`File ${e.path} failed to copy.`)};var u=e.i(19347),f=e.i(481959);let D=null,y=()=>(null===D&&(D=(0,n.type)()),D),v=({customRootDir:e,isPortable:i,execDir:t}={})=>{let r=e?0:void 0,s=!!e,o=s?i=>()=>{let t=["Settings","Data","Books","Fonts","Images"].includes(i)?"":i;return t?`${e}/${t}`:e}:void 0,n=o?e=>async()=>o(e)():void 0;return(e,l)=>{let c=o?.(l),h=n?.(l);switch(l){case"Settings":return{baseDir:i?0:a.BaseDirectory.AppConfig,basePrefix:i&&t?async()=>t:a.appConfigDir,fp:i&&t?`${t}${e?`/${e}`:""}`:e,base:l};case"Cache":return{baseDir:a.BaseDirectory.AppCache,basePrefix:a.appCacheDir,fp:e,base:l};case"Log":return{baseDir:s?0:a.BaseDirectory.AppLog,basePrefix:h??a.appLogDir,fp:c?`${c()}${e?`/${e}`:""}`:e,base:l};case"Data":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h??a.appDataDir,fp:c?`${c()}/${f.DATA_SUBDIR}${e?`/${e}`:""}`:`${f.DATA_SUBDIR}${e?`/${e}`:""}`,base:l};case"Books":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h||a.appDataDir,fp:c?`${c()}/${f.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`:`${f.LOCAL_BOOKS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Fonts":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h||a.appDataDir,fp:c?`${c()}/${f.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`:`${f.LOCAL_FONTS_SUBDIR}${e?`/${e}`:""}`,base:l};case"Images":return{baseDir:r??a.BaseDirectory.AppData,basePrefix:h||a.appDataDir,fp:c?`${c()}/${f.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`:`${f.LOCAL_IMAGES_SUBDIR}${e?`/${e}`:""}`,base:l};case"None":return{baseDir:0,basePrefix:async()=>"",fp:e,base:l};default:return{baseDir:a.BaseDirectory.Temp,basePrefix:a.tempDir,fp:e,base:l}}}},g={resolvePath:v(),async getPrefix(e){let{basePrefix:i,fp:t,baseDir:r}=this.resolvePath("",e),s=await i();return s=s.replace(/\/+$/,""),t?0===r?t:await (0,a.join)(s,t):s},getURL:e=>(0,c.isValidURL)(e)?e:(0,r.convertFileSrc)(e),async getBlobURL(e,i){let t=await this.readFile(e,i,"binary");return URL.createObjectURL(new Blob([t]))},async getImageURL(e){return this.getURL(e)},async openFile(e,i,t){let{fp:r,baseDir:s}=this.resolvePath(e,i),o=t||(0,h.getFilename)(r);if((0,c.isValidURL)(e))return await new p.RemoteFile(e,o).open();if((0,c.isContentURI)(e)||(0,c.isFileURI)(e)&&"ios"===y()){if(o=await (0,a.basename)(e),e.includes("com.android.externalstorage"))return await new p.NativeFile(r,o,s||null).open();{let i=await this.getPrefix("Cache"),t=await (0,a.join)(i,decodeURIComponent(o)),r=await (0,d.copyURIToPath)({uri:e,dst:t});if(!r.success)throw console.error("Failed to open file:",r),Error("Failed to open file");return await new p.NativeFile(t,o,s||null).open()}}{if((0,c.isFileURI)(e)||"android"===y())return await new p.NativeFile(r,o,s||null).open();let t=await this.getPrefix(i),n=t?await (0,a.join)(t,e):e;return await new p.RemoteFile(this.getURL(n),o).open()}},async copyFile(e,i,r){try{await this.exists((0,h.getDirPath)(i),r)||await this.createDir((0,h.getDirPath)(i),r,!0)}catch(e){console.log("Failed to create directory for copying file:",e)}if((0,c.isContentURI)(e)){let t=await this.getPrefix(r);if(!t)throw Error("Invalid base directory");let s=await (0,d.copyURIToPath)({uri:e,dst:await (0,a.join)(t,i)});if(!s.success)throw console.error("Failed to copy file:",s),Error("Failed to copy file")}else{let{fp:a,baseDir:s}=this.resolvePath(i,r);await (0,t.copyFile)(e,a,s?{toPathBaseDir:s}:void 0)}},async readFile(e,i,a){let{fp:r,baseDir:s}=this.resolvePath(e,i);return"text"===a?(0,t.readTextFile)(r,s?{baseDir:s}:void 0):(await (0,t.readFile)(r,s?{baseDir:s}:void 0)).buffer},async writeFile(e,i,a){let{fp:r,baseDir:s}=this.resolvePath(e,i);return(await this.exists((0,h.getDirPath)(e),i)||await this.createDir((0,h.getDirPath)(e),i,!0),"string"==typeof a)?(0,t.writeTextFile)(r,a,s?{baseDir:s}:void 0):a instanceof File?await (0,t.writeFile)(r,a.stream(),{write:!0,create:!0,baseDir:s||void 0}):await (0,t.writeFile)(r,new Uint8Array(a),s?{baseDir:s}:void 0)},async removeFile(e,i){let{fp:a,baseDir:r}=this.resolvePath(e,i);await (0,t.remove)(a,r?{baseDir:r}:void 0)},async createDir(e,i,a=!1){let{fp:r,baseDir:s}=this.resolvePath(e,i);await (0,t.mkdir)(r,{baseDir:s||void 0,recursive:a})},async removeDir(e,i,a=!1){let{fp:r,baseDir:s}=this.resolvePath(e,i);await (0,t.remove)(r,{baseDir:s||void 0,recursive:a})},async readDir(e,i){let{fp:s,baseDir:o}=this.resolvePath(e,i);if(!o||0===o)try{return(await (0,r.invoke)("read_dir",{path:s,recursive:!0,extensions:["*"]})).map(e=>{var i;let t;return{path:(i=e.path,t=i,i.toLowerCase().startsWith(s.toLowerCase())&&(t=i.substring(s.length)),(t.startsWith("\\")||t.startsWith("/"))&&(t=t.substring(1)),t),size:e.size}})}catch(e){console.error("Rust read_dir failed, falling back to JS recursion",e)}let n=await (0,t.readDir)(s,o?{baseDir:o}:void 0),l=[],c=async(e,i,r,s)=>{for(let n of r)if(n.isDirectory){let r=await (0,a.join)(e,n.name),l=i?await (0,a.join)(i,n.name):n.name;try{let e=await (0,t.readDir)(r,o?{baseDir:o}:void 0);await c(r,l,e,s)}catch{console.warn(`Skipping unreadable dir: ${r}`)}}else{let r=await (0,a.join)(e,n.name),l=i?await (0,a.join)(i,n.name):n.name,c=o?{baseDir:o}:void 0,h=await (0,t.stat)(r,c).then(e=>e.size).catch(()=>0);s.push({path:l,size:h})}};return await c(s,"",n,l),l},async exists(e,i){let{fp:a,baseDir:r}=this.resolvePath(e,i);try{return await (0,t.exists)(a,r?{baseDir:r}:void 0)}catch{return!1}},async stats(e,i){let{fp:a,baseDir:r}=this.resolvePath(e,i);return await (0,t.stat)(a,r?{baseDir:r}:void 0)}},A=i.default.env.NEXT_PUBLIC_DIST_CHANNEL||"readest";class P extends u.BaseAppService{fs=g;appPlatform="tauri";isAppDataSandbox=!1;isMobile=!1;isAndroidApp=!1;isIOSApp=!1;isMacOSApp=!1;isLinuxApp=!1;isMobileApp=!1;isDesktopApp=!1;isEink=!!window.__READEST_IS_EINK;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir="appstore"!==A;canReadExternalDir="appstore"!==A&&"playstore"!==A;distChannel=A;execDir=void 0;async init(){if(!window.__TAURI__)throw Error("NativeAppService can only be initialized in Tauri environment");let e=y();this.isAppDataSandbox=["android","ios"].includes(e),this.isMobile=["android","ios"].includes(e),this.isAndroidApp="android"===e,this.isIOSApp="ios"===e,this.isMacOSApp="macos"===e,this.isLinuxApp="linux"===e,this.isMobileApp=["android","ios"].includes(e),this.isDesktopApp=["macos","windows","linux"].includes(e),this.hasTrafficLight="macos"===e,this.hasWindow="ios"!==e&&"android"!==e,this.hasWindowBar="ios"!==e&&"android"!==e,this.hasContextMenu="ios"!==e&&"android"!==e,this.hasRoundedWindow="linux"===e,this.hasSafeAreaInset="ios"===e||"android"===e,this.hasHaptics="ios"===e||"android"===e,this.hasUpdater="ios"!==e&&!i.default.env.NEXT_PUBLIC_DISABLE_UPDATER&&!window.__READEST_UPDATER_DISABLED,this.hasOrientationLock="ios"===e&&"ios"===(0,c.getOSPlatform)()||"android"===e,this.hasScreenBrightness="ios"===e||"android"===e,this.hasIAP="ios"===e||"android"===e&&"playstore"===A;let t=await (0,r.invoke)("get_executable_dir");this.execDir=t,(i.default.env.NEXT_PUBLIC_PORTABLE_APP||await this.fs.exists(`${t}/${f.SETTINGS_FILENAME}`,"None"))&&(this.isPortableApp=!0,this.fs.resolvePath=v({customRootDir:t,isPortable:this.isPortableApp,execDir:t}));let a=await this.loadSettings();a.customRootDir&&(this.fs.resolvePath=v({customRootDir:a.customRootDir,isPortable:this.isPortableApp,execDir:t})),await this.prepareBooksDir(),await this.runMigrations()}async runMigrations(){try{let e=await this.loadSettings(),i=e.migrationVersion||0;if(await super.runMigrations(i),i<0x1350195)try{await this.migrate20251029()}catch(e){console.error("Error migrating to version 20251029:",e)}i<this.CURRENT_MIGRATION_VERSION&&await this.saveSettings({...e,migrationVersion:this.CURRENT_MIGRATION_VERSION})}catch(e){console.error("Failed to run migrations:",e)}}resolvePath(e,i){return this.fs.resolvePath(e,i)}async setCustomRootDir(e){this.fs.resolvePath=v({customRootDir:e,isPortable:this.isPortableApp,execDir:this.execDir}),await this.prepareBooksDir()}async selectDirectory(){return await s({directory:!0,multiple:!1,recursive:!0})}async selectFiles(e,i){let t=await s({multiple:!0,filters:[{name:e,extensions:i}]});return Array.isArray(t)?t:t?[t]:[]}async saveFile(e,i,a,r){try{let s=e.split(".").pop()||"";if(this.isIOSApp)await l(a,{mimeType:r||"application/octet-stream"});else{let a=await o({defaultPath:e,filters:[{name:s.toUpperCase(),extensions:[s]}]});if(!a)return!1;"string"==typeof i?await (0,t.writeTextFile)(a,i):await (0,t.writeFile)(a,new Uint8Array(i))}return!0}catch(e){return console.error("Failed to save file:",e),!1}}async migrate20251029(){console.log("Running migration 20251029 to update paths in Images dir...");let e=await this.resolveFilePath("..","Data"),i=await this.fs.getPrefix("Images"),t=await (0,a.join)(e,"Images","Readest","Images");await w(this,t,i);let r=await (0,a.join)(e,"Images","Readest");await this.deleteDir(r,"None",!0)}}e.s(["NativeAppService",()=>P,"nativeFileSystem",0,g],542436)},367859,e=>{e.v(i=>Promise.all(["static/chunks/9adae417cfca96c8.js"].map(i=>e.l(i))).then(()=>i(153654)))}]);