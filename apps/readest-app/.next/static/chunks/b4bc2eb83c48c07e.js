(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,229435,898400,669770,e=>{"use strict";let t;e.i(99500);var i,a,r=e.i(871611);function o(e){return{isFile:e.isFile,isDirectory:e.isDirectory,isSymlink:e.isSymlink,size:e.size,mtime:null!==e.mtime?new Date(e.mtime):null,atime:null!==e.atime?new Date(e.atime):null,birthtime:null!==e.birthtime?new Date(e.birthtime):null,readonly:e.readonly,fileAttributes:e.fileAttributes,dev:e.dev,ino:e.ino,mode:e.mode,nlink:e.nlink,uid:e.uid,gid:e.gid,rdev:e.rdev,blksize:e.blksize,blocks:e.blocks}}(i=a||(a={}))[i.Start=0]="Start",i[i.Current=1]="Current",i[i.End=2]="End";class s extends r.Resource{async read(e){if(0===e.byteLength)return 0;let t=await (0,r.invoke)("plugin:fs|read",{rid:this.rid,len:e.byteLength}),i=function(e){let t=new Uint8ClampedArray(e),i=t.byteLength,a=0;for(let e=0;e<i;e++)a*=256,a+=t[e];return a}(t.slice(-8)),a=t instanceof ArrayBuffer?new Uint8Array(t):t;return e.set(a.slice(0,a.length-8)),0===i?null:i}async seek(e,t){return await (0,r.invoke)("plugin:fs|seek",{rid:this.rid,offset:e,whence:t})}async stat(){return o(await (0,r.invoke)("plugin:fs|fstat",{rid:this.rid}))}async truncate(e){await (0,r.invoke)("plugin:fs|ftruncate",{rid:this.rid,len:e})}async write(e){return await (0,r.invoke)("plugin:fs|write",{rid:this.rid,data:e})}}async function n(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return new s(await (0,r.invoke)("plugin:fs|open",{path:e instanceof URL?e.toString():e,options:t}))}async function l(e,t,i){if(e instanceof URL&&"file:"!==e.protocol||t instanceof URL&&"file:"!==t.protocol)throw TypeError("Must be a file URL.");await (0,r.invoke)("plugin:fs|copy_file",{fromPath:e instanceof URL?e.toString():e,toPath:t instanceof URL?t.toString():t,options:i})}async function c(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");await (0,r.invoke)("plugin:fs|mkdir",{path:e instanceof URL?e.toString():e,options:t})}async function h(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return await (0,r.invoke)("plugin:fs|read_dir",{path:e instanceof URL?e.toString():e,options:t})}async function f(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let i=await (0,r.invoke)("plugin:fs|read_file",{path:e instanceof URL?e.toString():e,options:t});return i instanceof ArrayBuffer?new Uint8Array(i):Uint8Array.from(i)}async function d(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let i=await (0,r.invoke)("plugin:fs|read_text_file",{path:e instanceof URL?e.toString():e,options:t}),a=i instanceof ArrayBuffer?i:Uint8Array.from(i);return new TextDecoder().decode(a)}async function g(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");await (0,r.invoke)("plugin:fs|remove",{path:e instanceof URL?e.toString():e,options:t})}async function u(e,t){return o(await (0,r.invoke)("plugin:fs|stat",{path:e instanceof URL?e.toString():e,options:t}))}async function p(e,t,i){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");if(t instanceof ReadableStream){let a=await n(e,{read:!1,create:!0,write:!0,...i}),r=t.getReader();try{for(;;){let{done:e,value:t}=await r.read();if(e)break;await a.write(t)}}finally{r.releaseLock(),await a.close()}}else await (0,r.invoke)("plugin:fs|write_file",t,{headers:{path:encodeURIComponent(e instanceof URL?e.toString():e),options:JSON.stringify(i)}})}async function m(e,t,i){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");let a=new TextEncoder;await (0,r.invoke)("plugin:fs|write_text_file",a.encode(t),{headers:{path:encodeURIComponent(e instanceof URL?e.toString():e),options:JSON.stringify(i)}})}async function w(e,t){if(e instanceof URL&&"file:"!==e.protocol)throw TypeError("Must be a file URL.");return await (0,r.invoke)("plugin:fs|exists",{path:e instanceof URL?e.toString():e,options:t})}r.Resource,e.s(["SeekMode",()=>a,"copyFile",()=>l,"exists",()=>w,"mkdir",()=>c,"open",()=>n,"readDir",()=>h,"readFile",()=>f,"readTextFile",()=>d,"remove",()=>g,"stat",()=>u,"writeFile",()=>p,"writeTextFile",()=>m],898400);var y=e.i(62725);class S extends Blob{#e;#t;constructor(e,t){super(),this.#e=e,this.#t=t}async arrayBuffer(){return await this.#e}async text(){let e=await this.#e;return new TextDecoder().decode(e)}stream(){return new ReadableStream({start:async e=>{let t=await this.#e,i=new ReadableStream({start(e){e.enqueue(new Uint8Array(t)),e.close()}}).getReader(),a=()=>i.read().then(({done:t,value:i})=>t?(e.close(),Promise.resolve()):(e.enqueue(i),a()));return a()}})}get type(){return this.#t}}class b extends File{#i=null;#a;#r;#o;#s=0;#n=-1;#t="";static MAX_CACHE_CHUNK_SIZE=1048576;static MAX_CACHE_ITEMS_SIZE=50;#l=[];#c=new Map;#h=new Map;constructor(e,t,i=null,a=""){super([],t||e,{type:a}),this.#a=e,this.#o=i,this.#r=t||e}async open(){this.#i=await n(this.#a,this.#o?{baseDir:this.#o}:void 0);let e=await this.#i.stat();return this.#n=e.size,this.#s=e.mtime?e.mtime.getTime():Date.now(),this}async close(){this.#i&&(await this.#i.close(),this.#i=null),this.#c.clear(),this.#l=[]}get name(){return this.#r}get type(){return this.#t}get size(){return this.#n}get lastModified(){return this.#s}async stat(){return this.#i?.stat()}async seek(e,t){if(!this.#i)throw Error("File handle is not open");return this.#i.seek(e,t)}async readData(e,t){let i=(t=Math.max(e=Math.max(0,e),Math.min(this.size,t)))-e;if(i>b.MAX_CACHE_CHUNK_SIZE){let t=await n(this.#a,this.#o?{baseDir:this.#o}:void 0);try{await t.seek(e,a.Start);let r=new Uint8Array(i);return await t.read(r),r.buffer}finally{await t.close()}}let r=Array.from(this.#c.keys()).find(i=>{let a=this.#c.get(i);return e>=i&&t<=i+a.byteLength});if(void 0!==r){this.#f(r);let t=this.#c.get(r),a=e-r;return t.slice(a,a+i)}let o=`${e}-${t}`,s=this.#h.get(o);if(s)return s;let l=this.#d(e,i);this.#h.set(o,l);try{return await l}finally{this.#h.delete(o)}}async #d(e,t){let i=await n(this.#a,this.#o?{baseDir:this.#o}:void 0);try{let r=Math.max(0,e-1024),o=Math.min(this.size,e+b.MAX_CACHE_CHUNK_SIZE)-r;await i.seek(r,a.Start);let s=new Uint8Array(o);await i.read(s),this.#c.set(r,s.buffer),this.#f(r),this.#g();let n=e-r;return s.buffer.slice(n,n+t)}finally{await i.close()}}#f(e){let t=this.#l.indexOf(e);t>-1&&this.#l.splice(t,1),this.#l.unshift(e)}#g(){for(;this.#c.size>b.MAX_CACHE_ITEMS_SIZE;){let e=this.#l.pop();void 0!==e&&this.#c.delete(e)}}slice(e=0,t=this.size,i=this.type){return new S(this.readData(e,t),i)}stream(){let e=0;return new ReadableStream({pull:async t=>{if(!this.#i)return void t.error(Error("File handle is not open"));if(e>=this.size)return void t.close();let i=new Uint8Array(Math.min(e+1048576,this.size)-e);await this.#i.seek(e,a.Start);let r=await this.#i.read(i);null===r||0===r?t.close():(t.enqueue(i.subarray(0,r)),e+=r)},cancel:async()=>{await this.#i?.close()}})}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}class k extends File{url;#r;#s;#n=-1;#t="";#l=[];#c=new Map;#u=new Map;static MAX_CACHE_CHUNK_SIZE=131072;static MAX_CACHE_ITEMS_SIZE=128;constructor(e,t,i="",a=Date.now()){const r=e.split("/").pop()||"remote-file";super([],t||r,{type:i,lastModified:a}),this.url=e,this.#r=t||r,this.#t=i,this.#s=a}get name(){return this.#r}get type(){return this.#t}get size(){return this.#n}get lastModified(){return this.#s}async _open_with_head(){let e=await fetch(this.url,{method:"HEAD"});if(!e.ok)throw Error(`Failed to fetch file size: ${e.status}`);return this.#n=Number(e.headers.get("content-length")),this.#t=e.headers.get("content-type")||"",this}async _open_with_range(){let e=await fetch(this.url,{headers:{Range:"bytes=0-1023"}});if(!e.ok)throw Error(`Failed to fetch file size: ${e.status}`);return this.#n=Number(e.headers.get("content-range")?.split("/")[1]),this.#t=e.headers.get("content-type")||"",this}async open(){return"android"===(0,y.getOSPlatform)()?this._open_with_range():this._open_with_head()}async close(){this.#c.clear(),this.#l=[]}async fetchRangePart(e,t){e=Math.max(0,e),t=Math.min(this.size-1,t);let i=await fetch(this.url,{headers:{Range:`bytes=${e}-${t}`}});if(!i.ok)throw Error(`Failed to fetch range: ${i.status}`);return i.arrayBuffer()}async fetchRange(e,t){let i=t-e+1;if(i>1024e3){let i=[];for(let a=e;a<=t;a+=1024e3){let e=Math.min(a+1024e3-1,t);i.push(await this.fetchRangePart(a,e))}let a=new Uint8Array(i.reduce((e,t)=>e+t.byteLength,0)),r=0;for(let e of i)a.set(new Uint8Array(e),r),r+=e.byteLength;return a.buffer}{if(i>k.MAX_CACHE_CHUNK_SIZE)return this.fetchRangePart(e,t);let a=Array.from(this.#c.keys()).find(i=>{let a=this.#c.get(i).byteLength;return e>=i&&t<=i+a});if(void 0!==a){this.#f(a);let t=this.#c.get(a),r=e-a;return t.slice(r,r+i)}let r=`${e}-${t}`,o=this.#u.get(r);if(o)return o;let s=this.#p(e,t,i);this.#u.set(r,s);try{return await s}finally{this.#u.delete(r)}}}async #p(e,t,i){let a=Math.max(0,e-1024),r=Math.max(t,e+k.MAX_CACHE_CHUNK_SIZE-1024-1),o=await this.fetchRangePart(a,r);this.#c.set(a,o),this.#f(a),this.#g();let s=e-a;return o.slice(s,s+i)}#f(e){let t=this.#l.indexOf(e);t>-1&&this.#l.splice(t,1),this.#l.unshift(e)}#g(){for(;this.#c.size>k.MAX_CACHE_ITEMS_SIZE;){let e=this.#l.pop();void 0!==e&&this.#c.delete(e)}}slice(e=0,t=this.size,i=this.type){return new S(this.fetchRange(e,t-1),i)}async text(){return this.slice(0,this.size).text()}async arrayBuffer(){return this.slice(0,this.size).arrayBuffer()}}e.s(["NativeFile",()=>b,"RemoteFile",()=>k],229435),e.i(307178);let E="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),F=new Uint8Array(16),B=[];for(let e=0;e<256;++e)B.push((e+256).toString(16).slice(1));let T=function(e,i,a){if(E&&!i&&!e)return E();let r=(e=e||{}).random??e.rng?.()??function(){if(!t){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");t=crypto.getRandomValues.bind(crypto)}return t(F)}();if(r.length<16)throw Error("Random bytes length must be >= 16");if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,i){if((a=a||0)<0||a+16>i.length)throw RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);for(let e=0;e<16;++e)i[a+e]=r[e];return i}return function(e,t=0){return(B[e[t+0]]+B[e[t+1]]+B[e[t+2]]+B[e[t+3]]+"-"+B[e[t+4]]+B[e[t+5]]+"-"+B[e[t+6]]+B[e[t+7]]+"-"+B[e[t+8]]+B[e[t+9]]+"-"+B[e[t+10]]+B[e[t+11]]+B[e[t+12]]+B[e[t+13]]+B[e[t+14]]+B[e[t+15]]).toLowerCase()}(r)};var v=e.i(27357),A=e.i(955066),x=e.i(431263),L=e.i(805143),U=e.i(329748),D=e.i(835106),C=e.i(262504);let I="files",_=new class{db=null;initPromise=null;async init(){if(!this.db)return this.initPromise||(this.initPromise=new Promise((e,t)=>{let i=indexedDB.open("readest-cache",1);i.onerror=()=>{console.error("[IndexedDBCache] Failed to open database:",i.error),t(i.error)},i.onsuccess=()=>{this.db=i.result,console.log("[IndexedDBCache] ✓ Database opened successfully"),e()},i.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(I)||(t.createObjectStore(I,{keyPath:"key"}).createIndex("expiresAt","expiresAt",{unique:!1}),console.log("[IndexedDBCache] ✓ Object store created"))}})),this.initPromise}async get(e){return(await this.init(),this.db)?new Promise((t,i)=>{let a=this.db.transaction(I,"readonly").objectStore(I).get(e);a.onerror=()=>i(a.error),a.onsuccess=()=>{let i=a.result;i&&i.expiresAt&&Date.now()>i.expiresAt?(console.log("[IndexedDBCache] Cache expired for:",e),this.delete(e).catch(e=>console.error("Failed to delete expired cache:",e)),t(null)):(i&&console.log("[IndexedDBCache] ✓ Cache hit for:",e),t(i||null))}}):null}async set(e,t,i,a){if(await this.init(),!this.db)return;let r={key:e,data:t,mimeType:i,etag:a?.etag,timestamp:Date.now(),expiresAt:a?.ttl?Date.now()+a.ttl:void 0};return new Promise((t,i)=>{let a=this.db.transaction(I,"readwrite").objectStore(I).put(r);a.onerror=()=>i(a.error),a.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache saved for:",e),t()}})}async delete(e){if(await this.init(),this.db)return new Promise((t,i)=>{let a=this.db.transaction(I,"readwrite").objectStore(I).delete(e);a.onerror=()=>i(a.error),a.onsuccess=()=>{console.log("[IndexedDBCache] ✓ Cache deleted for:",e),t()}})}async clear(){if(await this.init(),this.db)return new Promise((e,t)=>{let i=this.db.transaction(I,"readwrite").objectStore(I).clear();i.onerror=()=>t(i.error),i.onsuccess=()=>{console.log("[IndexedDBCache] ✓ All caches cleared"),e()}})}async clearExpired(){return(await this.init(),this.db)?new Promise((e,t)=>{let i=this.db.transaction(I,"readwrite").objectStore(I),a=i.index("expiresAt"),r=IDBKeyRange.upperBound(Date.now()),o=a.openCursor(r),s=0;o.onerror=()=>t(o.error),o.onsuccess=t=>{let a=t.target.result;a?(console.log("[IndexedDBCache] Deleting expired cache:",a.key),i.delete(a.primaryKey),s++,a.continue()):(console.log("[IndexedDBCache] ✓ Cleared",s,"expired caches"),e(s))}}):0}async getStats(){return(await this.init(),this.db)?new Promise((e,t)=>{let i=this.db.transaction(I,"readonly").objectStore(I).getAll();i.onerror=()=>t(i.error),i.onsuccess=()=>{let t,a,r=i.result,o=0;r.forEach(e=>{o+=e.data.byteLength,(!t||e.timestamp<t.timestamp)&&(t={key:e.key,timestamp:e.timestamp}),(!a||e.timestamp>a.timestamp)&&(a={key:e.key,timestamp:e.timestamp})}),console.log("[IndexedDBCache] Stats:",{entries:r.length,size:(o/1024/1024).toFixed(2)+" MB"}),e({totalEntries:r.length,totalSize:o,oldestEntry:t,newestEntry:a})}}):{totalEntries:0,totalSize:0}}},$={cacheStrategy:"cache-first",cacheTTL:2592e6};async function R(e,t={}){let i={...$,...t},a=`file_${e}`;console.log(`[cachedFetch] Fetching: ${e}, strategy: ${i.cacheStrategy}`);try{if("cache-first"===i.cacheStrategy&&!i.bypassCache){let t=await _.get(a);if(t){console.log(`[cachedFetch] ✓ Using cached data for: ${e}`);let i=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),...t.etag&&{ETag:t.etag}});return{data:t.data,headers:i,fromCache:!0}}}let t=new Headers(i.headers||{}),r=await fetch(e,{method:"GET",headers:t,signal:AbortSignal.timeout(3e4)});if(304===r.status){console.log(`[cachedFetch] 304 Not Modified for: ${e}`);let t=await _.get(a);if(t){let e=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),ETag:r.headers.get("ETag")||t.etag||""});return{data:t.data,headers:e,fromCache:!0}}}if(!r.ok)throw Error(`HTTP ${r.status}: ${r.statusText}`);let o=parseInt(r.headers.get("Content-Length")||"0",10),s=r.body?.getReader(),n=[],l=0;if(s)for(;;){let{done:e,value:t}=await s.read();if(e)break;if(n.push(t),l+=t.length,o>0&&i.onProgress){let e=Math.round(l/o*100);i.onProgress(e)}}else n.push(new Uint8Array(await r.arrayBuffer()));let c=new ArrayBuffer(l),h=new Uint8Array(c),f=0;for(let e of n)h.set(e,f),f+=e.length;let d=r.headers.get("Content-Type")||"application/octet-stream",g=r.headers.get("ETag");return i.bypassCache||200!==r.status||_.set(a,c,d,{etag:g||void 0,ttl:i.cacheTTL}).catch(t=>{console.warn(`[cachedFetch] Failed to cache ${e}:`,t)}),console.log(`[cachedFetch] ✓ Fetched ${(c.byteLength/1024/1024).toFixed(2)} MB from network`),{data:c,headers:r.headers,fromCache:!1}}catch(i){console.warn(`[cachedFetch] Network error for ${e}:`,i);let t=await _.get(a);if(t){console.log(`[cachedFetch] ℹ Using stale cache due to network error: ${e}`);let i=new Headers({"Content-Type":t.mimeType,"Content-Length":t.data.byteLength.toString(),Warning:'199 - "Stale cache used due to network error"'});return{data:t.data,headers:i,fromCache:!0}}throw i}}async function P(e,t={}){let{data:i,headers:a}=await R(e,t),r=new Blob([i],{type:a.get("Content-Type")||"application/octet-stream"});return URL.createObjectURL(r)}var N=e.i(931955),M=e.i(421966),O=e.i(819045);let z={lastAccessDate:new Date(0),lastModDate:new Date(0)},G=e=>e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):"";class j{async convert(e){let{file:t,author:i,language:a}=e,r=await t.arrayBuffer(),o=this.detectEncoding(r)||"utf-8";console.log(`Detected encoding: ${o}`);let s=new TextDecoder(o).decode(r).trim(),n=this.extractBookTitle((0,U.getBaseFilename)(t.name)),l=`${n}.epub`,c=s.slice(0,1024),h=c.match(/[【\[]?作者[】\]]?[:：\s]\s*(.+)\r?\n/)||c.match(/[【\[]?\s*(.+)\s+著\s*[】\]]?\r?\n/),f=h?h[1].trim():i||"";try{f=f.replace(/^[\p{P}\p{S}]+|[\p{P}\p{S}]+$/gu,"")}catch{}let d=f||i||"",g=a||(0,O.detectLanguage)(c);console.log(`Detected language: ${g}`);let u={bookTitle:n,author:d,language:g,identifier:await (0,x.partialMD5)(t)},p=[];for(let e=8;e>=6;e--){if(0===(p=this.extractChapters(s,u,{linesBetweenSegments:e,fallbackParagraphsPerChapter:100})).length)throw Error("No chapters detected.");if(p.length>1)break}return{file:new File([await this.createEpub(p,u)],l),bookTitle:n,chapterCount:p.length,language:g}}extractChapters(e,t,i){let{language:a}=t,{linesBetweenSegments:r,fallbackParagraphsPerChapter:o}=i,s=RegExp(`(?:\\r?\\n){${r},}|-{8,}\r?
`),n=[];if("zh"===a)n.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`第[零〇一二三四五六七八九十0-9][零〇一二三四五六七八九十百千万0-9]*(?:[章卷节回讲篇封本册部话])(?:[：:、 　\(\)0-9]*[^\n-]{0,24})(?!\S)`,String.raw`(?:楔子|前言|简介|引言|序言|序章|总论|概论|后记)(?:[：: 　][^\n-]{0,24})?(?!\S)`,String.raw`chapter[\s.]*[0-9]+(?:[：:. 　]+[^\n-]{0,50})?(?!\S)`].join("|")+")","gui")),n.push(RegExp(String.raw`(?:^|\n)\s*`+"("+[String.raw`[一二三四五六七八九十][零〇一二三四五六七八九十百千万]?[：:、 　][^\n-]{0,24}(?=\n|$)`,String.raw`[0-9]+[^\n]{0,16}(?=\n|$)`].join("|")+")","gu"));else{let e=String.raw`(\d+|(?:[IVXLCDM]{2,}|V|X|L|C|D|M)\b)`,t=String.raw`\.\d{1,4}`,i=String.raw`[^\n]{0,50}`,a=["Chapter","Part","Section","Book","Volume","Act"].map(a=>String.raw`${a}\s*(?:${e}|${t})(?:[:.\-–—]?\s*${i})?`).join("|"),r=["Prologue","Epilogue","Introduction","Foreword","Preface","Afterword"].map(e=>String.raw`${e}(?:[:.\-–—]?\s*${i})?`).join("|"),o=String.raw`(?:^|\n|\s)(?:${a}|${r})(?=\s|$)`;n.push(RegExp(o,"gi"))}let l=e=>(e=G(e)).replace(/-{8,}|_{8,}/g,"\n").split(/\n+/).map(e=>e.trim()).filter(e=>e).join("</p><p>"),c=e=>e.reduce((e,t,i,a)=>(void 0===t&&i>0&&i<a.length-1&&void 0!==a[i-1]&&void 0!==a[i+1]?e[e.length-1]+=a[i+1]:void 0!==t&&(0===i||void 0!==a[i-1])&&e.push(t),e),[]),h=(e,t=1e5)=>{let i=e.filter(e=>e&&e.trim().length>0);return!(i.length<=1)&&!i.some(e=>e.length>t)},f=[];for(let t of e.split(s)){let e=t.replace(/<!--.*?-->/g,"").trim();if(!e)continue;let i=[],r=[];for(let t of n){let i=e.split(t);if(h(i)){r=c(i);break}}if(0===r.length&&o>0){let t=e.split(/\n+/),i=t.length;for(let e=0;e<i;e+=o){let i=t.slice(e,e+o),a=l(i.join("\n")),r=`${f.length+1}`,s=`<h2>${r}</h2><p>${a}</p>`;f.push({title:r,content:s,text:i.join("\n"),isVolume:!1})}continue}for(let e=1;e<r.length;e+=2){let t=r[e]?.trim()||"",o=r[e+1]?.trim()||"",s=!1,n=(s="zh"===a?/第[零〇一二三四五六七八九十百千万0-9]+(卷|本|册|部)/.test(t):/\b(Part|Volume|Book)\b/i.test(t))?`<h1>${t}</h1>`:`<h2>${t}</h2>`,c=l(o);i.push({title:G(t),content:`${n}<p>${c}</p>`,text:o,isVolume:s})}if(r[0]&&r[0].trim()){let e=r[0].trim(),t=e.split("\n")[0].trim(),a=(t.length>16?e.split(/[\n\s\p{P}]/u)[0].trim():t)||e.slice(0,16),o=l(e);i.unshift({title:G(a),content:`<h3></h3><p>${o}</p>`,text:e,isVolume:!1})}f.push(...i)}return f}async createEpub(t,i){let{BlobWriter:a,TextReader:r,ZipWriter:o}=await e.A(187722),{bookTitle:s,author:n,language:l,identifier:c}=i,h=new o(new a("application/epub+zip"),{extendedTimestamp:!1});await h.add("mimetype",new r("application/epub+zip"),z),await h.add("META-INF/container.xml",new r(`<?xml version="1.0" encoding="UTF-8"?>
    <container xmlns="urn:oasis:names:tc:opendocument:xmlns:container" version="1.0">
      <rootfiles>
        <rootfile full-path="content.opf" media-type="application/oebps-package+xml"/>
      </rootfiles>
    </container>`.trim()),z);let f=!1,d="";for(let e=0;e<t.length;e++){let i=`chapter${e+1}`,a=e+1;t[e].isVolume&&f&&(d+=`</navPoint>
`,f=!f),d+=`<navPoint id="navPoint-${i}" playOrder="${a}">
<navLabel><text>${t[e].title}</text></navLabel>
<content src="./OEBPS/${i}.xhtml" />
`,t[e].isVolume&&!f?f=!f:d+=`</navPoint>
`}f&&(d+="</navPoint>");let g=`<?xml version="1.0" encoding="UTF-8"?>
    <ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
      <head>
        <meta name="dtb:uid" content="book-id" />
        <meta name="dtb:depth" content="1" />
        <meta name="dtb:totalPageCount" content="0" />
        <meta name="dtb:maxPageNumber" content="0" />
      </head>
      <docTitle>
        <text>${G(s)}</text>
      </docTitle>
      <docAuthor>
        <text>${G(n)}</text>
      </docAuthor>
      <navMap>
        ${d}
      </navMap>
    </ncx>`.trim();await h.add("toc.ncx",new r(g),z);let u=t.map((e,t)=>`
      <item id="chap${t+1}" href="OEBPS/chapter${t+1}.xhtml" media-type="application/xhtml+xml"/>
    `).join("\n").trim(),p=t.map((e,t)=>`
      <itemref idref="chap${t+1}"/>`).join("\n").trim(),m=`
      body { line-height: 1.6; font-size: 1em; font-family: 'Arial', sans-serif; text-align: justify; }
      p { text-indent: 2em; margin: 0; }
    `;await h.add("style.css",new r(m),z);for(let e=0;e<t.length;e++){let i=t[e],a=(0,O.detectLanguage)(i.text),o=`<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
        <html xmlns="http://www.w3.org/1999/xhtml" lang="${a}" xml:lang="${a}">
          <head>
            <title>${i.title}</title>
            <link rel="stylesheet" type="text/css" href="../style.css"/>
          </head>
          <body>${i.content}</body>
        </html>`.trim();await h.add(`OEBPS/chapter${e+1}.xhtml`,new r(o),z)}let w=`<?xml version="1.0" encoding="UTF-8"?>
      <package xmlns="http://www.idpf.org/2007/opf" unique-identifier="book-id" version="2.0">
        <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
          <dc:title>${G(s)}</dc:title>
          <dc:language>${l}</dc:language>
          <dc:creator>${G(n)}</dc:creator>
          <dc:identifier id="book-id">${c}</dc:identifier>
        </metadata>
        <manifest>
          ${u}
          <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
          <item id="css" href="style.css" media-type="text/css"/>
        </manifest>
        <spine toc="ncx">
          ${p}
        </spine>
      </package>`.trim();return await h.add("content.opf",new r(w),z),await h.close()}detectEncoding(e){try{return new TextDecoder("utf-8",{fatal:!0}).decode(e),"utf-8"}catch{let t=new Uint8Array(e),i=0,a=0,r=Math.min(t.length,1e4);for(let e=0;e<r;e++)try{new TextDecoder("utf-8",{fatal:!0}).decode(t.slice(e,e+100)),i+=100,a+=100,e+=99}catch{a++}let o=i/a*100;if(console.log(`UTF-8 validity: ${o.toFixed(2)}%`),o>80)return console.log("Treating as UTF-8 despite some invalid sequences"),"utf-8"}let t=new Uint8Array(e.slice(0,4));if(255===t[0]&&254===t[1])return"utf-16le";if(254===t[0]&&255===t[1])return"utf-16be";if(239===t[0]&&187===t[1]&&191===t[2])return"utf-8";let i=new Uint8Array(e.slice(0,Math.min(1024,e.byteLength))),a=0;for(let e=0;e<i.length;e++)i[e]>=128&&a++;let r=a/i.length;if(r>.3)return"gbk";if(r>.1){let e=!1;for(let t=0;t<i.length-1;t++){let a=i[t],r=i[t+1];if((a>=129&&a<=159||a>=224&&a<=252)&&(r>=64&&r<=126||r>=128&&r<=252)){e=!0;break}}return e?"shift-jis":"gb18030"}return"utf-8"}extractBookTitle(e){let t=e.match(/《([^》]+)》/);return t?t[1]:e.split(".")[0]}}let V="Book file not found",H=new Set([1028,2052,3076,4100,19,33]);function J(e){let t=parseFloat(e);if(!isNaN(t))return t}async function W(e,t=700,i=1050){let a=await e.text(),r=new DOMParser().parseFromString(a,"image/svg+xml").documentElement,o=r.getAttribute("width"),s=r.getAttribute("height");if(o&&s)return{width:J(o)||t,height:J(s)||i};let n=r.getAttribute("viewBox");if(n){let e=n.split(/\s+/).map(Number);if(4===e.length&&!e.some(isNaN)){let[,,a,r]=e;return{width:a||t,height:r||i}}}return{width:t,height:i}}async function K(e,t=.9){let i=await e.text(),a=URL.createObjectURL(new Blob([i],{type:"image/svg+xml"})),r=new Image;r.crossOrigin="anonymous",await new Promise((e,t)=>{r.onload=()=>e(),r.onerror=()=>t(Error("Failed to load SVG")),r.src=a}),await new Promise(e=>requestAnimationFrame(e)),await new Promise(e=>requestAnimationFrame(e));let o=document.createElement("canvas"),{width:s,height:n}=await W(e);return o.width=s,o.height=n,o.getContext("2d").drawImage(r,0,0),URL.revokeObjectURL(a),new Promise(e=>{o.toBlob(t=>e(t),"image/png",t)})}class X{osPlatform=(0,y.getOSPlatform)();appPlatform="tauri";localBooksDir="";isMobile=!1;isMacOSApp=!1;isLinuxApp=!1;isAppDataSandbox=!1;isAndroidApp=!1;isIOSApp=!1;isMobileApp=!1;isPortableApp=!1;isDesktopApp=!1;isEink=!1;hasTrafficLight=!1;hasWindow=!1;hasWindowBar=!1;hasContextMenu=!1;hasRoundedWindow=!1;hasSafeAreaInset=!1;hasHaptics=!1;hasUpdater=!1;hasOrientationLock=!1;hasScreenBrightness=!1;hasIAP=!1;canCustomizeRootDir=!1;canReadExternalDir=!1;distChannel="readest";CURRENT_MIGRATION_VERSION=0x1352519;async runMigrations(e){if(e<0x13501f4)try{await this.migrate20251124()}catch(e){console.error("Error migrating to version 20251124:",e)}if(e<0x1352519)try{await this.migrate20260121()}catch(e){console.error("Error migrating to version 20260121:",e)}}async prepareBooksDir(){this.localBooksDir=await this.fs.getPrefix("Books"),await this.ensureConfigFilesExist()}async ensureConfigFilesExist(){try{if(!await this.fs.exists(C.SETTINGS_FILENAME,"Settings")){console.log("[Init] settings.json not found, creating with defaults...");let e={...C.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?C.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:C.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),globalReadSettings:{...C.DEFAULT_READSETTINGS,...this.isMobile?C.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()};await this.safeSaveJSON(C.SETTINGS_FILENAME,"Settings",e),console.log("[Init] ✓ settings.json created successfully")}let e=(0,A.getLibraryFilename)();await this.fs.exists(e,"Books")||(console.log("[Init] library.json not found, creating with defaults..."),await this.safeSaveJSON(e,"Books",[]),console.log("[Init] ✓ library.json created successfully")),console.log("[Init] ✓ All configuration files are ready")}catch(e){console.error("[Init] Error ensuring config files exist:",e)}}async openFile(e,t){return await this.fs.openFile(e,t)}async copyFile(e,t,i){return await this.fs.copyFile(e,t,i)}async readFile(e,t,i){return await this.fs.readFile(e,t,i)}async writeFile(e,t,i){return await this.fs.writeFile(e,t,i)}async createDir(e,t,i=!0){return await this.fs.createDir(e,t,i)}async deleteFile(e,t){return await this.fs.removeFile(e,t)}async deleteDir(e,t,i=!0){return await this.fs.removeDir(e,t,i)}async resolveFilePath(e,t){let i=await this.fs.getPrefix(t);return e?`${i}/${e}`:i}async readDirectory(e,t){return await this.fs.readDir(e,t)}async exists(e,t){return await this.fs.exists(e,t)}async getImageURL(e){return await this.fs.getImageURL(e)}getCoverImageUrl=e=>{let t=(0,A.getCoverFilename)(e),i=this.fs.resolvePath(t,"Books");return this.fs.getURL(i.fp)||`${this.localBooksDir}/${t}`};getCoverImageBlobUrl=async e=>{let t=(0,A.getCoverFilename)(e);if("web"===this.appPlatform)try{let e=this.fs.getURL(this.fs.resolvePath(t,"Books").fp)||`${this.localBooksDir}/${t}`;return await P(e,{cacheStrategy:"cache-first",cacheTTL:2592e6}).catch(()=>`${this.localBooksDir}/${t}`)}catch{return`${this.localBooksDir}/${t}`}try{return await this.fs.getBlobURL(t,"Books")}catch{return`${this.localBooksDir}/${t}`}};async getCachedImageUrl(e){let t=`img_${(0,L.md5)(e)}`,i=await this.fs.getPrefix("Cache"),a=`${i}/${t}`;if(await this.fs.exists(a,"None"))return await this.fs.getImageURL(a);{let i=await this.fs.openFile(e,"None");return await this.fs.writeFile(t,"Cache",await i.arrayBuffer()),await this.fs.getImageURL(a)}}getDefaultViewSettings(){return{...C.DEFAULT_BOOK_LAYOUT,...C.DEFAULT_BOOK_STYLE,...C.DEFAULT_BOOK_FONT,...C.DEFAULT_BOOK_LANGUAGE,...this.isMobile?C.DEFAULT_MOBILE_VIEW_SETTINGS:{},...this.isEink?C.DEFAULT_EINK_VIEW_SETTINGS:{},...(0,y.isCJKEnv)()?C.DEFAULT_CJK_VIEW_SETTINGS:{},...C.DEFAULT_VIEW_CONFIG,...C.DEFAULT_TTS_CONFIG,...C.DEFAULT_SCREEN_CONFIG,...C.DEFAULT_ANNOTATOR_CONFIG,...{...C.DEFAULT_TRANSLATOR_CONFIG,translateTargetLang:(0,y.getTargetLang)()}}}async loadSettings(){let e={...C.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?C.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},version:C.SYSTEM_SETTINGS_VERSION,localBooksDir:await this.fs.getPrefix("Books"),koreaderSyncDeviceId:T(),globalReadSettings:{...C.DEFAULT_READSETTINGS,...this.isMobile?C.DEFAULT_MOBILE_READSETTINGS:{}},globalViewSettings:this.getDefaultViewSettings()},t=await this.safeLoadJSON(C.SETTINGS_FILENAME,"Settings",e),i=t.version??0;return(this.isAppDataSandbox||i<C.SYSTEM_SETTINGS_VERSION)&&(t.version=C.SYSTEM_SETTINGS_VERSION),(t={...C.DEFAULT_SYSTEM_SETTINGS,...this.isMobile?C.DEFAULT_MOBILE_SYSTEM_SETTINGS:{},...t}).globalReadSettings={...C.DEFAULT_READSETTINGS,...this.isMobile?C.DEFAULT_MOBILE_READSETTINGS:{},...t.globalReadSettings},t.globalViewSettings={...this.getDefaultViewSettings(),...t.globalViewSettings},t.localBooksDir=await this.fs.getPrefix("Books"),t.kosync.deviceId||(t.kosync.deviceId=T(),await this.saveSettings(t)),this.localBooksDir=t.localBooksDir,t}async saveSettings(e){await this.safeSaveJSON(C.SETTINGS_FILENAME,"Settings",e)}async importFont(e){let t,i;if("string"==typeof e)t=(await this.fs.openFile(e,"None")).name||(0,U.getFilename)(e),await this.fs.copyFile(e,t,"Fonts"),i=await this.fs.openFile(t,"Fonts");else{if(!e)return null;t=(0,U.getFilename)(e.name),await this.fs.writeFile(t,"Fonts",e),i=e}return{path:t,...((e,t)=>{let i=t.replace(/\.[^/.]+$/,"");try{var a,r,o,s;let t,i=new DataView(e),n=i.getUint32(0,!1);if(65536!==n&&0x74727565!==n&&0x4f54544f!==n)throw Error("Unsupported font format");let l=i.getUint16(4,!1),c=0,h=0,f=0;for(let e=0;e<l;e++){let t=12+16*e,a=String.fromCharCode(i.getUint8(t),i.getUint8(t+1),i.getUint8(t+2),i.getUint8(t+3));"name"===a?c=i.getUint32(t+8,!1):"OS/2"===a?h=i.getUint32(t+8,!1):"fvar"===a&&(f=i.getUint32(t+8,!1))}if(0===c)throw Error("Name table not found");let d=i.getUint16(c+2,!1),g=i.getUint16(c+4,!1),u=(0,y.getUserLang)(),p=[],m=[],w=[],S=[];for(let e=0;e<d;e++){let t=c+6+12*e,a=i.getUint16(t,!1),r=i.getUint16(t+4,!1),o=i.getUint16(t+6,!1),s=i.getUint16(t+8,!1),n=i.getUint16(t+10,!1);if(1===o||2===o||16===o||17===o){let e=c+g+n,t="";if(0===a||3===a?t=function(e,t,i){let a=[];for(let r=0;r<i;r+=2){let i=e.getUint16(t+r,!1);0!==i&&a.push(String.fromCharCode(i))}return a.join("")}(i,e,s):1===a&&(t=function(e,t,i){let a=[];for(let r=0;r<i;r++){let i=e.getUint8(t+r);a.push(String.fromCharCode(i))}return a.join("")}(i,e,s)),t&&t.trim()){let e=function(e,t,i){let a=0;0===e?a+=100:3===e?a+=90:1===e&&(a+=50);let r=i.toLowerCase();return 0===e||3===e?(r.startsWith("zh")?2052===t?a+=50:1028===t?a+=45:3076===t?a+=40:4100===t&&(a+=35):r.startsWith("ja")?1041===t&&(a+=50):r.startsWith("ko")?1042===t&&(a+=50):r.startsWith("en")&&(1033===t?a+=50:2057===t&&(a+=45)),1033===t&&(a+=10)):1===e&&(r.startsWith("zh")?33===t?a+=50:19===t&&(a+=45):r.startsWith("ja")?11===t&&(a+=50):r.startsWith("ko")?23===t&&(a+=50):r.startsWith("en")&&0===t&&(a+=50),0===t&&(a+=10)),a}(a,r,u),i={name:t.trim(),platformID:a,languageID:r,priority:e};1===o?p.push(i):2===o?m.push(i):16===o?w.push(i):17===o&&S.push(i)}}}if(0===p.length)throw Error("Font family name not found");p.sort((e,t)=>t.priority-e.priority),m.sort((e,t)=>t.priority-e.priority),w.sort((e,t)=>t.priority-e.priority),S.sort((e,t)=>t.priority-e.priority);let b=(w[0]||p[0]).name,k=S[0]||m[0],E=k?.name||"",F=400,B="normal",T=0;if(h>0)try{a=h,F=(r=i.getUint16(a+4,!1))>=1&&r<=100?100:r>=101&&r<=200?200:r>=201&&r<=300?300:r>=301&&r<=400?400:r>=401&&r<=500?500:r>=501&&r<=600?600:r>=601&&r<=700?700:r>=701&&r<=800?800:r>=801&&r<=900?900:400,o=h,T=i.getUint16(o+62,!1)}catch{console.warn("Failed to parse OS/2 table, falling back to style name analysis")}let v=!1;if(f>0){let e=function(e,t){try{let i=e.getUint16(t+4,!1),a=e.getUint16(t+6,!1),r=[],o=t+16;for(let t=0;t<i;t++){let t=String.fromCharCode(e.getUint8(o),e.getUint8(o+1),e.getUint8(o+2),e.getUint8(o+3)),i=e.getInt32(o+4,!1)/65536,s=e.getInt32(o+8,!1)/65536,n=e.getInt32(o+12,!1)/65536;r.push({tag:t,minValue:i,defaultValue:s,maxValue:n}),o+=a}return r}catch(e){return console.warn("Failed to parse fvar table:",e),[]}}(i,f);e&&e.length>0&&(v=!0)}if(400===F&&E){let e,t=(e=E.toLowerCase()).includes("thin")||e.includes("hairline")?100:e.includes("extralight")||e.includes("ultralight")?200:!e.includes("light")||e.includes("extralight")||e.includes("ultralight")?e.includes("medium")?500:e.includes("semibold")||e.includes("demibold")?600:e.includes("extrabold")||e.includes("ultrabold")?800:e.includes("black")||e.includes("heavy")?900:!e.includes("bold")||e.includes("semibold")||e.includes("extrabold")||e.includes("ultrabold")?400:700:300;400!==t&&(F=t)}return s=T,t=E.toLowerCase(),B=512&s?"oblique":1&s?"italic":t.includes("oblique")?"oblique":t.includes("italic")||t.includes("slant")?"italic":"normal",{name:k&&!H.has(k.languageID)?`${b} ${E}`:b,family:b,weight:F,style:B,variable:v}}catch(e){return console.warn(`Failed to parse font: ${e}`),{name:i,family:i,weight:400,style:"normal",variable:!1}}})(await i.arrayBuffer(),t)}}async deleteFont(e){await this.fs.removeFile(e.path,"Fonts")}async importImage(e){let t;if("string"==typeof e)t=(await this.fs.openFile(e,"None")).name||(0,U.getFilename)(e),await this.fs.copyFile(e,t,"Images");else{if(!e)return null;t=(0,U.getFilename)(e.name),await this.fs.writeFile(t,"Images",e)}return{name:t.replace(/\.[^/.]+$/,""),path:t}}async deleteImage(e){await this.fs.removeFile(e.path,"Images")}async importBook(e,t,i=!0,a=!0,r=!1,o=!1,s){let n=Date.now(),l="";try{let c,h,f;if(o&&"string"!=typeof e)throw Error("Transient import is only supported for file paths");try{"string"==typeof e?l=(f=await this.fs.openFile(e,"None")).name||(0,U.getFilename)(e):(f=e,l=e.name);let t=f.size/1048576;if(console.log(`[importBook] Processing: ${l}, size: ${t.toFixed(2)} MB`),0===f.size)throw Error("Invalid or empty book file");if(f.size>0x6400000&&console.warn(`[importBook] ⚠️ Large file: ${t.toFixed(2)} MB, processing may take longer`),/\.txt$/i.test(l)){let e=new j;({file:f}=await e.convert({file:f}))}if(console.log(`[importBook] Opening document: ${l}`),{book:c,format:h}=await new D.DocumentLoader(f).open(),!c)throw Error("Unsupported or corrupted book file");let i=(0,A.formatTitle)(c.metadata.title);i&&i.trim()&&i!==l||(c.metadata.title=(0,U.getBaseFilename)(l)),console.log(`[importBook] ✓ Document opened successfully: ${l}`)}catch(t){let e=t.message||String(t);throw console.error(`[importBook] ✗ Failed to open book: ${l}`,e),Error(`Failed to open the book: ${e}`)}console.log(`[importBook] Computing hash for: ${l}`);let d=await (0,x.partialMD5)(f),g=t.filter(e=>e.hash===d)[0],u=Date.now();g&&(o||(g.deletedAt=null),g.createdAt=u,g.updatedAt=u);let p=(0,A.getPrimaryLanguage)(c.metadata.language),m={hash:d,format:h,title:(0,A.formatTitle)(c.metadata.title),sourceTitle:(0,A.formatTitle)(c.metadata.title),primaryLanguage:p,author:(0,A.formatAuthors)(c.metadata.author,p),createdAt:g?g.createdAt:u,uploadedAt:g?g.uploadedAt:o?null:u,deletedAt:o?u:null,downloadedAt:u,updatedAt:u};g&&(g.format=m.format,g.title=g.title.trim()?g.title.trim():m.title,g.sourceTitle=g.sourceTitle??m.sourceTitle,g.author=g.author??m.author,g.primaryLanguage=g.primaryLanguage??m.primaryLanguage,g.downloadedAt=Date.now());let w="local"===window.__STORAGE_MODE__||!0,S="web"===this.appPlatform&&w;console.log("[ImportBook] appPlatform:",this.appPlatform,"STORAGE_MODE (runtime):",window.__STORAGE_MODE__,"STORAGE_MODE (env):","local","shouldUseLocalFlatStorage:",S);let b=D.EXTS[h]||h.toLowerCase?.()||"book",k=(0,y.makeSafeFilename)(m.sourceTitle||m.title),E=s?.targetGroupName?.trim();if(S){let e=s?.targetRelativePath?s.targetRelativePath:`${E?`${E}/`:""}${k}.${b}`;if(!e)throw Error("targetRelativePath is required for local storage mode. Please provide a valid relative path.");m.relativePath=e,console.log("[ImportBook] 5. Setting book.relativePath to:",e),console.log("[ImportBook] 6. Book hash:",m.hash),g&&(g.relativePath=e),E&&!m.groupName&&(m.groupName=E,g&&!g.groupName&&(g.groupName=E))}else if("web"===this.appPlatform){let e=s?.targetRelativePath?s.targetRelativePath:`${E?`${E}/`:""}${k}.${b}`;m.relativePath=e,g&&(g.relativePath=e)}await this.ensureLocalBookDirs(m);let F=(0,A.getLocalBookFilename)(m);if(i&&!o&&(!await this.fs.exists(F,"Books")||r))if(/\.txt$/i.test(l))await this.fs.writeFile(F,"Books",f);else if("string"==typeof e&&(0,y.isContentURI)(e))await this.fs.copyFile(e,F,"Books");else if("string"!=typeof e||(0,y.isValidURL)(e))await this.fs.writeFile(F,"Books",f);else try{await this.fs.copyFile(e,F,"Books")}catch{await this.fs.writeFile(F,"Books",await f.arrayBuffer())}if(a&&(!await this.fs.exists((0,A.getCoverFilename)(m),"Books")||r)){console.log("[ImportBook] 7. Preparing to save cover");let e=await c.getCover();if(e?.type==="image/svg+xml")try{console.log("[ImportBook] Converting SVG cover to PNG..."),e=await K(e)}catch{}if(e){let t=(0,A.getCoverFilename)(m);console.log("[ImportBook] 8. Saving cover with filename:",t),console.log("[ImportBook] 9. Cover size:",e.size,"bytes"),await this.fs.writeFile(t,"Books",await e.arrayBuffer()),console.log("[ImportBook] 10. Cover saved successfully")}}g||(await this.saveBookConfig(m,A.INIT_BOOK_CONFIG),t.splice(0,0,m)),"string"==typeof e&&((0,y.isValidURL)(e)&&(m.url=e,g&&(g.url=e)),o&&(m.filePath=e,g&&(g.filePath=e))),m.coverImageUrl=await this.generateCoverImageUrl(m),e&&e.close&&await e.close();let B=Date.now()-n;return console.log(`[importBook] ✓ Import completed in ${B}ms: ${l}`),g||m}catch(r){let t=Date.now()-n,i=r.message||String(r),a=r.stack;if(console.error(`[importBook] ✗ Import failed after ${t}ms`),console.error(`[importBook] File: ${l||("string"==typeof e?e:"unknown")}`),console.error(`[importBook] Error: ${i}`),a&&console.error("[importBook] Stack trace:",a),i.includes("memory")||i.includes("ENOMEM"))throw Error(`内存不足：文件可能过大。请尝试导入较小的文件或关闭其他程序。原始错误：${i}`);throw i.includes("too large")||i.includes("Maximum size"),r}}async importBookFromPath(e,t,i){try{let a=t.split("/").slice(0,-1).join("/");return await this.importBook(e,i,!1,!0,!1,!0,{targetRelativePath:t,targetGroupName:a||""})}catch(t){return console.error("Error importing book from path:",e,t),null}}async reclassifyBook(e,t,i){if("web"!==this.appPlatform)return void console.log("[Reclassify] 非本地存储模式，跳过文件移动");if(!e.relativePath)return void console.log("[Reclassify] 书籍未使用新存储结构，跳过文件移动:",e.title);try{let a,r,o=(await this.loadSettings()).groupDirectories||{},s=e.relativePath;if(i&&s.startsWith(`${i}/`))a=s.substring(i.length+1);else{let e=s.split("/");a=e[e.length-1]||""}let n=(r=t&&o[t]?o[t]:t||"")?`${r}/${a}`:a;if(s===n)return void console.log("[Reclassify] 书籍分组未改变，无需移动文件");console.log("[Reclassify] 准备移动书籍文件"),console.log("  旧路径:",s),console.log("  新路径:",n),console.log("  文件名:",a),console.log("  新分组:",t),console.log("  目标目录:",r);let l=await fetch("/api/storage/reclassify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPath:s,newPath:n})});if(!l.ok){let e=await l.text();throw console.error("[Reclassify] 文件移动失败:",e),Error(`Failed to move book files: ${e}`)}let c=await l.json();e.relativePath=n,e.groupName=t||void 0,c.absolutePath&&(e.absolutePath=c.absolutePath),console.log("[Reclassify] 文件移动成功:",c)}catch(e){throw console.error("[Reclassify] 重新分类书籍时出错:",e),e}}async deleteBook(e,t){if(console.log("Deleting book with action:",t,e.title),"local"===t||"both"===t){for(let i of"local"===t?[(0,A.getLocalBookFilename)(e)]:[(0,A.getLocalBookFilename)(e),(0,A.getCoverFilename)(e)])console.log("Deleting local file:",i),await this.fs.removeFile(i,"Books");"local"===t?e.downloadedAt=null:(e.deletedAt=Date.now(),e.downloadedAt=null,e.coverDownloadedAt=null)}("cloud"===t||"both"===t)&&e.uploadedAt&&(console.log("Cloud delete operation skipped - cloud storage removed"),e.uploadedAt=null)}async exportBook(e){let{file:t}=await this.loadBookContent(e),i=await t.arrayBuffer(),a=`${(0,y.makeSafeFilename)(e.title)}.${e.format.toLowerCase()}`,r=await this.resolveFilePath((0,A.getLocalBookFilename)(e),"Books"),o=t.type||"application/octet-stream";return await this.saveFile(a,i,r,o)}async isBookAvailable(e){let t=(0,A.getLocalBookFilename)(e);return!!await this.fs.exists(t,"Books")||(e.filePath?await this.fs.exists(e.filePath,"None"):!!e.url&&(0,y.isValidURL)(e.url))}async getBookFileSize(e){let t=(0,A.getLocalBookFilename)(e);if(await this.fs.exists(t,"Books")){let e=await this.fs.openFile(t,"Books"),i=e.size;return e&&e.close&&await e.close(),i}return null}async loadBookContent(e){let t,i=(0,A.getLocalBookFilename)(e);if(await this.fs.exists(i,"Books"))t=await this.fs.openFile(i,"Books");else if(e.filePath)t=await this.fs.openFile(e.filePath,"None");else if(e.url)t=await this.fs.openFile(e.url,"None");else{let i=(0,A.getDir)(e),a=await this.fs.readDir((0,A.getDir)(e),"Books");if(a.length>0){let r=a.find(t=>t.path.endsWith(`.${D.EXTS[e.format]}`));if(r)t=await this.fs.openFile(`${i}/${r.path}`,"Books");else throw Error(V)}else throw Error(V)}return{book:e,file:t}}async loadBookConfig(e,t){let i={...t.globalViewSettings,...v.FIXED_LAYOUT_FORMATS.has(e.format)?C.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};try{let t="{}";return await this.fs.exists((0,A.getConfigFilename)(e),"Books")&&(t=await this.fs.readFile((0,A.getConfigFilename)(e),"Books","text")),(0,M.deserializeConfig)(t,i,C.DEFAULT_BOOK_SEARCH_CONFIG)}catch{return(0,M.deserializeConfig)("{}",i,C.DEFAULT_BOOK_SEARCH_CONFIG)}}async fetchBookDetails(e){let t=(0,A.getLocalBookFilename)(e);if(!await this.fs.exists(t,"Books")&&e.uploadedAt)throw console.warn("Book file not found locally and cloud download is disabled:",e.title),Error("Book file not found locally");let{file:i}=await this.loadBookContent(e),a=(await new D.DocumentLoader(i).open()).book;return i&&i.close&&await i.close(),a.metadata}async saveBookConfig(e,t,i){let a;if(i){let r={...i.globalViewSettings,...v.FIXED_LAYOUT_FORMATS.has(e.format)?C.DEFAULT_FIXED_LAYOUT_VIEW_SETTINGS:{}};a=(0,M.serializeConfig)(t,r,C.DEFAULT_BOOK_SEARCH_CONFIG)}else a=JSON.stringify(t);await this.fs.writeFile((0,A.getConfigFilename)(e),"Books",a)}async generateCoverImageUrl(e){return"web"===this.appPlatform?await this.getCoverImageBlobUrl(e):this.getCoverImageUrl(e)}async loadLibraryBooks(){console.log("Loading library books...");let e=(0,A.getLibraryFilename)();await this.fs.exists("","Books")||await this.fs.createDir("","Books",!0);let t=await this.safeLoadJSON(e,"Books",[]);return await Promise.all(t.map(async e=>(e.coverImageUrl=await this.generateCoverImageUrl(e),e.updatedAt??=e.lastUpdated||Date.now(),e))),t}async saveLibraryBooks(e){let t=e.map(({coverImageUrl:e,...t})=>t);await this.safeSaveJSON((0,A.getLibraryFilename)(),"Books",t)}async reconcileBookPaths(e){if("web"!==this.appPlatform)return console.log("[Reconcile] 非本地存储模式，跳过路径校准"),{success:!1,error:"Not in local storage mode"};try{console.log("[Reconcile] 开始校准书籍路径，共",e.length,"本书");let t=e.filter(e=>!e.deletedAt).map(e=>({hash:e.hash,relativePath:e.relativePath,absolutePath:e.absolutePath,title:e.title,groupName:e.groupName})),i=await fetch("/api/storage/reconcile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({library:t})});if(!i.ok){let e=await i.text();throw console.error("[Reconcile] 路径校准失败:",e),Error(`Failed to reconcile paths: ${e}`)}let a=await i.json();return console.log("[Reconcile] 路径校准完成:",a.summary),a}catch(e){throw console.error("[Reconcile] 路径校准出错:",e),e}}async applyReconciliation(e,t){let i=[...e];for(let e of t)if("moved"===e.status){let t=i.findIndex(t=>t.hash===e.hash);if(-1!==t){let a=i[t];a&&(a.relativePath=e.newRelativePath,a.absolutePath=e.absolutePath,void 0!==e.suggestedGroupName&&(a.groupName=e.suggestedGroupName,a.groupId=e.suggestedGroupName?(0,x.md5Fingerprint)(e.suggestedGroupName):""),a.updatedAt=Date.now(),console.log("[Reconcile] 更新书籍:",a.title,"新路径:",a.relativePath))}}return await this.saveLibraryBooks(i),i}imageToArrayBuffer(e,t){return new Promise((i,a)=>{e||t?"web"===this.appPlatform&&e&&e.startsWith("blob:")?fetch(e).then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):"tauri"===this.appPlatform&&t?this.fs.openFile(t,"None").then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):"tauri"===this.appPlatform&&e?(0,N.fetch)(e,{method:"GET"}).then(e=>e.arrayBuffer()).then(e=>i(e)).catch(e=>a(e)):a(Error("Unsupported platform or missing image data")):a(Error("No image URL or file provided"))})}async updateCoverImage(e,t,i){if("_blank"===t)await this.fs.removeFile((0,A.getCoverFilename)(e),"Books");else if(t||i){let a=await this.imageToArrayBuffer(t,i);await this.fs.writeFile((0,A.getCoverFilename)(e),"Books",a)}}async loadJSONFile(e,t){try{let i=await this.fs.readFile(e,t,"text");if(!i||"string"!=typeof i||0===i.trim().length)return{success:!1,error:"File is empty or invalid"};try{let e=JSON.parse(i);return{success:!0,data:e}}catch(e){return{success:!1,error:`JSON parse error: ${e}`}}}catch(e){return{success:!1,error:e}}}async safeLoadJSON(e,t,i){let a=`${e}.bak`,r=await this.loadJSONFile(e,t);if(r.success)return r.data;console.warn(`Failed to load ${e}, attempting backup...`,r.error);let o=await this.loadJSONFile(a,t);if(o.success){console.warn(`Loaded from backup: ${a}`);try{let i=JSON.stringify(o.data,null,2);await this.fs.writeFile(e,t,i),console.log(`Restored ${e} from backup`)}catch(t){console.error(`Failed to restore ${e} from backup:`,t)}return o.data}return console.error(`Both ${e} and ${a} failed to load`),i}async safeSaveJSON(e,t,i){let a=`${e}.bak`,r=JSON.stringify(i,null,2);try{await this.fs.writeFile(a,t,r),await this.fs.writeFile(e,t,r)}catch(t){throw console.error(`Failed to save ${e}:`,t),Error(`Failed to save ${e}: ${t}`)}}async ensureLocalBookDirs(e){if(e.relativePath){let t=e.relativePath.split("/").slice(0,-1).join("/"),i=e.relativePath.replace(/\.[^.]+$/,"");t&&await this.fs.createDir(t,"Books",!0),await this.fs.createDir(i,"Books",!0);return}await this.fs.exists((0,A.getDir)(e),"Books")||await this.fs.createDir((0,A.getDir)(e),"Books")}async migrate20251124(){console.log("Running migration for version 20251124 to rename the backup library file...");let e=(0,A.getLibraryBackupFilename)(),t=`${(0,A.getLibraryFilename)()}.bak`;if(await this.fs.exists(e,"Books"))try{let i=await this.fs.readFile(e,"Books","text");await this.fs.writeFile(t,"Books",i),await this.fs.removeFile(e,"Books"),console.log("Migration to rename backup library file completed successfully.")}catch(e){console.error("Error during migration to rename backup library file:",e)}}async migrate20260121(){if("web"!==this.appPlatform)return void console.log("[Migration 20260121] Skip (not web/local mode)");console.log("[Migration 20260121] Start migrating legacy hash-based books to flat layout");let e=await this.loadLibraryBooks(),t=0;for(let i of e){if(i.relativePath)continue;let e=D.EXTS[i.format]||i.format?.toLowerCase?.()||"book",a=(0,y.makeSafeFilename)(i.sourceTitle||i.title||i.hash),r=`${i.groupName?`${i.groupName}/`:""}${a}.${e}`,o=`${i.hash}/${a}.${e}`,s=`${i.hash}/cover.png`,n=`${i.hash}/config.json`,l=r.replace(/\.[^.]+$/,"")+"/cover.png",c=r.replace(/\.[^.]+$/,"")+"/config.json";try{if(await this.fs.exists(o,"Books")){await this.ensureLocalBookDirs({...i,relativePath:r});let e=await this.fs.openFile(o,"Books");await this.fs.writeFile(r,"Books",e),await this.fs.removeFile(o,"Books")}if(await this.fs.exists(s,"Books")){let e=await this.fs.openFile(s,"Books");await this.fs.writeFile(l,"Books",e),await this.fs.removeFile(s,"Books")}if(await this.fs.exists(n,"Books")){let e=await this.fs.readFile(n,"Books","text");await this.fs.writeFile(c,"Books",e),await this.fs.removeFile(n,"Books")}i.relativePath=r,t++}catch(e){console.error("[Migration 20260121] Failed to migrate book:",i.title,e)}}t>0?(await this.saveLibraryBooks(e),console.log(`[Migration 20260121] Migrated ${t} book(s) to flat layout`)):console.log("[Migration 20260121] No legacy books to migrate")}}e.s(["BaseAppService",()=>X],669770)}]);