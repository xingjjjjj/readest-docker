(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,480474,e=>{"use strict";var t=e.i(399458);let i="http://www.idpf.org/2007/opf",r="http://www.idpf.org/2007/ops",a="http://purl.org/dc/elements/1.1/",s="http://www.w3.org/2001/04/xmlenc#",n="http://www.w3.org/1999/xlink",l="application/xhtml+xml",o="text/html",h="text/css",c="image/svg+xml",d=/\/(x-)?(javascript|ecmascript)/,u={a11y:"http://www.idpf.org/epub/vocab/package/a11y/#",dcterms:"http://purl.org/dc/terms/",marc:"http://id.loc.gov/vocabulary/",media:"http://www.idpf.org/epub/vocab/overlays/#",onix:"http://www.editeur.org/ONIX/book/codelists/current.html#",rendition:"http://www.idpf.org/vocab/rendition/#",schema:"http://schema.org/",xsd:"http://www.w3.org/2001/XMLSchema#",msv:"http://www.idpf.org/epub/vocab/structure/magazine/#",prism:"http://www.prismstandard.org/specifications/3.0/PRISM_CV_Spec_3.0.htm#"},p={art:"artist",aut:"author",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},m={"02":"isbn","06":"doi",15:"isbn",26:"doi",34:"issn"},f=e=>e.toLowerCase().replace(/[-:](.)/g,(e,t)=>t.toUpperCase()),g=(...e)=>t=>t?Object.fromEntries(e.map(e=>[f(e),t.getAttribute(e)])):null,y=e=>{let t;return(t=e?.textContent)?t.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):""},b=(e,t)=>{let i=e.lookupNamespaceURI(null)===t||e.lookupPrefix(t),r=i?(e,i)=>e=>e.namespaceURI===t&&e.localName===i:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(r(e,t)),$$:(e,t)=>[...e.children].filter(r(e,t)),$$$:i?(e,i)=>[...e.getElementsByTagNameNS(t,i)]:(e,t)=>[...e.getElementsByTagName(t)]}},w=(e,t)=>{try{if(e=e.replace(/%2c/gi,",").replace(/%3a/gi,":"),t.includes(":")&&!t.startsWith("OEBPS"))return new URL(e,t);let i="https://invalid.invalid/",r=new URL(e,i+t);return r.search="",decodeURI(r.href.replace(i,""))}catch(t){return console.warn(t),e}},v=async(e,t,i)=>{let r=[];e.replace(t,(...e)=>(r.push(e),null));let a=[];for(let e of r)a.push(await i(...e));return e.replace(t,()=>a.shift())},I=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),x=e=>{for(let[t,i]of Object.entries(e))null==i?delete e[t]:Array.isArray(i)?(e[t]=i.filter(e=>e).map(e=>"object"!=typeof e||Array.isArray(e)?e:x(e)),e[t].length?1===e[t].length&&(e[t]=e[t][0]):delete e[t]):"object"==typeof i&&(e[t]=x(i),Object.keys(i).length||delete e[t]);let t=Object.keys(e);return 1===t.length&&"name"===t[0]?e[t[0]]:e},A=(e,t)=>{if(!e)return null;let[i,r]=e.split(":"),a=r||i,s=t.get(r?i:null);return s?s+a:null},E=e=>{if(!e)return;let t=e.split(":").map(e=>parseFloat(e));if(3===t.length){let[e,i,r]=t;return 60*e*60+60*i+r}if(2===t.length){let[e,i]=t;return 60*e+i}let[i,r]=e.split(/(?=[^\d.])/);return parseFloat(i)*("h"===r?3600:"min"===r?60:"ms"===r?.001:1)},S=["jpg","jpeg","png","gif","webp"];class T extends EventTarget{#e;#t;#i;#r;#a;#s;#n=1;#l=1;#o;constructor(e,t){super(),this.book=e,this.loadXML=t}async #h(e){if(this.#t===e)return;let t=await this.loadXML(e.href),i=t=>t?w(t,e.href):null,{$:r,$$$:a}=b(t,"http://www.w3.org/ns/SMIL");this.#r=-1,this.#a=-1,this.#e=a(t,"par").reduce((e,t)=>{let a=i(r(t,"text")?.getAttribute("src")),s=r(t,"audio");if(!a||!s)return e;let n=i(s.getAttribute("src")),l=E(s.getAttribute("clipBegin")),o=E(s.getAttribute("clipEnd")),h=e.at(-1);return h?.src===n?h.items.push({text:a,begin:l,end:o}):e.push({src:n,items:[{text:a,begin:l,end:o}]}),e},[]),this.#t=e}get #c(){return this.#e[this.#r]}get #d(){return this.#c?.items?.[this.#a]}#u(e){console.error(e),this.dispatchEvent(new CustomEvent("error",{detail:e}))}#p(){this.dispatchEvent(new CustomEvent("highlight",{detail:this.#d}))}#m(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:this.#d}))}async #f(e,t){this.#g(),this.#r=e,this.#a=t;let i=this.#c?.src;if(!i||!this.#d)return this.start(this.#i+1);let r=URL.createObjectURL(await this.book.loadBlob(i)),a=new Audio(r);this.#s=a,a.volume=this.#n,a.playbackRate=this.#l,a.addEventListener("timeupdate",()=>{if(a.paused)return;let e=a.currentTime,{items:t}=this.#c;if(e>this.#d?.end&&(this.#m(),this.#a===t.length-1))return void this.#f(this.#r+1,0).catch(e=>this.#u(e));let i=this.#a;for(;t[this.#a+1]?.begin<=e;)this.#a++;this.#a!==i&&this.#p()}),a.addEventListener("error",()=>this.#u(Error(`Failed to load ${i}`))),a.addEventListener("playing",()=>this.#p()),a.addEventListener("ended",()=>{this.#m(),URL.revokeObjectURL(r),this.#s=null,this.#f(e+1,0).catch(e=>this.#u(e))}),"paused"===this.#o?(this.#p(),a.currentTime=this.#d.begin??0):a.addEventListener("canplaythrough",()=>{a.currentTime=this.#d.begin??0,this.#o="playing",a.play().catch(e=>this.#u(e))},{once:!0})}async start(e,t=()=>!0){this.#s?.pause();let i=this.book.sections[e],r=i?.id;if(!r)return;let{mediaOverlay:a}=i;if(!a)return this.start(e+1);this.#i=e,await this.#h(a);for(let e=0;e<this.#e.length;e++){let{items:i}=this.#e[e];for(let a=0;a<i.length;a++)if(i[a].text.split("#")[0]===r&&t(i[a],a,i))return this.#f(e,a).catch(e=>this.#u(e))}}pause(){this.#o="paused",this.#s?.pause()}resume(){this.#o="playing",this.#s?.play().catch(e=>this.#u(e))}#g(){this.#s&&(this.#s.pause(),URL.revokeObjectURL(this.#s.src),this.#s=null,this.#m())}stop(){this.#o="stopped",this.#g()}prev(){this.#a>0?this.#f(this.#r,this.#a-1):this.#r>0?this.#f(this.#r-1,this.#e[this.#r-1].items.length-1):this.#i>0&&this.start(this.#i-1,(e,t,i)=>t===i.length-1)}next(){this.#f(this.#r,this.#a+1)}setVolume(e){this.#n=e,this.#s&&(this.#s.volume=e)}setRate(e){this.#l=e,this.#s&&(this.#s.playbackRate=e)}}let L=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,M=e=>y(e.getElementById(e.documentElement.getAttribute("unique-identifier"))??e.getElementsByTagNameNS(a,"identifier")[0]),C=async(e,t,i)=>{let r=new Uint8Array(await i.slice(0,t).arrayBuffer());t=Math.min(t,r.length);for(var a=0;a<t;a++)r[a]=r[a]^e[a%e.length];return new Blob([r,i.slice(t)],{type:i.type})},B=async e=>{let t=new TextEncoder().encode(e);return new Uint8Array(await globalThis.crypto.subtle.digest("SHA-1",t))};class R{#y=new Map;#b=new Map;#w;constructor(e){this.#w=e}async init(e,t){if(e)for(let{algorithm:i,uri:r}of Array.from(e.getElementsByTagNameNS(s,"EncryptedData"),e=>({algorithm:e.getElementsByTagNameNS(s,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:e.getElementsByTagNameNS(s,"CipherReference")[0]?.getAttribute("URI")}))){if(!this.#b.has(i)){let e=this.#w[i];if(!e){console.warn("Unknown encryption algorithm");continue}let r=await e.key(t);this.#b.set(i,t=>e.decode(r,t))}this.#y.set(r,i)}}getDecoder(e){return this.#b.get(this.#y.get(e))??(e=>e)}}class U{constructor({opf:e,resolveHref:r}){this.opf=e;const{$:a,$$:s,$$$:n}=b(e,i),l=a(e.documentElement,"manifest"),o=a(e.documentElement,"spine"),h=s(o,"itemref");this.manifest=s(l,"item").map(g("href","id","media-type","properties","media-overlay")).map(e=>(e.href=r(e.href),e.properties=e.properties?.split(/\s/),e)),this.manifestById=new Map(this.manifest.map(e=>[e.id,e])),this.spine=h.map(g("idref","id","linear","properties")).map(e=>(e.properties=e.properties?.split(/\s/),e)),this.pageProgressionDirection=o.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(o.getAttribute("toc"))??this.manifest.find(e=>"application/x-dtbncx+xml"===e.mediaType))?.href;const c=a(e.documentElement,"guide");c&&(this.guide=s(c,"reference").map(g("type","title","href")).map(({type:e,title:t,href:i})=>({label:t,type:e.split(/\s/),href:r(i)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(n(e,"meta").find(((e,t,i)=>"function"==typeof t?i=>t(i.getAttribute(e)):i=>i.getAttribute(e)===t)("name","cover"))?.getAttribute("content"))??this.manifest.find(e=>"cover"===e.id&&e.mediaType.startsWith("image"))??this.manifest.find(e=>e.href.includes("cover")&&e.mediaType.startsWith("image"))??this.getItemByHref(this.guide?.find(e=>e.type.includes("cover"))?.href)??this.manifest.find(e=>e.mediaType.startsWith("image")),this.cfis=t.fromElements(h)}getItemByID(e){return this.manifestById.get(e)}getItemByHref(e){return this.manifest.find(t=>t.href===e)}getItemByProperty(e){return this.manifest.find(t=>t.properties?.includes(e))}resolveCFI(e){let i=t.parse(e),r=(i.parent??i).shift(),a=t.toElement(this.opf,r);a&&"idref"!==a.nodeName&&(r.at(-1).id=null,a=t.toElement(this.opf,r));let s=a?.getAttribute("idref");return{index:this.spine.findIndex(e=>e.idref===s),anchor:e=>t.toRange(e,i)}}}class j{#v=new Map;#I=new Map;#x=new Map;#A=new Map;eventTarget=new EventTarget;constructor({loadText:e,loadBlob:t,resources:i,entries:r}){this.loadText=e,this.loadBlob=t,this.manifest=i.manifest,this.assets=i.manifest,this.entries=r}async createURL(e,t,i,r){if(!t)return"";let a={data:t,type:i};Object.defineProperty(a,"name",{value:e});let s=new CustomEvent("data",{detail:a});this.eventTarget.dispatchEvent(s);let n=await s.detail.data,o=await s.detail.type,h=URL.createObjectURL(new Blob([n],{type:o}));if(this.#v.set(e,h),this.#A.set(e,1),o===l&&this.#I.set(h,{href:e,type:o,data:n}),r){let t=this.#x.get(r);t?t.push(e):this.#x.set(r,[e])}return h}ref(e,t){let i=this.#x.get(t);return i?.includes(e)||(this.#A.set(e,this.#A.get(e)+1),i?i.push(e):this.#x.set(t,[e])),this.#v.get(e)}unref(e){if(!this.#A.has(e))return;let t=this.#A.get(e)-1;if(t<1){let t=this.#v.get(e);URL.revokeObjectURL(t),this.#v.delete(e),this.#I.delete(t),this.#A.delete(e);let i=this.#x.get(e);if(i)for(;i.length;)this.unref(i.pop());this.#x.delete(e)}else this.#A.set(e,t)}async loadItem(e,t=[]){if(!e)return null;let{href:i,mediaType:r}=e,a=d.test(e.mediaType),s=new CustomEvent("load",{detail:{type:r,isScript:a,allow:!0}});if(this.eventTarget.dispatchEvent(s),!await s.detail.allow)return null;let n=t.at(-1);if(this.#v.has(i))return this.ref(i,n);if((a||[l,o,h,c].includes(r))&&t.every(e=>e!==i))return this.loadReplaced(e,t);let u=Promise.resolve().then(()=>this.loadBlob(i));return this.createURL(i,u,r,n)}async loadItemXHTMLContent(e,t=[]){let i=await this.loadItem(e,t);if(i)return this.#I.get(i)?.data}tryImageEntryItem(e){return S.some(t=>e.toLowerCase().endsWith(`.${t}`))&&this.entries.get(e)?{href:e,mediaType:({jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp"})[e.toLowerCase().split(".").pop()]||"image/jpeg"}:null}async loadHref(e,t,i=[]){if(/^(?!blob)\w+:/i.test(e))return e;let r=w(e,t),a=this.manifest.find(e=>e.href===r);return a||(a=this.tryImageEntryItem(r))?this.loadItem(a,i.concat(t)):e}async loadReplaced(e,t=[]){let{href:i,mediaType:r}=e,a=t.at(-1),s="";try{s=await this.loadText(i)}catch(e){return this.createURL(i,Promise.reject(e),r,a)}if(!s)return null;if([l,o,c].includes(r)){let h=new DOMParser().parseFromString(s,r);if(r===l&&(h.querySelector("parsererror")||!h.documentElement?.namespaceURI)&&(console.warn(h.querySelector("parsererror")?.innerText??"Invalid XHTML"),e.mediaType=o,h=new DOMParser().parseFromString(s,e.mediaType)),[l,c].includes(e.mediaType)){let e=h.firstChild;for(;e instanceof ProcessingInstruction;){if(e.data){let r=await v(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(e,r,a,s)=>this.loadHref(a,i,t).then(e=>`${r}${e}${s}`));e.replaceWith(h.createProcessingInstruction(e.target,r))}e=e.nextSibling}}let d=async(e,r)=>e.setAttribute(r,await this.loadHref(e.getAttribute(r),i,t));for(let e of h.querySelectorAll("link[href]"))await d(e,"href");for(let e of h.querySelectorAll("[src]"))await d(e,"src");for(let e of h.querySelectorAll("[poster]"))await d(e,"poster");for(let e of h.querySelectorAll("object[data]"))await d(e,"data");for(let e of h.querySelectorAll("[*|href]:not([href])"))e.setAttributeNS(n,"href",await this.loadHref(e.getAttributeNS(n,"href"),i,t));for(let e of h.querySelectorAll("[srcset]"))e.setAttribute("srcset",await v(e.getAttribute("srcset"),/(\s*)(.+?)\s*((?:\s[\d.]+[wx])+\s*(?:,|$)|,\s+|$)/g,(e,r,a,s)=>this.loadHref(a,i,t).then(e=>`${r}${e}${s}`)));for(let e of h.querySelectorAll("style"))e.textContent&&(e.textContent=await this.replaceCSS(e.textContent,i,t));for(let e of h.querySelectorAll("[style]"))e.setAttribute("style",await this.replaceCSS(e.getAttribute("style"),i,t));let u=new XMLSerializer().serializeToString(h);return this.createURL(i,u,e.mediaType,a)}let d=r===h?await this.replaceCSS(s,i,t):await this.replaceString(s,i,t);return this.createURL(i,d,r,a)}async replaceCSS(e,t,i=[]){let r=await v(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(e,r)=>this.loadHref(r,t,i).then(e=>`url("${e}")`));return v(r,/@import\s*["']([^"'\n]*?)["']/gi,(e,r)=>this.loadHref(r,t,i).then(e=>`@import "${e}"`))}replaceString(e,t,i=[]){let r=new Map,a=this.assets.map(e=>{if(e.href===t)return;let i=((e,t)=>{if(!e)return t;let i=e.replace(/\/$/,"").split("/"),r=t.replace(/\/$/,"").split("/"),a=(i.length>r.length?i:r).findIndex((e,t)=>i[t]!==r[t]);return a<0?"":Array(i.length-a).fill("..").concat(r.slice(a)).join("/")})(t.slice(0,t.lastIndexOf("/")+1),e.href),a=encodeURI(i),s="/"+e.href,n=encodeURI(s),l=new Set([i,a,s,n]);for(let t of l)r.set(t,e);return Array.from(l)}).flat().filter(e=>e);return a.length?v(e,RegExp(a.map(I).join("|"),"g"),async e=>this.loadItem(r.get(e.replace(/^\//,"")),i.concat(t))):e}unloadItem(e){this.unref(e?.href)}destroy(){for(let e of this.#v.values())URL.revokeObjectURL(e)}}class O{parser=new DOMParser;#E;#S;constructor({entries:e,loadText:t,loadBlob:i,getSize:r,sha1:s}){this.entries=e.reduce((e,t)=>(e.set(t.filename,t),e),new Map),this.loadText=t,this.loadBlob=i,this.getSize=r,this.#S=new R(((e=B)=>({"http://www.idpf.org/2008/embedding":{key:t=>e(M(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>C(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{let t=(e=>{for(let t of e.getElementsByTagNameNS(a,"identifier")){let[e]=y(t).split(":").slice(-1);if(L.test(e))return e}return""})(e).replaceAll("-","");return Uint8Array.from({length:16},(e,i)=>parseInt(t.slice(2*i,2*i+2),16))},decode:(e,t)=>C(e,1024,t)}}))(s))}#T(e){let t={nbsp:"&#160;",mdash:"&#8212;",ndash:"&#8211;",ldquo:"&#8220;",rdquo:"&#8221;",lsquo:"&#8216;",rsquo:"&#8217;",hellip:"&#8230;",copy:"&#169;",reg:"&#174;",trade:"&#8482;",bull:"&#8226;",middot:"&#183;"};return e.replace(/&([a-z]+);/gi,(e,i)=>t[i.toLowerCase()]||e)}async #L(e){let t=await this.loadText(e);if(!t)return null;let i=this.#T(t),r=this.parser.parseFromString(i,"application/xml");if(r.querySelector("parsererror"))throw Error(`XML parsing error: ${e}
${r.querySelector("parsererror").innerText}`);return r}async init(){var e;let t=await this.#L("META-INF/container.xml");if(!t)throw Error("Failed to load container file");let s=Array.from(t.getElementsByTagNameNS("urn:oasis:names:tc:opendocument:xmlns:container","rootfile"),g("full-path","media-type")).filter(e=>"application/oebps-package+xml"===e.mediaType);if(!s.length)throw Error("No package document defined in container");let n=s[0].fullPath,l=await this.#L(n);if(!l)throw Error("Failed to load package document");let o=await this.#L("META-INF/encryption.xml");await this.#S.init(o,l),this.resources=new U({opf:l,resolveHref:e=>w(e,n)}),this.#E=new j({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then(this.#S.getDecoder(e)),resources:this.resources,entries:this.entries}),this.transformTarget=this.#E.eventTarget,this.sections=this.resources.spine.map((e,t)=>{let{idref:i,linear:r,properties:a=[]}=e,s=this.resources.getItemByID(i);return s?{id:s.href,load:()=>this.#E.loadItem(s),unload:()=>this.#E.unloadItem(s),loadContent:()=>this.#E.loadItemXHTMLContent(s),createDocument:()=>this.loadDocument(s),size:this.getSize(s.href),cfi:this.resources.cfis[t],linear:r,pageSpread:(e=>{for(let t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}})(a),resolveHref:e=>w(e,s.href),mediaOverlay:s.mediaOverlay?this.resources.getItemByID(s.mediaOverlay):null}:(console.warn(`Could not find item with ID "${i}" in manifest`),null)}).filter(e=>e);let{navPath:h,ncxPath:c}=this.resources;if(h)try{let e=((e,t=e=>e)=>{let{$:i,$$:a,$$$:s}=b(e,"http://www.w3.org/1999/xhtml"),n=(e,s)=>e?a(e,"li").map(e=>{let a,l=i(e,"a")??i(e,"span"),o=i(e,"ol"),h=(a=l?.getAttribute("href"))?decodeURI(t(a)):null,c={label:y(l)||l?.getAttribute("title"),href:h,subitems:n(o)};return s&&(c.type=l?.getAttributeNS(r,"type")?.split(/\s/)),c}):null,l=(e,t)=>n(i(e,"ol"),t),o=s(e,"nav"),h=null,c=null,d=null,u=[];for(let e of o){let t=e.getAttributeNS(r,"type")?.split(/\s/)??[];t.includes("toc")?h??=l(e):t.includes("page-list")?c??=l(e):t.includes("landmarks")?d??=l(e,!0):u.push({label:y(e.firstElementChild),type:t,list:l(e)})}return{toc:h,pageList:c,landmarks:d,others:u}})(await this.#L(h),e=>w(e,h));this.toc=e.toc,this.pageList=e.pageList,this.landmarks=e.landmarks}catch(e){console.warn(e)}if(!this.toc&&c)try{let e=((e,t=e=>e)=>{let{$:i,$$:r}=b(e,"http://www.daisy.org/z3986/2005/ncx/"),a=e=>{let s,n=i(e,"navLabel"),l=i(e,"content"),o=y(n),h=(s=l.getAttribute("src"))?decodeURI(t(s)):null;if("navPoint"===e.localName){let t=r(e,"navPoint");return{label:o,href:h,subitems:t.length?t.map(a):null}}return{label:o,href:h}},s=(e,t)=>r(e,t).map(a),n=(t,r)=>{let a=i(e.documentElement,t);return a?s(a,r):null};return{toc:n("navMap","navPoint"),pageList:n("pageList","pageTarget"),others:r(e.documentElement,"navList").map(e=>({label:y(i(e,"navLabel")),list:s(e,"navTarget")}))}})(await this.#L(c),e=>w(e,c));this.toc=e.toc,this.pageList=e.pageList}catch(e){console.warn(e)}this.landmarks??=this.resources.guide;let{metadata:d,rendition:v,media:I}=(e=>{let{$:t}=b(e,i),s=t(e.documentElement,"metadata"),n=Object.groupBy(s.children,e=>e.namespaceURI===a?"dc":e.namespaceURI===i&&"meta"===e.localName?e.hasAttribute("name")?"legacyMeta":"meta":""),l=s.getAttribute("xml:lang")??e.documentElement.getAttribute("xml:lang")??"und",o=(e=>{let t=new Map(Object.entries(u)),i=e.documentElement.getAttributeNS(r,"prefix")||e.documentElement.getAttribute("prefix");if(i)for(let[,e,r]of i.matchAll(/(.+): +(.+)[ \t\r\n]*/g))t.set(e,r);return t})(e),h=e=>{let t=e.getAttribute("property"),r=e.getAttribute("scheme");return{property:A(t,o)??t,scheme:A(r,o)??r,lang:e.getAttribute("xml:lang"),value:y(e),props:d(e),attrs:Object.fromEntries(Array.from(e.attributes).filter(e=>e.namespaceURI===i).map(e=>[e.localName,e.value]))}},c=Map.groupBy(n.meta??[],e=>e.getAttribute("refines")),d=e=>{let t=c.get(e?"#"+e.getAttribute("id"):null);return t?Object.groupBy(t.map(h),e=>e.property):null},g=Object.fromEntries(Object.entries(Object.groupBy(n.dc||[],e=>e.localName)).map(([e,t])=>[e,t.map(h)])),w=d()??{},v=Object.fromEntries(n.legacyMeta?.map(e=>[e.getAttribute("name"),e.getAttribute("content")])??[]),I=e=>e?.[0]?.value,S=(e,t)=>I(e?.props?.[t]),T=e=>{if(!e)return null;let t=e.props?.["alternate-script"]??[],i=e.attrs["alt-rep"];if(!t.length&&(!e.lang||e.lang===l)&&!i)return e.value;let r={[e.lang??l]:e.value};for(let a of(i&&(r[e.attrs["alt-rep-lang"]]=i),t))r[a.lang]??=a.value;return r},L=e=>e?{name:T(e),sortAs:T(e.props?.["file-as"]?.[0])??e.attrs["file-as"],role:e.props?.role?.filter(e=>e.scheme===u.marc+"relators")?.map(e=>e.value)??[e.attrs.role],code:S(e,"term")??e.attrs.term,scheme:S(e,"authority")??e.attrs.authority}:null,C=e=>({name:T(e),position:I(e.props?.["group-position"])}),B=e=>{let{value:t}=e;if(/^urn:/i.test(t))return t;if(/^doi:/i.test(t))return`urn:${t}`;let i=e.props?.["identifier-type"];if(!i){let i=e.attrs.scheme;return i?/^(doi|isbn|uuid)$/i.test(i)?`urn:${i}:${t}`:{scheme:i,value:t}:t}if(i.scheme===u.onix+"codelist5"){let e=m[i.value];if(e)return`urn:${e}:${t}`}return t},R=Object.groupBy(w["belongs-to-collection"]??[],e=>"series"===S(e,"collection-type")?"series":"collection"),U=g.title?.find(e=>"main"===S(e,"title-type"))??g.title?.[0],j={identifier:M(e),title:T(U),sortAs:T(U?.props?.["file-as"]?.[0])??U?.attrs?.["file-as"]??v?.["calibre:title_sort"],subtitle:g.title?.find(e=>"subtitle"===S(e,"title-type"))?.value,language:g.language?.map(e=>e.value),description:I(g.description),publisher:L(g.publisher?.[0]),published:g.date?.find(e=>"publication"===e.attrs.event)?.value??I(g.date),modified:I(w[u.dcterms+"modified"])??g.date?.find(e=>"modification"===e.attrs.event)?.value,subject:g.subject?.map(L),belongsTo:{collection:R.collection?.map(C),series:R.series?.map(C)??v?.["calibre:series"]?{name:v?.["calibre:series"],position:parseFloat(v?.["calibre:series_index"])}:null},altIdentifier:g.identifier?.map(B),source:g.source?.map(B),rights:I(g.rights)},O=e=>t=>{let i=new Set(t.role?.map(t=>p[t]??e));return[i.size?i:[e],t]};for(let[e,t]of[].concat(g.creator?.map(L)?.map(O("author"))??[],g.contributor?.map(L)?.map(O("contributor"))??[]))for(let i of e)"publisher"===i&&j.publisher||(j[i]?j[i].push(t):j[i]=[t]);x(j),j.altIdentifier===j.identifier&&delete j.altIdentifier;let N={},k={};for(let[e,t]of Object.entries(w))e.startsWith(u.rendition)?N[f(e.replace(u.rendition,""))]=I(t):e.startsWith(u.media)&&(k[f(e.replace(u.media,""))]=I(t));return k.duration&&(k.duration=E(k.duration)),{metadata:j,rendition:N,media:k}})(l);this.metadata=d,this.rendition=v,this.media=I,this.dir=this.resources.pageProgressionDirection;let S=(e=await this.#L("META-INF/com.apple.ibooks.display-options.xml")??await this.#L("META-INF/com.kobobooks.display-options.xml"))?{fixedLayout:y(e.querySelector('option[name="fixed-layout"]')),openToSpread:y(e.querySelector('option[name="open-to-spread"]'))}:null;return S&&("true"===S.fixedLayout&&(this.rendition.layout??="pre-paginated"),"false"===S.openToSpread&&(this.sections.find(e=>"no"!==e.linear).pageSpread??="rtl"===this.dir?"left":"right")),this}async loadDocument(e){let t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}getMediaOverlay(){return new T(this,this.#L.bind(this))}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){let[t,i]=e.split("#"),r=this.resources.getItemByHref(decodeURI(t));return r?{index:this.resources.spine.findIndex(({idref:e})=>e===r.id),anchor:i?e=>e.getElementById(i)??e.querySelector(`[name="${CSS.escape(i)}"]`):()=>0}:null}splitTOCHref(e){return e?.split("#")??[]}getTOCFragment(e,t){return e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`)}isExternal(e){return/^(?!blob)\w+:/i.test(e)}async getCover(){let e=this.resources?.cover;return e?.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){let e=await this.loadText("META-INF/calibre_bookmarks.txt"),t="encoding=json+base64:";if(e?.startsWith(t))return JSON.parse(atob(e.slice(t.length)))}destroy(){this.#E?.destroy()}}e.s(["EPUB",()=>O])}]);